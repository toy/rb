<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>DaemonController</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" />
    <script src="../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            DaemonController 
            
                <span class="parent">&lt; 
                    
                    Object
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../files/lib/daemon_controller/lock_file_rb.html">lib/daemon_controller/lock_file.rb</a></li>
            
            <li><a href="../files/lib/daemon_controller/version_rb.html">lib/daemon_controller/version.rb</a></li>
            
            <li><a href="../files/lib/daemon_controller_rb.html">lib/daemon_controller.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
Main daemon controller object. See the README for an introduction and
tutorial.
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>B</dt>
        <dd>
            <ul>
                
                <li><a href="#M000012">before_start</a></li>
                
            </ul>
        </dd>
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M000019">check_pid</a>,</li>
                
                <li><a href="#M000007">connect</a></li>
                
            </ul>
        </dd>
    
        <dt>D</dt>
        <dd>
            <ul>
                
                <li><a href="#M000016">daemon_is_running?</a>,</li>
                
                <li><a href="#M000027">daemonization_timed_out</a>,</li>
                
                <li><a href="#M000018">delete_pid_file</a>,</li>
                
                <li><a href="#M000031">determine_lock_file</a>,</li>
                
                <li><a href="#M000030">differences_in_log_file</a></li>
                
            </ul>
        </dd>
    
        <dt>F</dt>
        <dd>
            <ul>
                
                <li><a href="#M000032">fork_supported?</a></li>
                
            </ul>
        </dd>
    
        <dt>I</dt>
        <dd>
            <ul>
                
                <li><a href="#M000036">interruptable_waitpid</a>,</li>
                
                <li><a href="#M000037">interruptable_waitpid</a></li>
                
            </ul>
        </dd>
    
        <dt>K</dt>
        <dd>
            <ul>
                
                <li><a href="#M000014">kill_daemon</a>,</li>
                
                <li><a href="#M000015">kill_daemon_with_signal</a></li>
                
            </ul>
        </dd>
    
        <dt>L</dt>
        <dd>
            <ul>
                
                <li><a href="#M000029">log_file_has_changed?</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M000005">new</a>,</li>
                
                <li><a href="#M000024">no_activity?</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M000009">pid</a>,</li>
                
                <li><a href="#M000025">pid_file_available?</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000017">read_pid_file</a>,</li>
                
                <li><a href="#M000023">record_activity</a>,</li>
                
                <li><a href="#M000033">run_command</a>,</li>
                
                <li><a href="#M000034">run_ping_command</a>,</li>
                
                <li><a href="#M000010">running?</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M000035">safe_fork</a>,</li>
                
                <li><a href="#M000028">save_log_file_information</a>,</li>
                
                <li><a href="#M000013">spawn_daemon</a>,</li>
                
                <li><a href="#M000006">start</a>,</li>
                
                <li><a href="#M000026">start_timed_out</a>,</li>
                
                <li><a href="#M000011">start_without_locking</a>,</li>
                
                <li><a href="#M000008">stop</a></li>
                
            </ul>
        </dd>
    
        <dt>W</dt>
        <dd>
            <ul>
                
                <li><a href="#M000020">wait_until</a>,</li>
                
                <li><a href="#M000022">wait_until_daemon_responds_to_ping_or_has_exited_or_log_file_has_changed</a>,</li>
                
                <li><a href="#M000021">wait_until_pid_file_is_available_or_log_file_has_changed</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    
    <div class="sectiontitle">Classes and Modules</div>
    <ul>
        
        <li><span class="type">CLASS</span> <a href="DaemonController/AlreadyStarted.html">DaemonController::AlreadyStarted</a></li>
        
        <li><span class="type">CLASS</span> <a href="DaemonController/ConnectError.html">DaemonController::ConnectError</a></li>
        
        <li><span class="type">CLASS</span> <a href="DaemonController/DaemonizationTimeout.html">DaemonController::DaemonizationTimeout</a></li>
        
        <li><span class="type">CLASS</span> <a href="DaemonController/Error.html">DaemonController::Error</a></li>
        
        <li><span class="type">CLASS</span> <a href="DaemonController/LockFile.html">DaemonController::LockFile</a></li>
        
        <li><span class="type">CLASS</span> <a href="DaemonController/StartError.html">DaemonController::StartError</a></li>
        
        <li><span class="type">CLASS</span> <a href="DaemonController/StartTimeout.html">DaemonController::StartTimeout</a></li>
        
        <li><span class="type">CLASS</span> <a href="DaemonController/StopError.html">DaemonController::StopError</a></li>
        
        <li><span class="type">CLASS</span> <a href="DaemonController/StopTimeout.html">DaemonController::StopTimeout</a></li>
        
        <li><span class="type">CLASS</span> <a href="DaemonController/TimeoutError.html">DaemonController::TimeoutError</a></li>
        
    </ul>
    

    
    <div class="sectiontitle">Constants</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class="attr-name">MAJOR</td>
            <td>=</td>
            <td class="attr-value">1</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">MINOR</td>
            <td>=</td>
            <td class="attr-value">0</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">TINY</td>
            <td>=</td>
            <td class="attr-value">0</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">VERSION_STRING</td>
            <td>=</td>
            <td class="attr-value">&quot;#{MAJOR}.#{MINOR}.#{TINY}&quot;</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">ALLOWED_CONNECT_EXCEPTIONS</td>
            <td>=</td>
            <td class="attr-value">[Errno::ECONNREFUSED, Errno::ENETUNREACH,     Errno::ETIMEDOUT, Errno::ECONNRESET, Errno::EINVAL,     Errno::EADDRNOTAVAIL]</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">SPAWNER_FILE</td>
            <td>=</td>
            <td class="attr-value">File.expand_path(File.join(File.dirname(__FILE__),     &quot;daemon_controller&quot;, &quot;spawn.rb&quot;))</td>
        </tr>
        
        
    </table>
    

    

    
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000007">
                    
                    <a name="M000007"></a><b>connect</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Connect to the daemon by running the given block, which contains the
connection logic. If the daemon isn&#8217;t already running, then it will
be started.
</p>
<p>
The block must return nil or raise Errno::ECONNREFUSED, Errno::ENETUNREACH,
Errno::ETIMEDOUT, Errno::ECONNRESET, Errno::EINVAL and Errno::EADDRNOTAVAIL
to indicate that the daemon cannot be connected to. It must return non-nil
if the daemon can be connected to. Upon successful connection, the return
value of the block will be returned by <a
href="DaemonController.html#M000007">connect</a>.
</p>
<p>
Note that the block may be called multiple times.
</p>
<p>
Raises:
</p>
<ul>
<li><a href="DaemonController/StartError.html">StartError</a> - an attempt to
start the daemon was made, but the start command failed with an error.

</li>
<li><a href="DaemonController/StartTimeout.html">StartTimeout</a> - an attempt
to start the daemon was made, but the daemon did not start in time, or it
failed after it has gone into the background.

</li>
<li><a href="DaemonController/ConnectError.html">ConnectError</a> - the daemon
wasn&#8217;t already running, but we couldn&#8217;t connect to the daemon
even after starting it.

</li>
</ul>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000007_source')" id="l_M000007_source">show</a>
                        
                    </p>
                    <div id="M000007_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 231</span>
231:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">connect</span>
232:     <span class="ruby-identifier">connection</span> = <span class="ruby-keyword kw">nil</span>
233:     <span class="ruby-ivar">@lock_file</span>.<span class="ruby-identifier">shared_lock</span> <span class="ruby-keyword kw">do</span>
234:       <span class="ruby-keyword kw">begin</span>
235:         <span class="ruby-identifier">connection</span> = <span class="ruby-keyword kw">yield</span>
236:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">*</span><span class="ruby-constant">ALLOWED_CONNECT_EXCEPTIONS</span>
237:         <span class="ruby-identifier">connection</span> = <span class="ruby-keyword kw">nil</span>
238:       <span class="ruby-keyword kw">end</span>
239:     <span class="ruby-keyword kw">end</span>
240:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">nil?</span>
241:       <span class="ruby-ivar">@lock_file</span>.<span class="ruby-identifier">exclusive_lock</span> <span class="ruby-keyword kw">do</span>
242:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">daemon_is_running?</span>
243:           <span class="ruby-identifier">start_without_locking</span>
244:         <span class="ruby-keyword kw">end</span>
245:         <span class="ruby-identifier">connect_exception</span> = <span class="ruby-keyword kw">nil</span>
246:         <span class="ruby-keyword kw">begin</span>
247:           <span class="ruby-identifier">connection</span> = <span class="ruby-keyword kw">yield</span>
248:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">*</span><span class="ruby-constant">ALLOWED_CONNECT_EXCEPTIONS</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
249:           <span class="ruby-identifier">connection</span> = <span class="ruby-keyword kw">nil</span>
250:           <span class="ruby-identifier">connect_exception</span> = <span class="ruby-identifier">e</span>
251:         <span class="ruby-keyword kw">end</span>
252:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">nil?</span>
253:           <span class="ruby-comment cmt"># Daemon is running but we couldn't connect to it. Possible</span>
254:           <span class="ruby-comment cmt"># reasons:</span>
255:           <span class="ruby-comment cmt"># - The daemon froze.</span>
256:           <span class="ruby-comment cmt"># - Bizarre security restrictions.</span>
257:           <span class="ruby-comment cmt"># - There's a bug in the yielded code.</span>
258:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">connect_exception</span>
259:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConnectError</span>, <span class="ruby-node">&quot;Cannot connect to the daemon: #{connect_exception} (#{connect_exception.class})&quot;</span>
260:           <span class="ruby-keyword kw">else</span>
261:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConnectError</span>, <span class="ruby-value str">&quot;Cannot connect to the daemon&quot;</span>
262:           <span class="ruby-keyword kw">end</span>
263:         <span class="ruby-keyword kw">else</span>
264:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">connection</span>
265:         <span class="ruby-keyword kw">end</span>
266:       <span class="ruby-keyword kw">end</span>
267:     <span class="ruby-keyword kw">else</span>
268:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">connection</span>
269:     <span class="ruby-keyword kw">end</span>
270:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000009">
                    
                    <a name="M000009"></a><b>pid</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Returns the daemon&#8217;s PID, as reported by its PID file. Returns the
PID as an integer, or nil there is no valid PID in the PID file.
</p>
<p>
This method doesn&#8217;t check whether the daemon&#8217;s actually
running. Use <a href="DaemonController.html#M000010">running?</a> if you
want to check whether it&#8217;s actually running.
</p>
<p>
Raises SystemCallError or IOError if something went wrong during reading of
the PID file.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000009_source')" id="l_M000009_source">show</a>
                        
                    </p>
                    <div id="M000009_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 300</span>
300:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pid</span>
301:     <span class="ruby-ivar">@lock_file</span>.<span class="ruby-identifier">shared_lock</span> <span class="ruby-keyword kw">do</span>
302:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">read_pid_file</span>
303:     <span class="ruby-keyword kw">end</span>
304:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000010">
                    
                    <a name="M000010"></a><b>running?</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Checks whether the daemon is still running. This is done by reading the PID
file and then checking whether there is a process with that PID.
</p>
<p>
Raises SystemCallError or IOError if something went wrong during reading of
the PID file.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000010_source')" id="l_M000010_source">show</a>
                        
                    </p>
                    <div id="M000010_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 312</span>
312:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">running?</span>
313:     <span class="ruby-ivar">@lock_file</span>.<span class="ruby-identifier">shared_lock</span> <span class="ruby-keyword kw">do</span>
314:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">daemon_is_running?</span>
315:     <span class="ruby-keyword kw">end</span>
316:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000006">
                    
                    <a name="M000006"></a><b>start</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Start the daemon and wait until it can be pinged.
</p>
<p>
Raises:
</p>
<ul>
<li><a href="DaemonController/AlreadyStarted.html">AlreadyStarted</a> - the
daemon is already running.

</li>
<li><a href="DaemonController/StartError.html">StartError</a> - the start
command failed.

</li>
<li><a href="DaemonController/StartTimeout.html">StartTimeout</a> - the daemon
did not start in time. This could also mean that the daemon failed after it
has gone into the background.

</li>
</ul>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000006_source')" id="l_M000006_source">show</a>
                        
                    </p>
                    <div id="M000006_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 205</span>
205:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start</span>
206:     <span class="ruby-ivar">@lock_file</span>.<span class="ruby-identifier">exclusive_lock</span> <span class="ruby-keyword kw">do</span>
207:       <span class="ruby-identifier">start_without_locking</span>
208:     <span class="ruby-keyword kw">end</span>
209:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000008">
                    
                    <a name="M000008"></a><b>stop</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Stop the daemon and wait until it has exited.
</p>
<p>
Raises:
</p>
<ul>
<li><a href="DaemonController/StopError.html">StopError</a> - the stop command
failed.

</li>
<li><a href="DaemonController/StopTimeout.html">StopTimeout</a> - the daemon
didn&#8217;t stop in time.

</li>
</ul>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000008_source')" id="l_M000008_source">show</a>
                        
                    </p>
                    <div id="M000008_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 277</span>
277:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">stop</span>
278:     <span class="ruby-ivar">@lock_file</span>.<span class="ruby-identifier">exclusive_lock</span> <span class="ruby-keyword kw">do</span>
279:       <span class="ruby-keyword kw">begin</span>
280:         <span class="ruby-constant">Timeout</span>.<span class="ruby-identifier">timeout</span>(<span class="ruby-ivar">@stop_timeout</span>, <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>) <span class="ruby-keyword kw">do</span>
281:           <span class="ruby-identifier">kill_daemon</span>
282:           <span class="ruby-identifier">wait_until</span> <span class="ruby-keyword kw">do</span>
283:             <span class="ruby-operator">!</span><span class="ruby-identifier">daemon_is_running?</span>
284:           <span class="ruby-keyword kw">end</span>
285:         <span class="ruby-keyword kw">end</span>
286:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>
287:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">StopTimeout</span>, <span class="ruby-node">&quot;Daemon '#{@identifier}' did not exit in time&quot;</span>
288:       <span class="ruby-keyword kw">end</span>
289:     <span class="ruby-keyword kw">end</span>
290:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Private methods</div>
            
            <div class="method">
                <div class="title" id="M000012">
                    
                    <a name="M000012"></a><b>before_start</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000012_source')" id="l_M000012_source">show</a>
                        
                    </p>
                    <div id="M000012_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 386</span>
386:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">before_start</span>
387:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@before_start</span>
388:       <span class="ruby-ivar">@before_start</span>.<span class="ruby-identifier">call</span>
389:     <span class="ruby-keyword kw">end</span>
390:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000019">
                    
                    <a name="M000019"></a><b>check_pid</b>(pid)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000019_source')" id="l_M000019_source">show</a>
                        
                    </p>
                    <div id="M000019_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 457</span>
457:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">check_pid</span>(<span class="ruby-identifier">pid</span>)
458:     <span class="ruby-constant">Process</span>.<span class="ruby-identifier">kill</span>(<span class="ruby-value">0</span>, <span class="ruby-identifier">pid</span>)
459:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
460:   <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ESRCH</span>
461:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
462:   <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EPERM</span>
463:     <span class="ruby-comment cmt"># We didn't have permission to kill the process. Either the process</span>
464:     <span class="ruby-comment cmt"># is owned by someone else, or the system has draconian security</span>
465:     <span class="ruby-comment cmt"># settings and we aren't allowed to kill *any* process. Assume that</span>
466:     <span class="ruby-comment cmt"># the process is running.</span>
467:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
468:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000016">
                    
                    <a name="M000016"></a><b>daemon_is_running?</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000016_source')" id="l_M000016_source">show</a>
                        
                    </p>
                    <div id="M000016_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 424</span>
424:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">daemon_is_running?</span>
425:     <span class="ruby-keyword kw">begin</span>
426:       <span class="ruby-identifier">pid</span> = <span class="ruby-identifier">read_pid_file</span>
427:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ENOENT</span>
428:       <span class="ruby-comment cmt"># The PID file may not exist, or another thread/process</span>
429:       <span class="ruby-comment cmt"># executing #running? may have just deleted the PID file.</span>
430:       <span class="ruby-comment cmt"># So we catch this error.</span>
431:       <span class="ruby-identifier">pid</span> = <span class="ruby-keyword kw">nil</span>
432:     <span class="ruby-keyword kw">end</span>
433:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pid</span>.<span class="ruby-identifier">nil?</span>
434:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
435:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">check_pid</span>(<span class="ruby-identifier">pid</span>)
436:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
437:     <span class="ruby-keyword kw">else</span>
438:       <span class="ruby-identifier">delete_pid_file</span>
439:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
440:     <span class="ruby-keyword kw">end</span>
441:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000027">
                    
                    <a name="M000027"></a><b>daemonization_timed_out</b>()
                    
                </div>
                
                <div class="description">
                  <p>
This method does nothing and only serves as a hook for the unit test.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000027_source')" id="l_M000027_source">show</a>
                        
                    </p>
                    <div id="M000027_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 508</span>
508:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">daemonization_timed_out</span>
509:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000018">
                    
                    <a name="M000018"></a><b>delete_pid_file</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000018_source')" id="l_M000018_source">show</a>
                        
                    </p>
                    <div id="M000018_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 452</span>
452:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete_pid_file</span>
453:     <span class="ruby-constant">File</span>.<span class="ruby-identifier">unlink</span>(<span class="ruby-ivar">@pid_file</span>)
454:   <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EPERM</span>, <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EACCES</span>, <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ENOENT</span> <span class="ruby-comment cmt"># ignore</span>
455:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000031">
                    
                    <a name="M000031"></a><b>determine_lock_file</b>(options, identifier, pid_file)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000031_source')" id="l_M000031_source">show</a>
                        
                    </p>
                    <div id="M000031_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 550</span>
550:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">determine_lock_file</span>(<span class="ruby-identifier">options</span>, <span class="ruby-identifier">identifier</span>, <span class="ruby-identifier">pid_file</span>)
551:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:lock_file</span>]
552:       <span class="ruby-keyword kw">return</span> <span class="ruby-constant">LockFile</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:lock_file</span>]))
553:     <span class="ruby-keyword kw">else</span>
554:       <span class="ruby-keyword kw">return</span> <span class="ruby-constant">LockFile</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">pid_file</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;.lock&quot;</span>))
555:     <span class="ruby-keyword kw">end</span>
556:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000030">
                    
                    <a name="M000030"></a><b>differences_in_log_file</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000030_source')" id="l_M000030_source">show</a>
                        
                    </p>
                    <div id="M000030_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 532</span>
532:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">differences_in_log_file</span>
533:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@original_log_file_stat</span>
534:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-ivar">@log_file</span>, <span class="ruby-value str">'r'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
535:         <span class="ruby-identifier">f</span>.<span class="ruby-identifier">seek</span>(<span class="ruby-ivar">@original_log_file_stat</span>.<span class="ruby-identifier">size</span>, <span class="ruby-constant">IO</span><span class="ruby-operator">::</span><span class="ruby-constant">SEEK_SET</span>)
536:         <span class="ruby-identifier">diff</span> = <span class="ruby-identifier">f</span>.<span class="ruby-identifier">read</span>.<span class="ruby-identifier">strip</span>
537:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">diff</span>.<span class="ruby-identifier">empty?</span>
538:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
539:         <span class="ruby-keyword kw">else</span>
540:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">diff</span>
541:         <span class="ruby-keyword kw">end</span>
542:       <span class="ruby-keyword kw">end</span>
543:     <span class="ruby-keyword kw">else</span>
544:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
545:     <span class="ruby-keyword kw">end</span>
546:   <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ENOENT</span>
547:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
548:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000036">
                    
                    <a name="M000036"></a><b>interruptable_waitpid</b>(pid)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000036_source')" id="l_M000036_source">show</a>
                        
                    </p>
                    <div id="M000036_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 740</span>
740:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">interruptable_waitpid</span>(<span class="ruby-identifier">pid</span>)
741:       <span class="ruby-constant">Process</span>.<span class="ruby-identifier">waitpid</span>(<span class="ruby-identifier">pid</span>)
742:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000037">
                    
                    <a name="M000037"></a><b>interruptable_waitpid</b>(pid)
                    
                </div>
                
                <div class="description">
                  <p>
On Ruby 1.9, Thread#kill (which is called by timeout.rb) may not be able to
interrupt Process.waitpid. So here we use a special version that&#8217;s a
bit less efficient but is at least interruptable.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000037_source')" id="l_M000037_source">show</a>
                        
                    </p>
                    <div id="M000037_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 748</span>
748:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">interruptable_waitpid</span>(<span class="ruby-identifier">pid</span>)
749:       <span class="ruby-identifier">result</span> = <span class="ruby-keyword kw">nil</span>
750:       <span class="ruby-keyword kw">while</span> <span class="ruby-operator">!</span><span class="ruby-identifier">result</span>
751:         <span class="ruby-identifier">result</span> = <span class="ruby-constant">Process</span>.<span class="ruby-identifier">waitpid</span>(<span class="ruby-identifier">pid</span>, <span class="ruby-constant">Process</span><span class="ruby-operator">::</span><span class="ruby-constant">WNOHANG</span>)
752:         <span class="ruby-identifier">sleep</span> <span class="ruby-value">0</span><span class="ruby-value">.01</span> <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">result</span>
753:       <span class="ruby-keyword kw">end</span>
754:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">result</span>
755:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000014">
                    
                    <a name="M000014"></a><b>kill_daemon</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000014_source')" id="l_M000014_source">show</a>
                        
                    </p>
                    <div id="M000014_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 400</span>
400:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">kill_daemon</span>
401:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@stop_command</span>
402:       <span class="ruby-keyword kw">begin</span>
403:         <span class="ruby-identifier">run_command</span>(<span class="ruby-ivar">@stop_command</span>)
404:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">StartError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
405:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">StopError</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>
406:       <span class="ruby-keyword kw">end</span>
407:     <span class="ruby-keyword kw">else</span>
408:       <span class="ruby-identifier">kill_daemon_with_signal</span>
409:     <span class="ruby-keyword kw">end</span>
410:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000015">
                    
                    <a name="M000015"></a><b>kill_daemon_with_signal</b>(force = false)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000015_source')" id="l_M000015_source">show</a>
                        
                    </p>
                    <div id="M000015_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 412</span>
412:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">kill_daemon_with_signal</span>(<span class="ruby-identifier">force</span> = <span class="ruby-keyword kw">false</span>)
413:     <span class="ruby-identifier">pid</span> = <span class="ruby-identifier">read_pid_file</span>
414:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pid</span>
415:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">force</span>
416:         <span class="ruby-constant">Process</span>.<span class="ruby-identifier">kill</span>(<span class="ruby-value str">'SIGKILL'</span>, <span class="ruby-identifier">pid</span>)
417:       <span class="ruby-keyword kw">else</span>
418:         <span class="ruby-constant">Process</span>.<span class="ruby-identifier">kill</span>(<span class="ruby-value str">'SIGTERM'</span>, <span class="ruby-identifier">pid</span>)
419:       <span class="ruby-keyword kw">end</span>
420:     <span class="ruby-keyword kw">end</span>
421:   <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ESRCH</span>, <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ENOENT</span>
422:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000029">
                    
                    <a name="M000029"></a><b>log_file_has_changed?</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000029_source')" id="l_M000029_source">show</a>
                        
                    </p>
                    <div id="M000029_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 516</span>
516:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">log_file_has_changed?</span>
517:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_log_file_stat</span>
518:       <span class="ruby-identifier">stat</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">stat</span>(<span class="ruby-ivar">@log_file</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
519:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stat</span>
520:         <span class="ruby-identifier">result</span> = <span class="ruby-ivar">@current_log_file_stat</span>.<span class="ruby-identifier">mtime</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">stat</span>.<span class="ruby-identifier">mtime</span> <span class="ruby-operator">||</span>
521:                  <span class="ruby-ivar">@current_log_file_stat</span>.<span class="ruby-identifier">size</span>  <span class="ruby-operator">!=</span> <span class="ruby-identifier">stat</span>.<span class="ruby-identifier">size</span>
522:         <span class="ruby-ivar">@current_log_file_stat</span> = <span class="ruby-identifier">stat</span>
523:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">result</span>
524:       <span class="ruby-keyword kw">else</span>
525:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
526:       <span class="ruby-keyword kw">end</span>
527:     <span class="ruby-keyword kw">else</span>
528:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
529:     <span class="ruby-keyword kw">end</span>
530:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000024">
                    
                    <a name="M000024"></a><b>no_activity?</b>(seconds)
                    
                </div>
                
                <div class="description">
                  <p>
Check whether there has been no recorded activity in the past
<tt>seconds</tt> seconds.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000024_source')" id="l_M000024_source">show</a>
                        
                    </p>
                    <div id="M000024_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 495</span>
495:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">no_activity?</span>(<span class="ruby-identifier">seconds</span>)
496:     <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@last_activity_time</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">seconds</span>
497:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000025">
                    
                    <a name="M000025"></a><b>pid_file_available?</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000025_source')" id="l_M000025_source">show</a>
                        
                    </p>
                    <div id="M000025_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 499</span>
499:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pid_file_available?</span>
500:     <span class="ruby-keyword kw">return</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-ivar">@pid_file</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">stat</span>(<span class="ruby-ivar">@pid_file</span>).<span class="ruby-identifier">size</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
501:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000017">
                    
                    <a name="M000017"></a><b>read_pid_file</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000017_source')" id="l_M000017_source">show</a>
                        
                    </p>
                    <div id="M000017_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 443</span>
443:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_pid_file</span>
444:     <span class="ruby-identifier">pid</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">read</span>(<span class="ruby-ivar">@pid_file</span>).<span class="ruby-identifier">strip</span>
445:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pid</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/\A\d+\Z/</span>
446:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">pid</span>.<span class="ruby-identifier">to_i</span>
447:     <span class="ruby-keyword kw">else</span>
448:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
449:     <span class="ruby-keyword kw">end</span>
450:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000023">
                    
                    <a name="M000023"></a><b>record_activity</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000023_source')" id="l_M000023_source">show</a>
                        
                    </p>
                    <div id="M000023_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 490</span>
490:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">record_activity</span>
491:     <span class="ruby-ivar">@last_activity_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
492:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000033">
                    
                    <a name="M000033"></a><b>run_command</b>(command)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000033_source')" id="l_M000033_source">show</a>
                        
                    </p>
                    <div id="M000033_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 562</span>
562:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">run_command</span>(<span class="ruby-identifier">command</span>)
563:     <span class="ruby-comment cmt"># Create tempfile for storing the command's output.</span>
564:     <span class="ruby-identifier">tempfile</span> = <span class="ruby-constant">Tempfile</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'daemon-output'</span>)
565:     <span class="ruby-identifier">tempfile_path</span> = <span class="ruby-identifier">tempfile</span>.<span class="ruby-identifier">path</span>
566:     <span class="ruby-constant">File</span>.<span class="ruby-identifier">chmod</span>(<span class="ruby-value">0666</span>, <span class="ruby-identifier">tempfile_path</span>)
567:     <span class="ruby-identifier">tempfile</span>.<span class="ruby-identifier">close</span>
568:     
569:     <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">fork_supported?</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Process</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:spawn</span>)
570:       <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Process</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:spawn</span>)
571:         <span class="ruby-identifier">options</span> = {
572:           <span class="ruby-identifier">:in</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;/dev/null&quot;</span>,
573:           <span class="ruby-identifier">:out</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">tempfile_path</span>,
574:           <span class="ruby-identifier">:err</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">tempfile_path</span>,
575:           <span class="ruby-identifier">:close_others</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
576:         }
577:         <span class="ruby-ivar">@keep_ios</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
578:           <span class="ruby-identifier">options</span>[<span class="ruby-identifier">io</span>] = <span class="ruby-identifier">io</span>
579:         <span class="ruby-keyword kw">end</span>
580:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@daemonize_for_me</span>
581:           <span class="ruby-identifier">ruby_interpreter</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(
582:             <span class="ruby-constant">Config</span><span class="ruby-operator">::</span><span class="ruby-constant">CONFIG</span>[<span class="ruby-value str">'bindir'</span>],
583:             <span class="ruby-constant">Config</span><span class="ruby-operator">::</span><span class="ruby-constant">CONFIG</span>[<span class="ruby-value str">'RUBY_INSTALL_NAME'</span>]
584:           ) <span class="ruby-operator">+</span> <span class="ruby-constant">Config</span><span class="ruby-operator">::</span><span class="ruby-constant">CONFIG</span>[<span class="ruby-value str">'EXEEXT'</span>]
585:           <span class="ruby-identifier">pid</span> = <span class="ruby-constant">Process</span>.<span class="ruby-identifier">spawn</span>(<span class="ruby-identifier">ruby_interpreter</span>, <span class="ruby-constant">SPAWNER_FILE</span>,
586:             <span class="ruby-identifier">command</span>, <span class="ruby-identifier">options</span>)
587:         <span class="ruby-keyword kw">else</span>
588:           <span class="ruby-identifier">pid</span> = <span class="ruby-constant">Process</span>.<span class="ruby-identifier">spawn</span>(<span class="ruby-identifier">command</span>, <span class="ruby-identifier">options</span>)
589:         <span class="ruby-keyword kw">end</span>
590:       <span class="ruby-keyword kw">else</span>
591:         <span class="ruby-identifier">pid</span> = <span class="ruby-identifier">safe_fork</span>(<span class="ruby-ivar">@daemonize_for_me</span>) <span class="ruby-keyword kw">do</span>
592:           <span class="ruby-constant">ObjectSpace</span>.<span class="ruby-identifier">each_object</span>(<span class="ruby-constant">IO</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span>
593:             <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@keep_ios</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">obj</span>)
594:               <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
595:             <span class="ruby-keyword kw">end</span>
596:           <span class="ruby-keyword kw">end</span>
597:           <span class="ruby-constant">STDIN</span>.<span class="ruby-identifier">reopen</span>(<span class="ruby-value str">&quot;/dev/null&quot;</span>, <span class="ruby-value str">&quot;r&quot;</span>)
598:           <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">reopen</span>(<span class="ruby-identifier">tempfile_path</span>, <span class="ruby-value str">&quot;w&quot;</span>)
599:           <span class="ruby-constant">STDERR</span>.<span class="ruby-identifier">reopen</span>(<span class="ruby-identifier">tempfile_path</span>, <span class="ruby-value str">&quot;w&quot;</span>)
600:           <span class="ruby-identifier">exec</span>(<span class="ruby-identifier">command</span>)
601:         <span class="ruby-keyword kw">end</span>
602:       <span class="ruby-keyword kw">end</span>
603:       
604:       <span class="ruby-comment cmt"># run_command might be running in a timeout block (like</span>
605:       <span class="ruby-comment cmt"># in #start_without_locking).</span>
606:       <span class="ruby-keyword kw">begin</span>
607:         <span class="ruby-identifier">interruptable_waitpid</span>(<span class="ruby-identifier">pid</span>)
608:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECHILD</span>
609:         <span class="ruby-comment cmt"># Maybe a background thread or whatever waitpid()'ed</span>
610:         <span class="ruby-comment cmt"># this child process before we had the chance. There's</span>
611:         <span class="ruby-comment cmt"># no way to obtain the exit status now. Assume that</span>
612:         <span class="ruby-comment cmt"># it started successfully; if it didn't we'll know</span>
613:         <span class="ruby-comment cmt"># that later by checking the PID file and by pinging</span>
614:         <span class="ruby-comment cmt"># it.</span>
615:         <span class="ruby-keyword kw">return</span>
616:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>
617:         <span class="ruby-identifier">daemonization_timed_out</span>
618:         
619:         <span class="ruby-comment cmt"># If the daemon doesn't fork into the background</span>
620:         <span class="ruby-comment cmt"># in time, then kill it.</span>
621:         <span class="ruby-keyword kw">begin</span>
622:           <span class="ruby-constant">Process</span>.<span class="ruby-identifier">kill</span>(<span class="ruby-value str">'SIGTERM'</span>, <span class="ruby-identifier">pid</span>)
623:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SystemCallError</span>
624:         <span class="ruby-keyword kw">end</span>
625:         <span class="ruby-keyword kw">begin</span>
626:           <span class="ruby-constant">Timeout</span>.<span class="ruby-identifier">timeout</span>(<span class="ruby-value">5</span>, <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>) <span class="ruby-keyword kw">do</span>
627:             <span class="ruby-keyword kw">begin</span>
628:               <span class="ruby-identifier">interruptable_waitpid</span>(<span class="ruby-identifier">pid</span>)
629:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SystemCallError</span>
630:             <span class="ruby-keyword kw">end</span>
631:           <span class="ruby-keyword kw">end</span>
632:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>
633:           <span class="ruby-keyword kw">begin</span>
634:             <span class="ruby-constant">Process</span>.<span class="ruby-identifier">kill</span>(<span class="ruby-value str">'SIGKILL'</span>, <span class="ruby-identifier">pid</span>)
635:             <span class="ruby-identifier">interruptable_waitpid</span>(<span class="ruby-identifier">pid</span>)
636:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SystemCallError</span>
637:           <span class="ruby-keyword kw">end</span>
638:         <span class="ruby-keyword kw">end</span>
639:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">DaemonizationTimeout</span>
640:       <span class="ruby-keyword kw">end</span>
641:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$?</span>.<span class="ruby-identifier">exitstatus</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
642:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">StartError</span>, <span class="ruby-constant">File</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">tempfile_path</span>).<span class="ruby-identifier">strip</span>
643:       <span class="ruby-keyword kw">end</span>
644:     <span class="ruby-keyword kw">else</span>
645:       <span class="ruby-identifier">cmd</span> = <span class="ruby-node">&quot;#{command} &gt;\&quot;#{tempfile_path}\&quot;&quot;</span>
646:       <span class="ruby-identifier">cmd</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot; 2&gt;\&quot;#{tempfile_path}\&quot;&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">PLATFORM</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/mswin/</span>
647:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">system</span>(<span class="ruby-identifier">cmd</span>)
648:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">StartError</span>, <span class="ruby-constant">File</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">tempfile_path</span>).<span class="ruby-identifier">strip</span>
649:       <span class="ruby-keyword kw">end</span>
650:     <span class="ruby-keyword kw">end</span>
651:   <span class="ruby-keyword kw">ensure</span>
652:     <span class="ruby-constant">File</span>.<span class="ruby-identifier">unlink</span>(<span class="ruby-identifier">tempfile_path</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
653:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000034">
                    
                    <a name="M000034"></a><b>run_ping_command</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000034_source')" id="l_M000034_source">show</a>
                        
                    </p>
                    <div id="M000034_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 655</span>
655:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">run_ping_command</span>
656:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@ping_command</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:call</span>)
657:       <span class="ruby-keyword kw">begin</span>
658:         <span class="ruby-identifier">value</span> = <span class="ruby-ivar">@ping_command</span>.<span class="ruby-identifier">call</span>
659:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:close</span>)
660:           <span class="ruby-identifier">value</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
661:         <span class="ruby-keyword kw">end</span>
662:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">value</span>
663:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">*</span><span class="ruby-constant">ALLOWED_CONNECT_EXCEPTIONS</span>
664:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
665:       <span class="ruby-keyword kw">end</span>
666:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@ping_command</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>)
667:       <span class="ruby-identifier">type</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span> = <span class="ruby-ivar">@ping_command</span>
668:       
669:       <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">type</span>
670:       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:tcp</span>
671:         <span class="ruby-identifier">socket_domain</span> = <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">Constants</span><span class="ruby-operator">::</span><span class="ruby-constant">AF_INET</span>
672:         <span class="ruby-identifier">hostname</span>, <span class="ruby-identifier">port</span> = <span class="ruby-identifier">args</span>
673:         <span class="ruby-identifier">sockaddr</span> = <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">pack_sockaddr_in</span>(<span class="ruby-identifier">port</span>, <span class="ruby-identifier">hostname</span>)
674:       <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:unix</span>
675:         <span class="ruby-identifier">socket_domain</span> = <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">Constants</span><span class="ruby-operator">::</span><span class="ruby-constant">AF_LOCAL</span>
676:         <span class="ruby-identifier">sockaddr</span> = <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">pack_sockaddr_un</span>(<span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>])
677:       <span class="ruby-keyword kw">else</span>
678:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-node">&quot;Unknown ping command type #{type.inspect}&quot;</span>
679:       <span class="ruby-keyword kw">end</span>
680: 
681:       <span class="ruby-keyword kw">begin</span>
682:         <span class="ruby-identifier">socket</span> = <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">socket_domain</span>, <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">Constants</span><span class="ruby-operator">::</span><span class="ruby-constant">SOCK_STREAM</span>, <span class="ruby-value">0</span>)
683:         <span class="ruby-keyword kw">begin</span>
684:           <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">connect_nonblock</span>(<span class="ruby-identifier">sockaddr</span>)
685:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ENOENT</span>, <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EINPROGRESS</span>, <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EAGAIN</span>, <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EWOULDBLOCK</span>
686:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">select</span>(<span class="ruby-keyword kw">nil</span>, [<span class="ruby-identifier">socket</span>], <span class="ruby-keyword kw">nil</span>, <span class="ruby-value">0</span><span class="ruby-value">.1</span>)
687:             <span class="ruby-keyword kw">begin</span>
688:               <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">connect_nonblock</span>(<span class="ruby-identifier">sockaddr</span>)
689:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EISCONN</span>
690:             <span class="ruby-keyword kw">end</span>
691:           <span class="ruby-keyword kw">else</span>
692:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNREFUSED</span>
693:           <span class="ruby-keyword kw">end</span>
694:         <span class="ruby-keyword kw">end</span>
695:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
696:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNREFUSED</span>, <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ENOENT</span>
697:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
698:       <span class="ruby-keyword kw">ensure</span>
699:         <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">socket</span>
700:       <span class="ruby-keyword kw">end</span>
701:     <span class="ruby-keyword kw">else</span>
702:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">system</span>(<span class="ruby-ivar">@ping_command</span>)
703:     <span class="ruby-keyword kw">end</span>
704:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000035">
                    
                    <a name="M000035"></a><b>safe_fork</b>(double_fork)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000035_source')" id="l_M000035_source">show</a>
                        
                    </p>
                    <div id="M000035_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 706</span>
706:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">safe_fork</span>(<span class="ruby-identifier">double_fork</span>)
707:     <span class="ruby-identifier">pid</span> = <span class="ruby-identifier">fork</span>
708:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pid</span>.<span class="ruby-identifier">nil?</span>
709:       <span class="ruby-keyword kw">begin</span>
710:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">double_fork</span>
711:           <span class="ruby-identifier">pid2</span> = <span class="ruby-identifier">fork</span>
712:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pid2</span>.<span class="ruby-identifier">nil?</span>
713:             <span class="ruby-constant">Process</span>.<span class="ruby-identifier">setsid</span>
714:             <span class="ruby-keyword kw">yield</span>
715:           <span class="ruby-keyword kw">end</span>
716:         <span class="ruby-keyword kw">else</span>
717:           <span class="ruby-keyword kw">yield</span>
718:         <span class="ruby-keyword kw">end</span>
719:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
720:         <span class="ruby-identifier">message</span> = <span class="ruby-node">&quot;*** Exception #{e.class} &quot;</span> <span class="ruby-operator">&lt;&lt;</span>
721:           <span class="ruby-node">&quot;(#{e}) (process #{$$}):\n&quot;</span> <span class="ruby-operator">&lt;&lt;</span>
722:           <span class="ruby-value str">&quot;\tfrom &quot;</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">backtrace</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;\n\tfrom &quot;</span>)
723:         <span class="ruby-constant">STDERR</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">e</span>)
724:         <span class="ruby-constant">STDERR</span>.<span class="ruby-identifier">flush</span>
725:         <span class="ruby-identifier">exit!</span>
726:       <span class="ruby-keyword kw">ensure</span>
727:         <span class="ruby-identifier">exit!</span>(<span class="ruby-value">0</span>)
728:       <span class="ruby-keyword kw">end</span>
729:     <span class="ruby-keyword kw">else</span>
730:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">double_fork</span>
731:         <span class="ruby-constant">Process</span>.<span class="ruby-identifier">waitpid</span>(<span class="ruby-identifier">pid</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
732:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">pid</span>
733:       <span class="ruby-keyword kw">else</span>
734:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">pid</span>
735:       <span class="ruby-keyword kw">end</span>
736:     <span class="ruby-keyword kw">end</span>
737:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000028">
                    
                    <a name="M000028"></a><b>save_log_file_information</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000028_source')" id="l_M000028_source">show</a>
                        
                    </p>
                    <div id="M000028_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 511</span>
511:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">save_log_file_information</span>
512:     <span class="ruby-ivar">@original_log_file_stat</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">stat</span>(<span class="ruby-ivar">@log_file</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
513:     <span class="ruby-ivar">@current_log_file_stat</span> = <span class="ruby-ivar">@original_log_file_stat</span>
514:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000013">
                    
                    <a name="M000013"></a><b>spawn_daemon</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000013_source')" id="l_M000013_source">show</a>
                        
                    </p>
                    <div id="M000013_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 392</span>
392:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">spawn_daemon</span>
393:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@start_command</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:call</span>)
394:       <span class="ruby-identifier">run_command</span>(<span class="ruby-ivar">@start_command</span>.<span class="ruby-identifier">call</span>)
395:     <span class="ruby-keyword kw">else</span>
396:       <span class="ruby-identifier">run_command</span>(<span class="ruby-ivar">@start_command</span>)
397:     <span class="ruby-keyword kw">end</span>
398:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000026">
                    
                    <a name="M000026"></a><b>start_timed_out</b>()
                    
                </div>
                
                <div class="description">
                  <p>
This method does nothing and only serves as a hook for the unit test.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000026_source')" id="l_M000026_source">show</a>
                        
                    </p>
                    <div id="M000026_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 504</span>
504:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_timed_out</span>
505:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000011">
                    
                    <a name="M000011"></a><b>start_without_locking</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000011_source')" id="l_M000011_source">show</a>
                        
                    </p>
                    <div id="M000011_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 319</span>
319:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_without_locking</span>
320:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">daemon_is_running?</span>
321:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">AlreadyStarted</span>, <span class="ruby-node">&quot;Daemon '#{@identifier}' is already started&quot;</span>
322:     <span class="ruby-keyword kw">end</span>
323:     <span class="ruby-identifier">save_log_file_information</span>
324:     <span class="ruby-identifier">delete_pid_file</span>
325:     <span class="ruby-keyword kw">begin</span>
326:       <span class="ruby-identifier">started</span> = <span class="ruby-keyword kw">false</span>
327:       <span class="ruby-identifier">before_start</span>
328:       <span class="ruby-constant">Timeout</span>.<span class="ruby-identifier">timeout</span>(<span class="ruby-ivar">@start_timeout</span>, <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>) <span class="ruby-keyword kw">do</span>
329:         <span class="ruby-identifier">done</span> = <span class="ruby-keyword kw">false</span>
330:         <span class="ruby-identifier">spawn_daemon</span>
331:         <span class="ruby-identifier">record_activity</span>
332:         
333:         <span class="ruby-comment cmt"># We wait until the PID file is available and until</span>
334:         <span class="ruby-comment cmt"># the daemon responds to pings, but we wait no longer</span>
335:         <span class="ruby-comment cmt"># than @start_timeout seconds in total (including daemon</span>
336:         <span class="ruby-comment cmt"># spawn time).</span>
337:         <span class="ruby-comment cmt"># Furthermore, if the log file hasn't changed for</span>
338:         <span class="ruby-comment cmt"># @log_file_activity_timeout seconds, and the PID file</span>
339:         <span class="ruby-comment cmt"># still isn't available or the daemon still doesn't</span>
340:         <span class="ruby-comment cmt"># respond to pings, then assume that the daemon has</span>
341:         <span class="ruby-comment cmt"># terminated with an error.</span>
342:         <span class="ruby-identifier">wait_until</span> <span class="ruby-keyword kw">do</span>
343:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">log_file_has_changed?</span>
344:             <span class="ruby-identifier">record_activity</span>
345:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">no_activity?</span>(<span class="ruby-ivar">@log_file_activity_timeout</span>)
346:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>, <span class="ruby-value str">&quot;Daemon seems to have exited&quot;</span>
347:           <span class="ruby-keyword kw">end</span>
348:           <span class="ruby-identifier">pid_file_available?</span>
349:         <span class="ruby-keyword kw">end</span>
350:         <span class="ruby-identifier">wait_until</span>(<span class="ruby-ivar">@ping_interval</span>) <span class="ruby-keyword kw">do</span>
351:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">log_file_has_changed?</span>
352:             <span class="ruby-identifier">record_activity</span>
353:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">no_activity?</span>(<span class="ruby-ivar">@log_file_activity_timeout</span>)
354:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>, <span class="ruby-value str">&quot;Daemon seems to have exited&quot;</span>
355:           <span class="ruby-keyword kw">end</span>
356:           <span class="ruby-identifier">run_ping_command</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">daemon_is_running?</span>
357:         <span class="ruby-keyword kw">end</span>
358:         <span class="ruby-identifier">started</span> = <span class="ruby-identifier">run_ping_command</span>
359:       <span class="ruby-keyword kw">end</span>
360:       <span class="ruby-identifier">result</span> = <span class="ruby-identifier">started</span>
361:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">DaemonizationTimeout</span>, <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
362:       <span class="ruby-identifier">start_timed_out</span>
363:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pid_file_available?</span>
364:         <span class="ruby-identifier">kill_daemon_with_signal</span>(<span class="ruby-keyword kw">true</span>)
365:       <span class="ruby-keyword kw">end</span>
366:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">DaemonizationTimeout</span>)
367:         <span class="ruby-identifier">result</span> = <span class="ruby-identifier">:daemonization_timeout</span>
368:       <span class="ruby-keyword kw">else</span>
369:         <span class="ruby-identifier">result</span> = <span class="ruby-identifier">:start_timeout</span>
370:       <span class="ruby-keyword kw">end</span>
371:     <span class="ruby-keyword kw">end</span>
372:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">result</span>
373:       <span class="ruby-identifier">raise</span>(<span class="ruby-constant">StartError</span>, <span class="ruby-identifier">differences_in_log_file</span> <span class="ruby-operator">||</span>
374:         <span class="ruby-node">&quot;Daemon '#{@identifier}' failed to start.&quot;</span>)
375:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">result</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:daemonization_timeout</span>
376:       <span class="ruby-identifier">raise</span>(<span class="ruby-constant">StartTimeout</span>, <span class="ruby-identifier">differences_in_log_file</span> <span class="ruby-operator">||</span>
377:         <span class="ruby-node">&quot;Daemon '#{@identifier}' didn't daemonize in time.&quot;</span>)
378:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">result</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:start_timeout</span>
379:       <span class="ruby-identifier">raise</span>(<span class="ruby-constant">StartTimeout</span>, <span class="ruby-identifier">differences_in_log_file</span> <span class="ruby-operator">||</span>
380:         <span class="ruby-node">&quot;Daemon '#{@identifier}' failed to start in time.&quot;</span>)
381:     <span class="ruby-keyword kw">else</span>
382:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
383:     <span class="ruby-keyword kw">end</span>
384:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000020">
                    
                    <a name="M000020"></a><b>wait_until</b>(sleep_interval = 0.1)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000020_source')" id="l_M000020_source">show</a>
                        
                    </p>
                    <div id="M000020_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 470</span>
470:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">wait_until</span>(<span class="ruby-identifier">sleep_interval</span> = <span class="ruby-value">0</span><span class="ruby-value">.1</span>)
471:     <span class="ruby-keyword kw">while</span> <span class="ruby-operator">!</span><span class="ruby-keyword kw">yield</span>
472:       <span class="ruby-identifier">sleep</span>(<span class="ruby-identifier">sleep_interval</span>)
473:     <span class="ruby-keyword kw">end</span>
474:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000022">
                    
                    <a name="M000022"></a><b>wait_until_daemon_responds_to_ping_or_has_exited_or_log_file_has_changed</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000022_source')" id="l_M000022_source">show</a>
                        
                    </p>
                    <div id="M000022_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 483</span>
483:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">wait_until_daemon_responds_to_ping_or_has_exited_or_log_file_has_changed</span>
484:     <span class="ruby-keyword kw">while</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">run_ping_command</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">daemon_is_running?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">log_file_has_changed?</span>)
485:       <span class="ruby-identifier">sleep</span>(<span class="ruby-ivar">@ping_interval</span>)
486:     <span class="ruby-keyword kw">end</span>
487:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">run_ping_command</span>
488:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000021">
                    
                    <a name="M000021"></a><b>wait_until_pid_file_is_available_or_log_file_has_changed</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000021_source')" id="l_M000021_source">show</a>
                        
                    </p>
                    <div id="M000021_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 476</span>
476:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">wait_until_pid_file_is_available_or_log_file_has_changed</span>
477:     <span class="ruby-keyword kw">while</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">pid_file_available?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">log_file_has_changed?</span>)
478:       <span class="ruby-identifier">sleep</span> <span class="ruby-value">0</span><span class="ruby-value">.1</span>
479:     <span class="ruby-keyword kw">end</span>
480:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">pid_file_is_available?</span>
481:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M000005">
                    
                    <a name="M000005"></a><b>new</b>(options)
                    
                </div>
                
                <div class="description">
                  <p>
Create a new <a href="DaemonController.html">DaemonController</a> object.
</p>
<h3>Mandatory options</h3>
<dl>
<dt>:identifier</dt><dd>A human-readable, unique name for this daemon, e.g. &#8220;Sphinx search
server&#8221;. This identifier will be used in some error messages. On some
platforms, it will be used for concurrency control: on such platforms, no
two <a href="DaemonController.html">DaemonController</a> objects will
operate on the same identifier on the same time.

</dd>
<dt>:start_command</dt><dd>The command to start the daemon. This must be a a String, e.g.
&#8220;mongrel_rails start -e production&#8221;, or a Proc which returns a
String.

<p>
If the value is a Proc, and the <tt><a
href="DaemonController.html#M000012">before_start</a></tt> option is given
too, then the <tt>start_command</tt> Proc is guaranteed to be called after
the <tt><a href="DaemonController.html#M000012">before_start</a></tt> Proc
is called.
</p>
</dd>
<dt>:ping_command</dt><dd>The ping command is used to check whether the daemon can be connected to.
It is also used to ensure that <a
href="DaemonController.html#M000006">start</a> only returns when the daemon
can be connected to.

<p>
The value may be a command string. This command must exit with an exit code
of 0 if the daemon can be successfully connected to, or exit with a non-0
exit code on failure.
</p>
<p>
The value may also be an Array which specifies the socket address of the
daemon. It must be in one of the following forms:
</p>
<ul>
<li>[:tcp, host_name, port]

</li>
<li>[:unix, filename]

</li>
</ul>
<p>
The value may also be a Proc, which returns an expression that evaluates to
true (indicating that the daemon can be connected to) or false (failure).
If the Proc raises Errno::ECONNREFUSED, Errno::ENETUNREACH,
Errno::ETIMEDOUT Errno::ECONNRESET, Errno::EINVAL or Errno::EADDRNOTAVAIL
then that also means that the daemon cannot be connected to. <b>NOTE:</b>
if the ping command returns an object which responds to <tt>close</tt>,
then that method will be called on it. This makes it possible to specify a
ping command such as <tt>lambda { TCPSocket.new('localhost', 1234) }</tt>,
without having to worry about closing it afterwards. Any exceptions raised
by close are ignored.
</p>
</dd>
<dt>:pid_file</dt><dd>The PID file that the daemon will write to. Used to check whether the
daemon is running.

</dd>
<dt>:lock_file</dt><dd>The lock file to use for serializing concurrent daemon management
operations. Defaults to &#8220;(filename of PID file).lock&#8221;.

</dd>
<dt>:log_file</dt><dd>The log file that the daemon will write to. It will be consulted to see
whether the daemon has printed any error messages during startup.

</dd>
</dl>
<h3>Optional options</h3>
<dl>
<dt>:stop_command</dt><dd>A command to stop the daemon with, e.g. &#8220;/etc/rc.d/nginx stop&#8221;.
If no stop command is given (i.e. <tt>nil</tt>), then <a
href="DaemonController.html">DaemonController</a> will stop the daemon by
killing the PID written in the PID file.

<p>
The default value is <tt>nil</tt>.
</p>
</dd>
<dt>:<a href="DaemonController.html#M000012">before_start</a></dt><dd>This may be a Proc. It will be called just before running the start
command. The <a href="DaemonController.html#M000012">before_start</a> proc
is not subject to the start timeout.

</dd>
<dt>:start_timeout</dt><dd>The maximum amount of time, in seconds, that <a
href="DaemonController.html#M000006">start</a> may take to start the
daemon. Since <a href="DaemonController.html#M000006">start</a> also waits
until the daemon can be connected to, that wait time is counted as well. If
the daemon does not start in time, then <a
href="DaemonController.html#M000006">start</a> will raise an exception.

<p>
The default value is 15.
</p>
</dd>
<dt>:stop_timeout</dt><dd>The maximum amount of time, in seconds, that <a
href="DaemonController.html#M000008">stop</a> may take to stop the daemon.
Since <a href="DaemonController.html#M000008">stop</a> also waits until the
daemon is no longer running, that wait time is counted as well. If the
daemon does not stop in time, then <a
href="DaemonController.html#M000008">stop</a> will raise an exception.

<p>
The default value is 15.
</p>
</dd>
<dt>:log_file_activity_timeout</dt><dd>Once a daemon has gone into the background, it will become difficult to
know for certain whether it is still initializing or whether it has failed
and exited, until it has written its PID file. Suppose that it failed with
an error after daemonizing but before it has written its PID file; not many
system administrators want to wait 15 seconds (the default start timeout)
to be notified of whether the daemon has terminated with an error.

<p>
An alternative way to check whether the daemon has terminated with an
error, is by checking whether its log file has been recently updated. If,
after the daemon has started, the log file hasn&#8217;t been updated for
the amount of seconds given by the :log_file_activity_timeout option, then
the daemon is assumed to have terminated with an error.
</p>
<p>
The default value is 7.
</p>
</dd>
<dt>:daemonize_for_me</dt><dd>Normally daemon_controller will wait until the daemon has daemonized into
the background, in order to capture any errors that it may print on stdout
or stderr before daemonizing. However, if the daemon doesn&#8217;t support
daemonization for some reason, then setting this option to true will cause
daemon_controller to do the daemonization for the daemon.

<p>
The default is false.
</p>
</dd>
<dt>:keep_ios</dt><dd>Upon spawning the daemon, daemon_controller will normally close all file
descriptors except stdin, stdout and stderr. However if there are any file
descriptors you want to keep open, specify the IO objects here. This must
be an array of IO objects.

</dd>
</dl>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000005_source')" id="l_M000005_source">show</a>
                        
                    </p>
                    <div id="M000005_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 176</span>
176:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">options</span>)
177:     [<span class="ruby-identifier">:identifier</span>, <span class="ruby-identifier">:start_command</span>, <span class="ruby-identifier">:ping_command</span>, <span class="ruby-identifier">:pid_file</span>, <span class="ruby-identifier">:log_file</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">option</span><span class="ruby-operator">|</span>
178:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">options</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">option</span>)
179:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-node">&quot;The ':#{option}' option is mandatory.&quot;</span>
180:       <span class="ruby-keyword kw">end</span>
181:     <span class="ruby-keyword kw">end</span>
182:     <span class="ruby-ivar">@identifier</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:identifier</span>]
183:     <span class="ruby-ivar">@start_command</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:start_command</span>]
184:     <span class="ruby-ivar">@stop_command</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:stop_command</span>]
185:     <span class="ruby-ivar">@ping_command</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:ping_command</span>]
186:     <span class="ruby-ivar">@ping_interval</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:ping_interval</span>] <span class="ruby-operator">||</span> <span class="ruby-value">0</span><span class="ruby-value">.1</span>
187:     <span class="ruby-ivar">@pid_file</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:pid_file</span>]
188:     <span class="ruby-ivar">@log_file</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:log_file</span>]
189:     <span class="ruby-ivar">@before_start</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:before_start</span>]
190:     <span class="ruby-ivar">@start_timeout</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:start_timeout</span>] <span class="ruby-operator">||</span> <span class="ruby-value">15</span>
191:     <span class="ruby-ivar">@stop_timeout</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:stop_timeout</span>] <span class="ruby-operator">||</span> <span class="ruby-value">15</span>
192:     <span class="ruby-ivar">@log_file_activity_timeout</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:log_file_activity_timeout</span>] <span class="ruby-operator">||</span> <span class="ruby-value">7</span>
193:     <span class="ruby-ivar">@daemonize_for_me</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:daemonize_for_me</span>]
194:     <span class="ruby-ivar">@keep_ios</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:keep_ios</span>] <span class="ruby-operator">||</span> []
195:     <span class="ruby-ivar">@lock_file</span> = <span class="ruby-identifier">determine_lock_file</span>(<span class="ruby-identifier">options</span>, <span class="ruby-ivar">@identifier</span>, <span class="ruby-ivar">@pid_file</span>)
196:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Class Private methods</div>
            
            <div class="method">
                <div class="title" id="M000032">
                    
                    <a name="M000032"></a><b>fork_supported?</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000032_source')" id="l_M000032_source">show</a>
                        
                    </p>
                    <div id="M000032_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemon_controller.rb, line 558</span>
558:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">fork_supported?</span>
559:     <span class="ruby-keyword kw">return</span> <span class="ruby-constant">RUBY_PLATFORM</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;java&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">RUBY_PLATFORM</span> <span class="ruby-operator">!~</span> <span class="ruby-regexp re">/win32/</span>
560:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    