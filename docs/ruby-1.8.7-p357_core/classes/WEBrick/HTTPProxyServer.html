<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>WEBrick::HTTPProxyServer</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
    <script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            WEBrick::HTTPProxyServer 
            
                <span class="parent">&lt; 
                    
                    HTTPServer
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/webrick/httpproxy_rb.html">lib/webrick/httpproxy.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M007396">choose_header</a></li>
                
            </ul>
        </dd>
    
        <dt>D</dt>
        <dd>
            <ul>
                
                <li><a href="#M007414">do_OPTIONS</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M007392">new</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M007394">proxy_auth</a>,</li>
                
                <li><a href="#M007403">proxy_connect</a>,</li>
                
                <li><a href="#M007401">proxy_service</a>,</li>
                
                <li><a href="#M007400">proxy_uri</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M007393">service</a>,</li>
                
                <li><a href="#M007397">set_cookie</a>,</li>
                
                <li><a href="#M007399">set_via</a>,</li>
                
                <li><a href="#M007395">split_field</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    

    
    <div class="sectiontitle">Constants</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class="attr-name">HopByHop</td>
            <td>=</td>
            <td class="attr-value">%w( connection keep-alive proxy-authenticate upgrade                    proxy-authorization te trailers transfer-encoding )</td>
        </tr>
        
        <tr valign='top'>
            <td>&nbsp;</td>
            <td colspan="2" class="attr-desc"><p>
Some header fields should not be transferred.
</p>
</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">ShouldNotTransfer</td>
            <td>=</td>
            <td class="attr-value">%w( set-cookie proxy-connection )</td>
        </tr>
        
        
    </table>
    

    

    
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M007396">
                    
                    <a name="M007396"></a><b>choose_header</b>(src, dst)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M007396_source')" id="l_M007396_source">show</a>
                        
                    </p>
                    <div id="M007396_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/webrick/httpproxy.rb, line 56</span>
56:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">choose_header</span>(<span class="ruby-identifier">src</span>, <span class="ruby-identifier">dst</span>)
57:       <span class="ruby-identifier">connections</span> = <span class="ruby-identifier">split_field</span>(<span class="ruby-identifier">src</span>[<span class="ruby-value str">'connection'</span>])
58:       <span class="ruby-identifier">src</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
59:         <span class="ruby-identifier">key</span> = <span class="ruby-identifier">key</span>.<span class="ruby-identifier">downcase</span>
60:         <span class="ruby-keyword kw">if</span> <span class="ruby-constant">HopByHop</span>.<span class="ruby-identifier">member?</span>(<span class="ruby-identifier">key</span>)          <span class="ruby-operator">||</span> <span class="ruby-comment cmt"># RFC2616: 13.5.1</span>
61:            <span class="ruby-identifier">connections</span>.<span class="ruby-identifier">member?</span>(<span class="ruby-identifier">key</span>)       <span class="ruby-operator">||</span> <span class="ruby-comment cmt"># RFC2616: 14.10</span>
62:            <span class="ruby-constant">ShouldNotTransfer</span>.<span class="ruby-identifier">member?</span>(<span class="ruby-identifier">key</span>)    <span class="ruby-comment cmt"># pragmatics</span>
63:           <span class="ruby-ivar">@logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;choose_header: `#{key}: #{value}'&quot;</span>)
64:           <span class="ruby-keyword kw">next</span>
65:         <span class="ruby-keyword kw">end</span>
66:         <span class="ruby-identifier">dst</span>[<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">value</span>
67:       }
68:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M007414">
                    
                    <a name="M007414"></a><b>do_OPTIONS</b>(req, res)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M007414_source')" id="l_M007414_source">show</a>
                        
                    </p>
                    <div id="M007414_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/webrick/httpproxy.rb, line 250</span>
250:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">do_OPTIONS</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
251:       <span class="ruby-identifier">res</span>[<span class="ruby-value str">'allow'</span>] = <span class="ruby-value str">&quot;GET,HEAD,POST,OPTIONS,CONNECT&quot;</span>
252:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M007394">
                    
                    <a name="M007394"></a><b>proxy_auth</b>(req, res)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M007394_source')" id="l_M007394_source">show</a>
                        
                    </p>
                    <div id="M007394_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/webrick/httpproxy.rb, line 43</span>
43:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">proxy_auth</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
44:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">proc</span> = <span class="ruby-ivar">@config</span>[<span class="ruby-identifier">:ProxyAuthProc</span>]
45:         <span class="ruby-identifier">proc</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
46:       <span class="ruby-keyword kw">end</span>
47:       <span class="ruby-identifier">req</span>.<span class="ruby-identifier">header</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value str">&quot;proxy-authorization&quot;</span>)
48:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M007403">
                    
                    <a name="M007403"></a><b>proxy_connect</b>(req, res)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M007403_source')" id="l_M007403_source">show</a>
                        
                    </p>
                    <div id="M007403_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/webrick/httpproxy.rb, line 169</span>
169:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">proxy_connect</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
170:       <span class="ruby-comment cmt"># Proxy Authentication</span>
171:       <span class="ruby-identifier">proxy_auth</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
172: 
173:       <span class="ruby-identifier">ua</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">:WEBrickSocket</span>]  <span class="ruby-comment cmt"># User-Agent</span>
174:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">HTTPStatus</span><span class="ruby-operator">::</span><span class="ruby-constant">InternalServerError</span>,
175:         <span class="ruby-value str">&quot;[BUG] cannot get socket&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">ua</span>
176: 
177:       <span class="ruby-identifier">host</span>, <span class="ruby-identifier">port</span> = <span class="ruby-identifier">req</span>.<span class="ruby-identifier">unparsed_uri</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">&quot;:&quot;</span>, <span class="ruby-value">2</span>)
178:       <span class="ruby-comment cmt"># Proxy authentication for upstream proxy server</span>
179:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">proxy</span> = <span class="ruby-identifier">proxy_uri</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
180:         <span class="ruby-identifier">proxy_request_line</span> = <span class="ruby-node">&quot;CONNECT #{host}:#{port} HTTP/1.0&quot;</span>
181:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">proxy</span>.<span class="ruby-identifier">userinfo</span>
182:           <span class="ruby-identifier">credentials</span> = <span class="ruby-value str">&quot;Basic &quot;</span> <span class="ruby-operator">+</span> [<span class="ruby-identifier">proxy</span>.<span class="ruby-identifier">userinfo</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">&quot;m*&quot;</span>)
183:           <span class="ruby-identifier">credentials</span>.<span class="ruby-identifier">chomp!</span>
184:         <span class="ruby-keyword kw">end</span>
185:         <span class="ruby-identifier">host</span>, <span class="ruby-identifier">port</span> = <span class="ruby-identifier">proxy</span>.<span class="ruby-identifier">host</span>, <span class="ruby-identifier">proxy</span>.<span class="ruby-identifier">port</span>
186:       <span class="ruby-keyword kw">end</span>
187: 
188:       <span class="ruby-keyword kw">begin</span>
189:         <span class="ruby-ivar">@logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;CONNECT: upstream proxy is `#{host}:#{port}'.&quot;</span>)
190:         <span class="ruby-identifier">os</span> = <span class="ruby-constant">TCPSocket</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">host</span>, <span class="ruby-identifier">port</span>)     <span class="ruby-comment cmt"># origin server</span>
191: 
192:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">proxy</span>
193:           <span class="ruby-ivar">@logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-value str">&quot;CONNECT: sending a Request-Line&quot;</span>)
194:           <span class="ruby-identifier">os</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">proxy_request_line</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">CRLF</span>
195:           <span class="ruby-ivar">@logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;CONNECT: &gt; #{proxy_request_line}&quot;</span>)
196:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">credentials</span>
197:             <span class="ruby-ivar">@logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-value str">&quot;CONNECT: sending a credentials&quot;</span>)
198:             <span class="ruby-identifier">os</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;Proxy-Authorization: &quot;</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">credentials</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">CRLF</span>
199:           <span class="ruby-keyword kw">end</span>
200:           <span class="ruby-identifier">os</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">CRLF</span>
201:           <span class="ruby-identifier">proxy_status_line</span> = <span class="ruby-identifier">os</span>.<span class="ruby-identifier">gets</span>(<span class="ruby-constant">LF</span>)
202:           <span class="ruby-ivar">@logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-value str">&quot;CONNECT: read a Status-Line form the upstream server&quot;</span>)
203:           <span class="ruby-ivar">@logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;CONNECT: &lt; #{proxy_status_line}&quot;</span>)
204:           <span class="ruby-keyword kw">if</span> <span class="ruby-regexp re">%r{^HTTP/\d+\.\d+\s+200\s*}</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">proxy_status_line</span>
205:             <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">line</span> = <span class="ruby-identifier">os</span>.<span class="ruby-identifier">gets</span>(<span class="ruby-constant">LF</span>)
206:               <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">if</span> <span class="ruby-node">/\A(#{CRLF}|#{LF})\z/o</span><span class="ruby-identifier">m</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">line</span>
207:             <span class="ruby-keyword kw">end</span>
208:           <span class="ruby-keyword kw">else</span>
209:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">HTTPStatus</span><span class="ruby-operator">::</span><span class="ruby-constant">BadGateway</span>
210:           <span class="ruby-keyword kw">end</span>
211:         <span class="ruby-keyword kw">end</span>
212:         <span class="ruby-ivar">@logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;CONNECT #{host}:#{port}: succeeded&quot;</span>)
213:         <span class="ruby-identifier">res</span>.<span class="ruby-identifier">status</span> = <span class="ruby-constant">HTTPStatus</span><span class="ruby-operator">::</span><span class="ruby-constant">RC_OK</span>
214:       <span class="ruby-keyword kw">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ex</span>
215:         <span class="ruby-ivar">@logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;CONNECT #{host}:#{port}: failed `#{ex.message}'&quot;</span>)
216:         <span class="ruby-identifier">res</span>.<span class="ruby-identifier">set_error</span>(<span class="ruby-identifier">ex</span>)
217:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">HTTPStatus</span><span class="ruby-operator">::</span><span class="ruby-constant">EOFError</span>
218:       <span class="ruby-keyword kw">ensure</span>
219:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">handler</span> = <span class="ruby-ivar">@config</span>[<span class="ruby-identifier">:ProxyContentHandler</span>]
220:           <span class="ruby-identifier">handler</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
221:         <span class="ruby-keyword kw">end</span>
222:         <span class="ruby-identifier">res</span>.<span class="ruby-identifier">send_response</span>(<span class="ruby-identifier">ua</span>)
223:         <span class="ruby-identifier">access_log</span>(<span class="ruby-ivar">@config</span>, <span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
224: 
225:         <span class="ruby-comment cmt"># Should clear request-line not to send the sesponse twice.</span>
226:         <span class="ruby-comment cmt"># see: HTTPServer#run</span>
227:         <span class="ruby-identifier">req</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-constant">NullReader</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
228:       <span class="ruby-keyword kw">end</span>
229: 
230:       <span class="ruby-keyword kw">begin</span>
231:         <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">fds</span> = <span class="ruby-constant">IO</span><span class="ruby-operator">::</span><span class="ruby-identifier">select</span>([<span class="ruby-identifier">ua</span>, <span class="ruby-identifier">os</span>])
232:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">fds</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">member?</span>(<span class="ruby-identifier">ua</span>)
233:             <span class="ruby-identifier">buf</span> = <span class="ruby-identifier">ua</span>.<span class="ruby-identifier">sysread</span>(<span class="ruby-value">1024</span>);
234:             <span class="ruby-ivar">@logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;CONNECT: #{buf.size} byte from User-Agent&quot;</span>)
235:             <span class="ruby-identifier">os</span>.<span class="ruby-identifier">syswrite</span>(<span class="ruby-identifier">buf</span>)
236:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">fds</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">member?</span>(<span class="ruby-identifier">os</span>)
237:             <span class="ruby-identifier">buf</span> = <span class="ruby-identifier">os</span>.<span class="ruby-identifier">sysread</span>(<span class="ruby-value">1024</span>);
238:             <span class="ruby-ivar">@logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;CONNECT: #{buf.size} byte from #{host}:#{port}&quot;</span>)
239:             <span class="ruby-identifier">ua</span>.<span class="ruby-identifier">syswrite</span>(<span class="ruby-identifier">buf</span>)
240:           <span class="ruby-keyword kw">end</span>
241:         <span class="ruby-keyword kw">end</span>
242:       <span class="ruby-keyword kw">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ex</span>
243:         <span class="ruby-identifier">os</span>.<span class="ruby-identifier">close</span>
244:         <span class="ruby-ivar">@logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;CONNECT #{host}:#{port}: closed&quot;</span>)
245:       <span class="ruby-keyword kw">end</span>
246: 
247:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">HTTPStatus</span><span class="ruby-operator">::</span><span class="ruby-constant">EOFError</span>
248:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M007401">
                    
                    <a name="M007401"></a><b>proxy_service</b>(req, res)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M007401_source')" id="l_M007401_source">show</a>
                        
                    </p>
                    <div id="M007401_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/webrick/httpproxy.rb, line 102</span>
102:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">proxy_service</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
103:       <span class="ruby-comment cmt"># Proxy Authentication</span>
104:       <span class="ruby-identifier">proxy_auth</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)      
105: 
106:       <span class="ruby-comment cmt"># Create Request-URI to send to the origin server</span>
107:       <span class="ruby-identifier">uri</span>  = <span class="ruby-identifier">req</span>.<span class="ruby-identifier">request_uri</span>
108:       <span class="ruby-identifier">path</span> = <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">path</span>.<span class="ruby-identifier">dup</span>
109:       <span class="ruby-identifier">path</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;?&quot;</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">query</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">query</span>
110: 
111:       <span class="ruby-comment cmt"># Choose header fields to transfer</span>
112:       <span class="ruby-identifier">header</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
113:       <span class="ruby-identifier">choose_header</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">header</span>)
114:       <span class="ruby-identifier">set_via</span>(<span class="ruby-identifier">header</span>)
115: 
116:       <span class="ruby-comment cmt"># select upstream proxy server</span>
117:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">proxy</span> = <span class="ruby-identifier">proxy_uri</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
118:         <span class="ruby-identifier">proxy_host</span> = <span class="ruby-identifier">proxy</span>.<span class="ruby-identifier">host</span>
119:         <span class="ruby-identifier">proxy_port</span> = <span class="ruby-identifier">proxy</span>.<span class="ruby-identifier">port</span>
120:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">proxy</span>.<span class="ruby-identifier">userinfo</span>
121:           <span class="ruby-identifier">credentials</span> = <span class="ruby-value str">&quot;Basic &quot;</span> <span class="ruby-operator">+</span> [<span class="ruby-identifier">proxy</span>.<span class="ruby-identifier">userinfo</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">&quot;m*&quot;</span>)
122:           <span class="ruby-identifier">credentials</span>.<span class="ruby-identifier">chomp!</span>
123:           <span class="ruby-identifier">header</span>[<span class="ruby-value str">'proxy-authorization'</span>] = <span class="ruby-identifier">credentials</span>
124:         <span class="ruby-keyword kw">end</span>
125:       <span class="ruby-keyword kw">end</span>
126: 
127:       <span class="ruby-identifier">response</span> = <span class="ruby-keyword kw">nil</span>
128:       <span class="ruby-keyword kw">begin</span>
129:         <span class="ruby-identifier">http</span> = <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">uri</span>.<span class="ruby-identifier">host</span>, <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">port</span>, <span class="ruby-identifier">proxy_host</span>, <span class="ruby-identifier">proxy_port</span>)
130:         <span class="ruby-identifier">http</span>.<span class="ruby-identifier">start</span>{
131:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@config</span>[<span class="ruby-identifier">:ProxyTimeout</span>]
132:             <span class="ruby-comment cmt">##################################   these issues are </span>
133:             <span class="ruby-identifier">http</span>.<span class="ruby-identifier">open_timeout</span> = <span class="ruby-value">30</span>   <span class="ruby-comment cmt"># secs  #   necessary (maybe bacause</span>
134:             <span class="ruby-identifier">http</span>.<span class="ruby-identifier">read_timeout</span> = <span class="ruby-value">60</span>   <span class="ruby-comment cmt"># secs  #   Ruby's bug, but why?)</span>
135:             <span class="ruby-comment cmt">##################################</span>
136:           <span class="ruby-keyword kw">end</span>
137:           <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">req</span>.<span class="ruby-identifier">request_method</span>
138:           <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;GET&quot;</span>  <span class="ruby-keyword kw">then</span> <span class="ruby-identifier">response</span> = <span class="ruby-identifier">http</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">header</span>)
139:           <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;POST&quot;</span> <span class="ruby-keyword kw">then</span> <span class="ruby-identifier">response</span> = <span class="ruby-identifier">http</span>.<span class="ruby-identifier">post</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">req</span>.<span class="ruby-identifier">body</span> <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;&quot;</span>, <span class="ruby-identifier">header</span>)
140:           <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;HEAD&quot;</span> <span class="ruby-keyword kw">then</span> <span class="ruby-identifier">response</span> = <span class="ruby-identifier">http</span>.<span class="ruby-identifier">head</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">header</span>)
141:           <span class="ruby-keyword kw">else</span>
142:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">HTTPStatus</span><span class="ruby-operator">::</span><span class="ruby-constant">MethodNotAllowed</span>,
143:               <span class="ruby-node">&quot;unsupported method `#{req.request_method}'.&quot;</span>
144:           <span class="ruby-keyword kw">end</span>
145:         }
146:       <span class="ruby-keyword kw">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">err</span>
147:         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;#{err.class}: #{err.message}&quot;</span>)
148:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">HTTPStatus</span><span class="ruby-operator">::</span><span class="ruby-constant">ServiceUnavailable</span>, <span class="ruby-identifier">err</span>.<span class="ruby-identifier">message</span>
149:       <span class="ruby-keyword kw">end</span>
150:   
151:       <span class="ruby-comment cmt"># Persistent connction requirements are mysterious for me.</span>
152:       <span class="ruby-comment cmt"># So I will close the connection in every response.</span>
153:       <span class="ruby-identifier">res</span>[<span class="ruby-value str">'proxy-connection'</span>] = <span class="ruby-value str">&quot;close&quot;</span>
154:       <span class="ruby-identifier">res</span>[<span class="ruby-value str">'connection'</span>] = <span class="ruby-value str">&quot;close&quot;</span>
155: 
156:       <span class="ruby-comment cmt"># Convert Net::HTTP::HTTPResponse to WEBrick::HTTPProxy</span>
157:       <span class="ruby-identifier">res</span>.<span class="ruby-identifier">status</span> = <span class="ruby-identifier">response</span>.<span class="ruby-identifier">code</span>.<span class="ruby-identifier">to_i</span>
158:       <span class="ruby-identifier">choose_header</span>(<span class="ruby-identifier">response</span>, <span class="ruby-identifier">res</span>)
159:       <span class="ruby-identifier">set_cookie</span>(<span class="ruby-identifier">response</span>, <span class="ruby-identifier">res</span>)
160:       <span class="ruby-identifier">set_via</span>(<span class="ruby-identifier">res</span>)
161:       <span class="ruby-identifier">res</span>.<span class="ruby-identifier">body</span> = <span class="ruby-identifier">response</span>.<span class="ruby-identifier">body</span>
162: 
163:       <span class="ruby-comment cmt"># Process contents</span>
164:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">handler</span> = <span class="ruby-ivar">@config</span>[<span class="ruby-identifier">:ProxyContentHandler</span>]
165:         <span class="ruby-identifier">handler</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
166:       <span class="ruby-keyword kw">end</span>
167:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M007400">
                    
                    <a name="M007400"></a><b>proxy_uri</b>(req, res)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M007400_source')" id="l_M007400_source">show</a>
                        
                    </p>
                    <div id="M007400_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/webrick/httpproxy.rb, line 98</span>
 98:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">proxy_uri</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
 99:       <span class="ruby-ivar">@config</span>[<span class="ruby-identifier">:ProxyURI</span>]
100:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M007393">
                    
                    <a name="M007393"></a><b>service</b>(req, res)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M007393_source')" id="l_M007393_source">show</a>
                        
                    </p>
                    <div id="M007393_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/webrick/httpproxy.rb, line 33</span>
33:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">service</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
34:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">req</span>.<span class="ruby-identifier">request_method</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;CONNECT&quot;</span>
35:         <span class="ruby-identifier">proxy_connect</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
36:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">req</span>.<span class="ruby-identifier">unparsed_uri</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">%r!^http://!</span>
37:         <span class="ruby-identifier">proxy_service</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
38:       <span class="ruby-keyword kw">else</span>
39:         <span class="ruby-keyword kw">super</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
40:       <span class="ruby-keyword kw">end</span>
41:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M007397">
                    
                    <a name="M007397"></a><b>set_cookie</b>(src, dst)
                    
                </div>
                
                <div class="description">
                  <p>
<a href="../Net/HTTP.html">Net::HTTP</a> is stupid about the multiple
header fields. Here is workaround:
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M007397_source')" id="l_M007397_source">show</a>
                        
                    </p>
                    <div id="M007397_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/webrick/httpproxy.rb, line 72</span>
72:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_cookie</span>(<span class="ruby-identifier">src</span>, <span class="ruby-identifier">dst</span>)
73:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">str</span> = <span class="ruby-identifier">src</span>[<span class="ruby-value str">'set-cookie'</span>]
74:         <span class="ruby-identifier">cookies</span> = []
75:         <span class="ruby-identifier">str</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp re">/,\s*/</span>).<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">token</span><span class="ruby-operator">|</span>
76:           <span class="ruby-keyword kw">if</span> <span class="ruby-regexp re">/^[^=]+;/o</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">token</span>
77:             <span class="ruby-identifier">cookies</span>[<span class="ruby-value">-1</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;, &quot;</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">token</span>
78:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-regexp re">/=/o</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">token</span>
79:             <span class="ruby-identifier">cookies</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">token</span>
80:           <span class="ruby-keyword kw">else</span>
81:             <span class="ruby-identifier">cookies</span>[<span class="ruby-value">-1</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;, &quot;</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">token</span>
82:           <span class="ruby-keyword kw">end</span>
83:         }
84:         <span class="ruby-identifier">dst</span>.<span class="ruby-identifier">cookies</span>.<span class="ruby-identifier">replace</span>(<span class="ruby-identifier">cookies</span>)
85:       <span class="ruby-keyword kw">end</span>
86:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M007399">
                    
                    <a name="M007399"></a><b>set_via</b>(h)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M007399_source')" id="l_M007399_source">show</a>
                        
                    </p>
                    <div id="M007399_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/webrick/httpproxy.rb, line 88</span>
88:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_via</span>(<span class="ruby-identifier">h</span>)
89:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@config</span>[<span class="ruby-identifier">:ProxyVia</span>]
90:         <span class="ruby-keyword kw">if</span>  <span class="ruby-identifier">h</span>[<span class="ruby-value str">'via'</span>]
91:           <span class="ruby-identifier">h</span>[<span class="ruby-value str">'via'</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;, &quot;</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@via</span>
92:         <span class="ruby-keyword kw">else</span>
93:           <span class="ruby-identifier">h</span>[<span class="ruby-value str">'via'</span>] = <span class="ruby-ivar">@via</span>
94:         <span class="ruby-keyword kw">end</span>
95:       <span class="ruby-keyword kw">end</span>
96:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M007395">
                    
                    <a name="M007395"></a><b>split_field</b>(f)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M007395_source')" id="l_M007395_source">show</a>
                        
                    </p>
                    <div id="M007395_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/webrick/httpproxy.rb, line 54</span>
54:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">split_field</span>(<span class="ruby-identifier">f</span>) <span class="ruby-identifier">f</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp re">/,\s+/</span>).<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">downcase</span> } <span class="ruby-operator">:</span> [] <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M007392">
                    
                    <a name="M007392"></a><b>new</b>(config)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M007392_source')" id="l_M007392_source">show</a>
                        
                    </p>
                    <div id="M007392_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/webrick/httpproxy.rb, line 27</span>
27:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">config</span>)
28:       <span class="ruby-keyword kw">super</span>
29:       <span class="ruby-identifier">c</span> = <span class="ruby-ivar">@config</span>
30:       <span class="ruby-ivar">@via</span> = <span class="ruby-node">&quot;#{c[:HTTPVersion]} #{c[:ServerName]}:#{c[:Port]}&quot;</span>
31:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    