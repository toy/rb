<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Rack::OpenID</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
    <script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            Rack::OpenID 
            
                <span class="parent">&lt; 
                    
                    Object
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/rack/openid/simple_auth_rb.html">lib/rack/openid/simple_auth.rb</a></li>
            
            <li><a href="../../files/lib/rack/openid_rb.html">lib/rack/openid.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
A Rack middleware that provides a more HTTPish API around the ruby-openid
library.
</p>
<p>
You trigger an <a href="OpenID.html">OpenID</a> request similar to HTTP
authentication. From your app, return a &#8220;401 Unauthorized&#8221; and
a &#8220;WWW-Authenticate&#8221; header with the identifier you would like
to validate.
</p>
<p>
On competition, the <a href="OpenID.html">OpenID</a> response is
automatically verified and assigned to <tt><a
href="http://"rack.openid.response"">env</a></tt>.
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>A</dt>
        <dd>
            <ul>
                
                <li><a href="#M000026">add_attribute_exchange_fields</a>,</li>
                
                <li><a href="#M000027">add_oauth_fields</a>,</li>
                
                <li><a href="#M000025">add_simple_registration_fields</a></li>
                
            </ul>
        </dd>
    
        <dt>B</dt>
        <dd>
            <ul>
                
                <li><a href="#M000016">begin_authentication</a>,</li>
                
                <li><a href="#M000012">build_header</a></li>
                
            </ul>
        </dd>
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M000015">call</a>,</li>
                
                <li><a href="#M000017">complete_authentication</a></li>
                
            </ul>
        </dd>
    
        <dt>D</dt>
        <dd>
            <ul>
                
                <li><a href="#M000028">default_store</a></li>
                
            </ul>
        </dd>
    
        <dt>F</dt>
        <dd>
            <ul>
                
                <li><a href="#M000018">flatten_params</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M000014">new</a></li>
                
            </ul>
        </dd>
    
        <dt>O</dt>
        <dd>
            <ul>
                
                <li><a href="#M000024">open_id_redirect_url</a>,</li>
                
                <li><a href="#M000019">override_request_method</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M000013">parse_header</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000021">realm_url</a>,</li>
                
                <li><a href="#M000023">redirect_to</a>,</li>
                
                <li><a href="#M000022">request_url</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M000020">sanitize_query_string</a></li>
                
            </ul>
        </dd>
    
        <dt>T</dt>
        <dd>
            <ul>
                
                <li><a href="#M000029">timeout_protection_from_identity_server</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    
    <div class="sectiontitle">Classes and Modules</div>
    <ul>
        
        <li><span class="type">CLASS</span> <a href="OpenID/MissingResponse.html">Rack::OpenID::MissingResponse</a></li>
        
        <li><span class="type">CLASS</span> <a href="OpenID/SimpleAuth.html">Rack::OpenID::SimpleAuth</a></li>
        
        <li><span class="type">CLASS</span> <a href="OpenID/TimeoutResponse.html">Rack::OpenID::TimeoutResponse</a></li>
        
    </ul>
    

    

    

    
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000015">
                    
                    <a name="M000015"></a><b>call</b>(env)
                    
                </div>
                
                <div class="description">
                  <p>
Standard Rack <tt>call</tt> dispatch that accepts an <tt>env</tt> and
returns a <tt>[status, header, body]</tt> response.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000015_source')" id="l_M000015_source">show</a>
                        
                    </p>
                    <div id="M000015_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rack/openid.rb, line 92</span>
 92:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">call</span>(<span class="ruby-identifier">env</span>)
 93:       <span class="ruby-identifier">req</span> = <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Request</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">env</span>)
 94:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">req</span>.<span class="ruby-identifier">params</span>[<span class="ruby-value str">&quot;openid.mode&quot;</span>]
 95:         <span class="ruby-identifier">complete_authentication</span>(<span class="ruby-identifier">env</span>)
 96:       <span class="ruby-keyword kw">end</span>
 97: 
 98:       <span class="ruby-identifier">status</span>, <span class="ruby-identifier">headers</span>, <span class="ruby-identifier">body</span> = <span class="ruby-ivar">@app</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">env</span>)
 99: 
100:       <span class="ruby-identifier">qs</span> = <span class="ruby-identifier">headers</span>[<span class="ruby-constant">AUTHENTICATE_HEADER</span>]
101:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">status</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">401</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">qs</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">qs</span>.<span class="ruby-identifier">match</span>(<span class="ruby-constant">AUTHENTICATE_REGEXP</span>)
102:         <span class="ruby-identifier">begin_authentication</span>(<span class="ruby-identifier">env</span>, <span class="ruby-identifier">qs</span>)
103:       <span class="ruby-keyword kw">else</span>
104:         [<span class="ruby-identifier">status</span>, <span class="ruby-identifier">headers</span>, <span class="ruby-identifier">body</span>]
105:       <span class="ruby-keyword kw">end</span>
106:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Private methods</div>
            
            <div class="method">
                <div class="title" id="M000026">
                    
                    <a name="M000026"></a><b>add_attribute_exchange_fields</b>(oidreq, fields)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000026_source')" id="l_M000026_source">show</a>
                        
                    </p>
                    <div id="M000026_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rack/openid.rb, line 239</span>
239:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_attribute_exchange_fields</span>(<span class="ruby-identifier">oidreq</span>, <span class="ruby-identifier">fields</span>)
240:         <span class="ruby-identifier">axreq</span> = <span class="ruby-operator">::</span><span class="ruby-constant">OpenID</span><span class="ruby-operator">::</span><span class="ruby-constant">AX</span><span class="ruby-operator">::</span><span class="ruby-constant">FetchRequest</span>.<span class="ruby-identifier">new</span>
241: 
242:         <span class="ruby-identifier">required</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">fields</span>[<span class="ruby-value str">'required'</span>]).<span class="ruby-identifier">select</span>(<span class="ruby-operator">&amp;</span><span class="ruby-constant">URL_FIELD_SELECTOR</span>)
243:         <span class="ruby-identifier">optional</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">fields</span>[<span class="ruby-value str">'optional'</span>]).<span class="ruby-identifier">select</span>(<span class="ruby-operator">&amp;</span><span class="ruby-constant">URL_FIELD_SELECTOR</span>)
244: 
245:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">required</span>.<span class="ruby-identifier">any?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">optional</span>.<span class="ruby-identifier">any?</span>
246:           <span class="ruby-identifier">required</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">field</span><span class="ruby-operator">|</span>
247:             <span class="ruby-identifier">axreq</span>.<span class="ruby-identifier">add</span>(<span class="ruby-operator">::</span><span class="ruby-constant">OpenID</span><span class="ruby-operator">::</span><span class="ruby-constant">AX</span><span class="ruby-operator">::</span><span class="ruby-constant">AttrInfo</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">field</span>, <span class="ruby-keyword kw">nil</span>, <span class="ruby-keyword kw">true</span>))
248:           <span class="ruby-keyword kw">end</span>
249: 
250:           <span class="ruby-identifier">optional</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">field</span><span class="ruby-operator">|</span>
251:             <span class="ruby-identifier">axreq</span>.<span class="ruby-identifier">add</span>(<span class="ruby-operator">::</span><span class="ruby-constant">OpenID</span><span class="ruby-operator">::</span><span class="ruby-constant">AX</span><span class="ruby-operator">::</span><span class="ruby-constant">AttrInfo</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">field</span>, <span class="ruby-keyword kw">nil</span>, <span class="ruby-keyword kw">false</span>))
252:           <span class="ruby-keyword kw">end</span>
253: 
254:           <span class="ruby-identifier">oidreq</span>.<span class="ruby-identifier">add_extension</span>(<span class="ruby-identifier">axreq</span>)
255:         <span class="ruby-keyword kw">end</span>
256:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000027">
                    
                    <a name="M000027"></a><b>add_oauth_fields</b>(oidreq, fields)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000027_source')" id="l_M000027_source">show</a>
                        
                    </p>
                    <div id="M000027_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rack/openid.rb, line 258</span>
258:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_oauth_fields</span>(<span class="ruby-identifier">oidreq</span>, <span class="ruby-identifier">fields</span>)
259:         <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">consumer</span> = <span class="ruby-identifier">fields</span>[<span class="ruby-value str">'oauth[consumer]'</span>]) <span class="ruby-operator">&amp;&amp;</span>
260:               (<span class="ruby-identifier">scope</span> = <span class="ruby-identifier">fields</span>[<span class="ruby-value str">'oauth[scope]'</span>])
261:           <span class="ruby-identifier">oauthreq</span> = <span class="ruby-operator">::</span><span class="ruby-constant">OpenID</span><span class="ruby-operator">::</span><span class="ruby-constant">OAuth</span><span class="ruby-operator">::</span><span class="ruby-constant">Request</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">consumer</span>, <span class="ruby-constant">Array</span>(<span class="ruby-identifier">scope</span>).<span class="ruby-identifier">join</span>(<span class="ruby-value str">' '</span>))
262:           <span class="ruby-identifier">oidreq</span>.<span class="ruby-identifier">add_extension</span>(<span class="ruby-identifier">oauthreq</span>)
263:         <span class="ruby-keyword kw">end</span>
264:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000025">
                    
                    <a name="M000025"></a><b>add_simple_registration_fields</b>(oidreq, fields)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000025_source')" id="l_M000025_source">show</a>
                        
                    </p>
                    <div id="M000025_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rack/openid.rb, line 224</span>
224:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_simple_registration_fields</span>(<span class="ruby-identifier">oidreq</span>, <span class="ruby-identifier">fields</span>)
225:         <span class="ruby-identifier">sregreq</span> = <span class="ruby-operator">::</span><span class="ruby-constant">OpenID</span><span class="ruby-operator">::</span><span class="ruby-constant">SReg</span><span class="ruby-operator">::</span><span class="ruby-constant">Request</span>.<span class="ruby-identifier">new</span>
226: 
227:         <span class="ruby-identifier">required</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">fields</span>[<span class="ruby-value str">'required'</span>]).<span class="ruby-identifier">reject</span>(<span class="ruby-operator">&amp;</span><span class="ruby-constant">URL_FIELD_SELECTOR</span>)
228:         <span class="ruby-identifier">sregreq</span>.<span class="ruby-identifier">request_fields</span>(<span class="ruby-identifier">required</span>, <span class="ruby-keyword kw">true</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">required</span>.<span class="ruby-identifier">any?</span>
229: 
230:         <span class="ruby-identifier">optional</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">fields</span>[<span class="ruby-value str">'optional'</span>]).<span class="ruby-identifier">reject</span>(<span class="ruby-operator">&amp;</span><span class="ruby-constant">URL_FIELD_SELECTOR</span>)
231:         <span class="ruby-identifier">sregreq</span>.<span class="ruby-identifier">request_fields</span>(<span class="ruby-identifier">optional</span>, <span class="ruby-keyword kw">false</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">optional</span>.<span class="ruby-identifier">any?</span>
232: 
233:         <span class="ruby-identifier">policy_url</span> = <span class="ruby-identifier">fields</span>[<span class="ruby-value str">'policy_url'</span>]
234:         <span class="ruby-identifier">sregreq</span>.<span class="ruby-identifier">policy_url</span> = <span class="ruby-identifier">policy_url</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">policy_url</span>
235: 
236:         <span class="ruby-identifier">oidreq</span>.<span class="ruby-identifier">add_extension</span>(<span class="ruby-identifier">sregreq</span>)
237:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000016">
                    
                    <a name="M000016"></a><b>begin_authentication</b>(env, qs)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000016_source')" id="l_M000016_source">show</a>
                        
                    </p>
                    <div id="M000016_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rack/openid.rb, line 109</span>
109:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">begin_authentication</span>(<span class="ruby-identifier">env</span>, <span class="ruby-identifier">qs</span>)
110:         <span class="ruby-identifier">req</span> = <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Request</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">env</span>)
111:         <span class="ruby-identifier">params</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">parse_header</span>(<span class="ruby-identifier">qs</span>)
112:         <span class="ruby-identifier">session</span> = <span class="ruby-identifier">env</span>[<span class="ruby-value str">&quot;rack.session&quot;</span>]
113: 
114:         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">session</span>
115:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">RuntimeError</span>, <span class="ruby-value str">&quot;Rack::OpenID requires a session&quot;</span>
116:         <span class="ruby-keyword kw">end</span>
117: 
118:         <span class="ruby-identifier">consumer</span>   = <span class="ruby-operator">::</span><span class="ruby-constant">OpenID</span><span class="ruby-operator">::</span><span class="ruby-constant">Consumer</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">session</span>, <span class="ruby-ivar">@store</span>)
119:         <span class="ruby-identifier">identifier</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value str">'identifier'</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'identity'</span>]
120:         <span class="ruby-identifier">immediate</span>  = <span class="ruby-identifier">params</span>[<span class="ruby-value str">'immediate'</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'true'</span>
121: 
122:         <span class="ruby-keyword kw">begin</span>
123:           <span class="ruby-identifier">oidreq</span> = <span class="ruby-identifier">consumer</span>.<span class="ruby-identifier">begin</span>(<span class="ruby-identifier">identifier</span>)
124:           <span class="ruby-identifier">add_simple_registration_fields</span>(<span class="ruby-identifier">oidreq</span>, <span class="ruby-identifier">params</span>)
125:           <span class="ruby-identifier">add_attribute_exchange_fields</span>(<span class="ruby-identifier">oidreq</span>, <span class="ruby-identifier">params</span>)
126:           <span class="ruby-identifier">add_oauth_fields</span>(<span class="ruby-identifier">oidreq</span>, <span class="ruby-identifier">params</span>)
127:           <span class="ruby-identifier">url</span> = <span class="ruby-identifier">open_id_redirect_url</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">oidreq</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value str">&quot;trust_root&quot;</span>], <span class="ruby-identifier">params</span>[<span class="ruby-value str">&quot;return_to&quot;</span>], <span class="ruby-identifier">params</span>[<span class="ruby-value str">&quot;method&quot;</span>], <span class="ruby-identifier">immediate</span>)
128:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">redirect_to</span>(<span class="ruby-identifier">url</span>)
129:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">OpenID</span><span class="ruby-operator">::</span><span class="ruby-constant">OpenIDError</span>, <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
130:           <span class="ruby-identifier">env</span>[<span class="ruby-constant">RESPONSE</span>] = <span class="ruby-constant">MissingResponse</span>.<span class="ruby-identifier">new</span>
131:           <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@app</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">env</span>)
132:         <span class="ruby-keyword kw">end</span>
133:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000017">
                    
                    <a name="M000017"></a><b>complete_authentication</b>(env)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000017_source')" id="l_M000017_source">show</a>
                        
                    </p>
                    <div id="M000017_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rack/openid.rb, line 135</span>
135:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">complete_authentication</span>(<span class="ruby-identifier">env</span>)
136:         <span class="ruby-identifier">req</span> = <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Request</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">env</span>)
137:         <span class="ruby-identifier">session</span> = <span class="ruby-identifier">env</span>[<span class="ruby-value str">&quot;rack.session&quot;</span>]
138: 
139:         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">session</span>
140:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">RuntimeError</span>, <span class="ruby-value str">&quot;Rack::OpenID requires a session&quot;</span>
141:         <span class="ruby-keyword kw">end</span>
142: 
143:         <span class="ruby-identifier">oidresp</span> = <span class="ruby-identifier">timeout_protection_from_identity_server</span> {
144:           <span class="ruby-identifier">consumer</span> = <span class="ruby-operator">::</span><span class="ruby-constant">OpenID</span><span class="ruby-operator">::</span><span class="ruby-constant">Consumer</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">session</span>, <span class="ruby-ivar">@store</span>)
145:           <span class="ruby-identifier">consumer</span>.<span class="ruby-identifier">complete</span>(<span class="ruby-identifier">flatten_params</span>(<span class="ruby-identifier">req</span>.<span class="ruby-identifier">params</span>), <span class="ruby-identifier">req</span>.<span class="ruby-identifier">url</span>)
146:         }
147: 
148:         <span class="ruby-identifier">env</span>[<span class="ruby-constant">RESPONSE</span>] = <span class="ruby-identifier">oidresp</span>
149: 
150:         <span class="ruby-identifier">method</span> = <span class="ruby-identifier">req</span>.<span class="ruby-constant">GET</span>[<span class="ruby-value str">&quot;_method&quot;</span>]
151:         <span class="ruby-identifier">override_request_method</span>(<span class="ruby-identifier">env</span>, <span class="ruby-identifier">method</span>)
152: 
153:         <span class="ruby-identifier">sanitize_query_string</span>(<span class="ruby-identifier">env</span>)
154:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000028">
                    
                    <a name="M000028"></a><b>default_store</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000028_source')" id="l_M000028_source">show</a>
                        
                    </p>
                    <div id="M000028_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rack/openid.rb, line 266</span>
266:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">default_store</span>
267:         <span class="ruby-identifier">require</span> <span class="ruby-value str">'openid/store/memory'</span>
268:         <span class="ruby-operator">::</span><span class="ruby-constant">OpenID</span><span class="ruby-operator">::</span><span class="ruby-constant">Store</span><span class="ruby-operator">::</span><span class="ruby-constant">Memory</span>.<span class="ruby-identifier">new</span>
269:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000018">
                    
                    <a name="M000018"></a><b>flatten_params</b>(params)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000018_source')" id="l_M000018_source">show</a>
                        
                    </p>
                    <div id="M000018_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rack/openid.rb, line 156</span>
156:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">flatten_params</span>(<span class="ruby-identifier">params</span>)
157:         <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Utils</span>.<span class="ruby-identifier">parse_query</span>(<span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Utils</span>.<span class="ruby-identifier">build_nested_query</span>(<span class="ruby-identifier">params</span>))
158:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000024">
                    
                    <a name="M000024"></a><b>open_id_redirect_url</b>(req, oidreq, trust_root, return_to, method, immediate)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000024_source')" id="l_M000024_source">show</a>
                        
                    </p>
                    <div id="M000024_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rack/openid.rb, line 209</span>
209:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">open_id_redirect_url</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">oidreq</span>, <span class="ruby-identifier">trust_root</span>, <span class="ruby-identifier">return_to</span>, <span class="ruby-identifier">method</span>, <span class="ruby-identifier">immediate</span>)
210:         <span class="ruby-identifier">request_url</span> = <span class="ruby-identifier">request_url</span>(<span class="ruby-identifier">req</span>)
211: 
212:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">return_to</span>
213:           <span class="ruby-identifier">method</span> <span class="ruby-operator">||=</span> <span class="ruby-value str">&quot;get&quot;</span>
214:         <span class="ruby-keyword kw">else</span>
215:           <span class="ruby-identifier">return_to</span> = <span class="ruby-identifier">request_url</span>
216:           <span class="ruby-identifier">method</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">req</span>.<span class="ruby-identifier">request_method</span>
217:         <span class="ruby-keyword kw">end</span>
218: 
219:         <span class="ruby-identifier">method</span> = <span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span>
220:         <span class="ruby-identifier">oidreq</span>.<span class="ruby-identifier">return_to_args</span>[<span class="ruby-value str">'_method'</span>] = <span class="ruby-identifier">method</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">method</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;get&quot;</span>
221:         <span class="ruby-identifier">oidreq</span>.<span class="ruby-identifier">redirect_url</span>(<span class="ruby-identifier">trust_root</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">realm_url</span>(<span class="ruby-identifier">req</span>), <span class="ruby-identifier">return_to</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">request_url</span>, <span class="ruby-identifier">immediate</span>)
222:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000019">
                    
                    <a name="M000019"></a><b>override_request_method</b>(env, method)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000019_source')" id="l_M000019_source">show</a>
                        
                    </p>
                    <div id="M000019_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rack/openid.rb, line 160</span>
160:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">override_request_method</span>(<span class="ruby-identifier">env</span>, <span class="ruby-identifier">method</span>)
161:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">method</span>
162:         <span class="ruby-identifier">method</span> = <span class="ruby-identifier">method</span>.<span class="ruby-identifier">upcase</span>
163:         <span class="ruby-keyword kw">if</span> <span class="ruby-constant">HTTP_METHODS</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">method</span>)
164:           <span class="ruby-identifier">env</span>[<span class="ruby-value str">&quot;REQUEST_METHOD&quot;</span>] = <span class="ruby-identifier">method</span>
165:         <span class="ruby-keyword kw">end</span>
166:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000021">
                    
                    <a name="M000021"></a><b>realm_url</b>(req)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000021_source')" id="l_M000021_source">show</a>
                        
                    </p>
                    <div id="M000021_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rack/openid.rb, line 184</span>
184:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">realm_url</span>(<span class="ruby-identifier">req</span>)
185:         <span class="ruby-identifier">url</span> = <span class="ruby-identifier">req</span>.<span class="ruby-identifier">scheme</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;://&quot;</span>
186:         <span class="ruby-identifier">url</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">req</span>.<span class="ruby-identifier">host</span>
187: 
188:         <span class="ruby-identifier">scheme</span>, <span class="ruby-identifier">port</span> = <span class="ruby-identifier">req</span>.<span class="ruby-identifier">scheme</span>, <span class="ruby-identifier">req</span>.<span class="ruby-identifier">port</span>
189:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scheme</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;https&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">port</span> <span class="ruby-operator">!=</span> <span class="ruby-value">443</span> <span class="ruby-operator">||</span>
190:             <span class="ruby-identifier">scheme</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;http&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">port</span> <span class="ruby-operator">!=</span> <span class="ruby-value">80</span>
191:           <span class="ruby-identifier">url</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;:#{port}&quot;</span>
192:         <span class="ruby-keyword kw">end</span>
193: 
194:         <span class="ruby-identifier">url</span>
195:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000023">
                    
                    <a name="M000023"></a><b>redirect_to</b>(url)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000023_source')" id="l_M000023_source">show</a>
                        
                    </p>
                    <div id="M000023_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rack/openid.rb, line 205</span>
205:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">redirect_to</span>(<span class="ruby-identifier">url</span>)
206:         [<span class="ruby-value">303</span>, {<span class="ruby-value str">&quot;Content-Type&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;text/html&quot;</span>, <span class="ruby-value str">&quot;Location&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">url</span>}, []]
207:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000022">
                    
                    <a name="M000022"></a><b>request_url</b>(req)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000022_source')" id="l_M000022_source">show</a>
                        
                    </p>
                    <div id="M000022_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rack/openid.rb, line 197</span>
197:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">request_url</span>(<span class="ruby-identifier">req</span>)
198:         <span class="ruby-identifier">url</span> = <span class="ruby-identifier">realm_url</span>(<span class="ruby-identifier">req</span>)
199:         <span class="ruby-identifier">url</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">req</span>.<span class="ruby-identifier">script_name</span>
200:         <span class="ruby-identifier">url</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">req</span>.<span class="ruby-identifier">path_info</span>
201:         <span class="ruby-identifier">url</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;?#{req.query_string}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">req</span>.<span class="ruby-identifier">query_string</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
202:         <span class="ruby-identifier">url</span>
203:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000020">
                    
                    <a name="M000020"></a><b>sanitize_query_string</b>(env)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000020_source')" id="l_M000020_source">show</a>
                        
                    </p>
                    <div id="M000020_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rack/openid.rb, line 168</span>
168:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sanitize_query_string</span>(<span class="ruby-identifier">env</span>)
169:         <span class="ruby-identifier">query_hash</span> = <span class="ruby-identifier">env</span>[<span class="ruby-value str">&quot;rack.request.query_hash&quot;</span>]
170:         <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value str">&quot;_method&quot;</span>)
171:         <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">delete_if</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
172:           <span class="ruby-identifier">key</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/^openid\./</span>
173:         <span class="ruby-keyword kw">end</span>
174: 
175:         <span class="ruby-identifier">env</span>[<span class="ruby-value str">&quot;QUERY_STRING&quot;</span>] = <span class="ruby-identifier">env</span>[<span class="ruby-value str">&quot;rack.request.query_string&quot;</span>] =
176:           <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Utils</span>.<span class="ruby-identifier">build_query</span>(<span class="ruby-identifier">env</span>[<span class="ruby-value str">&quot;rack.request.query_hash&quot;</span>])
177: 
178:         <span class="ruby-identifier">qs</span> = <span class="ruby-identifier">env</span>[<span class="ruby-value str">&quot;QUERY_STRING&quot;</span>]
179:         <span class="ruby-identifier">request_uri</span> = (<span class="ruby-identifier">env</span>[<span class="ruby-value str">&quot;PATH_INFO&quot;</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;&quot;</span>).<span class="ruby-identifier">dup</span>
180:         <span class="ruby-identifier">request_uri</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;?&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">qs</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">qs</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;&quot;</span>
181:         <span class="ruby-identifier">env</span>[<span class="ruby-value str">&quot;REQUEST_URI&quot;</span>] = <span class="ruby-identifier">request_uri</span>
182:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000029">
                    
                    <a name="M000029"></a><b>timeout_protection_from_identity_server</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000029_source')" id="l_M000029_source">show</a>
                        
                    </p>
                    <div id="M000029_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rack/openid.rb, line 271</span>
271:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">timeout_protection_from_identity_server</span>
272:         <span class="ruby-keyword kw">yield</span>
273:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>
274:         <span class="ruby-constant">TimeoutResponse</span>.<span class="ruby-identifier">new</span>
275:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M000012">
                    
                    <a name="M000012"></a><b>build_header</b>(params = {})
                    
                </div>
                
                <div class="description">
                  <p>
Helper method for building the &#8220;WWW-Authenticate&#8221; header value.
</p>
<pre>
  Rack::OpenID.build_header(:identifier =&gt; &quot;http://josh.openid.com/&quot;)
    #=&gt; OpenID identifier=&quot;http://josh.openid.com/&quot;
</pre>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000012_source')" id="l_M000012_source">show</a>
                        
                    </p>
                    <div id="M000012_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/rack/openid.rb, line 25</span>
25:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">build_header</span>(<span class="ruby-identifier">params</span> = {})
26:       <span class="ruby-value str">'OpenID '</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">params</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
27:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>)
28:           <span class="ruby-node">&quot;#{key}=\&quot;#{value.join(',')}\&quot;&quot;</span>
29:         <span class="ruby-keyword kw">else</span>
30:           <span class="ruby-node">&quot;#{key}=\&quot;#{value}\&quot;&quot;</span>
31:         <span class="ruby-keyword kw">end</span>
32:       }.<span class="ruby-identifier">join</span>(<span class="ruby-value str">', '</span>)
33:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000014">
                    
                    <a name="M000014"></a><b>new</b>(app, store = nil)
                    
                </div>
                
                <div class="description">
                  <p>
Initialize middleware with application and optional OpenID::Store. If no
store is given, OpenID::Store::Memory is used.
</p>
<pre>
  use Rack::OpenID
</pre>
<p>
or
</p>
<pre>
  use Rack::OpenID, OpenID::Store::Memcache.new
</pre>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000014_source')" id="l_M000014_source">show</a>
                        
                    </p>
                    <div id="M000014_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/rack/openid.rb, line 85</span>
85:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">store</span> = <span class="ruby-keyword kw">nil</span>)
86:       <span class="ruby-ivar">@app</span> = <span class="ruby-identifier">app</span>
87:       <span class="ruby-ivar">@store</span> = <span class="ruby-identifier">store</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">default_store</span>
88:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000013">
                    
                    <a name="M000013"></a><b>parse_header</b>(str)
                    
                </div>
                
                <div class="description">
                  <p>
Helper method for parsing &#8220;WWW-Authenticate&#8221; header values into
a hash.
</p>
<pre>
  Rack::OpenID.parse_header(&quot;OpenID identifier='http://josh.openid.com/'&quot;)
    #=&gt; {:identifier =&gt; &quot;http://josh.openid.com/&quot;}
</pre>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000013_source')" id="l_M000013_source">show</a>
                        
                    </p>
                    <div id="M000013_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/rack/openid.rb, line 40</span>
40:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">parse_header</span>(<span class="ruby-identifier">str</span>)
41:       <span class="ruby-identifier">params</span> = {}
42:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">str</span> <span class="ruby-operator">=~</span> <span class="ruby-constant">AUTHENTICATE_REGEXP</span>
43:         <span class="ruby-identifier">str</span> = <span class="ruby-identifier">str</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-node">/#{AUTHENTICATE_REGEXP}\s+/</span>, <span class="ruby-value str">''</span>)
44:         <span class="ruby-identifier">str</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">', '</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">pair</span><span class="ruby-operator">|</span>
45:           <span class="ruby-identifier">key</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">value</span> = <span class="ruby-identifier">pair</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">'='</span>)
46:           <span class="ruby-identifier">value</span> = <span class="ruby-identifier">value</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">'='</span>)
47:           <span class="ruby-identifier">value</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp re">/^\&quot;/</span>, <span class="ruby-value str">''</span>).<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp re">/\&quot;$/</span>, <span class="ruby-value str">&quot;&quot;</span>)
48:           <span class="ruby-identifier">value</span> = <span class="ruby-identifier">value</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>)
49:           <span class="ruby-identifier">params</span>[<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">value</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">value</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">first</span>
50:         }
51:       <span class="ruby-keyword kw">end</span>
52:       <span class="ruby-identifier">params</span>
53:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    