<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Daemons</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" />
    <script src="../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Module</span> 
            Daemons 
            
        </h1>
        <ul class="files">
            
            <li><a href="../files/lib/daemons/application_rb.html">lib/daemons/application.rb</a></li>
            
            <li><a href="../files/lib/daemons/application_group_rb.html">lib/daemons/application_group.rb</a></li>
            
            <li><a href="../files/lib/daemons/cmdline_rb.html">lib/daemons/cmdline.rb</a></li>
            
            <li><a href="../files/lib/daemons/controller_rb.html">lib/daemons/controller.rb</a></li>
            
            <li><a href="../files/lib/daemons/exceptions_rb.html">lib/daemons/exceptions.rb</a></li>
            
            <li><a href="../files/lib/daemons/pid_rb.html">lib/daemons/pid.rb</a></li>
            
            <li><a href="../files/lib/daemons/monitor_rb.html">lib/daemons/monitor.rb</a></li>
            
            <li><a href="../files/lib/daemons/pidfile_rb.html">lib/daemons/pidfile.rb</a></li>
            
            <li><a href="../files/lib/daemons/pidmem_rb.html">lib/daemons/pidmem.rb</a></li>
            
            <li><a href="../files/lib/daemons_rb.html">lib/daemons.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
All functions and classes that <a href="Daemons.html">Daemons</a> provides
reside in this module.
</p>
<p>
<a href="Daemons.html">Daemons</a> is normally invoked by one of the
following four ways:
</p>
<ol>
<li><tt><a href="Daemons.html#M000076">Daemons.run</a>(script, options)</tt>:
This is used in wrapper-scripts that are supposed to control other ruby
scripts or external applications. Control is completely passed to the
daemons library. Such wrapper script need to be invoked with command line
options like &#8216;start&#8217; or &#8216;stop&#8217; to do anything
useful.

</li>
<li><tt><a href="Daemons.html#M000077">Daemons.run_proc</a>(app_name, options)
{ (...) }</tt>: This is used in wrapper-scripts that are supposed to
control a proc. Control is completely passed to the daemons library. Such
wrapper script need to be invoked with command line options like
&#8216;start&#8217; or &#8216;stop&#8217; to do anything useful.

</li>
<li><tt><a href="Daemons.html#M000078">Daemons.call(options)</a> { block
}</tt>: Execute the block in a new daemon. <tt><a
href="Daemons.html#M000078">Daemons.call</a></tt> will return immediately
after spawning the daemon with the new <a
href="Daemons/Application.html">Application</a> object as a return value.

</li>
<li><tt><a href="Daemons.html#M000079">Daemons.daemonize(options)</a></tt>: <a
href="Daemonize.html">Daemonize</a> the currently runnig process, i.e. the
calling process will become a daemon.

</li>
</ol>
<h2>What does daemons internally do with my daemons?</h2>
<table>
<tr><td valign="top"><b>or</b>:</td><td>why do my daemons crash when they try to open a file?

</td></tr>
<tr><td valign="top"><b>or</b>:</td><td>why can I not see any output from the daemon on the console (when using for
example <tt>puts</tt>)?

</td></tr>
</table>
<p>
From a technical aspect of view, daemons does the following when creating a
daemon:
</p>
<ol>
<li>Forks a child (and exits the parent process, if needed)

</li>
<li>Becomes a session leader (which detaches the program from the controlling
terminal).

</li>
<li>Forks another child process and exits first child. This prevents the
potential of acquiring a controlling terminal.

</li>
<li>Changes the current working directory to &#8220;/&#8221;.

</li>
<li>Clears the file creation mask (sets <tt>umask</tt> to 0000).

</li>
<li>Closes file descriptors (reopens <tt>STDOUT</tt> and <tt>STDERR</tt> to
point to a logfile if possible).

</li>
</ol>
<p>
So what does this mean for your daemons:
</p>
<ul>
<li>the current directory is &#8217;/&#8217;

</li>
<li>you cannot receive any input from the console (for example no
<tt>gets</tt>)

</li>
<li>you cannot output anything from the daemons with
<tt>puts</tt>/<tt>print</tt> unless a logfile is used

</li>
</ul>
<h2>How do PidFiles work? Where are they stored?</h2>
<p>
Also, you are maybe interested in reading the documentation for the class
<a href="Daemons/PidFile.html">PidFile</a>. There you can find out about
how <a href="Daemons.html">Daemons</a> works internally and how and where
the so called <em>PidFiles</em> are stored.
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M000078">call</a>,</li>
                
                <li><a href="#M000078">call</a>,</li>
                
                <li><a href="#M000081">controller</a>,</li>
                
                <li><a href="#M000081">controller</a></li>
                
            </ul>
        </dd>
    
        <dt>D</dt>
        <dd>
            <ul>
                
                <li><a href="#M000079">daemonize</a>,</li>
                
                <li><a href="#M000079">daemonize</a></li>
                
            </ul>
        </dd>
    
        <dt>G</dt>
        <dd>
            <ul>
                
                <li><a href="#M000080">group</a>,</li>
                
                <li><a href="#M000080">group</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000076">run</a>,</li>
                
                <li><a href="#M000076">run</a>,</li>
                
                <li><a href="#M000077">run_proc</a>,</li>
                
                <li><a href="#M000077">run_proc</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    
    <div class="sectiontitle">Classes and Modules</div>
    <ul>
        
        <li><span class="type">CLASS</span> <a href="Daemons/Application.html">Daemons::Application</a></li>
        
        <li><span class="type">CLASS</span> <a href="Daemons/ApplicationGroup.html">Daemons::ApplicationGroup</a></li>
        
        <li><span class="type">CLASS</span> <a href="Daemons/CmdException.html">Daemons::CmdException</a></li>
        
        <li><span class="type">CLASS</span> <a href="Daemons/Controller.html">Daemons::Controller</a></li>
        
        <li><span class="type">CLASS</span> <a href="Daemons/Error.html">Daemons::Error</a></li>
        
        <li><span class="type">CLASS</span> <a href="Daemons/Exception.html">Daemons::Exception</a></li>
        
        <li><span class="type">CLASS</span> <a href="Daemons/Monitor.html">Daemons::Monitor</a></li>
        
        <li><span class="type">CLASS</span> <a href="Daemons/Optparse.html">Daemons::Optparse</a></li>
        
        <li><span class="type">CLASS</span> <a href="Daemons/Pid.html">Daemons::Pid</a></li>
        
        <li><span class="type">CLASS</span> <a href="Daemons/PidFile.html">Daemons::PidFile</a></li>
        
        <li><span class="type">CLASS</span> <a href="Daemons/PidMem.html">Daemons::PidMem</a></li>
        
        <li><span class="type">CLASS</span> <a href="Daemons/RuntimeException.html">Daemons::RuntimeException</a></li>
        
        <li><span class="type">CLASS</span> <a href="Daemons/SystemError.html">Daemons::SystemError</a></li>
        
    </ul>
    

    
    <div class="sectiontitle">Constants</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class="attr-name">VERSION</td>
            <td>=</td>
            <td class="attr-value">&quot;1.1.5&quot;</td>
        </tr>
        
        
    </table>
    

    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M000078">
                    
                    <a name="M000078"></a><b>call</b>(options = {}, &amp;block)
                    
                </div>
                
                <div class="description">
                  <p>
Execute the block in a new daemon. <tt><a
href="Daemons.html#M000078">Daemons.call</a></tt> will return immediately
after spawning the daemon with the new <a
href="Daemons/Application.html">Application</a> object as a return value.
</p>
<table>
<tr><td valign="top"><tt>options</tt>:</td><td>A hash that may contain one or more of the options listed below

</td></tr>
<tr><td valign="top"><tt>block</tt>:</td><td>The block to call in the daemon.

</td></tr>
</table>
<h3>Options:</h3>
<table>
<tr><td valign="top"><tt>:multiple</tt>:</td><td>Specifies whether multiple instances of the same script are allowed to run
at the same time

</td></tr>
<tr><td valign="top"><tt>:ontop</tt>:</td><td>When given, stay on top, i.e. do not daemonize the application

</td></tr>
<tr><td valign="top"><tt>:backtrace</tt>:</td><td>Write a backtrace of the last exceptions to the file
&#8217;[app_name].log&#8217; in the pid-file directory if the application
exits due to an uncaught exception

</td></tr>
</table>
<hr size="3"></hr><h3>Example:</h3>
<pre>
  options = {
    :backtrace  =&gt; true,
    :monitor    =&gt; true,
    :ontop      =&gt; true
  }

  Daemons.call(options) begin
    # Server loop:
    loop {
      conn = accept_conn()
      serve(conn)
    }
  end
</pre>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000078_source')" id="l_M000078_source">show</a>
                        
                    </p>
                    <div id="M000078_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons.rb, line 234</span>
234:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">call</span>(<span class="ruby-identifier">options</span> = {}, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
235:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">block_given?</span>
236:       <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Daemons.call: no block given&quot;</span>
237:     <span class="ruby-keyword kw">end</span>
238:     
239:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:proc</span>] = <span class="ruby-identifier">block</span>
240:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:mode</span>] = <span class="ruby-identifier">:proc</span>
241:     
242:     <span class="ruby-ivar">@group</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">ApplicationGroup</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'proc'</span>, <span class="ruby-identifier">options</span>)
243:     
244:     <span class="ruby-identifier">new_app</span> = <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">new_application</span>(<span class="ruby-identifier">options</span>)
245:     <span class="ruby-identifier">new_app</span>.<span class="ruby-identifier">start</span>
246: 
247:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">new_app</span>
248:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000081">
                    
                    <a name="M000081"></a><b>controller</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Return the internal <a href="Daemons/Controller.html">Controller</a>
instance.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000081_source')" id="l_M000081_source">show</a>
                        
                    </p>
                    <div id="M000081_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons.rb, line 306</span>
306:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">controller</span>; <span class="ruby-ivar">@controller</span>; <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000079">
                    
                    <a name="M000079"></a><b>daemonize</b>(options = {})
                    
                </div>
                
                <div class="description">
                  <p>
<a href="Daemonize.html">Daemonize</a> the currently runnig process, i.e.
the calling process will become a daemon.
</p>
<table>
<tr><td valign="top"><tt>options</tt>:</td><td>A hash that may contain one or more of the options listed below

</td></tr>
</table>
<h3>Options:</h3>
<table>
<tr><td valign="top"><tt>:ontop</tt>:</td><td>When given, stay on top, i.e. do not daemonize the application

</td></tr>
<tr><td valign="top"><tt>:backtrace</tt>:</td><td>Write a backtrace of the last exceptions to the file
&#8217;[app_name].log&#8217; in the pid-file directory if the application
exits due to an uncaught exception

</td></tr>
<tr><td valign="top"><tt>:app_name</tt>:</td><td>The name of the application. This will be used to contruct the name of the
pid files and log files. Defaults to the basename of the script.

</td></tr>
<tr><td valign="top"><tt>:dir_mode</tt>:</td><td>Either <tt>:script</tt> (the directory for writing files to given by
<tt>:dir</tt> is interpreted relative to the script location given by
<tt>script</tt>, the default) or <tt>:normal</tt> (the directory given by
<tt>:dir</tt> is interpreted as a (absolute or relative) path) or
<tt>:system</tt> (<tt>/var/run</tt> is used as the file directory)

</td></tr>
<tr><td valign="top"><tt>:dir</tt>:</td><td>Used in combination with <tt>:dir_mode</tt> (description above)

</td></tr>
<tr><td valign="top"><tt>:log_dir</tt>:</td><td>A specific directory to put the log files into (when not given, resort to
the default location as derived from the :dir_mode and :dir options

</td></tr>
<tr><td valign="top"><tt>:log_output</tt>:</td><td>When given (i.e. set to true), redirect both STDOUT and STDERR to a logfile
named &#8217;[app_name].output&#8217; in the pid-file directory

</td></tr>
</table>
<hr size="3"></hr><h3>Example:</h3>
<pre>
  options = {
    :backtrace  =&gt; true,
    :ontop      =&gt; true,
    :log_output =&gt; true
  }

  Daemons.daemonize(options)

  # Server loop:
  loop {
    conn = accept_conn()
    puts &quot;some text which goes to the output logfile&quot;
    serve(conn)
  }
</pre>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000079_source')" id="l_M000079_source">show</a>
                        
                    </p>
                    <div id="M000079_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons.rb, line 292</span>
292:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">daemonize</span>(<span class="ruby-identifier">options</span> = {})
293:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:script</span>] <span class="ruby-operator">||=</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">basename</span>(<span class="ruby-keyword kw">__FILE__</span>)
294:     
295:     <span class="ruby-ivar">@group</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">ApplicationGroup</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:app_name</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:script</span>], <span class="ruby-identifier">options</span>)
296:     
297:     <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">new_application</span>(<span class="ruby-identifier">:mode</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:none</span>).<span class="ruby-identifier">start</span>
298:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000080">
                    
                    <a name="M000080"></a><b>group</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Return the internal <a
href="Daemons/ApplicationGroup.html">ApplicationGroup</a> instance.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000080_source')" id="l_M000080_source">show</a>
                        
                    </p>
                    <div id="M000080_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons.rb, line 302</span>
302:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">group</span>; <span class="ruby-ivar">@group</span>; <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000076">
                    
                    <a name="M000076"></a><b>run</b>(script, options = {})
                    
                </div>
                
                <div class="description">
                  <p>
Passes control to <a href="Daemons.html">Daemons</a>. This is used in
wrapper-scripts that are supposed to control other ruby scripts or external
applications. Control is completely passed to the daemons library. Such
wrapper script should be invoked with command line options like
&#8216;start&#8217; or &#8216;stop&#8217; to do anything useful.
</p>
<table>
<tr><td valign="top"><tt>script</tt>:</td><td>This is the path to the script that should be run as a daemon. Please note
that <a href="Daemons.html">Daemons</a> runs this script with <tt>load
&lt;script&gt;</tt>. Also note that <a href="Daemons.html">Daemons</a>
cannot detect the directory in which the controlling script resides, so
this has to be either an absolute path or you have to run the controlling
script from the appropriate directory.

</td></tr>
<tr><td valign="top"><tt>options</tt>:</td><td>A hash that may contain one or more of the options listed below

</td></tr>
</table>
<h3>Options:</h3>
<table>
<tr><td valign="top"><tt>:app_name</tt>:</td><td>The name of the application. This will be used to contruct the name of the
pid files and log files. Defaults to the basename of the script.

</td></tr>
<tr><td valign="top"><tt>:ARGV</tt>:</td><td>An array of strings containing parameters and switches for <a
href="Daemons.html">Daemons</a>. This includes both parameters for <a
href="Daemons.html">Daemons</a> itself and the controlled scripted. These
are assumed to be separated by an array element &#8217;&#8212;&#8217;,
.e.g. [&#8216;start&#8217;, &#8216;f&#8217;, &#8217;&#8212;&#8217;,
&#8216;param1_for_script&#8217;, &#8216;param2_for_script&#8217;]. If not
given, ARGV (the parameters given to the Ruby process) will be used.

</td></tr>
<tr><td valign="top"><tt>:dir_mode</tt>:</td><td>Either <tt>:script</tt> (the directory for writing the pid files to given
by <tt>:dir</tt> is interpreted relative to the script location given by
<tt>script</tt>, the default) or <tt>:normal</tt> (the directory given by
<tt>:dir</tt> is interpreted as a (absolute or relative) path) or
<tt>:system</tt> (<tt>/var/run</tt> is used as the pid file directory)

</td></tr>
<tr><td valign="top"><tt>:dir</tt>:</td><td>Used in combination with <tt>:dir_mode</tt> (description above)

</td></tr>
<tr><td valign="top"><tt>:multiple</tt>:</td><td>Specifies whether multiple instances of the same script are allowed to run
at the same time

</td></tr>
<tr><td valign="top"><tt>:ontop</tt>:</td><td>When given (i.e. set to true), stay on top, i.e. do not daemonize the
application (but the pid-file and other things are written as usual)

</td></tr>
<tr><td valign="top"><tt>:mode</tt>:</td><td><tt>:load</tt> Load the script with <tt>Kernel.load</tt>; note that
:stop_proc only works for the :load (and :proc) mode. <tt>:exec</tt>
Execute the script file with <tt>Kernel.exec</tt>

</td></tr>
<tr><td valign="top"><tt>:backtrace</tt>:</td><td>Write a backtrace of the last exceptions to the file
&#8217;[app_name].log&#8217; in the pid-file directory if the application
exits due to an uncaught exception

</td></tr>
<tr><td valign="top"><tt>:monitor</tt>:</td><td><a href="Daemons/Monitor.html">Monitor</a> the programs and restart crashed
instances

</td></tr>
<tr><td valign="top"><tt>:log_dir</tt>:</td><td>A specific directory to put the log files into (when not given, resort to
the default location as derived from the :dir_mode and :dir options

</td></tr>
<tr><td valign="top"><tt>:log_output</tt>:</td><td>When given (i.e. set to true), redirect both STDOUT and STDERR to a logfile
named &#8217;[app_name].output&#8217; in the pid-file directory

</td></tr>
<tr><td valign="top"><tt>:keep_pid_files</tt>:</td><td>When given do not delete lingering pid-files (files for which the process
is no longer running).

</td></tr>
<tr><td valign="top"><tt>:hard_exit</tt>:</td><td>When given use exit! to end a daemons instead of exit (this will for
example not call at_exit handlers).

</td></tr>
<tr><td valign="top"><tt>:stop_proc</tt>:</td><td>A proc that will be called when the daemonized process receives a request
to stop (works only for :load and :proc mode)

</td></tr>
</table>
<hr size="3"></hr><h3>Example:</h3>
<pre>
  options = {
    :app_name   =&gt; &quot;my_app&quot;,
    :ARGV       =&gt; ['start', '-f', '--', 'param_for_myscript']
    :dir_mode   =&gt; :script,
    :dir        =&gt; 'pids',
    :multiple   =&gt; true,
    :ontop      =&gt; true,
    :mode       =&gt; :exec,
    :backtrace  =&gt; true,
    :monitor    =&gt; true
  }

  Daemons.run(File.join(File.dirname(__FILE__), 'myscript.rb'), options)
</pre>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000076_source')" id="l_M000076_source">show</a>
                        
                    </p>
                    <div id="M000076_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons.rb, line 140</span>
140:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">run</span>(<span class="ruby-identifier">script</span>, <span class="ruby-identifier">options</span> = {})
141:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:script</span>] = <span class="ruby-identifier">script</span>
142:     <span class="ruby-ivar">@controller</span> = <span class="ruby-constant">Controller</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">options</span>, <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:ARGV</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">ARGV</span>)
143:     
144:     <span class="ruby-ivar">@controller</span>.<span class="ruby-identifier">catch_exceptions</span> {
145:       <span class="ruby-ivar">@controller</span>.<span class="ruby-identifier">run</span>
146:     }
147:     
148:     <span class="ruby-comment cmt"># I don't think anybody will ever use @group, as this location should not be reached under non-error conditions</span>
149:     <span class="ruby-ivar">@group</span> = <span class="ruby-ivar">@controller</span>.<span class="ruby-identifier">group</span>
150:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000077">
                    
                    <a name="M000077"></a><b>run_proc</b>(app_name, options = {}, &amp;block)
                    
                </div>
                
                <div class="description">
                  <p>
Passes control to <a href="Daemons.html">Daemons</a>. This function does
the same as <a href="Daemons.html#M000076">Daemons.run</a> except that not
a script but a proc will be run as a daemon while this script provides
command line options like &#8216;start&#8217; or &#8216;stop&#8217; and the
whole pid-file management to control the proc.
</p>
<table>
<tr><td valign="top"><tt>app_name</tt>:</td><td>The name of the application. This will be used to contruct the name of the
pid files and log files. Defaults to the basename of the script.

</td></tr>
<tr><td valign="top"><tt>options</tt>:</td><td>A hash that may contain one or more of the options listed in the
documentation for <a href="Daemons.html#M000076">Daemons.run</a>

</td></tr>
</table>
<p>
A block must be given to this function. The block will be used as the :proc
entry in the options hash.
</p>
<hr size="3"></hr><h3>Example:</h3>
<pre>
  Daemons.run_proc('myproc.rb') do
    loop do
      accept_connection()
      read_request()
      send_response()
      close_connection()
    end
  end
</pre>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000077_source')" id="l_M000077_source">show</a>
                        
                    </p>
                    <div id="M000077_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons.rb, line 181</span>
181:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">run_proc</span>(<span class="ruby-identifier">app_name</span>, <span class="ruby-identifier">options</span> = {}, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
182:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:app_name</span>] = <span class="ruby-identifier">app_name</span>
183:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:mode</span>] = <span class="ruby-identifier">:proc</span>
184:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:proc</span>] = <span class="ruby-identifier">block</span>
185:     
186:     <span class="ruby-comment cmt"># we do not have a script location so the the :script :dir_mode cannot be used, change it to :normal</span>
187:     <span class="ruby-keyword kw">if</span> [<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">:script</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:dir_mode</span>]
188:       <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:dir_mode</span>] = <span class="ruby-identifier">:normal</span>
189:       <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:dir</span>] <span class="ruby-operator">||=</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-value str">'.'</span>)
190:     <span class="ruby-keyword kw">end</span>
191:     
192:     <span class="ruby-ivar">@controller</span> = <span class="ruby-constant">Controller</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">options</span>, <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:ARGV</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">ARGV</span>)
193:     
194:     <span class="ruby-ivar">@controller</span>.<span class="ruby-identifier">catch_exceptions</span> {
195:       <span class="ruby-ivar">@controller</span>.<span class="ruby-identifier">run</span>
196:     }
197:     
198:     <span class="ruby-comment cmt"># I don't think anybody will ever use @group, as this location should not be reached under non-error conditions</span>
199:     <span class="ruby-ivar">@group</span> = <span class="ruby-ivar">@controller</span>.<span class="ruby-identifier">group</span>
200:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Private methods</div>
            
            <div class="method">
                <div class="title" id="M000078">
                    
                    <a name="M000078"></a><b>call</b>(options = {}, &amp;block)
                    
                </div>
                
                <div class="description">
                  <p>
Execute the block in a new daemon. <tt><a
href="Daemons.html#M000078">Daemons.call</a></tt> will return immediately
after spawning the daemon with the new <a
href="Daemons/Application.html">Application</a> object as a return value.
</p>
<table>
<tr><td valign="top"><tt>options</tt>:</td><td>A hash that may contain one or more of the options listed below

</td></tr>
<tr><td valign="top"><tt>block</tt>:</td><td>The block to call in the daemon.

</td></tr>
</table>
<h3>Options:</h3>
<table>
<tr><td valign="top"><tt>:multiple</tt>:</td><td>Specifies whether multiple instances of the same script are allowed to run
at the same time

</td></tr>
<tr><td valign="top"><tt>:ontop</tt>:</td><td>When given, stay on top, i.e. do not daemonize the application

</td></tr>
<tr><td valign="top"><tt>:backtrace</tt>:</td><td>Write a backtrace of the last exceptions to the file
&#8217;[app_name].log&#8217; in the pid-file directory if the application
exits due to an uncaught exception

</td></tr>
</table>
<hr size="3"></hr><h3>Example:</h3>
<pre>
  options = {
    :backtrace  =&gt; true,
    :monitor    =&gt; true,
    :ontop      =&gt; true
  }

  Daemons.call(options) begin
    # Server loop:
    loop {
      conn = accept_conn()
      serve(conn)
    }
  end
</pre>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000078_source')" id="l_M000078_source">show</a>
                        
                    </p>
                    <div id="M000078_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons.rb, line 234</span>
234:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">call</span>(<span class="ruby-identifier">options</span> = {}, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
235:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">block_given?</span>
236:       <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Daemons.call: no block given&quot;</span>
237:     <span class="ruby-keyword kw">end</span>
238:     
239:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:proc</span>] = <span class="ruby-identifier">block</span>
240:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:mode</span>] = <span class="ruby-identifier">:proc</span>
241:     
242:     <span class="ruby-ivar">@group</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">ApplicationGroup</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'proc'</span>, <span class="ruby-identifier">options</span>)
243:     
244:     <span class="ruby-identifier">new_app</span> = <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">new_application</span>(<span class="ruby-identifier">options</span>)
245:     <span class="ruby-identifier">new_app</span>.<span class="ruby-identifier">start</span>
246: 
247:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">new_app</span>
248:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000081">
                    
                    <a name="M000081"></a><b>controller</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Return the internal <a href="Daemons/Controller.html">Controller</a>
instance.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000081_source')" id="l_M000081_source">show</a>
                        
                    </p>
                    <div id="M000081_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons.rb, line 306</span>
306:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">controller</span>; <span class="ruby-ivar">@controller</span>; <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000079">
                    
                    <a name="M000079"></a><b>daemonize</b>(options = {})
                    
                </div>
                
                <div class="description">
                  <p>
<a href="Daemonize.html">Daemonize</a> the currently runnig process, i.e.
the calling process will become a daemon.
</p>
<table>
<tr><td valign="top"><tt>options</tt>:</td><td>A hash that may contain one or more of the options listed below

</td></tr>
</table>
<h3>Options:</h3>
<table>
<tr><td valign="top"><tt>:ontop</tt>:</td><td>When given, stay on top, i.e. do not daemonize the application

</td></tr>
<tr><td valign="top"><tt>:backtrace</tt>:</td><td>Write a backtrace of the last exceptions to the file
&#8217;[app_name].log&#8217; in the pid-file directory if the application
exits due to an uncaught exception

</td></tr>
<tr><td valign="top"><tt>:app_name</tt>:</td><td>The name of the application. This will be used to contruct the name of the
pid files and log files. Defaults to the basename of the script.

</td></tr>
<tr><td valign="top"><tt>:dir_mode</tt>:</td><td>Either <tt>:script</tt> (the directory for writing files to given by
<tt>:dir</tt> is interpreted relative to the script location given by
<tt>script</tt>, the default) or <tt>:normal</tt> (the directory given by
<tt>:dir</tt> is interpreted as a (absolute or relative) path) or
<tt>:system</tt> (<tt>/var/run</tt> is used as the file directory)

</td></tr>
<tr><td valign="top"><tt>:dir</tt>:</td><td>Used in combination with <tt>:dir_mode</tt> (description above)

</td></tr>
<tr><td valign="top"><tt>:log_dir</tt>:</td><td>A specific directory to put the log files into (when not given, resort to
the default location as derived from the :dir_mode and :dir options

</td></tr>
<tr><td valign="top"><tt>:log_output</tt>:</td><td>When given (i.e. set to true), redirect both STDOUT and STDERR to a logfile
named &#8217;[app_name].output&#8217; in the pid-file directory

</td></tr>
</table>
<hr size="3"></hr><h3>Example:</h3>
<pre>
  options = {
    :backtrace  =&gt; true,
    :ontop      =&gt; true,
    :log_output =&gt; true
  }

  Daemons.daemonize(options)

  # Server loop:
  loop {
    conn = accept_conn()
    puts &quot;some text which goes to the output logfile&quot;
    serve(conn)
  }
</pre>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000079_source')" id="l_M000079_source">show</a>
                        
                    </p>
                    <div id="M000079_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons.rb, line 292</span>
292:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">daemonize</span>(<span class="ruby-identifier">options</span> = {})
293:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:script</span>] <span class="ruby-operator">||=</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">basename</span>(<span class="ruby-keyword kw">__FILE__</span>)
294:     
295:     <span class="ruby-ivar">@group</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">ApplicationGroup</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:app_name</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:script</span>], <span class="ruby-identifier">options</span>)
296:     
297:     <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">new_application</span>(<span class="ruby-identifier">:mode</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:none</span>).<span class="ruby-identifier">start</span>
298:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000080">
                    
                    <a name="M000080"></a><b>group</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Return the internal <a
href="Daemons/ApplicationGroup.html">ApplicationGroup</a> instance.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000080_source')" id="l_M000080_source">show</a>
                        
                    </p>
                    <div id="M000080_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons.rb, line 302</span>
302:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">group</span>; <span class="ruby-ivar">@group</span>; <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000076">
                    
                    <a name="M000076"></a><b>run</b>(script, options = {})
                    
                </div>
                
                <div class="description">
                  <p>
Passes control to <a href="Daemons.html">Daemons</a>. This is used in
wrapper-scripts that are supposed to control other ruby scripts or external
applications. Control is completely passed to the daemons library. Such
wrapper script should be invoked with command line options like
&#8216;start&#8217; or &#8216;stop&#8217; to do anything useful.
</p>
<table>
<tr><td valign="top"><tt>script</tt>:</td><td>This is the path to the script that should be run as a daemon. Please note
that <a href="Daemons.html">Daemons</a> runs this script with <tt>load
&lt;script&gt;</tt>. Also note that <a href="Daemons.html">Daemons</a>
cannot detect the directory in which the controlling script resides, so
this has to be either an absolute path or you have to run the controlling
script from the appropriate directory.

</td></tr>
<tr><td valign="top"><tt>options</tt>:</td><td>A hash that may contain one or more of the options listed below

</td></tr>
</table>
<h3>Options:</h3>
<table>
<tr><td valign="top"><tt>:app_name</tt>:</td><td>The name of the application. This will be used to contruct the name of the
pid files and log files. Defaults to the basename of the script.

</td></tr>
<tr><td valign="top"><tt>:ARGV</tt>:</td><td>An array of strings containing parameters and switches for <a
href="Daemons.html">Daemons</a>. This includes both parameters for <a
href="Daemons.html">Daemons</a> itself and the controlled scripted. These
are assumed to be separated by an array element &#8217;&#8212;&#8217;,
.e.g. [&#8216;start&#8217;, &#8216;f&#8217;, &#8217;&#8212;&#8217;,
&#8216;param1_for_script&#8217;, &#8216;param2_for_script&#8217;]. If not
given, ARGV (the parameters given to the Ruby process) will be used.

</td></tr>
<tr><td valign="top"><tt>:dir_mode</tt>:</td><td>Either <tt>:script</tt> (the directory for writing the pid files to given
by <tt>:dir</tt> is interpreted relative to the script location given by
<tt>script</tt>, the default) or <tt>:normal</tt> (the directory given by
<tt>:dir</tt> is interpreted as a (absolute or relative) path) or
<tt>:system</tt> (<tt>/var/run</tt> is used as the pid file directory)

</td></tr>
<tr><td valign="top"><tt>:dir</tt>:</td><td>Used in combination with <tt>:dir_mode</tt> (description above)

</td></tr>
<tr><td valign="top"><tt>:multiple</tt>:</td><td>Specifies whether multiple instances of the same script are allowed to run
at the same time

</td></tr>
<tr><td valign="top"><tt>:ontop</tt>:</td><td>When given (i.e. set to true), stay on top, i.e. do not daemonize the
application (but the pid-file and other things are written as usual)

</td></tr>
<tr><td valign="top"><tt>:mode</tt>:</td><td><tt>:load</tt> Load the script with <tt>Kernel.load</tt>; note that
:stop_proc only works for the :load (and :proc) mode. <tt>:exec</tt>
Execute the script file with <tt>Kernel.exec</tt>

</td></tr>
<tr><td valign="top"><tt>:backtrace</tt>:</td><td>Write a backtrace of the last exceptions to the file
&#8217;[app_name].log&#8217; in the pid-file directory if the application
exits due to an uncaught exception

</td></tr>
<tr><td valign="top"><tt>:monitor</tt>:</td><td><a href="Daemons/Monitor.html">Monitor</a> the programs and restart crashed
instances

</td></tr>
<tr><td valign="top"><tt>:log_dir</tt>:</td><td>A specific directory to put the log files into (when not given, resort to
the default location as derived from the :dir_mode and :dir options

</td></tr>
<tr><td valign="top"><tt>:log_output</tt>:</td><td>When given (i.e. set to true), redirect both STDOUT and STDERR to a logfile
named &#8217;[app_name].output&#8217; in the pid-file directory

</td></tr>
<tr><td valign="top"><tt>:keep_pid_files</tt>:</td><td>When given do not delete lingering pid-files (files for which the process
is no longer running).

</td></tr>
<tr><td valign="top"><tt>:hard_exit</tt>:</td><td>When given use exit! to end a daemons instead of exit (this will for
example not call at_exit handlers).

</td></tr>
<tr><td valign="top"><tt>:stop_proc</tt>:</td><td>A proc that will be called when the daemonized process receives a request
to stop (works only for :load and :proc mode)

</td></tr>
</table>
<hr size="3"></hr><h3>Example:</h3>
<pre>
  options = {
    :app_name   =&gt; &quot;my_app&quot;,
    :ARGV       =&gt; ['start', '-f', '--', 'param_for_myscript']
    :dir_mode   =&gt; :script,
    :dir        =&gt; 'pids',
    :multiple   =&gt; true,
    :ontop      =&gt; true,
    :mode       =&gt; :exec,
    :backtrace  =&gt; true,
    :monitor    =&gt; true
  }

  Daemons.run(File.join(File.dirname(__FILE__), 'myscript.rb'), options)
</pre>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000076_source')" id="l_M000076_source">show</a>
                        
                    </p>
                    <div id="M000076_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons.rb, line 140</span>
140:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">run</span>(<span class="ruby-identifier">script</span>, <span class="ruby-identifier">options</span> = {})
141:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:script</span>] = <span class="ruby-identifier">script</span>
142:     <span class="ruby-ivar">@controller</span> = <span class="ruby-constant">Controller</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">options</span>, <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:ARGV</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">ARGV</span>)
143:     
144:     <span class="ruby-ivar">@controller</span>.<span class="ruby-identifier">catch_exceptions</span> {
145:       <span class="ruby-ivar">@controller</span>.<span class="ruby-identifier">run</span>
146:     }
147:     
148:     <span class="ruby-comment cmt"># I don't think anybody will ever use @group, as this location should not be reached under non-error conditions</span>
149:     <span class="ruby-ivar">@group</span> = <span class="ruby-ivar">@controller</span>.<span class="ruby-identifier">group</span>
150:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000077">
                    
                    <a name="M000077"></a><b>run_proc</b>(app_name, options = {}, &amp;block)
                    
                </div>
                
                <div class="description">
                  <p>
Passes control to <a href="Daemons.html">Daemons</a>. This function does
the same as <a href="Daemons.html#M000076">Daemons.run</a> except that not
a script but a proc will be run as a daemon while this script provides
command line options like &#8216;start&#8217; or &#8216;stop&#8217; and the
whole pid-file management to control the proc.
</p>
<table>
<tr><td valign="top"><tt>app_name</tt>:</td><td>The name of the application. This will be used to contruct the name of the
pid files and log files. Defaults to the basename of the script.

</td></tr>
<tr><td valign="top"><tt>options</tt>:</td><td>A hash that may contain one or more of the options listed in the
documentation for <a href="Daemons.html#M000076">Daemons.run</a>

</td></tr>
</table>
<p>
A block must be given to this function. The block will be used as the :proc
entry in the options hash.
</p>
<hr size="3"></hr><h3>Example:</h3>
<pre>
  Daemons.run_proc('myproc.rb') do
    loop do
      accept_connection()
      read_request()
      send_response()
      close_connection()
    end
  end
</pre>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000077_source')" id="l_M000077_source">show</a>
                        
                    </p>
                    <div id="M000077_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons.rb, line 181</span>
181:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">run_proc</span>(<span class="ruby-identifier">app_name</span>, <span class="ruby-identifier">options</span> = {}, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
182:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:app_name</span>] = <span class="ruby-identifier">app_name</span>
183:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:mode</span>] = <span class="ruby-identifier">:proc</span>
184:     <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:proc</span>] = <span class="ruby-identifier">block</span>
185:     
186:     <span class="ruby-comment cmt"># we do not have a script location so the the :script :dir_mode cannot be used, change it to :normal</span>
187:     <span class="ruby-keyword kw">if</span> [<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">:script</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:dir_mode</span>]
188:       <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:dir_mode</span>] = <span class="ruby-identifier">:normal</span>
189:       <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:dir</span>] <span class="ruby-operator">||=</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-value str">'.'</span>)
190:     <span class="ruby-keyword kw">end</span>
191:     
192:     <span class="ruby-ivar">@controller</span> = <span class="ruby-constant">Controller</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">options</span>, <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:ARGV</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">ARGV</span>)
193:     
194:     <span class="ruby-ivar">@controller</span>.<span class="ruby-identifier">catch_exceptions</span> {
195:       <span class="ruby-ivar">@controller</span>.<span class="ruby-identifier">run</span>
196:     }
197:     
198:     <span class="ruby-comment cmt"># I don't think anybody will ever use @group, as this location should not be reached under non-error conditions</span>
199:     <span class="ruby-ivar">@group</span> = <span class="ruby-ivar">@controller</span>.<span class="ruby-identifier">group</span>
200:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    