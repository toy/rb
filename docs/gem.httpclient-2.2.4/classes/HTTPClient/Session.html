<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>HTTPClient::Session</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
    <script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            HTTPClient::Session 
            
                <span class="parent">&lt; 
                    
                    Object
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/httpclient/session_rb.html">lib/httpclient/session.rb</a></li>
            
            <li><a href="../../files/lib/httpclient_rb.html">lib/httpclient.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
Deprecated. just for backward compatibility
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M000244">close</a>,</li>
                
                <li><a href="#M000245">closed?</a>,</li>
                
                <li><a href="#M000252">connect</a>,</li>
                
                <li><a href="#M000260">connect_ssl_proxy</a>,</li>
                
                <li><a href="#M000254">create_socket</a>,</li>
                
                <li><a href="#M000259">create_ssl_socket</a></li>
                
            </ul>
        </dd>
    
        <dt>E</dt>
        <dd>
            <ul>
                
                <li><a href="#M000249">eof?</a></li>
                
            </ul>
        </dd>
    
        <dt>G</dt>
        <dd>
            <ul>
                
                <li><a href="#M000250">get_body</a>,</li>
                
                <li><a href="#M000248">get_header</a></li>
                
            </ul>
        </dd>
    
        <dt>I</dt>
        <dd>
            <ul>
                
                <li><a href="#M000246">invalidate</a>,</li>
                
                <li><a href="#M000247">invalidated?</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M000242">new</a>,</li>
                
                <li><a href="#M000279">no_message_body?</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M000272">parse_header</a>,</li>
                
                <li><a href="#M000280">parse_keepalive_header</a></li>
                
            </ul>
        </dd>
    
        <dt>Q</dt>
        <dd>
            <ul>
                
                <li><a href="#M000243">query</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000284">read_body_chunked</a>,</li>
                
                <li><a href="#M000283">read_body_length</a>,</li>
                
                <li><a href="#M000285">read_body_rest</a>,</li>
                
                <li><a href="#M000267">read_header</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M000251">set_header</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    
    <div class="sectiontitle">Included Modules</div>
    <ul>
        
        <li>
            
            <a href="Util.html">HTTPClient::Util</a>
            
            START:includes
        </li>
        
        <li>
            
            <a href="Util.html">HTTPClient::Util</a>
            
            START:includes
        </li>
        
    </ul>
    

    

    

    
    <div class="sectiontitle">Constants</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class="attr-name">StatusParseRegexp</td>
            <td>=</td>
            <td class="attr-value">%r(\AHTTP/(\d+\.\d+)\s+(\d\d\d)\s*([^\r\n]+)?\r?\n\z)</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">RS</td>
            <td>=</td>
            <td class="attr-value">&quot;\r\n&quot;</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">BadResponse</td>
            <td>=</td>
            <td class="attr-value">::HTTPClient::BadResponseError</td>
        </tr>
        
        
    </table>
    

    
    <div class="sectiontitle">Attributes</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>dest</td>
            <td class='attr-desc'><p>
Destination site
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>proxy</td>
            <td class='attr-desc'><p>
Proxy site
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>socket_sync</td>
            <td class='attr-desc'><p>
Boolean value for Socket#sync
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>requested_version</td>
            <td class='attr-desc'><p>
Requested protocol version
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>debug_dev</td>
            <td class='attr-desc'><p>
Device for dumping log for debugging
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>connect_timeout</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>connect_retry</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>send_timeout</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>receive_timeout</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>read_block_size</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>protocol_retry_count</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>socket_local</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>ssl_config</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>ssl_peer_cert</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>test_loopback_http_response</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>transparent_gzip_decompression</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>last_used</td>
            <td class='attr-desc'></td>
        </tr>
        
    </table>
    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M000242">
                    
                    <a name="M000242"></a><b>new</b>(client, dest, agent_name, from)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000242_source')" id="l_M000242_source">show</a>
                        
                    </p>
                    <div id="M000242_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 552</span>
552:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">client</span>, <span class="ruby-identifier">dest</span>, <span class="ruby-identifier">agent_name</span>, <span class="ruby-identifier">from</span>)
553:       <span class="ruby-ivar">@client</span> = <span class="ruby-identifier">client</span>
554:       <span class="ruby-ivar">@dest</span> = <span class="ruby-identifier">dest</span>
555:       <span class="ruby-ivar">@invalidated</span> = <span class="ruby-keyword kw">false</span>
556:       <span class="ruby-ivar">@proxy</span> = <span class="ruby-keyword kw">nil</span>
557:       <span class="ruby-ivar">@socket_sync</span> = <span class="ruby-keyword kw">true</span>
558:       <span class="ruby-ivar">@requested_version</span> = <span class="ruby-keyword kw">nil</span>
559: 
560:       <span class="ruby-ivar">@debug_dev</span> = <span class="ruby-keyword kw">nil</span>
561: 
562:       <span class="ruby-ivar">@connect_timeout</span> = <span class="ruby-keyword kw">nil</span>
563:       <span class="ruby-ivar">@connect_retry</span> = <span class="ruby-value">1</span>
564:       <span class="ruby-ivar">@send_timeout</span> = <span class="ruby-keyword kw">nil</span>
565:       <span class="ruby-ivar">@receive_timeout</span> = <span class="ruby-keyword kw">nil</span>
566:       <span class="ruby-ivar">@read_block_size</span> = <span class="ruby-keyword kw">nil</span>
567:       <span class="ruby-ivar">@protocol_retry_count</span> = <span class="ruby-value">5</span>
568: 
569:       <span class="ruby-ivar">@ssl_config</span> = <span class="ruby-keyword kw">nil</span>
570:       <span class="ruby-ivar">@ssl_peer_cert</span> = <span class="ruby-keyword kw">nil</span>
571: 
572:       <span class="ruby-ivar">@test_loopback_http_response</span> = <span class="ruby-keyword kw">nil</span>
573:       <span class="ruby-ivar">@socket_local</span> = <span class="ruby-constant">Site</span><span class="ruby-operator">::</span><span class="ruby-constant">EMPTY</span>
574: 
575:       <span class="ruby-ivar">@agent_name</span> = <span class="ruby-identifier">agent_name</span>
576:       <span class="ruby-ivar">@from</span> = <span class="ruby-identifier">from</span>
577:       <span class="ruby-ivar">@state</span> = <span class="ruby-identifier">:INIT</span>
578: 
579:       <span class="ruby-ivar">@requests</span> = []
580: 
581:       <span class="ruby-ivar">@status</span> = <span class="ruby-keyword kw">nil</span>
582:       <span class="ruby-ivar">@reason</span> = <span class="ruby-keyword kw">nil</span>
583:       <span class="ruby-ivar">@headers</span> = []
584: 
585:       <span class="ruby-ivar">@socket</span> = <span class="ruby-keyword kw">nil</span>
586:       <span class="ruby-ivar">@readbuf</span> = <span class="ruby-keyword kw">nil</span>
587: 
588:       <span class="ruby-ivar">@transparent_gzip_decompression</span> = <span class="ruby-keyword kw">false</span>
589:       <span class="ruby-ivar">@last_used</span> = <span class="ruby-keyword kw">nil</span>
590:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000244">
                    
                    <a name="M000244"></a><b>close</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000244_source')" id="l_M000244_source">show</a>
                        
                    </p>
                    <div id="M000244_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 626</span>
626:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">close</span>
627:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">and</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">closed?</span>
628:         <span class="ruby-comment cmt"># @socket.flush may block when it the socket is already closed by</span>
629:         <span class="ruby-comment cmt"># foreign host and the client runs under MT-condition.</span>
630:         <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">close</span>
631:       <span class="ruby-keyword kw">end</span>
632:       <span class="ruby-ivar">@state</span> = <span class="ruby-identifier">:INIT</span>
633:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000245">
                    
                    <a name="M000245"></a><b>closed?</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000245_source')" id="l_M000245_source">show</a>
                        
                    </p>
                    <div id="M000245_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 635</span>
635:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">closed?</span>
636:       <span class="ruby-ivar">@state</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:INIT</span>
637:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000249">
                    
                    <a name="M000249"></a><b>eof?</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000249_source')" id="l_M000249_source">show</a>
                        
                    </p>
                    <div id="M000249_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 660</span>
660:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">eof?</span>
661:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@content_length</span>.<span class="ruby-identifier">nil?</span>
662:         <span class="ruby-ivar">@content_length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
663:       <span class="ruby-keyword kw">else</span>
664:         <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">closed?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">eof?</span>
665:       <span class="ruby-keyword kw">end</span>
666:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000250">
                    
                    <a name="M000250"></a><b>get_body</b>(&amp;block)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000250_source')" id="l_M000250_source">show</a>
                        
                    </p>
                    <div id="M000250_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 668</span>
668:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_body</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
669:       <span class="ruby-keyword kw">begin</span>
670:         <span class="ruby-identifier">read_header</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@state</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:META</span>
671:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@state</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">:DATA</span>
672:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@gzipped</span> <span class="ruby-keyword kw">and</span> <span class="ruby-ivar">@transparent_gzip_decompression</span>
673:           <span class="ruby-comment cmt"># zlib itself has a functionality to decompress gzip stream.</span>
674:           <span class="ruby-comment cmt"># - zlib 1.2.5 Manual</span>
675:           <span class="ruby-comment cmt">#   http://www.zlib.net/manual.html#Advanced</span>
676:           <span class="ruby-comment cmt"># &gt; windowBits can also be greater than 15 for optional gzip decoding. Add 32 to</span>
677:           <span class="ruby-comment cmt"># &gt; windowBits to enable zlib and gzip decoding with automatic header detection,</span>
678:           <span class="ruby-comment cmt"># &gt; or add 16 to decode only the gzip format</span>
679:           <span class="ruby-identifier">inflate_stream</span> = <span class="ruby-constant">Zlib</span><span class="ruby-operator">::</span><span class="ruby-constant">Inflate</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">Zlib</span><span class="ruby-operator">::</span><span class="ruby-constant">MAX_WBITS</span> <span class="ruby-operator">+</span> <span class="ruby-value">32</span>)
680:           <span class="ruby-identifier">original_block</span> = <span class="ruby-identifier">block</span>
681:           <span class="ruby-identifier">block</span> = <span class="ruby-constant">Proc</span>.<span class="ruby-identifier">new</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">buf</span><span class="ruby-operator">|</span>
682:             <span class="ruby-identifier">original_block</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">inflate_stream</span>.<span class="ruby-identifier">inflate</span>(<span class="ruby-identifier">buf</span>))
683:           }
684:         <span class="ruby-keyword kw">end</span>
685:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@chunked</span>
686:           <span class="ruby-identifier">read_body_chunked</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
687:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@content_length</span>
688:           <span class="ruby-identifier">read_body_length</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
689:         <span class="ruby-keyword kw">else</span>
690:           <span class="ruby-identifier">read_body_rest</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
691:         <span class="ruby-keyword kw">end</span>
692:       <span class="ruby-keyword kw">rescue</span>
693:         <span class="ruby-identifier">close</span>
694:         <span class="ruby-identifier">raise</span>
695:       <span class="ruby-keyword kw">end</span>
696:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">eof?</span>
697:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@next_connection</span>
698:           <span class="ruby-ivar">@state</span> = <span class="ruby-identifier">:WAIT</span>
699:         <span class="ruby-keyword kw">else</span>
700:           <span class="ruby-identifier">close</span>
701:         <span class="ruby-keyword kw">end</span>
702:       <span class="ruby-keyword kw">end</span>
703:       <span class="ruby-keyword kw">nil</span>
704:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000248">
                    
                    <a name="M000248"></a><b>get_header</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000248_source')" id="l_M000248_source">show</a>
                        
                    </p>
                    <div id="M000248_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 647</span>
647:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_header</span>
648:       <span class="ruby-keyword kw">begin</span>
649:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@state</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">:META</span>
650:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">RuntimeError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">&quot;get_status must be called at the beginning of a session&quot;</span>)
651:         <span class="ruby-keyword kw">end</span>
652:         <span class="ruby-identifier">read_header</span>
653:       <span class="ruby-keyword kw">rescue</span>
654:         <span class="ruby-identifier">close</span>
655:         <span class="ruby-identifier">raise</span>
656:       <span class="ruby-keyword kw">end</span>
657:       [<span class="ruby-ivar">@version</span>, <span class="ruby-ivar">@status</span>, <span class="ruby-ivar">@reason</span>, <span class="ruby-ivar">@headers</span>]
658:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000246">
                    
                    <a name="M000246"></a><b>invalidate</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000246_source')" id="l_M000246_source">show</a>
                        
                    </p>
                    <div id="M000246_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 639</span>
639:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">invalidate</span>
640:       <span class="ruby-ivar">@invalidated</span> = <span class="ruby-keyword kw">true</span>
641:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000247">
                    
                    <a name="M000247"></a><b>invalidated?</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000247_source')" id="l_M000247_source">show</a>
                        
                    </p>
                    <div id="M000247_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 643</span>
643:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">invalidated?</span>
644:       <span class="ruby-ivar">@invalidated</span>
645:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000243">
                    
                    <a name="M000243"></a><b>query</b>(req)
                    
                </div>
                
                <div class="description">
                  <p>
Send a request to the server
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000243_source')" id="l_M000243_source">show</a>
                        
                    </p>
                    <div id="M000243_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 593</span>
593:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">query</span>(<span class="ruby-identifier">req</span>)
594:       <span class="ruby-identifier">connect</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@state</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:INIT</span>
595:       <span class="ruby-comment cmt"># Use absolute URI (not absolute path) iif via proxy AND not HTTPS.</span>
596:       <span class="ruby-identifier">req</span>.<span class="ruby-identifier">header</span>.<span class="ruby-identifier">request_absolute_uri</span> = <span class="ruby-operator">!</span><span class="ruby-ivar">@proxy</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">and</span> <span class="ruby-operator">!</span><span class="ruby-identifier">https?</span>(<span class="ruby-ivar">@dest</span>)
597:       <span class="ruby-keyword kw">begin</span>
598:         <span class="ruby-identifier">timeout</span>(<span class="ruby-ivar">@send_timeout</span>, <span class="ruby-constant">SendTimeoutError</span>) <span class="ruby-keyword kw">do</span>
599:           <span class="ruby-identifier">set_header</span>(<span class="ruby-identifier">req</span>)
600:           <span class="ruby-identifier">req</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-ivar">@socket</span>)
601:           <span class="ruby-comment cmt"># flush the IO stream as IO::sync mode is false</span>
602:           <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">flush</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@socket_sync</span>
603:         <span class="ruby-keyword kw">end</span>
604:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNABORTED</span>, <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNRESET</span>, <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EPIPE</span>, <span class="ruby-constant">IOError</span>
605:         <span class="ruby-comment cmt"># JRuby can raise IOError instead of ECONNRESET for now</span>
606:         <span class="ruby-identifier">close</span>
607:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">KeepAliveDisconnected</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">self</span>)
608:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">HTTPClient</span><span class="ruby-operator">::</span><span class="ruby-constant">TimeoutError</span>
609:         <span class="ruby-identifier">close</span>
610:         <span class="ruby-identifier">raise</span>
611:       <span class="ruby-keyword kw">rescue</span>
612:         <span class="ruby-identifier">close</span>
613:         <span class="ruby-keyword kw">if</span> <span class="ruby-constant">SSLEnabled</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">$!</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">OpenSSL</span><span class="ruby-operator">::</span><span class="ruby-constant">SSL</span><span class="ruby-operator">::</span><span class="ruby-constant">SSLError</span>)
614:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">KeepAliveDisconnected</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">self</span>)
615:         <span class="ruby-keyword kw">else</span>
616:           <span class="ruby-identifier">raise</span>
617:         <span class="ruby-keyword kw">end</span>
618:       <span class="ruby-keyword kw">end</span>
619: 
620:       <span class="ruby-ivar">@state</span> = <span class="ruby-identifier">:META</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@state</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:WAIT</span>
621:       <span class="ruby-ivar">@next_connection</span> = <span class="ruby-keyword kw">nil</span>
622:       <span class="ruby-ivar">@requests</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">req</span>)
623:       <span class="ruby-ivar">@last_used</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
624:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Private methods</div>
            
            <div class="method">
                <div class="title" id="M000252">
                    
                    <a name="M000252"></a><b>connect</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Connect to the server
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000252_source')" id="l_M000252_source">show</a>
                        
                    </p>
                    <div id="M000252_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 727</span>
727:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">connect</span>
728:       <span class="ruby-identifier">site</span> = <span class="ruby-ivar">@proxy</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@dest</span>
729:       <span class="ruby-identifier">retry_number</span> = <span class="ruby-value">0</span>
730:       <span class="ruby-keyword kw">begin</span>
731:         <span class="ruby-identifier">timeout</span>(<span class="ruby-ivar">@connect_timeout</span>, <span class="ruby-constant">ConnectTimeoutError</span>) <span class="ruby-keyword kw">do</span>
732:           <span class="ruby-ivar">@socket</span> = <span class="ruby-identifier">create_socket</span>(<span class="ruby-identifier">site</span>)
733:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">https?</span>(<span class="ruby-ivar">@dest</span>)
734:             <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">LoopBackSocket</span>)
735:               <span class="ruby-identifier">connect_ssl_proxy</span>(<span class="ruby-ivar">@socket</span>, <span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-ivar">@dest</span>.<span class="ruby-identifier">to_s</span>)) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@proxy</span>
736:             <span class="ruby-keyword kw">else</span>
737:               <span class="ruby-ivar">@socket</span> = <span class="ruby-identifier">create_ssl_socket</span>(<span class="ruby-ivar">@socket</span>)
738:               <span class="ruby-identifier">connect_ssl_proxy</span>(<span class="ruby-ivar">@socket</span>, <span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-ivar">@dest</span>.<span class="ruby-identifier">to_s</span>)) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@proxy</span>
739:               <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">ssl_connect</span>(<span class="ruby-ivar">@dest</span>.<span class="ruby-identifier">host</span>)
740:               <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">post_connection_check</span>(<span class="ruby-ivar">@dest</span>)
741:               <span class="ruby-ivar">@ssl_peer_cert</span> = <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">peer_cert</span>
742:             <span class="ruby-keyword kw">end</span>
743:           <span class="ruby-keyword kw">end</span>
744:           <span class="ruby-comment cmt"># Use Ruby internal buffering instead of passing data immediately</span>
745:           <span class="ruby-comment cmt"># to the underlying layer</span>
746:           <span class="ruby-comment cmt"># =&gt; we need to to call explicitly flush on the socket</span>
747:           <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">sync</span> = <span class="ruby-ivar">@socket_sync</span>
748:         <span class="ruby-keyword kw">end</span>
749:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">RetryableResponse</span>
750:         <span class="ruby-identifier">retry_number</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
751:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">retry_number</span> <span class="ruby-operator">&lt;</span> <span class="ruby-ivar">@protocol_retry_count</span>
752:           <span class="ruby-keyword kw">retry</span>
753:         <span class="ruby-keyword kw">end</span>
754:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadResponseError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;connect to the server failed with status #{@status} #{@reason}&quot;</span>)
755:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">TimeoutError</span>
756:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@connect_retry</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
757:           <span class="ruby-keyword kw">retry</span>
758:         <span class="ruby-keyword kw">else</span>
759:           <span class="ruby-identifier">retry_number</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
760:           <span class="ruby-keyword kw">retry</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">retry_number</span> <span class="ruby-operator">&lt;</span> <span class="ruby-ivar">@connect_retry</span>
761:         <span class="ruby-keyword kw">end</span>
762:         <span class="ruby-identifier">close</span>
763:         <span class="ruby-identifier">raise</span>
764:       <span class="ruby-keyword kw">end</span>
765:       <span class="ruby-ivar">@state</span> = <span class="ruby-identifier">:WAIT</span>
766:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000260">
                    
                    <a name="M000260"></a><b>connect_ssl_proxy</b>(socket, uri)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000260_source')" id="l_M000260_source">show</a>
                        
                    </p>
                    <div id="M000260_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 799</span>
799:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">connect_ssl_proxy</span>(<span class="ruby-identifier">socket</span>, <span class="ruby-identifier">uri</span>)
800:       <span class="ruby-identifier">req</span> = <span class="ruby-constant">HTTP</span><span class="ruby-operator">::</span><span class="ruby-constant">Message</span>.<span class="ruby-identifier">new_connect_request</span>(<span class="ruby-identifier">uri</span>)
801:       <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">request_filter</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">filter</span><span class="ruby-operator">|</span>
802:         <span class="ruby-identifier">filter</span>.<span class="ruby-identifier">filter_request</span>(<span class="ruby-identifier">req</span>)
803:       <span class="ruby-keyword kw">end</span>
804:       <span class="ruby-identifier">set_header</span>(<span class="ruby-identifier">req</span>)
805:       <span class="ruby-identifier">req</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-ivar">@socket</span>)
806:       <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">flush</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@socket_sync</span>
807:       <span class="ruby-identifier">res</span> = <span class="ruby-constant">HTTP</span><span class="ruby-operator">::</span><span class="ruby-constant">Message</span>.<span class="ruby-identifier">new_response</span>(<span class="ruby-value str">''</span>)
808:       <span class="ruby-identifier">parse_header</span>
809:       <span class="ruby-identifier">res</span>.<span class="ruby-identifier">http_version</span>, <span class="ruby-identifier">res</span>.<span class="ruby-identifier">status</span>, <span class="ruby-identifier">res</span>.<span class="ruby-identifier">reason</span> = <span class="ruby-ivar">@version</span>, <span class="ruby-ivar">@status</span>, <span class="ruby-ivar">@reason</span>
810:       <span class="ruby-ivar">@headers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
811:         <span class="ruby-identifier">res</span>.<span class="ruby-identifier">header</span>.<span class="ruby-identifier">set</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span>)
812:       <span class="ruby-keyword kw">end</span>
813:       <span class="ruby-identifier">commands</span> = <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">request_filter</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">filter</span><span class="ruby-operator">|</span>
814:         <span class="ruby-identifier">filter</span>.<span class="ruby-identifier">filter_response</span>(<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>)
815:       }
816:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">commands</span>.<span class="ruby-identifier">find</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">command</span><span class="ruby-operator">|</span> <span class="ruby-identifier">command</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:retry</span> }
817:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">RetryableResponse</span>.<span class="ruby-identifier">new</span>
818:       <span class="ruby-keyword kw">end</span>
819:       <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@status</span> <span class="ruby-operator">==</span> <span class="ruby-value">200</span>
820:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadResponseError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;connect to ssl proxy failed with status #{@status} #{@reason}&quot;</span>, <span class="ruby-identifier">res</span>)
821:       <span class="ruby-keyword kw">end</span>
822:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000254">
                    
                    <a name="M000254"></a><b>create_socket</b>(site)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000254_source')" id="l_M000254_source">show</a>
                        
                    </p>
                    <div id="M000254_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 768</span>
768:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_socket</span>(<span class="ruby-identifier">site</span>)
769:       <span class="ruby-identifier">socket</span> = <span class="ruby-keyword kw">nil</span>
770:       <span class="ruby-keyword kw">begin</span>
771:         <span class="ruby-ivar">@debug_dev</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;! CONNECT TO #{site.host}:#{site.port}\n&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@debug_dev</span>
772:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">str</span> = <span class="ruby-ivar">@test_loopback_http_response</span>.<span class="ruby-identifier">shift</span>
773:           <span class="ruby-identifier">socket</span> = <span class="ruby-constant">LoopBackSocket</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">site</span>.<span class="ruby-identifier">host</span>, <span class="ruby-identifier">site</span>.<span class="ruby-identifier">port</span>, <span class="ruby-identifier">str</span>)
774:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@socket_local</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Site</span><span class="ruby-operator">::</span><span class="ruby-constant">EMPTY</span>
775:           <span class="ruby-identifier">socket</span> = <span class="ruby-constant">TCPSocket</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">site</span>.<span class="ruby-identifier">host</span>, <span class="ruby-identifier">site</span>.<span class="ruby-identifier">port</span>)
776:         <span class="ruby-keyword kw">else</span>
777:           <span class="ruby-identifier">socket</span> = <span class="ruby-constant">TCPSocket</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">site</span>.<span class="ruby-identifier">host</span>, <span class="ruby-identifier">site</span>.<span class="ruby-identifier">port</span>, <span class="ruby-ivar">@socket_local</span>.<span class="ruby-identifier">host</span>, <span class="ruby-ivar">@socket_local</span>.<span class="ruby-identifier">port</span>)
778:         <span class="ruby-keyword kw">end</span>
779:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@debug_dev</span>
780:           <span class="ruby-ivar">@debug_dev</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;! CONNECTION ESTABLISHED\n&quot;</span>
781:           <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">extend</span>(<span class="ruby-constant">DebugSocket</span>)
782:           <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">debug_dev</span> = <span class="ruby-ivar">@debug_dev</span>
783:         <span class="ruby-keyword kw">end</span>
784:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SystemCallError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
785:         <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; (#{site})&quot;</span>
786:         <span class="ruby-identifier">raise</span>
787:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SocketError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
788:         <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; (#{site})&quot;</span>
789:         <span class="ruby-identifier">raise</span>
790:       <span class="ruby-keyword kw">end</span>
791:       <span class="ruby-identifier">socket</span>
792:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000259">
                    
                    <a name="M000259"></a><b>create_ssl_socket</b>(raw_socket)
                    
                </div>
                
                <div class="description">
                  <p>
wrap socket with OpenSSL.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000259_source')" id="l_M000259_source">show</a>
                        
                    </p>
                    <div id="M000259_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 795</span>
795:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_ssl_socket</span>(<span class="ruby-identifier">raw_socket</span>)
796:       <span class="ruby-constant">SSLSocketWrap</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">raw_socket</span>, <span class="ruby-ivar">@ssl_config</span>, <span class="ruby-ivar">@debug_dev</span>)
797:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000279">
                    
                    <a name="M000279"></a><b>no_message_body?</b>(status)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000279_source')" id="l_M000279_source">show</a>
                        
                    </p>
                    <div id="M000279_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 894</span>
894:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">no_message_body?</span>(<span class="ruby-identifier">status</span>)
895:       <span class="ruby-operator">!</span><span class="ruby-identifier">status</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-comment cmt"># HTTP/0.9</span>
896:         ((<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">100</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">status</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">200</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-value">204</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-value">304</span>)
897:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000272">
                    
                    <a name="M000272"></a><b>parse_header</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000272_source')" id="l_M000272_source">show</a>
                        
                    </p>
                    <div id="M000272_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 846</span>
846:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">parse_header</span>
847:       <span class="ruby-identifier">timeout</span>(<span class="ruby-ivar">@receive_timeout</span>, <span class="ruby-constant">ReceiveTimeoutError</span>) <span class="ruby-keyword kw">do</span>
848:         <span class="ruby-identifier">initial_line</span> = <span class="ruby-keyword kw">nil</span>
849:         <span class="ruby-keyword kw">begin</span>
850:           <span class="ruby-identifier">initial_line</span> = <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">gets</span>(<span class="ruby-value str">&quot;\n&quot;</span>)
851:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">initial_line</span>.<span class="ruby-identifier">nil?</span>
852:             <span class="ruby-identifier">close</span>
853:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">KeepAliveDisconnected</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">self</span>)
854:           <span class="ruby-keyword kw">end</span>
855:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNABORTED</span>, <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNRESET</span>, <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EPIPE</span>, <span class="ruby-constant">IOError</span>
856:           <span class="ruby-comment cmt"># JRuby can raise IOError instead of ECONNRESET for now</span>
857:           <span class="ruby-identifier">close</span>
858:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">KeepAliveDisconnected</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">self</span>)
859:         <span class="ruby-keyword kw">end</span>
860:         <span class="ruby-keyword kw">begin</span>
861:           <span class="ruby-keyword kw">if</span> <span class="ruby-constant">StatusParseRegexp</span> <span class="ruby-operator">!~</span> <span class="ruby-identifier">initial_line</span>
862:             <span class="ruby-ivar">@version</span> = <span class="ruby-value str">'0.9'</span>
863:             <span class="ruby-ivar">@status</span> = <span class="ruby-keyword kw">nil</span>
864:             <span class="ruby-ivar">@reason</span> = <span class="ruby-keyword kw">nil</span>
865:             <span class="ruby-ivar">@next_connection</span> = <span class="ruby-keyword kw">false</span>
866:             <span class="ruby-ivar">@content_length</span> = <span class="ruby-keyword kw">nil</span>
867:             <span class="ruby-ivar">@readbuf</span> = <span class="ruby-identifier">initial_line</span>
868:             <span class="ruby-keyword kw">break</span>
869:           <span class="ruby-keyword kw">end</span>
870:           <span class="ruby-ivar">@version</span>, <span class="ruby-ivar">@status</span>, <span class="ruby-ivar">@reason</span> = <span class="ruby-identifier">$1</span>, <span class="ruby-identifier">$2</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">$3</span>
871:           <span class="ruby-ivar">@next_connection</span> = <span class="ruby-constant">HTTP</span><span class="ruby-operator">::</span><span class="ruby-constant">Message</span>.<span class="ruby-identifier">keep_alive_enabled?</span>(<span class="ruby-ivar">@version</span>)
872:           <span class="ruby-ivar">@headers</span> = []
873:           <span class="ruby-keyword kw">while</span> <span class="ruby-keyword kw">true</span>
874:             <span class="ruby-identifier">line</span> = <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">gets</span>(<span class="ruby-value str">&quot;\n&quot;</span>)
875:             <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">line</span>
876:               <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadResponseError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'unexpected EOF'</span>)
877:             <span class="ruby-keyword kw">end</span>
878:             <span class="ruby-identifier">line</span>.<span class="ruby-identifier">chomp!</span>
879:             <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">line</span>.<span class="ruby-identifier">empty?</span>
880:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">line</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">?\ </span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">line</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">?\t</span>
881:               <span class="ruby-identifier">last</span> = <span class="ruby-ivar">@headers</span>.<span class="ruby-identifier">last</span>[<span class="ruby-value">1</span>]
882:               <span class="ruby-identifier">last</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">' '</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">last</span>.<span class="ruby-identifier">empty?</span>
883:               <span class="ruby-identifier">last</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">line</span>.<span class="ruby-identifier">strip</span>
884:             <span class="ruby-keyword kw">else</span>
885:               <span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span> = <span class="ruby-identifier">line</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp re">/\s*:\s*/</span>, <span class="ruby-value">2</span>)
886:               <span class="ruby-identifier">parse_keepalive_header</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span>)
887:               <span class="ruby-ivar">@headers</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span>]
888:             <span class="ruby-keyword kw">end</span>
889:           <span class="ruby-keyword kw">end</span>
890:         <span class="ruby-keyword kw">end</span> <span class="ruby-keyword kw">while</span> (<span class="ruby-ivar">@version</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'1.1'</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@status</span> <span class="ruby-operator">==</span> <span class="ruby-value">100</span>)
891:       <span class="ruby-keyword kw">end</span>
892:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000280">
                    
                    <a name="M000280"></a><b>parse_keepalive_header</b>(key, value)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000280_source')" id="l_M000280_source">show</a>
                        
                    </p>
                    <div id="M000280_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 899</span>
899:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">parse_keepalive_header</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span>)
900:       <span class="ruby-identifier">key</span> = <span class="ruby-identifier">key</span>.<span class="ruby-identifier">downcase</span>
901:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">key</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'content-length'</span>
902:         <span class="ruby-ivar">@content_length</span> = <span class="ruby-identifier">value</span>.<span class="ruby-identifier">to_i</span>
903:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">key</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'content-encoding'</span> <span class="ruby-keyword kw">and</span> ( <span class="ruby-identifier">value</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'gzip'</span> <span class="ruby-keyword kw">or</span>
904:                                             <span class="ruby-identifier">value</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'x-gzip'</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'deflate'</span> )
905:         <span class="ruby-ivar">@gzipped</span> = <span class="ruby-keyword kw">true</span>
906:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">key</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'transfer-encoding'</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'chunked'</span>
907:         <span class="ruby-ivar">@chunked</span> = <span class="ruby-keyword kw">true</span>
908:         <span class="ruby-ivar">@chunk_length</span> = <span class="ruby-value">0</span>
909:         <span class="ruby-ivar">@content_length</span> = <span class="ruby-keyword kw">nil</span>
910:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">key</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'connection'</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">key</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'proxy-connection'</span>
911:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'keep-alive'</span>
912:           <span class="ruby-ivar">@next_connection</span> = <span class="ruby-keyword kw">true</span>
913:         <span class="ruby-keyword kw">else</span>
914:           <span class="ruby-ivar">@next_connection</span> = <span class="ruby-keyword kw">false</span>
915:         <span class="ruby-keyword kw">end</span>
916:       <span class="ruby-keyword kw">end</span>
917:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000284">
                    
                    <a name="M000284"></a><b>read_body_chunked</b>(&amp;block)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000284_source')" id="l_M000284_source">show</a>
                        
                    </p>
                    <div id="M000284_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 944</span>
944:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_body_chunked</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
945:       <span class="ruby-identifier">buf</span> = <span class="ruby-value str">''</span>
946:       <span class="ruby-keyword kw">while</span> <span class="ruby-keyword kw">true</span>
947:         <span class="ruby-identifier">len</span> = <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">gets</span>(<span class="ruby-constant">RS</span>)
948:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">len</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-comment cmt"># EOF</span>
949:           <span class="ruby-identifier">close</span>
950:           <span class="ruby-keyword kw">return</span>
951:         <span class="ruby-keyword kw">end</span>
952:         <span class="ruby-ivar">@chunk_length</span> = <span class="ruby-identifier">len</span>.<span class="ruby-identifier">hex</span>
953:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@chunk_length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
954:           <span class="ruby-ivar">@content_length</span> = <span class="ruby-value">0</span>
955:           <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">gets</span>(<span class="ruby-constant">RS</span>)
956:           <span class="ruby-keyword kw">return</span>
957:         <span class="ruby-keyword kw">end</span>
958:         <span class="ruby-identifier">timeout</span>(<span class="ruby-ivar">@receive_timeout</span>, <span class="ruby-constant">ReceiveTimeoutError</span>) <span class="ruby-keyword kw">do</span>
959:           <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">read</span>(<span class="ruby-ivar">@chunk_length</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>, <span class="ruby-identifier">buf</span>)
960:         <span class="ruby-keyword kw">end</span>
961:         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">buf</span>.<span class="ruby-identifier">empty?</span>
962:           <span class="ruby-keyword kw">yield</span> <span class="ruby-identifier">buf</span>.<span class="ruby-identifier">slice</span>(<span class="ruby-value">0</span>, <span class="ruby-ivar">@chunk_length</span>)
963:         <span class="ruby-keyword kw">end</span>
964:       <span class="ruby-keyword kw">end</span>
965:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000283">
                    
                    <a name="M000283"></a><b>read_body_length</b>(&amp;block)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000283_source')" id="l_M000283_source">show</a>
                        
                    </p>
                    <div id="M000283_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 919</span>
919:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_body_length</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
920:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@content_length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
921:       <span class="ruby-keyword kw">while</span> <span class="ruby-keyword kw">true</span>
922:         <span class="ruby-identifier">buf</span> = <span class="ruby-value str">''</span>
923:         <span class="ruby-identifier">maxbytes</span> = <span class="ruby-ivar">@read_block_size</span>
924:         <span class="ruby-identifier">maxbytes</span> = <span class="ruby-ivar">@content_length</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">maxbytes</span> <span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@content_length</span>
925:         <span class="ruby-identifier">timeout</span>(<span class="ruby-ivar">@receive_timeout</span>, <span class="ruby-constant">ReceiveTimeoutError</span>) <span class="ruby-keyword kw">do</span>
926:           <span class="ruby-keyword kw">begin</span>
927:             <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">readpartial</span>(<span class="ruby-identifier">maxbytes</span>, <span class="ruby-identifier">buf</span>)
928:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">EOFError</span>
929:             <span class="ruby-identifier">close</span>
930:             <span class="ruby-identifier">buf</span> = <span class="ruby-keyword kw">nil</span>
931:           <span class="ruby-keyword kw">end</span>
932:         <span class="ruby-keyword kw">end</span>
933:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">buf</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">buf</span>.<span class="ruby-identifier">bytesize</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
934:           <span class="ruby-ivar">@content_length</span> <span class="ruby-operator">-=</span> <span class="ruby-identifier">buf</span>.<span class="ruby-identifier">bytesize</span>
935:           <span class="ruby-keyword kw">yield</span> <span class="ruby-identifier">buf</span>
936:         <span class="ruby-keyword kw">else</span>
937:           <span class="ruby-ivar">@content_length</span> = <span class="ruby-value">0</span>
938:         <span class="ruby-keyword kw">end</span>
939:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@content_length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
940:       <span class="ruby-keyword kw">end</span>
941:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000285">
                    
                    <a name="M000285"></a><b>read_body_rest</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000285_source')" id="l_M000285_source">show</a>
                        
                    </p>
                    <div id="M000285_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 967</span>
967:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_body_rest</span>
968:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@readbuf</span> <span class="ruby-keyword kw">and</span> <span class="ruby-ivar">@readbuf</span>.<span class="ruby-identifier">bytesize</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
969:         <span class="ruby-keyword kw">yield</span> <span class="ruby-ivar">@readbuf</span>
970:         <span class="ruby-ivar">@readbuf</span> = <span class="ruby-keyword kw">nil</span>
971:       <span class="ruby-keyword kw">end</span>
972:       <span class="ruby-keyword kw">while</span> <span class="ruby-keyword kw">true</span>
973:         <span class="ruby-identifier">buf</span> = <span class="ruby-value str">''</span>
974:         <span class="ruby-identifier">timeout</span>(<span class="ruby-ivar">@receive_timeout</span>, <span class="ruby-constant">ReceiveTimeoutError</span>) <span class="ruby-keyword kw">do</span>
975:           <span class="ruby-keyword kw">begin</span>
976:             <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">readpartial</span>(<span class="ruby-ivar">@read_block_size</span>, <span class="ruby-identifier">buf</span>)
977:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">EOFError</span>
978:             <span class="ruby-identifier">buf</span> = <span class="ruby-keyword kw">nil</span>
979:           <span class="ruby-keyword kw">end</span>
980:         <span class="ruby-keyword kw">end</span>
981:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">buf</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">buf</span>.<span class="ruby-identifier">bytesize</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
982:           <span class="ruby-keyword kw">yield</span> <span class="ruby-identifier">buf</span>
983:         <span class="ruby-keyword kw">else</span>
984:           <span class="ruby-keyword kw">return</span>
985:         <span class="ruby-keyword kw">end</span>
986:       <span class="ruby-keyword kw">end</span>
987:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000267">
                    
                    <a name="M000267"></a><b>read_header</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Read status block.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000267_source')" id="l_M000267_source">show</a>
                        
                    </p>
                    <div id="M000267_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 825</span>
825:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_header</span>
826:       <span class="ruby-ivar">@content_length</span> = <span class="ruby-keyword kw">nil</span>
827:       <span class="ruby-ivar">@chunked</span> = <span class="ruby-keyword kw">false</span>
828:       <span class="ruby-ivar">@gzipped</span> = <span class="ruby-keyword kw">false</span>
829:       <span class="ruby-ivar">@chunk_length</span> = <span class="ruby-value">0</span>
830:       <span class="ruby-identifier">parse_header</span>
831:       <span class="ruby-comment cmt"># Header of the request has been parsed.</span>
832:       <span class="ruby-ivar">@state</span> = <span class="ruby-identifier">:DATA</span>
833:       <span class="ruby-identifier">req</span> = <span class="ruby-ivar">@requests</span>.<span class="ruby-identifier">shift</span>
834:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">req</span>.<span class="ruby-identifier">header</span>.<span class="ruby-identifier">request_method</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'HEAD'</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">no_message_body?</span>(<span class="ruby-ivar">@status</span>)
835:         <span class="ruby-ivar">@content_length</span> = <span class="ruby-value">0</span>
836:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@next_connection</span>
837:           <span class="ruby-ivar">@state</span> = <span class="ruby-identifier">:WAIT</span>
838:         <span class="ruby-keyword kw">else</span>
839:           <span class="ruby-identifier">close</span>
840:         <span class="ruby-keyword kw">end</span>
841:       <span class="ruby-keyword kw">end</span>
842:       <span class="ruby-ivar">@next_connection</span> = <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@content_length</span> <span class="ruby-keyword kw">and</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@chunked</span>
843:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000251">
                    
                    <a name="M000251"></a><b>set_header</b>(req)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000251_source')" id="l_M000251_source">show</a>
                        
                    </p>
                    <div id="M000251_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/httpclient/session.rb, line 708</span>
708:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_header</span>(<span class="ruby-identifier">req</span>)
709:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@requested_version</span>
710:         <span class="ruby-keyword kw">if</span> <span class="ruby-regexp re">/^(?:HTTP\/|)(\d+.\d+)$/</span> <span class="ruby-operator">=~</span> <span class="ruby-ivar">@requested_version</span>
711:           <span class="ruby-identifier">req</span>.<span class="ruby-identifier">http_version</span> = <span class="ruby-identifier">$1</span>
712:         <span class="ruby-keyword kw">end</span>
713:       <span class="ruby-keyword kw">end</span>
714:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@agent_name</span>
715:         <span class="ruby-identifier">req</span>.<span class="ruby-identifier">header</span>.<span class="ruby-identifier">set</span>(<span class="ruby-value str">'User-Agent'</span>, <span class="ruby-node">&quot;#{@agent_name} #{LIB_NAME}&quot;</span>)
716:       <span class="ruby-keyword kw">end</span>
717:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@from</span>
718:         <span class="ruby-identifier">req</span>.<span class="ruby-identifier">header</span>.<span class="ruby-identifier">set</span>(<span class="ruby-value str">'From'</span>, <span class="ruby-ivar">@from</span>)
719:       <span class="ruby-keyword kw">end</span>
720:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@transparent_gzip_decompression</span>
721:         <span class="ruby-identifier">req</span>.<span class="ruby-identifier">header</span>.<span class="ruby-identifier">set</span>(<span class="ruby-value str">'Accept-Encoding'</span>, <span class="ruby-value str">'gzip,deflate'</span>)
722:       <span class="ruby-keyword kw">end</span>
723:       <span class="ruby-identifier">req</span>.<span class="ruby-identifier">header</span>.<span class="ruby-identifier">set</span>(<span class="ruby-value str">'Date'</span>, <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">httpdate</span>)
724:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    