<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>NewRelic::Agent::Agent::InstanceMethods</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../../../css/main.css" type="text/css" media="screen" />
    <script src="../../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Module</span> 
            NewRelic::Agent::Agent::InstanceMethods 
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../../files/lib/new_relic/agent/agent_rb.html">lib/new_relic/agent/agent.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
Holds all the methods defined on <a
href="../Agent.html">NewRelic::Agent::Agent</a> instances
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>A</dt>
        <dd>
            <ul>
                
                <li><a href="#M000029">after_fork</a></li>
                
            </ul>
        </dd>
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M000164">check_for_exception</a>,</li>
                
                <li><a href="#M000159">check_post_size</a>,</li>
                
                <li><a href="#M000066">collector</a>,</li>
                
                <li><a href="#M000157">compress_data</a>,</li>
                
                <li><a href="#M000124">connect</a>,</li>
                
                <li><a href="#M000031">connected?</a>,</li>
                
                <li><a href="#M000085">control</a></li>
                
            </ul>
        </dd>
    
        <dt>D</dt>
        <dd>
            <ul>
                
                <li><a href="#M000163">decompress_response</a>,</li>
                
                <li><a href="#M000132">determine_home_directory</a>,</li>
                
                <li><a href="#M000128">determine_host</a></li>
                
            </ul>
        </dd>
    
        <dt>E</dt>
        <dd>
            <ul>
                
                <li><a href="#M000034">end_transaction</a></li>
                
            </ul>
        </dd>
    
        <dt>F</dt>
        <dd>
            <ul>
                
                <li><a href="#M000136">fill_metric_id_cache</a></li>
                
            </ul>
        </dd>
    
        <dt>G</dt>
        <dd>
            <ul>
                
                <li><a href="#M000169">graceful_disconnect</a></li>
                
            </ul>
        </dd>
    
        <dt>H</dt>
        <dd>
            <ul>
                
                <li><a href="#M000154">harvest_and_send_errors</a>,</li>
                
                <li><a href="#M000148">harvest_and_send_slowest_sample</a>,</li>
                
                <li><a href="#M000145">harvest_and_send_slowest_sql</a>,</li>
                
                <li><a href="#M000137">harvest_and_send_timeslice_data</a>,</li>
                
                <li><a href="#M000153">harvest_errors</a>,</li>
                
                <li><a href="#M000134">harvest_timeslice_data</a>,</li>
                
                <li><a href="#M000144">harvest_transaction_traces</a></li>
                
            </ul>
        </dd>
    
        <dt>I</dt>
        <dd>
            <ul>
                
                <li><a href="#M000167">invoke_remote</a>,</li>
                
                <li><a href="#M000133">is_application_spawner?</a></li>
                
            </ul>
        </dd>
    
        <dt>L</dt>
        <dd>
            <ul>
                
                <li><a href="#M000040">log</a></li>
                
            </ul>
        </dd>
    
        <dt>M</dt>
        <dd>
            <ul>
                
                <li><a href="#M000122">merge_data_from</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M000039">pop_trace_execution_flag</a>,</li>
                
                <li><a href="#M000037">push_trace_execution_flag</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000021">record_transaction</a>,</li>
                
                <li><a href="#M000165">remote_method_uri</a>,</li>
                
                <li><a href="#M000065">reset_stats</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M000168">save_or_transmit_data</a>,</li>
                
                <li><a href="#M000162">send_request</a>,</li>
                
                <li><a href="#M000121">serialize</a>,</li>
                
                <li><a href="#M000035">set_record_sql</a>,</li>
                
                <li><a href="#M000036">set_record_tt</a>,</li>
                
                <li><a href="#M000032">shutdown</a>,</li>
                
                <li><a href="#M000064">start</a>,</li>
                
                <li><a href="#M000033">start_transaction</a>,</li>
                
                <li><a href="#M000081">start_worker_thread</a>,</li>
                
                <li><a href="#M000030">started?</a></li>
                
            </ul>
        </dd>
    
        <dt>U</dt>
        <dd>
            <ul>
                
                <li><a href="#M000013">unsent_errors_size</a>,</li>
                
                <li><a href="#M000020">unsent_timeslice_data</a>,</li>
                
                <li><a href="#M000019">unsent_traces_size</a>,</li>
                
                <li><a href="#M000166">user_agent</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    
    <div class="sectiontitle">Included Modules</div>
    <ul>
        
        <li>
            
            <a href="InstanceMethods/Start.html">NewRelic::Agent::Agent::InstanceMethods::Start</a>
            
            START:includes
        </li>
        
        <li>
            
            <a href="InstanceMethods/Start.html">NewRelic::Agent::Agent::InstanceMethods::Start</a>
            
            START:includes
        </li>
        
        <li>
            
            <a href="InstanceMethods/Start.html">NewRelic::Agent::Agent::InstanceMethods::Start</a>
            
            START:includes
        </li>
        
    </ul>
    

    

    
    <div class="sectiontitle">Classes and Modules</div>
    <ul>
        
        <li><span class="type">MODULE</span> <a href="InstanceMethods/Connect.html">NewRelic::Agent::Agent::InstanceMethods::Connect</a></li>
        
        <li><span class="type">MODULE</span> <a href="InstanceMethods/Start.html">NewRelic::Agent::Agent::InstanceMethods::Start</a></li>
        
        <li><span class="type">MODULE</span> <a href="InstanceMethods/StartWorkerThread.html">NewRelic::Agent::Agent::InstanceMethods::StartWorkerThread</a></li>
        
    </ul>
    

    

    
    <div class="sectiontitle">Attributes</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>obfuscator</td>
            <td class='attr-desc'><p>
holds a proc that is used to obfuscate sql statements
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>stats_engine</td>
            <td class='attr-desc'><p>
the statistics engine that holds all the timeslice data
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>transaction_sampler</td>
            <td class='attr-desc'><p>
the transaction sampler that handles recording transactions
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>sql_sampler</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>error_collector</td>
            <td class='attr-desc'><p>
error collector is a simple collection of recorded errors
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>record_sql</td>
            <td class='attr-desc'><p>
whether we should record raw, obfuscated, or no sql
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>metric_ids</td>
            <td class='attr-desc'><p>
a cached set of <a href="InstanceMethods.html#metric_ids">metric_ids</a> to
save the collector some time - it returns a metric id for every metric name
we send it, and in the future we transmit using the metric id only
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>url_rules</td>
            <td class='attr-desc'><p>
in theory a set of rules applied by the agent to the output of its metrics.
Currently unimplemented
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>beacon_configuration</td>
            <td class='attr-desc'><p>
a configuration for the Real User Monitoring system - handles things like
static setup of the header for inclusion into pages
</p></td>
        </tr>
        
    </table>
    

    
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000029">
                    
                    <a name="M000029"></a><b>after_fork</b>(options={})
                    
                </div>
                
                <div class="description">
                  <p>
This method should be called in a forked process after a fork. It assumes
the parent process initialized the agent, but does not assume the agent
started.
</p>
<p>
The call is idempotent, but not re-entrant.
</p>
<ul>
<li>It clears any metrics carried over from the parent process

</li>
<li>Restarts the sampler thread if necessary

</li>
<li>Initiates a new agent run and worker loop unless that was done in the
parent process and <tt>:force_reconnect</tt> is not true

</li>
</ul>
<p>
Options:
</p>
<ul>
<li><tt>:force_reconnect =&gt; true</tt> to force the spawned process to
establish a new connection, such as when forking a long running process.
The default is false&#8212;it will only connect to the server if the parent
had not connected.

</li>
<li><tt>:keep_retrying =&gt; false</tt> if we try to initiate a new connection,
this tells me to only try it once so this method returns quickly if there
is some kind of latency with the server.

</li>
</ul>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000029_source')" id="l_M000029_source">show</a>
                        
                    </p>
                    <div id="M000029_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 160</span>
160:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">after_fork</span>(<span class="ruby-identifier">options</span>={})
161: 
162:           <span class="ruby-comment cmt"># @connected gets false after we fail to connect or have an error</span>
163:           <span class="ruby-comment cmt"># connecting.  @connected has nil if we haven't finished trying to connect.</span>
164:           <span class="ruby-comment cmt"># or we didn't attempt a connection because this is the master process</span>
165: 
166:           <span class="ruby-comment cmt"># log.debug &quot;Agent received after_fork notice in #$$: [#{control.agent_enabled?}; monitor=#{control.monitor_mode?}; connected: #{@connected.inspect}; thread=#{@worker_thread.inspect}]&quot;</span>
167:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">control</span>.<span class="ruby-identifier">agent_enabled?</span> <span class="ruby-keyword kw">or</span>
168:             <span class="ruby-operator">!</span><span class="ruby-identifier">control</span>.<span class="ruby-identifier">monitor_mode?</span> <span class="ruby-keyword kw">or</span>
169:             <span class="ruby-ivar">@connected</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">or</span>
170:             <span class="ruby-ivar">@worker_thread</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@worker_thread</span>.<span class="ruby-identifier">alive?</span>
171: 
172:           <span class="ruby-identifier">log</span>.<span class="ruby-identifier">info</span> <span class="ruby-value str">&quot;Starting the worker thread in #$$ after forking.&quot;</span>
173: 
174:           <span class="ruby-comment cmt"># Clear out stats that are left over from parent process</span>
175:           <span class="ruby-identifier">reset_stats</span>
176: 
177:           <span class="ruby-comment cmt"># Don't ever check to see if this is a spawner.  If we're in a forked process</span>
178:           <span class="ruby-comment cmt"># I'm pretty sure we're not also forking new instances.</span>
179:           <span class="ruby-identifier">start_worker_thread</span>(<span class="ruby-identifier">options</span>)
180:           <span class="ruby-ivar">@stats_engine</span>.<span class="ruby-identifier">start_sampler_thread</span>
181:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000031">
                    
                    <a name="M000031"></a><b>connected?</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Return nil if not yet connected, true if successfully started and false if
we failed to start.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000031_source')" id="l_M000031_source">show</a>
                        
                    </p>
                    <div id="M000031_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 190</span>
190:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">connected?</span>
191:           <span class="ruby-ivar">@connected</span>
192:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000034">
                    
                    <a name="M000034"></a><b>end_transaction</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Tells the statistics engine we are ending a transaction
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000034_source')" id="l_M000034_source">show</a>
                        
                    </p>
                    <div id="M000034_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 235</span>
235:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">end_transaction</span>
236:           <span class="ruby-ivar">@stats_engine</span>.<span class="ruby-identifier">end_transaction</span>
237:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000040">
                    
                    <a name="M000040"></a><b>log</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Shorthand to the <a
href="../../Agent.html#M000564">NewRelic::Agent.logger</a> method
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000040_source')" id="l_M000040_source">show</a>
                        
                    </p>
                    <div id="M000040_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 277</span>
277:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">log</span>
278:           <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">logger</span>
279:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000122">
                    
                    <a name="M000122"></a><b>merge_data_from</b>(data)
                    
                </div>
                
                <div class="description">
                  <p>
Accepts data as provided by the serialize method and merges it into our
current collection of data to send. Can be dangerous if we re-merge the
same data more than once - it will be sent multiple times.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000122_source')" id="l_M000122_source">show</a>
                        
                    </p>
                    <div id="M000122_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 909</span>
909:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">merge_data_from</span>(<span class="ruby-identifier">data</span>)
910:           <span class="ruby-identifier">metrics</span>, <span class="ruby-identifier">transaction_traces</span>, <span class="ruby-identifier">errors</span> = <span class="ruby-identifier">data</span>
911:           <span class="ruby-ivar">@stats_engine</span>.<span class="ruby-identifier">merge_data</span>(<span class="ruby-identifier">metrics</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">metrics</span>
912:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">transaction_traces</span>
913:             <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@traces</span>
914:               <span class="ruby-ivar">@traces</span> = <span class="ruby-ivar">@traces</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">transaction_traces</span>
915:             <span class="ruby-keyword kw">else</span>
916:               <span class="ruby-ivar">@traces</span> = <span class="ruby-identifier">transaction_traces</span>
917:             <span class="ruby-keyword kw">end</span>
918:           <span class="ruby-keyword kw">end</span>
919:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">errors</span>
920:             <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@unsent_errors</span>
921:               <span class="ruby-ivar">@unsent_errors</span> = <span class="ruby-ivar">@unsent_errors</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">errors</span>
922:             <span class="ruby-keyword kw">else</span>
923:               <span class="ruby-ivar">@unsent_errors</span> = <span class="ruby-identifier">errors</span>
924:             <span class="ruby-keyword kw">end</span>
925:           <span class="ruby-keyword kw">end</span>
926:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000039">
                    
                    <a name="M000039"></a><b>pop_trace_execution_flag</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Pop the current trace execution status. Restore trace execution status to
what it was before we pushed the current flag.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000039_source')" id="l_M000039_source">show</a>
                        
                    </p>
                    <div id="M000039_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 272</span>
272:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pop_trace_execution_flag</span>
273:           <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_untraced</span>].<span class="ruby-identifier">pop</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_untraced</span>]
274:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000037">
                    
                    <a name="M000037"></a><b>push_trace_execution_flag</b>(should_trace=false)
                    
                </div>
                
                <div class="description">
                  <p>
Push flag indicating whether we should be tracing in this thread. This uses
a stack which allows us to disable tracing children of a transaction
without affecting the tracing of the whole transaction
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000037_source')" id="l_M000037_source">show</a>
                        
                    </p>
                    <div id="M000037_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 261</span>
261:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">push_trace_execution_flag</span>(<span class="ruby-identifier">should_trace</span>=<span class="ruby-keyword kw">false</span>)
262:           <span class="ruby-identifier">value</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_untraced</span>]
263:           <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">value</span>.<span class="ruby-identifier">nil?</span>)
264:             <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_untraced</span>] = []
265:           <span class="ruby-keyword kw">end</span>
266: 
267:           <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_untraced</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">should_trace</span>
268:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000021">
                    
                    <a name="M000021"></a><b>record_transaction</b>(duration_seconds, options={})
                    
                </div>
                
                <div class="description">
                  <p>
fakes out a transaction that did not happen in this process by creating
apdex, summary metrics, and recording statistics for the transaction
</p>
<p>
This method is <b>deprecated</b> - it may be removed in future versions of
the agent
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000021_source')" id="l_M000021_source">show</a>
                        
                    </p>
                    <div id="M000021_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 110</span>
110:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">record_transaction</span>(<span class="ruby-identifier">duration_seconds</span>, <span class="ruby-identifier">options</span>={})
111:           <span class="ruby-identifier">is_error</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value str">'is_error'</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value str">'error_message'</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value str">'exception'</span>]
112:           <span class="ruby-identifier">metric</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value str">'metric'</span>]
113:           <span class="ruby-identifier">metric</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">options</span>[<span class="ruby-value str">'uri'</span>] <span class="ruby-comment cmt"># normalize this with url rules</span>
114:           <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;metric or uri arguments required&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">metric</span>
115:           <span class="ruby-identifier">metric_info</span> = <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">MetricParser</span><span class="ruby-operator">::</span><span class="ruby-constant">MetricParser</span>.<span class="ruby-identifier">for_metric_named</span>(<span class="ruby-identifier">metric</span>)
116: 
117:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">metric_info</span>.<span class="ruby-identifier">is_web_transaction?</span>
118:             <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">Instrumentation</span><span class="ruby-operator">::</span><span class="ruby-constant">MetricFrame</span>.<span class="ruby-identifier">record_apdex</span>(<span class="ruby-identifier">metric_info</span>, <span class="ruby-identifier">duration_seconds</span>, <span class="ruby-identifier">duration_seconds</span>, <span class="ruby-identifier">is_error</span>)
119:           <span class="ruby-keyword kw">end</span>
120:           <span class="ruby-identifier">metrics</span> = <span class="ruby-identifier">metric_info</span>.<span class="ruby-identifier">summary_metrics</span>
121: 
122:           <span class="ruby-identifier">metrics</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">metric</span>
123:           <span class="ruby-identifier">metrics</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span><span class="ruby-operator">|</span>
124:             <span class="ruby-identifier">stats</span> = <span class="ruby-identifier">stats_engine</span>.<span class="ruby-identifier">get_stats_no_scope</span>(<span class="ruby-identifier">name</span>)
125:             <span class="ruby-identifier">stats</span>.<span class="ruby-identifier">record_data_point</span>(<span class="ruby-identifier">duration_seconds</span>)
126:           <span class="ruby-keyword kw">end</span>
127: 
128:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">is_error</span>
129:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value str">'exception'</span>]
130:               <span class="ruby-identifier">e</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value str">'exception'</span>]
131:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">options</span>[<span class="ruby-value str">'error_message'</span>]
132:               <span class="ruby-identifier">e</span> = <span class="ruby-constant">Exception</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">options</span>[<span class="ruby-value str">'error_message'</span>]
133:             <span class="ruby-keyword kw">else</span>
134:               <span class="ruby-identifier">e</span> = <span class="ruby-constant">Exception</span>.<span class="ruby-identifier">new</span> <span class="ruby-value str">'Unknown Error'</span>
135:             <span class="ruby-keyword kw">end</span>
136:             <span class="ruby-identifier">error_collector</span>.<span class="ruby-identifier">notice_error</span> <span class="ruby-identifier">e</span>, <span class="ruby-identifier">:uri</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">options</span>[<span class="ruby-value str">'uri'</span>], <span class="ruby-identifier">:metric</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">metric</span>
137:           <span class="ruby-keyword kw">end</span>
138:           <span class="ruby-comment cmt"># busy time ?</span>
139:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000065">
                    
                    <a name="M000065"></a><b>reset_stats</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Clear out the metric data, errors, and transaction traces, making sure the
agent is in a fresh state
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000065_source')" id="l_M000065_source">show</a>
                        
                    </p>
                    <div id="M000065_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 439</span>
439:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">reset_stats</span>
440:           <span class="ruby-ivar">@stats_engine</span>.<span class="ruby-identifier">reset_stats</span>
441:           <span class="ruby-ivar">@unsent_errors</span> = []
442:           <span class="ruby-ivar">@traces</span> = <span class="ruby-keyword kw">nil</span>
443:           <span class="ruby-ivar">@unsent_timeslice_data</span> = {}
444:           <span class="ruby-ivar">@last_harvest_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
445:           <span class="ruby-ivar">@launch_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
446:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000121">
                    
                    <a name="M000121"></a><b>serialize</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Serialize all the important data that the agent might want to send to the
server. We could be sending this to file ( common in short-running
background transactions ) or alternately we could serialize via a pipe or
socket to a local aggregation device
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000121_source')" id="l_M000121_source">show</a>
                        
                    </p>
                    <div id="M000121_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 894</span>
894:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">serialize</span>
895:           <span class="ruby-identifier">accumulator</span> = []
896:           <span class="ruby-identifier">accumulator</span>[<span class="ruby-value">1</span>] = <span class="ruby-identifier">harvest_transaction_traces</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@transaction_sampler</span>
897:           <span class="ruby-identifier">accumulator</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">harvest_errors</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@error_collector</span>
898:           <span class="ruby-identifier">accumulator</span>[<span class="ruby-value">0</span>] = <span class="ruby-identifier">harvest_timeslice_data</span>
899:           <span class="ruby-identifier">reset_stats</span>
900:           <span class="ruby-ivar">@metric_ids</span> = {}
901:           <span class="ruby-identifier">accumulator</span>
902:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000035">
                    
                    <a name="M000035"></a><b>set_record_sql</b>(should_record)
                    
                </div>
                
                <div class="description">
                  <p>
Sets a thread local variable as to whether we should or should not record
sql in the current thread. Returns the previous value, if there is one
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000035_source')" id="l_M000035_source">show</a>
                        
                    </p>
                    <div id="M000035_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 242</span>
242:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_record_sql</span>(<span class="ruby-identifier">should_record</span>)
243:           <span class="ruby-identifier">prev</span> = <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:record_sql</span>]
244:           <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:record_sql</span>] = <span class="ruby-identifier">should_record</span>
245:           <span class="ruby-identifier">prev</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">prev</span>
246:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000036">
                    
                    <a name="M000036"></a><b>set_record_tt</b>(should_record)
                    
                </div>
                
                <div class="description">
                  <p>
Sets a thread local variable as to whether we should or should not record
transaction traces in the current thread. Returns the previous value, if
there is one
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000036_source')" id="l_M000036_source">show</a>
                        
                    </p>
                    <div id="M000036_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 251</span>
251:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_record_tt</span>(<span class="ruby-identifier">should_record</span>)
252:           <span class="ruby-identifier">prev</span> = <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:record_tt</span>]
253:           <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:record_tt</span>] = <span class="ruby-identifier">should_record</span>
254:           <span class="ruby-identifier">prev</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">prev</span>
255:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000032">
                    
                    <a name="M000032"></a><b>shutdown</b>(options={})
                    
                </div>
                
                <div class="description">
                  <p>
Attempt a graceful shutdown of the agent, running the worker loop if it
exists and is running.
</p>
<p>
Options: :force_send => (true/false) # force the agent to send data before
shutting down
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000032_source')" id="l_M000032_source">show</a>
                        
                    </p>
                    <div id="M000032_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 200</span>
200:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">shutdown</span>(<span class="ruby-identifier">options</span>={})
201:           <span class="ruby-identifier">run_loop_before_exit</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-identifier">:force_send</span>, <span class="ruby-keyword kw">false</span>)
202:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">started?</span>
203:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@worker_loop</span>
204:             <span class="ruby-ivar">@worker_loop</span>.<span class="ruby-identifier">run_task</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">run_loop_before_exit</span>
205:             <span class="ruby-ivar">@worker_loop</span>.<span class="ruby-identifier">stop</span>
206: 
207:             <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-value str">&quot;Starting Agent shutdown&quot;</span>
208: 
209:             <span class="ruby-comment cmt"># if litespeed, then ignore all future SIGUSR1 - it's</span>
210:             <span class="ruby-comment cmt"># litespeed trying to shut us down</span>
211: 
212:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">control</span>.<span class="ruby-identifier">dispatcher</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:litespeed</span>
213:               <span class="ruby-constant">Signal</span>.<span class="ruby-identifier">trap</span>(<span class="ruby-value str">&quot;SIGUSR1&quot;</span>, <span class="ruby-value str">&quot;IGNORE&quot;</span>)
214:               <span class="ruby-constant">Signal</span>.<span class="ruby-identifier">trap</span>(<span class="ruby-value str">&quot;SIGTERM&quot;</span>, <span class="ruby-value str">&quot;IGNORE&quot;</span>)
215:             <span class="ruby-keyword kw">end</span>
216: 
217:             <span class="ruby-keyword kw">begin</span>
218:               <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">disable_all_tracing</span> <span class="ruby-keyword kw">do</span>
219:                 <span class="ruby-identifier">graceful_disconnect</span>
220:               <span class="ruby-keyword kw">end</span>
221:             <span class="ruby-keyword kw">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
222:               <span class="ruby-identifier">log</span>.<span class="ruby-identifier">error</span> <span class="ruby-identifier">e</span>
223:               <span class="ruby-identifier">log</span>.<span class="ruby-identifier">error</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">backtrace</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;\n&quot;</span>)
224:             <span class="ruby-keyword kw">end</span>
225:           <span class="ruby-keyword kw">end</span>
226:           <span class="ruby-ivar">@started</span> = <span class="ruby-keyword kw">nil</span>
227:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000064">
                    
                    <a name="M000064"></a><b>start</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Logs a bunch of data and starts the agent, if needed
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000064_source')" id="l_M000064_source">show</a>
                        
                    </p>
                    <div id="M000064_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 425</span>
425:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start</span>
426:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">already_started?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">disabled?</span>
427:           <span class="ruby-ivar">@started</span> = <span class="ruby-keyword kw">true</span>
428:           <span class="ruby-ivar">@local_host</span> = <span class="ruby-identifier">determine_host</span>
429:           <span class="ruby-identifier">log_dispatcher</span>
430:           <span class="ruby-identifier">log_app_names</span>
431:           <span class="ruby-identifier">config_transaction_tracer</span>
432:           <span class="ruby-identifier">check_config_and_start_agent</span>
433:           <span class="ruby-identifier">log_version_and_pid</span>
434:           <span class="ruby-identifier">notify_log_file_location</span>
435:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000033">
                    
                    <a name="M000033"></a><b>start_transaction</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Tells the statistics engine we are starting a new transaction
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000033_source')" id="l_M000033_source">show</a>
                        
                    </p>
                    <div id="M000033_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 230</span>
230:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_transaction</span>
231:           <span class="ruby-ivar">@stats_engine</span>.<span class="ruby-identifier">start_transaction</span>
232:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000030">
                    
                    <a name="M000030"></a><b>started?</b>()
                    
                </div>
                
                <div class="description">
                  <p>
True if we have initialized and completed &#8216;start&#8217;
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000030_source')" id="l_M000030_source">show</a>
                        
                    </p>
                    <div id="M000030_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 184</span>
184:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">started?</span>
185:           <span class="ruby-ivar">@started</span>
186:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000013">
                    
                    <a name="M000013"></a><b>unsent_errors_size</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Returns the length of the unsent errors array, if it exists, otherwise nil
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000013_source')" id="l_M000013_source">show</a>
                        
                    </p>
                    <div id="M000013_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 87</span>
87:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">unsent_errors_size</span>
88:           <span class="ruby-ivar">@unsent_errors</span>.<span class="ruby-identifier">length</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@unsent_errors</span>
89:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000020">
                    
                    <a name="M000020"></a><b>unsent_timeslice_data</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Initializes the unsent timeslice data hash, if needed, and returns the
number of keys it contains
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000020_source')" id="l_M000020_source">show</a>
                        
                    </p>
                    <div id="M000020_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 99</span>
 99:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">unsent_timeslice_data</span>
100:           <span class="ruby-ivar">@unsent_timeslice_data</span> <span class="ruby-operator">||=</span> {}
101:           <span class="ruby-ivar">@unsent_timeslice_data</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">length</span>
102:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000019">
                    
                    <a name="M000019"></a><b>unsent_traces_size</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Returns the length of the traces array, if it exists, otherwise nil
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000019_source')" id="l_M000019_source">show</a>
                        
                    </p>
                    <div id="M000019_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 93</span>
93:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">unsent_traces_size</span>
94:           <span class="ruby-ivar">@traces</span>.<span class="ruby-identifier">length</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@traces</span>
95:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Private methods</div>
            
            <div class="method">
                <div class="title" id="M000164">
                    
                    <a name="M000164"></a><b>check_for_exception</b>(response)
                    
                </div>
                
                <div class="description">
                  <p>
unmarshals the response and raises it if it is an exception, so we can
handle it in nonlocally
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000164_source')" id="l_M000164_source">show</a>
                        
                    </p>
                    <div id="M000164_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 1221</span>
1221:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">check_for_exception</span>(<span class="ruby-identifier">response</span>)
1222:           <span class="ruby-identifier">dump</span> = <span class="ruby-identifier">decompress_response</span>(<span class="ruby-identifier">response</span>)
1223:           <span class="ruby-identifier">value</span> = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">load</span>(<span class="ruby-identifier">dump</span>)
1224:           <span class="ruby-identifier">raise</span> <span class="ruby-identifier">value</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Exception</span>
1225:           <span class="ruby-identifier">value</span>
1226:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000159">
                    
                    <a name="M000159"></a><b>check_post_size</b>(post_string)
                    
                </div>
                
                <div class="description">
                  <p>
Raises a <a href="../PostTooBigException.html">PostTooBigException</a> if
the post_string is longer than the limit configured in the control object
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000159_source')" id="l_M000159_source">show</a>
                        
                    </p>
                    <div id="M000159_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 1158</span>
1158:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">check_post_size</span>(<span class="ruby-identifier">post_string</span>)
1159:           <span class="ruby-comment cmt"># TODO: define this as a config option on the server side</span>
1160:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">post_string</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">control</span>.<span class="ruby-identifier">post_size_limit</span>
1161:           <span class="ruby-identifier">log</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;Tried to send too much data: #{post_string.size} bytes&quot;</span>
1162:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">PostTooBigException</span>
1163:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000066">
                    
                    <a name="M000066"></a><b>collector</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000066_source')" id="l_M000066_source">show</a>
                        
                    </p>
                    <div id="M000066_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 449</span>
449:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">collector</span>
450:           <span class="ruby-ivar">@collector</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">control</span>.<span class="ruby-identifier">server</span>
451:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000157">
                    
                    <a name="M000157"></a><b>compress_data</b>(object)
                    
                </div>
                
                <div class="description">
                  <p>
This method handles the compression of the request body that we are going
to send to the server
</p>
<p>
We currently optimize for CPU here since we get roughly a 10x reduction in
message size with this, and CPU overhead is at a premium. For extra-large
posts, we use the higher compression since otherwise it actually errors
out.
</p>
<p>
We do not compress if content is smaller than 64kb. There are problems with
bugs in Ruby in some versions that expose us to a risk of segfaults if we
compress aggressively.
</p>
<p>
medium payloads get fast compression, to save CPU big payloads get all the
compression possible, to stay under the 2,000,000 byte post threshold
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000157_source')" id="l_M000157_source">show</a>
                        
                    </p>
                    <div id="M000157_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 1141</span>
1141:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">compress_data</span>(<span class="ruby-identifier">object</span>)
1142:           <span class="ruby-identifier">dump</span> = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">object</span>)
1143: 
1144:           <span class="ruby-identifier">dump_size</span> = <span class="ruby-identifier">dump</span>.<span class="ruby-identifier">size</span>
1145: 
1146:           <span class="ruby-keyword kw">return</span> [<span class="ruby-identifier">dump</span>, <span class="ruby-value str">'identity'</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">dump_size</span> <span class="ruby-operator">&lt;</span> (<span class="ruby-value">64</span><span class="ruby-operator">*</span><span class="ruby-value">1024</span>)
1147: 
1148:           <span class="ruby-identifier">compressed_dump</span> = <span class="ruby-constant">Zlib</span><span class="ruby-operator">::</span><span class="ruby-constant">Deflate</span>.<span class="ruby-identifier">deflate</span>(<span class="ruby-identifier">dump</span>, <span class="ruby-constant">Zlib</span><span class="ruby-operator">::</span><span class="ruby-constant">DEFAULT_COMPRESSION</span>)
1149: 
1150:           <span class="ruby-comment cmt"># this checks to make sure mongrel won't choke on big uploads</span>
1151:           <span class="ruby-identifier">check_post_size</span>(<span class="ruby-identifier">compressed_dump</span>)
1152: 
1153:           [<span class="ruby-identifier">compressed_dump</span>, <span class="ruby-value str">'deflate'</span>]
1154:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000124">
                    
                    <a name="M000124"></a><b>connect</b>(options)
                    
                </div>
                
                <div class="description">
                  <p>
<a href="InstanceMethods/Connect.html">Connect</a> to the server and
validate the license. If successful, @connected has true when finished. If
not successful, you can keep calling this. Return false if we could not
establish a connection with the server and we should not retry, such as if
there&#8217;s a bad license key.
</p>
<p>
Set keep_retrying=false to disable retrying and return asap, such as when
invoked in the foreground. Otherwise this runs until a successful
connection is made, or the server rejects us.
</p>
<ul>
<li><tt>:keep_retrying =&gt; false</tt> to only try to connect once, and return
with the connection set to nil. This ensures we may try again later
(default true).

</li>
<li><tt>force_reconnect =&gt; true</tt> if you want to establish a new
connection to the server before running the worker loop. This means you get
a separate agent run and New Relic sees it as a separate instance (default
is false).

</li>
</ul>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000124_source')" id="l_M000124_source">show</a>
                        
                    </p>
                    <div id="M000124_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 946</span>
946:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">connect</span>(<span class="ruby-identifier">options</span>)
947:           <span class="ruby-comment cmt"># Don't proceed if we already connected (@connected=true) or if we tried</span>
948:           <span class="ruby-comment cmt"># to connect and were rejected with prejudice because of a license issue</span>
949:           <span class="ruby-comment cmt"># (@connected=false), unless we're forced to by force_reconnect.</span>
950:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tried_to_connect?</span>(<span class="ruby-identifier">options</span>)
951: 
952:           <span class="ruby-comment cmt"># wait a few seconds for the web server to boot, necessary in development</span>
953:           <span class="ruby-ivar">@connect_retry_period</span> = <span class="ruby-identifier">should_keep_retrying?</span>(<span class="ruby-identifier">options</span>) <span class="ruby-operator">?</span> <span class="ruby-value">10</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>
954: 
955:           <span class="ruby-identifier">sleep</span> <span class="ruby-identifier">connect_retry_period</span>
956:           <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-value str">&quot;Connecting Process to New Relic: #$0&quot;</span>
957:           <span class="ruby-identifier">query_server_for_configuration</span>
958:           <span class="ruby-ivar">@connected_pid</span> = <span class="ruby-identifier">$$</span>
959:           <span class="ruby-ivar">@connected</span> = <span class="ruby-keyword kw">true</span>
960:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">LicenseException</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
961:           <span class="ruby-identifier">handle_license_error</span>(<span class="ruby-identifier">e</span>)
962:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>, <span class="ruby-constant">StandardError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
963:           <span class="ruby-identifier">log_error</span>(<span class="ruby-identifier">e</span>)
964:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">should_retry?</span>
965:             <span class="ruby-keyword kw">retry</span>
966:           <span class="ruby-keyword kw">else</span>
967:             <span class="ruby-identifier">disconnect</span>
968:           <span class="ruby-keyword kw">end</span>
969:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000085">
                    
                    <a name="M000085"></a><b>control</b>()
                    
                </div>
                
                <div class="description">
                  <p>
A shorthand for NewRelic::Control.instance
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000085_source')" id="l_M000085_source">show</a>
                        
                    </p>
                    <div id="M000085_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 589</span>
589:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">control</span>
590:           <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>
591:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000163">
                    
                    <a name="M000163"></a><b>decompress_response</b>(response)
                    
                </div>
                
                <div class="description">
                  <p>
Decompresses the response from the server, if it is gzip encoded, otherwise
returns it verbatim
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000163_source')" id="l_M000163_source">show</a>
                        
                    </p>
                    <div id="M000163_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 1209</span>
1209:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">decompress_response</span>(<span class="ruby-identifier">response</span>)
1210:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">response</span>[<span class="ruby-value str">'content-encoding'</span>] <span class="ruby-operator">!=</span> <span class="ruby-value str">'gzip'</span>
1211:             <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-value str">&quot;Uncompressed content returned&quot;</span>
1212:             <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">response</span>.<span class="ruby-identifier">body</span>
1213:           <span class="ruby-keyword kw">end</span>
1214:           <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-value str">&quot;Decompressing return value&quot;</span>
1215:           <span class="ruby-identifier">i</span> = <span class="ruby-constant">Zlib</span><span class="ruby-operator">::</span><span class="ruby-constant">GzipReader</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">StringIO</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">response</span>.<span class="ruby-identifier">body</span>))
1216:           <span class="ruby-identifier">i</span>.<span class="ruby-identifier">read</span>
1217:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000132">
                    
                    <a name="M000132"></a><b>determine_home_directory</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Delegates to the control class to determine the root directory of this
project
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000132_source')" id="l_M000132_source">show</a>
                        
                    </p>
                    <div id="M000132_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 978</span>
978:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">determine_home_directory</span>
979:           <span class="ruby-identifier">control</span>.<span class="ruby-identifier">root</span>
980:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000128">
                    
                    <a name="M000128"></a><b>determine_host</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Who am I? Well, this method can tell you your hostname.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000128_source')" id="l_M000128_source">show</a>
                        
                    </p>
                    <div id="M000128_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 972</span>
972:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">determine_host</span>
973:           <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">gethostname</span>
974:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000136">
                    
                    <a name="M000136"></a><b>fill_metric_id_cache</b>(pairs_of_specs_and_ids)
                    
                </div>
                
                <div class="description">
                  <p>
takes an array of arrays of spec and id, adds it into the metric cache so
we can save the collector some work by sending integers instead of strings
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000136_source')" id="l_M000136_source">show</a>
                        
                    </p>
                    <div id="M000136_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 1003</span>
1003:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">fill_metric_id_cache</span>(<span class="ruby-identifier">pairs_of_specs_and_ids</span>)
1004:           <span class="ruby-constant">Array</span>(<span class="ruby-identifier">pairs_of_specs_and_ids</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">metric_spec</span>, <span class="ruby-identifier">metric_id</span><span class="ruby-operator">|</span>
1005:             <span class="ruby-ivar">@metric_ids</span>[<span class="ruby-identifier">metric_spec</span>] = <span class="ruby-identifier">metric_id</span>
1006:           <span class="ruby-keyword kw">end</span>
1007:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000169">
                    
                    <a name="M000169"></a><b>graceful_disconnect</b>()
                    
                </div>
                
                <div class="description">
                  <p>
This method contacts the server to send remaining data and let the server
know that the agent is shutting down - this allows us to do things like
accurately set the end of the lifetime of the process
</p>
<p>
If this process comes from a parent process, it will not disconnect, so
that the parent process can continue to send data
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000169_source')" id="l_M000169_source">show</a>
                        
                    </p>
                    <div id="M000169_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 1300</span>
1300:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">graceful_disconnect</span>
1301:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@connected</span>
1302:             <span class="ruby-keyword kw">begin</span>
1303:               <span class="ruby-ivar">@request_timeout</span> = <span class="ruby-value">10</span>
1304:               <span class="ruby-identifier">save_or_transmit_data</span>
1305:               <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@connected_pid</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">$$</span>
1306:                 <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-value str">&quot;Sending New Relic service agent run shutdown message&quot;</span>
1307:                 <span class="ruby-identifier">invoke_remote</span> <span class="ruby-identifier">:shutdown</span>, <span class="ruby-ivar">@agent_id</span>, <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span>
1308:               <span class="ruby-keyword kw">else</span>
1309:                 <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;This agent connected from parent process #{@connected_pid}--not sending shutdown&quot;</span>
1310:               <span class="ruby-keyword kw">end</span>
1311:               <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-value str">&quot;Graceful disconnect complete&quot;</span>
1312:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>, <span class="ruby-constant">StandardError</span>
1313:             <span class="ruby-keyword kw">end</span>
1314:           <span class="ruby-keyword kw">else</span>
1315:             <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-value str">&quot;Bypassing graceful disconnect - agent not connected&quot;</span>
1316:           <span class="ruby-keyword kw">end</span>
1317:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000154">
                    
                    <a name="M000154"></a><b>harvest_and_send_errors</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Handles getting the errors from the error collector and sending them to the
server, and any error cases like trying to send very large errors - we drop
the oldest error on the floor and try again
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000154_source')" id="l_M000154_source">show</a>
                        
                    </p>
                    <div id="M000154_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 1108</span>
1108:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">harvest_and_send_errors</span>
1109:           <span class="ruby-identifier">harvest_errors</span>
1110:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@unsent_errors</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@unsent_errors</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1111:             <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Sending #{@unsent_errors.length} errors&quot;</span>
1112:             <span class="ruby-keyword kw">begin</span>
1113:               <span class="ruby-identifier">invoke_remote</span> <span class="ruby-identifier">:error_data</span>, <span class="ruby-ivar">@agent_id</span>, <span class="ruby-ivar">@unsent_errors</span>
1114:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">PostTooBigException</span>
1115:               <span class="ruby-ivar">@unsent_errors</span>.<span class="ruby-identifier">shift</span>
1116:               <span class="ruby-keyword kw">retry</span>
1117:             <span class="ruby-keyword kw">end</span>
1118:             <span class="ruby-comment cmt"># if the remote invocation fails, then we never clear</span>
1119:             <span class="ruby-comment cmt"># @unsent_errors, and therefore we can re-attempt to send on</span>
1120:             <span class="ruby-comment cmt"># the next heartbeat.  Note the error collector maxes out at</span>
1121:             <span class="ruby-comment cmt"># 20 instances to prevent leakage</span>
1122:             <span class="ruby-ivar">@unsent_errors</span> = []
1123:           <span class="ruby-keyword kw">end</span>
1124:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000148">
                    
                    <a name="M000148"></a><b>harvest_and_send_slowest_sample</b>()
                    
                </div>
                
                <div class="description">
                  <p>
This handles getting the transaction traces and then sending them across
the wire. This includes gathering SQL explanations, stripping out stack
traces, and normalizing SQL. note that we explain only the sql statements
whose segments&#8217; execution times exceed our threshold (to avoid
unnecessary overhead of running explains on fast queries.)
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000148_source')" id="l_M000148_source">show</a>
                        
                    </p>
                    <div id="M000148_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 1067</span>
1067:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">harvest_and_send_slowest_sample</span>
1068:           <span class="ruby-identifier">harvest_transaction_traces</span>
1069:           <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@traces</span>.<span class="ruby-identifier">empty?</span>
1070:             <span class="ruby-identifier">now</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
1071:             <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Sending (#{@traces.length}) transaction traces&quot;</span>
1072:             
1073:             <span class="ruby-keyword kw">begin</span>
1074:               <span class="ruby-identifier">options</span> = { <span class="ruby-identifier">:keep_backtraces</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span> }
1075:               <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:record_sql</span>] = <span class="ruby-ivar">@record_sql</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@record_sql</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:off</span>
1076:               <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@transaction_sampler</span>.<span class="ruby-identifier">explain_enabled</span>
1077:                 <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:explain_sql</span>] = <span class="ruby-ivar">@transaction_sampler</span>.<span class="ruby-identifier">explain_threshold</span>
1078:               <span class="ruby-keyword kw">end</span>
1079:               <span class="ruby-identifier">traces</span> = <span class="ruby-ivar">@traces</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">trace</span><span class="ruby-operator">|</span> <span class="ruby-identifier">trace</span>.<span class="ruby-identifier">prepare_to_send</span>(<span class="ruby-identifier">options</span>)}
1080:               <span class="ruby-identifier">invoke_remote</span> <span class="ruby-identifier">:transaction_sample_data</span>, <span class="ruby-ivar">@agent_id</span>, <span class="ruby-identifier">traces</span>
1081:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">PostTooBigException</span>
1082:               <span class="ruby-comment cmt"># we tried to send too much data, drop the first trace and</span>
1083:               <span class="ruby-comment cmt"># try again</span>
1084:               <span class="ruby-keyword kw">retry</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@traces</span>.<span class="ruby-identifier">shift</span>
1085:             <span class="ruby-keyword kw">end</span>
1086: 
1087:             <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Sent slowest sample (#{@agent_id}) in #{Time.now - now} seconds&quot;</span>
1088:           <span class="ruby-keyword kw">end</span>
1089: 
1090:           <span class="ruby-comment cmt"># if we succeed sending this sample, then we don't need to keep</span>
1091:           <span class="ruby-comment cmt"># the slowest sample around - it has been sent already and we</span>
1092:           <span class="ruby-comment cmt"># can clear the collection and move on</span>
1093:           <span class="ruby-ivar">@traces</span> = <span class="ruby-keyword kw">nil</span>
1094:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000145">
                    
                    <a name="M000145"></a><b>harvest_and_send_slowest_sql</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000145_source')" id="l_M000145_source">show</a>
                        
                    </p>
                    <div id="M000145_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 1047</span>
1047:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">harvest_and_send_slowest_sql</span>
1048:           <span class="ruby-comment cmt"># FIXME add the code to try to resend if our connection is down</span>
1049:           <span class="ruby-identifier">sql_traces</span> = <span class="ruby-ivar">@sql_sampler</span>.<span class="ruby-identifier">harvest</span>
1050:           <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">sql_traces</span>.<span class="ruby-identifier">empty?</span>
1051:             <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Sending (#{sql_traces.size}) sql traces&quot;</span>
1052:             <span class="ruby-keyword kw">begin</span>
1053:               <span class="ruby-identifier">response</span> = <span class="ruby-identifier">invoke_remote</span> <span class="ruby-identifier">:sql_trace_data</span>, <span class="ruby-identifier">sql_traces</span>
1054: <span class="ruby-comment cmt">#              log.debug &quot;Sql trace response: #{response}&quot;</span>
1055:             <span class="ruby-keyword kw">rescue</span>
1056:               <span class="ruby-ivar">@sql_sampler</span>.<span class="ruby-identifier">merge</span> <span class="ruby-identifier">sql_traces</span> 
1057:             <span class="ruby-keyword kw">end</span>
1058:           <span class="ruby-keyword kw">end</span>
1059:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000137">
                    
                    <a name="M000137"></a><b>harvest_and_send_timeslice_data</b>()
                    
                </div>
                
                <div class="description">
                  <p>
note - exceptions are logged in invoke_remote. If an exception is
encountered here, then the metric data is downsampled for another
transmission later
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000137_source')" id="l_M000137_source">show</a>
                        
                    </p>
                    <div id="M000137_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 1012</span>
1012:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">harvest_and_send_timeslice_data</span>
1013:           <span class="ruby-identifier">now</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
1014:           <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">stats_engine</span>.<span class="ruby-identifier">get_stats_no_scope</span>(<span class="ruby-value str">'Supportability/invoke_remote'</span>).<span class="ruby-identifier">record_data_point</span>(<span class="ruby-value">0</span><span class="ruby-value">.0</span>)
1015:           <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">stats_engine</span>.<span class="ruby-identifier">get_stats_no_scope</span>(<span class="ruby-value str">'Supportability/invoke_remote/metric_data'</span>).<span class="ruby-identifier">record_data_point</span>(<span class="ruby-value">0</span><span class="ruby-value">.0</span>)
1016:           <span class="ruby-identifier">harvest_timeslice_data</span>(<span class="ruby-identifier">now</span>)
1017:           <span class="ruby-keyword kw">begin</span>
1018:             <span class="ruby-comment cmt"># In this version of the protocol, we get back an assoc array of spec to id.</span>
1019:             <span class="ruby-identifier">metric_specs_and_ids</span> = <span class="ruby-identifier">invoke_remote</span>(<span class="ruby-identifier">:metric_data</span>, <span class="ruby-ivar">@agent_id</span>,
1020:                                                  <span class="ruby-ivar">@last_harvest_time</span>.<span class="ruby-identifier">to_f</span>,
1021:                                                  <span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span>,
1022:                                                  <span class="ruby-ivar">@unsent_timeslice_data</span>.<span class="ruby-identifier">values</span>)
1023: 
1024:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>
1025:             <span class="ruby-comment cmt"># assume that the data was received. chances are that it</span>
1026:             <span class="ruby-comment cmt"># was. Also, lol.</span>
1027:             <span class="ruby-identifier">metric_specs_and_ids</span> = []
1028:           <span class="ruby-keyword kw">end</span>
1029: 
1030:           <span class="ruby-identifier">fill_metric_id_cache</span>(<span class="ruby-identifier">metric_specs_and_ids</span>)
1031: 
1032:           <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;#{now}: sent #{@unsent_timeslice_data.length} timeslices (#{@agent_id}) in #{Time.now - now} seconds&quot;</span>
1033: 
1034:           <span class="ruby-comment cmt"># if we successfully invoked this web service, then clear the unsent message cache.</span>
1035:           <span class="ruby-ivar">@unsent_timeslice_data</span> = {}
1036:           <span class="ruby-ivar">@last_harvest_time</span> = <span class="ruby-identifier">now</span>
1037:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000153">
                    
                    <a name="M000153"></a><b>harvest_errors</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Gets the collection of unsent errors from the error collector. We pass back
in an existing array of errors that may be left over from a previous send
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000153_source')" id="l_M000153_source">show</a>
                        
                    </p>
                    <div id="M000153_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 1099</span>
1099:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">harvest_errors</span>
1100:           <span class="ruby-ivar">@unsent_errors</span> = <span class="ruby-ivar">@error_collector</span>.<span class="ruby-identifier">harvest_errors</span>(<span class="ruby-ivar">@unsent_errors</span>)
1101:           <span class="ruby-ivar">@unsent_errors</span>
1102:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000134">
                    
                    <a name="M000134"></a><b>harvest_timeslice_data</b>(time=Time.now)
                    
                </div>
                
                <div class="description">
                  <p>
calls the busy harvester and collects timeslice data to send later
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000134_source')" id="l_M000134_source">show</a>
                        
                    </p>
                    <div id="M000134_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 991</span>
991:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">harvest_timeslice_data</span>(<span class="ruby-identifier">time</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>)
992:           <span class="ruby-comment cmt"># this creates timeslices that are harvested below</span>
993:           <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">BusyCalculator</span>.<span class="ruby-identifier">harvest_busy</span>
994: 
995:           <span class="ruby-ivar">@unsent_timeslice_data</span> <span class="ruby-operator">||=</span> {}
996:           <span class="ruby-ivar">@unsent_timeslice_data</span> = <span class="ruby-ivar">@stats_engine</span>.<span class="ruby-identifier">harvest_timeslice_data</span>(<span class="ruby-ivar">@unsent_timeslice_data</span>, <span class="ruby-ivar">@metric_ids</span>)
997:           <span class="ruby-ivar">@unsent_timeslice_data</span>
998:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000144">
                    
                    <a name="M000144"></a><b>harvest_transaction_traces</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Fills the traces array with the harvested transactions from the transaction
sampler, subject to the setting for slowest transaction threshold
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000144_source')" id="l_M000144_source">show</a>
                        
                    </p>
                    <div id="M000144_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 1042</span>
1042:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">harvest_transaction_traces</span>
1043:           <span class="ruby-ivar">@traces</span> = <span class="ruby-ivar">@transaction_sampler</span>.<span class="ruby-identifier">harvest</span>(<span class="ruby-ivar">@traces</span>, <span class="ruby-ivar">@slowest_transaction_threshold</span>)
1044:           <span class="ruby-ivar">@traces</span>
1045:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000167">
                    
                    <a name="M000167"></a><b>invoke_remote</b>(method, *args)
                    
                </div>
                
                <div class="description">
                  <p>
send a message via post to the actual server. This attempts to
automatically compress the data via zlib if it is large enough to be worth
compressing, and handles any errors the server may return
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000167_source')" id="l_M000167_source">show</a>
                        
                    </p>
                    <div id="M000167_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 1252</span>
1252:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">invoke_remote</span>(<span class="ruby-identifier">method</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
1253:           <span class="ruby-identifier">now</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
1254:           <span class="ruby-comment cmt">#determines whether to zip the data or send plain</span>
1255:           <span class="ruby-identifier">post_data</span>, <span class="ruby-identifier">encoding</span> = <span class="ruby-identifier">compress_data</span>(<span class="ruby-identifier">args</span>)
1256: 
1257:           <span class="ruby-identifier">response</span> = <span class="ruby-identifier">send_request</span>({<span class="ruby-identifier">:uri</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">remote_method_uri</span>(<span class="ruby-identifier">method</span>), <span class="ruby-identifier">:encoding</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">encoding</span>, <span class="ruby-identifier">:collector</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">collector</span>, <span class="ruby-identifier">:data</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">post_data</span>})
1258: 
1259:           <span class="ruby-comment cmt"># raises the right exception if the remote server tells it to die</span>
1260:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">check_for_exception</span>(<span class="ruby-identifier">response</span>)
1261:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">ForceRestartException</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
1262:           <span class="ruby-identifier">log</span>.<span class="ruby-identifier">info</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>
1263:           <span class="ruby-identifier">raise</span>
1264:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SystemCallError</span>, <span class="ruby-constant">SocketError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
1265:           <span class="ruby-comment cmt"># These include Errno connection errors</span>
1266:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">ServerConnectionException</span>, <span class="ruby-node">&quot;Recoverable error connecting to the server: #{e}&quot;</span>
1267:         <span class="ruby-keyword kw">ensure</span>
1268:           <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">stats_engine</span>.<span class="ruby-identifier">get_stats_no_scope</span>(<span class="ruby-value str">'Supportability/invoke_remote'</span>).<span class="ruby-identifier">record_data_point</span>((<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">now</span>).<span class="ruby-identifier">to_f</span>)
1269:           <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">stats_engine</span>.<span class="ruby-identifier">get_stats_no_scope</span>(<span class="ruby-value str">'Supportability/invoke_remote/'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">method</span>.<span class="ruby-identifier">to_s</span>).<span class="ruby-identifier">record_data_point</span>((<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">now</span>).<span class="ruby-identifier">to_f</span>)
1270:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000133">
                    
                    <a name="M000133"></a><b>is_application_spawner?</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Checks whether this process is a Passenger or Unicorn spawning server - if
so, we probably don&#8217;t intend to report statistics from this process
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000133_source')" id="l_M000133_source">show</a>
                        
                    </p>
                    <div id="M000133_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 985</span>
985:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">is_application_spawner?</span>
986:           <span class="ruby-identifier">$0</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/ApplicationSpawner|^unicorn\S* master/</span>
987:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000165">
                    
                    <a name="M000165"></a><b>remote_method_uri</b>(method)
                    
                </div>
                
                <div class="description">
                  <p>
The path on the server that we should post our data to
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000165_source')" id="l_M000165_source">show</a>
                        
                    </p>
                    <div id="M000165_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 1229</span>
1229:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">remote_method_uri</span>(<span class="ruby-identifier">method</span>)
1230:           <span class="ruby-identifier">uri</span> = <span class="ruby-node">&quot;/agent_listener/#{PROTOCOL_VERSION}/#{control.license_key}/#{method}&quot;</span>
1231:           <span class="ruby-identifier">uri</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;?run_id=#{@agent_id}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@agent_id</span>
1232:           <span class="ruby-identifier">uri</span>
1233:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000168">
                    
                    <a name="M000168"></a><b>save_or_transmit_data</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000168_source')" id="l_M000168_source">show</a>
                        
                    </p>
                    <div id="M000168_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 1272</span>
1272:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">save_or_transmit_data</span>
1273:           <span class="ruby-keyword kw">if</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">DataSerialization</span>.<span class="ruby-identifier">should_send_data?</span>
1274:             <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-value str">&quot;Sending data to New Relic Service&quot;</span>
1275:             <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">load_data</span>
1276:             <span class="ruby-identifier">harvest_and_send_errors</span>
1277:             <span class="ruby-identifier">harvest_and_send_slowest_sample</span>
1278:             <span class="ruby-identifier">harvest_and_send_slowest_sql</span>
1279:             <span class="ruby-identifier">harvest_and_send_timeslice_data</span>
1280:           <span class="ruby-keyword kw">else</span>
1281:             <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-value str">&quot;Serializing agent data to disk&quot;</span>
1282:             <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">save_data</span>
1283:           <span class="ruby-keyword kw">end</span>
1284:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
1285:           <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">disable_serialization</span> = <span class="ruby-keyword kw">true</span>
1286:           <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">log</span>.<span class="ruby-identifier">warn</span>(<span class="ruby-node">&quot;Disabling serialization: #{e.message}&quot;</span>)
1287:           <span class="ruby-identifier">retry_count</span> <span class="ruby-operator">||=</span> <span class="ruby-value">0</span>
1288:           <span class="ruby-identifier">retry_count</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
1289:           <span class="ruby-keyword kw">retry</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">retry_count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
1290:           <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span>
1291:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000162">
                    
                    <a name="M000162"></a><b>send_request</b>(opts)
                    
                </div>
                
                <div class="description">
                  <p>
Posts to the specified server
</p>
<p>
Options:
</p>
<pre>
 - :uri =&gt; the path to request on the server (a misnomer of
             course)
 - :encoding =&gt; the encoding to pass to the server
 - :collector =&gt; a URI object that responds to the 'name' method
                   and returns the name of the collector to
                   contact
 - :data =&gt; the data to send as the body of the request
</pre>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000162_source')" id="l_M000162_source">show</a>
                        
                    </p>
                    <div id="M000162_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 1175</span>
1175:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">send_request</span>(<span class="ruby-identifier">opts</span>)
1176:           <span class="ruby-identifier">request</span> = <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span><span class="ruby-operator">::</span><span class="ruby-constant">Post</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:uri</span>], <span class="ruby-value str">'CONTENT-ENCODING'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:encoding</span>], <span class="ruby-value str">'HOST'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:collector</span>].<span class="ruby-identifier">name</span>)
1177:           <span class="ruby-identifier">request</span>[<span class="ruby-value str">'user-agent'</span>] = <span class="ruby-identifier">user_agent</span>
1178:           <span class="ruby-identifier">request</span>.<span class="ruby-identifier">content_type</span> = <span class="ruby-value str">&quot;application/octet-stream&quot;</span>
1179:           <span class="ruby-identifier">request</span>.<span class="ruby-identifier">body</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:data</span>]
1180: 
1181:           <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Connect to #{opts[:collector]}#{opts[:uri]}&quot;</span>
1182: 
1183:           <span class="ruby-identifier">response</span> = <span class="ruby-keyword kw">nil</span>
1184:           <span class="ruby-identifier">http</span> = <span class="ruby-identifier">control</span>.<span class="ruby-identifier">http_connection</span>(<span class="ruby-identifier">collector</span>)
1185:           <span class="ruby-identifier">http</span>.<span class="ruby-identifier">read_timeout</span> = <span class="ruby-keyword kw">nil</span>
1186:           <span class="ruby-keyword kw">begin</span>
1187:             <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">TimerLib</span>.<span class="ruby-identifier">timeout</span>(<span class="ruby-ivar">@request_timeout</span>) <span class="ruby-keyword kw">do</span>
1188:               <span class="ruby-identifier">response</span> = <span class="ruby-identifier">http</span>.<span class="ruby-identifier">request</span>(<span class="ruby-identifier">request</span>)
1189:             <span class="ruby-keyword kw">end</span>
1190:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>
1191:             <span class="ruby-identifier">log</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;Timed out trying to post data to New Relic (timeout = #{@request_timeout} seconds)&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@request_timeout</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">30</span>
1192:             <span class="ruby-identifier">raise</span>
1193:           <span class="ruby-keyword kw">end</span>
1194:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">response</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTPServiceUnavailable</span>
1195:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">ServerConnectionException</span>, <span class="ruby-node">&quot;Service unavailable (#{response.code}): #{response.message}&quot;</span>
1196:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">response</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTPGatewayTimeOut</span>
1197:             <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;Timed out getting response: #{response.message}&quot;</span>)
1198:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>, <span class="ruby-identifier">response</span>.<span class="ruby-identifier">message</span>
1199:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">response</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTPRequestEntityTooLarge</span>
1200:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">PostTooBigException</span>
1201:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">response</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTPSuccess</span>)
1202:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">ServerConnectionException</span>, <span class="ruby-node">&quot;Unexpected response from server (#{response.code}): #{response.message}&quot;</span>
1203:           <span class="ruby-keyword kw">end</span>
1204:           <span class="ruby-identifier">response</span>
1205:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000081">
                    
                    <a name="M000081"></a><b>start_worker_thread</b>(connection_options = {})
                    
                </div>
                
                <div class="description">
                  <p>
Try to launch the worker thread and connect to the server.
</p>
<p>
See <a href="InstanceMethods.html#M000124">connect</a> for a description of
connection_options.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000081_source')" id="l_M000081_source">show</a>
                        
                    </p>
                    <div id="M000081_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 580</span>
580:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_worker_thread</span>(<span class="ruby-identifier">connection_options</span> = {})
581:           <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-value str">&quot;Creating Ruby Agent worker thread.&quot;</span>
582:           <span class="ruby-ivar">@worker_thread</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword kw">do</span>
583:             <span class="ruby-identifier">deferred_work!</span>(<span class="ruby-identifier">connection_options</span>)
584:           <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># thread new</span>
585:           <span class="ruby-ivar">@worker_thread</span>[<span class="ruby-value str">'newrelic_label'</span>] = <span class="ruby-value str">'Worker Loop'</span>
586:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000166">
                    
                    <a name="M000166"></a><b>user_agent</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Sets the user agent for connections to the server, to conform with the HTTP
spec and allow for debugging. Includes the ruby version and also zlib
version if available since that may cause corrupt compression if there is a
problem.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000166_source')" id="l_M000166_source">show</a>
                        
                    </p>
                    <div id="M000166_source" class="dyn-source">
                        <pre>      <span class="ruby-comment cmt"># File lib/new_relic/agent/agent.rb, line 1239</span>
1239:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">user_agent</span>
1240:           <span class="ruby-identifier">ruby_description</span> = <span class="ruby-value str">''</span>
1241:           <span class="ruby-comment cmt"># note the trailing space!</span>
1242:           <span class="ruby-identifier">ruby_description</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;(ruby #{::RUBY_VERSION} #{::RUBY_PLATFORM}) &quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">defined?</span>(<span class="ruby-operator">::</span><span class="ruby-constant">RUBY_VERSION</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword kw">defined?</span>(<span class="ruby-operator">::</span><span class="ruby-constant">RUBY_PLATFORM</span>)
1243:           <span class="ruby-identifier">zlib_version</span> = <span class="ruby-value str">''</span>
1244:           <span class="ruby-identifier">zlib_version</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;zlib/#{Zlib.zlib_version}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">defined?</span>(<span class="ruby-operator">::</span><span class="ruby-constant">Zlib</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">Zlib</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:zlib_version</span>)
1245:           <span class="ruby-node">&quot;NewRelic-RubyAgent/#{NewRelic::VERSION::STRING} #{ruby_description}#{zlib_version}&quot;</span>
1246:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    