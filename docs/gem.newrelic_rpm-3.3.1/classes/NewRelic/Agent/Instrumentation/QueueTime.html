<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>NewRelic::Agent::Instrumentation::QueueTime</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../../../css/main.css" type="text/css" media="screen" />
    <script src="../../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Module</span> 
            NewRelic::Agent::Instrumentation::QueueTime 
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../../files/lib/new_relic/agent/instrumentation/queue_time_rb.html">lib/new_relic/agent/instrumentation/queue_time.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>A</dt>
        <dd>
            <ul>
                
                <li><a href="#M000293">add_end_time_header</a></li>
                
            </ul>
        </dd>
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M000269">check_for_alternate_queue_length</a>,</li>
                
                <li><a href="#M000270">check_for_heroku_queue_length</a>,</li>
                
                <li><a href="#M000296">convert_from_microseconds</a>,</li>
                
                <li><a href="#M000295">convert_to_microseconds</a>,</li>
                
                <li><a href="#M000275">convert_to_name_time_pair</a></li>
                
            </ul>
        </dd>
    
        <dt>F</dt>
        <dd>
            <ul>
                
                <li><a href="#M000289">find_oldest_time</a></li>
                
            </ul>
        </dd>
    
        <dt>G</dt>
        <dd>
            <ul>
                
                <li><a href="#M000274">get_matches</a>,</li>
                
                <li><a href="#M000273">get_matches_from_header</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M000294">parse_end_time</a>,</li>
                
                <li><a href="#M000265">parse_frontend_headers</a>,</li>
                
                <li><a href="#M000267">parse_middleware_time_from</a>,</li>
                
                <li><a href="#M000268">parse_queue_time_from</a>,</li>
                
                <li><a href="#M000266">parse_server_time_from</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000282">record_individual_middleware_stats</a>,</li>
                
                <li><a href="#M000281">record_individual_server_stats</a>,</li>
                
                <li><a href="#M000276">record_individual_stat_of_type</a>,</li>
                
                <li><a href="#M000291">record_middleware_time_for</a>,</li>
                
                <li><a href="#M000286">record_rollup_middleware_stat</a>,</li>
                
                <li><a href="#M000287">record_rollup_queue_stat</a>,</li>
                
                <li><a href="#M000285">record_rollup_server_stat</a>,</li>
                
                <li><a href="#M000288">record_rollup_stat_of_type</a>,</li>
                
                <li><a href="#M000290">record_server_time_for</a>,</li>
                
                <li><a href="#M000292">record_time_stat</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    

    
    <div class="sectiontitle">Constants</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class="attr-name">MAIN_HEADER</td>
            <td>=</td>
            <td class="attr-value">'HTTP_X_REQUEST_START'</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">MIDDLEWARE_HEADER</td>
            <td>=</td>
            <td class="attr-value">'HTTP_X_MIDDLEWARE_START'</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">QUEUE_HEADER</td>
            <td>=</td>
            <td class="attr-value">'HTTP_X_QUEUE_START'</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">ALT_QUEUE_HEADER</td>
            <td>=</td>
            <td class="attr-value">'HTTP_X_QUEUE_TIME'</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">HEROKU_QUEUE_HEADER</td>
            <td>=</td>
            <td class="attr-value">'HTTP_X_HEROKU_QUEUE_WAIT_TIME'</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">APP_HEADER</td>
            <td>=</td>
            <td class="attr-value">'HTTP_X_APPLICATION_START'</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">HEADER_REGEX</td>
            <td>=</td>
            <td class="attr-value">/([^\s\/,(t=)]+)? ?t=([0-9]+)/</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">SERVER_METRIC</td>
            <td>=</td>
            <td class="attr-value">'WebFrontend/WebServer/'</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">MIDDLEWARE_METRIC</td>
            <td>=</td>
            <td class="attr-value">'Middleware/'</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">ALL_SERVER_METRIC</td>
            <td>=</td>
            <td class="attr-value">'WebFrontend/WebServer/all'</td>
        </tr>
        
        <tr valign='top'>
            <td>&nbsp;</td>
            <td colspan="2" class="attr-desc"><p>
no individual queue metric - more than one queue?!
</p>
</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">ALL_MIDDLEWARE_METRIC</td>
            <td>=</td>
            <td class="attr-value">'Middleware/all'</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">ALL_QUEUE_METRIC</td>
            <td>=</td>
            <td class="attr-value">'WebFrontend/QueueTime'</td>
        </tr>
        
        
    </table>
    

    

    
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000265">
                    
                    <a name="M000265"></a><b>parse_frontend_headers</b>(headers)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000265_source')" id="l_M000265_source">show</a>
                        
                    </p>
                    <div id="M000265_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 22</span>
22:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">parse_frontend_headers</span>(<span class="ruby-identifier">headers</span>)
23:           <span class="ruby-comment cmt"># these methods add internal state, so we dup so other parts</span>
24:           <span class="ruby-comment cmt"># of the app don't have to worry about it.</span>
25:           <span class="ruby-comment cmt"># May have performance implications with very large env hashes</span>
26:           <span class="ruby-identifier">env</span> = <span class="ruby-identifier">headers</span>.<span class="ruby-identifier">dup</span>
27:           <span class="ruby-identifier">add_end_time_header</span>(<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>, <span class="ruby-identifier">env</span>)
28:           <span class="ruby-identifier">middleware_start</span> = <span class="ruby-identifier">parse_middleware_time_from</span>(<span class="ruby-identifier">env</span>)
29:           <span class="ruby-identifier">queue_start</span> = <span class="ruby-identifier">parse_queue_time_from</span>(<span class="ruby-identifier">env</span>)
30:           <span class="ruby-identifier">server_start</span> = <span class="ruby-identifier">parse_server_time_from</span>(<span class="ruby-identifier">env</span>)
31:           <span class="ruby-comment cmt"># returned for the controller instrumentation</span>
32:           [<span class="ruby-identifier">middleware_start</span>, <span class="ruby-identifier">queue_start</span>, <span class="ruby-identifier">server_start</span>].<span class="ruby-identifier">min</span>
33:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Private methods</div>
            
            <div class="method">
                <div class="title" id="M000293">
                    
                    <a name="M000293"></a><b>add_end_time_header</b>(end_time, env)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000293_source')" id="l_M000293_source">show</a>
                        
                    </p>
                    <div id="M000293_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 181</span>
181:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_end_time_header</span>(<span class="ruby-identifier">end_time</span>, <span class="ruby-identifier">env</span>) <span class="ruby-comment cmt"># (Time, Env) -&gt; nil</span>
182:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">end_time</span>
183:           <span class="ruby-identifier">env</span>[<span class="ruby-constant">APP_HEADER</span>] = <span class="ruby-node">&quot;t=#{convert_to_microseconds(end_time)}&quot;</span>
184:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000269">
                    
                    <a name="M000269"></a><b>check_for_alternate_queue_length</b>(env)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000269_source')" id="l_M000269_source">show</a>
                        
                    </p>
                    <div id="M000269_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 79</span>
79:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">check_for_alternate_queue_length</span>(<span class="ruby-identifier">env</span>)
80:           <span class="ruby-identifier">heroku_length</span> = <span class="ruby-identifier">check_for_heroku_queue_length</span>(<span class="ruby-identifier">env</span>)
81:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">heroku_length</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">heroku_length</span>
82:           <span class="ruby-identifier">header</span> = <span class="ruby-identifier">env</span>[<span class="ruby-constant">ALT_QUEUE_HEADER</span>]
83:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">header</span>
84:           (<span class="ruby-identifier">header</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">'t='</span>, <span class="ruby-value str">''</span>).<span class="ruby-identifier">to_i</span> <span class="ruby-operator">/</span> <span class="ruby-value">1_000_000.0</span>)
85:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000270">
                    
                    <a name="M000270"></a><b>check_for_heroku_queue_length</b>(env)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000270_source')" id="l_M000270_source">show</a>
                        
                    </p>
                    <div id="M000270_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 87</span>
87:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">check_for_heroku_queue_length</span>(<span class="ruby-identifier">env</span>)
88:           <span class="ruby-identifier">header</span> = <span class="ruby-identifier">env</span>[<span class="ruby-constant">HEROKU_QUEUE_HEADER</span>]
89:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">header</span>
90:           (<span class="ruby-identifier">header</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/[^0-9]/</span>, <span class="ruby-value str">''</span>).<span class="ruby-identifier">to_i</span> <span class="ruby-operator">/</span> <span class="ruby-value">1_000.0</span>)
91:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000296">
                    
                    <a name="M000296"></a><b>convert_from_microseconds</b>(int)
                    
                </div>
                
                <div class="description">
                  <p>
convert a time from the header value (time in microseconds) into a ruby
time object
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000296_source')" id="l_M000296_source">show</a>
                        
                    </p>
                    <div id="M000296_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 201</span>
201:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">convert_from_microseconds</span>(<span class="ruby-identifier">int</span>) <span class="ruby-comment cmt"># Int -&gt; Time</span>
202:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">TypeError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'Cannot convert a non-number into a time'</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">int</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Time</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">int</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Numeric</span>)
203:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">int</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">int</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Time</span>)
204:           <span class="ruby-constant">Time</span>.<span class="ruby-identifier">at</span>((<span class="ruby-identifier">int</span> <span class="ruby-operator">/</span> <span class="ruby-value">1_000_000.0</span>))
205:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000295">
                    
                    <a name="M000295"></a><b>convert_to_microseconds</b>(time)
                    
                </div>
                
                <div class="description">
                  <p>
convert a time to the value provided by the header, for convenience
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000295_source')" id="l_M000295_source">show</a>
                        
                    </p>
                    <div id="M000295_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 193</span>
193:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">convert_to_microseconds</span>(<span class="ruby-identifier">time</span>) <span class="ruby-comment cmt"># Time -&gt; Int</span>
194:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">TypeError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'Cannot convert a non-time into microseconds'</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">time</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Time</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">time</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Numeric</span>)
195:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">time</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">time</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Numeric</span>)
196:           (<span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">*</span> <span class="ruby-value">1_000_000</span>).<span class="ruby-identifier">to_i</span>
197:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000275">
                    
                    <a name="M000275"></a><b>convert_to_name_time_pair</b>(name, time)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000275_source')" id="l_M000275_source">show</a>
                        
                    </p>
                    <div id="M000275_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 104</span>
104:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">convert_to_name_time_pair</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">time</span>)
105:           [<span class="ruby-identifier">name</span>, <span class="ruby-identifier">convert_from_microseconds</span>(<span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_i</span>)]
106:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000289">
                    
                    <a name="M000289"></a><b>find_oldest_time</b>(matches)
                    
                </div>
                
                <div class="description">
                  <p>
searches for the first server to touch a request
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000289_source')" id="l_M000289_source">show</a>
                        
                    </p>
                    <div id="M000289_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 155</span>
155:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">find_oldest_time</span>(<span class="ruby-identifier">matches</span>) <span class="ruby-comment cmt"># [[String, Time]] -&gt; Time</span>
156:           <span class="ruby-identifier">matches</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">time</span><span class="ruby-operator">|</span>
157:             <span class="ruby-identifier">time</span>
158:           <span class="ruby-keyword kw">end</span>.<span class="ruby-identifier">min</span>
159:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000274">
                    
                    <a name="M000274"></a><b>get_matches</b>(string)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000274_source')" id="l_M000274_source">show</a>
                        
                    </p>
                    <div id="M000274_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 100</span>
100:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_matches</span>(<span class="ruby-identifier">string</span>)
101:           <span class="ruby-identifier">string</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-constant">HEADER_REGEX</span>)
102:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000273">
                    
                    <a name="M000273"></a><b>get_matches_from_header</b>(header, env)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000273_source')" id="l_M000273_source">show</a>
                        
                    </p>
                    <div id="M000273_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 93</span>
93:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_matches_from_header</span>(<span class="ruby-identifier">header</span>, <span class="ruby-identifier">env</span>)
94:           <span class="ruby-keyword kw">return</span> [] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">env</span>.<span class="ruby-identifier">nil?</span>
95:           <span class="ruby-identifier">get_matches</span>(<span class="ruby-identifier">env</span>[<span class="ruby-identifier">header</span>]).<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">time</span><span class="ruby-operator">|</span>
96:             <span class="ruby-identifier">convert_to_name_time_pair</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">time</span>)
97:           <span class="ruby-keyword kw">end</span>
98:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000294">
                    
                    <a name="M000294"></a><b>parse_end_time</b>(env)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000294_source')" id="l_M000294_source">show</a>
                        
                    </p>
                    <div id="M000294_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 186</span>
186:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">parse_end_time</span>(<span class="ruby-identifier">env</span>)
187:           <span class="ruby-identifier">header</span> = <span class="ruby-identifier">env</span>[<span class="ruby-constant">APP_HEADER</span>]
188:           <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">header</span>
189:           <span class="ruby-identifier">convert_from_microseconds</span>(<span class="ruby-identifier">header</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-value str">'t='</span>, <span class="ruby-value str">''</span>).<span class="ruby-identifier">to_i</span>)
190:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000267">
                    
                    <a name="M000267"></a><b>parse_middleware_time_from</b>(env)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000267_source')" id="l_M000267_source">show</a>
                        
                    </p>
                    <div id="M000267_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 47</span>
47:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">parse_middleware_time_from</span>(<span class="ruby-identifier">env</span>)
48:           <span class="ruby-identifier">end_time</span> = <span class="ruby-identifier">parse_end_time</span>(<span class="ruby-identifier">env</span>)
49:           <span class="ruby-identifier">matches</span> = <span class="ruby-identifier">get_matches_from_header</span>(<span class="ruby-constant">MIDDLEWARE_HEADER</span>, <span class="ruby-identifier">env</span>)
50: 
51:           <span class="ruby-identifier">record_individual_middleware_stats</span>(<span class="ruby-identifier">end_time</span>, <span class="ruby-identifier">matches</span>)
52:           <span class="ruby-identifier">oldest_time</span> = <span class="ruby-identifier">record_rollup_middleware_stat</span>(<span class="ruby-identifier">end_time</span>, <span class="ruby-identifier">matches</span>)
53:           <span class="ruby-comment cmt"># notice this bit: we reset the end time to the earliest</span>
54:           <span class="ruby-comment cmt"># middleware tag so that other frontend metrics don't</span>
55:           <span class="ruby-comment cmt"># include this time.</span>
56:           <span class="ruby-identifier">add_end_time_header</span>(<span class="ruby-identifier">oldest_time</span>, <span class="ruby-identifier">env</span>)
57:           <span class="ruby-identifier">oldest_time</span>
58:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000268">
                    
                    <a name="M000268"></a><b>parse_queue_time_from</b>(env)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000268_source')" id="l_M000268_source">show</a>
                        
                    </p>
                    <div id="M000268_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 60</span>
60:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">parse_queue_time_from</span>(<span class="ruby-identifier">env</span>)
61:           <span class="ruby-identifier">oldest_time</span> = <span class="ruby-keyword kw">nil</span>
62:           <span class="ruby-identifier">end_time</span> = <span class="ruby-identifier">parse_end_time</span>(<span class="ruby-identifier">env</span>)
63:           <span class="ruby-identifier">alternate_length</span> = <span class="ruby-identifier">check_for_alternate_queue_length</span>(<span class="ruby-identifier">env</span>)
64:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">alternate_length</span>
65:             <span class="ruby-comment cmt"># skip all that fancy-dan stuff</span>
66:             <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">get_stats</span>(<span class="ruby-constant">ALL_QUEUE_METRIC</span>).<span class="ruby-identifier">trace_call</span>(<span class="ruby-identifier">alternate_length</span>)
67:             <span class="ruby-identifier">oldest_time</span> = (<span class="ruby-identifier">end_time</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">alternate_length</span>) <span class="ruby-comment cmt"># should be a time</span>
68:           <span class="ruby-keyword kw">else</span>
69:             <span class="ruby-identifier">matches</span> = <span class="ruby-identifier">get_matches_from_header</span>(<span class="ruby-constant">QUEUE_HEADER</span>, <span class="ruby-identifier">env</span>)
70:             <span class="ruby-identifier">oldest_time</span> = <span class="ruby-identifier">record_rollup_queue_stat</span>(<span class="ruby-identifier">end_time</span>, <span class="ruby-identifier">matches</span>)
71:           <span class="ruby-keyword kw">end</span>
72:           <span class="ruby-comment cmt"># notice this bit: we reset the end time to the earliest</span>
73:           <span class="ruby-comment cmt"># queue tag or the start time minus the queue time so that</span>
74:           <span class="ruby-comment cmt"># other frontend metrics don't include this time.</span>
75:           <span class="ruby-identifier">add_end_time_header</span>(<span class="ruby-identifier">oldest_time</span>, <span class="ruby-identifier">env</span>)
76:           <span class="ruby-identifier">oldest_time</span>
77:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000266">
                    
                    <a name="M000266"></a><b>parse_server_time_from</b>(env)
                    
                </div>
                
                <div class="description">
                  <p>
main method to extract server time info from env hash, records individual
server metrics and one roll-up for all servers
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000266_source')" id="l_M000266_source">show</a>
                        
                    </p>
                    <div id="M000266_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 39</span>
39:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">parse_server_time_from</span>(<span class="ruby-identifier">env</span>)
40:           <span class="ruby-identifier">end_time</span> = <span class="ruby-identifier">parse_end_time</span>(<span class="ruby-identifier">env</span>)
41:           <span class="ruby-identifier">matches</span> = <span class="ruby-identifier">get_matches_from_header</span>(<span class="ruby-constant">MAIN_HEADER</span>, <span class="ruby-identifier">env</span>)
42: 
43:           <span class="ruby-identifier">record_individual_server_stats</span>(<span class="ruby-identifier">end_time</span>, <span class="ruby-identifier">matches</span>)
44:           <span class="ruby-identifier">record_rollup_server_stat</span>(<span class="ruby-identifier">end_time</span>, <span class="ruby-identifier">matches</span>)
45:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000282">
                    
                    <a name="M000282"></a><b>record_individual_middleware_stats</b>(end_time, matches)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000282_source')" id="l_M000282_source">show</a>
                        
                    </p>
                    <div id="M000282_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 131</span>
131:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">record_individual_middleware_stats</span>(<span class="ruby-identifier">end_time</span>, <span class="ruby-identifier">matches</span>)
132:           <span class="ruby-identifier">record_individual_stat_of_type</span>(<span class="ruby-identifier">:record_middleware_time_for</span>, <span class="ruby-identifier">end_time</span>, <span class="ruby-identifier">matches</span>)
133:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000281">
                    
                    <a name="M000281"></a><b>record_individual_server_stats</b>(end_time, matches)
                    
                </div>
                
                <div class="description">
                  <p>
goes through the list of servers and records each one in reverse order,
subtracting the time for each successive server from the earlier ones in
the list. an example because it&#8217;s complicated: start data:
[[&#8216;a&#8217;, Time.at(1000)], [&#8216;b&#8217;, Time.at(1001)]], start
time: Time.at(1002) initial run: Time.at(1002), [&#8216;b&#8217;,
Time.at(1001)] next: Time.at(1001), [&#8216;a&#8217;, Time.at(1000)] see
tests for more
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000281_source')" id="l_M000281_source">show</a>
                        
                    </p>
                    <div id="M000281_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 127</span>
127:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">record_individual_server_stats</span>(<span class="ruby-identifier">end_time</span>, <span class="ruby-identifier">matches</span>) <span class="ruby-comment cmt"># (Time, [[String, Time]]) -&gt; nil</span>
128:           <span class="ruby-identifier">record_individual_stat_of_type</span>(<span class="ruby-identifier">:record_server_time_for</span>, <span class="ruby-identifier">end_time</span>, <span class="ruby-identifier">matches</span>)
129:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000276">
                    
                    <a name="M000276"></a><b>record_individual_stat_of_type</b>(type, end_time, matches)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000276_source')" id="l_M000276_source">show</a>
                        
                    </p>
                    <div id="M000276_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 108</span>
108:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">record_individual_stat_of_type</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">end_time</span>, <span class="ruby-identifier">matches</span>)
109:           <span class="ruby-identifier">matches</span> = <span class="ruby-identifier">matches</span>.<span class="ruby-identifier">sort_by</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">time</span><span class="ruby-operator">|</span> <span class="ruby-identifier">time</span> }
110:           <span class="ruby-identifier">matches</span>.<span class="ruby-identifier">reverse!</span>
111:           <span class="ruby-identifier">matches</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-identifier">end_time</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">end_time</span>, <span class="ruby-identifier">pair</span><span class="ruby-operator">|</span>
112:             <span class="ruby-identifier">name</span>, <span class="ruby-identifier">time</span> = <span class="ruby-identifier">pair</span>
113:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">time</span>, <span class="ruby-identifier">end_time</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">name</span>
114:             <span class="ruby-identifier">time</span>
115:           }
116:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000291">
                    
                    <a name="M000291"></a><b>record_middleware_time_for</b>(name, start_time, end_time)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000291_source')" id="l_M000291_source">show</a>
                        
                    </p>
                    <div id="M000291_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 166</span>
166:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">record_middleware_time_for</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">start_time</span>, <span class="ruby-identifier">end_time</span>)
167:           <span class="ruby-identifier">record_time_stat</span>(<span class="ruby-constant">MIDDLEWARE_METRIC</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">name</span>, <span class="ruby-identifier">start_time</span>, <span class="ruby-identifier">end_time</span>)
168:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000286">
                    
                    <a name="M000286"></a><b>record_rollup_middleware_stat</b>(end_time, matches)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000286_source')" id="l_M000286_source">show</a>
                        
                    </p>
                    <div id="M000286_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 140</span>
140:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">record_rollup_middleware_stat</span>(<span class="ruby-identifier">end_time</span>, <span class="ruby-identifier">matches</span>)
141:           <span class="ruby-identifier">record_rollup_stat_of_type</span>(<span class="ruby-constant">ALL_MIDDLEWARE_METRIC</span>, <span class="ruby-identifier">end_time</span>, <span class="ruby-identifier">matches</span>)
142:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000287">
                    
                    <a name="M000287"></a><b>record_rollup_queue_stat</b>(end_time, matches)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000287_source')" id="l_M000287_source">show</a>
                        
                    </p>
                    <div id="M000287_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 144</span>
144:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">record_rollup_queue_stat</span>(<span class="ruby-identifier">end_time</span>, <span class="ruby-identifier">matches</span>)
145:           <span class="ruby-identifier">record_rollup_stat_of_type</span>(<span class="ruby-constant">ALL_QUEUE_METRIC</span>, <span class="ruby-identifier">end_time</span>, <span class="ruby-identifier">matches</span>)
146:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000285">
                    
                    <a name="M000285"></a><b>record_rollup_server_stat</b>(end_time, matches)
                    
                </div>
                
                <div class="description">
                  <p>
records the total time for all servers in a rollup metric
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000285_source')" id="l_M000285_source">show</a>
                        
                    </p>
                    <div id="M000285_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 136</span>
136:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">record_rollup_server_stat</span>(<span class="ruby-identifier">end_time</span>, <span class="ruby-identifier">matches</span>) <span class="ruby-comment cmt"># (Time, [String, Time]) -&gt; nil</span>
137:           <span class="ruby-identifier">record_rollup_stat_of_type</span>(<span class="ruby-constant">ALL_SERVER_METRIC</span>, <span class="ruby-identifier">end_time</span>, <span class="ruby-identifier">matches</span>)
138:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000288">
                    
                    <a name="M000288"></a><b>record_rollup_stat_of_type</b>(metric, end_time, matches)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000288_source')" id="l_M000288_source">show</a>
                        
                    </p>
                    <div id="M000288_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 148</span>
148:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">record_rollup_stat_of_type</span>(<span class="ruby-identifier">metric</span>, <span class="ruby-identifier">end_time</span>, <span class="ruby-identifier">matches</span>)
149:           <span class="ruby-identifier">oldest_time</span> = <span class="ruby-identifier">find_oldest_time</span>(<span class="ruby-identifier">matches</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">end_time</span>
150:           <span class="ruby-identifier">record_time_stat</span>(<span class="ruby-identifier">metric</span>, <span class="ruby-identifier">oldest_time</span>, <span class="ruby-identifier">end_time</span>)
151:           <span class="ruby-identifier">oldest_time</span>
152:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000290">
                    
                    <a name="M000290"></a><b>record_server_time_for</b>(name, start_time, end_time)
                    
                </div>
                
                <div class="description">
                  <p>
basically just assembles the metric name
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000290_source')" id="l_M000290_source">show</a>
                        
                    </p>
                    <div id="M000290_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 162</span>
162:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">record_server_time_for</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">start_time</span>, <span class="ruby-identifier">end_time</span>) <span class="ruby-comment cmt"># (Maybe String, Time, Time) -&gt; nil</span>
163:           <span class="ruby-identifier">record_time_stat</span>(<span class="ruby-constant">SERVER_METRIC</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">name</span>, <span class="ruby-identifier">start_time</span>, <span class="ruby-identifier">end_time</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">name</span>
164:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000292">
                    
                    <a name="M000292"></a><b>record_time_stat</b>(name, start_time, end_time)
                    
                </div>
                
                <div class="description">
                  <p>
Checks that the time is not negative, and does the actual data recording
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000292_source')" id="l_M000292_source">show</a>
                        
                    </p>
                    <div id="M000292_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/queue_time.rb, line 172</span>
172:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">record_time_stat</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">start_time</span>, <span class="ruby-identifier">end_time</span>) <span class="ruby-comment cmt"># (String, Time, Time) -&gt; nil</span>
173:           <span class="ruby-identifier">total_time</span> = <span class="ruby-identifier">end_time</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">start_time</span>
174:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">total_time</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>
175:             <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;should not provide an end time less than start time: #{end_time} is less than #{start_time}&quot;</span>
176:           <span class="ruby-keyword kw">else</span>
177:             <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">get_stats</span>(<span class="ruby-identifier">name</span>).<span class="ruby-identifier">trace_call</span>(<span class="ruby-identifier">total_time</span>)
178:           <span class="ruby-keyword kw">end</span>
179:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    