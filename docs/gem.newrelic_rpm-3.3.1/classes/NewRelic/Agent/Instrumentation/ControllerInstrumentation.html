<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>NewRelic::Agent::Instrumentation::ControllerInstrumentation</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../../../css/main.css" type="text/css" media="screen" />
    <script src="../../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Module</span> 
            NewRelic::Agent::Instrumentation::ControllerInstrumentation 
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../../files/lib/new_relic/agent/instrumentation/controller_instrumentation_rb.html">lib/new_relic/agent/instrumentation/controller_instrumentation.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <h2>NewRelic instrumentation for controller actions and tasks</h2>
<p>
This instrumentation is applied to the action controller to collect metrics
for every web request.
</p>
<p>
It can also be used to capture performance information for background tasks
and other non-web transactions, including detailed transaction traces and
traced errors.
</p>
<p>
For details on how to instrument background tasks see <a
href="ControllerInstrumentation/ClassMethods.html#M000184">ClassMethods#add_transaction_tracer</a>
and <a
href="ControllerInstrumentation.html#M000188">perform_action_with_newrelic_trace</a>
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>#</dt>
        <dd>
            <ul>
                
                <li><a href="#M000197">_convert_args_to_path</a>,</li>
                
                <li><a href="#M000202">_detect_upstream_wait</a>,</li>
                
                <li><a href="#M000204">_dispatch_stat</a>,</li>
                
                <li><a href="#M000199">_is_filtered?</a>,</li>
                
                <li><a href="#M000200">_record_queue_length</a></li>
                
            </ul>
        </dd>
    
        <dt>D</dt>
        <dd>
            <ul>
                
                <li><a href="#M000192">do_not_trace?</a></li>
                
            </ul>
        </dd>
    
        <dt>I</dt>
        <dd>
            <ul>
                
                <li><a href="#M000193">ignore_apdex?</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M000189">newrelic_request</a>,</li>
                
                <li><a href="#M000191">newrelic_request_headers</a>,</li>
                
                <li><a href="#M000190">newrelic_response_code</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M000194">perform_action_with_newrelic_profile</a>,</li>
                
                <li><a href="#M000188">perform_action_with_newrelic_trace</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    
    <div class="sectiontitle">Included Modules</div>
    <ul>
        
        <li>
            
            <a href="../BrowserMonitoring.html">NewRelic::Agent::BrowserMonitoring</a>
            
            START:includes
        </li>
        
    </ul>
    

    

    
    <div class="sectiontitle">Classes and Modules</div>
    <ul>
        
        <li><span class="type">MODULE</span> <a href="ControllerInstrumentation/ClassMethods.html">NewRelic::Agent::Instrumentation::ControllerInstrumentation::ClassMethods</a></li>
        
        <li><span class="type">MODULE</span> <a href="ControllerInstrumentation/ClassMethodsShim.html">NewRelic::Agent::Instrumentation::ControllerInstrumentation::ClassMethodsShim</a></li>
        
        <li><span class="type">MODULE</span> <a href="ControllerInstrumentation/Shim.html">NewRelic::Agent::Instrumentation::ControllerInstrumentation::Shim</a></li>
        
    </ul>
    

    

    

    
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000188">
                    
                    <a name="M000188"></a><b>perform_action_with_newrelic_trace</b>(*args, &amp;block)
                    
                </div>
                
                <div class="description">
                  <p>
Yield to the given block with NewRelic tracing. Used by default
instrumentation on controller actions in Rails and Merb. But it can also be
used in custom instrumentation of controller methods and background tasks.
</p>
<p>
This is the method invoked by instrumentation added by the <tt><a
href="ControllerInstrumentation/ClassMethods.html#M000184">ClassMethods#add_transaction_tracer</a></tt>.
</p>
<p>
Here&#8217;s a more verbose version of the example shown in <tt><a
href="ControllerInstrumentation/ClassMethods.html#M000184">ClassMethods#add_transaction_tracer</a></tt>
using this method instead of add_transaction_tracer.
</p>
<p>
Below is a controller with an <tt>invoke_operation</tt> action which
dispatches to more specific operation methods based on a parameter (very
dangerous, btw!). With this instrumentation, the <tt>invoke_operation</tt>
action is ignored but the operation methods show up in New Relic as if they
were first class controller actions
</p>
<pre>
  MyController &lt; ActionController::Base
    include NewRelic::Agent::Instrumentation::ControllerInstrumentation
    # dispatch the given op to the method given by the service parameter.
    def invoke_operation
      op = params['operation']
      perform_action_with_newrelic_trace(:name =&gt; op) do
        send op, params['message']
      end
    end
    # Ignore the invoker to avoid double counting
    newrelic_ignore :only =&gt; 'invoke_operation'
  end
</pre>
<p>
When invoking this method explicitly as in the example above, pass in a
block to measure with some combination of options:
</p>
<ul>
<li><tt>:category =&gt; :controller</tt> indicates that this is a controller
action and will appear with all the other actions. This is the default.

</li>
<li><tt>:category =&gt; :task</tt> indicates that this is a background task and
will show up in New Relic with other background tasks instead of in the
controllers list

</li>
<li><tt>:category =&gt; :rack</tt> if you are instrumenting a rack middleware
call. The <tt>:name</tt> is optional, useful if you have more than one
potential transaction in the call.

</li>
<li><tt>:category =&gt; :uri</tt> indicates that this is a web transaction
whose name is a normalized URI, where &#8216;normalized&#8217; means the
URI does not have any elements with data in them such as in many REST URIs.

</li>
<li><tt>:name =&gt; action_name</tt> is used to specify the action name used as
part of the metric name

</li>
<li><tt>:params =&gt; {...}</tt> to provide information about the context of
the call, used in transaction trace display, for example: <tt>:params =&gt;
{ :account =&gt; @account.name, :file =&gt; file.name }</tt> These are
treated similarly to request parameters in web transactions.

</li>
</ul>
<p>
Seldomly used options:
</p>
<ul>
<li><tt>:force =&gt; true</tt> indicates you should capture all metrics even if
the newrelic_ignore directive was specified

</li>
<li><tt>:class_name =&gt; aClass.name</tt> is used to override the name of the
class when used inside the metric name. Default is the current class.

</li>
<li><tt>:path =&gt; metric_path</tt> is <b>deprecated</b> in the public API. It
allows you to set the entire metric after the category part. Overrides all
the other options.

</li>
<li><tt>:request =&gt; Rack::Request#new(env)</tt> is used to pass in a request
object that may respond to uri and referer.

</li>
</ul>
<p>
If a single argument is passed in, it is treated as a metric path. This
form is deprecated.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000188_source')" id="l_M000188_source">show</a>
                        
                    </p>
                    <div id="M000188_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/controller_instrumentation.rb, line 234</span>
234:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">perform_action_with_newrelic_trace</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
235:           <span class="ruby-identifier">request</span> = <span class="ruby-identifier">newrelic_request</span>(<span class="ruby-identifier">args</span>)
236:           <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">TransactionInfo</span>.<span class="ruby-identifier">reset</span>(<span class="ruby-identifier">request</span>)
237: 
238:           <span class="ruby-comment cmt"># Skip instrumentation based on the value of 'do_not_trace' and if</span>
239:           <span class="ruby-comment cmt"># we aren't calling directly with a block.</span>
240:           <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">block_given?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">do_not_trace?</span>
241:             <span class="ruby-comment cmt"># Also ignore all instrumentation in the call sequence</span>
242:             <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">disable_all_tracing</span> <span class="ruby-keyword kw">do</span>
243:               <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">perform_action_without_newrelic_trace</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
244:             <span class="ruby-keyword kw">end</span>
245:           <span class="ruby-keyword kw">end</span>
246: 
247:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">perform_action_with_newrelic_profile</span>(<span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">profiling?</span>
248: 
249:           <span class="ruby-identifier">frame_data</span> = <span class="ruby-identifier">_push_metric_frame</span>(<span class="ruby-identifier">block_given?</span> <span class="ruby-value">? </span><span class="ruby-identifier">args</span> <span class="ruby-operator">:</span> [])
250:           <span class="ruby-keyword kw">begin</span>
251:             <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">trace_execution_scoped</span> <span class="ruby-identifier">frame_data</span>.<span class="ruby-identifier">recorded_metrics</span>, <span class="ruby-identifier">:force</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">frame_data</span>.<span class="ruby-identifier">force_flag</span> <span class="ruby-keyword kw">do</span>
252:               <span class="ruby-identifier">frame_data</span>.<span class="ruby-identifier">start_transaction</span>
253:               <span class="ruby-keyword kw">begin</span>
254:                 <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">BusyCalculator</span>.<span class="ruby-identifier">dispatcher_start</span> <span class="ruby-identifier">frame_data</span>.<span class="ruby-identifier">start</span>
255:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">block_given?</span>
256:                   <span class="ruby-keyword kw">yield</span>
257:                 <span class="ruby-keyword kw">else</span>
258:                   <span class="ruby-identifier">perform_action_without_newrelic_trace</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
259:                 <span class="ruby-keyword kw">end</span>
260:               <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
261:                 <span class="ruby-identifier">frame_data</span>.<span class="ruby-identifier">notice_error</span>(<span class="ruby-identifier">e</span>)
262:                 <span class="ruby-identifier">raise</span>
263:               <span class="ruby-keyword kw">end</span>
264:             <span class="ruby-keyword kw">end</span>
265:           <span class="ruby-keyword kw">ensure</span>
266:             <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">BusyCalculator</span>.<span class="ruby-identifier">dispatcher_finish</span>
267:             <span class="ruby-comment cmt"># Look for a metric frame in the thread local and process it.</span>
268:             <span class="ruby-comment cmt"># Clear the thread local when finished to ensure it only gets called once.</span>
269:             <span class="ruby-identifier">frame_data</span>.<span class="ruby-identifier">record_apdex</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">ignore_apdex?</span>
270: 
271:             <span class="ruby-identifier">frame_data</span>.<span class="ruby-identifier">pop</span>
272:           <span class="ruby-keyword kw">end</span>
273:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Protected methods</div>
            
            <div class="method">
                <div class="title" id="M000192">
                    
                    <a name="M000192"></a><b>do_not_trace?</b>()
                    
                </div>
                
                <div class="description">
                  <p>
overrideable method to determine whether to trace an action or not - you
may override this in your controller and supply your own logic for ignoring
transactions.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000192_source')" id="l_M000192_source">show</a>
                        
                    </p>
                    <div id="M000192_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/controller_instrumentation.rb, line 302</span>
302:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">do_not_trace?</span>
303:           <span class="ruby-identifier">_is_filtered?</span>(<span class="ruby-value str">'do_not_trace'</span>)
304:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000193">
                    
                    <a name="M000193"></a><b>ignore_apdex?</b>()
                    
                </div>
                
                <div class="description">
                  <p>
overrideable method to determine whether to trace an action for purposes of
apdex measurement - you can use this to ignore things like api calls or
other fast non-user-facing actions
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000193_source')" id="l_M000193_source">show</a>
                        
                    </p>
                    <div id="M000193_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/controller_instrumentation.rb, line 310</span>
310:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ignore_apdex?</span>
311:           <span class="ruby-identifier">_is_filtered?</span>(<span class="ruby-value str">'ignore_apdex'</span>)
312:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000189">
                    
                    <a name="M000189"></a><b>newrelic_request</b>(args)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000189_source')" id="l_M000189_source">show</a>
                        
                    </p>
                    <div id="M000189_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/controller_instrumentation.rb, line 277</span>
277:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">newrelic_request</span>(<span class="ruby-identifier">args</span>)
278:           <span class="ruby-identifier">opts</span> = <span class="ruby-identifier">args</span>.<span class="ruby-identifier">first</span>
279:           <span class="ruby-comment cmt"># passed as a parameter to add_transaction_tracer</span>
280:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:keys</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:[]</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:request</span>]
281:             <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:request</span>]
282:           <span class="ruby-comment cmt"># in a Rack app</span>
283:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:keys</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:[]</span>) <span class="ruby-operator">&amp;&amp;</span>
284:               <span class="ruby-identifier">opts</span>[<span class="ruby-value str">'rack.version'</span>]
285:             <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Request</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">args</span>)
286:           <span class="ruby-comment cmt"># in a Rails app</span>
287:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:request</span>)
288:             <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">request</span>
289:           <span class="ruby-keyword kw">end</span>
290:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000191">
                    
                    <a name="M000191"></a><b>newrelic_request_headers</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000191_source')" id="l_M000191_source">show</a>
                        
                    </p>
                    <div id="M000191_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/controller_instrumentation.rb, line 295</span>
295:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">newrelic_request_headers</span>
296:           <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:request</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:headers</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">headers</span>
297:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000190">
                    
                    <a name="M000190"></a><b>newrelic_response_code</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Should be implemented in the dispatcher class
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000190_source')" id="l_M000190_source">show</a>
                        
                    </p>
                    <div id="M000190_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/controller_instrumentation.rb, line 293</span>
293:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">newrelic_response_code</span>; <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Private methods</div>
            
            <div class="method">
                <div class="title" id="M000197">
                    
                    <a name="M000197"></a><b>_convert_args_to_path</b>(args)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000197_source')" id="l_M000197_source">show</a>
                        
                    </p>
                    <div id="M000197_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/controller_instrumentation.rb, line 369</span>
369:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">_convert_args_to_path</span>(<span class="ruby-identifier">args</span>)
370:           <span class="ruby-identifier">options</span> =  <span class="ruby-identifier">args</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">pop</span> <span class="ruby-operator">:</span> {}
371:           <span class="ruby-identifier">params</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:params</span>] <span class="ruby-operator">||</span> {}
372:           <span class="ruby-identifier">category</span> = <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:category</span>]
373:                      <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:controller</span>, <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">then</span> <span class="ruby-value str">'Controller'</span>
374:                      <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:task</span> <span class="ruby-keyword kw">then</span> <span class="ruby-value str">'OtherTransaction/Background'</span> <span class="ruby-comment cmt"># 'Task'</span>
375:                      <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:rack</span> <span class="ruby-keyword kw">then</span> <span class="ruby-value str">'Controller/Rack'</span> <span class="ruby-comment cmt">#'WebTransaction/Rack'</span>
376:                      <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:uri</span> <span class="ruby-keyword kw">then</span> <span class="ruby-value str">'Controller'</span> <span class="ruby-comment cmt">#'WebTransaction/Uri'</span>
377:                      <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:sinatra</span> <span class="ruby-keyword kw">then</span> <span class="ruby-value str">'Controller/Sinatra'</span> <span class="ruby-comment cmt">#'WebTransaction/Uri'</span>
378:                        <span class="ruby-comment cmt"># for internal use only</span>
379:                      <span class="ruby-keyword kw">else</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:category</span>].<span class="ruby-identifier">to_s</span>
380:                      <span class="ruby-keyword kw">end</span>
381:           <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">path</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:path</span>]
382:             <span class="ruby-identifier">action</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:name</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">first</span>
383:             <span class="ruby-identifier">metric_class</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:class_name</span>] <span class="ruby-operator">||</span> (<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Class</span>) <span class="ruby-operator">?</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">:</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span>)
384:             <span class="ruby-identifier">path</span> = <span class="ruby-identifier">metric_class</span>
385:             <span class="ruby-identifier">path</span> <span class="ruby-operator">+=</span> (<span class="ruby-value str">'/'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">action</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">action</span>
386:           <span class="ruby-keyword kw">end</span>
387:           [<span class="ruby-identifier">category</span>, <span class="ruby-identifier">path</span>, <span class="ruby-identifier">params</span>]
388:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000202">
                    
                    <a name="M000202"></a><b>_detect_upstream_wait</b>(now)
                    
                </div>
                
                <div class="description">
                  <p>
Return a Time instance representing the upstream start time. now is a Time
instance to fall back on if no other candidate for the start time is found.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000202_source')" id="l_M000202_source">show</a>
                        
                    </p>
                    <div id="M000202_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/controller_instrumentation.rb, line 423</span>
423:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">_detect_upstream_wait</span>(<span class="ruby-identifier">now</span>)
424:           <span class="ruby-identifier">queue_start</span> = <span class="ruby-keyword kw">nil</span>
425:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">newrelic_request_headers</span>
426:             <span class="ruby-identifier">queue_start</span> = <span class="ruby-identifier">parse_frontend_headers</span>(<span class="ruby-identifier">newrelic_request_headers</span>)
427:           <span class="ruby-keyword kw">end</span>
428:           <span class="ruby-identifier">queue_start</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">now</span>
429:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
430:           <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">log</span>.<span class="ruby-identifier">error</span>(<span class="ruby-node">&quot;Error detecting upstream wait time: #{e}&quot;</span>)
431:           <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;#{e.backtrace[0..20]}&quot;</span>)
432:           <span class="ruby-identifier">now</span>
433:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000204">
                    
                    <a name="M000204"></a><b>_dispatch_stat</b>()
                    
                </div>
                
                <div class="description">
                  <p>
returns the <a
href="../../MethodTraceStats.html">NewRelic::MethodTraceStats</a> object
associated with the dispatcher time measurement
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000204_source')" id="l_M000204_source">show</a>
                        
                    </p>
                    <div id="M000204_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/controller_instrumentation.rb, line 437</span>
437:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">_dispatch_stat</span>
438:           <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">agent</span>.<span class="ruby-identifier">stats_engine</span>.<span class="ruby-identifier">get_stats_no_scope</span> <span class="ruby-value str">'HttpDispatcher'</span>
439:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000199">
                    
                    <a name="M000199"></a><b>_is_filtered?</b>(key)
                    
                </div>
                
                <div class="description">
                  <p>
Filter out a request if it matches one of our parameters for ignoring it -
the key is either &#8216;do_not_trace&#8217; or &#8216;ignore_apdex&#8216;
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000199_source')" id="l_M000199_source">show</a>
                        
                    </p>
                    <div id="M000199_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/controller_instrumentation.rb, line 392</span>
392:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">_is_filtered?</span>(<span class="ruby-identifier">key</span>)
393:           <span class="ruby-identifier">ignore_actions</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">newrelic_read_attr</span>(<span class="ruby-identifier">key</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-identifier">:newrelic_read_attr</span>
394:           <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">ignore_actions</span>
395:           <span class="ruby-keyword kw">when</span> <span class="ruby-keyword kw">nil</span>; <span class="ruby-keyword kw">false</span>
396:           <span class="ruby-keyword kw">when</span> <span class="ruby-constant">Hash</span>
397:             <span class="ruby-identifier">only_actions</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">ignore_actions</span>[<span class="ruby-identifier">:only</span>])
398:             <span class="ruby-identifier">except_actions</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">ignore_actions</span>[<span class="ruby-identifier">:except</span>])
399:             <span class="ruby-identifier">only_actions</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">action_name</span>.<span class="ruby-identifier">to_sym</span>) <span class="ruby-operator">||</span> (<span class="ruby-identifier">except_actions</span>.<span class="ruby-identifier">any?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">except_actions</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">action_name</span>.<span class="ruby-identifier">to_sym</span>))
400:           <span class="ruby-keyword kw">else</span>
401:             <span class="ruby-keyword kw">true</span>
402:           <span class="ruby-keyword kw">end</span>
403:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000200">
                    
                    <a name="M000200"></a><b>_record_queue_length</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Take a guess at a measure representing the number of requests waiting in
mongrel or heroku.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000200_source')" id="l_M000200_source">show</a>
                        
                    </p>
                    <div id="M000200_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/controller_instrumentation.rb, line 406</span>
406:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">_record_queue_length</span>
407:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">newrelic_request_headers</span>
408:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">queue_depth</span> = <span class="ruby-identifier">newrelic_request_headers</span>[<span class="ruby-value str">'HTTP_X_HEROKU_QUEUE_DEPTH'</span>]
409:               <span class="ruby-identifier">queue_depth</span> = <span class="ruby-identifier">queue_depth</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
410:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">mongrel</span> = <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">local_env</span>.<span class="ruby-identifier">mongrel</span>
411:               <span class="ruby-comment cmt"># Always subtrace 1 for the active mongrel</span>
412:               <span class="ruby-identifier">queue_depth</span> = [<span class="ruby-identifier">mongrel</span>.<span class="ruby-identifier">workers</span>.<span class="ruby-identifier">list</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-value">0</span>].<span class="ruby-identifier">max</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
413:             <span class="ruby-keyword kw">end</span>
414:             <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">agent</span>.<span class="ruby-identifier">stats_engine</span>.<span class="ruby-identifier">get_stats_no_scope</span>(<span class="ruby-value str">'Mongrel/Queue Length'</span>).<span class="ruby-identifier">trace_call</span>(<span class="ruby-identifier">queue_depth</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">queue_depth</span>
415:           <span class="ruby-keyword kw">end</span>
416:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000194">
                    
                    <a name="M000194"></a><b>perform_action_with_newrelic_profile</b>(args)
                    
                </div>
                
                <div class="description">
                  <p>
Profile the instrumented call. Dev mode only. Experimental
</p>
<ul>
<li>should definitely not be used on production applications

</li>
</ul>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000194_source')" id="l_M000194_source">show</a>
                        
                    </p>
                    <div id="M000194_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/controller_instrumentation.rb, line 318</span>
318:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">perform_action_with_newrelic_profile</span>(<span class="ruby-identifier">args</span>)
319:           <span class="ruby-identifier">frame_data</span> = <span class="ruby-identifier">_push_metric_frame</span>(<span class="ruby-identifier">block_given?</span> <span class="ruby-value">? </span><span class="ruby-identifier">args</span> <span class="ruby-operator">:</span> [])
320:           <span class="ruby-identifier">val</span> = <span class="ruby-keyword kw">nil</span>
321:           <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">trace_execution_scoped</span> <span class="ruby-identifier">frame_data</span>.<span class="ruby-identifier">metric_name</span> <span class="ruby-keyword kw">do</span>
322:             <span class="ruby-constant">MetricFrame</span>.<span class="ruby-identifier">current</span>(<span class="ruby-keyword kw">true</span>).<span class="ruby-identifier">start_transaction</span>
323:             <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">disable_all_tracing</span> <span class="ruby-keyword kw">do</span>
324:               <span class="ruby-comment cmt"># turn on profiling</span>
325:               <span class="ruby-identifier">profile</span> = <span class="ruby-constant">RubyProf</span>.<span class="ruby-identifier">profile</span> <span class="ruby-keyword kw">do</span>
326:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">block_given?</span>
327:                   <span class="ruby-identifier">val</span> = <span class="ruby-keyword kw">yield</span>
328:                 <span class="ruby-keyword kw">else</span>
329:                   <span class="ruby-identifier">val</span> = <span class="ruby-identifier">perform_action_without_newrelic_trace</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
330:                 <span class="ruby-keyword kw">end</span>
331:               <span class="ruby-keyword kw">end</span>
332:               <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">transaction_sampler</span>.<span class="ruby-identifier">notice_profile</span> <span class="ruby-identifier">profile</span>
333:             <span class="ruby-keyword kw">end</span>
334:           <span class="ruby-keyword kw">end</span>
335:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">val</span>
336:         <span class="ruby-keyword kw">ensure</span>
337:           <span class="ruby-identifier">frame_data</span>.<span class="ruby-identifier">pop</span>
338:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    