<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>CGI::QueryExtension</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
    <script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Module</span> 
            CGI::QueryExtension 
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/cgi/core_rb.html">lib/cgi/core.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
Mixin module that provides the following:
</p>
<ol>
<li>Access to the <a href="../CGI.html">CGI</a> environment variables as
methods. See documentation to the <a href="../CGI.html">CGI</a> class for a
list of these variables. The methods are exposed by removing the leading
<tt>HTTP_</tt> (if it exists) and downcasing the name. For example,
<tt>auth_type</tt> will return the environment variable <tt>AUTH_TYPE</tt>,
and <tt>accept</tt> will return the value for <tt>HTTP_ACCEPT</tt>.

</li>
<li>Access to cookies, including the cookies attribute.

</li>
<li>Access to parameters, including the params attribute, and overloading #[]
to perform parameter value lookup by key.

</li>
<li>The <a href="QueryExtension.html#M001695">initialize_query</a> method, for
initializing the above mechanisms, handling multipart forms, and allowing
the class to be used in &#8220;offline&#8221; mode.

</li>
</ol>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>#</dt>
        <dd>
            <ul>
                
                <li><a href="#M001699">[]</a></li>
                
            </ul>
        </dd>
    
        <dt>H</dt>
        <dd>
            <ul>
                
                <li><a href="#M001701">has_key?</a></li>
                
            </ul>
        </dd>
    
        <dt>I</dt>
        <dd>
            <ul>
                
                <li><a href="#M001703">include?</a>,</li>
                
                <li><a href="#M001695">initialize_query</a></li>
                
            </ul>
        </dd>
    
        <dt>K</dt>
        <dd>
            <ul>
                
                <li><a href="#M001702">key?</a>,</li>
                
                <li><a href="#M001700">keys</a></li>
                
            </ul>
        </dd>
    
        <dt>M</dt>
        <dd>
            <ul>
                
                <li><a href="#M001698">multipart?</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M001681">params=</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M001679">raw_cookie</a>,</li>
                
                <li><a href="#M001680">raw_cookie2</a>,</li>
                
                <li><a href="#M001693">read_from_cmdline</a>,</li>
                
                <li><a href="#M001682">read_multipart</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    

    

    
    <div class="sectiontitle">Attributes</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>cookies</td>
            <td class='attr-desc'><p>
Get the cookies as a hash of cookie-name=><a href="Cookie.html">Cookie</a>
pairs.
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>params</td>
            <td class='attr-desc'><p>
Get the parameters as a hash of name=>values pairs, where values is an <a
href="../Array.html">Array</a>.
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>files</td>
            <td class='attr-desc'><p>
Get the uploaded files as a hash of name=>values pairs
</p></td>
        </tr>
        
    </table>
    

    
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M001699">
                    
                    <a name="M001699"></a><b>[]</b>(key)
                    
                </div>
                
                <div class="description">
                  <p>
Get the value for the parameter with a given key.
</p>
<p>
If the parameter has multiple values, only the first will be retrieved; use
<a href="QueryExtension.html#params">params</a> to get the array of values.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001699_source')" id="l_M001699_source">show</a>
                        
                    </p>
                    <div id="M001699_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/cgi/core.rb, line 676</span>
676:     <span class="ruby-keyword kw">def</span> <span class="ruby-operator">[]</span>(<span class="ruby-identifier">key</span>)
677:       <span class="ruby-identifier">params</span> = <span class="ruby-ivar">@params</span>[<span class="ruby-identifier">key</span>]
678:       <span class="ruby-keyword kw">return</span> <span class="ruby-value str">''</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>
679:       <span class="ruby-identifier">value</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">0</span>]
680:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@multipart</span>
681:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">value</span>
682:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">value</span>
683:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-keyword kw">defined?</span> <span class="ruby-constant">StringIO</span>
684:           <span class="ruby-constant">StringIO</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">&quot;&quot;</span>.<span class="ruby-identifier">force_encoding</span>(<span class="ruby-value str">&quot;ascii-8bit&quot;</span>))
685:         <span class="ruby-keyword kw">else</span>
686:           <span class="ruby-constant">Tempfile</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">&quot;CGI&quot;</span>,<span class="ruby-identifier">encoding</span><span class="ruby-identifier">:&quot;ascii-8bit&quot;</span>)
687:         <span class="ruby-keyword kw">end</span>
688:       <span class="ruby-keyword kw">else</span>
689:         <span class="ruby-identifier">str</span> = <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">value</span> <span class="ruby-keyword kw">then</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">dup</span> <span class="ruby-keyword kw">else</span> <span class="ruby-value str">&quot;&quot;</span> <span class="ruby-keyword kw">end</span>
690:         <span class="ruby-identifier">str</span>
691:       <span class="ruby-keyword kw">end</span>
692:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001701">
                    
                    <a name="M001701"></a><b>has_key?</b>(*args)
                    
                </div>
                
                <div class="description">
                  <p>
Returns true if a given query string parameter exists.
</p>

                </div>
                
                
                <div class="aka">
                    This method is also aliased as
                    
                    <a href="QueryExtension.html#M001702">key?</a>
                    
                    <a href="QueryExtension.html#M001703">include?</a>
                    
                </div>
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001701_source')" id="l_M001701_source">show</a>
                        
                    </p>
                    <div id="M001701_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/cgi/core.rb, line 700</span>
700:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">has_key?</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
701:       <span class="ruby-ivar">@params</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
702:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001703">
                    
                    <a name="M001703"></a><b>include?</b>(*args)
                    
                </div>
                
                <div class="description">
                  <p>
Alias for <a href="QueryExtension.html#M001701">has_key?</a>
</p>

                </div>
                
                
                
            </div>
            
            <div class="method">
                <div class="title" id="M001702">
                    
                    <a name="M001702"></a><b>key?</b>(*args)
                    
                </div>
                
                <div class="description">
                  <p>
Alias for <a href="QueryExtension.html#M001701">has_key?</a>
</p>

                </div>
                
                
                
            </div>
            
            <div class="method">
                <div class="title" id="M001700">
                    
                    <a name="M001700"></a><b>keys</b>(*args)
                    
                </div>
                
                <div class="description">
                  <p>
Return all query parameter names as an array of <a
href="../String.html">String</a>.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001700_source')" id="l_M001700_source">show</a>
                        
                    </p>
                    <div id="M001700_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/cgi/core.rb, line 695</span>
695:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">keys</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
696:       <span class="ruby-ivar">@params</span>.<span class="ruby-identifier">keys</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
697:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001698">
                    
                    <a name="M001698"></a><b>multipart?</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Returns whether the form contained multipart/form-data
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001698_source')" id="l_M001698_source">show</a>
                        
                    </p>
                    <div id="M001698_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/cgi/core.rb, line 668</span>
668:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">multipart?</span>
669:       <span class="ruby-ivar">@multipart</span>
670:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001681">
                    
                    <a name="M001681"></a><b>params=</b>(hash)
                    
                </div>
                
                <div class="description">
                  <p>
<a href="../Set.html">Set</a> all the parameters.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001681_source')" id="l_M001681_source">show</a>
                        
                    </p>
                    <div id="M001681_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/cgi/core.rb, line 449</span>
449:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">params=</span>(<span class="ruby-identifier">hash</span>)
450:       <span class="ruby-ivar">@params</span>.<span class="ruby-identifier">clear</span>
451:       <span class="ruby-ivar">@params</span>.<span class="ruby-identifier">update</span>(<span class="ruby-identifier">hash</span>)
452:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001679">
                    
                    <a name="M001679"></a><b>raw_cookie</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Get the raw cookies as a string.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001679_source')" id="l_M001679_source">show</a>
                        
                    </p>
                    <div id="M001679_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/cgi/core.rb, line 429</span>
429:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">raw_cookie</span>
430:       <span class="ruby-identifier">env_table</span>[<span class="ruby-value str">&quot;HTTP_COOKIE&quot;</span>]
431:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001680">
                    
                    <a name="M001680"></a><b>raw_cookie2</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Get the raw RFC2965 cookies as a string.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001680_source')" id="l_M001680_source">show</a>
                        
                    </p>
                    <div id="M001680_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/cgi/core.rb, line 434</span>
434:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">raw_cookie2</span>
435:       <span class="ruby-identifier">env_table</span>[<span class="ruby-value str">&quot;HTTP_COOKIE2&quot;</span>]
436:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Private methods</div>
            
            <div class="method">
                <div class="title" id="M001695">
                    
                    <a name="M001695"></a><b>initialize_query</b>()
                    
                </div>
                
                <div class="description">
                  <p>
A wrapper class to use a <a href="../StringIO.html">StringIO</a> object as
the body and switch to a TempFile when the passed threshold is passed.
Initialize the data from the query.
</p>
<p>
Handles multipart forms (in particular, forms that involve file uploads).
Reads query parameters in the @params field, and cookies into @cookies.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001695_source')" id="l_M001695_source">show</a>
                        
                    </p>
                    <div id="M001695_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/cgi/core.rb, line 624</span>
624:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize_query</span>()
625:       <span class="ruby-keyword kw">if</span> (<span class="ruby-value str">&quot;POST&quot;</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'REQUEST_METHOD'</span>]) <span class="ruby-keyword kw">and</span>
626:          <span class="ruby-regexp re">%r|\Amultipart/form-data.*boundary=\&quot;?([^\&quot;;,]+)\&quot;?|</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'CONTENT_TYPE'</span>])
627:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">StandardError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">&quot;too large multipart data.&quot;</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'CONTENT_LENGTH'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">MAX_MULTIPART_LENGTH</span>
628:         <span class="ruby-identifier">boundary</span> = <span class="ruby-identifier">$1</span>.<span class="ruby-identifier">dup</span>
629:         <span class="ruby-ivar">@multipart</span> = <span class="ruby-keyword kw">true</span>
630:         <span class="ruby-ivar">@params</span> = <span class="ruby-identifier">read_multipart</span>(<span class="ruby-identifier">boundary</span>, <span class="ruby-constant">Integer</span>(<span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'CONTENT_LENGTH'</span>]))
631:       <span class="ruby-keyword kw">else</span>
632:         <span class="ruby-ivar">@multipart</span> = <span class="ruby-keyword kw">false</span>
633:         <span class="ruby-ivar">@params</span> = <span class="ruby-constant">CGI</span><span class="ruby-operator">::</span><span class="ruby-identifier">parse</span>(
634:                     <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'REQUEST_METHOD'</span>]
635:                     <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;GET&quot;</span>, <span class="ruby-value str">&quot;HEAD&quot;</span>
636:                       <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">defined?</span>(<span class="ruby-constant">MOD_RUBY</span>)
637:                         <span class="ruby-constant">Apache</span><span class="ruby-operator">::</span><span class="ruby-identifier">request</span>.<span class="ruby-identifier">args</span> <span class="ruby-keyword kw">or</span> <span class="ruby-value str">&quot;&quot;</span>
638:                       <span class="ruby-keyword kw">else</span>
639:                         <span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'QUERY_STRING'</span>] <span class="ruby-keyword kw">or</span> <span class="ruby-value str">&quot;&quot;</span>
640:                       <span class="ruby-keyword kw">end</span>
641:                     <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;POST&quot;</span>
642:                       <span class="ruby-identifier">stdinput</span>.<span class="ruby-identifier">binmode</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">defined?</span> <span class="ruby-identifier">stdinput</span>.<span class="ruby-identifier">binmode</span>
643:                       <span class="ruby-identifier">stdinput</span>.<span class="ruby-identifier">read</span>(<span class="ruby-constant">Integer</span>(<span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'CONTENT_LENGTH'</span>])) <span class="ruby-keyword kw">or</span> <span class="ruby-value str">''</span>
644:                     <span class="ruby-keyword kw">else</span>
645:                       <span class="ruby-identifier">read_from_cmdline</span>
646:                     <span class="ruby-keyword kw">end</span>.<span class="ruby-identifier">dup</span>.<span class="ruby-identifier">force_encoding</span>(<span class="ruby-ivar">@accept_charset</span>)
647:                   )
648:         <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">Encoding</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@accept_charset</span>) <span class="ruby-operator">==</span> <span class="ruby-constant">Encoding</span><span class="ruby-operator">::</span><span class="ruby-constant">ASCII_8BIT</span>
649:           <span class="ruby-ivar">@params</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>,<span class="ruby-identifier">values</span><span class="ruby-operator">|</span>
650:             <span class="ruby-identifier">values</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
651:               <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">valid_encoding?</span>
652:                 <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@accept_charset_error_block</span>
653:                   <span class="ruby-ivar">@accept_charset_error_block</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">key</span>,<span class="ruby-identifier">value</span>)
654:                 <span class="ruby-keyword kw">else</span>
655:                   <span class="ruby-identifier">raise</span> <span class="ruby-constant">InvalidEncoding</span>,<span class="ruby-value str">&quot;Accept-Charset encoding error&quot;</span>
656:                 <span class="ruby-keyword kw">end</span>
657:               <span class="ruby-keyword kw">end</span>
658:             <span class="ruby-keyword kw">end</span>
659:           <span class="ruby-keyword kw">end</span>
660:         <span class="ruby-keyword kw">end</span>
661:       <span class="ruby-keyword kw">end</span>
662: 
663:       <span class="ruby-ivar">@cookies</span> = <span class="ruby-constant">CGI</span><span class="ruby-operator">::</span><span class="ruby-constant">Cookie</span><span class="ruby-operator">::</span><span class="ruby-identifier">parse</span>((<span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'HTTP_COOKIE'</span>] <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">env_table</span>[<span class="ruby-value str">'COOKIE'</span>]))
664:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001693">
                    
                    <a name="M001693"></a><b>read_from_cmdline</b>()
                    
                </div>
                
                <div class="description">
                  <p>
offline mode. read name=value pairs on standard input.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001693_source')" id="l_M001693_source">show</a>
                        
                    </p>
                    <div id="M001693_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/cgi/core.rb, line 589</span>
589:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_from_cmdline</span>
590:       <span class="ruby-identifier">require</span> <span class="ruby-value str">&quot;shellwords&quot;</span>
591: 
592:       <span class="ruby-identifier">string</span> = <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">empty?</span>
593:         <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">' '</span>)
594:       <span class="ruby-keyword kw">else</span>
595:         <span class="ruby-keyword kw">if</span> <span class="ruby-constant">STDIN</span>.<span class="ruby-identifier">tty?</span>
596:           <span class="ruby-constant">STDERR</span>.<span class="ruby-identifier">print</span>(
597:             <span class="ruby-value str">%|(offline mode: enter name=value pairs on standard input)\n|</span>
598:           )
599:         <span class="ruby-keyword kw">end</span>
600:         <span class="ruby-identifier">array</span> = <span class="ruby-identifier">readlines</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
601:         <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">array</span>.<span class="ruby-identifier">nil?</span>
602:             <span class="ruby-identifier">array</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">' '</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/\n/n</span>, <span class="ruby-value str">''</span>)
603:         <span class="ruby-keyword kw">else</span>
604:             <span class="ruby-value str">&quot;&quot;</span>
605:         <span class="ruby-keyword kw">end</span>
606:       <span class="ruby-keyword kw">end</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/\\=/n</span>, <span class="ruby-value str">'%3D'</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/\\&amp;/n</span>, <span class="ruby-value str">'%26'</span>)
607: 
608:       <span class="ruby-identifier">words</span> = <span class="ruby-constant">Shellwords</span>.<span class="ruby-identifier">shellwords</span>(<span class="ruby-identifier">string</span>)
609: 
610:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">words</span>.<span class="ruby-identifier">find</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span> <span class="ruby-regexp re">/=/n</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">x</span>) }
611:         <span class="ruby-identifier">words</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">'&amp;'</span>)
612:       <span class="ruby-keyword kw">else</span>
613:         <span class="ruby-identifier">words</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">'+'</span>)
614:       <span class="ruby-keyword kw">end</span>
615:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M001682">
                    
                    <a name="M001682"></a><b>read_multipart</b>(boundary, content_length)
                    
                </div>
                
                <div class="description">
                  <p>
Parses multipart form elements according to
</p>
<pre>
  http://www.w3.org/TR/html401/interact/forms.html#h-17.13.4.2
</pre>
<p>
Returns a hash of multipart form parameters with bodies of type <a
href="../StringIO.html">StringIO</a> or Tempfile depending on whether the
multipart form element exceeds 10 KB
</p>
<pre>
  params[name =&gt; body]
</pre>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M001682_source')" id="l_M001682_source">show</a>
                        
                    </p>
                    <div id="M001682_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/cgi/core.rb, line 463</span>
463:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_multipart</span>(<span class="ruby-identifier">boundary</span>, <span class="ruby-identifier">content_length</span>)
464:       <span class="ruby-comment cmt">## read first boundary</span>
465:       <span class="ruby-identifier">stdin</span> = <span class="ruby-identifier">$stdin</span>
466:       <span class="ruby-identifier">first_line</span> = <span class="ruby-node">&quot;--#{boundary}#{EOL}&quot;</span>
467:       <span class="ruby-identifier">content_length</span> <span class="ruby-operator">-=</span> <span class="ruby-identifier">first_line</span>.<span class="ruby-identifier">bytesize</span>
468:       <span class="ruby-identifier">status</span> = <span class="ruby-identifier">stdin</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">first_line</span>.<span class="ruby-identifier">bytesize</span>)
469:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">EOFError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">&quot;no content body&quot;</span>)  <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">status</span>
470:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">EOFError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">&quot;bad content body&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">first_line</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">status</span>
471:       <span class="ruby-comment cmt">## parse and set params</span>
472:       <span class="ruby-identifier">params</span> = {}
473:       <span class="ruby-ivar">@files</span> = {}
474:       <span class="ruby-identifier">boundary_rexp</span> = <span class="ruby-node">/--#{Regexp.quote(boundary)}(#{EOL}|--)/</span>
475:       <span class="ruby-identifier">boundary_size</span> = <span class="ruby-node">&quot;#{EOL}--#{boundary}#{EOL}&quot;</span>.<span class="ruby-identifier">bytesize</span>
476:       <span class="ruby-identifier">boundary_end</span>  = <span class="ruby-keyword kw">nil</span>
477:       <span class="ruby-identifier">buf</span> = <span class="ruby-value str">''</span>
478:       <span class="ruby-identifier">bufsize</span> = <span class="ruby-value">10</span> <span class="ruby-operator">*</span> <span class="ruby-value">1024</span>
479:       <span class="ruby-identifier">max_count</span> = <span class="ruby-constant">MAX_MULTIPART_COUNT</span>
480:       <span class="ruby-identifier">n</span> = <span class="ruby-value">0</span>
481:       <span class="ruby-keyword kw">while</span> <span class="ruby-keyword kw">true</span>
482:         (<span class="ruby-identifier">n</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>) <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">max_count</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">raise</span> <span class="ruby-constant">StandardError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">&quot;too many parameters.&quot;</span>)
483:         <span class="ruby-comment cmt">## create body (StringIO or Tempfile)</span>
484:         <span class="ruby-identifier">body</span> = <span class="ruby-identifier">create_body</span>(<span class="ruby-identifier">bufsize</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">content_length</span>)
485:         <span class="ruby-keyword kw">class</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span>
486:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">method_defined?</span>(<span class="ruby-identifier">:path</span>)
487:             <span class="ruby-keyword kw">alias</span> <span class="ruby-identifier">local_path</span> <span class="ruby-identifier">path</span>
488:           <span class="ruby-keyword kw">else</span>
489:             <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">local_path</span>
490:               <span class="ruby-keyword kw">nil</span>
491:             <span class="ruby-keyword kw">end</span>
492:           <span class="ruby-keyword kw">end</span>
493:           <span class="ruby-identifier">attr_reader</span> <span class="ruby-identifier">:original_filename</span>, <span class="ruby-identifier">:content_type</span>
494:         <span class="ruby-keyword kw">end</span>
495:         <span class="ruby-comment cmt">## find head and boundary</span>
496:         <span class="ruby-identifier">head</span> = <span class="ruby-keyword kw">nil</span>
497:         <span class="ruby-identifier">separator</span> = <span class="ruby-constant">EOL</span> <span class="ruby-operator">*</span> <span class="ruby-value">2</span>
498:         <span class="ruby-keyword kw">until</span> <span class="ruby-identifier">head</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">matched</span> = <span class="ruby-identifier">boundary_rexp</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">buf</span>)
499:           <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">head</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">pos</span> = <span class="ruby-identifier">buf</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">separator</span>)
500:             <span class="ruby-identifier">len</span>  = <span class="ruby-identifier">pos</span> <span class="ruby-operator">+</span> <span class="ruby-constant">EOL</span>.<span class="ruby-identifier">bytesize</span>
501:             <span class="ruby-identifier">head</span> = <span class="ruby-identifier">buf</span>[<span class="ruby-value">0</span>, <span class="ruby-identifier">len</span>]
502:             <span class="ruby-identifier">buf</span>  = <span class="ruby-identifier">buf</span>[(<span class="ruby-identifier">pos</span><span class="ruby-operator">+</span><span class="ruby-identifier">separator</span>.<span class="ruby-identifier">bytesize</span>)<span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
503:           <span class="ruby-keyword kw">else</span>
504:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">head</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">buf</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">boundary_size</span>
505:               <span class="ruby-identifier">len</span> = <span class="ruby-identifier">buf</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">boundary_size</span>
506:               <span class="ruby-identifier">body</span>.<span class="ruby-identifier">print</span>(<span class="ruby-identifier">buf</span>[<span class="ruby-value">0</span>, <span class="ruby-identifier">len</span>])
507:               <span class="ruby-identifier">buf</span>[<span class="ruby-value">0</span>, <span class="ruby-identifier">len</span>] = <span class="ruby-value str">''</span>
508:             <span class="ruby-keyword kw">end</span>
509:             <span class="ruby-identifier">c</span> = <span class="ruby-identifier">stdin</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">bufsize</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">content_length</span> <span class="ruby-value">? </span><span class="ruby-identifier">bufsize</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">content_length</span>)
510:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">EOFError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">&quot;bad content body&quot;</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">empty?</span>
511:             <span class="ruby-identifier">buf</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">c</span>
512:             <span class="ruby-identifier">content_length</span> <span class="ruby-operator">-=</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">bytesize</span>
513:           <span class="ruby-keyword kw">end</span>
514:         <span class="ruby-keyword kw">end</span>
515:         <span class="ruby-comment cmt">## read to end of boundary</span>
516:         <span class="ruby-identifier">m</span> = <span class="ruby-identifier">matched</span>
517:         <span class="ruby-identifier">len</span> = <span class="ruby-identifier">m</span>.<span class="ruby-identifier">begin</span>(<span class="ruby-value">0</span>)
518:         <span class="ruby-identifier">s</span> = <span class="ruby-identifier">buf</span>[<span class="ruby-value">0</span>, <span class="ruby-identifier">len</span>]
519:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/(\r?\n)\z/</span>
520:           <span class="ruby-identifier">s</span> = <span class="ruby-identifier">buf</span>[<span class="ruby-value">0</span>, <span class="ruby-identifier">len</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">$1</span>.<span class="ruby-identifier">bytesize</span>]
521:         <span class="ruby-keyword kw">end</span>
522:         <span class="ruby-identifier">body</span>.<span class="ruby-identifier">print</span>(<span class="ruby-identifier">s</span>)
523:         <span class="ruby-identifier">buf</span> = <span class="ruby-identifier">buf</span>[<span class="ruby-identifier">m</span>.<span class="ruby-identifier">end</span>(<span class="ruby-value">0</span>)<span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
524:         <span class="ruby-identifier">boundary_end</span> = <span class="ruby-identifier">m</span>[<span class="ruby-value">1</span>]
525:         <span class="ruby-identifier">content_length</span> = <span class="ruby-value">-1</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">boundary_end</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'--'</span>
526:         <span class="ruby-comment cmt">## reset file cursor position</span>
527:         <span class="ruby-identifier">body</span>.<span class="ruby-identifier">rewind</span>
528:         <span class="ruby-comment cmt">## original filename</span>
529:         <span class="ruby-regexp re">/Content-Disposition:.* filename=(?:&quot;(.*?)&quot;|([^;\r\n]*))/i</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">head</span>)
530:         <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">$1</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">$2</span> <span class="ruby-operator">||</span> <span class="ruby-value str">''</span>
531:         <span class="ruby-identifier">filename</span> = <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">unescape</span>(<span class="ruby-identifier">filename</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">unescape_filename?</span>()
532:         <span class="ruby-identifier">body</span>.<span class="ruby-identifier">instance_variable_set</span>(<span class="ruby-value str">'@original_filename'</span>, <span class="ruby-identifier">filename</span>.<span class="ruby-identifier">taint</span>)
533:         <span class="ruby-comment cmt">## content type</span>
534:         <span class="ruby-regexp re">/Content-Type: (.*)/i</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">head</span>)
535:         (<span class="ruby-identifier">content_type</span> = <span class="ruby-identifier">$1</span> <span class="ruby-operator">||</span> <span class="ruby-value str">''</span>).<span class="ruby-identifier">chomp!</span>
536:         <span class="ruby-identifier">body</span>.<span class="ruby-identifier">instance_variable_set</span>(<span class="ruby-value str">'@content_type'</span>, <span class="ruby-identifier">content_type</span>.<span class="ruby-identifier">taint</span>)
537:         <span class="ruby-comment cmt">## query parameter name</span>
538:         <span class="ruby-regexp re">/Content-Disposition:.* name=(?:&quot;(.*?)&quot;|([^;\r\n]*))/i</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">head</span>)
539:         <span class="ruby-identifier">name</span> = <span class="ruby-identifier">$1</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">$2</span> <span class="ruby-operator">||</span> <span class="ruby-value str">''</span>
540:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">original_filename</span>.<span class="ruby-identifier">empty?</span>
541:           <span class="ruby-identifier">value</span>=<span class="ruby-identifier">body</span>.<span class="ruby-identifier">read</span>.<span class="ruby-identifier">dup</span>.<span class="ruby-identifier">force_encoding</span>(<span class="ruby-ivar">@accept_charset</span>)
542:           (<span class="ruby-identifier">params</span>[<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span> []) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">value</span>
543:           <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">valid_encoding?</span>
544:             <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@accept_charset_error_block</span>
545:               <span class="ruby-ivar">@accept_charset_error_block</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">name</span>,<span class="ruby-identifier">value</span>)
546:             <span class="ruby-keyword kw">else</span>
547:               <span class="ruby-identifier">raise</span> <span class="ruby-constant">InvalidEncoding</span>,<span class="ruby-value str">&quot;Accept-Charset encoding error&quot;</span>
548:             <span class="ruby-keyword kw">end</span>
549:           <span class="ruby-keyword kw">end</span>
550:           <span class="ruby-keyword kw">class</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">name</span>].<span class="ruby-identifier">last</span>;<span class="ruby-keyword kw">self</span>;<span class="ruby-keyword kw">end</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-keyword kw">do</span>
551:             <span class="ruby-identifier">define_method</span>(<span class="ruby-identifier">:read</span>){<span class="ruby-keyword kw">self</span>}
552:             <span class="ruby-identifier">define_method</span>(<span class="ruby-identifier">:original_filename</span>){<span class="ruby-value str">&quot;&quot;</span>}
553:             <span class="ruby-identifier">define_method</span>(<span class="ruby-identifier">:content_type</span>){<span class="ruby-value str">&quot;&quot;</span>}
554:           <span class="ruby-keyword kw">end</span>
555:         <span class="ruby-keyword kw">else</span>
556:           (<span class="ruby-identifier">params</span>[<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span> []) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span>
557:           <span class="ruby-ivar">@files</span>[<span class="ruby-identifier">name</span>]=<span class="ruby-identifier">body</span>
558:         <span class="ruby-keyword kw">end</span>
559:         <span class="ruby-comment cmt">## break loop</span>
560:         <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">content_length</span> <span class="ruby-operator">==</span> <span class="ruby-value">-1</span>
561:       <span class="ruby-keyword kw">end</span>
562:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">EOFError</span>, <span class="ruby-value str">&quot;bad boundary end of body part&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">boundary_end</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/--/</span>
563:       <span class="ruby-identifier">params</span>.<span class="ruby-identifier">default</span> = []
564:       <span class="ruby-identifier">params</span>
565:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    