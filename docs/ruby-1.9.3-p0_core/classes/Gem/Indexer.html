<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Gem::Indexer</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
    <script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            Gem::Indexer 
            
                <span class="parent">&lt; 
                    
                    <a href="../Object.html">Object</a>
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/rubygems/indexer_rb.html">lib/rubygems/indexer.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
Top level class for building the gem repository index.
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>A</dt>
        <dd>
            <ul>
                
                <li><a href="#M006774">abbreviate</a></li>
                
            </ul>
        </dd>
    
        <dt>B</dt>
        <dd>
            <ul>
                
                <li><a href="#M006775">build_indicies</a>,</li>
                
                <li><a href="#M006776">build_legacy_indicies</a>,</li>
                
                <li><a href="#M006777">build_marshal_gemspecs</a>,</li>
                
                <li><a href="#M006778">build_modern_index</a>,</li>
                
                <li><a href="#M006780">build_modern_indicies</a>,</li>
                
                <li><a href="#M006781">build_rss</a></li>
                
            </ul>
        </dd>
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M006783">collect_specs</a>,</li>
                
                <li><a href="#M006785">compact_specs</a>,</li>
                
                <li><a href="#M006786">compress</a>,</li>
                
                <li><a href="#M006784">compress_indicies</a></li>
                
            </ul>
        </dd>
    
        <dt>G</dt>
        <dd>
            <ul>
                
                <li><a href="#M006789">gem_file_list</a>,</li>
                
                <li><a href="#M006790">generate_index</a>,</li>
                
                <li><a href="#M006791">gzip</a></li>
                
            </ul>
        </dd>
    
        <dt>I</dt>
        <dd>
            <ul>
                
                <li><a href="#M006795">install_indicies</a></li>
                
            </ul>
        </dd>
    
        <dt>M</dt>
        <dd>
            <ul>
                
                <li><a href="#M006797">make_temp_directories</a>,</li>
                
                <li><a href="#M006782">map_gems_to_specs</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M006772">new</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M006798">paranoid</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M006799">sanitize</a>,</li>
                
                <li><a href="#M006800">sanitize_string</a></li>
                
            </ul>
        </dd>
    
        <dt>U</dt>
        <dd>
            <ul>
                
                <li><a href="#M006801">update_index</a>,</li>
                
                <li><a href="#M006808">update_specs_index</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    
    <div class="sectiontitle">Included Modules</div>
    <ul>
        
        <li>
            
            <a href="../JSON.html">JSON</a>
            
            START:includes
        </li>
        
    </ul>
    

    

    

    

    
    <div class="sectiontitle">Attributes</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>build_legacy</td>
            <td class='attr-desc'><p>
Build indexes for RubyGems older than 1.2.0 when true
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>build_modern</td>
            <td class='attr-desc'><p>
Build indexes for RubyGems 1.2.0 and newer when true
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>dest_directory</td>
            <td class='attr-desc'><p>
Index install location
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>dest_specs_index</td>
            <td class='attr-desc'><p>
Specs index install location
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>dest_latest_specs_index</td>
            <td class='attr-desc'><p>
Latest specs index install location
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>dest_prerelease_specs_index</td>
            <td class='attr-desc'><p>
Prerelease specs index install location
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>directory</td>
            <td class='attr-desc'><p>
Index build directory
</p></td>
        </tr>
        
    </table>
    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M006772">
                    
                    <a name="M006772"></a><b>new</b>(directory, options = {})
                    
                </div>
                
                <div class="description">
                  <p>
Create an indexer that will index the gems in <tt>directory</tt>.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006772_source')" id="l_M006772_source">show</a>
                        
                    </p>
                    <div id="M006772_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 56</span>
 56:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">directory</span>, <span class="ruby-identifier">options</span> = {})
 57:     <span class="ruby-identifier">require</span> <span class="ruby-value str">'fileutils'</span>
 58:     <span class="ruby-identifier">require</span> <span class="ruby-value str">'tmpdir'</span>
 59:     <span class="ruby-identifier">require</span> <span class="ruby-value str">'zlib'</span>
 60: 
 61:     <span class="ruby-keyword kw">unless</span> <span class="ruby-keyword kw">defined?</span>(<span class="ruby-constant">Builder</span><span class="ruby-operator">::</span><span class="ruby-constant">XChar</span>) <span class="ruby-keyword kw">then</span>
 62:       <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Gem::Indexer requires that the XML Builder library be installed:&quot;</span> \
 63:            <span class="ruby-value str">&quot;\n\tgem install builder&quot;</span>
 64:     <span class="ruby-keyword kw">end</span>
 65: 
 66:     <span class="ruby-identifier">options</span> = { <span class="ruby-identifier">:build_legacy</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>, <span class="ruby-identifier">:build_modern</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span> }.<span class="ruby-identifier">merge</span> <span class="ruby-identifier">options</span>
 67: 
 68:     <span class="ruby-ivar">@build_legacy</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:build_legacy</span>]
 69:     <span class="ruby-ivar">@build_modern</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:build_modern</span>]
 70: 
 71:     <span class="ruby-ivar">@rss_title</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:rss_title</span>]
 72:     <span class="ruby-ivar">@rss_host</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:rss_host</span>]
 73:     <span class="ruby-ivar">@rss_gems_host</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:rss_gems_host</span>]
 74: 
 75:     <span class="ruby-ivar">@dest_directory</span> = <span class="ruby-identifier">directory</span>
 76:     <span class="ruby-ivar">@directory</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">Dir</span>.<span class="ruby-identifier">tmpdir</span>, <span class="ruby-node">&quot;gem_generate_index_#{$$}&quot;</span>)
 77: 
 78:     <span class="ruby-identifier">marshal_name</span> = <span class="ruby-node">&quot;Marshal.#{Gem.marshal_version}&quot;</span>
 79: 
 80:     <span class="ruby-ivar">@master_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-value str">'yaml'</span>
 81:     <span class="ruby-ivar">@marshal_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-identifier">marshal_name</span>
 82: 
 83:     <span class="ruby-ivar">@quick_dir</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-value str">'quick'</span>
 84:     <span class="ruby-ivar">@quick_marshal_dir</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@quick_dir</span>, <span class="ruby-identifier">marshal_name</span>
 85:     <span class="ruby-ivar">@quick_marshal_dir_base</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-value str">&quot;quick&quot;</span>, <span class="ruby-identifier">marshal_name</span> <span class="ruby-comment cmt"># FIX: UGH</span>
 86: 
 87:     <span class="ruby-ivar">@quick_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@quick_dir</span>, <span class="ruby-value str">'index'</span>
 88:     <span class="ruby-ivar">@latest_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@quick_dir</span>, <span class="ruby-value str">'latest_index'</span>
 89: 
 90:     <span class="ruby-ivar">@specs_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-node">&quot;specs.#{Gem.marshal_version}&quot;</span>
 91:     <span class="ruby-ivar">@latest_specs_index</span> =
 92:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@directory</span>, <span class="ruby-node">&quot;latest_specs.#{Gem.marshal_version}&quot;</span>)
 93:     <span class="ruby-ivar">@prerelease_specs_index</span> =
 94:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@directory</span>, <span class="ruby-node">&quot;prerelease_specs.#{Gem.marshal_version}&quot;</span>)
 95:     <span class="ruby-ivar">@dest_specs_index</span> =
 96:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@dest_directory</span>, <span class="ruby-node">&quot;specs.#{Gem.marshal_version}&quot;</span>)
 97:     <span class="ruby-ivar">@dest_latest_specs_index</span> =
 98:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@dest_directory</span>, <span class="ruby-node">&quot;latest_specs.#{Gem.marshal_version}&quot;</span>)
 99:     <span class="ruby-ivar">@dest_prerelease_specs_index</span> =
100:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@dest_directory</span>, <span class="ruby-node">&quot;prerelease_specs.#{Gem.marshal_version}&quot;</span>)
101: 
102:     <span class="ruby-ivar">@rss_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-value str">'index.rss'</span>
103: 
104:     <span class="ruby-ivar">@files</span> = []
105:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M006774">
                    
                    <a name="M006774"></a><b>abbreviate</b>(spec)
                    
                </div>
                
                <div class="description">
                  <p>
Abbreviate the spec for downloading. Abbreviated specs are only used for
searching, downloading and related activities and do not need deployment
specific information (e.g. list of files). So we abbreviate the spec,
making it much smaller for quicker downloads.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006774_source')" id="l_M006774_source">show</a>
                        
                    </p>
                    <div id="M006774_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 113</span>
113:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">abbreviate</span>(<span class="ruby-identifier">spec</span>)
114:     <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">files</span> = []
115:     <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">test_files</span> = []
116:     <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">rdoc_options</span> = []
117:     <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">extra_rdoc_files</span> = []
118:     <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">cert_chain</span> = []
119:     <span class="ruby-identifier">spec</span>
120:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006775">
                    
                    <a name="M006775"></a><b>build_indicies</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Build various indicies
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006775_source')" id="l_M006775_source">show</a>
                        
                    </p>
                    <div id="M006775_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 125</span>
125:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">build_indicies</span>
126:     <span class="ruby-comment cmt"># Marshal gemspecs are used by both modern and legacy RubyGems</span>
127: 
128:     <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Specification</span>.<span class="ruby-identifier">dirs</span> = []
129:     <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Specification</span>.<span class="ruby-identifier">add_specs</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">map_gems_to_specs</span>(<span class="ruby-identifier">gem_file_list</span>))
130: 
131:     <span class="ruby-identifier">build_marshal_gemspecs</span>
132:     <span class="ruby-identifier">build_legacy_indicies</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@build_legacy</span>
133:     <span class="ruby-identifier">build_modern_indicies</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@build_modern</span>
134:     <span class="ruby-identifier">build_rss</span>
135: 
136:     <span class="ruby-identifier">compress_indicies</span>
137:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006776">
                    
                    <a name="M006776"></a><b>build_legacy_indicies</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Builds indicies for RubyGems older than 1.2.x
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006776_source')" id="l_M006776_source">show</a>
                        
                    </p>
                    <div id="M006776_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 142</span>
142:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">build_legacy_indicies</span>
143:     <span class="ruby-identifier">index</span> = <span class="ruby-identifier">collect_specs</span>
144: 
145:     <span class="ruby-identifier">say</span> <span class="ruby-value str">&quot;Generating Marshal master index&quot;</span>
146: 
147:     <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-value str">'Generated Marshal master index'</span> <span class="ruby-keyword kw">do</span>
148:       <span class="ruby-identifier">open</span> <span class="ruby-ivar">@marshal_index</span>, <span class="ruby-value str">'wb'</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
149:         <span class="ruby-identifier">io</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">index</span>.<span class="ruby-identifier">dump</span>
150:       <span class="ruby-keyword kw">end</span>
151:     <span class="ruby-keyword kw">end</span>
152: 
153:     <span class="ruby-ivar">@files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@marshal_index</span>
154:     <span class="ruby-ivar">@files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{@marshal_index}.Z&quot;</span>
155:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006777">
                    
                    <a name="M006777"></a><b>build_marshal_gemspecs</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Builds <a href="../Marshal.html">Marshal</a> quick index gemspecs.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006777_source')" id="l_M006777_source">show</a>
                        
                    </p>
                    <div id="M006777_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 160</span>
160:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">build_marshal_gemspecs</span>
161:     <span class="ruby-identifier">count</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Specification</span>.<span class="ruby-identifier">count</span>
162:     <span class="ruby-identifier">progress</span> = <span class="ruby-identifier">ui</span>.<span class="ruby-identifier">progress_reporter</span> <span class="ruby-identifier">count</span>,
163:                                     <span class="ruby-node">&quot;Generating Marshal quick index gemspecs for #{count} gems&quot;</span>,
164:                                     <span class="ruby-value str">&quot;Complete&quot;</span>
165: 
166:     <span class="ruby-identifier">files</span> = []
167: 
168:     <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-value str">'Generated Marshal quick index gemspecs'</span> <span class="ruby-keyword kw">do</span>
169:       <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Specification</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
170:         <span class="ruby-identifier">spec_file_name</span> = <span class="ruby-node">&quot;#{spec.original_name}.gemspec.rz&quot;</span>
171:         <span class="ruby-identifier">marshal_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@quick_marshal_dir</span>, <span class="ruby-identifier">spec_file_name</span>
172: 
173:         <span class="ruby-identifier">marshal_zipped</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">deflate</span> <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">spec</span>)
174:         <span class="ruby-identifier">open</span> <span class="ruby-identifier">marshal_name</span>, <span class="ruby-value str">'wb'</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">marshal_zipped</span> <span class="ruby-keyword kw">end</span>
175: 
176:         <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">marshal_name</span>
177: 
178:         <span class="ruby-identifier">progress</span>.<span class="ruby-identifier">updated</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">original_name</span>
179:       <span class="ruby-keyword kw">end</span>
180: 
181:       <span class="ruby-identifier">progress</span>.<span class="ruby-identifier">done</span>
182:     <span class="ruby-keyword kw">end</span>
183: 
184:     <span class="ruby-ivar">@files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@quick_marshal_dir</span>
185: 
186:     <span class="ruby-identifier">files</span>
187:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006778">
                    
                    <a name="M006778"></a><b>build_modern_index</b>(index, file, name)
                    
                </div>
                
                <div class="description">
                  <p>
Build a single index for RubyGems 1.2 and newer
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006778_source')" id="l_M006778_source">show</a>
                        
                    </p>
                    <div id="M006778_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 192</span>
192:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">build_modern_index</span>(<span class="ruby-identifier">index</span>, <span class="ruby-identifier">file</span>, <span class="ruby-identifier">name</span>)
193:     <span class="ruby-identifier">say</span> <span class="ruby-node">&quot;Generating #{name} index&quot;</span>
194: 
195:     <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-node">&quot;Generated #{name} index&quot;</span> <span class="ruby-keyword kw">do</span>
196:       <span class="ruby-identifier">open</span>(<span class="ruby-identifier">file</span>, <span class="ruby-value str">'wb'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
197:         <span class="ruby-identifier">specs</span> = <span class="ruby-identifier">index</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-operator">*</span><span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
198:           <span class="ruby-comment cmt"># We have to splat here because latest_specs is an array, while the</span>
199:           <span class="ruby-comment cmt"># others are hashes.</span>
200:           <span class="ruby-identifier">spec</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">last</span>
201:           <span class="ruby-identifier">platform</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">original_platform</span>
202: 
203:           <span class="ruby-comment cmt"># win32-api-1.0.4-x86-mswin32-60</span>
204:           <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">String</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">platform</span> <span class="ruby-keyword kw">then</span>
205:             <span class="ruby-identifier">alert_warning</span> <span class="ruby-node">&quot;Skipping invalid platform in gem: #{spec.full_name}&quot;</span>
206:             <span class="ruby-keyword kw">next</span>
207:           <span class="ruby-keyword kw">end</span>
208: 
209:           <span class="ruby-identifier">platform</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Platform</span><span class="ruby-operator">::</span><span class="ruby-constant">RUBY</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">platform</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">platform</span>.<span class="ruby-identifier">empty?</span>
210:           [<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">version</span>, <span class="ruby-identifier">platform</span>]
211:         <span class="ruby-keyword kw">end</span>
212: 
213:         <span class="ruby-identifier">specs</span> = <span class="ruby-identifier">compact_specs</span>(<span class="ruby-identifier">specs</span>)
214:         <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">specs</span>, <span class="ruby-identifier">io</span>)
215:       <span class="ruby-keyword kw">end</span>
216:     <span class="ruby-keyword kw">end</span>
217:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006780">
                    
                    <a name="M006780"></a><b>build_modern_indicies</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Builds indicies for RubyGems 1.2 and newer. Handles full, latest,
prerelease
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006780_source')" id="l_M006780_source">show</a>
                        
                    </p>
                    <div id="M006780_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 222</span>
222:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">build_modern_indicies</span>
223:     <span class="ruby-identifier">prerelease</span>, <span class="ruby-identifier">released</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Specification</span>.<span class="ruby-identifier">partition</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
224:       <span class="ruby-identifier">s</span>.<span class="ruby-identifier">version</span>.<span class="ruby-identifier">prerelease?</span>
225:     }
226:     <span class="ruby-identifier">latest_specs</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Specification</span>.<span class="ruby-identifier">latest_specs</span>
227: 
228:     <span class="ruby-identifier">build_modern_index</span>(<span class="ruby-identifier">released</span>.<span class="ruby-identifier">sort</span>, <span class="ruby-ivar">@specs_index</span>, <span class="ruby-value str">'specs'</span>)
229:     <span class="ruby-identifier">build_modern_index</span>(<span class="ruby-identifier">latest_specs</span>.<span class="ruby-identifier">sort</span>, <span class="ruby-ivar">@latest_specs_index</span>, <span class="ruby-value str">'latest specs'</span>)
230:     <span class="ruby-identifier">build_modern_index</span>(<span class="ruby-identifier">prerelease</span>.<span class="ruby-identifier">sort</span>, <span class="ruby-ivar">@prerelease_specs_index</span>,
231:                        <span class="ruby-value str">'prerelease specs'</span>)
232: 
233:     <span class="ruby-ivar">@files</span> <span class="ruby-operator">+=</span> [<span class="ruby-ivar">@specs_index</span>,
234:                <span class="ruby-node">&quot;#{@specs_index}.gz&quot;</span>,
235:                <span class="ruby-ivar">@latest_specs_index</span>,
236:                <span class="ruby-node">&quot;#{@latest_specs_index}.gz&quot;</span>,
237:                <span class="ruby-ivar">@prerelease_specs_index</span>,
238:                <span class="ruby-node">&quot;#{@prerelease_specs_index}.gz&quot;</span>]
239:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006781">
                    
                    <a name="M006781"></a><b>build_rss</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Builds an <a href="../RSS.html">RSS</a> feed for past two days gem releases
according to the gem&#8217;s date.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006781_source')" id="l_M006781_source">show</a>
                        
                    </p>
                    <div id="M006781_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 245</span>
245:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">build_rss</span>
246:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@rss_host</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-ivar">@rss_gems_host</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">then</span>
247:       <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">configuration</span>.<span class="ruby-identifier">really_verbose</span> <span class="ruby-keyword kw">then</span>
248:         <span class="ruby-identifier">alert_warning</span> <span class="ruby-value str">&quot;no --rss-host or --rss-gems-host, RSS generation disabled&quot;</span>
249:       <span class="ruby-keyword kw">end</span>
250:       <span class="ruby-keyword kw">return</span>
251:     <span class="ruby-keyword kw">end</span>
252: 
253:     <span class="ruby-identifier">require</span> <span class="ruby-value str">'cgi'</span>
254:     <span class="ruby-identifier">require</span> <span class="ruby-value str">'rubygems/text'</span>
255: 
256:     <span class="ruby-identifier">extend</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Text</span>
257: 
258:     <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-value str">'Generated rss'</span> <span class="ruby-keyword kw">do</span>
259:       <span class="ruby-identifier">open</span> <span class="ruby-ivar">@rss_index</span>, <span class="ruby-value str">'wb'</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
260:         <span class="ruby-identifier">rss_host</span> = <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">escapeHTML</span> <span class="ruby-ivar">@rss_host</span>
261:         <span class="ruby-identifier">rss_title</span> = <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">escapeHTML</span>(<span class="ruby-ivar">@rss_title</span> <span class="ruby-operator">||</span> <span class="ruby-value str">'gems'</span>)
262: 
263:         <span class="ruby-identifier">io</span>.<span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&lt;rss version=\&quot;2.0\&quot;&gt;\n&lt;channel&gt;\n&lt;title&gt;\#{rss_title}&lt;/title&gt;\n&lt;link&gt;http://\#{rss_host}&lt;/link&gt;\n&lt;description&gt;Recently released gems from http://\#{rss_host}&lt;/description&gt;\n&lt;generator&gt;RubyGems v\#{Gem::VERSION}&lt;/generator&gt;\n&lt;docs&gt;http://cyber.law.harvard.edu/rss/rss.html&lt;/docs&gt;\n&quot;</span>
264: 
265:         <span class="ruby-identifier">today</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Specification</span><span class="ruby-operator">::</span><span class="ruby-constant">TODAY</span>
266:         <span class="ruby-identifier">yesterday</span> = <span class="ruby-identifier">today</span> <span class="ruby-operator">-</span> <span class="ruby-value">86400</span>
267: 
268:         <span class="ruby-identifier">index</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Specification</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
269:           <span class="ruby-identifier">spec_date</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">date</span>
270:           <span class="ruby-comment cmt"># TODO: remove this and make YAML based specs properly normalized</span>
271:           <span class="ruby-identifier">spec_date</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">spec_date</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Date</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">spec_date</span>
272: 
273:           <span class="ruby-identifier">spec_date</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">yesterday</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">spec_date</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">today</span>
274:         <span class="ruby-keyword kw">end</span>
275: 
276:         <span class="ruby-identifier">index</span>.<span class="ruby-identifier">sort_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">spec</span><span class="ruby-operator">|</span> [<span class="ruby-operator">-</span><span class="ruby-identifier">spec</span>.<span class="ruby-identifier">date</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">spec</span>] }.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
277:           <span class="ruby-identifier">file_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">basename</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">cache_file</span>
278:           <span class="ruby-identifier">gem_path</span> = <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">escapeHTML</span> <span class="ruby-node">&quot;http://#{@rss_gems_host}/gems/#{file_name}&quot;</span>
279:           <span class="ruby-identifier">size</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">stat</span>(<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">loaded_from</span>).<span class="ruby-identifier">size</span> <span class="ruby-comment cmt"># rescue next</span>
280: 
281:           <span class="ruby-identifier">description</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">description</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">summary</span> <span class="ruby-operator">||</span> <span class="ruby-value str">''</span>
282:           <span class="ruby-identifier">authors</span> = <span class="ruby-constant">Array</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">authors</span>
283:           <span class="ruby-identifier">emails</span> = <span class="ruby-constant">Array</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">email</span>
284:           <span class="ruby-identifier">authors</span> = <span class="ruby-identifier">emails</span>.<span class="ruby-identifier">zip</span>(<span class="ruby-identifier">authors</span>).<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">email</span>, <span class="ruby-identifier">author</span><span class="ruby-operator">|</span>
285:             <span class="ruby-identifier">email</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot; (#{author})&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">author</span> <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">author</span>.<span class="ruby-identifier">empty?</span>
286:           <span class="ruby-keyword kw">end</span>.<span class="ruby-identifier">join</span> <span class="ruby-value str">', '</span>
287: 
288:           <span class="ruby-identifier">description</span> = <span class="ruby-identifier">description</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp re">/\n\n+/</span>).<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">chunk</span><span class="ruby-operator">|</span>
289:             <span class="ruby-identifier">format_text</span> <span class="ruby-identifier">chunk</span>, <span class="ruby-value">78</span>
290:           <span class="ruby-keyword kw">end</span>
291: 
292:           <span class="ruby-identifier">description</span> = <span class="ruby-identifier">description</span>.<span class="ruby-identifier">join</span> <span class="ruby-value str">&quot;\n\n&quot;</span>
293: 
294:           <span class="ruby-identifier">item</span> = <span class="ruby-value str">''</span>
295: 
296:           <span class="ruby-identifier">item</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;item&gt;\n&lt;title&gt;\#{CGI.escapeHTML spec.full_name}&lt;/title&gt;\n&lt;description&gt;\n&amp;lt;pre&amp;gt;\#{CGI.escapeHTML description.chomp}&amp;lt;/pre&amp;gt;\n&lt;/description&gt;\n&lt;author&gt;\#{CGI.escapeHTML authors}&lt;/author&gt;\n&lt;guid&gt;\#{CGI.escapeHTML spec.full_name}&lt;/guid&gt;\n&lt;enclosure url=\\\&quot;\#{gem_path}\\\&quot;\nlength=\\\&quot;\#{size}\\\&quot; type=\\\&quot;application/octet-stream\\\&quot; /&gt;\n&lt;pubDate&gt;\#{spec.date.rfc2822}&lt;/pubDate&gt;\n&quot;</span>
297: 
298:           <span class="ruby-identifier">item</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;link&gt;\#{CGI.escapeHTML spec.homepage}&lt;/link&gt;\n&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">homepage</span>
299: 
300:           <span class="ruby-identifier">item</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;/item&gt;\n&quot;</span>
301: 
302:           <span class="ruby-identifier">io</span>.<span class="ruby-identifier">puts</span> <span class="ruby-identifier">item</span>
303:         <span class="ruby-keyword kw">end</span>
304: 
305:         <span class="ruby-identifier">io</span>.<span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;&lt;/channel&gt;\n&lt;/rss&gt;\n&quot;</span>
306:       <span class="ruby-keyword kw">end</span>
307:     <span class="ruby-keyword kw">end</span>
308: 
309:     <span class="ruby-ivar">@files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@rss_index</span>
310:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006783">
                    
                    <a name="M006783"></a><b>collect_specs</b>(gems = gem_file_list)
                    
                </div>
                
                <div class="description">
                  <p>
Collect specifications from .gem files from the gem directory.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006783_source')" id="l_M006783_source">show</a>
                        
                    </p>
                    <div id="M006783_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 384</span>
384:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">collect_specs</span>(<span class="ruby-identifier">gems</span> = <span class="ruby-identifier">gem_file_list</span>)
385:     <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Deprecate</span>.<span class="ruby-identifier">skip_during</span> <span class="ruby-keyword kw">do</span>
386:       <span class="ruby-identifier">index</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">SourceIndex</span>.<span class="ruby-identifier">new</span>
387: 
388:       <span class="ruby-identifier">map_gems_to_specs</span>(<span class="ruby-identifier">gems</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
389:         <span class="ruby-identifier">index</span>.<span class="ruby-identifier">add_spec</span> <span class="ruby-identifier">spec</span>, <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">original_name</span>
390:       <span class="ruby-keyword kw">end</span>
391: 
392:       <span class="ruby-identifier">index</span>
393:     <span class="ruby-keyword kw">end</span>
394:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006785">
                    
                    <a name="M006785"></a><b>compact_specs</b>(specs)
                    
                </div>
                
                <div class="description">
                  <p>
Compacts <a href="../Marshal.html">Marshal</a> output for the specs index
data source by using identical objects as much as possible.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006785_source')" id="l_M006785_source">show</a>
                        
                    </p>
                    <div id="M006785_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 422</span>
422:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">compact_specs</span>(<span class="ruby-identifier">specs</span>)
423:     <span class="ruby-identifier">names</span> = {}
424:     <span class="ruby-identifier">versions</span> = {}
425:     <span class="ruby-identifier">platforms</span> = {}
426: 
427:     <span class="ruby-identifier">specs</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">version</span>, <span class="ruby-identifier">platform</span>)<span class="ruby-operator">|</span>
428:       <span class="ruby-identifier">names</span>[<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">names</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">name</span>
429:       <span class="ruby-identifier">versions</span>[<span class="ruby-identifier">version</span>] = <span class="ruby-identifier">version</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">versions</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">version</span>
430:       <span class="ruby-identifier">platforms</span>[<span class="ruby-identifier">platform</span>] = <span class="ruby-identifier">platform</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">platforms</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">platform</span>
431: 
432:       [<span class="ruby-identifier">names</span>[<span class="ruby-identifier">name</span>], <span class="ruby-identifier">versions</span>[<span class="ruby-identifier">version</span>], <span class="ruby-identifier">platforms</span>[<span class="ruby-identifier">platform</span>]]
433:     <span class="ruby-keyword kw">end</span>
434:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006786">
                    
                    <a name="M006786"></a><b>compress</b>(filename, extension)
                    
                </div>
                
                <div class="description">
                  <p>
Compress <tt>filename</tt> with <tt>extension</tt>.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006786_source')" id="l_M006786_source">show</a>
                        
                    </p>
                    <div id="M006786_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 439</span>
439:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">compress</span>(<span class="ruby-identifier">filename</span>, <span class="ruby-identifier">extension</span>)
440:     <span class="ruby-identifier">data</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">read_binary</span> <span class="ruby-identifier">filename</span>
441: 
442:     <span class="ruby-identifier">zipped</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">deflate</span> <span class="ruby-identifier">data</span>
443: 
444:     <span class="ruby-identifier">open</span> <span class="ruby-node">&quot;#{filename}.#{extension}&quot;</span>, <span class="ruby-value str">'wb'</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
445:       <span class="ruby-identifier">io</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">zipped</span>
446:     <span class="ruby-keyword kw">end</span>
447:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006784">
                    
                    <a name="M006784"></a><b>compress_indicies</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Compresses indicies on disk
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006784_source')" id="l_M006784_source">show</a>
                        
                    </p>
                    <div id="M006784_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 401</span>
401:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">compress_indicies</span>
402:     <span class="ruby-identifier">say</span> <span class="ruby-value str">&quot;Compressing indicies&quot;</span>
403: 
404:     <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-value str">'Compressed indicies'</span> <span class="ruby-keyword kw">do</span>
405:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@build_legacy</span> <span class="ruby-keyword kw">then</span>
406:         <span class="ruby-identifier">compress</span> <span class="ruby-ivar">@marshal_index</span>, <span class="ruby-value str">'Z'</span>
407:         <span class="ruby-identifier">paranoid</span> <span class="ruby-ivar">@marshal_index</span>, <span class="ruby-value str">'Z'</span>
408:       <span class="ruby-keyword kw">end</span>
409: 
410:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@build_modern</span> <span class="ruby-keyword kw">then</span>
411:         <span class="ruby-identifier">gzip</span> <span class="ruby-ivar">@specs_index</span>
412:         <span class="ruby-identifier">gzip</span> <span class="ruby-ivar">@latest_specs_index</span>
413:         <span class="ruby-identifier">gzip</span> <span class="ruby-ivar">@prerelease_specs_index</span>
414:       <span class="ruby-keyword kw">end</span>
415:     <span class="ruby-keyword kw">end</span>
416:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006789">
                    
                    <a name="M006789"></a><b>gem_file_list</b>()
                    
                </div>
                
                <div class="description">
                  <p>
List of gem file names to index.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006789_source')" id="l_M006789_source">show</a>
                        
                    </p>
                    <div id="M006789_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 452</span>
452:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gem_file_list</span>
453:     <span class="ruby-constant">Dir</span>[<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@dest_directory</span>, <span class="ruby-value str">&quot;gems&quot;</span>, <span class="ruby-value str">'*.gem'</span>)]
454:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006790">
                    
                    <a name="M006790"></a><b>generate_index</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Builds and installs indicies.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006790_source')" id="l_M006790_source">show</a>
                        
                    </p>
                    <div id="M006790_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 459</span>
459:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">generate_index</span>
460:     <span class="ruby-identifier">make_temp_directories</span>
461:     <span class="ruby-identifier">build_indicies</span>
462:     <span class="ruby-identifier">install_indicies</span>
463:   <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SignalException</span>
464:   <span class="ruby-keyword kw">ensure</span>
465:     <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_rf</span> <span class="ruby-ivar">@directory</span>
466:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006791">
                    
                    <a name="M006791"></a><b>gzip</b>(filename)
                    
                </div>
                
                <div class="description">
                  <p>
<a href="../Zlib/GzipWriter.html">Zlib::GzipWriter</a> wrapper that gzips
<tt>filename</tt> on disk.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006791_source')" id="l_M006791_source">show</a>
                        
                    </p>
                    <div id="M006791_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 471</span>
471:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gzip</span>(<span class="ruby-identifier">filename</span>)
472:     <span class="ruby-constant">Zlib</span><span class="ruby-operator">::</span><span class="ruby-constant">GzipWriter</span>.<span class="ruby-identifier">open</span> <span class="ruby-node">&quot;#{filename}.gz&quot;</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
473:       <span class="ruby-identifier">io</span>.<span class="ruby-identifier">write</span> <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">read_binary</span>(<span class="ruby-identifier">filename</span>)
474:     <span class="ruby-keyword kw">end</span>
475:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006795">
                    
                    <a name="M006795"></a><b>install_indicies</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Install generated indicies into the destination directory.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006795_source')" id="l_M006795_source">show</a>
                        
                    </p>
                    <div id="M006795_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 480</span>
480:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">install_indicies</span>
481:     <span class="ruby-identifier">verbose</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">configuration</span>.<span class="ruby-identifier">really_verbose</span>
482: 
483:     <span class="ruby-identifier">say</span> <span class="ruby-node">&quot;Moving index into production dir #{@dest_directory}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">verbose</span>
484: 
485:     <span class="ruby-identifier">files</span> = <span class="ruby-ivar">@files</span>
486:     <span class="ruby-identifier">files</span>.<span class="ruby-identifier">delete</span> <span class="ruby-ivar">@quick_marshal_dir</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">files</span>.<span class="ruby-identifier">include?</span> <span class="ruby-ivar">@quick_dir</span>
487: 
488:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">files</span>.<span class="ruby-identifier">include?</span> <span class="ruby-ivar">@quick_marshal_dir</span> <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">files</span>.<span class="ruby-identifier">include?</span> <span class="ruby-ivar">@quick_dir</span> <span class="ruby-keyword kw">then</span>
489:       <span class="ruby-identifier">files</span>.<span class="ruby-identifier">delete</span> <span class="ruby-ivar">@quick_marshal_dir</span>
490: 
491:       <span class="ruby-identifier">dst_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@dest_directory</span>, <span class="ruby-ivar">@quick_marshal_dir_base</span>)
492: 
493:       <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">dirname</span>(<span class="ruby-identifier">dst_name</span>), <span class="ruby-identifier">:verbose</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">verbose</span>
494:       <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_rf</span> <span class="ruby-identifier">dst_name</span>, <span class="ruby-identifier">:verbose</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">verbose</span>
495:       <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mv</span>(<span class="ruby-ivar">@quick_marshal_dir</span>, <span class="ruby-identifier">dst_name</span>,
496:                    <span class="ruby-identifier">:verbose</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">verbose</span>, <span class="ruby-identifier">:force</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>)
497:     <span class="ruby-keyword kw">end</span>
498: 
499:     <span class="ruby-identifier">files</span> = <span class="ruby-identifier">files</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">path</span><span class="ruby-operator">|</span>
500:       <span class="ruby-identifier">path</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-node">/^#{Regexp.escape @directory}\/?/</span>, <span class="ruby-value str">''</span>) <span class="ruby-comment cmt"># HACK?</span>
501:     <span class="ruby-keyword kw">end</span>
502: 
503:     <span class="ruby-identifier">files</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span>
504:       <span class="ruby-identifier">src_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-identifier">file</span>
505:       <span class="ruby-identifier">dst_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@dest_directory</span>, <span class="ruby-identifier">file</span>
506: 
507:       <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_rf</span> <span class="ruby-identifier">dst_name</span>, <span class="ruby-identifier">:verbose</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">verbose</span>
508:       <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mv</span>(<span class="ruby-identifier">src_name</span>, <span class="ruby-ivar">@dest_directory</span>,
509:                    <span class="ruby-identifier">:verbose</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">verbose</span>, <span class="ruby-identifier">:force</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>)
510:     <span class="ruby-keyword kw">end</span>
511:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006797">
                    
                    <a name="M006797"></a><b>make_temp_directories</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Make directories for index generation
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006797_source')" id="l_M006797_source">show</a>
                        
                    </p>
                    <div id="M006797_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 516</span>
516:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">make_temp_directories</span>
517:     <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_rf</span> <span class="ruby-ivar">@directory</span>
518:     <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-identifier">:mode</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0700</span>
519:     <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-ivar">@quick_marshal_dir</span>
520:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006782">
                    
                    <a name="M006782"></a><b>map_gems_to_specs</b>(gems)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006782_source')" id="l_M006782_source">show</a>
                        
                    </p>
                    <div id="M006782_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 344</span>
344:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">map_gems_to_specs</span> <span class="ruby-identifier">gems</span>
345:     <span class="ruby-identifier">gems</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">gemfile</span><span class="ruby-operator">|</span>
346:       <span class="ruby-keyword kw">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">size</span>(<span class="ruby-identifier">gemfile</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">then</span>
347:         <span class="ruby-identifier">alert_warning</span> <span class="ruby-node">&quot;Skipping zero-length gem: #{gemfile}&quot;</span>
348:         <span class="ruby-keyword kw">next</span>
349:       <span class="ruby-keyword kw">end</span>
350: 
351:       <span class="ruby-keyword kw">begin</span>
352:         <span class="ruby-identifier">spec</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">from_file_by_path</span>(<span class="ruby-identifier">gemfile</span>).<span class="ruby-identifier">spec</span>
353:         <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">loaded_from</span> = <span class="ruby-identifier">gemfile</span>
354: 
355:         <span class="ruby-comment cmt"># HACK: fuck this shit - borks all tests that use pl1</span>
356:         <span class="ruby-comment cmt"># if File.basename(gemfile, &quot;.gem&quot;) != spec.original_name then</span>
357:         <span class="ruby-comment cmt">#   exp = spec.full_name</span>
358:         <span class="ruby-comment cmt">#   exp &lt;&lt; &quot; (#{spec.original_name})&quot; if</span>
359:         <span class="ruby-comment cmt">#     spec.original_name != spec.full_name</span>
360:         <span class="ruby-comment cmt">#   msg = &quot;Skipping misnamed gem: #{gemfile} should be named #{exp}&quot;</span>
361:         <span class="ruby-comment cmt">#   alert_warning msg</span>
362:         <span class="ruby-comment cmt">#   next</span>
363:         <span class="ruby-comment cmt"># end</span>
364: 
365:         <span class="ruby-identifier">abbreviate</span> <span class="ruby-identifier">spec</span>
366:         <span class="ruby-identifier">sanitize</span> <span class="ruby-identifier">spec</span>
367: 
368:         <span class="ruby-identifier">spec</span>
369:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SignalException</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
370:         <span class="ruby-identifier">alert_error</span> <span class="ruby-value str">&quot;Received signal, exiting&quot;</span>
371:         <span class="ruby-identifier">raise</span>
372:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
373:         <span class="ruby-identifier">msg</span> = [<span class="ruby-node">&quot;Unable to process #{gemfile}&quot;</span>,
374:                <span class="ruby-node">&quot;#{e.message} (#{e.class})&quot;</span>,
375:                <span class="ruby-node">&quot;\t#{e.backtrace.join &quot;\n\t&quot;}&quot;</span>].<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;\n&quot;</span>)
376:         <span class="ruby-identifier">alert_error</span> <span class="ruby-identifier">msg</span>
377:       <span class="ruby-keyword kw">end</span>
378:     }.<span class="ruby-identifier">compact</span>
379:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006798">
                    
                    <a name="M006798"></a><b>paranoid</b>(path, extension)
                    
                </div>
                
                <div class="description">
                  <p>
Ensure <tt>path</tt> and path with <tt>extension</tt> are identical.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006798_source')" id="l_M006798_source">show</a>
                        
                    </p>
                    <div id="M006798_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 525</span>
525:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">paranoid</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">extension</span>)
526:     <span class="ruby-identifier">data</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">read_binary</span> <span class="ruby-identifier">path</span>
527:     <span class="ruby-identifier">compressed_data</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">read_binary</span> <span class="ruby-node">&quot;#{path}.#{extension}&quot;</span>
528: 
529:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">data</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">inflate</span>(<span class="ruby-identifier">compressed_data</span>) <span class="ruby-keyword kw">then</span>
530:       <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Compressed file #{compressed_path} does not match uncompressed file #{path}&quot;</span>
531:     <span class="ruby-keyword kw">end</span>
532:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006799">
                    
                    <a name="M006799"></a><b>sanitize</b>(spec)
                    
                </div>
                
                <div class="description">
                  <p>
Sanitize the descriptive fields in the spec. Sometimes non-ASCII characters
will garble the site index. Non-ASCII characters will be replaced by their
<a href="../XML.html">XML</a> entity equivalent.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006799_source')" id="l_M006799_source">show</a>
                        
                    </p>
                    <div id="M006799_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 539</span>
539:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sanitize</span>(<span class="ruby-identifier">spec</span>)
540:     <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">summary</span>              = <span class="ruby-identifier">sanitize_string</span>(<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">summary</span>)
541:     <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">description</span>          = <span class="ruby-identifier">sanitize_string</span>(<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">description</span>)
542:     <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">post_install_message</span> = <span class="ruby-identifier">sanitize_string</span>(<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">post_install_message</span>)
543:     <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">authors</span>              = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">authors</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sanitize_string</span>(<span class="ruby-identifier">a</span>) }
544: 
545:     <span class="ruby-identifier">spec</span>
546:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006800">
                    
                    <a name="M006800"></a><b>sanitize_string</b>(string)
                    
                </div>
                
                <div class="description">
                  <p>
Sanitize a single string.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006800_source')" id="l_M006800_source">show</a>
                        
                    </p>
                    <div id="M006800_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 551</span>
551:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sanitize_string</span>(<span class="ruby-identifier">string</span>)
552:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">string</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">string</span>
553: 
554:     <span class="ruby-comment cmt"># HACK the #to_s is in here because RSpec has an Array of Arrays of</span>
555:     <span class="ruby-comment cmt"># Strings for authors.  Need a way to disallow bad values on gemspec</span>
556:     <span class="ruby-comment cmt"># generation.  (Probably won't happen.)</span>
557:     <span class="ruby-identifier">string</span> = <span class="ruby-identifier">string</span>.<span class="ruby-identifier">to_s</span>
558: 
559:     <span class="ruby-keyword kw">begin</span>
560:       <span class="ruby-constant">Builder</span><span class="ruby-operator">::</span><span class="ruby-constant">XChar</span>.<span class="ruby-identifier">encode</span> <span class="ruby-identifier">string</span>
561:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">NameError</span>, <span class="ruby-constant">NoMethodError</span>
562:       <span class="ruby-identifier">string</span>.<span class="ruby-identifier">to_xs</span>
563:     <span class="ruby-keyword kw">end</span>
564:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006801">
                    
                    <a name="M006801"></a><b>update_index</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Perform an in-place update of the repository from newly added gems. Only
works for modern indicies, and sets <a
href="Indexer.html#build_legacy">build_legacy</a> to false when run.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006801_source')" id="l_M006801_source">show</a>
                        
                    </p>
                    <div id="M006801_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 570</span>
570:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_index</span>
571:     <span class="ruby-ivar">@build_legacy</span> = <span class="ruby-keyword kw">false</span>
572: 
573:     <span class="ruby-identifier">make_temp_directories</span>
574: 
575:     <span class="ruby-identifier">specs_mtime</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">stat</span>(<span class="ruby-ivar">@dest_specs_index</span>).<span class="ruby-identifier">mtime</span>
576:     <span class="ruby-identifier">newest_mtime</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">at</span> <span class="ruby-value">0</span>
577: 
578:     <span class="ruby-identifier">updated_gems</span> = <span class="ruby-identifier">gem_file_list</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">gem</span><span class="ruby-operator">|</span>
579:       <span class="ruby-identifier">gem_mtime</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">stat</span>(<span class="ruby-identifier">gem</span>).<span class="ruby-identifier">mtime</span>
580:       <span class="ruby-identifier">newest_mtime</span> = <span class="ruby-identifier">gem_mtime</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">gem_mtime</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">newest_mtime</span>
581:       <span class="ruby-identifier">gem_mtime</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">specs_mtime</span>
582:     <span class="ruby-keyword kw">end</span>
583: 
584:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">updated_gems</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-keyword kw">then</span>
585:       <span class="ruby-identifier">say</span> <span class="ruby-value str">'No new gems'</span>
586:       <span class="ruby-identifier">terminate_interaction</span> <span class="ruby-value">0</span>
587:     <span class="ruby-keyword kw">end</span>
588: 
589:     <span class="ruby-identifier">specs</span> = <span class="ruby-identifier">map_gems_to_specs</span> <span class="ruby-identifier">updated_gems</span>
590:     <span class="ruby-identifier">prerelease</span>, <span class="ruby-identifier">released</span> = <span class="ruby-identifier">specs</span>.<span class="ruby-identifier">partition</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">version</span>.<span class="ruby-identifier">prerelease?</span> }
591: 
592:     <span class="ruby-identifier">files</span> = <span class="ruby-identifier">build_marshal_gemspecs</span>
593: 
594:     <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-value str">'Updated indexes'</span> <span class="ruby-keyword kw">do</span>
595:       <span class="ruby-identifier">update_specs_index</span> <span class="ruby-identifier">released</span>, <span class="ruby-ivar">@dest_specs_index</span>, <span class="ruby-ivar">@specs_index</span>
596:       <span class="ruby-identifier">update_specs_index</span> <span class="ruby-identifier">released</span>, <span class="ruby-ivar">@dest_latest_specs_index</span>, <span class="ruby-ivar">@latest_specs_index</span>
597:       <span class="ruby-identifier">update_specs_index</span>(<span class="ruby-identifier">prerelease</span>,
598:                          <span class="ruby-ivar">@dest_prerelease_specs_index</span>,
599:                          <span class="ruby-ivar">@prerelease_specs_index</span>)
600:     <span class="ruby-keyword kw">end</span>
601: 
602:     <span class="ruby-identifier">compress_indicies</span>
603: 
604:     <span class="ruby-identifier">verbose</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">configuration</span>.<span class="ruby-identifier">really_verbose</span>
605: 
606:     <span class="ruby-identifier">say</span> <span class="ruby-node">&quot;Updating production dir #{@dest_directory}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">verbose</span>
607: 
608:     <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@specs_index</span>
609:     <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{@specs_index}.gz&quot;</span>
610:     <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@latest_specs_index</span>
611:     <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{@latest_specs_index}.gz&quot;</span>
612:     <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@prerelease_specs_index</span>
613:     <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{@prerelease_specs_index}.gz&quot;</span>
614: 
615:     <span class="ruby-identifier">files</span> = <span class="ruby-identifier">files</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">path</span><span class="ruby-operator">|</span>
616:       <span class="ruby-identifier">path</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-node">/^#{Regexp.escape @directory}\/?/</span>, <span class="ruby-value str">''</span>) <span class="ruby-comment cmt"># HACK?</span>
617:     <span class="ruby-keyword kw">end</span>
618: 
619:     <span class="ruby-identifier">files</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span>
620:       <span class="ruby-identifier">src_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-identifier">file</span>
621:       <span class="ruby-identifier">dst_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@dest_directory</span>, <span class="ruby-identifier">file</span> <span class="ruby-comment cmt"># REFACTOR: duped above</span>
622: 
623:       <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mv</span> <span class="ruby-identifier">src_name</span>, <span class="ruby-identifier">dst_name</span>, <span class="ruby-identifier">:verbose</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">verbose</span>,
624:                    <span class="ruby-identifier">:force</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
625: 
626:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">utime</span> <span class="ruby-identifier">newest_mtime</span>, <span class="ruby-identifier">newest_mtime</span>, <span class="ruby-identifier">dst_name</span>
627:     <span class="ruby-keyword kw">end</span>
628:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M006808">
                    
                    <a name="M006808"></a><b>update_specs_index</b>(index, source, dest)
                    
                </div>
                
                <div class="description">
                  <p>
Combines specs in <tt>index</tt> and <tt>source</tt> then writes out a new
copy to <tt>dest</tt>. For a latest index, does not ensure the new file is
minimal.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M006808_source')" id="l_M006808_source">show</a>
                        
                    </p>
                    <div id="M006808_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/rubygems/indexer.rb, line 634</span>
634:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_specs_index</span>(<span class="ruby-identifier">index</span>, <span class="ruby-identifier">source</span>, <span class="ruby-identifier">dest</span>)
635:     <span class="ruby-identifier">specs_index</span> = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">load</span> <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">read_binary</span>(<span class="ruby-identifier">source</span>)
636: 
637:     <span class="ruby-identifier">index</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
638:       <span class="ruby-identifier">platform</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">original_platform</span>
639:       <span class="ruby-identifier">platform</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Platform</span><span class="ruby-operator">::</span><span class="ruby-constant">RUBY</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">platform</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">platform</span>.<span class="ruby-identifier">empty?</span>
640:       <span class="ruby-identifier">specs_index</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">version</span>, <span class="ruby-identifier">platform</span>]
641:     <span class="ruby-keyword kw">end</span>
642: 
643:     <span class="ruby-identifier">specs_index</span> = <span class="ruby-identifier">compact_specs</span> <span class="ruby-identifier">specs_index</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">sort</span>
644: 
645:     <span class="ruby-identifier">open</span> <span class="ruby-identifier">dest</span>, <span class="ruby-value str">'wb'</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
646:       <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">dump</span> <span class="ruby-identifier">specs_index</span>, <span class="ruby-identifier">io</span>
647:     <span class="ruby-keyword kw">end</span>
648:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    