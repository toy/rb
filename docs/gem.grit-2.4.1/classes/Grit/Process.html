<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Grit::Process</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
    <script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            Grit::Process 
            
                <span class="parent">&lt; 
                    
                    Object
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/grit/jruby_rb.html">lib/grit/jruby.rb</a></li>
            
            <li><a href="../../files/lib/grit/process_rb.html">lib/grit/process.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
<a href="Process.html">Grit::Process</a> includes logic for executing child
processes and reading/writing from their standard input, output, and error
streams.
</p>
<p>
Create an run a process to completion:
</p>
<pre>
  &gt;&gt; process = Grit::Process.new(['git', '--help'])
</pre>
<p>
Retrieve stdout or stderr output:
</p>
<pre>
  &gt;&gt; process.out
  =&gt; &quot;usage: git [--version] [--exec-path[=GIT_EXEC_PATH]]\n ...&quot;
  &gt;&gt; process.err
  =&gt; &quot;&quot;
</pre>
<p>
Check process exit status information:
</p>
<pre>
  &gt;&gt; process.status
  =&gt; #&lt;Process::Status: pid=80718,exited(0)&gt;
</pre>
<p>
<a href="Process.html">Grit::Process</a> is designed to take all input in a
single string and provides all output as single strings. It is therefore
not well suited to streaming large quantities of data in and out of
commands.
</p>
<p>
Q: Why not use popen3 or hand-roll fork/exec code?
</p>
<ul>
<li>It&#8217;s more efficient than popen3 and provides meaningful process
hierarchies because it performs a single fork/exec. (popen3 double forks to
avoid needing to collect the exit status and also calls Process::detach
which creates a Ruby Thread!!!!).

</li>
<li>It&#8217;s more portable than hand rolled pipe, fork, exec code because
fork(2) and exec(2) aren&#8217;t available on all platforms. In those
cases, <a href="Process.html">Grit::Process</a> falls back to using
whatever janky substitutes the platform provides.

</li>
<li>It handles all max pipe buffer hang cases, which is non trivial to
implement correctly and must be accounted for with either popen3 or hand
rolled fork/exec code.

</li>
</ul>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>E</dt>
        <dd>
            <ul>
                
                <li><a href="#M000277">exec!</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M000273">new</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M000282">popen4</a>,</li>
                
                <li><a href="#M000265">popen4</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000280">read_and_write</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M000285">spawn</a>,</li>
                
                <li><a href="#M000281">spawn</a>,</li>
                
                <li><a href="#M000276">success?</a></li>
                
            </ul>
        </dd>
    
        <dt>W</dt>
        <dd>
            <ul>
                
                <li><a href="#M000283">waitpid</a>,</li>
                
                <li><a href="#M000267">waitpid</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    
    <div class="sectiontitle">Classes and Modules</div>
    <ul>
        
        <li><span class="type">CLASS</span> <a href="Process/MaximumOutputExceeded.html">Grit::Process::MaximumOutputExceeded</a></li>
        
        <li><span class="type">CLASS</span> <a href="Process/TimeoutExceeded.html">Grit::Process::TimeoutExceeded</a></li>
        
    </ul>
    

    
    <div class="sectiontitle">Constants</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class="attr-name">FakeStatus</td>
            <td>=</td>
            <td class="attr-value">Struct.new(:pid, :exitstatus, :success?, :fake?)</td>
        </tr>
        
        <tr valign='top'>
            <td>&nbsp;</td>
            <td colspan="2" class="attr-desc"><p>
JRuby always raises ECHILD on pids returned from its IO.popen4 method for
some reason. Return a fake <a href="Status.html">Process::Status</a>
object.
</p>
</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">BUFSIZE</td>
            <td>=</td>
            <td class="attr-value">(32 * 1024)</td>
        </tr>
        
        <tr valign='top'>
            <td>&nbsp;</td>
            <td colspan="2" class="attr-desc"><p>
Maximum buffer size for reading
</p>
</td>
        </tr>
        
        
    </table>
    

    
    <div class="sectiontitle">Attributes</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>out</td>
            <td class='attr-desc'><p>
All data written to the child process&#8217;s stdout stream as a <a
href="../String.html">String</a>.
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>err</td>
            <td class='attr-desc'><p>
All data written to the child process&#8217;s stderr stream as a <a
href="../String.html">String</a>.
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>status</td>
            <td class='attr-desc'><p>
A <a href="Status.html">Process::Status</a> object with information on how
the child exited.
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>runtime</td>
            <td class='attr-desc'><p>
Total command execution time (wall-clock time)
</p></td>
        </tr>
        
    </table>
    

    
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000265">
                    
                    <a name="M000265"></a><b>popen4</b>(*argv)
                    
                </div>
                
                <div class="description">
                  <p>
Use JRuby&#8217;s built in IO.popen4 but emulate the special spawn env and
options arguments as best we can.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000265_source')" id="l_M000265_source">show</a>
                        
                    </p>
                    <div id="M000265_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/grit/jruby.rb, line 9</span>
 9:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">popen4</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">argv</span>)
10:       <span class="ruby-identifier">env</span> = (<span class="ruby-identifier">argv</span>.<span class="ruby-identifier">shift</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">argv</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>))  <span class="ruby-operator">||</span> {}
11:       <span class="ruby-identifier">opt</span> = (<span class="ruby-identifier">argv</span>.<span class="ruby-identifier">pop</span>   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">argv</span>[<span class="ruby-value">-1</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>)) <span class="ruby-operator">||</span> {}
12: 
13:       <span class="ruby-comment cmt"># emulate :chdir option</span>
14:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">opt</span>[<span class="ruby-identifier">:chdir</span>]
15:         <span class="ruby-identifier">previous_dir</span> = <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">pwd</span>
16:         <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">chdir</span>(<span class="ruby-identifier">opt</span>[<span class="ruby-identifier">:chdir</span>])
17:       <span class="ruby-keyword kw">else</span>
18:         <span class="ruby-identifier">previous_dir</span> = <span class="ruby-keyword kw">nil</span>
19:       <span class="ruby-keyword kw">end</span>
20: 
21:       <span class="ruby-comment cmt"># emulate :env option</span>
22:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">env</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
23:         <span class="ruby-identifier">previous_env</span> = <span class="ruby-constant">ENV</span>
24:         <span class="ruby-constant">ENV</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-identifier">env</span>)
25:       <span class="ruby-keyword kw">else</span>
26:         <span class="ruby-identifier">previous_env</span> = <span class="ruby-keyword kw">nil</span>
27:       <span class="ruby-keyword kw">end</span>
28: 
29:       <span class="ruby-identifier">pid</span>, <span class="ruby-identifier">stdin</span>, <span class="ruby-identifier">stdout</span>, <span class="ruby-identifier">stderr</span> = <span class="ruby-constant">IO</span>.<span class="ruby-identifier">popen4</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">argv</span>)
30:     <span class="ruby-keyword kw">ensure</span>
31:       <span class="ruby-constant">ENV</span>.<span class="ruby-identifier">replace</span>(<span class="ruby-identifier">previous_env</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">previous_env</span>
32:       <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">chdir</span>(<span class="ruby-identifier">previous_dir</span>)   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">previous_dir</span>
33:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000276">
                    
                    <a name="M000276"></a><b>success?</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Determine if the process did exit with a zero exit status.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000276_source')" id="l_M000276_source">show</a>
                        
                    </p>
                    <div id="M000276_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/grit/process.rb, line 84</span>
84:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">success?</span>
85:       <span class="ruby-ivar">@status</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@status</span>.<span class="ruby-identifier">success?</span>
86:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000267">
                    
                    <a name="M000267"></a><b>waitpid</b>(pid)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000267_source')" id="l_M000267_source">show</a>
                        
                    </p>
                    <div id="M000267_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/grit/jruby.rb, line 38</span>
38:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">waitpid</span>(<span class="ruby-identifier">pid</span>)
39:       <span class="ruby-operator">::</span><span class="ruby-constant">Process</span><span class="ruby-operator">::</span><span class="ruby-identifier">waitpid</span>(<span class="ruby-identifier">pid</span>)
40:       <span class="ruby-identifier">$?</span>
41:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECHILD</span>
42:       <span class="ruby-constant">FakeStatus</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">pid</span>, <span class="ruby-value">0</span>, <span class="ruby-keyword kw">true</span>, <span class="ruby-keyword kw">true</span>)
43:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Private methods</div>
            
            <div class="method">
                <div class="title" id="M000277">
                    
                    <a name="M000277"></a><b>exec!</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Execute command, write input, and read output. This is called immediately
when a new instance of this object is initialized.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000277_source')" id="l_M000277_source">show</a>
                        
                    </p>
                    <div id="M000277_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/grit/process.rb, line 91</span>
 91:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">exec!</span>
 92:       <span class="ruby-comment cmt"># when argv is a string, use /bin/sh to interpret command</span>
 93:       <span class="ruby-identifier">argv</span> = <span class="ruby-ivar">@argv</span>
 94:       <span class="ruby-identifier">argv</span> = [<span class="ruby-value str">'/bin/sh'</span>, <span class="ruby-value str">'-c'</span>, <span class="ruby-identifier">argv</span>.<span class="ruby-identifier">to_str</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">argv</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:to_str</span>)
 95: 
 96:       <span class="ruby-comment cmt"># spawn the process and hook up the pipes</span>
 97:       <span class="ruby-identifier">pid</span>, <span class="ruby-identifier">stdin</span>, <span class="ruby-identifier">stdout</span>, <span class="ruby-identifier">stderr</span> = <span class="ruby-identifier">popen4</span>(<span class="ruby-ivar">@env</span>, <span class="ruby-operator">*</span>(<span class="ruby-identifier">argv</span> <span class="ruby-operator">+</span> [<span class="ruby-ivar">@options</span>]))
 98: 
 99:       <span class="ruby-comment cmt"># async read from all streams into buffers</span>
100:       <span class="ruby-ivar">@out</span>, <span class="ruby-ivar">@err</span> = <span class="ruby-identifier">read_and_write</span>(<span class="ruby-ivar">@input</span>, <span class="ruby-identifier">stdin</span>, <span class="ruby-identifier">stdout</span>, <span class="ruby-identifier">stderr</span>, <span class="ruby-ivar">@timeout</span>, <span class="ruby-ivar">@max</span>)
101: 
102:       <span class="ruby-comment cmt"># grab exit status</span>
103:       <span class="ruby-ivar">@status</span> = <span class="ruby-identifier">waitpid</span>(<span class="ruby-identifier">pid</span>)
104:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Object</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">boom</span>
105:       [<span class="ruby-identifier">stdin</span>, <span class="ruby-identifier">stdout</span>, <span class="ruby-identifier">stderr</span>].<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">fd</span><span class="ruby-operator">|</span> <span class="ruby-identifier">fd</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span> }
106:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@status</span>.<span class="ruby-identifier">nil?</span>
107:         <span class="ruby-operator">::</span><span class="ruby-constant">Process</span>.<span class="ruby-identifier">kill</span>(<span class="ruby-value str">'TERM'</span>, <span class="ruby-identifier">pid</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
108:         <span class="ruby-ivar">@status</span> = <span class="ruby-identifier">waitpid</span>(<span class="ruby-identifier">pid</span>)      <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
109:       <span class="ruby-keyword kw">end</span>
110:       <span class="ruby-identifier">raise</span>
111:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000282">
                    
                    <a name="M000282"></a><b>popen4</b>(*argv)
                    
                </div>
                
                <div class="description">
                  <p>
Start a process with spawn options and return popen4([env], command, arg1,
arg2, [opt])
</p>
<pre>
  env     - The child process's environment as a Hash.
  command - The command and zero or more arguments.
  options - An options hash.
</pre>
<p>
See Ruby 1.9 IO.popen and Process::spawn docs for more info: <a
href="http://www.ruby-doc.org/core-1.9/classes/IO.html#M001640">www.ruby-doc.org/core-1.9/classes/IO.html#M001640</a>
</p>
<p>
Returns a [pid, stdin, stderr, stdout] tuple where pid is the child
process&#8217;s pid, stdin is a writeable IO object, and stdout + stderr
are readable IO objects.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000282_source')" id="l_M000282_source">show</a>
                        
                    </p>
                    <div id="M000282_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/grit/process.rb, line 257</span>
257:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">popen4</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">argv</span>)
258:       <span class="ruby-comment cmt"># create some pipes (see pipe(2) manual -- the ruby docs suck)</span>
259:       <span class="ruby-identifier">ird</span>, <span class="ruby-identifier">iwr</span> = <span class="ruby-constant">IO</span>.<span class="ruby-identifier">pipe</span>
260:       <span class="ruby-identifier">ord</span>, <span class="ruby-identifier">owr</span> = <span class="ruby-constant">IO</span>.<span class="ruby-identifier">pipe</span>
261:       <span class="ruby-identifier">erd</span>, <span class="ruby-identifier">ewr</span> = <span class="ruby-constant">IO</span>.<span class="ruby-identifier">pipe</span>
262: 
263:       <span class="ruby-comment cmt"># spawn the child process with either end of pipes hooked together</span>
264:       <span class="ruby-identifier">opts</span> =
265:         ((<span class="ruby-identifier">argv</span>.<span class="ruby-identifier">pop</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">argv</span>[<span class="ruby-value">-1</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>)) <span class="ruby-operator">||</span> {}).<span class="ruby-identifier">merge</span>(
266:           <span class="ruby-comment cmt"># redirect fds        # close other sides</span>
267:           <span class="ruby-identifier">:in</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ird</span>,          <span class="ruby-identifier">iwr</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:close</span>,
268:           <span class="ruby-identifier">:out</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">owr</span>,          <span class="ruby-identifier">ord</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:close</span>,
269:           <span class="ruby-identifier">:err</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ewr</span>,          <span class="ruby-identifier">erd</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:close</span>
270:         )
271:       <span class="ruby-identifier">pid</span> = <span class="ruby-identifier">spawn</span>(<span class="ruby-operator">*</span>(<span class="ruby-identifier">argv</span> <span class="ruby-operator">+</span> [<span class="ruby-identifier">opts</span>]))
272: 
273:       [<span class="ruby-identifier">pid</span>, <span class="ruby-identifier">iwr</span>, <span class="ruby-identifier">ord</span>, <span class="ruby-identifier">erd</span>]
274:     <span class="ruby-keyword kw">ensure</span>
275:       <span class="ruby-comment cmt"># we're in the parent, close child-side fds</span>
276:       [<span class="ruby-identifier">ird</span>, <span class="ruby-identifier">owr</span>, <span class="ruby-identifier">ewr</span>].<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">fd</span><span class="ruby-operator">|</span> <span class="ruby-identifier">fd</span>.<span class="ruby-identifier">close</span> }
277:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000280">
                    
                    <a name="M000280"></a><b>read_and_write</b>(input, stdin, stdout, stderr, timeout=nil, max=nil)
                    
                </div>
                
                <div class="description">
                  <p>
Start a select loop writing any input on the child&#8217;s stdin and
reading any output from the child&#8217;s stdout or stderr.
</p>
<p>
input - <a href="../String.html">String</a> input to write on stdin. May be
nil. stdin - The write side IO object for the child&#8217;s stdin stream.
stdout - The read side IO object for the child&#8217;s stdout stream.
stderr - The read side IO object for the child&#8217;s stderr stream.
timeout - An optional Numeric specifying the total number of seconds
</p>
<pre>
          the read/write operations should occur for.
</pre>
<p>
Returns an [out, err] tuple where both elements are strings with all
</p>
<pre>
  data written to the stdout and stderr streams, respectively.
</pre>
<p>
Raises <a href="Process/TimeoutExceeded.html">TimeoutExceeded</a> when all
data has not been read / written within
</p>
<pre>
  the duration specified in the timeout argument.
</pre>
<p>
Raises <a
href="Process/MaximumOutputExceeded.html">MaximumOutputExceeded</a> when
the total number of bytes output
</p>
<pre>
  exceeds the amount specified by the max argument.
</pre>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000280_source')" id="l_M000280_source">show</a>
                        
                    </p>
                    <div id="M000280_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/grit/process.rb, line 141</span>
141:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_and_write</span>(<span class="ruby-identifier">input</span>, <span class="ruby-identifier">stdin</span>, <span class="ruby-identifier">stdout</span>, <span class="ruby-identifier">stderr</span>, <span class="ruby-identifier">timeout</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">max</span>=<span class="ruby-keyword kw">nil</span>)
142:       <span class="ruby-identifier">input</span> <span class="ruby-operator">||=</span> <span class="ruby-value str">''</span>
143:       <span class="ruby-identifier">max</span> = <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">max</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">max</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">0</span>
144:       <span class="ruby-identifier">out</span>, <span class="ruby-identifier">err</span> = <span class="ruby-value str">''</span>, <span class="ruby-value str">''</span>
145:       <span class="ruby-identifier">offset</span> = <span class="ruby-value">0</span>
146: 
147:       <span class="ruby-identifier">timeout</span> = <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">timeout</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">timeout</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">0</span><span class="ruby-value">.0</span>
148:       <span class="ruby-ivar">@runtime</span> = <span class="ruby-value">0</span><span class="ruby-value">.0</span>
149:       <span class="ruby-identifier">start</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
150: 
151:       <span class="ruby-identifier">writers</span> = [<span class="ruby-identifier">stdin</span>]
152:       <span class="ruby-identifier">readers</span> = [<span class="ruby-identifier">stdout</span>, <span class="ruby-identifier">stderr</span>]
153:       <span class="ruby-identifier">t</span> = <span class="ruby-identifier">timeout</span>
154:       <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">readers</span>.<span class="ruby-identifier">any?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">writers</span>.<span class="ruby-identifier">any?</span>
155:         <span class="ruby-identifier">ready</span> = <span class="ruby-constant">IO</span>.<span class="ruby-identifier">select</span>(<span class="ruby-identifier">readers</span>, <span class="ruby-identifier">writers</span>, <span class="ruby-identifier">readers</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">writers</span>, <span class="ruby-identifier">t</span>)
156:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">TimeoutExceeded</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">ready</span>.<span class="ruby-identifier">nil?</span>
157: 
158:         <span class="ruby-comment cmt"># write to stdin stream</span>
159:         <span class="ruby-identifier">ready</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fd</span><span class="ruby-operator">|</span>
160:           <span class="ruby-keyword kw">begin</span>
161:             <span class="ruby-identifier">boom</span> = <span class="ruby-keyword kw">nil</span>
162:             <span class="ruby-identifier">size</span> = <span class="ruby-identifier">fd</span>.<span class="ruby-identifier">write_nonblock</span>(<span class="ruby-identifier">input</span>)
163:             <span class="ruby-identifier">input</span> = <span class="ruby-identifier">input</span>[<span class="ruby-identifier">size</span>, <span class="ruby-identifier">input</span>.<span class="ruby-identifier">size</span>]
164:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EPIPE</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">boom</span>
165:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EAGAIN</span>, <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EINTR</span>
166:           <span class="ruby-keyword kw">end</span>
167:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">boom</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">input</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
168:             <span class="ruby-identifier">stdin</span>.<span class="ruby-identifier">close</span>
169:             <span class="ruby-identifier">writers</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">stdin</span>)
170:           <span class="ruby-keyword kw">end</span>
171:         <span class="ruby-keyword kw">end</span>
172: 
173:         <span class="ruby-comment cmt"># read from stdout and stderr streams</span>
174:         <span class="ruby-identifier">ready</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fd</span><span class="ruby-operator">|</span>
175:           <span class="ruby-identifier">buf</span> = (<span class="ruby-identifier">fd</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">stdout</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">out</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">err</span>
176:           <span class="ruby-keyword kw">begin</span>
177:             <span class="ruby-identifier">buf</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">fd</span>.<span class="ruby-identifier">readpartial</span>(<span class="ruby-constant">BUFSIZE</span>)
178:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EAGAIN</span>, <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EINTR</span>
179:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">EOFError</span>
180:             <span class="ruby-identifier">readers</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">fd</span>)
181:             <span class="ruby-identifier">fd</span>.<span class="ruby-identifier">close</span>
182:           <span class="ruby-keyword kw">end</span>
183:         <span class="ruby-keyword kw">end</span>
184: 
185:         <span class="ruby-comment cmt"># keep tabs on the total amount of time we've spent here</span>
186:         <span class="ruby-ivar">@runtime</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">start</span>
187:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">timeout</span>
188:           <span class="ruby-identifier">t</span> = <span class="ruby-identifier">timeout</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@runtime</span>
189:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">TimeoutExceeded</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">t</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span><span class="ruby-value">.0</span>
190:         <span class="ruby-keyword kw">end</span>
191: 
192:         <span class="ruby-comment cmt"># maybe we've hit our max output</span>
193:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">max</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ready</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">any?</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">out</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">err</span>.<span class="ruby-identifier">size</span>) <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">max</span>
194:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">MaximumOutputExceeded</span>
195:         <span class="ruby-keyword kw">end</span>
196:       <span class="ruby-keyword kw">end</span>
197: 
198:       [<span class="ruby-identifier">out</span>, <span class="ruby-identifier">err</span>]
199:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000285">
                    
                    <a name="M000285"></a><b>spawn</b>(*argv)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000285_source')" id="l_M000285_source">show</a>
                        
                    </p>
                    <div id="M000285_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/grit/process.rb, line 289</span>
289:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">spawn</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">argv</span>)
290:         <span class="ruby-operator">::</span><span class="ruby-constant">Process</span>.<span class="ruby-identifier">spawn</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">argv</span>)
291:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000281">
                    
                    <a name="M000281"></a><b>spawn</b>(env, *argv)
                    
                </div>
                
                <div class="description">
                  <p>
Spawn a child process, perform IO redirection and environment prep, and
return the running process&#8217;s pid.
</p>
<p>
This method implements a limited subset of Ruby 1.9&#8217;s Process::spawn.
The idea is that we can just use that when available, since most platforms
will eventually build in special (and hopefully good) support for it.
</p>
<pre>
  env     - Hash of { name =&gt; val } environment variables set in the child
            process.
  argv    - New process's argv as an Array. When this value is a string,
            the command may be run through the system /bin/sh or
  options - Supports a subset of Process::spawn options, including:
            :chdir =&gt; str to change the directory to str in the child
                FD =&gt; :close to close a file descriptor in the child
               :in =&gt; FD to redirect child's stdin to FD
              :out =&gt; FD to redirect child's stdout to FD
              :err =&gt; FD to redirect child's stderr to FD
</pre>
<p>
Returns the pid of the new process as an integer. The process exit status
must be obtained using Process::waitpid.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000281_source')" id="l_M000281_source">show</a>
                        
                    </p>
                    <div id="M000281_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/grit/process.rb, line 221</span>
221:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">spawn</span>(<span class="ruby-identifier">env</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">argv</span>)
222:       <span class="ruby-identifier">options</span> = (<span class="ruby-identifier">argv</span>.<span class="ruby-identifier">pop</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">argv</span>[<span class="ruby-value">-1</span>].<span class="ruby-identifier">kind_of?</span>(<span class="ruby-constant">Hash</span>)) <span class="ruby-operator">||</span> {}
223:       <span class="ruby-identifier">fork</span> <span class="ruby-keyword kw">do</span>
224:         <span class="ruby-comment cmt"># { fd =&gt; :close } in options means close that fd</span>
225:         <span class="ruby-identifier">options</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:close</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">k</span>.<span class="ruby-identifier">closed?</span> }
226: 
227:         <span class="ruby-comment cmt"># reopen stdin, stdout, and stderr on provided fds</span>
228:         <span class="ruby-constant">STDIN</span>.<span class="ruby-identifier">reopen</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:in</span>])
229:         <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">reopen</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:out</span>])
230:         <span class="ruby-constant">STDERR</span>.<span class="ruby-identifier">reopen</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:err</span>])
231: 
232:         <span class="ruby-comment cmt"># setup child environment</span>
233:         <span class="ruby-identifier">env</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-constant">ENV</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">v</span> }
234: 
235:         <span class="ruby-comment cmt"># { :chdir =&gt; '/' } in options means change into that dir</span>
236:         <span class="ruby-operator">::</span><span class="ruby-constant">Dir</span>.<span class="ruby-identifier">chdir</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:chdir</span>]) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:chdir</span>]
237: 
238:         <span class="ruby-comment cmt"># do the deed</span>
239:         <span class="ruby-operator">::</span><span class="ruby-constant">Kernel</span><span class="ruby-operator">::</span><span class="ruby-identifier">exec</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">argv</span>)
240:         <span class="ruby-identifier">exit!</span> <span class="ruby-value">1</span>
241:       <span class="ruby-keyword kw">end</span>
242:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000283">
                    
                    <a name="M000283"></a><b>waitpid</b>(pid)
                    
                </div>
                
                <div class="description">
                  <p>
Wait for the child process to exit
</p>
<p>
Returns the <a href="Status.html">Process::Status</a> object obtained by
reaping the process.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000283_source')" id="l_M000283_source">show</a>
                        
                    </p>
                    <div id="M000283_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/grit/process.rb, line 282</span>
282:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">waitpid</span>(<span class="ruby-identifier">pid</span>)
283:       <span class="ruby-operator">::</span><span class="ruby-constant">Process</span><span class="ruby-operator">::</span><span class="ruby-identifier">waitpid</span>(<span class="ruby-identifier">pid</span>)
284:       <span class="ruby-identifier">$?</span>
285:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M000273">
                    
                    <a name="M000273"></a><b>new</b>(argv, env={}, options={})
                    
                </div>
                
                <div class="description">
                  <p>
Create and execute a new process.
</p>
<p>
argv - Array of [command, arg1, &#8230;] strings to use as the new
</p>
<pre>
          process's argv. When argv is a String, the shell is used
          to interpret the command.
</pre>
<p>
env - The new process&#8217;s environment variables. This is merged with
</p>
<pre>
          the current environment as if by ENV.merge(env).
</pre>
<p>
options - Additional options:
</p>
<pre>
            :input   =&gt; str to write str to the process's stdin.
            :timeout =&gt; int number of seconds before we given up.
            :max     =&gt; total number of output bytes
          A subset of Process:spawn options are also supported on all
          platforms:
            :chdir =&gt; str to start the process in different working dir.
</pre>
<p>
Returns a new <a href="Process.html">Process</a> instance that has already
executed to completion. The out, err, and status attributes are immediately
available.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000273_source')" id="l_M000273_source">show</a>
                        
                    </p>
                    <div id="M000273_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/grit/process.rb, line 58</span>
58:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">argv</span>, <span class="ruby-identifier">env</span>={}, <span class="ruby-identifier">options</span>={})
59:       <span class="ruby-ivar">@argv</span> = <span class="ruby-identifier">argv</span>
60:       <span class="ruby-ivar">@env</span> = <span class="ruby-identifier">env</span>
61: 
62:       <span class="ruby-ivar">@options</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">dup</span>
63:       <span class="ruby-ivar">@input</span> = <span class="ruby-ivar">@options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">:input</span>)
64:       <span class="ruby-ivar">@timeout</span> = <span class="ruby-ivar">@options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">:timeout</span>)
65:       <span class="ruby-ivar">@max</span> = <span class="ruby-ivar">@options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">:max</span>)
66:       <span class="ruby-ivar">@options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">:chdir</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@options</span>[<span class="ruby-identifier">:chdir</span>].<span class="ruby-identifier">nil?</span>
67: 
68:       <span class="ruby-identifier">exec!</span>
69:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    