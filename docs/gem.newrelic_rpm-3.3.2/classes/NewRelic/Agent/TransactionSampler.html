<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>NewRelic::Agent::TransactionSampler</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../../css/main.css" type="text/css" media="screen" />
    <script src="../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            NewRelic::Agent::TransactionSampler 
            
                <span class="parent">&lt; 
                    
                    <a href="../../Object.html">Object</a>
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../files/lib/new_relic/agent/transaction_sampler_rb.html">lib/new_relic/agent/transaction_sampler.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
This class contains the logic of sampling a transaction - creation and
modification of transaction samples
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>A</dt>
        <dd>
            <ul>
                
                <li><a href="#M000559">add_force_persist_to</a>,</li>
                
                <li><a href="#M000558">add_random_sample_to</a>,</li>
                
                <li><a href="#M000560">add_samples_to</a>,</li>
                
                <li><a href="#M000555">append_backtrace</a>,</li>
                
                <li><a href="#M000554">append_new_message</a></li>
                
            </ul>
        </dd>
    
        <dt>B</dt>
        <dd>
            <ul>
                
                <li><a href="#M000570">builder</a></li>
                
            </ul>
        </dd>
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M000534">capture_segment_trace</a>,</li>
                
                <li><a href="#M000564">clamp_number_tts</a>,</li>
                
                <li><a href="#M000572">clear_builder</a>,</li>
                
                <li><a href="#M000522">config</a>,</li>
                
                <li><a href="#M000521">configure!</a>,</li>
                
                <li><a href="#M000523">current_sample_id</a></li>
                
            </ul>
        </dd>
    
        <dt>D</dt>
        <dd>
            <ul>
                
                <li><a href="#M000525">disable</a></li>
                
            </ul>
        </dd>
    
        <dt>E</dt>
        <dd>
            <ul>
                
                <li><a href="#M000524">enable</a>,</li>
                
                <li><a href="#M000528">enabled?</a></li>
                
            </ul>
        </dd>
    
        <dt>H</dt>
        <dd>
            <ul>
                
                <li><a href="#M000561">harvest</a></li>
                
            </ul>
        </dd>
    
        <dt>I</dt>
        <dd>
            <ul>
                
                <li><a href="#M000549">ignore_transaction</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M000520">new</a>,</li>
                
                <li><a href="#M000552">notice_extra_data</a>,</li>
                
                <li><a href="#M000530">notice_first_scope_push</a>,</li>
                
                <li><a href="#M000557">notice_nosql</a>,</li>
                
                <li><a href="#M000539">notice_pop_scope</a>,</li>
                
                <li><a href="#M000550">notice_profile</a>,</li>
                
                <li><a href="#M000531">notice_push_scope</a>,</li>
                
                <li><a href="#M000540">notice_scope_empty</a>,</li>
                
                <li><a href="#M000556">notice_sql</a>,</li>
                
                <li><a href="#M000548">notice_transaction</a>,</li>
                
                <li><a href="#M000551">notice_transaction_cpu_time</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000565">reset!</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M000529">sampling_rate=</a>,</li>
                
                <li><a href="#M000538">scope_depth</a>,</li>
                
                <li><a href="#M000546">slowest_sample?</a>,</li>
                
                <li><a href="#M000569">start_builder</a>,</li>
                
                <li><a href="#M000543">store_force_persist</a>,</li>
                
                <li><a href="#M000542">store_random_sample</a>,</li>
                
                <li><a href="#M000541">store_sample</a>,</li>
                
                <li><a href="#M000544">store_sample_for_developer_mode</a>,</li>
                
                <li><a href="#M000545">store_slowest_sample</a></li>
                
            </ul>
        </dd>
    
        <dt>T</dt>
        <dd>
            <ul>
                
                <li><a href="#M000553">truncate_message</a>,</li>
                
                <li><a href="#M000547">truncate_samples</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    
    <div class="sectiontitle">Classes and Modules</div>
    <ul>
        
        <li><span class="type">MODULE</span> <a href="TransactionSampler/Shim.html">NewRelic::Agent::TransactionSampler::Shim</a></li>
        
    </ul>
    

    
    <div class="sectiontitle">Constants</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class="attr-name">BUILDER_KEY</td>
            <td>=</td>
            <td class="attr-value">:transaction_sample_builder</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">MAX_DATA_LENGTH</td>
            <td>=</td>
            <td class="attr-value">16384</td>
        </tr>
        
        
    </table>
    

    
    <div class="sectiontitle">Attributes</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>stack_trace_threshold</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>random_sampling</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>sampling_rate</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>explain_threshold</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>explain_enabled</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>transaction_threshold</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>slow_capture_threshold</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>samples</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>last_sample</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>disabled</td>
            <td class='attr-desc'></td>
        </tr>
        
    </table>
    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M000520">
                    
                    <a name="M000520"></a><b>new</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000520_source')" id="l_M000520_source">show</a>
                        
                    </p>
                    <div id="M000520_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 27</span>
27:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>
28:         <span class="ruby-comment cmt"># @samples is an array of recent samples up to @max_samples in</span>
29:         <span class="ruby-comment cmt"># size - it's only used by developer mode</span>
30:         <span class="ruby-ivar">@samples</span> = []
31:         <span class="ruby-ivar">@force_persist</span> = []
32:         <span class="ruby-ivar">@max_samples</span> = <span class="ruby-value">100</span>
33: 
34:         <span class="ruby-comment cmt"># @harvest_count is a count of harvests used for random</span>
35:         <span class="ruby-comment cmt"># sampling - we pull 1 @random_sample in every @sampling_rate harvests</span>
36:         <span class="ruby-ivar">@harvest_count</span> = <span class="ruby-value">0</span>
37:         <span class="ruby-ivar">@random_sample</span> = <span class="ruby-keyword kw">nil</span>
38:         <span class="ruby-ivar">@sampling_rate</span> = <span class="ruby-value">10</span>
39:         <span class="ruby-ivar">@slow_capture_threshold</span> = <span class="ruby-value">2.0</span>
40:         <span class="ruby-identifier">configure!</span>
41: 
42:         <span class="ruby-comment cmt"># This lock is used to synchronize access to the @last_sample</span>
43:         <span class="ruby-comment cmt"># and related variables. It can become necessary on JRuby or</span>
44:         <span class="ruby-comment cmt"># any 'honest-to-god'-multithreaded system</span>
45:         <span class="ruby-ivar">@samples_lock</span> = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>
46:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000559">
                    
                    <a name="M000559"></a><b>add_force_persist_to</b>(result)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000559_source')" id="l_M000559_source">show</a>
                        
                    </p>
                    <div id="M000559_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 351</span>
351:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_force_persist_to</span>(<span class="ruby-identifier">result</span>)
352:         <span class="ruby-identifier">result</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-ivar">@force_persist</span>)
353:         <span class="ruby-ivar">@force_persist</span> = []
354:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000558">
                    
                    <a name="M000558"></a><b>add_random_sample_to</b>(result)
                    
                </div>
                
                <div class="description">
                  <p>
Every 1/n harvests, adds the most recent sample to the harvest array if it
exists. Makes sure that the random sample is not also the slowest sample
for this harvest by `uniq!`ing the result array
</p>
<p>
random sampling is very, very seldom used
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000558_source')" id="l_M000558_source">show</a>
                        
                    </p>
                    <div id="M000558_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 341</span>
341:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_random_sample_to</span>(<span class="ruby-identifier">result</span>)
342:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@random_sampling</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@sampling_rate</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@sampling_rate</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
343:         <span class="ruby-ivar">@harvest_count</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
344:         <span class="ruby-keyword kw">if</span> (<span class="ruby-ivar">@harvest_count</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">%</span> <span class="ruby-ivar">@sampling_rate</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
345:           <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@random_sample</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@random_sample</span>
346:           <span class="ruby-ivar">@harvest_count</span> = <span class="ruby-value">0</span>
347:         <span class="ruby-keyword kw">end</span>
348:         <span class="ruby-keyword kw">nil</span> <span class="ruby-comment cmt"># don't assume this method returns anything</span>
349:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000560">
                    
                    <a name="M000560"></a><b>add_samples_to</b>(result, slow_threshold)
                    
                </div>
                
                <div class="description">
                  <p>
Returns an array of slow samples, with either one or two elements - one
element unless random sampling is enabled. The sample returned will be the
slowest sample among those available during this harvest
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000560_source')" id="l_M000560_source">show</a>
                        
                    </p>
                    <div id="M000560_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 360</span>
360:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_samples_to</span>(<span class="ruby-identifier">result</span>, <span class="ruby-identifier">slow_threshold</span>)
361:         
362:         <span class="ruby-comment cmt"># pull out force persist</span>
363:         <span class="ruby-identifier">force_persist</span> = <span class="ruby-identifier">result</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">sample</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sample</span>.<span class="ruby-identifier">force_persist</span>} <span class="ruby-operator">||</span> []
364:         <span class="ruby-identifier">result</span>.<span class="ruby-identifier">reject!</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">sample</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sample</span>.<span class="ruby-identifier">force_persist</span>}
365:         
366:         <span class="ruby-identifier">force_persist</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">sample</span><span class="ruby-operator">|</span> <span class="ruby-identifier">store_force_persist</span>(<span class="ruby-identifier">sample</span>)}
367:         
368:         
369:         <span class="ruby-comment cmt"># Now get the slowest sample</span>
370:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@slowest_sample</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@slowest_sample</span>.<span class="ruby-identifier">duration</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">slow_threshold</span>
371:           <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@slowest_sample</span>
372:         <span class="ruby-keyword kw">end</span>
373: 
374:         <span class="ruby-identifier">result</span>.<span class="ruby-identifier">compact!</span>
375:         <span class="ruby-identifier">result</span> = <span class="ruby-identifier">result</span>.<span class="ruby-identifier">sort_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span> <span class="ruby-identifier">x</span>.<span class="ruby-identifier">duration</span> }
376:         <span class="ruby-identifier">result</span> = <span class="ruby-identifier">result</span>[<span class="ruby-value">-1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] <span class="ruby-operator">||</span> []               <span class="ruby-comment cmt"># take the slowest sample</span>
377:         
378:         <span class="ruby-identifier">add_random_sample_to</span>(<span class="ruby-identifier">result</span>)
379:         <span class="ruby-identifier">add_force_persist_to</span>(<span class="ruby-identifier">result</span>)
380:         
381:         <span class="ruby-identifier">result</span>.<span class="ruby-identifier">uniq</span>
382:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000555">
                    
                    <a name="M000555"></a><b>append_backtrace</b>(segment, duration)
                    
                </div>
                
                <div class="description">
                  <p>
Appends a backtrace to a segment if that segment took longer than the
specified duration
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000555_source')" id="l_M000555_source">show</a>
                        
                    </p>
                    <div id="M000555_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 313</span>
313:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">append_backtrace</span>(<span class="ruby-identifier">segment</span>, <span class="ruby-identifier">duration</span>)
314:         <span class="ruby-identifier">segment</span>[<span class="ruby-identifier">:backtrace</span>] = <span class="ruby-identifier">caller</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;\n&quot;</span>) <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">duration</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-ivar">@stack_trace_threshold</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">:capture_deep_tt</span>])
315:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000554">
                    
                    <a name="M000554"></a><b>append_new_message</b>(old_message, message)
                    
                </div>
                
                <div class="description">
                  <p>
Allows the addition of multiple pieces of metadata to one segment - i.e.
traced method calls multiple sql queries
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000554_source')" id="l_M000554_source">show</a>
                        
                    </p>
                    <div id="M000554_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 303</span>
303:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">append_new_message</span>(<span class="ruby-identifier">old_message</span>, <span class="ruby-identifier">message</span>)
304:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old_message</span>
305:           <span class="ruby-identifier">old_message</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;;\n&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">message</span>
306:         <span class="ruby-keyword kw">else</span>
307:           <span class="ruby-identifier">message</span>
308:         <span class="ruby-keyword kw">end</span>
309:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000570">
                    
                    <a name="M000570"></a><b>builder</b>()
                    
                </div>
                
                <div class="description">
                  <p>
The current thread-local transaction sample builder
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000570_source')" id="l_M000570_source">show</a>
                        
                    </p>
                    <div id="M000570_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 451</span>
451:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">builder</span>
452:         <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-constant">BUILDER_KEY</span>]
453:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000534">
                    
                    <a name="M000534"></a><b>capture_segment_trace</b>()
                    
                </div>
                
                <div class="description">
                  <p>
in developer mode, capture the stack trace with the segment. this is cpu
and memory expensive and therefore should not be turned on in production
mode
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000534_source')" id="l_M000534_source">show</a>
                        
                    </p>
                    <div id="M000534_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 123</span>
123:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">capture_segment_trace</span>
124:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">developer_mode?</span>
125:         <span class="ruby-identifier">segment</span> = <span class="ruby-identifier">builder</span>.<span class="ruby-identifier">current_segment</span>
126:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">segment</span>
127:           <span class="ruby-comment cmt"># Strip stack frames off the top that match /new_relic/agent/</span>
128:           <span class="ruby-identifier">trace</span> = <span class="ruby-identifier">caller</span>
129:           <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">trace</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">=~</span><span class="ruby-regexp re">/\/lib\/new_relic\/agent\//</span>
130:             <span class="ruby-identifier">trace</span>.<span class="ruby-identifier">shift</span>
131:           <span class="ruby-keyword kw">end</span>
132: 
133:           <span class="ruby-identifier">trace</span> = <span class="ruby-identifier">trace</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">39</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">trace</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">40</span>
134:           <span class="ruby-identifier">segment</span>[<span class="ruby-identifier">:backtrace</span>] = <span class="ruby-identifier">trace</span>
135:         <span class="ruby-keyword kw">end</span>
136:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000564">
                    
                    <a name="M000564"></a><b>clamp_number_tts</b>(tts, limit)
                    
                </div>
                
                <div class="description">
                  <p>
JON - THIS CODE NEEDS A UNIT TEST
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000564_source')" id="l_M000564_source">show</a>
                        
                    </p>
                    <div id="M000564_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 412</span>
412:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">clamp_number_tts</span>(<span class="ruby-identifier">tts</span>, <span class="ruby-identifier">limit</span>)
413:         <span class="ruby-identifier">tts</span>.<span class="ruby-identifier">sort!</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span>,<span class="ruby-identifier">b</span><span class="ruby-operator">|</span>
414:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">force_persist</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">force_persist</span>
415:             <span class="ruby-identifier">b</span>.<span class="ruby-identifier">duration</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">duration</span>
416:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">force_persist</span>
417:             <span class="ruby-value">-1</span>
418:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">force_persist</span>
419:             <span class="ruby-value">1</span>
420:           <span class="ruby-keyword kw">else</span>
421:             <span class="ruby-identifier">b</span>.<span class="ruby-identifier">duration</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">duration</span>
422:           <span class="ruby-keyword kw">end</span>
423:         <span class="ruby-keyword kw">end</span>        
424:         
425:         <span class="ruby-identifier">tts</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">limit</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>)]  
426:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000572">
                    
                    <a name="M000572"></a><b>clear_builder</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Sets the thread local variable storing the transaction sample builder to
nil to clear it
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000572_source')" id="l_M000572_source">show</a>
                        
                    </p>
                    <div id="M000572_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 457</span>
457:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">clear_builder</span>
458:         <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-constant">BUILDER_KEY</span>] = <span class="ruby-keyword kw">nil</span>
459:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000522">
                    
                    <a name="M000522"></a><b>config</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000522_source')" id="l_M000522_source">show</a>
                        
                    </p>
                    <div id="M000522_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 62</span>
62:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">config</span>
63:         <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'transaction_tracer'</span>, {})
64:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000521">
                    
                    <a name="M000521"></a><b>configure!</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000521_source')" id="l_M000521_source">show</a>
                        
                    </p>
                    <div id="M000521_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 48</span>
48:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">configure!</span>
49:         <span class="ruby-comment cmt"># @segment_limit and @stack_trace_threshold come from the</span>
50:         <span class="ruby-comment cmt"># configuration file, with built-in defaults that should</span>
51:         <span class="ruby-comment cmt"># suffice for most customers</span>
52:         
53:         <span class="ruby-comment cmt"># enable if config.fetch('enabled', true)</span>
54:         
55:         <span class="ruby-ivar">@segment_limit</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'limit_segments'</span>, <span class="ruby-value">4000</span>)
56:         <span class="ruby-ivar">@stack_trace_threshold</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'stack_trace_threshold'</span>, <span class="ruby-value">0</span><span class="ruby-value">.500</span>).<span class="ruby-identifier">to_f</span>
57:         <span class="ruby-ivar">@explain_threshold</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'explain_threshold'</span>, <span class="ruby-value">0</span><span class="ruby-value">.5</span>).<span class="ruby-identifier">to_f</span>
58:         <span class="ruby-ivar">@explain_enabled</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'explain_enabled'</span>, <span class="ruby-keyword kw">true</span>)
59:         <span class="ruby-ivar">@transaction_threshold</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'transation_threshold'</span>, <span class="ruby-value">2.0</span>)
60:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000523">
                    
                    <a name="M000523"></a><b>current_sample_id</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Returns the current sample id, delegated from `builder`
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000523_source')" id="l_M000523_source">show</a>
                        
                    </p>
                    <div id="M000523_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 67</span>
67:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">current_sample_id</span>
68:         <span class="ruby-identifier">b</span>=<span class="ruby-identifier">builder</span>
69:         <span class="ruby-identifier">b</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">sample_id</span>
70:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000525">
                    
                    <a name="M000525"></a><b>disable</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Disable the transaction sampler - this also deregisters it with the
statistics engine.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000525_source')" id="l_M000525_source">show</a>
                        
                    </p>
                    <div id="M000525_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 81</span>
81:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">disable</span>
82:         <span class="ruby-ivar">@disabled</span> = <span class="ruby-keyword kw">true</span>
83:         <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">stats_engine</span>.<span class="ruby-identifier">remove_transaction_sampler</span>(<span class="ruby-keyword kw">self</span>)
84:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000524">
                    
                    <a name="M000524"></a><b>enable</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Enable the transaction sampler - this also registers it with the statistics
engine.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000524_source')" id="l_M000524_source">show</a>
                        
                    </p>
                    <div id="M000524_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 74</span>
74:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">enable</span>
75:         <span class="ruby-ivar">@disabled</span> = <span class="ruby-keyword kw">false</span>
76:         <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">stats_engine</span>.<span class="ruby-identifier">transaction_sampler</span> = <span class="ruby-keyword kw">self</span>
77:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000528">
                    
                    <a name="M000528"></a><b>enabled?</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000528_source')" id="l_M000528_source">show</a>
                        
                    </p>
                    <div id="M000528_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 86</span>
86:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">enabled?</span>
87:         <span class="ruby-operator">!</span><span class="ruby-ivar">@disabled</span>
88:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000561">
                    
                    <a name="M000561"></a><b>harvest</b>(previous = [], slow_threshold = 2.0)
                    
                </div>
                
                <div class="description">
                  <p>
get the set of collected samples, merging into previous samples, and clear
the collected sample list. Truncates samples to a specified @segment_limit
to save memory and bandwith transmitting samples to the server.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000561_source')" id="l_M000561_source">show</a>
                        
                    </p>
                    <div id="M000561_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 388</span>
388:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">harvest</span>(<span class="ruby-identifier">previous</span> = [], <span class="ruby-identifier">slow_threshold</span> = <span class="ruby-value">2.0</span>)
389:         <span class="ruby-keyword kw">return</span> [] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">disabled</span>
390:         <span class="ruby-identifier">result</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">previous</span>)
391:         
392:         <span class="ruby-ivar">@samples_lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
393:           <span class="ruby-identifier">result</span> = <span class="ruby-identifier">add_samples_to</span>(<span class="ruby-identifier">result</span>, <span class="ruby-identifier">slow_threshold</span>)
394:                     
395:           <span class="ruby-comment cmt"># clear previous transaction samples</span>
396:           <span class="ruby-ivar">@slowest_sample</span> = <span class="ruby-keyword kw">nil</span>
397:           <span class="ruby-ivar">@random_sample</span> = <span class="ruby-keyword kw">nil</span>
398:           <span class="ruby-ivar">@last_sample</span> = <span class="ruby-keyword kw">nil</span>
399:         <span class="ruby-keyword kw">end</span>
400:         
401:         <span class="ruby-comment cmt"># Clamp the number of TTs we'll keep in memory and send</span>
402:         <span class="ruby-comment cmt">#</span>
403:         <span class="ruby-identifier">result</span> = <span class="ruby-identifier">clamp_number_tts</span>(<span class="ruby-identifier">result</span>, <span class="ruby-value">20</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">20</span>
404:         
405:         <span class="ruby-comment cmt"># Truncate the samples at 2100 segments. The UI will clamp them at 2000 segments anyway.</span>
406:         <span class="ruby-comment cmt"># This will save us memory and bandwidth.</span>
407:         <span class="ruby-identifier">result</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">sample</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sample</span>.<span class="ruby-identifier">truncate</span>(<span class="ruby-ivar">@segment_limit</span>) }
408:         <span class="ruby-identifier">result</span>
409:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000549">
                    
                    <a name="M000549"></a><b>ignore_transaction</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Tells the builder to ignore a transaction, if we are currently creating
one. Only causes the sample to be ignored upon end of the transaction, and
does not change the metrics gathered outside of the sampler
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000549_source')" id="l_M000549_source">show</a>
                        
                    </p>
                    <div id="M000549_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 252</span>
252:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ignore_transaction</span>
253:         <span class="ruby-identifier">builder</span>.<span class="ruby-identifier">ignore_transaction</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">builder</span>
254:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000530">
                    
                    <a name="M000530"></a><b>notice_first_scope_push</b>(time)
                    
                </div>
                
                <div class="description">
                  <p>
Creates a new transaction sample builder, unless the transaction sampler is
disabled. Takes a time parameter for the start of the transaction sample
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000530_source')" id="l_M000530_source">show</a>
                        
                    </p>
                    <div id="M000530_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 102</span>
102:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">notice_first_scope_push</span>(<span class="ruby-identifier">time</span>)
103:         <span class="ruby-identifier">start_builder</span>(<span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_f</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">disabled</span>
104:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000557">
                    
                    <a name="M000557"></a><b>notice_nosql</b>(key, duration)
                    
                </div>
                
                <div class="description">
                  <p>
Adds non-sql metadata to a segment - generally the memcached key
</p>
<p>
duration is seconds, float value.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000557_source')" id="l_M000557_source">show</a>
                        
                    </p>
                    <div id="M000557_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 331</span>
331:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">notice_nosql</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">duration</span>)
332:         <span class="ruby-identifier">notice_extra_data</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">duration</span>, <span class="ruby-identifier">:key</span>)
333:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000539">
                    
                    <a name="M000539"></a><b>notice_pop_scope</b>(scope, time = Time.now)
                    
                </div>
                
                <div class="description">
                  <p>
Informs the transaction sample builder about the end of a traced scope
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000539_source')" id="l_M000539_source">show</a>
                        
                    </p>
                    <div id="M000539_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 148</span>
148:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">notice_pop_scope</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-identifier">time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>)
149:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">builder</span>
150:         <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;frozen already???&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">builder</span>.<span class="ruby-identifier">sample</span>.<span class="ruby-identifier">frozen?</span>
151:         <span class="ruby-identifier">builder</span>.<span class="ruby-identifier">trace_exit</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_f</span>)
152:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000550">
                    
                    <a name="M000550"></a><b>notice_profile</b>(profile)
                    
                </div>
                
                <div class="description">
                  <p>
For developer mode profiling support - delegates to the builder
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000550_source')" id="l_M000550_source">show</a>
                        
                    </p>
                    <div id="M000550_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 257</span>
257:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">notice_profile</span>(<span class="ruby-identifier">profile</span>)
258:         <span class="ruby-identifier">builder</span>.<span class="ruby-identifier">set_profile</span>(<span class="ruby-identifier">profile</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">builder</span>
259:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000531">
                    
                    <a name="M000531"></a><b>notice_push_scope</b>(scope, time=Time.now)
                    
                </div>
                
                <div class="description">
                  <p>
This delegates to the builder to create a new open transaction segment for
the specified scope, beginning at the optionally specified time.
</p>
<p>
Note that in developer mode, this captures a stacktrace for the beginning
of each segment, which can be fairly slow
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000531_source')" id="l_M000531_source">show</a>
                        
                    </p>
                    <div id="M000531_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 112</span>
112:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">notice_push_scope</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-identifier">time</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>)
113:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">builder</span>
114: 
115:         <span class="ruby-identifier">builder</span>.<span class="ruby-identifier">trace_entry</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_f</span>)
116: 
117:         <span class="ruby-identifier">capture_segment_trace</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">developer_mode?</span>
118:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000540">
                    
                    <a name="M000540"></a><b>notice_scope_empty</b>(time=Time.now)
                    
                </div>
                
                <div class="description">
                  <p>
This is called when we are done with the transaction. We&#8217;ve unwound
the stack to the top level. It also clears the transaction sample builder
so that it won&#8217;t continue to have scopes appended to it.
</p>
<p>
It sets various instance variables to the finished sample, depending on
which settings are active. See `<a
href="TransactionSampler.html#M000541">store_sample</a>`
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000540_source')" id="l_M000540_source">show</a>
                        
                    </p>
                    <div id="M000540_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 161</span>
161:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">notice_scope_empty</span>(<span class="ruby-identifier">time</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>)
162: 
163:         <span class="ruby-identifier">last_builder</span> = <span class="ruby-identifier">builder</span>
164:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">last_builder</span>
165: 
166:         <span class="ruby-identifier">last_builder</span>.<span class="ruby-identifier">finish_trace</span>(<span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_f</span>)
167:         <span class="ruby-identifier">clear_builder</span>
168:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">last_builder</span>.<span class="ruby-identifier">ignored?</span>
169: 
170:         <span class="ruby-ivar">@samples_lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
171:           <span class="ruby-comment cmt"># NB this instance variable may be used elsewhere, it's not</span>
172:           <span class="ruby-comment cmt"># just a side effect</span>
173:           <span class="ruby-ivar">@last_sample</span> = <span class="ruby-identifier">last_builder</span>.<span class="ruby-identifier">sample</span>
174:           <span class="ruby-identifier">store_sample</span>(<span class="ruby-ivar">@last_sample</span>)
175:         <span class="ruby-keyword kw">end</span>
176:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000556">
                    
                    <a name="M000556"></a><b>notice_sql</b>(sql, config, duration)
                    
                </div>
                
                <div class="description">
                  <p>
some statements (particularly INSERTS with large BLOBS may be very large;
we should trim them to a maximum usable length config is the driver
configuration for the connection duration is seconds, float value.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000556_source')" id="l_M000556_source">show</a>
                        
                    </p>
                    <div id="M000556_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 321</span>
321:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">notice_sql</span>(<span class="ruby-identifier">sql</span>, <span class="ruby-identifier">config</span>, <span class="ruby-identifier">duration</span>)
322:         <span class="ruby-keyword kw">if</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">is_sql_recorded?</span>
323:           <span class="ruby-identifier">notice_extra_data</span>(<span class="ruby-identifier">sql</span>, <span class="ruby-identifier">duration</span>, <span class="ruby-identifier">:sql</span>, <span class="ruby-identifier">config</span>, <span class="ruby-identifier">:connection_config</span>)
324:         <span class="ruby-keyword kw">end</span>
325:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000548">
                    
                    <a name="M000548"></a><b>notice_transaction</b>(path, uri=nil, params={})
                    
                </div>
                
                <div class="description">
                  <p>
Delegates to the builder to store the path, uri, and parameters if the
sampler is active
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000548_source')" id="l_M000548_source">show</a>
                        
                    </p>
                    <div id="M000548_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 244</span>
244:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">notice_transaction</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">uri</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">params</span>={})
245:         <span class="ruby-identifier">builder</span>.<span class="ruby-identifier">set_transaction_info</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">uri</span>, <span class="ruby-identifier">params</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">disabled</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">builder</span>
246:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000551">
                    
                    <a name="M000551"></a><b>notice_transaction_cpu_time</b>(cpu_time)
                    
                </div>
                
                <div class="description">
                  <p>
Sets the CPU time used by a transaction, delegates to the builder
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000551_source')" id="l_M000551_source">show</a>
                        
                    </p>
                    <div id="M000551_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 262</span>
262:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">notice_transaction_cpu_time</span>(<span class="ruby-identifier">cpu_time</span>)
263:         <span class="ruby-identifier">builder</span>.<span class="ruby-identifier">set_transaction_cpu_time</span>(<span class="ruby-identifier">cpu_time</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">builder</span>
264:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000565">
                    
                    <a name="M000565"></a><b>reset!</b>()
                    
                </div>
                
                <div class="description">
                  <p>
reset samples without rebooting the web server
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000565_source')" id="l_M000565_source">show</a>
                        
                    </p>
                    <div id="M000565_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 429</span>
429:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">reset!</span>
430:         <span class="ruby-ivar">@samples</span> = []
431:         <span class="ruby-ivar">@last_sample</span> = <span class="ruby-keyword kw">nil</span>
432:         <span class="ruby-ivar">@random_sample</span> = <span class="ruby-keyword kw">nil</span>
433:         <span class="ruby-ivar">@slowest_sample</span> = <span class="ruby-keyword kw">nil</span>
434:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000529">
                    
                    <a name="M000529"></a><b>sampling_rate=</b>(val)
                    
                </div>
                
                <div class="description">
                  <p>
Set with an integer value n, this takes one in every n harvested samples.
It also resets the harvest count to a random integer between 0 and (n-1)
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000529_source')" id="l_M000529_source">show</a>
                        
                    </p>
                    <div id="M000529_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 93</span>
93:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sampling_rate=</span>(<span class="ruby-identifier">val</span>)
94:         <span class="ruby-ivar">@sampling_rate</span> = <span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_i</span>
95:         <span class="ruby-ivar">@harvest_count</span> = <span class="ruby-identifier">rand</span>(<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_i</span>).<span class="ruby-identifier">to_i</span>
96:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000538">
                    
                    <a name="M000538"></a><b>scope_depth</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Defaults to zero, otherwise delegated to the transaction sample builder
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000538_source')" id="l_M000538_source">show</a>
                        
                    </p>
                    <div id="M000538_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 140</span>
140:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">scope_depth</span>
141:         <span class="ruby-keyword kw">return</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">builder</span>
142: 
143:         <span class="ruby-identifier">builder</span>.<span class="ruby-identifier">scope_depth</span>
144:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000546">
                    
                    <a name="M000546"></a><b>slowest_sample?</b>(old_sample, new_sample)
                    
                </div>
                
                <div class="description">
                  <p>
Checks to see if the old sample exists, or if it&#8217;s duration is less
than the new sample
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000546_source')" id="l_M000546_source">show</a>
                        
                    </p>
                    <div id="M000546_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 230</span>
230:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">slowest_sample?</span>(<span class="ruby-identifier">old_sample</span>, <span class="ruby-identifier">new_sample</span>)
231:         <span class="ruby-identifier">old_sample</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> (<span class="ruby-identifier">new_sample</span>.<span class="ruby-identifier">duration</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">old_sample</span>.<span class="ruby-identifier">duration</span>)
232:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000569">
                    
                    <a name="M000569"></a><b>start_builder</b>(time=nil)
                    
                </div>
                
                <div class="description">
                  <p>
Checks to see if the transaction sampler is disabled, if transaction trace
recording is disabled by a thread local, or if execution is untraced - if
so it clears the transaction sample builder from the thread local,
otherwise it generates a new transaction sample builder with the stated
time as a starting point and saves it in the thread local variable
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000569_source')" id="l_M000569_source">show</a>
                        
                    </p>
                    <div id="M000569_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 442</span>
442:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_builder</span>(<span class="ruby-identifier">time</span>=<span class="ruby-keyword kw">nil</span>)
443:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">disabled</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">is_transaction_traced?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">is_execution_traced?</span>
444:           <span class="ruby-identifier">clear_builder</span>
445:         <span class="ruby-keyword kw">else</span>
446:           <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-constant">BUILDER_KEY</span>] <span class="ruby-operator">||=</span> <span class="ruby-constant">TransactionSampleBuilder</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">time</span>)
447:         <span class="ruby-keyword kw">end</span>
448:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000543">
                    
                    <a name="M000543"></a><b>store_force_persist</b>(sample)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000543_source')" id="l_M000543_source">show</a>
                        
                    </p>
                    <div id="M000543_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 201</span>
201:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">store_force_persist</span>(<span class="ruby-identifier">sample</span>)
202:         <span class="ruby-ivar">@force_persist</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">sample</span>
203: 
204:         <span class="ruby-comment cmt"># WARNING - this clamp should be configurable</span>
205:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@force_persist</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">15</span>
206:           <span class="ruby-ivar">@force_persist</span>.<span class="ruby-identifier">sort!</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">a</span>,<span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">duration</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">duration</span>}
207:           <span class="ruby-ivar">@force_persist</span> = <span class="ruby-ivar">@force_persist</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">14</span>]
208:         <span class="ruby-keyword kw">end</span>
209:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000542">
                    
                    <a name="M000542"></a><b>store_random_sample</b>(sample)
                    
                </div>
                
                <div class="description">
                  <p>
Only active when random sampling is true - this is very rarely used. Always
store the most recent sample so that random sampling can pick a few of the
samples to store, upon harvest
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000542_source')" id="l_M000542_source">show</a>
                        
                    </p>
                    <div id="M000542_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 195</span>
195:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">store_random_sample</span>(<span class="ruby-identifier">sample</span>)
196:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@random_sampling</span>
197:           <span class="ruby-ivar">@random_sample</span> = <span class="ruby-identifier">sample</span>
198:         <span class="ruby-keyword kw">end</span>
199:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000541">
                    
                    <a name="M000541"></a><b>store_sample</b>(sample)
                    
                </div>
                
                <div class="description">
                  <p>
Samples can be stored in three places: the random sample variable, when
random sampling is active, the developer mode @samples array, and the
@slowest_sample variable if it is slower than the current occupant of that
slot
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000541_source')" id="l_M000541_source">show</a>
                        
                    </p>
                    <div id="M000541_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 182</span>
182:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">store_sample</span>(<span class="ruby-identifier">sample</span>)
183:         <span class="ruby-identifier">store_random_sample</span>(<span class="ruby-identifier">sample</span>)
184:         <span class="ruby-identifier">store_sample_for_developer_mode</span>(<span class="ruby-identifier">sample</span>)
185:         <span class="ruby-identifier">store_slowest_sample</span>(<span class="ruby-identifier">sample</span>)
186:         
187:         <span class="ruby-keyword kw">if</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">TransactionInfo</span>.<span class="ruby-identifier">get</span>.<span class="ruby-identifier">force_persist_sample?</span>(<span class="ruby-identifier">sample</span>)
188:           <span class="ruby-identifier">store_force_persist</span>(<span class="ruby-identifier">sample</span>)
189:         <span class="ruby-keyword kw">end</span>
190:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000544">
                    
                    <a name="M000544"></a><b>store_sample_for_developer_mode</b>(sample)
                    
                </div>
                
                <div class="description">
                  <p>
Samples take up a ton of memory, so we only store a lot of them in
developer mode - we truncate to @max_samples
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000544_source')" id="l_M000544_source">show</a>
                        
                    </p>
                    <div id="M000544_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 213</span>
213:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">store_sample_for_developer_mode</span>(<span class="ruby-identifier">sample</span>)
214:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">developer_mode?</span>
215:         <span class="ruby-ivar">@samples</span> = [] <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@samples</span>
216:         <span class="ruby-ivar">@samples</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">sample</span>
217:         <span class="ruby-identifier">truncate_samples</span>
218:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000545">
                    
                    <a name="M000545"></a><b>store_slowest_sample</b>(sample)
                    
                </div>
                
                <div class="description">
                  <p>
Sets @slowest_sample to the passed in sample if it is slower than the
current sample in @slowest_sample
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000545_source')" id="l_M000545_source">show</a>
                        
                    </p>
                    <div id="M000545_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 222</span>
222:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">store_slowest_sample</span>(<span class="ruby-identifier">sample</span>)
223:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">slowest_sample?</span>(<span class="ruby-ivar">@slowest_sample</span>, <span class="ruby-identifier">sample</span>)
224:           <span class="ruby-ivar">@slowest_sample</span> = <span class="ruby-identifier">sample</span>
225:         <span class="ruby-keyword kw">end</span>
226:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000553">
                    
                    <a name="M000553"></a><b>truncate_message</b>(message)
                    
                </div>
                
                <div class="description">
                  <p>
Truncates the message to `<a
href="TransactionSampler.html#MAX_DATA_LENGTH">MAX_DATA_LENGTH</a>` if
needed, and appends an ellipsis because it makes the trucation clearer in
the UI
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000553_source')" id="l_M000553_source">show</a>
                        
                    </p>
                    <div id="M000553_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 293</span>
293:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">truncate_message</span>(<span class="ruby-identifier">message</span>)
294:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">message</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> (<span class="ruby-constant">MAX_DATA_LENGTH</span> <span class="ruby-operator">-</span> <span class="ruby-value">4</span>)
295:           <span class="ruby-identifier">message</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-constant">MAX_DATA_LENGTH</span> <span class="ruby-operator">-</span> <span class="ruby-value">4</span>] <span class="ruby-operator">+</span> <span class="ruby-value str">'...'</span>
296:         <span class="ruby-keyword kw">else</span>
297:           <span class="ruby-identifier">message</span>
298:         <span class="ruby-keyword kw">end</span>
299:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000547">
                    
                    <a name="M000547"></a><b>truncate_samples</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Smashes the @samples array down to the length of @max_samples by taking the
last @max_samples elements of the array
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000547_source')" id="l_M000547_source">show</a>
                        
                    </p>
                    <div id="M000547_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 236</span>
236:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">truncate_samples</span>
237:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@samples</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@max_samples</span>
238:           <span class="ruby-ivar">@samples</span> = <span class="ruby-ivar">@samples</span>[<span class="ruby-operator">-</span><span class="ruby-ivar">@max_samples</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
239:         <span class="ruby-keyword kw">end</span>
240:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Private methods</div>
            
            <div class="method">
                <div class="title" id="M000552">
                    
                    <a name="M000552"></a><b>notice_extra_data</b>(message, duration, key, config=nil, config_key=nil)
                    
                </div>
                
                <div class="description">
                  <p>
This method is used to record metadata into the currently active segment
like a sql query, memcache key, or Net::HTTP uri
</p>
<p>
duration is seconds, float value.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000552_source')" id="l_M000552_source">show</a>
                        
                    </p>
                    <div id="M000552_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/agent/transaction_sampler.rb, line 271</span>
271:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">notice_extra_data</span>(<span class="ruby-identifier">message</span>, <span class="ruby-identifier">duration</span>, <span class="ruby-identifier">key</span>, <span class="ruby-identifier">config</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">config_key</span>=<span class="ruby-keyword kw">nil</span>)
272:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">builder</span>
273:         <span class="ruby-identifier">segment</span> = <span class="ruby-identifier">builder</span>.<span class="ruby-identifier">current_segment</span>
274:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">segment</span>
275:           <span class="ruby-identifier">new_message</span> = <span class="ruby-identifier">truncate_message</span>(<span class="ruby-identifier">append_new_message</span>(<span class="ruby-identifier">segment</span>[<span class="ruby-identifier">key</span>],
276:                                                             <span class="ruby-identifier">message</span>))
277:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">key</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:sql</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">config</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:has_key?</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">config</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">:adapter</span>)
278:             <span class="ruby-identifier">segment</span>[<span class="ruby-identifier">key</span>] = <span class="ruby-constant">Database</span><span class="ruby-operator">::</span><span class="ruby-constant">Statement</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">new_message</span>)
279:             <span class="ruby-identifier">segment</span>[<span class="ruby-identifier">key</span>].<span class="ruby-identifier">adapter</span> = <span class="ruby-identifier">config</span>[<span class="ruby-identifier">:adapter</span>]
280:           <span class="ruby-keyword kw">else</span>
281:             <span class="ruby-identifier">segment</span>[<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">new_message</span>
282:           <span class="ruby-keyword kw">end</span>
283:           <span class="ruby-identifier">segment</span>[<span class="ruby-identifier">config_key</span>] = <span class="ruby-identifier">config</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">config_key</span>
284:           <span class="ruby-identifier">append_backtrace</span>(<span class="ruby-identifier">segment</span>, <span class="ruby-identifier">duration</span>)
285:         <span class="ruby-keyword kw">end</span>
286:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    