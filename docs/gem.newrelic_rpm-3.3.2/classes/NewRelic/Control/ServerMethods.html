<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>NewRelic::Control::ServerMethods</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../../css/main.css" type="text/css" media="screen" />
    <script src="../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Module</span> 
            NewRelic::Control::ServerMethods 
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../files/lib/new_relic/control/server_methods_rb.html">lib/new_relic/control/server_methods.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
Contains methods that deal with connecting to the server
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>A</dt>
        <dd>
            <ul>
                
                <li><a href="#M000720">api_server</a></li>
                
            </ul>
        </dd>
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M000725">cert_file_path</a>,</li>
                
                <li><a href="#M000723">convert_to_ip_address</a></li>
                
            </ul>
        </dd>
    
        <dt>H</dt>
        <dd>
            <ul>
                
                <li><a href="#M000726">http_connection</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M000721">proxy_server</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000724">resolve_ip_address</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M000719">server</a>,</li>
                
                <li><a href="#M000722">server_from_host</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    

    

    

    
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000720">
                    
                    <a name="M000720"></a><b>api_server</b>()
                    
                </div>
                
                <div class="description">
                  <p>
the server we should contact for api requests, like uploading deployments
and the like
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000720_source')" id="l_M000720_source">show</a>
                        
                    </p>
                    <div id="M000720_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/control/server_methods.rb, line 20</span>
20:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">api_server</span>
21:         <span class="ruby-identifier">api_host</span> = <span class="ruby-keyword kw">self</span>[<span class="ruby-value str">'api_host'</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">'rpm.newrelic.com'</span>
22:         <span class="ruby-ivar">@api_server</span> <span class="ruby-operator">||=</span>
23:           <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span><span class="ruby-operator">::</span><span class="ruby-constant">Server</span>.<span class="ruby-identifier">new</span> \
24:         <span class="ruby-identifier">api_host</span>,
25:         (<span class="ruby-keyword kw">self</span>[<span class="ruby-value str">'api_port'</span>] <span class="ruby-operator">||</span> <span class="ruby-keyword kw">self</span>[<span class="ruby-value str">'port'</span>] <span class="ruby-operator">||</span> (<span class="ruby-identifier">use_ssl?</span> <span class="ruby-value">? </span><span class="ruby-value">443</span> <span class="ruby-operator">:</span> <span class="ruby-value">80</span>)).<span class="ruby-identifier">to_i</span>,
26:         <span class="ruby-keyword kw">nil</span>
27:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000725">
                    
                    <a name="M000725"></a><b>cert_file_path</b>()
                    
                </div>
                
                <div class="description">
                  <p>
The path to the certificate file used to verify the SSL connection if
verify_peer is enabled
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000725_source')" id="l_M000725_source">show</a>
                        
                    </p>
                    <div id="M000725_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/control/server_methods.rb, line 80</span>
80:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cert_file_path</span>
81:         <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">newrelic_root</span>, <span class="ruby-value str">'cert'</span>, <span class="ruby-value str">'cacert.pem'</span>))
82:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000723">
                    
                    <a name="M000723"></a><b>convert_to_ip_address</b>(host)
                    
                </div>
                
                <div class="description">
                  <p>
Check to see if we need to look up the IP address If it&#8217;s an IP
address already, we pass it through. If it&#8217;s nil, or localhost, we
don&#8217;t bother. Otherwise, use `<a
href="ServerMethods.html#M000724">resolve_ip_address</a>` to find one
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000723_source')" id="l_M000723_source">show</a>
                        
                    </p>
                    <div id="M000723_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/control/server_methods.rb, line 50</span>
50:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">convert_to_ip_address</span>(<span class="ruby-identifier">host</span>)
51:         <span class="ruby-comment cmt"># here we leave it as a host name since the cert verification</span>
52:         <span class="ruby-comment cmt"># needs it in host form</span>
53:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">host</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">verify_certificate?</span>
54:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">host</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">host</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;localhost&quot;</span>
55:         <span class="ruby-identifier">ip</span> = <span class="ruby-identifier">resolve_ip_address</span>(<span class="ruby-identifier">host</span>)
56:         <span class="ruby-identifier">log</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;Resolved #{host} to #{ip}&quot;</span>
57:         <span class="ruby-identifier">ip</span>
58:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000726">
                    
                    <a name="M000726"></a><b>http_connection</b>(host = nil)
                    
                </div>
                
                <div class="description">
                  <p>
Return the Net::HTTP with proxy configuration given the
NewRelic::Control::Server object. Default is the collector but for api
calls you need to pass <a href="ServerMethods.html#M000720">api_server</a>
</p>
<p>
Experimental support for SSL verification: swap &#8216;VERIFY_NONE&#8217;
for &#8216;VERIFY_PEER&#8217; line to try it out If verification fails,
uncomment the &#8216;http.ca_file&#8217; line and it will use the included
certificate.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000726_source')" id="l_M000726_source">show</a>
                        
                    </p>
                    <div id="M000726_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/new_relic/control/server_methods.rb, line 91</span>
 91:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">http_connection</span>(<span class="ruby-identifier">host</span> = <span class="ruby-keyword kw">nil</span>)
 92:         <span class="ruby-identifier">host</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">server</span>
 93:         <span class="ruby-comment cmt"># Proxy returns regular HTTP if @proxy_host is nil (the default)</span>
 94:         <span class="ruby-identifier">http_class</span> = <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span><span class="ruby-operator">::</span><span class="ruby-constant">Proxy</span>(<span class="ruby-identifier">proxy_server</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">proxy_server</span>.<span class="ruby-identifier">port</span>,
 95:                                       <span class="ruby-identifier">proxy_server</span>.<span class="ruby-identifier">user</span>, <span class="ruby-identifier">proxy_server</span>.<span class="ruby-identifier">password</span>)
 96:         <span class="ruby-identifier">http</span> = <span class="ruby-identifier">http_class</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">host</span>.<span class="ruby-identifier">ip</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">host</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">host</span>.<span class="ruby-identifier">port</span>)
 97:         <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-node">&quot;Http Connection opened to #{host.ip||host.name}:#{host.port}&quot;</span>)
 98:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">use_ssl?</span>
 99:           <span class="ruby-identifier">http</span>.<span class="ruby-identifier">use_ssl</span> = <span class="ruby-keyword kw">true</span>
100:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">verify_certificate?</span>
101:             <span class="ruby-identifier">http</span>.<span class="ruby-identifier">verify_mode</span> = <span class="ruby-constant">OpenSSL</span><span class="ruby-operator">::</span><span class="ruby-constant">SSL</span><span class="ruby-operator">::</span><span class="ruby-constant">VERIFY_PEER</span>
102:             <span class="ruby-identifier">http</span>.<span class="ruby-identifier">ca_file</span> = <span class="ruby-identifier">cert_file_path</span>
103:           <span class="ruby-keyword kw">else</span>
104:             <span class="ruby-identifier">http</span>.<span class="ruby-identifier">verify_mode</span> = <span class="ruby-constant">OpenSSL</span><span class="ruby-operator">::</span><span class="ruby-constant">SSL</span><span class="ruby-operator">::</span><span class="ruby-constant">VERIFY_NONE</span>
105:           <span class="ruby-keyword kw">end</span>
106:         <span class="ruby-keyword kw">end</span>
107:         <span class="ruby-identifier">http</span>
108:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000721">
                    
                    <a name="M000721"></a><b>proxy_server</b>()
                    
                </div>
                
                <div class="description">
                  <p>
a new instances of the proxy server - this passes through if there is no
proxy, otherwise it has proxy configuration information pulled from the
config file
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000721_source')" id="l_M000721_source">show</a>
                        
                    </p>
                    <div id="M000721_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/control/server_methods.rb, line 32</span>
32:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">proxy_server</span>
33:         <span class="ruby-ivar">@proxy_server</span> <span class="ruby-operator">||=</span>
34:           <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span><span class="ruby-operator">::</span><span class="ruby-constant">ProxyServer</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword kw">self</span>[<span class="ruby-value str">'proxy_host'</span>], <span class="ruby-keyword kw">self</span>[<span class="ruby-value str">'proxy_port'</span>], <span class="ruby-keyword kw">self</span>[<span class="ruby-value str">'proxy_user'</span>], <span class="ruby-keyword kw">self</span>[<span class="ruby-value str">'proxy_pass'</span>]
35:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000724">
                    
                    <a name="M000724"></a><b>resolve_ip_address</b>(host)
                    
                </div>
                
                <div class="description">
                  <p>
Look up the ip address of the host using the pure ruby lookup to prevent
blocking. If that fails, fall back to the regular IPSocket library. Return
nil if we can&#8217;t find the host ip address and don&#8217;t have a good
default.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000724_source')" id="l_M000724_source">show</a>
                        
                    </p>
                    <div id="M000724_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/control/server_methods.rb, line 64</span>
64:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">resolve_ip_address</span>(<span class="ruby-identifier">host</span>)
65:         <span class="ruby-constant">Resolv</span>.<span class="ruby-identifier">getaddress</span>(<span class="ruby-identifier">host</span>)
66:       <span class="ruby-keyword kw">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
67:         <span class="ruby-identifier">log</span>.<span class="ruby-identifier">warn</span>(<span class="ruby-node">&quot;DNS Error caching IP address: #{e}&quot;</span>)
68:         <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span>(<span class="ruby-identifier">e</span>.<span class="ruby-identifier">backtrace</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;\n   &quot;</span>))
69:         <span class="ruby-keyword kw">begin</span>
70:           <span class="ruby-identifier">log</span>.<span class="ruby-identifier">info</span>(<span class="ruby-value str">&quot;Trying native DNS lookup since Resolv failed&quot;</span>)
71:           <span class="ruby-constant">IPSocket</span>.<span class="ruby-identifier">getaddress</span>(<span class="ruby-identifier">host</span>)
72:         <span class="ruby-keyword kw">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
73:           <span class="ruby-identifier">log</span>.<span class="ruby-identifier">error</span>(<span class="ruby-node">&quot;Could not look up server address: #{e}&quot;</span>)
74:           <span class="ruby-keyword kw">nil</span>
75:         <span class="ruby-keyword kw">end</span>
76:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000719">
                    
                    <a name="M000719"></a><b>server</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000719_source')" id="l_M000719_source">show</a>
                        
                    </p>
                    <div id="M000719_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/control/server_methods.rb, line 14</span>
14:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">server</span>
15:         <span class="ruby-ivar">@remote_server</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">server_from_host</span>(<span class="ruby-keyword kw">nil</span>)
16:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000722">
                    
                    <a name="M000722"></a><b>server_from_host</b>(hostname=nil)
                    
                </div>
                
                <div class="description">
                  <p>
turns a hostname into an ip address and returns a NewRelic::Control::Server
that contains the configuration info
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000722_source')" id="l_M000722_source">show</a>
                        
                    </p>
                    <div id="M000722_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/new_relic/control/server_methods.rb, line 39</span>
39:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">server_from_host</span>(<span class="ruby-identifier">hostname</span>=<span class="ruby-keyword kw">nil</span>)
40:         <span class="ruby-identifier">host</span> = <span class="ruby-identifier">hostname</span> <span class="ruby-operator">||</span> <span class="ruby-keyword kw">self</span>[<span class="ruby-value str">'host'</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">'collector.newrelic.com'</span>
41: 
42:         <span class="ruby-comment cmt"># if the host is not an IP address, turn it into one</span>
43:         <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span><span class="ruby-operator">::</span><span class="ruby-constant">Server</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">host</span>, (<span class="ruby-keyword kw">self</span>[<span class="ruby-value str">'port'</span>] <span class="ruby-operator">||</span> (<span class="ruby-identifier">use_ssl?</span> <span class="ruby-value">? </span><span class="ruby-value">443</span> <span class="ruby-operator">:</span> <span class="ruby-value">80</span>)).<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">convert_to_ip_address</span>(<span class="ruby-identifier">host</span>)
44:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    