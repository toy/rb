<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>PhusionPassenger::AbstractRequestHandler</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
    <script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            PhusionPassenger::AbstractRequestHandler 
            
                <span class="parent">&lt; 
                    
                    <a href="../Object.html">Object</a>
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/phusion_passenger/abstract_request_handler_rb.html">lib/phusion_passenger/abstract_request_handler.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
The request handler is the layer which connects Apache with the underlying
application&#8217;s request dispatcher (i.e. either Rails&#8217;s
Dispatcher class or <a href="Rack.html">Rack</a>). The request
handler&#8217;s job is to process incoming HTTP requests using the
currently loaded Ruby on Rails application. HTTP requests are forwarded to
the request handler by the web server. HTTP responses generated by the RoR
application are forwarded to the web server, which, in turn, sends the
response back to the HTTP client.
</p>
<p>
<a href="AbstractRequestHandler.html">AbstractRequestHandler</a> is an
abstract base class for easing the implementation of request handlers for
Rails and <a href="Rack.html">Rack</a>.
</p>
<h2>Design decisions</h2>
<p>
Some design decisions are made because we want to decrease system
administrator maintenance overhead. These decisions are documented in this
section.
</p>
<h3>Owner pipes</h3>
<p>
Because only the web server communicates directly with a request handler,
we want the request handler to exit if the web server has also exited. This
is implemented by using a so-called _owner pipe_. The writable part of the
pipe will be passed to the web server* via a Unix socket, and the web
server will own that part of the pipe, while <a
href="AbstractRequestHandler.html">AbstractRequestHandler</a> owns the
readable part of the pipe. <a
href="AbstractRequestHandler.html">AbstractRequestHandler</a> will
continuously check whether the other side of the pipe has been closed. If
so, then it knows that the web server has exited, and so the request
handler will exit as well. This works even if the web server gets killed by
SIGKILL.
</p>
<ul>
<li>It might also be passed to the ApplicationPoolServerExecutable, if the web
server&#8217;s using ApplicationPoolServer instead of
StandardApplicationPool.

</li>
</ul>
<h2>Request format</h2>
<p>
Incoming &#8220;HTTP requests&#8221; are not true HTTP requests, i.e. their
binary representation do not conform to RFC 2616. Instead, the request
format is based on CGI, and is similar to that of SCGI.
</p>
<p>
The format consists of 3 parts:
</p>
<ul>
<li>A 32-bit big-endian integer, containing the size of the transformed
headers.

</li>
<li>The transformed HTTP headers.

</li>
<li>The verbatim (untransformed) HTTP request body.

</li>
</ul>
<p>
HTTP headers are transformed to a format that satisfies the following
grammar:
</p>
<pre>
 headers ::= header*
 header ::= name NUL value NUL
 name ::= notnull+
 value ::= notnull+
 notnull ::= &quot;\x01&quot; | &quot;\x02&quot; | &quot;\x02&quot; | ... | &quot;\xFF&quot;
 NUL = &quot;\x00&quot;
</pre>
<p>
The web server transforms the HTTP request to the aforementioned format,
and sends it to the request handler.
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>A</dt>
        <dd>
            <ul>
                
                <li><a href="#M000041">accept_and_process_next_request</a></li>
                
            </ul>
        </dd>
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M000017">cleanup</a>,</li>
                
                <li><a href="#M000029">create_tcp_socket</a>,</li>
                
                <li><a href="#M000027">create_unix_socket_on_filesystem</a></li>
                
            </ul>
        </dd>
    
        <dt>D</dt>
        <dd>
            <ul>
                
                <li><a href="#M000048">determine_passenger_header</a></li>
                
            </ul>
        </dd>
    
        <dt>F</dt>
        <dd>
            <ul>
                
                <li><a href="#M000052">finalize_request</a></li>
                
            </ul>
        </dd>
    
        <dt>I</dt>
        <dd>
            <ul>
                
                <li><a href="#M000034">install_useful_signal_handlers</a></li>
                
            </ul>
        </dd>
    
        <dt>L</dt>
        <dd>
            <ul>
                
                <li><a href="#M000054">log_analytics_exception</a></li>
                
            </ul>
        </dd>
    
        <dt>M</dt>
        <dd>
            <ul>
                
                <li><a href="#M000019">main_loop</a>,</li>
                
                <li><a href="#M000018">main_loop_running?</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M000016">new</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M000046">parse_http_request</a>,</li>
                
                <li><a href="#M000045">parse_native_request</a>,</li>
                
                <li><a href="#M000050">prepare_request</a>,</li>
                
                <li><a href="#M000047">process_ping</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000033">reset_signal_handlers</a>,</li>
                
                <li><a href="#M000040">revert_signal_handlers</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M000025">should_use_unix_sockets?</a>,</li>
                
                <li><a href="#M000023">soft_shutdown</a>,</li>
                
                <li><a href="#M000022">start_main_loop_thread</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    
    <div class="sectiontitle">Included Modules</div>
    <ul>
        
        <li>
            
            <a href="Rack.html">PhusionPassenger::Rack</a>
            
            START:includes
        </li>
        
        <li>
            
            <a href="Rack.html">PhusionPassenger::Rack</a>
            
            START:includes
        </li>
        
    </ul>
    

    

    

    
    <div class="sectiontitle">Constants</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class="attr-name">HARD_TERMINATION_SIGNAL</td>
            <td>=</td>
            <td class="attr-value">&quot;SIGTERM&quot;</td>
        </tr>
        
        <tr valign='top'>
            <td>&nbsp;</td>
            <td colspan="2" class="attr-desc"><p>
<a href="../Signal.html">Signal</a> which will cause the Rails application
to exit immediately.
</p>
</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">SOFT_TERMINATION_SIGNAL</td>
            <td>=</td>
            <td class="attr-value">&quot;SIGUSR1&quot;</td>
        </tr>
        
        <tr valign='top'>
            <td>&nbsp;</td>
            <td colspan="2" class="attr-desc"><p>
<a href="../Signal.html">Signal</a> which will cause the Rails application
to exit as soon as it&#8217;s done processing a request.
</p>
</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">BACKLOG_SIZE</td>
            <td>=</td>
            <td class="attr-value">500</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">MAX_HEADER_SIZE</td>
            <td>=</td>
            <td class="attr-value">128 * 1024</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">OBJECT_SPACE_SUPPORTS_LIVE_OBJECTS</td>
            <td>=</td>
            <td class="attr-value">ObjectSpace.respond_to?(:live_objects)</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">OBJECT_SPACE_SUPPORTS_ALLOCATED_OBJECTS</td>
            <td>=</td>
            <td class="attr-value">ObjectSpace.respond_to?(:allocated_objects)</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">OBJECT_SPACE_SUPPORTS_COUNT_OBJECTS</td>
            <td>=</td>
            <td class="attr-value">ObjectSpace.respond_to?(:count_objects)</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">GC_SUPPORTS_TIME</td>
            <td>=</td>
            <td class="attr-value">GC.respond_to?(:time)</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">GC_SUPPORTS_CLEAR_STATS</td>
            <td>=</td>
            <td class="attr-value">GC.respond_to?(:clear_stats)</td>
        </tr>
        
        
    </table>
    

    
    <div class="sectiontitle">Attributes</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>server_sockets</td>
            <td class='attr-desc'><p>
A hash containing all server sockets that this request handler listens on.
The hash is in the form of:
</p>
<pre>
  {
     name1 =&gt; [socket_address1, socket_type1, socket1],
     name2 =&gt; [socket_address2, socket_type2, socket2],
     ...
  }
</pre>
<p>
<tt>name</tt> is a Symbol. <tt>socket_addressx</tt> is the address of the
socket, <tt>socket_typex</tt> is the socket&#8217;s type (either
&#8216;unix&#8217; or &#8216;tcp&#8217;) and <tt>socketx</tt> is the actual
socket <a href="../IO.html">IO</a> objec. There&#8217;s guaranteed to be at
least one server socket, namely one with the name <tt>:main</tt>.
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>memory_limit</td>
            <td class='attr-desc'><p>
Specifies the maximum allowed memory usage, in MB. If after having
processed a request <a
href="AbstractRequestHandler.html">AbstractRequestHandler</a> detects that
memory usage has risen above this limit, then it will gracefully exit (that
is, exit after having processed all pending requests).
</p>
<p>
A value of 0 (the default) indicates that there&#8217;s no limit.
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>iterations</td>
            <td class='attr-desc'><p>
The number of times the main loop has iterated so far. Mostly useful for
unit test assertions.
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>processed_requests</td>
            <td class='attr-desc'><p>
Number of requests processed so far. This includes requests that raised
exceptions.
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>soft_termination_linger_time</td>
            <td class='attr-desc'><p>
If a soft termination signal was received, then the main loop will quit the
given amount of seconds after the last time a connection was accepted.
Defaults to 3 seconds.
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>connect_password</td>
            <td class='attr-desc'><p>
A password with which clients must authenticate. Default is
unauthenticated.
</p></td>
        </tr>
        
    </table>
    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M000016">
                    
                    <a name="M000016"></a><b>new</b>(owner_pipe, options = {})
                    
                </div>
                
                <div class="description">
                  <p>
Create a new RequestHandler with the given owner pipe. <tt>owner_pipe</tt>
must be the readable part of a pipe <a href="../IO.html">IO</a> object.
</p>
<p>
Additionally, the following options may be given:
</p>
<ul>
<li><a href="AbstractRequestHandler.html#memory_limit">memory_limit</a>: Used
to set the <tt><a
href="AbstractRequestHandler.html#memory_limit">memory_limit</a></tt>
attribute.

</li>
<li>detach_key

</li>
<li><a href="AbstractRequestHandler.html#connect_password">connect_password</a>

</li>
<li>pool_account_username

</li>
<li>pool_account_password_base64

</li>
</ul>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000016_source')" id="l_M000016_source">show</a>
                        
                    </p>
                    <div id="M000016_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 170</span>
170:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">owner_pipe</span>, <span class="ruby-identifier">options</span> = {})
171:     <span class="ruby-ivar">@server_sockets</span> = {}
172:     
173:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">should_use_unix_sockets?</span>
174:       <span class="ruby-ivar">@main_socket_address</span>, <span class="ruby-ivar">@main_socket</span> = <span class="ruby-identifier">create_unix_socket_on_filesystem</span>
175:       <span class="ruby-ivar">@server_sockets</span>[<span class="ruby-identifier">:main</span>] = [<span class="ruby-ivar">@main_socket_address</span>, <span class="ruby-value str">'unix'</span>, <span class="ruby-ivar">@main_socket</span>]
176:     <span class="ruby-keyword kw">else</span>
177:       <span class="ruby-ivar">@main_socket_address</span>, <span class="ruby-ivar">@main_socket</span> = <span class="ruby-identifier">create_tcp_socket</span>
178:       <span class="ruby-ivar">@server_sockets</span>[<span class="ruby-identifier">:main</span>] = [<span class="ruby-ivar">@main_socket_address</span>, <span class="ruby-value str">'tcp'</span>, <span class="ruby-ivar">@main_socket</span>]
179:     <span class="ruby-keyword kw">end</span>
180:     
181:     <span class="ruby-ivar">@http_socket_address</span>, <span class="ruby-ivar">@http_socket</span> = <span class="ruby-identifier">create_tcp_socket</span>
182:     <span class="ruby-ivar">@server_sockets</span>[<span class="ruby-identifier">:http</span>] = [<span class="ruby-ivar">@http_socket_address</span>, <span class="ruby-value str">'tcp'</span>, <span class="ruby-ivar">@http_socket</span>]
183:     
184:     <span class="ruby-ivar">@owner_pipe</span> = <span class="ruby-identifier">owner_pipe</span>
185:     <span class="ruby-ivar">@options</span> = <span class="ruby-identifier">options</span>
186:     <span class="ruby-ivar">@previous_signal_handlers</span> = {}
187:     <span class="ruby-ivar">@main_loop_generation</span>  = <span class="ruby-value">0</span>
188:     <span class="ruby-ivar">@main_loop_thread_lock</span> = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>
189:     <span class="ruby-ivar">@main_loop_thread_cond</span> = <span class="ruby-constant">ConditionVariable</span>.<span class="ruby-identifier">new</span>
190:     <span class="ruby-ivar">@memory_limit</span>          = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;memory_limit&quot;</span>] <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
191:     <span class="ruby-ivar">@connect_password</span>      = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;connect_password&quot;</span>]
192:     <span class="ruby-ivar">@detach_key</span>            = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;detach_key&quot;</span>]
193:     <span class="ruby-ivar">@pool_account_username</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;pool_account_username&quot;</span>]
194:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;pool_account_password_base64&quot;</span>]
195:       <span class="ruby-ivar">@pool_account_password</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;pool_account_password_base64&quot;</span>].<span class="ruby-identifier">unpack</span>(<span class="ruby-value str">'m'</span>).<span class="ruby-identifier">first</span>
196:     <span class="ruby-keyword kw">end</span>
197:     <span class="ruby-ivar">@analytics_logger</span>      = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;analytics_logger&quot;</span>]
198:     <span class="ruby-ivar">@iterations</span>         = <span class="ruby-value">0</span>
199:     <span class="ruby-ivar">@processed_requests</span> = <span class="ruby-value">0</span>
200:     <span class="ruby-ivar">@soft_termination_linger_time</span> = <span class="ruby-value">3</span>
201:     <span class="ruby-ivar">@main_loop_running</span>  = <span class="ruby-keyword kw">false</span>
202:     <span class="ruby-ivar">@passenger_header</span>   = <span class="ruby-identifier">determine_passenger_header</span>
203:     
204:     <span class="ruby-ivar">@debugger</span> = <span class="ruby-ivar">@options</span>[<span class="ruby-value str">&quot;debugger&quot;</span>]
205:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@debugger</span>
206:       <span class="ruby-ivar">@server_sockets</span>[<span class="ruby-identifier">:ruby_debug_cmd</span>] = [<span class="ruby-node">&quot;127.0.0.1:#{Debugger.cmd_port}&quot;</span>, <span class="ruby-value str">'tcp'</span>]
207:       <span class="ruby-ivar">@server_sockets</span>[<span class="ruby-identifier">:ruby_debug_ctrl</span>] = [<span class="ruby-node">&quot;127.0.0.1:#{Debugger.ctrl_port}&quot;</span>, <span class="ruby-value str">'tcp'</span>]
208:     <span class="ruby-keyword kw">end</span>
209:     
210:     <span class="ruby-comment cmt">#############</span>
211:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000017">
                    
                    <a name="M000017"></a><b>cleanup</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Clean up temporary stuff created by the request handler.
</p>
<p>
If the main loop was started by <a
href="AbstractRequestHandler.html#M000019">main_loop</a>, then this method
may only be called after the main loop has exited.
</p>
<p>
If the main loop was started by <a
href="AbstractRequestHandler.html#M000022">start_main_loop_thread</a>, then
this method may be called at any time, and it will stop the main loop
thread.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000017_source')" id="l_M000017_source">show</a>
                        
                    </p>
                    <div id="M000017_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 220</span>
220:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cleanup</span>
221:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@main_loop_thread</span>
222:       <span class="ruby-ivar">@main_loop_thread_lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
223:         <span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
224:       <span class="ruby-keyword kw">end</span>
225:       <span class="ruby-ivar">@main_loop_thread</span>.<span class="ruby-identifier">join</span>
226:     <span class="ruby-keyword kw">end</span>
227:     <span class="ruby-ivar">@server_sockets</span>.<span class="ruby-identifier">each_value</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
228:       <span class="ruby-identifier">address</span>, <span class="ruby-identifier">type</span>, <span class="ruby-identifier">socket</span> = <span class="ruby-identifier">value</span>
229:       <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
230:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'unix'</span>
231:         <span class="ruby-constant">File</span>.<span class="ruby-identifier">unlink</span>(<span class="ruby-identifier">address</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
232:       <span class="ruby-keyword kw">end</span>
233:     <span class="ruby-keyword kw">end</span>
234:     <span class="ruby-ivar">@owner_pipe</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
235:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000019">
                    
                    <a name="M000019"></a><b>main_loop</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Enter the request handler&#8217;s main loop.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000019_source')" id="l_M000019_source">show</a>
                        
                    </p>
                    <div id="M000019_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 243</span>
243:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">main_loop</span>
244:     <span class="ruby-identifier">debug</span>(<span class="ruby-value str">&quot;Entering request handler main loop&quot;</span>)
245:     <span class="ruby-identifier">reset_signal_handlers</span>
246:     <span class="ruby-keyword kw">begin</span>
247:       <span class="ruby-ivar">@graceful_termination_pipe</span> = <span class="ruby-constant">IO</span>.<span class="ruby-identifier">pipe</span>
248:       <span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">close_on_exec!</span>
249:       <span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">close_on_exec!</span>
250:       
251:       <span class="ruby-ivar">@main_loop_thread_lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
252:         <span class="ruby-ivar">@main_loop_generation</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
253:         <span class="ruby-ivar">@main_loop_running</span> = <span class="ruby-keyword kw">true</span>
254:         <span class="ruby-ivar">@main_loop_thread_cond</span>.<span class="ruby-identifier">broadcast</span>
255:         
256:         <span class="ruby-ivar">@select_timeout</span> = <span class="ruby-keyword kw">nil</span>
257:         
258:         <span class="ruby-ivar">@selectable_sockets</span> = []
259:         <span class="ruby-ivar">@server_sockets</span>.<span class="ruby-identifier">each_value</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
260:           <span class="ruby-identifier">socket</span> = <span class="ruby-identifier">value</span>[<span class="ruby-value">2</span>]
261:           <span class="ruby-ivar">@selectable_sockets</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">socket</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">socket</span>
262:         <span class="ruby-keyword kw">end</span>
263:         <span class="ruby-ivar">@selectable_sockets</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@owner_pipe</span>
264:         <span class="ruby-ivar">@selectable_sockets</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">0</span>]
265:       <span class="ruby-keyword kw">end</span>
266:       
267:       <span class="ruby-identifier">install_useful_signal_handlers</span>
268:       <span class="ruby-identifier">socket_wrapper</span> = <span class="ruby-constant">Utils</span><span class="ruby-operator">::</span><span class="ruby-constant">UnseekableSocket</span>.<span class="ruby-identifier">new</span>
269:       <span class="ruby-identifier">channel</span>        = <span class="ruby-constant">MessageChannel</span>.<span class="ruby-identifier">new</span>
270:       <span class="ruby-identifier">buffer</span>         = <span class="ruby-value str">''</span>
271:       
272:       <span class="ruby-keyword kw">while</span> <span class="ruby-keyword kw">true</span>
273:         <span class="ruby-ivar">@iterations</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
274:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">accept_and_process_next_request</span>(<span class="ruby-identifier">socket_wrapper</span>, <span class="ruby-identifier">channel</span>, <span class="ruby-identifier">buffer</span>)
275:           <span class="ruby-identifier">trace</span>(<span class="ruby-value">2</span>, <span class="ruby-value str">&quot;Request handler main loop exited normally&quot;</span>)
276:           <span class="ruby-keyword kw">break</span>
277:         <span class="ruby-keyword kw">end</span>
278:         <span class="ruby-ivar">@processed_requests</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
279:       <span class="ruby-keyword kw">end</span>
280:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">EOFError</span>
281:       <span class="ruby-comment cmt"># Exit main loop.</span>
282:       <span class="ruby-identifier">trace</span>(<span class="ruby-value">2</span>, <span class="ruby-value str">&quot;Request handler main loop interrupted by EOFError exception&quot;</span>)
283:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Interrupt</span>
284:       <span class="ruby-comment cmt"># Exit main loop.</span>
285:       <span class="ruby-identifier">trace</span>(<span class="ruby-value">2</span>, <span class="ruby-value str">&quot;Request handler main loop interrupted by Interrupt exception&quot;</span>)
286:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SignalException</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">signal</span>
287:       <span class="ruby-identifier">trace</span>(<span class="ruby-value">2</span>, <span class="ruby-value str">&quot;Request handler main loop interrupted by SignalException&quot;</span>)
288:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">signal</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">HARD_TERMINATION_SIGNAL</span> <span class="ruby-operator">&amp;&amp;</span>
289:          <span class="ruby-identifier">signal</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">SOFT_TERMINATION_SIGNAL</span>
290:         <span class="ruby-identifier">raise</span>
291:       <span class="ruby-keyword kw">end</span>
292:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
293:       <span class="ruby-identifier">trace</span>(<span class="ruby-value">2</span>, <span class="ruby-node">&quot;Request handler main loop interrupted by #{e.class} exception&quot;</span>)
294:       <span class="ruby-identifier">raise</span>
295:     <span class="ruby-keyword kw">ensure</span>
296:       <span class="ruby-identifier">debug</span>(<span class="ruby-value str">&quot;Exiting request handler main loop&quot;</span>)
297:       <span class="ruby-identifier">revert_signal_handlers</span>
298:       <span class="ruby-ivar">@main_loop_thread_lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
299:         <span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
300:         <span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
301:         <span class="ruby-ivar">@selectable_sockets</span> = []
302:         <span class="ruby-ivar">@main_loop_generation</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
303:         <span class="ruby-ivar">@main_loop_running</span> = <span class="ruby-keyword kw">false</span>
304:         <span class="ruby-ivar">@main_loop_thread_cond</span>.<span class="ruby-identifier">broadcast</span>
305:       <span class="ruby-keyword kw">end</span>
306:     <span class="ruby-keyword kw">end</span>
307:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000018">
                    
                    <a name="M000018"></a><b>main_loop_running?</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Check whether the main loop&#8217;s currently running.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000018_source')" id="l_M000018_source">show</a>
                        
                    </p>
                    <div id="M000018_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 238</span>
238:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">main_loop_running?</span>
239:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@main_loop_running</span>
240:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000023">
                    
                    <a name="M000023"></a><b>soft_shutdown</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Remove this request handler from the application pool so that no new
connections will come in. Then make the main loop quit a few seconds after
the last time a connection came in. This all is to ensure that no
connections come in while we&#8217;re shutting down.
</p>
<p>
May only be called while the main loop is running. May be called from any
thread.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000023_source')" id="l_M000023_source">show</a>
                        
                    </p>
                    <div id="M000023_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 333</span>
333:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">soft_shutdown</span>
334:     <span class="ruby-ivar">@select_timeout</span> = <span class="ruby-ivar">@soft_termination_linger_time</span>
335:     <span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
336:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@detach_key</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@pool_account_username</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@pool_account_password</span>
337:       <span class="ruby-identifier">client</span> = <span class="ruby-constant">MessageClient</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@pool_account_username</span>, <span class="ruby-ivar">@pool_account_password</span>)
338:       <span class="ruby-keyword kw">begin</span>
339:         <span class="ruby-identifier">client</span>.<span class="ruby-identifier">detach</span>(<span class="ruby-ivar">@detach_key</span>)
340:       <span class="ruby-keyword kw">ensure</span>
341:         <span class="ruby-identifier">client</span>.<span class="ruby-identifier">close</span>
342:       <span class="ruby-keyword kw">end</span>
343:     <span class="ruby-keyword kw">end</span>
344:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000022">
                    
                    <a name="M000022"></a><b>start_main_loop_thread</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Start the main loop in a new thread. This thread will be stopped by <a
href="AbstractRequestHandler.html#M000017">cleanup</a>.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000022_source')" id="l_M000022_source">show</a>
                        
                    </p>
                    <div id="M000022_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 310</span>
310:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_main_loop_thread</span>
311:     <span class="ruby-identifier">current_generation</span> = <span class="ruby-ivar">@main_loop_generation</span>
312:     <span class="ruby-ivar">@main_loop_thread</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword kw">do</span>
313:       <span class="ruby-keyword kw">begin</span>
314:         <span class="ruby-identifier">main_loop</span>
315:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
316:         <span class="ruby-identifier">print_exception</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>, <span class="ruby-identifier">e</span>)
317:       <span class="ruby-keyword kw">end</span>
318:     <span class="ruby-keyword kw">end</span>
319:     <span class="ruby-ivar">@main_loop_thread_lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
320:       <span class="ruby-keyword kw">while</span> <span class="ruby-ivar">@main_loop_generation</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">current_generation</span>
321:         <span class="ruby-ivar">@main_loop_thread_cond</span>.<span class="ruby-identifier">wait</span>(<span class="ruby-ivar">@main_loop_thread_lock</span>)
322:       <span class="ruby-keyword kw">end</span>
323:     <span class="ruby-keyword kw">end</span>
324:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Private methods</div>
            
            <div class="method">
                <div class="title" id="M000041">
                    
                    <a name="M000041"></a><b>accept_and_process_next_request</b>(socket_wrapper, channel, buffer)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000041_source')" id="l_M000041_source">show</a>
                        
                    </p>
                    <div id="M000041_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 454</span>
454:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">accept_and_process_next_request</span>(<span class="ruby-identifier">socket_wrapper</span>, <span class="ruby-identifier">channel</span>, <span class="ruby-identifier">buffer</span>)
455:     <span class="ruby-identifier">select_result</span> = <span class="ruby-identifier">select</span>(<span class="ruby-ivar">@selectable_sockets</span>, <span class="ruby-keyword kw">nil</span>, <span class="ruby-keyword kw">nil</span>, <span class="ruby-ivar">@select_timeout</span>)
456:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">select_result</span>.<span class="ruby-identifier">nil?</span>
457:       <span class="ruby-comment cmt"># This can only happen after we've received a soft termination</span>
458:       <span class="ruby-comment cmt"># signal. No connection was accepted for @select_timeout seconds,</span>
459:       <span class="ruby-comment cmt"># so now we quit the main loop.</span>
460:       <span class="ruby-identifier">trace</span>(<span class="ruby-value">2</span>, <span class="ruby-value str">&quot;Soft termination timeout&quot;</span>)
461:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
462:     <span class="ruby-keyword kw">end</span>
463:     
464:     <span class="ruby-identifier">ios</span> = <span class="ruby-identifier">select_result</span>.<span class="ruby-identifier">first</span>
465:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">ios</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-ivar">@main_socket</span>)
466:       <span class="ruby-identifier">trace</span>(<span class="ruby-value">3</span>, <span class="ruby-value str">&quot;Accepting new request on main socket&quot;</span>)
467:       <span class="ruby-identifier">connection</span> = <span class="ruby-identifier">socket_wrapper</span>.<span class="ruby-identifier">wrap</span>(<span class="ruby-ivar">@main_socket</span>.<span class="ruby-identifier">accept</span>)
468:       <span class="ruby-identifier">channel</span>.<span class="ruby-identifier">io</span> = <span class="ruby-identifier">connection</span>
469:       <span class="ruby-identifier">headers</span>, <span class="ruby-identifier">input_stream</span> = <span class="ruby-identifier">parse_native_request</span>(<span class="ruby-identifier">connection</span>, <span class="ruby-identifier">channel</span>, <span class="ruby-identifier">buffer</span>)
470:       <span class="ruby-identifier">full_http_response</span> = <span class="ruby-keyword kw">false</span>
471:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">ios</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-ivar">@http_socket</span>)
472:       <span class="ruby-identifier">trace</span>(<span class="ruby-value">3</span>, <span class="ruby-value str">&quot;Accepting new request on HTTP socket&quot;</span>)
473:       <span class="ruby-identifier">connection</span> = <span class="ruby-identifier">socket_wrapper</span>.<span class="ruby-identifier">wrap</span>(<span class="ruby-ivar">@http_socket</span>.<span class="ruby-identifier">accept</span>)
474:       <span class="ruby-identifier">headers</span>, <span class="ruby-identifier">input_stream</span> = <span class="ruby-identifier">parse_http_request</span>(<span class="ruby-identifier">connection</span>)
475:       <span class="ruby-identifier">full_http_response</span> = <span class="ruby-keyword kw">true</span>
476:     <span class="ruby-keyword kw">else</span>
477:       <span class="ruby-comment cmt"># The other end of the owner pipe has been closed, or the</span>
478:       <span class="ruby-comment cmt"># graceful termination pipe has been closed. This is our</span>
479:       <span class="ruby-comment cmt"># call to gracefully terminate (after having processed all</span>
480:       <span class="ruby-comment cmt"># incoming requests).</span>
481:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@select_timeout</span>
482:         <span class="ruby-comment cmt"># But if @select_timeout is set then it means that we</span>
483:         <span class="ruby-comment cmt"># received a soft termination signal. In that case</span>
484:         <span class="ruby-comment cmt"># we don't want to quit immediately, but @select_timeout</span>
485:         <span class="ruby-comment cmt"># seconds after the last time a connection was accepted.</span>
486:         <span class="ruby-comment cmt">#</span>
487:         <span class="ruby-comment cmt"># #soft_shutdown not only closes the graceful termination</span>
488:         <span class="ruby-comment cmt"># pipe, but it also tells the application pool to remove</span>
489:         <span class="ruby-comment cmt"># this process from the pool, which will cause the owner</span>
490:         <span class="ruby-comment cmt"># pipe to be closed. So we remove both IO objects</span>
491:         <span class="ruby-comment cmt"># from @selectable_sockets in order to prevent the</span>
492:         <span class="ruby-comment cmt"># next select call from immediately returning, allowing</span>
493:         <span class="ruby-comment cmt"># it to time out.</span>
494:         <span class="ruby-ivar">@selectable_sockets</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">0</span>])
495:         <span class="ruby-ivar">@selectable_sockets</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-ivar">@owner_pipe</span>)
496:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
497:       <span class="ruby-keyword kw">else</span>
498:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">ios</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-ivar">@owner_pipe</span>)
499:           <span class="ruby-identifier">trace</span>(<span class="ruby-value">2</span>, <span class="ruby-value str">&quot;Owner pipe closed&quot;</span>)
500:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">ios</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-ivar">@graceful_termination_pipe</span>[<span class="ruby-value">0</span>])
501:           <span class="ruby-identifier">trace</span>(<span class="ruby-value">2</span>, <span class="ruby-value str">&quot;Graceful termination pipe closed&quot;</span>)
502:         <span class="ruby-keyword kw">end</span>
503:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
504:       <span class="ruby-keyword kw">end</span>
505:     <span class="ruby-keyword kw">end</span>
506:     
507:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">headers</span>
508:       <span class="ruby-identifier">prepare_request</span>(<span class="ruby-identifier">headers</span>)
509:       <span class="ruby-keyword kw">begin</span>
510:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">headers</span>[<span class="ruby-constant">REQUEST_METHOD</span>] <span class="ruby-operator">==</span> <span class="ruby-constant">PING</span>
511:           <span class="ruby-identifier">process_ping</span>(<span class="ruby-identifier">headers</span>, <span class="ruby-identifier">input_stream</span>, <span class="ruby-identifier">connection</span>)
512:         <span class="ruby-keyword kw">else</span>
513:           <span class="ruby-identifier">process_request</span>(<span class="ruby-identifier">headers</span>, <span class="ruby-identifier">input_stream</span>, <span class="ruby-identifier">connection</span>, <span class="ruby-identifier">full_http_response</span>)
514:         <span class="ruby-keyword kw">end</span>
515:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span>
516:         <span class="ruby-identifier">has_error</span> = <span class="ruby-keyword kw">true</span>
517:         <span class="ruby-identifier">raise</span>
518:       <span class="ruby-keyword kw">ensure</span>
519:         <span class="ruby-identifier">finalize_request</span>(<span class="ruby-identifier">headers</span>, <span class="ruby-identifier">has_error</span>)
520:       <span class="ruby-keyword kw">end</span>
521:     <span class="ruby-keyword kw">end</span>
522:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
523:   <span class="ruby-keyword kw">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
524:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">socket_wrapper</span>.<span class="ruby-identifier">source_of_exception?</span>(<span class="ruby-identifier">e</span>)
525:       <span class="ruby-comment cmt"># EPIPE is harmless, it just means that the client closed the connection.</span>
526:       <span class="ruby-comment cmt"># Other errors might indicate a problem so we print them, but they're</span>
527:       <span class="ruby-comment cmt"># probably not bad enough to warrant stopping the request handler.</span>
528:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">e</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EPIPE</span>)
529:         <span class="ruby-identifier">print_exception</span>(<span class="ruby-value str">&quot;Passenger RequestHandler's client socket&quot;</span>, <span class="ruby-identifier">e</span>)
530:       <span class="ruby-keyword kw">end</span>
531:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
532:     <span class="ruby-keyword kw">else</span>
533:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@analytics_logger</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">headers</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">headers</span>[<span class="ruby-constant">PASSENGER_TXN_ID</span>]
534:         <span class="ruby-identifier">log_analytics_exception</span>(<span class="ruby-identifier">headers</span>, <span class="ruby-identifier">e</span>)
535:       <span class="ruby-keyword kw">end</span>
536:       <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span>
537:     <span class="ruby-keyword kw">end</span>
538:   <span class="ruby-keyword kw">ensure</span>
539:     <span class="ruby-comment cmt"># The 'close_write' here prevents forked child</span>
540:     <span class="ruby-comment cmt"># processes from unintentionally keeping the</span>
541:     <span class="ruby-comment cmt"># connection open.</span>
542:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">connection</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">connection</span>.<span class="ruby-identifier">closed?</span>
543:       <span class="ruby-keyword kw">begin</span>
544:         <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">close_write</span>
545:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SystemCallError</span>
546:       <span class="ruby-keyword kw">end</span>
547:       <span class="ruby-keyword kw">begin</span>
548:         <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">close</span>
549:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SystemCallError</span>
550:       <span class="ruby-keyword kw">end</span>
551:     <span class="ruby-keyword kw">end</span>
552:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">input_stream</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">input_stream</span>.<span class="ruby-identifier">closed?</span>
553:       <span class="ruby-identifier">input_stream</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
554:     <span class="ruby-keyword kw">end</span>
555:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000029">
                    
                    <a name="M000029"></a><b>create_tcp_socket</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000029_source')" id="l_M000029_source">show</a>
                        
                    </p>
                    <div id="M000029_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 400</span>
400:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_tcp_socket</span>
401:     <span class="ruby-comment cmt"># We use &quot;127.0.0.1&quot; as address in order to force</span>
402:     <span class="ruby-comment cmt"># TCPv4 instead of TCPv6.</span>
403:     <span class="ruby-identifier">socket</span> = <span class="ruby-constant">TCPServer</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'127.0.0.1'</span>, <span class="ruby-value">0</span>)
404:     <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">listen</span>(<span class="ruby-constant">BACKLOG_SIZE</span>)
405:     <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">close_on_exec!</span>
406:     <span class="ruby-identifier">socket_address</span> = <span class="ruby-node">&quot;127.0.0.1:#{socket.addr[1]}&quot;</span>
407:     <span class="ruby-keyword kw">return</span> [<span class="ruby-identifier">socket_address</span>, <span class="ruby-identifier">socket</span>]
408:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000027">
                    
                    <a name="M000027"></a><b>create_unix_socket_on_filesystem</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000027_source')" id="l_M000027_source">show</a>
                        
                    </p>
                    <div id="M000027_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 379</span>
379:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_unix_socket_on_filesystem</span>
380:     <span class="ruby-keyword kw">while</span> <span class="ruby-keyword kw">true</span>
381:       <span class="ruby-keyword kw">begin</span>
382:         <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">defined?</span>(<span class="ruby-constant">NativeSupport</span>)
383:           <span class="ruby-identifier">unix_path_max</span> = <span class="ruby-constant">NativeSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">UNIX_PATH_MAX</span>
384:         <span class="ruby-keyword kw">else</span>
385:           <span class="ruby-identifier">unix_path_max</span> = <span class="ruby-value">100</span>
386:         <span class="ruby-keyword kw">end</span>
387:         <span class="ruby-identifier">socket_address</span> = <span class="ruby-node">&quot;#{passenger_tmpdir}/backends/ruby.#{generate_random_id(:base64)}&quot;</span>
388:         <span class="ruby-identifier">socket_address</span> = <span class="ruby-identifier">socket_address</span>.<span class="ruby-identifier">slice</span>(<span class="ruby-value">0</span>, <span class="ruby-identifier">unix_path_max</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)
389:         <span class="ruby-identifier">socket</span> = <span class="ruby-constant">UNIXServer</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">socket_address</span>)
390:         <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">listen</span>(<span class="ruby-constant">BACKLOG_SIZE</span>)
391:         <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">close_on_exec!</span>
392:         <span class="ruby-constant">File</span>.<span class="ruby-identifier">chmod</span>(<span class="ruby-value">0666</span>, <span class="ruby-identifier">socket_address</span>)
393:         <span class="ruby-keyword kw">return</span> [<span class="ruby-identifier">socket_address</span>, <span class="ruby-identifier">socket</span>]
394:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EADDRINUSE</span>
395:         <span class="ruby-comment cmt"># Do nothing, try again with another name.</span>
396:       <span class="ruby-keyword kw">end</span>
397:     <span class="ruby-keyword kw">end</span>
398:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000048">
                    
                    <a name="M000048"></a><b>determine_passenger_header</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000048_source')" id="l_M000048_source">show</a>
                        
                    </p>
                    <div id="M000048_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 642</span>
642:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">determine_passenger_header</span>
643:     <span class="ruby-identifier">header</span> = <span class="ruby-value str">&quot;Phusion Passenger (mod_rails/mod_rack)&quot;</span>
644:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@options</span>[<span class="ruby-value str">&quot;show_version_in_header&quot;</span>]
645:       <span class="ruby-identifier">header</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; #{VERSION_STRING}&quot;</span>
646:     <span class="ruby-keyword kw">end</span>
647:     <span class="ruby-keyword kw">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-node">&quot;#{SOURCE_ROOT}/enterprisey.txt&quot;</span>) <span class="ruby-operator">||</span>
648:        <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-value str">&quot;/etc/passenger_enterprisey.txt&quot;</span>)
649:       <span class="ruby-identifier">header</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;, Enterprise Edition&quot;</span>
650:     <span class="ruby-keyword kw">end</span>
651:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">header</span>
652:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000052">
                    
                    <a name="M000052"></a><b>finalize_request</b>(headers, has_error)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000052_source')" id="l_M000052_source">show</a>
                        
                    </p>
                    <div id="M000052_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 684</span>
684:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">finalize_request</span>(<span class="ruby-identifier">headers</span>, <span class="ruby-identifier">has_error</span>)
685:     <span class="ruby-identifier">log</span> = <span class="ruby-identifier">headers</span>[<span class="ruby-constant">PASSENGER_ANALYTICS_WEB_LOG</span>]
686:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">log</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">log</span>.<span class="ruby-identifier">closed?</span>
687:       <span class="ruby-identifier">exception_occurred</span> = <span class="ruby-keyword kw">false</span>
688:       <span class="ruby-keyword kw">begin</span>
689:         <span class="ruby-identifier">log</span>.<span class="ruby-identifier">end_measure</span>(<span class="ruby-value str">&quot;app request handler processing&quot;</span>, <span class="ruby-identifier">has_error</span>)
690:         <span class="ruby-keyword kw">if</span> <span class="ruby-constant">OBJECT_SPACE_SUPPORTS_LIVE_OBJECTS</span>
691:           <span class="ruby-identifier">log</span>.<span class="ruby-identifier">message</span>(<span class="ruby-node">&quot;Final objects on heap: #{ObjectSpace.live_objects}&quot;</span>)
692:         <span class="ruby-keyword kw">end</span>
693:         <span class="ruby-keyword kw">if</span> <span class="ruby-constant">OBJECT_SPACE_SUPPORTS_ALLOCATED_OBJECTS</span>
694:           <span class="ruby-identifier">log</span>.<span class="ruby-identifier">message</span>(<span class="ruby-node">&quot;Final objects allocated so far: #{ObjectSpace.allocated_objects}&quot;</span>)
695:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-constant">OBJECT_SPACE_SUPPORTS_COUNT_OBJECTS</span>
696:           <span class="ruby-identifier">count</span> = <span class="ruby-constant">ObjectSpace</span>.<span class="ruby-identifier">count_objects</span>
697:           <span class="ruby-identifier">log</span>.<span class="ruby-identifier">message</span>(<span class="ruby-node">&quot;Final objects allocated so far: #{count[:TOTAL] - count[:FREE]}&quot;</span>)
698:         <span class="ruby-keyword kw">end</span>
699:         <span class="ruby-keyword kw">if</span> <span class="ruby-constant">GC_SUPPORTS_TIME</span>
700:           <span class="ruby-identifier">log</span>.<span class="ruby-identifier">message</span>(<span class="ruby-node">&quot;Final GC time: #{GC.time}&quot;</span>)
701:         <span class="ruby-keyword kw">end</span>
702:         <span class="ruby-keyword kw">if</span> <span class="ruby-constant">GC_SUPPORTS_CLEAR_STATS</span>
703:           <span class="ruby-comment cmt"># Clear statistics to void integer wraps.</span>
704:           <span class="ruby-constant">GC</span>.<span class="ruby-identifier">clear_stats</span>
705:         <span class="ruby-keyword kw">end</span>
706:         <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-constant">PASSENGER_ANALYTICS_WEB_LOG</span>] = <span class="ruby-keyword kw">nil</span>
707:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span>
708:         <span class="ruby-comment cmt"># Maybe this exception was raised while communicating</span>
709:         <span class="ruby-comment cmt"># with the logging agent. If that is the case then</span>
710:         <span class="ruby-comment cmt"># log.close may also raise an exception, but we're only</span>
711:         <span class="ruby-comment cmt"># interested in the original exception. So if this</span>
712:         <span class="ruby-comment cmt"># situation occurs we must ignore any exceptions raised</span>
713:         <span class="ruby-comment cmt"># by log.close.</span>
714:         <span class="ruby-identifier">exception_occurred</span> = <span class="ruby-keyword kw">true</span>
715:         <span class="ruby-identifier">raise</span>
716:       <span class="ruby-keyword kw">ensure</span>
717:         <span class="ruby-comment cmt"># It is important that the following call receives an ACK</span>
718:         <span class="ruby-comment cmt"># from the logging agent and that we don't close the socket</span>
719:         <span class="ruby-comment cmt"># connection until the ACK has been received, otherwise</span>
720:         <span class="ruby-comment cmt"># the helper agent may close the transaction before this</span>
721:         <span class="ruby-comment cmt"># process's openTransaction command is processed.</span>
722:         <span class="ruby-keyword kw">begin</span>
723:           <span class="ruby-identifier">log</span>.<span class="ruby-identifier">close</span>
724:         <span class="ruby-keyword kw">rescue</span>
725:           <span class="ruby-identifier">raise</span> <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">exception_occurred</span>
726:         <span class="ruby-keyword kw">end</span>
727:       <span class="ruby-keyword kw">end</span>
728:     <span class="ruby-keyword kw">end</span>
729:     
730:     <span class="ruby-comment cmt">#################</span>
731:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000034">
                    
                    <a name="M000034"></a><b>install_useful_signal_handlers</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000034_source')" id="l_M000034_source">show</a>
                        
                    </p>
                    <div id="M000034_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 428</span>
428:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">install_useful_signal_handlers</span>
429:     <span class="ruby-identifier">trappable_signals</span> = <span class="ruby-constant">Signal</span>.<span class="ruby-identifier">list_trappable</span>
430:     
431:     <span class="ruby-identifier">trap</span>(<span class="ruby-constant">SOFT_TERMINATION_SIGNAL</span>) <span class="ruby-keyword kw">do</span>
432:       <span class="ruby-keyword kw">begin</span>
433:         <span class="ruby-identifier">soft_shutdown</span>
434:       <span class="ruby-keyword kw">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
435:         <span class="ruby-identifier">print_exception</span>(<span class="ruby-value str">&quot;Passenger RequestHandler soft shutdown routine&quot;</span>, <span class="ruby-identifier">e</span>)
436:       <span class="ruby-keyword kw">end</span>
437:     <span class="ruby-keyword kw">end</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">trappable_signals</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-constant">SOFT_TERMINATION_SIGNAL</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp re">/^SIG/</span>, <span class="ruby-value str">''</span>))
438:     
439:     <span class="ruby-identifier">trap</span>(<span class="ruby-value str">'ABRT'</span>) <span class="ruby-keyword kw">do</span>
440:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">SignalException</span>, <span class="ruby-value str">&quot;SIGABRT&quot;</span>
441:     <span class="ruby-keyword kw">end</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">trappable_signals</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-value str">'ABRT'</span>)
442:     
443:     <span class="ruby-identifier">trap</span>(<span class="ruby-value str">'QUIT'</span>) <span class="ruby-keyword kw">do</span>
444:       <span class="ruby-identifier">warn</span>(<span class="ruby-identifier">global_backtrace_report</span>)
445:     <span class="ruby-keyword kw">end</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">trappable_signals</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-value str">'QUIT'</span>)
446:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000054">
                    
                    <a name="M000054"></a><b>log_analytics_exception</b>(env, exception)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000054_source')" id="l_M000054_source">show</a>
                        
                    </p>
                    <div id="M000054_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 733</span>
733:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">log_analytics_exception</span>(<span class="ruby-identifier">env</span>, <span class="ruby-identifier">exception</span>)
734:     <span class="ruby-identifier">log</span> = <span class="ruby-ivar">@analytics_logger</span>.<span class="ruby-identifier">new_transaction</span>(
735:       <span class="ruby-identifier">env</span>[<span class="ruby-constant">PASSENGER_GROUP_NAME</span>],
736:       <span class="ruby-identifier">:exceptions</span>,
737:       <span class="ruby-identifier">env</span>[<span class="ruby-constant">PASSENGER_UNION_STATION_KEY</span>])
738:     <span class="ruby-keyword kw">begin</span>
739:       <span class="ruby-identifier">request_txn_id</span> = <span class="ruby-identifier">env</span>[<span class="ruby-constant">PASSENGER_TXN_ID</span>]
740:       <span class="ruby-identifier">message</span> = <span class="ruby-identifier">exception</span>.<span class="ruby-identifier">message</span>
741:       <span class="ruby-identifier">message</span> = <span class="ruby-identifier">exception</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">message</span>.<span class="ruby-identifier">empty?</span>
742:       <span class="ruby-identifier">message</span> = [<span class="ruby-identifier">message</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">'m'</span>)
743:       <span class="ruby-identifier">message</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-value str">&quot;\n&quot;</span>, <span class="ruby-value str">&quot;&quot;</span>)
744:       <span class="ruby-identifier">backtrace_string</span> = [<span class="ruby-identifier">exception</span>.<span class="ruby-identifier">backtrace</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;\n&quot;</span>)].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">'m'</span>)
745:       <span class="ruby-identifier">backtrace_string</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-value str">&quot;\n&quot;</span>, <span class="ruby-value str">&quot;&quot;</span>)
746: 
747:       <span class="ruby-identifier">log</span>.<span class="ruby-identifier">message</span>(<span class="ruby-node">&quot;Request transaction ID: #{request_txn_id}&quot;</span>)
748:       <span class="ruby-identifier">log</span>.<span class="ruby-identifier">message</span>(<span class="ruby-node">&quot;Message: #{message}&quot;</span>)
749:       <span class="ruby-identifier">log</span>.<span class="ruby-identifier">message</span>(<span class="ruby-node">&quot;Class: #{exception.class.name}&quot;</span>)
750:       <span class="ruby-identifier">log</span>.<span class="ruby-identifier">message</span>(<span class="ruby-node">&quot;Backtrace: #{backtrace_string}&quot;</span>)
751:     <span class="ruby-keyword kw">ensure</span>
752:       <span class="ruby-identifier">log</span>.<span class="ruby-identifier">close</span>
753:     <span class="ruby-keyword kw">end</span>
754:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000046">
                    
                    <a name="M000046"></a><b>parse_http_request</b>(socket)
                    
                </div>
                
                <div class="description">
                  <p>
Like <a
href="AbstractRequestHandler.html#M000045">parse_native_request</a>, but
parses an HTTP request. This is a very minimalistic HTTP parser and is not
intended to be complete, fast or secure, since the HTTP server socket is
intended to be used for debugging purposes only.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000046_source')" id="l_M000046_source">show</a>
                        
                    </p>
                    <div id="M000046_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 585</span>
585:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">parse_http_request</span>(<span class="ruby-identifier">socket</span>)
586:     <span class="ruby-identifier">headers</span> = {}
587:     
588:     <span class="ruby-identifier">data</span> = <span class="ruby-value str">&quot;&quot;</span>
589:     <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">data</span> <span class="ruby-operator">!~</span> <span class="ruby-regexp re">/\r\n\r\n/</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">MAX_HEADER_SIZE</span>
590:       <span class="ruby-identifier">data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">readpartial</span>(<span class="ruby-value">16</span> <span class="ruby-operator">*</span> <span class="ruby-value">1024</span>)
591:     <span class="ruby-keyword kw">end</span>
592:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-constant">MAX_HEADER_SIZE</span>
593:       <span class="ruby-identifier">warn</span>(<span class="ruby-value str">&quot;*** Passenger RequestHandler warning: &quot;</span> <span class="ruby-operator">&lt;&lt;</span>
594:         <span class="ruby-value str">&quot;HTTP header size exceeded maximum.&quot;</span>)
595:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
596:     <span class="ruby-keyword kw">end</span>
597:     
598:     <span class="ruby-identifier">data</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp re">/\r\n\r\n.*/</span>, <span class="ruby-value str">''</span>)
599:     <span class="ruby-identifier">data</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">&quot;\r\n&quot;</span>).<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">line</span>, <span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
600:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
601:         <span class="ruby-comment cmt"># GET / HTTP/1.1</span>
602:         <span class="ruby-identifier">line</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/^([A-Za-z]+) (.+?) (HTTP\/\d\.\d)$/</span>
603:         <span class="ruby-identifier">request_method</span> = <span class="ruby-identifier">$1</span>
604:         <span class="ruby-identifier">request_uri</span>    = <span class="ruby-identifier">$2</span>
605:         <span class="ruby-identifier">protocol</span>       = <span class="ruby-identifier">$3</span>
606:         <span class="ruby-identifier">path_info</span>, <span class="ruby-identifier">query_string</span>    = <span class="ruby-identifier">request_uri</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">&quot;?&quot;</span>, <span class="ruby-value">2</span>)
607:         <span class="ruby-identifier">headers</span>[<span class="ruby-constant">REQUEST_METHOD</span>]    = <span class="ruby-identifier">request_method</span>
608:         <span class="ruby-identifier">headers</span>[<span class="ruby-value str">&quot;REQUEST_URI&quot;</span>]     = <span class="ruby-identifier">request_uri</span>
609:         <span class="ruby-identifier">headers</span>[<span class="ruby-value str">&quot;QUERY_STRING&quot;</span>]    = <span class="ruby-identifier">query_string</span> <span class="ruby-operator">||</span> <span class="ruby-value str">&quot;&quot;</span>
610:         <span class="ruby-identifier">headers</span>[<span class="ruby-value str">&quot;SCRIPT_NAME&quot;</span>]     = <span class="ruby-value str">&quot;&quot;</span>
611:         <span class="ruby-identifier">headers</span>[<span class="ruby-value str">&quot;PATH_INFO&quot;</span>]       = <span class="ruby-identifier">path_info</span>
612:         <span class="ruby-identifier">headers</span>[<span class="ruby-value str">&quot;SERVER_NAME&quot;</span>]     = <span class="ruby-value str">&quot;127.0.0.1&quot;</span>
613:         <span class="ruby-identifier">headers</span>[<span class="ruby-value str">&quot;SERVER_PORT&quot;</span>]     = <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">addr</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_s</span>
614:         <span class="ruby-identifier">headers</span>[<span class="ruby-value str">&quot;SERVER_PROTOCOL&quot;</span>] = <span class="ruby-identifier">protocol</span>
615:       <span class="ruby-keyword kw">else</span>
616:         <span class="ruby-identifier">header</span>, <span class="ruby-identifier">value</span> = <span class="ruby-identifier">line</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp re">/\s*:\s*/</span>, <span class="ruby-value">2</span>)
617:         <span class="ruby-identifier">header</span>.<span class="ruby-identifier">upcase!</span>            <span class="ruby-comment cmt"># &quot;Foo-Bar&quot; =&gt; &quot;FOO-BAR&quot;</span>
618:         <span class="ruby-identifier">header</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-value str">&quot;-&quot;</span>, <span class="ruby-value str">&quot;_&quot;</span>)    <span class="ruby-comment cmt">#           =&gt; &quot;FOO_BAR&quot;</span>
619:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">header</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;CONTENT_LENGTH&quot;</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">header</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;CONTENT_TYPE&quot;</span>
620:           <span class="ruby-identifier">headers</span>[<span class="ruby-identifier">header</span>] = <span class="ruby-identifier">value</span>
621:         <span class="ruby-keyword kw">else</span>
622:           <span class="ruby-identifier">headers</span>[<span class="ruby-node">&quot;HTTP_#{header}&quot;</span>] = <span class="ruby-identifier">value</span>
623:         <span class="ruby-keyword kw">end</span>
624:       <span class="ruby-keyword kw">end</span>
625:     <span class="ruby-keyword kw">end</span>
626:     
627:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@connect_password</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">headers</span>[<span class="ruby-value str">&quot;HTTP_X_PASSENGER_CONNECT_PASSWORD&quot;</span>] <span class="ruby-operator">!=</span> <span class="ruby-ivar">@connect_password</span>
628:       <span class="ruby-identifier">warn</span> <span class="ruby-value str">&quot;*** Passenger RequestHandler warning: &quot;</span> <span class="ruby-operator">&lt;&lt;</span>
629:         <span class="ruby-value str">&quot;someone tried to connect with an invalid connect password.&quot;</span>
630:       <span class="ruby-keyword kw">return</span>
631:     <span class="ruby-keyword kw">else</span>
632:       <span class="ruby-keyword kw">return</span> [<span class="ruby-identifier">headers</span>, <span class="ruby-identifier">socket</span>]
633:     <span class="ruby-keyword kw">end</span>
634:   <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">EOFError</span>
635:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
636:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000045">
                    
                    <a name="M000045"></a><b>parse_native_request</b>(socket, channel, buffer)
                    
                </div>
                
                <div class="description">
                  <p>
Read the next request from the given socket, and return a pair [headers,
input_stream]. <em>headers</em> is a Hash containing the request headers,
while <em>input_stream</em> is an <a href="../IO.html">IO</a> object for
reading HTTP POST data.
</p>
<p>
Returns nil if end-of-stream was encountered.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000045_source')" id="l_M000045_source">show</a>
                        
                    </p>
                    <div id="M000045_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 563</span>
563:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">parse_native_request</span>(<span class="ruby-identifier">socket</span>, <span class="ruby-identifier">channel</span>, <span class="ruby-identifier">buffer</span>)
564:     <span class="ruby-identifier">headers_data</span> = <span class="ruby-identifier">channel</span>.<span class="ruby-identifier">read_scalar</span>(<span class="ruby-identifier">buffer</span>, <span class="ruby-constant">MAX_HEADER_SIZE</span>)
565:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">headers_data</span>.<span class="ruby-identifier">nil?</span>
566:       <span class="ruby-keyword kw">return</span>
567:     <span class="ruby-keyword kw">end</span>
568:     <span class="ruby-identifier">headers</span> = <span class="ruby-identifier">split_by_null_into_hash</span>(<span class="ruby-identifier">headers_data</span>)
569:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@connect_password</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">headers</span>[<span class="ruby-constant">PASSENGER_CONNECT_PASSWORD</span>] <span class="ruby-operator">!=</span> <span class="ruby-ivar">@connect_password</span>
570:       <span class="ruby-identifier">warn</span> <span class="ruby-value str">&quot;*** Passenger RequestHandler warning: &quot;</span> <span class="ruby-operator">&lt;&lt;</span>
571:         <span class="ruby-value str">&quot;someone tried to connect with an invalid connect password.&quot;</span>
572:       <span class="ruby-keyword kw">return</span>
573:     <span class="ruby-keyword kw">else</span>
574:       <span class="ruby-keyword kw">return</span> [<span class="ruby-identifier">headers</span>, <span class="ruby-identifier">socket</span>]
575:     <span class="ruby-keyword kw">end</span>
576:   <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SecurityError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
577:     <span class="ruby-identifier">warn</span>(<span class="ruby-value str">&quot;*** Passenger RequestHandler warning: &quot;</span> <span class="ruby-operator">&lt;&lt;</span>
578:       <span class="ruby-value str">&quot;HTTP header size exceeded maximum.&quot;</span>)
579:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
580:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000050">
                    
                    <a name="M000050"></a><b>prepare_request</b>(headers)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000050_source')" id="l_M000050_source">show</a>
                        
                    </p>
                    <div id="M000050_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 654</span>
654:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">prepare_request</span>(<span class="ruby-identifier">headers</span>)
655:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@analytics_logger</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">headers</span>[<span class="ruby-constant">PASSENGER_TXN_ID</span>]
656:       <span class="ruby-identifier">txn_id</span> = <span class="ruby-identifier">headers</span>[<span class="ruby-constant">PASSENGER_TXN_ID</span>]
657:       <span class="ruby-identifier">group_name</span> = <span class="ruby-identifier">headers</span>[<span class="ruby-constant">PASSENGER_GROUP_NAME</span>]
658:       <span class="ruby-identifier">union_station_key</span> = <span class="ruby-identifier">headers</span>[<span class="ruby-constant">PASSENGER_UNION_STATION_KEY</span>]
659:       <span class="ruby-identifier">log</span> = <span class="ruby-ivar">@analytics_logger</span>.<span class="ruby-identifier">continue_transaction</span>(<span class="ruby-identifier">txn_id</span>, <span class="ruby-identifier">group_name</span>,
660:         <span class="ruby-identifier">:requests</span>, <span class="ruby-identifier">union_station_key</span>)
661:       <span class="ruby-identifier">headers</span>[<span class="ruby-constant">PASSENGER_ANALYTICS_WEB_LOG</span>] = <span class="ruby-identifier">log</span>
662:       <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-constant">PASSENGER_ANALYTICS_WEB_LOG</span>] = <span class="ruby-identifier">log</span>
663:       <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-constant">PASSENGER_TXN_ID</span>] = <span class="ruby-identifier">txn_id</span>
664:       <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-constant">PASSENGER_GROUP_NAME</span>] = <span class="ruby-identifier">group_name</span>
665:       <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-constant">PASSENGER_UNION_STATION_KEY</span>] = <span class="ruby-identifier">union_station_key</span>
666:       <span class="ruby-keyword kw">if</span> <span class="ruby-constant">OBJECT_SPACE_SUPPORTS_LIVE_OBJECTS</span>
667:         <span class="ruby-identifier">log</span>.<span class="ruby-identifier">message</span>(<span class="ruby-node">&quot;Initial objects on heap: #{ObjectSpace.live_objects}&quot;</span>)
668:       <span class="ruby-keyword kw">end</span>
669:       <span class="ruby-keyword kw">if</span> <span class="ruby-constant">OBJECT_SPACE_SUPPORTS_ALLOCATED_OBJECTS</span>
670:         <span class="ruby-identifier">log</span>.<span class="ruby-identifier">message</span>(<span class="ruby-node">&quot;Initial objects allocated so far: #{ObjectSpace.allocated_objects}&quot;</span>)
671:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-constant">OBJECT_SPACE_SUPPORTS_COUNT_OBJECTS</span>
672:         <span class="ruby-identifier">count</span> = <span class="ruby-constant">ObjectSpace</span>.<span class="ruby-identifier">count_objects</span>
673:         <span class="ruby-identifier">log</span>.<span class="ruby-identifier">message</span>(<span class="ruby-node">&quot;Initial objects allocated so far: #{count[:TOTAL] - count[:FREE]}&quot;</span>)
674:       <span class="ruby-keyword kw">end</span>
675:       <span class="ruby-keyword kw">if</span> <span class="ruby-constant">GC_SUPPORTS_TIME</span>
676:         <span class="ruby-identifier">log</span>.<span class="ruby-identifier">message</span>(<span class="ruby-node">&quot;Initial GC time: #{GC.time}&quot;</span>)
677:       <span class="ruby-keyword kw">end</span>
678:       <span class="ruby-identifier">log</span>.<span class="ruby-identifier">begin_measure</span>(<span class="ruby-value str">&quot;app request handler processing&quot;</span>)
679:     <span class="ruby-keyword kw">end</span>
680:     
681:     <span class="ruby-comment cmt">#################</span>
682:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000047">
                    
                    <a name="M000047"></a><b>process_ping</b>(env, input, output)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000047_source')" id="l_M000047_source">show</a>
                        
                    </p>
                    <div id="M000047_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 638</span>
638:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">process_ping</span>(<span class="ruby-identifier">env</span>, <span class="ruby-identifier">input</span>, <span class="ruby-identifier">output</span>)
639:     <span class="ruby-identifier">output</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value str">&quot;pong&quot;</span>)
640:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000033">
                    
                    <a name="M000033"></a><b>reset_signal_handlers</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Reset signal handlers to their default handler, and install some special
handlers for a few signals. The previous signal handlers will be put back
by calling revert_signal_handlers.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000033_source')" id="l_M000033_source">show</a>
                        
                    </p>
                    <div id="M000033_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 413</span>
413:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">reset_signal_handlers</span>
414:     <span class="ruby-constant">Signal</span>.<span class="ruby-identifier">list_trappable</span>.<span class="ruby-identifier">each_key</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">signal</span><span class="ruby-operator">|</span>
415:       <span class="ruby-keyword kw">begin</span>
416:         <span class="ruby-identifier">prev_handler</span> = <span class="ruby-identifier">trap</span>(<span class="ruby-identifier">signal</span>, <span class="ruby-constant">DEFAULT</span>)
417:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">prev_handler</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">DEFAULT</span>
418:           <span class="ruby-ivar">@previous_signal_handlers</span>[<span class="ruby-identifier">signal</span>] = <span class="ruby-identifier">prev_handler</span>
419:         <span class="ruby-keyword kw">end</span>
420:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">ArgumentError</span>
421:         <span class="ruby-comment cmt"># Signal cannot be trapped; ignore it.</span>
422:       <span class="ruby-keyword kw">end</span>
423:     <span class="ruby-keyword kw">end</span>
424:     <span class="ruby-identifier">trap</span>(<span class="ruby-value str">'HUP'</span>, <span class="ruby-constant">IGNORE</span>)
425:     <span class="ruby-constant">PhusionPassenger</span>.<span class="ruby-identifier">call_event</span>(<span class="ruby-identifier">:after_installing_signal_handlers</span>)
426:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000040">
                    
                    <a name="M000040"></a><b>revert_signal_handlers</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000040_source')" id="l_M000040_source">show</a>
                        
                    </p>
                    <div id="M000040_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 448</span>
448:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">revert_signal_handlers</span>
449:     <span class="ruby-ivar">@previous_signal_handlers</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">signal</span>, <span class="ruby-identifier">handler</span><span class="ruby-operator">|</span>
450:       <span class="ruby-identifier">trap</span>(<span class="ruby-identifier">signal</span>, <span class="ruby-identifier">handler</span>)
451:     <span class="ruby-keyword kw">end</span>
452:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000025">
                    
                    <a name="M000025"></a><b>should_use_unix_sockets?</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000025_source')" id="l_M000025_source">show</a>
                        
                    </p>
                    <div id="M000025_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_request_handler.rb, line 349</span>
349:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">should_use_unix_sockets?</span>
350:     <span class="ruby-comment cmt"># Historical note:</span>
351:     <span class="ruby-comment cmt"># There seems to be a bug in MacOS X Leopard w.r.t. Unix server</span>
352:     <span class="ruby-comment cmt"># sockets file descriptors that are passed to another process.</span>
353:     <span class="ruby-comment cmt"># Usually Unix server sockets work fine, but when they're passed</span>
354:     <span class="ruby-comment cmt"># to another process, then clients that connect to the socket</span>
355:     <span class="ruby-comment cmt"># can incorrectly determine that the client socket is closed,</span>
356:     <span class="ruby-comment cmt"># even though that's not actually the case. More specifically:</span>
357:     <span class="ruby-comment cmt"># recv()/read() calls on these client sockets can return 0 even</span>
358:     <span class="ruby-comment cmt"># when we know EOF is not reached.</span>
359:     <span class="ruby-comment cmt">#</span>
360:     <span class="ruby-comment cmt"># The ApplicationPool infrastructure used to connect to a backend</span>
361:     <span class="ruby-comment cmt"># process's Unix socket in the helper server process, and then</span>
362:     <span class="ruby-comment cmt"># pass the connection file descriptor to the web server, which</span>
363:     <span class="ruby-comment cmt"># triggers this kernel bug. We used to work around this by using</span>
364:     <span class="ruby-comment cmt"># TCP sockets instead of Unix sockets; TCP sockets can still fail</span>
365:     <span class="ruby-comment cmt"># with this fake-EOF bug once in a while, but not nearly as often</span>
366:     <span class="ruby-comment cmt"># as with Unix sockets.</span>
367:     <span class="ruby-comment cmt">#</span>
368:     <span class="ruby-comment cmt"># This problem no longer applies today. The client socket is now</span>
369:     <span class="ruby-comment cmt"># created directly in the web server, and the bug is no longer</span>
370:     <span class="ruby-comment cmt"># triggered. Nevertheless, we keep this function intact so that</span>
371:     <span class="ruby-comment cmt"># if something like this ever happens again, we know why, and we</span>
372:     <span class="ruby-comment cmt"># can easily reactivate the workaround. Or maybe if we just need</span>
373:     <span class="ruby-comment cmt"># TCP sockets for some other reason.</span>
374:     
375:     <span class="ruby-comment cmt">#return RUBY_PLATFORM !~ /darwin/</span>
376:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
377:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    