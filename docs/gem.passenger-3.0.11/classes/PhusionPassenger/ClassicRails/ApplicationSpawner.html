<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>PhusionPassenger::ClassicRails::ApplicationSpawner</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../../css/main.css" type="text/css" media="screen" />
    <script src="../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            PhusionPassenger::ClassicRails::ApplicationSpawner 
            
                <span class="parent">&lt; 
                    
                    AbstractServer
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../files/lib/phusion_passenger/classic_rails/application_spawner_rb.html">lib/phusion_passenger/classic_rails/application_spawner.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
Spawning of Rails 1 and Rails 2 applications.
</p>
<p>
<a href="ApplicationSpawner.html">ClassicRails::ApplicationSpawner</a> can
operate in two modes:
</p>
<ul>
<li>Smart mode. In this mode, the Rails application&#8217;s code is first
preloaded into a temporary process, which can then further fork off
application processes. Once the code has been preloaded, forking off
application processes is very fast, and all the forked off application
processes can share code memory with each other. To use this mode, create
an <a href="ApplicationSpawner.html">ApplicationSpawner</a> object, start
it, and call <a
href="ApplicationSpawner.html#M000141">spawn_application</a> on it. A
single <a href="ApplicationSpawner.html">ApplicationSpawner</a> object can
only handle a single Rails application.

</li>
<li>Conservative mode. In this mode, a Rails app process is directly spawned
without any preloading. This increases compatibility with applications. To
use this mode, call <a
href="ApplicationSpawner.html#M000141">ApplicationSpawner.spawn_application</a>.

</li>
</ul>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>F</dt>
        <dd>
            <ul>
                
                <li><a href="#M000161">find_rack_app</a></li>
                
            </ul>
        </dd>
    
        <dt>H</dt>
        <dd>
            <ul>
                
                <li><a href="#M000158">handle_spawn_application</a></li>
                
            </ul>
        </dd>
    
        <dt>L</dt>
        <dd>
            <ul>
                
                <li><a href="#M000156">load_environment_with_passenger</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M000145">new</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M000155">preload_application</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000157">rails_will_preload_app_code?</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M000146">spawn_application</a>,</li>
                
                <li><a href="#M000141">spawn_application</a>,</li>
                
                <li><a href="#M000147">start</a>,</li>
                
                <li><a href="#M000159">start_request_handler</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    
    <div class="sectiontitle">Included Modules</div>
    <ul>
        
        <li>
            
            <a href="../Rack.html">PhusionPassenger::Rack</a>
            
            START:includes
        </li>
        
        <li>
            
            <a href="../Rack.html">PhusionPassenger::Rack</a>
            
            START:includes
        </li>
        
    </ul>
    

    

    
    <div class="sectiontitle">Classes and Modules</div>
    <ul>
        
        <li><span class="type">CLASS</span> <a href="ApplicationSpawner/Error.html">PhusionPassenger::ClassicRails::ApplicationSpawner::Error</a></li>
        
    </ul>
    

    

    
    <div class="sectiontitle">Attributes</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>app_root</td>
            <td class='attr-desc'><p>
The application root of this spawner.
</p></td>
        </tr>
        
    </table>
    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M000145">
                    
                    <a name="M000145"></a><b>new</b>(options)
                    
                </div>
                
                <div class="description">
                  <p>
The following options are accepted:
</p>
<ul>
<li>&#8216;<a href="ApplicationSpawner.html#app_root">app_root</a>&#8216;

</li>
</ul>
<p>
See <a
href="../SpawnManager.html#M000372">SpawnManager#spawn_application</a> for
information about the options.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000145_source')" id="l_M000145_source">show</a>
                        
                    </p>
                    <div id="M000145_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/classic_rails/application_spawner.rb, line 116</span>
116:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">options</span>)
117:     <span class="ruby-keyword kw">super</span>()
118:     <span class="ruby-ivar">@options</span>          = <span class="ruby-identifier">sanitize_spawn_options</span>(<span class="ruby-identifier">options</span>)
119:     <span class="ruby-ivar">@app_root</span>         = <span class="ruby-ivar">@options</span>[<span class="ruby-value str">&quot;app_root&quot;</span>]
120:     <span class="ruby-ivar">@canonicalized_app_root</span> = <span class="ruby-identifier">canonicalize_path</span>(<span class="ruby-ivar">@app_root</span>)
121:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">max_idle_time</span> = <span class="ruby-constant">DEFAULT_APP_SPAWNER_MAX_IDLE_TIME</span>
122:     <span class="ruby-identifier">define_message_handler</span>(<span class="ruby-identifier">:spawn_application</span>, <span class="ruby-identifier">:handle_spawn_application</span>)
123:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000141">
                    
                    <a name="M000141"></a><b>spawn_application</b>(options)
                    
                </div>
                
                <div class="description">
                  <p>
Spawns an instance of a Rails application. When successful, an <a
href="../AppProcess.html">AppProcess</a> object will be returned, which
represents the spawned Rails application.
</p>
<p>
This method spawns the application directly, without preloading its code.
This method may only be called if no Rails framework has been loaded in the
current Ruby VM.
</p>
<p>
The &#8220;<a href="ApplicationSpawner.html#app_root">app_root</a>&#8220;
option must be given. All other options are passed to the request
handler&#8217;s constructor.
</p>
<p>
Raises:
</p>
<ul>
<li>AppInitError: The Ruby on Rails application raised an exception or called
exit() during startup.

</li>
<li>SystemCallError, IOError, SocketError: Something went wrong.

</li>
</ul>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000141_source')" id="l_M000141_source">show</a>
                        
                    </p>
                    <div id="M000141_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/classic_rails/application_spawner.rb, line 80</span>
 80:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">spawn_application</span>(<span class="ruby-identifier">options</span>)
 81:     <span class="ruby-identifier">options</span> = <span class="ruby-identifier">sanitize_spawn_options</span>(<span class="ruby-identifier">options</span>)
 82:     
 83:     <span class="ruby-identifier">a</span>, <span class="ruby-identifier">b</span> = <span class="ruby-constant">UNIXSocket</span>.<span class="ruby-identifier">pair</span>
 84:     <span class="ruby-identifier">pid</span> = <span class="ruby-identifier">safe_fork</span>(<span class="ruby-value str">'application'</span>, <span class="ruby-keyword kw">true</span>) <span class="ruby-keyword kw">do</span>
 85:       <span class="ruby-identifier">a</span>.<span class="ruby-identifier">close</span>
 86:       
 87:       <span class="ruby-identifier">file_descriptors_to_leave_open</span> = [<span class="ruby-value">0</span>, <span class="ruby-value">1</span>, <span class="ruby-value">2</span>, <span class="ruby-identifier">b</span>.<span class="ruby-identifier">fileno</span>]
 88:       <span class="ruby-constant">NativeSupport</span>.<span class="ruby-identifier">close_all_file_descriptors</span>(<span class="ruby-identifier">file_descriptors_to_leave_open</span>)
 89:       <span class="ruby-identifier">close_all_io_objects_for_fds</span>(<span class="ruby-identifier">file_descriptors_to_leave_open</span>)
 90:       
 91:       <span class="ruby-identifier">channel</span> = <span class="ruby-constant">MessageChannel</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">b</span>)
 92:       <span class="ruby-identifier">success</span> = <span class="ruby-identifier">report_app_init_status</span>(<span class="ruby-identifier">channel</span>) <span class="ruby-keyword kw">do</span>
 93:         <span class="ruby-identifier">prepare_app_process</span>(<span class="ruby-value str">'config/environment.rb'</span>, <span class="ruby-identifier">options</span>)
 94:         <span class="ruby-identifier">require</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-value str">'config/environment'</span>)
 95:         <span class="ruby-identifier">require</span> <span class="ruby-value str">'dispatcher'</span>
 96:         <span class="ruby-identifier">after_loading_app_code</span>(<span class="ruby-identifier">options</span>)
 97:       <span class="ruby-keyword kw">end</span>
 98:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">success</span>
 99:         <span class="ruby-identifier">start_request_handler</span>(<span class="ruby-identifier">channel</span>, <span class="ruby-keyword kw">false</span>, <span class="ruby-identifier">options</span>)
100:       <span class="ruby-keyword kw">end</span>
101:     <span class="ruby-keyword kw">end</span>
102:     <span class="ruby-identifier">b</span>.<span class="ruby-identifier">close</span>
103:     <span class="ruby-constant">Process</span>.<span class="ruby-identifier">waitpid</span>(<span class="ruby-identifier">pid</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
104:     
105:     <span class="ruby-identifier">channel</span> = <span class="ruby-constant">MessageChannel</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">a</span>)
106:     <span class="ruby-identifier">unmarshal_and_raise_errors</span>(<span class="ruby-identifier">channel</span>, <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;print_exceptions&quot;</span>])
107:     
108:     <span class="ruby-comment cmt"># No exception was raised, so spawning succeeded.</span>
109:     <span class="ruby-keyword kw">return</span> <span class="ruby-constant">AppProcess</span>.<span class="ruby-identifier">read_from_channel</span>(<span class="ruby-identifier">channel</span>)
110:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Class Private methods</div>
            
            <div class="method">
                <div class="title" id="M000161">
                    
                    <a name="M000161"></a><b>find_rack_app</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000161_source')" id="l_M000161_source">show</a>
                        
                    </p>
                    <div id="M000161_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/classic_rails/application_spawner.rb, line 331</span>
331:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">find_rack_app</span>
332:     <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Rails</span><span class="ruby-operator">::</span><span class="ruby-constant">VERSION</span><span class="ruby-operator">::</span><span class="ruby-constant">MAJOR</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">3</span>
333:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">read</span>(<span class="ruby-value str">&quot;config/application.rb&quot;</span>) <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/^module (.+)$/</span>
334:       <span class="ruby-identifier">app_module</span> = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">$1</span>)
335:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">app_module</span><span class="ruby-operator">::</span><span class="ruby-constant">Application</span>
336:     <span class="ruby-keyword kw">else</span>
337:       <span class="ruby-keyword kw">return</span> <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Dispatcher</span>.<span class="ruby-identifier">new</span>
338:     <span class="ruby-keyword kw">end</span>
339:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000159">
                    
                    <a name="M000159"></a><b>start_request_handler</b>(channel, forked, options)
                    
                </div>
                
                <div class="description">
                  <p>
Initialize the request handler and enter its main loop. Spawn information
will be sent back via <tt>channel</tt>. The <tt>forked</tt> argument
indicates whether a new process was forked off after loading environment.rb
(i.e. whether smart spawning is being used).
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000159_source')" id="l_M000159_source">show</a>
                        
                    </p>
                    <div id="M000159_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/classic_rails/application_spawner.rb, line 300</span>
300:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">start_request_handler</span>(<span class="ruby-identifier">channel</span>, <span class="ruby-identifier">forked</span>, <span class="ruby-identifier">options</span>)
301:     <span class="ruby-identifier">app_root</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;app_root&quot;</span>]
302:     <span class="ruby-identifier">$0</span> = <span class="ruby-node">&quot;Rails: #{options['app_group_name']}&quot;</span>
303:     <span class="ruby-identifier">reader</span>, <span class="ruby-identifier">writer</span> = <span class="ruby-constant">IO</span>.<span class="ruby-identifier">pipe</span>
304:     <span class="ruby-keyword kw">begin</span>
305:       <span class="ruby-identifier">reader</span>.<span class="ruby-identifier">close_on_exec!</span>
306:       
307:       <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Rails</span><span class="ruby-operator">::</span><span class="ruby-constant">VERSION</span><span class="ruby-operator">::</span><span class="ruby-constant">STRING</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value str">'2.3.0'</span>
308:         <span class="ruby-identifier">rack_app</span> = <span class="ruby-identifier">find_rack_app</span>
309:         <span class="ruby-identifier">handler</span> = <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">RequestHandler</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">reader</span>, <span class="ruby-identifier">rack_app</span>, <span class="ruby-identifier">options</span>)
310:       <span class="ruby-keyword kw">else</span>
311:         <span class="ruby-identifier">handler</span> = <span class="ruby-constant">RequestHandler</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">reader</span>, <span class="ruby-identifier">options</span>)
312:       <span class="ruby-keyword kw">end</span>
313:       
314:       <span class="ruby-identifier">app_process</span> = <span class="ruby-constant">AppProcess</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">app_root</span>, <span class="ruby-constant">Process</span>.<span class="ruby-identifier">pid</span>, <span class="ruby-identifier">writer</span>,
315:         <span class="ruby-identifier">handler</span>.<span class="ruby-identifier">server_sockets</span>)
316:       <span class="ruby-identifier">app_process</span>.<span class="ruby-identifier">write_to_channel</span>(<span class="ruby-identifier">channel</span>)
317:       <span class="ruby-identifier">writer</span>.<span class="ruby-identifier">close</span>
318:       <span class="ruby-identifier">channel</span>.<span class="ruby-identifier">close</span>
319:       
320:       <span class="ruby-identifier">before_handling_requests</span>(<span class="ruby-identifier">forked</span>, <span class="ruby-identifier">options</span>)
321:       <span class="ruby-identifier">handler</span>.<span class="ruby-identifier">main_loop</span>
322:     <span class="ruby-keyword kw">ensure</span>
323:       <span class="ruby-identifier">channel</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
324:       <span class="ruby-identifier">writer</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
325:       <span class="ruby-identifier">handler</span>.<span class="ruby-identifier">cleanup</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
326:       <span class="ruby-identifier">after_handling_requests</span>
327:     <span class="ruby-keyword kw">end</span>
328:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000146">
                    
                    <a name="M000146"></a><b>spawn_application</b>(options = {})
                    
                </div>
                
                <div class="description">
                  <p>
Spawns an instance of the Rails application. When successful, an <a
href="../AppProcess.html">AppProcess</a> object will be returned, which
represents the spawned Rails application.
</p>
<p>
<tt>options</tt> will be passed to the request handler&#8217;s constructor.
</p>
<p>
Raises:
</p>
<ul>
<li>AbstractServer::ServerNotStarted: The <a
href="ApplicationSpawner.html">ApplicationSpawner</a> server hasn&#8217;t
already been started.

</li>
<li>ApplicationSpawner::Error: The <a
href="ApplicationSpawner.html">ApplicationSpawner</a> server exited
unexpectedly.

</li>
</ul>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000146_source')" id="l_M000146_source">show</a>
                        
                    </p>
                    <div id="M000146_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/classic_rails/application_spawner.rb, line 133</span>
133:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">spawn_application</span>(<span class="ruby-identifier">options</span> = {})
134:     <span class="ruby-identifier">connect</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">channel</span><span class="ruby-operator">|</span>
135:       <span class="ruby-identifier">channel</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value str">&quot;spawn_application&quot;</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">options</span>.<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">flatten</span>)
136:       <span class="ruby-keyword kw">return</span> <span class="ruby-constant">AppProcess</span>.<span class="ruby-identifier">read_from_channel</span>(<span class="ruby-identifier">channel</span>)
137:     <span class="ruby-keyword kw">end</span>
138:   <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SystemCallError</span>, <span class="ruby-constant">IOError</span>, <span class="ruby-constant">SocketError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
139:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">Error</span>, <span class="ruby-node">&quot;The application spawner server exited unexpectedly: #{e}&quot;</span>
140:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000147">
                    
                    <a name="M000147"></a><b>start</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Overrided from <a
href="../AbstractServer.html#M000021">AbstractServer#start</a>.
</p>
<p>
May raise these additional exceptions:
</p>
<ul>
<li>AppInitError: The Ruby on Rails application raised an exception or called
exit() during startup.

</li>
<li>ApplicationSpawner::Error: The <a
href="ApplicationSpawner.html">ApplicationSpawner</a> server exited
unexpectedly.

</li>
</ul>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000147_source')" id="l_M000147_source">show</a>
                        
                    </p>
                    <div id="M000147_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/classic_rails/application_spawner.rb, line 148</span>
148:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start</span>
149:     <span class="ruby-keyword kw">super</span>
150:     <span class="ruby-keyword kw">begin</span>
151:       <span class="ruby-identifier">channel</span> = <span class="ruby-constant">MessageChannel</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@owner_socket</span>)
152:       <span class="ruby-identifier">unmarshal_and_raise_errors</span>(<span class="ruby-identifier">channel</span>, <span class="ruby-ivar">@options</span>[<span class="ruby-value str">&quot;print_exceptions&quot;</span>])
153:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">IOError</span>, <span class="ruby-constant">SystemCallError</span>, <span class="ruby-constant">SocketError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
154:       <span class="ruby-identifier">stop</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">started?</span>
155:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">Error</span>, <span class="ruby-node">&quot;The application spawner server exited unexpectedly: #{e}&quot;</span>
156:     <span class="ruby-keyword kw">rescue</span>
157:       <span class="ruby-identifier">stop</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">started?</span>
158:       <span class="ruby-identifier">raise</span>
159:     <span class="ruby-keyword kw">end</span>
160:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Private methods</div>
            
            <div class="method">
                <div class="title" id="M000158">
                    
                    <a name="M000158"></a><b>handle_spawn_application</b>(client, *options)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000158_source')" id="l_M000158_source">show</a>
                        
                    </p>
                    <div id="M000158_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/classic_rails/application_spawner.rb, line 267</span>
267:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">handle_spawn_application</span>(<span class="ruby-identifier">client</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">options</span>)
268:     <span class="ruby-identifier">options</span> = <span class="ruby-identifier">sanitize_spawn_options</span>(<span class="ruby-constant">Hash</span>[<span class="ruby-operator">*</span><span class="ruby-identifier">options</span>])
269:     <span class="ruby-identifier">a</span>, <span class="ruby-identifier">b</span> = <span class="ruby-constant">UNIXSocket</span>.<span class="ruby-identifier">pair</span>
270:     <span class="ruby-identifier">safe_fork</span>(<span class="ruby-value str">'application'</span>, <span class="ruby-keyword kw">true</span>) <span class="ruby-keyword kw">do</span>
271:       <span class="ruby-keyword kw">begin</span>
272:         <span class="ruby-identifier">a</span>.<span class="ruby-identifier">close</span>
273:         <span class="ruby-identifier">client</span>.<span class="ruby-identifier">close</span>
274:         <span class="ruby-identifier">options</span> = <span class="ruby-ivar">@options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">options</span>)
275:         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">:start_request_handler</span>, <span class="ruby-constant">MessageChannel</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">b</span>),
276:           <span class="ruby-keyword kw">true</span>, <span class="ruby-identifier">options</span>)
277:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SignalException</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
278:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">AbstractRequestHandler</span><span class="ruby-operator">::</span><span class="ruby-constant">HARD_TERMINATION_SIGNAL</span> <span class="ruby-operator">&amp;&amp;</span>
279:            <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">AbstractRequestHandler</span><span class="ruby-operator">::</span><span class="ruby-constant">SOFT_TERMINATION_SIGNAL</span>
280:           <span class="ruby-identifier">raise</span>
281:         <span class="ruby-keyword kw">end</span>
282:       <span class="ruby-keyword kw">end</span>
283:     <span class="ruby-keyword kw">end</span>
284:     
285:     <span class="ruby-identifier">b</span>.<span class="ruby-identifier">close</span>
286:     <span class="ruby-identifier">worker_channel</span> = <span class="ruby-constant">MessageChannel</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">a</span>)
287:     <span class="ruby-identifier">app_process</span> = <span class="ruby-constant">AppProcess</span>.<span class="ruby-identifier">read_from_channel</span>(<span class="ruby-identifier">worker_channel</span>)
288:     <span class="ruby-identifier">app_process</span>.<span class="ruby-identifier">write_to_channel</span>(<span class="ruby-identifier">client</span>)
289:   <span class="ruby-keyword kw">ensure</span>
290:     <span class="ruby-identifier">a</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">a</span>
291:     <span class="ruby-identifier">b</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">b</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">b</span>.<span class="ruby-identifier">closed?</span>
292:     <span class="ruby-identifier">app_process</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">app_process</span>
293:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000156">
                    
                    <a name="M000156"></a><b>load_environment_with_passenger</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000156_source')" id="l_M000156_source">show</a>
                        
                    </p>
                    <div id="M000156_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/classic_rails/application_spawner.rb, line 196</span>
196:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">load_environment_with_passenger</span>
197:           <span class="ruby-identifier">using_default_log_path</span> =
198:             <span class="ruby-identifier">configuration</span>.<span class="ruby-identifier">log_path</span> <span class="ruby-operator">==</span>
199:             <span class="ruby-identifier">configuration</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">:default_log_path</span>)
200:           
201:           <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">defined?</span>(<span class="ruby-operator">::</span><span class="ruby-constant">RAILS_ENV</span>)
202:             <span class="ruby-constant">Object</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">:remove_const</span>, <span class="ruby-identifier">:RAILS_ENV</span>)
203:           <span class="ruby-keyword kw">end</span>
204:           <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_set</span>(<span class="ruby-identifier">:RAILS_ENV</span>, (<span class="ruby-constant">ENV</span>[<span class="ruby-value str">'RAILS_ENV'</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">'development'</span>).<span class="ruby-identifier">dup</span>)
205:           
206:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">using_default_log_path</span>
207:             <span class="ruby-comment cmt"># We've changed the environment, so open the</span>
208:             <span class="ruby-comment cmt"># correct log file.</span>
209:             <span class="ruby-identifier">configuration</span>.<span class="ruby-identifier">log_path</span> = <span class="ruby-identifier">configuration</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">:default_log_path</span>)
210:           <span class="ruby-keyword kw">end</span>
211:           
212:           <span class="ruby-identifier">load_environment_without_passenger</span>
213:         <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000155">
                    
                    <a name="M000155"></a><b>preload_application</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000155_source')" id="l_M000155_source">show</a>
                        
                    </p>
                    <div id="M000155_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/classic_rails/application_spawner.rb, line 187</span>
187:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">preload_application</span>
188:     <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_set</span>(<span class="ruby-identifier">:RAILS_ROOT</span>, <span class="ruby-ivar">@canonicalized_app_root</span>)
189:     <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">defined?</span>(<span class="ruby-operator">::</span><span class="ruby-constant">Rails</span><span class="ruby-operator">::</span><span class="ruby-constant">Initializer</span>)
190:       <span class="ruby-operator">::</span><span class="ruby-constant">Rails</span><span class="ruby-operator">::</span><span class="ruby-constant">Initializer</span>.<span class="ruby-identifier">run</span>(<span class="ruby-identifier">:set_load_path</span>)
191:       
192:       <span class="ruby-comment cmt"># The Rails framework is loaded at the moment.</span>
193:       <span class="ruby-comment cmt"># environment.rb may set ENV['RAILS_ENV']. So we re-initialize</span>
194:       <span class="ruby-comment cmt"># RAILS_ENV in Rails::Initializer.load_environment.</span>
195:       <span class="ruby-operator">::</span><span class="ruby-constant">Rails</span><span class="ruby-operator">::</span><span class="ruby-constant">Initializer</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-keyword kw">do</span>
196:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">load_environment_with_passenger</span>
197:           <span class="ruby-identifier">using_default_log_path</span> =
198:             <span class="ruby-identifier">configuration</span>.<span class="ruby-identifier">log_path</span> <span class="ruby-operator">==</span>
199:             <span class="ruby-identifier">configuration</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">:default_log_path</span>)
200:           
201:           <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">defined?</span>(<span class="ruby-operator">::</span><span class="ruby-constant">RAILS_ENV</span>)
202:             <span class="ruby-constant">Object</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">:remove_const</span>, <span class="ruby-identifier">:RAILS_ENV</span>)
203:           <span class="ruby-keyword kw">end</span>
204:           <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_set</span>(<span class="ruby-identifier">:RAILS_ENV</span>, (<span class="ruby-constant">ENV</span>[<span class="ruby-value str">'RAILS_ENV'</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">'development'</span>).<span class="ruby-identifier">dup</span>)
205:           
206:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">using_default_log_path</span>
207:             <span class="ruby-comment cmt"># We've changed the environment, so open the</span>
208:             <span class="ruby-comment cmt"># correct log file.</span>
209:             <span class="ruby-identifier">configuration</span>.<span class="ruby-identifier">log_path</span> = <span class="ruby-identifier">configuration</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">:default_log_path</span>)
210:           <span class="ruby-keyword kw">end</span>
211:           
212:           <span class="ruby-identifier">load_environment_without_passenger</span>
213:         <span class="ruby-keyword kw">end</span>
214:         
215:         <span class="ruby-identifier">alias_method</span> <span class="ruby-identifier">:load_environment_without_passenger</span>, <span class="ruby-identifier">:load_environment</span>
216:         <span class="ruby-identifier">alias_method</span> <span class="ruby-identifier">:load_environment</span>, <span class="ruby-identifier">:load_environment_with_passenger</span>
217:       <span class="ruby-keyword kw">end</span>
218:     <span class="ruby-keyword kw">end</span>
219:     <span class="ruby-keyword kw">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-value str">'config/preinitializer.rb'</span>)
220:       <span class="ruby-identifier">require</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-value str">'config/preinitializer'</span>)
221:     <span class="ruby-keyword kw">end</span>
222:     <span class="ruby-identifier">require</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-value str">'config/environment'</span>)
223:     <span class="ruby-keyword kw">if</span> <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">page_cache_directory</span>.<span class="ruby-identifier">blank?</span>
224:       <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">page_cache_directory</span> = <span class="ruby-node">&quot;#{RAILS_ROOT}/public&quot;</span>
225:     <span class="ruby-keyword kw">end</span>
226:     <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">defined?</span>(<span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Dispatcher</span>) \
227:        <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Dispatcher</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:error_file_path</span>)
228:       <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Dispatcher</span>.<span class="ruby-identifier">error_file_path</span> = <span class="ruby-node">&quot;#{RAILS_ROOT}/public&quot;</span>
229:     <span class="ruby-keyword kw">end</span>
230:     
231:     <span class="ruby-identifier">require</span> <span class="ruby-value str">'rails/version'</span> <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword kw">defined?</span>(<span class="ruby-operator">::</span><span class="ruby-constant">Rails</span><span class="ruby-operator">::</span><span class="ruby-constant">VERSION</span>)
232:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword kw">defined?</span>(<span class="ruby-constant">Dispatcher</span>)
233:       <span class="ruby-keyword kw">begin</span>
234:         <span class="ruby-identifier">require</span> <span class="ruby-value str">'dispatcher'</span>
235:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">LoadError</span>
236:         <span class="ruby-comment cmt"># Early versions of Rails 3 still had the dispatcher, but</span>
237:         <span class="ruby-comment cmt"># later versions disposed of it, in which case we'll need</span>
238:         <span class="ruby-comment cmt"># to use the application object.</span>
239:         <span class="ruby-identifier">raise</span> <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Rails</span><span class="ruby-operator">::</span><span class="ruby-constant">VERSION</span><span class="ruby-operator">::</span><span class="ruby-constant">MAJOR</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">3</span>
240:       <span class="ruby-keyword kw">end</span>
241:     <span class="ruby-keyword kw">end</span>
242:     
243:     <span class="ruby-comment cmt"># - No point in preloading the application sources if the garbage collector</span>
244:     <span class="ruby-comment cmt">#   isn't copy-on-write friendly.</span>
245:     <span class="ruby-comment cmt"># - Rails &gt;= 2.2 already preloads application sources by default, so no need</span>
246:     <span class="ruby-comment cmt">#   to do that again.</span>
247:     <span class="ruby-keyword kw">if</span> <span class="ruby-constant">GC</span>.<span class="ruby-identifier">copy_on_write_friendly?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">rails_will_preload_app_code?</span>
248:       <span class="ruby-comment cmt"># Rails 2.2+ uses application_controller.rb while olde</span>
249:       <span class="ruby-comment cmt"># versions use application.rb.</span>
250:       <span class="ruby-identifier">require_dependency</span> <span class="ruby-value str">'application'</span>
251:       [<span class="ruby-value str">'models'</span>,<span class="ruby-value str">'controllers'</span>,<span class="ruby-value str">'helpers'</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">section</span><span class="ruby-operator">|</span>
252:         <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">glob</span>(<span class="ruby-node">&quot;app/#{section}}/*.rb&quot;</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span>
253:           <span class="ruby-identifier">require_dependency</span> <span class="ruby-identifier">canonicalize_path</span>(<span class="ruby-identifier">file</span>)
254:         <span class="ruby-keyword kw">end</span>
255:       <span class="ruby-keyword kw">end</span>
256:     <span class="ruby-keyword kw">end</span>
257:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000157">
                    
                    <a name="M000157"></a><b>rails_will_preload_app_code?</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000157_source')" id="l_M000157_source">show</a>
                        
                    </p>
                    <div id="M000157_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/classic_rails/application_spawner.rb, line 259</span>
259:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">rails_will_preload_app_code?</span>
260:     <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">defined?</span>(<span class="ruby-constant">Rails</span><span class="ruby-operator">::</span><span class="ruby-constant">Initializer</span>)
261:       <span class="ruby-keyword kw">return</span> <span class="ruby-operator">::</span><span class="ruby-constant">Rails</span><span class="ruby-operator">::</span><span class="ruby-constant">Initializer</span>.<span class="ruby-identifier">method_defined?</span>(<span class="ruby-identifier">:load_application_classes</span>)
262:     <span class="ruby-keyword kw">else</span>
263:       <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Rails</span><span class="ruby-operator">::</span><span class="ruby-constant">VERSION</span><span class="ruby-operator">::</span><span class="ruby-constant">MAJOR</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">3</span>
264:     <span class="ruby-keyword kw">end</span>
265:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    