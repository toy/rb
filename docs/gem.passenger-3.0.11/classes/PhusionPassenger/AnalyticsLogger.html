<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>PhusionPassenger::AnalyticsLogger</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
    <script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            PhusionPassenger::AnalyticsLogger 
            
                <span class="parent">&lt; 
                    
                    <a href="../Object.html">Object</a>
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/phusion_passenger/analytics_logger_rb.html">lib/phusion_passenger/analytics_logger.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M000120">clear_connection</a>,</li>
                
                <li><a href="#M000122">close</a>,</li>
                
                <li><a href="#M000139">connect</a>,</li>
                
                <li><a href="#M000127">continue_transaction</a>,</li>
                
                <li><a href="#M000143">current_time</a>,</li>
                
                <li><a href="#M000142">current_time</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M000118">new</a>,</li>
                
                <li><a href="#M000117">new_from_options</a>,</li>
                
                <li><a href="#M000123">new_transaction</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000140">random_token</a></li>
                
            </ul>
        </dd>
    
        <dt>T</dt>
        <dd>
            <ul>
                
                <li><a href="#M000144">timestamp_string</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    
    <div class="sectiontitle">Included Modules</div>
    <ul>
        
        <li>
            
            <a href="Rack.html">PhusionPassenger::Rack</a>
            
            START:includes
        </li>
        
    </ul>
    

    

    
    <div class="sectiontitle">Classes and Modules</div>
    <ul>
        
        <li><span class="type">CLASS</span> <a href="AnalyticsLogger/Connection.html">PhusionPassenger::AnalyticsLogger::Connection</a></li>
        
        <li><span class="type">CLASS</span> <a href="AnalyticsLogger/Lock.html">PhusionPassenger::AnalyticsLogger::Lock</a></li>
        
        <li><span class="type">CLASS</span> <a href="AnalyticsLogger/Log.html">PhusionPassenger::AnalyticsLogger::Log</a></li>
        
    </ul>
    

    
    <div class="sectiontitle">Constants</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class="attr-name">RETRY_SLEEP</td>
            <td>=</td>
            <td class="attr-value">0.2</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">NETWORK_ERRORS</td>
            <td>=</td>
            <td class="attr-value">[Errno::EPIPE, Errno::ECONNREFUSED, Errno::ECONNRESET,     Errno::EHOSTUNREACH, Errno::ENETDOWN, Errno::ENETUNREACH, Errno::ETIMEDOUT]</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">RANDOM_CHARS</td>
            <td>=</td>
            <td class="attr-value">['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm',     'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z',     'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M',     'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z',     '0', '1', '2', '3', '4', '5', '6', '7', '8', '9']</td>
        </tr>
        
        
    </table>
    

    
    <div class="sectiontitle">Attributes</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>max_connect_tries</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>reconnect_timeout</td>
            <td class='attr-desc'></td>
        </tr>
        
    </table>
    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M000118">
                    
                    <a name="M000118"></a><b>new</b>(logging_agent_address, username, password, node_name)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000118_source')" id="l_M000118_source">show</a>
                        
                    </p>
                    <div id="M000118_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/analytics_logger.rb, line 179</span>
179:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">logging_agent_address</span>, <span class="ruby-identifier">username</span>, <span class="ruby-identifier">password</span>, <span class="ruby-identifier">node_name</span>)
180:     <span class="ruby-ivar">@server_address</span> = <span class="ruby-identifier">logging_agent_address</span>
181:     <span class="ruby-ivar">@username</span> = <span class="ruby-identifier">username</span>
182:     <span class="ruby-ivar">@password</span> = <span class="ruby-identifier">password</span>
183:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">node_name</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">node_name</span>.<span class="ruby-identifier">empty?</span>
184:       <span class="ruby-ivar">@node_name</span> = <span class="ruby-identifier">node_name</span>
185:     <span class="ruby-keyword kw">else</span>
186:       <span class="ruby-ivar">@node_name</span> = <span class="ruby-value">`hostname`</span>.<span class="ruby-identifier">strip</span>
187:     <span class="ruby-keyword kw">end</span>
188:     <span class="ruby-ivar">@random_dev</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-value str">&quot;/dev/urandom&quot;</span>)
189:     
190:     <span class="ruby-comment cmt"># This mutex protects the following instance variables, but</span>
191:     <span class="ruby-comment cmt"># not the contents of @connection.</span>
192:     <span class="ruby-ivar">@mutex</span> = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>
193:     
194:     <span class="ruby-ivar">@connection</span> = <span class="ruby-constant">Connection</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">nil</span>)
195:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@server_address</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">local_socket_address?</span>(<span class="ruby-ivar">@server_address</span>)
196:       <span class="ruby-ivar">@max_connect_tries</span> = <span class="ruby-value">10</span>
197:     <span class="ruby-keyword kw">else</span>
198:       <span class="ruby-ivar">@max_connect_tries</span> = <span class="ruby-value">1</span>
199:     <span class="ruby-keyword kw">end</span>
200:     <span class="ruby-ivar">@reconnect_timeout</span> = <span class="ruby-value">1</span>
201:     <span class="ruby-ivar">@next_reconnect_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">utc</span>(<span class="ruby-value">1980</span>, <span class="ruby-value">1</span>, <span class="ruby-value">1</span>)
202:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000117">
                    
                    <a name="M000117"></a><b>new_from_options</b>(options)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000117_source')" id="l_M000117_source">show</a>
                        
                    </p>
                    <div id="M000117_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/analytics_logger.rb, line 165</span>
165:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">new_from_options</span>(<span class="ruby-identifier">options</span>)
166:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;analytics&quot;</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;logging_agent_address&quot;</span>]
167:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">new</span>(<span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;logging_agent_address&quot;</span>],
168:         <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;logging_agent_username&quot;</span>],
169:         <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;logging_agent_password_base64&quot;</span>].<span class="ruby-identifier">unpack</span>(<span class="ruby-value str">'m'</span>).<span class="ruby-identifier">first</span>,
170:         <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;node_name&quot;</span>])
171:     <span class="ruby-keyword kw">else</span>
172:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
173:     <span class="ruby-keyword kw">end</span>
174:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Class Private methods</div>
            
            <div class="method">
                <div class="title" id="M000143">
                    
                    <a name="M000143"></a><b>current_time</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000143_source')" id="l_M000143_source">show</a>
                        
                    </p>
                    <div id="M000143_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/analytics_logger.rb, line 466</span>
466:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">current_time</span>
467:     <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
468:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000144">
                    
                    <a name="M000144"></a><b>timestamp_string</b>(time = current_time)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000144_source')" id="l_M000144_source">show</a>
                        
                    </p>
                    <div id="M000144_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/analytics_logger.rb, line 470</span>
470:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">timestamp_string</span>(<span class="ruby-identifier">time</span> = <span class="ruby-identifier">current_time</span>)
471:     <span class="ruby-identifier">timestamp</span> = <span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">*</span> <span class="ruby-value">1_000_000</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">time</span>.<span class="ruby-identifier">usec</span>
472:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">timestamp</span>.<span class="ruby-identifier">to_s</span>(<span class="ruby-value">36</span>)
473:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000120">
                    
                    <a name="M000120"></a><b>clear_connection</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000120_source')" id="l_M000120_source">show</a>
                        
                    </p>
                    <div id="M000120_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/analytics_logger.rb, line 204</span>
204:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">clear_connection</span>
205:     <span class="ruby-ivar">@mutex</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
206:       <span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
207:         <span class="ruby-ivar">@random_dev</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-value str">&quot;/dev/urandom&quot;</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@random_dev</span>.<span class="ruby-identifier">closed?</span>
208:         <span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">unref</span>
209:         <span class="ruby-ivar">@connection</span> = <span class="ruby-constant">Connection</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">nil</span>)
210:       <span class="ruby-keyword kw">end</span>
211:     <span class="ruby-keyword kw">end</span>
212:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000122">
                    
                    <a name="M000122"></a><b>close</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000122_source')" id="l_M000122_source">show</a>
                        
                    </p>
                    <div id="M000122_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/analytics_logger.rb, line 214</span>
214:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">close</span>
215:     <span class="ruby-ivar">@mutex</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
216:       <span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
217:         <span class="ruby-ivar">@random_dev</span>.<span class="ruby-identifier">close</span>
218:         <span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">unref</span>
219:         <span class="ruby-ivar">@connection</span> = <span class="ruby-keyword kw">nil</span>
220:       <span class="ruby-keyword kw">end</span>
221:     <span class="ruby-keyword kw">end</span>
222:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000127">
                    
                    <a name="M000127"></a><b>continue_transaction</b>(txn_id, group_name, category = :requests, union_station_key = nil)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000127_source')" id="l_M000127_source">show</a>
                        
                    </p>
                    <div id="M000127_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/analytics_logger.rb, line 283</span>
283:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">continue_transaction</span>(<span class="ruby-identifier">txn_id</span>, <span class="ruby-identifier">group_name</span>, <span class="ruby-identifier">category</span> = <span class="ruby-identifier">:requests</span>, <span class="ruby-identifier">union_station_key</span> = <span class="ruby-keyword kw">nil</span>)
284:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@server_address</span>
285:       <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Log</span>.<span class="ruby-identifier">new</span>
286:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">txn_id</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">txn_id</span>.<span class="ruby-identifier">empty?</span>
287:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">&quot;Transaction ID may not be empty&quot;</span>
288:     <span class="ruby-keyword kw">end</span>
289:     
290:     <span class="ruby-constant">Lock</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@mutex</span>).<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">lock</span><span class="ruby-operator">|</span>
291:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_time</span> <span class="ruby-operator">&lt;</span> <span class="ruby-ivar">@next_reconnect_time</span>
292:         <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Log</span>.<span class="ruby-identifier">new</span>
293:       <span class="ruby-keyword kw">end</span>
294:       
295:       <span class="ruby-constant">Lock</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">mutex</span>).<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">connection_lock</span><span class="ruby-operator">|</span>
296:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">connected?</span>
297:           <span class="ruby-keyword kw">begin</span>
298:             <span class="ruby-identifier">connect</span>
299:             <span class="ruby-identifier">connection_lock</span>.<span class="ruby-identifier">reset</span>(<span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">mutex</span>)
300:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SystemCallError</span>, <span class="ruby-constant">IOError</span>
301:             <span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">disconnect</span>
302:             <span class="ruby-constant">DebugLogging</span>.<span class="ruby-identifier">warn</span>(<span class="ruby-node">&quot;Cannot connect to the logging agent at #{@server_address}; &quot;</span> <span class="ruby-operator">+</span>
303:               <span class="ruby-node">&quot;retrying in #{@reconnect_timeout} second(s).&quot;</span>)
304:             <span class="ruby-ivar">@next_reconnect_time</span> = <span class="ruby-identifier">current_time</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@reconnect_timeout</span>
305:             <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Log</span>.<span class="ruby-identifier">new</span>
306:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
307:             <span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">disconnect</span>
308:             <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span>
309:           <span class="ruby-keyword kw">end</span>
310:         <span class="ruby-keyword kw">end</span>
311:         
312:         <span class="ruby-keyword kw">begin</span>
313:           <span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">channel</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value str">&quot;openTransaction&quot;</span>,
314:             <span class="ruby-identifier">txn_id</span>, <span class="ruby-identifier">group_name</span>, <span class="ruby-value str">&quot;&quot;</span>, <span class="ruby-identifier">category</span>,
315:             <span class="ruby-constant">AnalyticsLogger</span>.<span class="ruby-identifier">timestamp_string</span>,
316:             <span class="ruby-identifier">union_station_key</span>,
317:             <span class="ruby-keyword kw">true</span>)
318:           <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Log</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@connection</span>, <span class="ruby-identifier">txn_id</span>)
319:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SystemCallError</span>, <span class="ruby-constant">IOError</span>
320:           <span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">disconnect</span>
321:           <span class="ruby-constant">DebugLogging</span>.<span class="ruby-identifier">warn</span>(<span class="ruby-node">&quot;The logging agent at #{@server_address}&quot;</span> <span class="ruby-operator">&lt;&lt;</span>
322:             <span class="ruby-value str">&quot; closed the connection; will reconnect in &quot;</span> <span class="ruby-operator">&lt;&lt;</span>
323:             <span class="ruby-node">&quot;#{@reconnect_timeout} second(s).&quot;</span>)
324:           <span class="ruby-ivar">@next_reconnect_time</span> = <span class="ruby-identifier">current_time</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@reconnect_timeout</span>
325:           <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Log</span>.<span class="ruby-identifier">new</span>
326:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
327:           <span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">disconnect</span>
328:           <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span>
329:         <span class="ruby-keyword kw">end</span>
330:       <span class="ruby-keyword kw">end</span>
331:     <span class="ruby-keyword kw">end</span>
332:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000123">
                    
                    <a name="M000123"></a><b>new_transaction</b>(group_name, category = :requests, union_station_key = nil)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000123_source')" id="l_M000123_source">show</a>
                        
                    </p>
                    <div id="M000123_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/analytics_logger.rb, line 224</span>
224:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">new_transaction</span>(<span class="ruby-identifier">group_name</span>, <span class="ruby-identifier">category</span> = <span class="ruby-identifier">:requests</span>, <span class="ruby-identifier">union_station_key</span> = <span class="ruby-keyword kw">nil</span>)
225:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@server_address</span>
226:       <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Log</span>.<span class="ruby-identifier">new</span>
227:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">group_name</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">group_name</span>.<span class="ruby-identifier">empty?</span>
228:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">&quot;Group name may not be empty&quot;</span>
229:     <span class="ruby-keyword kw">end</span>
230:     
231:     <span class="ruby-identifier">txn_id</span> = (<span class="ruby-constant">AnalyticsLogger</span>.<span class="ruby-identifier">current_time</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">/</span> <span class="ruby-value">60</span>).<span class="ruby-identifier">to_s</span>(<span class="ruby-value">36</span>)
232:     <span class="ruby-identifier">txn_id</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;-#{random_token(11)}&quot;</span>
233:     
234:     <span class="ruby-constant">Lock</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@mutex</span>).<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">lock</span><span class="ruby-operator">|</span>
235:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_time</span> <span class="ruby-operator">&lt;</span> <span class="ruby-ivar">@next_reconnect_time</span>
236:         <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Log</span>.<span class="ruby-identifier">new</span>
237:       <span class="ruby-keyword kw">end</span>
238:       
239:       <span class="ruby-constant">Lock</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">mutex</span>).<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">connection_lock</span><span class="ruby-operator">|</span>
240:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">connected?</span>
241:           <span class="ruby-keyword kw">begin</span>
242:             <span class="ruby-identifier">connect</span>
243:             <span class="ruby-identifier">connection_lock</span>.<span class="ruby-identifier">reset</span>(<span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">mutex</span>)
244:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SystemCallError</span>, <span class="ruby-constant">IOError</span>
245:             <span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">disconnect</span>
246:             <span class="ruby-constant">DebugLogging</span>.<span class="ruby-identifier">warn</span>(<span class="ruby-node">&quot;Cannot connect to the logging agent at #{@server_address}; &quot;</span> <span class="ruby-operator">+</span>
247:               <span class="ruby-node">&quot;retrying in #{@reconnect_timeout} second(s).&quot;</span>)
248:             <span class="ruby-ivar">@next_reconnect_time</span> = <span class="ruby-identifier">current_time</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@reconnect_timeout</span>
249:             <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Log</span>.<span class="ruby-identifier">new</span>
250:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
251:             <span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">disconnect</span>
252:             <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span>
253:           <span class="ruby-keyword kw">end</span>
254:         <span class="ruby-keyword kw">end</span>
255:         
256:         <span class="ruby-keyword kw">begin</span>
257:           <span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">channel</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value str">&quot;openTransaction&quot;</span>,
258:             <span class="ruby-identifier">txn_id</span>, <span class="ruby-identifier">group_name</span>, <span class="ruby-value str">&quot;&quot;</span>, <span class="ruby-identifier">category</span>,
259:             <span class="ruby-constant">AnalyticsLogger</span>.<span class="ruby-identifier">timestamp_string</span>,
260:             <span class="ruby-identifier">union_station_key</span>,
261:             <span class="ruby-keyword kw">true</span>,
262:             <span class="ruby-keyword kw">true</span>)
263:           <span class="ruby-identifier">result</span> = <span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">channel</span>.<span class="ruby-identifier">read</span>
264:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span> <span class="ruby-operator">!=</span> [<span class="ruby-value str">&quot;ok&quot;</span>]
265:             <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Expected logging server to respond with 'ok', but got #{result.inspect} instead&quot;</span>
266:           <span class="ruby-keyword kw">end</span>
267:           <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Log</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@connection</span>, <span class="ruby-identifier">txn_id</span>)
268:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SystemCallError</span>, <span class="ruby-constant">IOError</span>
269:           <span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">disconnect</span>
270:           <span class="ruby-constant">DebugLogging</span>.<span class="ruby-identifier">warn</span>(<span class="ruby-node">&quot;The logging agent at #{@server_address}&quot;</span> <span class="ruby-operator">&lt;&lt;</span>
271:             <span class="ruby-value str">&quot; closed the connection; will reconnect in &quot;</span> <span class="ruby-operator">&lt;&lt;</span>
272:             <span class="ruby-node">&quot;#{@reconnect_timeout} second(s).&quot;</span>)
273:           <span class="ruby-ivar">@next_reconnect_time</span> = <span class="ruby-identifier">current_time</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@reconnect_timeout</span>
274:           <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Log</span>.<span class="ruby-identifier">new</span>
275:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
276:           <span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">disconnect</span>
277:           <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span>
278:         <span class="ruby-keyword kw">end</span>
279:       <span class="ruby-keyword kw">end</span>
280:     <span class="ruby-keyword kw">end</span>
281:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Private methods</div>
            
            <div class="method">
                <div class="title" id="M000139">
                    
                    <a name="M000139"></a><b>connect</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000139_source')" id="l_M000139_source">show</a>
                        
                    </p>
                    <div id="M000139_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/analytics_logger.rb, line 412</span>
412:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">connect</span>
413:     <span class="ruby-identifier">socket</span>  = <span class="ruby-identifier">connect_to_server</span>(<span class="ruby-ivar">@server_address</span>)
414:     <span class="ruby-identifier">channel</span> = <span class="ruby-constant">MessageChannel</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">socket</span>)
415:     
416:     <span class="ruby-identifier">result</span> = <span class="ruby-identifier">channel</span>.<span class="ruby-identifier">read</span>
417:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">nil?</span>
418:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">EOFError</span>
419:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">!=</span> <span class="ruby-value">2</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">result</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;version&quot;</span>
420:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">IOError</span>, <span class="ruby-value str">&quot;The logging agent didn't sent a valid version identifier&quot;</span>
421:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">result</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;1&quot;</span>
422:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">IOError</span>, <span class="ruby-node">&quot;Unsupported logging agent protocol version #{result[1]}&quot;</span>
423:     <span class="ruby-keyword kw">end</span>
424:     
425:     <span class="ruby-identifier">channel</span>.<span class="ruby-identifier">write_scalar</span>(<span class="ruby-ivar">@username</span>)
426:     <span class="ruby-identifier">channel</span>.<span class="ruby-identifier">write_scalar</span>(<span class="ruby-ivar">@password</span>)
427:     
428:     <span class="ruby-identifier">result</span> = <span class="ruby-identifier">channel</span>.<span class="ruby-identifier">read</span>
429:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">nil?</span>
430:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">EOFError</span>
431:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">result</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;ok&quot;</span>
432:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">SecurityError</span>, <span class="ruby-identifier">result</span>[<span class="ruby-value">0</span>]
433:     <span class="ruby-keyword kw">end</span>
434:     
435:     <span class="ruby-identifier">channel</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value str">&quot;init&quot;</span>, <span class="ruby-ivar">@node_name</span>)
436:     <span class="ruby-identifier">args</span> = <span class="ruby-identifier">channel</span>.<span class="ruby-identifier">read</span>
437:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">args</span>
438:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNREFUSED</span>, <span class="ruby-value str">&quot;Cannot connect to logging agent&quot;</span>
439:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">!=</span> <span class="ruby-value">1</span>
440:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">IOError</span>, <span class="ruby-value str">&quot;Logging agent returned an invalid reply for the 'init' command&quot;</span>
441:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;server shutting down&quot;</span>
442:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNREFUSED</span>, <span class="ruby-value str">&quot;Cannot connect to logging agent&quot;</span>
443:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;ok&quot;</span>
444:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">IOError</span>, <span class="ruby-value str">&quot;Logging agent returned an invalid reply for the 'init' command&quot;</span>
445:     <span class="ruby-keyword kw">end</span>
446:     
447:     <span class="ruby-ivar">@connection</span>.<span class="ruby-identifier">unref</span>
448:     <span class="ruby-ivar">@connection</span> = <span class="ruby-constant">Connection</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">socket</span>)
449:   <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
450:     <span class="ruby-identifier">socket</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">socket</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">socket</span>.<span class="ruby-identifier">closed?</span>
451:     <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span>
452:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000142">
                    
                    <a name="M000142"></a><b>current_time</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000142_source')" id="l_M000142_source">show</a>
                        
                    </p>
                    <div id="M000142_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/analytics_logger.rb, line 462</span>
462:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">current_time</span>
463:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">current_time</span>
464:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000140">
                    
                    <a name="M000140"></a><b>random_token</b>(length)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000140_source')" id="l_M000140_source">show</a>
                        
                    </p>
                    <div id="M000140_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/analytics_logger.rb, line 454</span>
454:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">random_token</span>(<span class="ruby-identifier">length</span>)
455:     <span class="ruby-identifier">token</span> = <span class="ruby-value str">&quot;&quot;</span>
456:     <span class="ruby-ivar">@random_dev</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">length</span>).<span class="ruby-identifier">each_byte</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
457:       <span class="ruby-identifier">token</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">RANDOM_CHARS</span>[<span class="ruby-identifier">c</span> <span class="ruby-operator">%</span> <span class="ruby-constant">RANDOM_CHARS</span>.<span class="ruby-identifier">size</span>]
458:     <span class="ruby-keyword kw">end</span>
459:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">token</span>
460:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    