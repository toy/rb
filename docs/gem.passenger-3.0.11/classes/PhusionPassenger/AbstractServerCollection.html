<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>PhusionPassenger::AbstractServerCollection</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
    <script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            PhusionPassenger::AbstractServerCollection 
            
                <span class="parent">&lt; 
                    
                    <a href="../Object.html">Object</a>
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/phusion_passenger/abstract_server_collection_rb.html">lib/phusion_passenger/abstract_server_collection.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
This class maintains a collection of <a
href="AbstractServer.html">AbstractServer</a> objects. One can add new <a
href="AbstractServer.html">AbstractServer</a> objects, or look up existing
ones via a key. <a
href="AbstractServerCollection.html">AbstractServerCollection</a> also
automatically takes care of cleaning up AbstractServers that have been idle
for too long.
</p>
<p>
This class exists because both <a href="SpawnManager.html">SpawnManager</a>
and <a
href="ClassicRails/FrameworkSpawner.html">ClassicRails::FrameworkSpawner</a>
need this kind of functionality. <a
href="SpawnManager.html">SpawnManager</a> maintains a collection of <a
href="ClassicRails/FrameworkSpawner.html">ClassicRails::FrameworkSpawner</a>
and <a
href="ClassicRails/ApplicationSpawner.html">ClassicRails::ApplicationSpawner</a>
objects, while <a
href="ClassicRails/FrameworkSpawner.html">ClassicRails::FrameworkSpawner</a>
maintains a collection of <a
href="ClassicRails/ApplicationSpawner.html">ClassicRails::ApplicationSpawner</a>
objects.
</p>
<p>
This class is thread-safe as long as the specified thread-safety rules are
followed.
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M000059">check_idle_servers!</a>,</li>
                
                <li><a href="#M000064">cleaner_thread_main</a>,</li>
                
                <li><a href="#M000063">cleanup</a>,</li>
                
                <li><a href="#M000062">clear</a></li>
                
            </ul>
        </dd>
    
        <dt>D</dt>
        <dd>
            <ul>
                
                <li><a href="#M000057">delete</a></li>
                
            </ul>
        </dd>
    
        <dt>E</dt>
        <dd>
            <ul>
                
                <li><a href="#M000060">each</a>,</li>
                
                <li><a href="#M000061">each_pair</a>,</li>
                
                <li><a href="#M000065">eligable_for_cleanup?</a>,</li>
                
                <li><a href="#M000056">empty?</a></li>
                
            </ul>
        </dd>
    
        <dt>H</dt>
        <dd>
            <ul>
                
                <li><a href="#M000055">has_key?</a></li>
                
            </ul>
        </dd>
    
        <dt>L</dt>
        <dd>
            <ul>
                
                <li><a href="#M000053">lookup_or_add</a></li>
                
            </ul>
        </dd>
    
        <dt>M</dt>
        <dd>
            <ul>
                
                <li><a href="#M000066">must_be_in_synchronize_block</a>,</li>
                
                <li><a href="#M000067">must_not_be_in_synchronize_block</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M000049">new</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000058">register_activity</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M000051">synchronize</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    
    <div class="sectiontitle">Included Modules</div>
    <ul>
        
        <li>
            
            <a href="Rack.html">PhusionPassenger::Rack</a>
            
            START:includes
        </li>
        
    </ul>
    

    

    

    

    
    <div class="sectiontitle">Attributes</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>next_cleaning_time</td>
            <td class='attr-desc'></td>
        </tr>
        
    </table>
    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M000049">
                    
                    <a name="M000049"></a><b>new</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000049_source')" id="l_M000049_source">show</a>
                        
                    </p>
                    <div id="M000049_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_server_collection.rb, line 44</span>
44:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>
45:     <span class="ruby-ivar">@collection</span> = {}
46:     <span class="ruby-ivar">@lock</span> = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>
47:     <span class="ruby-ivar">@cleanup_lock</span> = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>
48:     <span class="ruby-ivar">@cond</span> = <span class="ruby-constant">ConditionVariable</span>.<span class="ruby-identifier">new</span>
49:     <span class="ruby-ivar">@done</span> = <span class="ruby-keyword kw">false</span>
50:     
51:     <span class="ruby-comment cmt"># The next time the cleaner thread should check for idle servers.</span>
52:     <span class="ruby-comment cmt"># The value may be nil, in which case the value will be calculated</span>
53:     <span class="ruby-comment cmt"># at the end of the #synchronized block.</span>
54:     <span class="ruby-comment cmt">#</span>
55:     <span class="ruby-comment cmt"># Invariant:</span>
56:     <span class="ruby-comment cmt">#    if value is not nil:</span>
57:     <span class="ruby-comment cmt">#       There exists an s in @collection with s.next_cleaning_time == value.</span>
58:     <span class="ruby-comment cmt">#       for all s in @collection:</span>
59:     <span class="ruby-comment cmt">#          if eligable_for_cleanup?(s):</span>
60:     <span class="ruby-comment cmt">#             s.next_cleaning_time &lt;= value</span>
61:     <span class="ruby-ivar">@next_cleaning_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">+</span> <span class="ruby-value">60</span> <span class="ruby-operator">*</span> <span class="ruby-value">60</span>
62:     <span class="ruby-ivar">@next_cleaning_time_changed</span> = <span class="ruby-keyword kw">false</span>
63:     
64:     <span class="ruby-ivar">@cleaner_thread</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword kw">do</span>
65:       <span class="ruby-keyword kw">begin</span>
66:         <span class="ruby-ivar">@lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
67:           <span class="ruby-identifier">cleaner_thread_main</span>
68:         <span class="ruby-keyword kw">end</span>
69:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
70:         <span class="ruby-identifier">print_exception</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-identifier">e</span>)
71:       <span class="ruby-keyword kw">end</span>
72:     <span class="ruby-keyword kw">end</span>
73:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000059">
                    
                    <a name="M000059"></a><b>check_idle_servers!</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Tell the cleaner thread to check the collection as soon as possible,
instead of sleeping until the next scheduled cleaning time.
</p>
<p>
Precondition: this method must NOT be called within a <a
href="AbstractServerCollection.html#M000051">synchronize</a> block.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000059_source')" id="l_M000059_source">show</a>
                        
                    </p>
                    <div id="M000059_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_server_collection.rb, line 208</span>
208:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">check_idle_servers!</span>
209:     <span class="ruby-identifier">must_not_be_in_synchronize_block</span>
210:     <span class="ruby-ivar">@lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
211:       <span class="ruby-ivar">@next_cleaning_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">-</span> <span class="ruby-value">60</span> <span class="ruby-operator">*</span> <span class="ruby-value">60</span>
212:       <span class="ruby-ivar">@cond</span>.<span class="ruby-identifier">signal</span>
213:     <span class="ruby-keyword kw">end</span>
214:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000063">
                    
                    <a name="M000063"></a><b>cleanup</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Cleanup all resources used by this <a
href="AbstractServerCollection.html">AbstractServerCollection</a>. All
AbstractServers from the collection will be deleted. Each <a
href="AbstractServer.html">AbstractServer</a> will be stopped, if
necessary. The background thread which removes idle AbstractServers will be
stopped.
</p>
<p>
After calling this method, this <a
href="AbstractServerCollection.html">AbstractServerCollection</a> object
will become unusable.
</p>
<p>
Precondition: this method must <b>NOT</b> be called within a <a
href="AbstractServerCollection.html#M000051">synchronize</a> block.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000063_source')" id="l_M000063_source">show</a>
                        
                    </p>
                    <div id="M000063_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_server_collection.rb, line 260</span>
260:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cleanup</span>
261:     <span class="ruby-identifier">must_not_be_in_synchronize_block</span>
262:     <span class="ruby-ivar">@cleanup_lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
263:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@done</span>
264:       <span class="ruby-ivar">@lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
265:         <span class="ruby-ivar">@done</span> = <span class="ruby-keyword kw">true</span>
266:         <span class="ruby-ivar">@cond</span>.<span class="ruby-identifier">signal</span>
267:       <span class="ruby-keyword kw">end</span>
268:       <span class="ruby-ivar">@cleaner_thread</span>.<span class="ruby-identifier">join</span>
269:       <span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
270:         <span class="ruby-identifier">clear</span>
271:       <span class="ruby-keyword kw">end</span>
272:     <span class="ruby-keyword kw">end</span>
273:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000062">
                    
                    <a name="M000062"></a><b>clear</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Delete all AbstractServers from the collection. Each <a
href="AbstractServer.html">AbstractServer</a> will be stopped, if
necessary.
</p>
<p>
Precondition: this method must be called within a <a
href="AbstractServerCollection.html#M000051">synchronize</a> block.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000062_source')" id="l_M000062_source">show</a>
                        
                    </p>
                    <div id="M000062_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_server_collection.rb, line 241</span>
241:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">clear</span>
242:     <span class="ruby-identifier">must_be_in_synchronize_block</span>
243:     <span class="ruby-ivar">@collection</span>.<span class="ruby-identifier">each_value</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span><span class="ruby-operator">|</span>
244:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">started?</span>
245:         <span class="ruby-identifier">server</span>.<span class="ruby-identifier">stop</span>
246:       <span class="ruby-keyword kw">end</span>
247:     <span class="ruby-keyword kw">end</span>
248:     <span class="ruby-ivar">@collection</span>.<span class="ruby-identifier">clear</span>
249:     <span class="ruby-ivar">@next_cleaning_time</span> = <span class="ruby-keyword kw">nil</span>
250:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000057">
                    
                    <a name="M000057"></a><b>delete</b>(key)
                    
                </div>
                
                <div class="description">
                  <p>
Deletes from the collection the <a
href="AbstractServer.html">AbstractServer</a> that&#8217;s associated with
the given key. If no such <a href="AbstractServer.html">AbstractServer</a>
exists, nothing will happen.
</p>
<p>
If the <a href="AbstractServer.html">AbstractServer</a> is started, then it
will be stopped before deletion.
</p>
<p>
Precondition: this method must be called within a <a
href="AbstractServerCollection.html#M000051">synchronize</a> block.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000057_source')" id="l_M000057_source">show</a>
                        
                    </p>
                    <div id="M000057_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_server_collection.rb, line 170</span>
170:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete</span>(<span class="ruby-identifier">key</span>)
171:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">&quot;cleanup() has already been called.&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@done</span>
172:     <span class="ruby-identifier">must_be_in_synchronize_block</span>
173:     <span class="ruby-identifier">server</span> = <span class="ruby-ivar">@collection</span>[<span class="ruby-identifier">key</span>]
174:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">server</span>
175:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">started?</span>
176:         <span class="ruby-identifier">server</span>.<span class="ruby-identifier">stop</span>
177:       <span class="ruby-keyword kw">end</span>
178:       <span class="ruby-ivar">@collection</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">key</span>)
179:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">next_cleaning_time</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@next_cleaning_time</span>
180:         <span class="ruby-ivar">@next_cleaning_time</span> = <span class="ruby-keyword kw">nil</span>
181:       <span class="ruby-keyword kw">end</span>
182:     <span class="ruby-keyword kw">end</span>
183:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000060">
                    
                    <a name="M000060"></a><b>each</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Iterate over all <a href="AbstractServer.html">AbstractServer</a> objects.
</p>
<p>
Precondition: this method must be called within a <a
href="AbstractServerCollection.html#M000051">synchronize</a> block.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000060_source')" id="l_M000060_source">show</a>
                        
                    </p>
                    <div id="M000060_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_server_collection.rb, line 219</span>
219:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">each</span>
220:     <span class="ruby-identifier">must_be_in_synchronize_block</span>
221:     <span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">server</span><span class="ruby-operator">|</span>
222:       <span class="ruby-keyword kw">yield</span> <span class="ruby-identifier">server</span>
223:     <span class="ruby-keyword kw">end</span>
224:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000061">
                    
                    <a name="M000061"></a><b>each_pair</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Iterate over all keys and associated <a
href="AbstractServer.html">AbstractServer</a> objects.
</p>
<p>
Precondition: this method must be called within a <a
href="AbstractServerCollection.html#M000051">synchronize</a> block.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000061_source')" id="l_M000061_source">show</a>
                        
                    </p>
                    <div id="M000061_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_server_collection.rb, line 229</span>
229:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">each_pair</span>
230:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">&quot;cleanup() has already been called.&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@done</span>
231:     <span class="ruby-identifier">must_be_in_synchronize_block</span>
232:     <span class="ruby-ivar">@collection</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">server</span><span class="ruby-operator">|</span>
233:       <span class="ruby-keyword kw">yield</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">server</span>)
234:     <span class="ruby-keyword kw">end</span>
235:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000056">
                    
                    <a name="M000056"></a><b>empty?</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Checks whether the collection is empty.
</p>
<p>
Precondition: this method must be called within a <a
href="AbstractServerCollection.html#M000051">synchronize</a> block.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000056_source')" id="l_M000056_source">show</a>
                        
                    </p>
                    <div id="M000056_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_server_collection.rb, line 159</span>
159:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">empty?</span>
160:     <span class="ruby-identifier">must_be_in_synchronize_block</span>
161:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@collection</span>.<span class="ruby-identifier">empty?</span>
162:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000055">
                    
                    <a name="M000055"></a><b>has_key?</b>(key)
                    
                </div>
                
                <div class="description">
                  <p>
Checks whether there&#8217;s an <a
href="AbstractServer.html">AbstractServer</a> object associated with the
given key.
</p>
<p>
Precondition: this method must be called within a <a
href="AbstractServerCollection.html#M000051">synchronize</a> block.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000055_source')" id="l_M000055_source">show</a>
                        
                    </p>
                    <div id="M000055_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_server_collection.rb, line 151</span>
151:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">key</span>)
152:     <span class="ruby-identifier">must_be_in_synchronize_block</span>
153:     <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@collection</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">key</span>)
154:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000053">
                    
                    <a name="M000053"></a><b>lookup_or_add</b>(key)
                    
                </div>
                
                <div class="description">
                  <p>
Lookup and returns an <a href="AbstractServer.html">AbstractServer</a> with
the given key.
</p>
<p>
If there is no AbstractSerer associated with the given key, then the given
block will be called. That block must return an <a
href="AbstractServer.html">AbstractServer</a> object. Then, that object
will be stored in the collection, and returned.
</p>
<p>
The block must set the &#8216;max_idle_time&#8217; attribute on the <a
href="AbstractServer.html">AbstractServer</a>.
AbstractServerCollection&#8217;s idle cleaning interval will be adapted to
accomodate with this. Changing the value outside this block is not
guaranteed to have any effect on the idle cleaning interval. A
max_idle_time value of nil or 0 means the <a
href="AbstractServer.html">AbstractServer</a> will never be idle cleaned.
</p>
<p>
If the block raises an exception, then the collection will not be modified,
and the exception will be propagated.
</p>
<p>
Precondition: this method must be called within a <a
href="AbstractServerCollection.html#M000051">synchronize</a> block.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000053_source')" id="l_M000053_source">show</a>
                        
                    </p>
                    <div id="M000053_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_server_collection.rb, line 124</span>
124:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">lookup_or_add</span>(<span class="ruby-identifier">key</span>)
125:     <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">&quot;cleanup() has already been called.&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@done</span>
126:     <span class="ruby-identifier">must_be_in_synchronize_block</span>
127:     <span class="ruby-identifier">server</span> = <span class="ruby-ivar">@collection</span>[<span class="ruby-identifier">key</span>]
128:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">server</span>
129:       <span class="ruby-identifier">register_activity</span>(<span class="ruby-identifier">server</span>)
130:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">server</span>
131:     <span class="ruby-keyword kw">else</span>
132:       <span class="ruby-identifier">server</span> = <span class="ruby-keyword kw">yield</span>
133:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">server</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:start</span>)
134:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">TypeError</span>, <span class="ruby-value str">&quot;The block didn't return a valid AbstractServer object.&quot;</span>
135:       <span class="ruby-keyword kw">end</span>
136:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">eligable_for_cleanup?</span>(<span class="ruby-identifier">server</span>)
137:         <span class="ruby-identifier">server</span>.<span class="ruby-identifier">next_cleaning_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">max_idle_time</span>
138:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@next_cleaning_time</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">next_cleaning_time</span> <span class="ruby-operator">&lt;</span> <span class="ruby-ivar">@next_cleaning_time</span>
139:           <span class="ruby-ivar">@next_cleaning_time</span> = <span class="ruby-identifier">server</span>.<span class="ruby-identifier">next_cleaning_time</span>
140:           <span class="ruby-ivar">@next_cleaning_time_changed</span> = <span class="ruby-keyword kw">true</span>
141:         <span class="ruby-keyword kw">end</span>
142:       <span class="ruby-keyword kw">end</span>
143:       <span class="ruby-ivar">@collection</span>[<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">server</span>
144:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">server</span>
145:     <span class="ruby-keyword kw">end</span>
146:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000058">
                    
                    <a name="M000058"></a><b>register_activity</b>(server)
                    
                </div>
                
                <div class="description">
                  <p>
Notify this <a
href="AbstractServerCollection.html">AbstractServerCollection</a> that
<tt>server</tt> has performed an activity. This <a
href="AbstractServerCollection.html">AbstractServerCollection</a> will
update the idle information associated with <tt>server</tt> accordingly.
</p>
<p>
<a href="AbstractServerCollection.html#M000053">lookup_or_add</a> already
automatically updates idle information, so you only need to call this
method if the time at which the server has performed an activity is not
close to the time at which <a
href="AbstractServerCollection.html#M000053">lookup_or_add</a> had been
called.
</p>
<p>
Precondition: this method must be called within a <a
href="AbstractServerCollection.html#M000051">synchronize</a> block.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000058_source')" id="l_M000058_source">show</a>
                        
                    </p>
                    <div id="M000058_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_server_collection.rb, line 194</span>
194:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">register_activity</span>(<span class="ruby-identifier">server</span>)
195:     <span class="ruby-identifier">must_be_in_synchronize_block</span>
196:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">eligable_for_cleanup?</span>(<span class="ruby-identifier">server</span>)
197:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">next_cleaning_time</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@next_cleaning_time</span>
198:         <span class="ruby-ivar">@next_cleaning_time</span> = <span class="ruby-keyword kw">nil</span>
199:       <span class="ruby-keyword kw">end</span>
200:       <span class="ruby-identifier">server</span>.<span class="ruby-identifier">next_cleaning_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">max_idle_time</span>
201:     <span class="ruby-keyword kw">end</span>
202:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000051">
                    
                    <a name="M000051"></a><b>synchronize</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Acquire the lock for this <a
href="AbstractServerCollection.html">AbstractServerCollection</a> object,
and run the code within the block. The entire block will be a single atomic
operation.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000051_source')" id="l_M000051_source">show</a>
                        
                    </p>
                    <div id="M000051_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_server_collection.rb, line 78</span>
 78:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">synchronize</span>
 79:     <span class="ruby-ivar">@lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
 80:       <span class="ruby-ivar">@in_synchronize_block</span> = <span class="ruby-keyword kw">true</span>
 81:       <span class="ruby-keyword kw">begin</span>
 82:         <span class="ruby-keyword kw">yield</span>
 83:       <span class="ruby-keyword kw">ensure</span>
 84:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@next_cleaning_time</span>.<span class="ruby-identifier">nil?</span>
 85:           <span class="ruby-ivar">@collection</span>.<span class="ruby-identifier">each_value</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span><span class="ruby-operator">|</span>
 86:             <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@next_cleaning_time</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span>
 87:                (<span class="ruby-identifier">eligable_for_cleanup?</span>(<span class="ruby-identifier">server</span>) <span class="ruby-operator">&amp;&amp;</span>
 88:                 <span class="ruby-identifier">server</span>.<span class="ruby-identifier">next_cleaning_time</span> <span class="ruby-operator">&lt;</span> <span class="ruby-ivar">@next_cleaning_time</span>
 89:                )
 90:               <span class="ruby-ivar">@next_cleaning_time</span> = <span class="ruby-identifier">server</span>.<span class="ruby-identifier">next_cleaning_time</span>
 91:             <span class="ruby-keyword kw">end</span>
 92:           <span class="ruby-keyword kw">end</span>
 93:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@next_cleaning_time</span>.<span class="ruby-identifier">nil?</span>
 94:             <span class="ruby-comment cmt"># There are no servers in the collection with an idle timeout.</span>
 95:             <span class="ruby-ivar">@next_cleaning_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">+</span> <span class="ruby-value">60</span> <span class="ruby-operator">*</span> <span class="ruby-value">60</span>
 96:           <span class="ruby-keyword kw">end</span>
 97:           <span class="ruby-ivar">@next_cleaning_time_changed</span> = <span class="ruby-keyword kw">true</span>
 98:         <span class="ruby-keyword kw">end</span>
 99:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@next_cleaning_time_changed</span>
100:           <span class="ruby-ivar">@next_cleaning_time_changed</span> = <span class="ruby-keyword kw">false</span>
101:           <span class="ruby-ivar">@cond</span>.<span class="ruby-identifier">signal</span>
102:         <span class="ruby-keyword kw">end</span>
103:         <span class="ruby-ivar">@in_synchronize_block</span> = <span class="ruby-keyword kw">false</span>
104:       <span class="ruby-keyword kw">end</span>
105:     <span class="ruby-keyword kw">end</span>
106:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Private methods</div>
            
            <div class="method">
                <div class="title" id="M000064">
                    
                    <a name="M000064"></a><b>cleaner_thread_main</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000064_source')" id="l_M000064_source">show</a>
                        
                    </p>
                    <div id="M000064_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_server_collection.rb, line 276</span>
276:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cleaner_thread_main</span>
277:     <span class="ruby-keyword kw">while</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@done</span>
278:       <span class="ruby-identifier">current_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
279:       <span class="ruby-comment cmt"># We add a 0.2 seconds delay to the sleep time because system</span>
280:       <span class="ruby-comment cmt"># timers are not entirely accurate.</span>
281:       <span class="ruby-identifier">sleep_time</span> = (<span class="ruby-ivar">@next_cleaning_time</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">current_time</span>).<span class="ruby-identifier">to_f</span> <span class="ruby-operator">+</span> <span class="ruby-value">0</span><span class="ruby-value">.2</span>
282:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">sleep_time</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@cond</span>.<span class="ruby-identifier">timed_wait</span>(<span class="ruby-ivar">@lock</span>, <span class="ruby-identifier">sleep_time</span>)
283:         <span class="ruby-keyword kw">next</span>
284:       <span class="ruby-keyword kw">else</span>
285:         <span class="ruby-identifier">keys_to_delete</span> = <span class="ruby-keyword kw">nil</span>
286:         <span class="ruby-ivar">@next_cleaning_time</span> = <span class="ruby-keyword kw">nil</span>
287:         <span class="ruby-ivar">@collection</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">server</span><span class="ruby-operator">|</span>
288:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">eligable_for_cleanup?</span>(<span class="ruby-identifier">server</span>)
289:             <span class="ruby-comment cmt"># Cleanup this server if its idle timeout has expired.</span>
290:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">next_cleaning_time</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">current_time</span>
291:               <span class="ruby-identifier">keys_to_delete</span> <span class="ruby-operator">||=</span> []
292:               <span class="ruby-identifier">keys_to_delete</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">key</span>
293:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">started?</span>
294:                 <span class="ruby-identifier">server</span>.<span class="ruby-identifier">stop</span>
295:               <span class="ruby-keyword kw">end</span>
296:             <span class="ruby-comment cmt"># If not, then calculate the next cleaning time because</span>
297:             <span class="ruby-comment cmt"># we're iterating the collection anyway.</span>
298:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@next_cleaning_time</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span>
299:                   <span class="ruby-identifier">server</span>.<span class="ruby-identifier">next_cleaning_time</span> <span class="ruby-operator">&lt;</span> <span class="ruby-ivar">@next_cleaning_time</span>
300:               <span class="ruby-ivar">@next_cleaning_time</span> = <span class="ruby-identifier">server</span>.<span class="ruby-identifier">next_cleaning_time</span>
301:             <span class="ruby-keyword kw">end</span>
302:           <span class="ruby-keyword kw">end</span>
303:         <span class="ruby-keyword kw">end</span>
304:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">keys_to_delete</span>
305:           <span class="ruby-identifier">keys_to_delete</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>
306:             <span class="ruby-ivar">@collection</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">key</span>)
307:           <span class="ruby-keyword kw">end</span>
308:         <span class="ruby-keyword kw">end</span>
309:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@next_cleaning_time</span>.<span class="ruby-identifier">nil?</span>
310:           <span class="ruby-comment cmt"># There are no servers in the collection with an idle timeout.</span>
311:           <span class="ruby-ivar">@next_cleaning_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">+</span> <span class="ruby-value">60</span> <span class="ruby-operator">*</span> <span class="ruby-value">60</span>
312:         <span class="ruby-keyword kw">end</span>
313:       <span class="ruby-keyword kw">end</span>
314:     <span class="ruby-keyword kw">end</span>
315:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000065">
                    
                    <a name="M000065"></a><b>eligable_for_cleanup?</b>(server)
                    
                </div>
                
                <div class="description">
                  <p>
Checks whether the given server is eligible for being idle cleaned.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000065_source')" id="l_M000065_source">show</a>
                        
                    </p>
                    <div id="M000065_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_server_collection.rb, line 318</span>
318:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">eligable_for_cleanup?</span>(<span class="ruby-identifier">server</span>)
319:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">max_idle_time</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">max_idle_time</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
320:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000066">
                    
                    <a name="M000066"></a><b>must_be_in_synchronize_block</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000066_source')" id="l_M000066_source">show</a>
                        
                    </p>
                    <div id="M000066_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_server_collection.rb, line 322</span>
322:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">must_be_in_synchronize_block</span>
323:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@in_synchronize_block</span>
324:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">RuntimeError</span>, <span class="ruby-value str">&quot;This method may only be called within a #synchronize block!&quot;</span>
325:     <span class="ruby-keyword kw">end</span>
326:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000067">
                    
                    <a name="M000067"></a><b>must_not_be_in_synchronize_block</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000067_source')" id="l_M000067_source">show</a>
                        
                    </p>
                    <div id="M000067_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/abstract_server_collection.rb, line 328</span>
328:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">must_not_be_in_synchronize_block</span>
329:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@in_synchronize_block</span>
330:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">RuntimeError</span>, <span class="ruby-value str">&quot;This method may NOT be called within a #synchronize block!&quot;</span>
331:     <span class="ruby-keyword kw">end</span>
332:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    