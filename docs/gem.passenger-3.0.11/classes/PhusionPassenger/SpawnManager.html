<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>PhusionPassenger::SpawnManager</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
    <script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            PhusionPassenger::SpawnManager 
            
                <span class="parent">&lt; 
                    
                    AbstractServer
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/phusion_passenger/spawn_manager_rb.html">lib/phusion_passenger/spawn_manager.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
The spawn manager is capable of spawning Ruby on Rails or <a
href="Rack.html">Rack</a> application instances. It acts like a simple
fascade for the rest of the spawn manager system.
</p>
<p>
<b>Note</b>: <a href="SpawnManager.html">SpawnManager</a> may only be
started synchronously with <a
href="AbstractServer.html#M000024">AbstractServer#start_synchronously</a>.
Starting asynchronously has not been tested. Don&#8217;t forget to call
cleanup after the server&#8217;s main loop has finished.
</p>
<h2>Ruby on Rails optimizations</h2>
<p>
Spawning a Ruby on Rails application is usually slow. But <a
href="SpawnManager.html">SpawnManager</a> will preload and cache Ruby on
Rails frameworks, as well as application code, so subsequent spawns will be
very fast.
</p>
<p>
Internally, <a href="SpawnManager.html">SpawnManager</a> uses <a
href="ClassicRails/FrameworkSpawner.html">ClassicRails::FrameworkSpawner</a>
to preload and cache Ruby on Rails frameworks. <a
href="ClassicRails/FrameworkSpawner.html">ClassicRails::FrameworkSpawner</a>,
in turn, uses <a
href="ClassicRails/ApplicationSpawner.html">ClassicRails::ApplicationSpawner</a>
to preload and cache application code.
</p>
<p>
In case you&#8217;re wondering why the namespace is
&#8220;ClassicRails&#8221; and not &#8220;Rails&#8221;: it&#8217;s to work
around an obscure bug in ActiveSupport&#8217;s Dispatcher.
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>A</dt>
        <dd>
            <ul>
                
                <li><a href="#M000391">app_name</a></li>
                
            </ul>
        </dd>
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M000377">cleanup</a></li>
                
            </ul>
        </dd>
    
        <dt>D</dt>
        <dd>
            <ul>
                
                <li><a href="#M000389">database_error?</a></li>
                
            </ul>
        </dd>
    
        <dt>H</dt>
        <dd>
            <ul>
                
                <li><a href="#M000387">handle_reload</a>,</li>
                
                <li><a href="#M000386">handle_spawn_application</a></li>
                
            </ul>
        </dd>
    
        <dt>L</dt>
        <dd>
            <ul>
                
                <li><a href="#M000390">load_error?</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M000371">new</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000376">reload</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M000388">send_error_page</a>,</li>
                
                <li><a href="#M000372">spawn_application</a>,</li>
                
                <li><a href="#M000380">spawn_rack_application</a>,</li>
                
                <li><a href="#M000378">spawn_rails_application</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    
    <div class="sectiontitle">Included Modules</div>
    <ul>
        
        <li>
            
            <a href="Rack.html">PhusionPassenger::Rack</a>
            
            START:includes
        </li>
        
    </ul>
    

    

    

    

    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M000371">
                    
                    <a name="M000371"></a><b>new</b>(options = {})
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000371_source')" id="l_M000371_source">show</a>
                        
                    </p>
                    <div id="M000371_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/phusion_passenger/spawn_manager.rb, line 62</span>
62:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">options</span> = {})
63:     <span class="ruby-keyword kw">super</span>(<span class="ruby-value str">&quot;&quot;</span>, <span class="ruby-value str">&quot;&quot;</span>)
64:     <span class="ruby-ivar">@options</span> = <span class="ruby-identifier">options</span>
65:     <span class="ruby-ivar">@spawners</span> = <span class="ruby-constant">AbstractServerCollection</span>.<span class="ruby-identifier">new</span>
66:     <span class="ruby-identifier">define_message_handler</span>(<span class="ruby-identifier">:spawn_application</span>, <span class="ruby-identifier">:handle_spawn_application</span>)
67:     <span class="ruby-identifier">define_message_handler</span>(<span class="ruby-identifier">:reload</span>, <span class="ruby-identifier">:handle_reload</span>)
68:     <span class="ruby-identifier">define_signal_handler</span>(<span class="ruby-value str">'SIGHUP'</span>, <span class="ruby-identifier">:reload</span>)
69:     
70:     <span class="ruby-comment cmt"># Start garbage collector in order to free up some existing</span>
71:     <span class="ruby-comment cmt"># heap slots. This prevents the heap from growing unnecessarily</span>
72:     <span class="ruby-comment cmt"># during the startup phase.</span>
73:     <span class="ruby-constant">GC</span>.<span class="ruby-identifier">start</span>
74:     <span class="ruby-keyword kw">if</span> <span class="ruby-constant">GC</span>.<span class="ruby-identifier">copy_on_write_friendly?</span>
75:       <span class="ruby-comment cmt"># Preload libraries for copy-on-write semantics.</span>
76:       <span class="ruby-identifier">require</span> <span class="ruby-value str">'base64'</span>
77:       <span class="ruby-identifier">require</span> <span class="ruby-value str">'phusion_passenger/app_process'</span>
78:       <span class="ruby-identifier">require</span> <span class="ruby-value str">'phusion_passenger/classic_rails/framework_spawner'</span>
79:       <span class="ruby-identifier">require</span> <span class="ruby-value str">'phusion_passenger/classic_rails/application_spawner'</span>
80:       <span class="ruby-identifier">require</span> <span class="ruby-value str">'phusion_passenger/rack/application_spawner'</span>
81:       <span class="ruby-identifier">require</span> <span class="ruby-value str">'phusion_passenger/html_template'</span>
82:       <span class="ruby-identifier">require</span> <span class="ruby-value str">'phusion_passenger/platform_info'</span>
83:       <span class="ruby-identifier">require</span> <span class="ruby-value str">'phusion_passenger/exceptions'</span>
84:     <span class="ruby-keyword kw">end</span>
85:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000377">
                    
                    <a name="M000377"></a><b>cleanup</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Cleanup resources. Should be called when this <a
href="SpawnManager.html">SpawnManager</a> is no longer needed.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000377_source')" id="l_M000377_source">show</a>
                        
                    </p>
                    <div id="M000377_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/spawn_manager.rb, line 180</span>
180:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cleanup</span>
181:     <span class="ruby-ivar">@spawners</span>.<span class="ruby-identifier">cleanup</span>
182:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000376">
                    
                    <a name="M000376"></a><b>reload</b>(app_group_name = nil)
                    
                </div>
                
                <div class="description">
                  <p>
Remove the cached application instances at the given group name. If nil is
specified as group name, then all cached application instances will be
removed, no matter the group name.
</p>
<p>
<b>Long description:</b> Application code might be cached in memory. But
once it a while, it will be necessary to reload the code for an
application, such as after deploying a new version of the application. This
method makes sure that any cached application code is removed, so that the
next time an application instance is spawned, the application code will be
freshly loaded into memory.
</p>
<p>
Raises AbstractServer::SpawnError if something went wrong.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000376_source')" id="l_M000376_source">show</a>
                        
                    </p>
                    <div id="M000376_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/spawn_manager.rb, line 161</span>
161:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">reload</span>(<span class="ruby-identifier">app_group_name</span> = <span class="ruby-keyword kw">nil</span>)
162:     <span class="ruby-ivar">@spawners</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
163:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">app_group_name</span>
164:         <span class="ruby-comment cmt"># Stop and delete associated ApplicationSpawner.</span>
165:         <span class="ruby-ivar">@spawners</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-node">&quot;app:#{app_group_name}&quot;</span>)
166:         <span class="ruby-comment cmt"># Propagate reload command to associated FrameworkSpawner.</span>
167:         <span class="ruby-ivar">@spawners</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">spawner</span><span class="ruby-operator">|</span>
168:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">spawner</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:reload</span>)
169:             <span class="ruby-identifier">spawner</span>.<span class="ruby-identifier">reload</span>(<span class="ruby-identifier">app_group_name</span>)
170:           <span class="ruby-keyword kw">end</span>
171:         <span class="ruby-keyword kw">end</span>
172:       <span class="ruby-keyword kw">else</span>
173:         <span class="ruby-comment cmt"># Stop and delete all spawners.</span>
174:         <span class="ruby-ivar">@spawners</span>.<span class="ruby-identifier">clear</span>
175:       <span class="ruby-keyword kw">end</span>
176:     <span class="ruby-keyword kw">end</span>
177:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000372">
                    
                    <a name="M000372"></a><b>spawn_application</b>(options)
                    
                </div>
                
                <div class="description">
                  <p>
Spawns an application with the given spawn options. When successful, an <a
href="AppProcess.html">AppProcess</a> object will be returned, which
represents the spawned application process.
</p>
<p>
Most options are explained in PoolOptions.h.
</p>
<p>
Mandatory options:
</p>
<ul>
<li>&#8216;app_root&#8216;

</li>
</ul>
<p>
Optional options:
</p>
<ul>
<li>&#8216;app_type&#8216;

</li>
<li>&#8216;environment&#8217;

</li>
<li>&#8216;spawn_method&#8216;

</li>
<li>&#8216;user&#8217;,

</li>
<li>&#8216;group&#8217;

</li>
<li>&#8216;default_user&#8216;

</li>
<li>&#8216;default_group&#8216;

</li>
<li>&#8216;framework_spawner_timeout&#8216;

</li>
<li>&#8216;app_spawner_timeout&#8216;

</li>
<li>&#8216;environment_variables&#8217;: Environment variables which should be
passed to the spawned application process. This is NULL-seperated string of
key-value pairs, encoded in base64. The last byte in the unencoded data
must be a NULL.

</li>
<li>&#8216;base_uri&#8216;

</li>
<li>&#8216;print_exceptions&#8216;

</li>
</ul>
<p>
<b>Exceptions:</b>
</p>
<ul>
<li>InvalidPath: <tt>app_root</tt> doesn&#8217;t appear to be a valid Ruby on
Rails application root.

</li>
<li>VersionNotFound: The Ruby on Rails framework version that the given
application requires is not installed.

</li>
<li>AbstractServer::ServerError: One of the server processes exited
unexpectedly.

</li>
<li>FrameworkInitError: The Ruby on Rails framework that the application
requires could not be loaded.

</li>
<li>AppInitError: The application raised an exception or called exit() during
startup.

</li>
</ul>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000372_source')" id="l_M000372_source">show</a>
                        
                    </p>
                    <div id="M000372_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/spawn_manager.rb, line 120</span>
120:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">spawn_application</span>(<span class="ruby-identifier">options</span>)
121:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;app_root&quot;</span>]
122:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">&quot;The 'app_root' option must be given.&quot;</span>
123:     <span class="ruby-keyword kw">end</span>
124:     <span class="ruby-identifier">options</span> = <span class="ruby-identifier">sanitize_spawn_options</span>(<span class="ruby-identifier">options</span>)
125:     
126:     <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;app_type&quot;</span>]
127:     <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;rails&quot;</span>
128:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword kw">defined?</span>(<span class="ruby-constant">ClassicRails</span><span class="ruby-operator">::</span><span class="ruby-constant">FrameworkSpawner</span>)
129:         <span class="ruby-identifier">require</span> <span class="ruby-value str">'phusion_passenger/classic_rails/framework_spawner'</span>
130:         <span class="ruby-identifier">require</span> <span class="ruby-value str">'phusion_passenger/classic_rails/application_spawner'</span>
131:       <span class="ruby-keyword kw">end</span>
132:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">spawn_rails_application</span>(<span class="ruby-identifier">options</span>)
133:     <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;rack&quot;</span>
134:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword kw">defined?</span>(<span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">ApplicationSpawner</span>)
135:         <span class="ruby-identifier">require</span> <span class="ruby-value str">'phusion_passenger/rack/application_spawner'</span>
136:       <span class="ruby-keyword kw">end</span>
137:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">spawn_rack_application</span>(<span class="ruby-identifier">options</span>)
138:     <span class="ruby-keyword kw">when</span> <span class="ruby-value str">&quot;wsgi&quot;</span>
139:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword kw">defined?</span>(<span class="ruby-constant">WSGI</span><span class="ruby-operator">::</span><span class="ruby-constant">ApplicationSpawner</span>)
140:         <span class="ruby-identifier">require</span> <span class="ruby-value str">'phusion_passenger/wsgi/application_spawner'</span>
141:       <span class="ruby-keyword kw">end</span>
142:       <span class="ruby-keyword kw">return</span> <span class="ruby-constant">WSGI</span><span class="ruby-operator">::</span><span class="ruby-constant">ApplicationSpawner</span>.<span class="ruby-identifier">spawn_application</span>(<span class="ruby-identifier">options</span>)
143:     <span class="ruby-keyword kw">else</span>
144:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-node">&quot;Unknown 'app_type' value '#{options[&quot;app_type&quot;]}'.&quot;</span>
145:     <span class="ruby-keyword kw">end</span>
146:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Private methods</div>
            
            <div class="method">
                <div class="title" id="M000391">
                    
                    <a name="M000391"></a><b>app_name</b>(app_type)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000391_source')" id="l_M000391_source">show</a>
                        
                    </p>
                    <div id="M000391_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/spawn_manager.rb, line 350</span>
350:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">app_name</span>(<span class="ruby-identifier">app_type</span>)
351:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">app_type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;rails&quot;</span>
352:       <span class="ruby-keyword kw">return</span> <span class="ruby-value str">&quot;Ruby on Rails&quot;</span>
353:     <span class="ruby-keyword kw">else</span>
354:       <span class="ruby-keyword kw">return</span> <span class="ruby-value str">&quot;Ruby (Rack)&quot;</span>
355:     <span class="ruby-keyword kw">end</span>
356:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000389">
                    
                    <a name="M000389"></a><b>database_error?</b>(e)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000389_source')" id="l_M000389_source">show</a>
                        
                    </p>
                    <div id="M000389_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/spawn_manager.rb, line 333</span>
333:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">database_error?</span>(<span class="ruby-identifier">e</span>)
334:     <span class="ruby-keyword kw">return</span> ( <span class="ruby-keyword kw">defined?</span>(<span class="ruby-constant">Mysql</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">child_exception</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Mysql</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>) ) <span class="ruby-operator">||</span>
335:            ( <span class="ruby-identifier">e</span>.<span class="ruby-identifier">child_exception</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">UnknownError</span>) <span class="ruby-operator">&amp;&amp;</span>
336:                (
337:                    <span class="ruby-identifier">e</span>.<span class="ruby-identifier">child_exception</span>.<span class="ruby-identifier">real_class_name</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/^ActiveRecord/</span> <span class="ruby-operator">||</span>
338:                    <span class="ruby-identifier">e</span>.<span class="ruby-identifier">child_exception</span>.<span class="ruby-identifier">real_class_name</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/^Mysql::/</span>
339:                )
340:            )
341:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000387">
                    
                    <a name="M000387"></a><b>handle_reload</b>(client, app_group_name)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000387_source')" id="l_M000387_source">show</a>
                        
                    </p>
                    <div id="M000387_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/spawn_manager.rb, line 316</span>
316:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">handle_reload</span>(<span class="ruby-identifier">client</span>, <span class="ruby-identifier">app_group_name</span>)
317:     <span class="ruby-identifier">reload</span>(<span class="ruby-identifier">app_group_name</span>)
318:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000386">
                    
                    <a name="M000386"></a><b>handle_spawn_application</b>(client, *options)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000386_source')" id="l_M000386_source">show</a>
                        
                    </p>
                    <div id="M000386_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/spawn_manager.rb, line 269</span>
269:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">handle_spawn_application</span>(<span class="ruby-identifier">client</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">options</span>)
270:     <span class="ruby-identifier">options</span>     = <span class="ruby-identifier">sanitize_spawn_options</span>(<span class="ruby-constant">Hash</span>[<span class="ruby-operator">*</span><span class="ruby-identifier">options</span>])
271:     <span class="ruby-identifier">app_process</span> = <span class="ruby-keyword kw">nil</span>
272:     <span class="ruby-identifier">app_root</span>    = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;app_root&quot;</span>]
273:     <span class="ruby-identifier">app_type</span>    = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;app_type&quot;</span>]
274:     <span class="ruby-keyword kw">begin</span>
275:       <span class="ruby-identifier">app_process</span> = <span class="ruby-identifier">spawn_application</span>(<span class="ruby-identifier">options</span>)
276:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">AbstractServer</span><span class="ruby-operator">::</span><span class="ruby-constant">ServerError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
277:       <span class="ruby-identifier">send_error_page</span>(<span class="ruby-identifier">client</span>, <span class="ruby-value str">'general_error'</span>, <span class="ruby-identifier">:error</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>)
278:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">VersionNotFound</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
279:       <span class="ruby-identifier">send_error_page</span>(<span class="ruby-identifier">client</span>, <span class="ruby-value str">'version_not_found'</span>, <span class="ruby-identifier">:error</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>, <span class="ruby-identifier">:app_root</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">app_root</span>)
280:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">AppInitError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
281:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">database_error?</span>(<span class="ruby-identifier">e</span>)
282:         <span class="ruby-identifier">send_error_page</span>(<span class="ruby-identifier">client</span>, <span class="ruby-value str">'database_error'</span>, <span class="ruby-identifier">:error</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>,
283:           <span class="ruby-identifier">:app_root</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">app_root</span>, <span class="ruby-identifier">:app_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">app_name</span>(<span class="ruby-identifier">app_type</span>),
284:           <span class="ruby-identifier">:app_type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">app_type</span>)
285:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">load_error?</span>(<span class="ruby-identifier">e</span>)
286:         <span class="ruby-comment cmt"># A source file failed to load, maybe because of a</span>
287:         <span class="ruby-comment cmt"># missing gem. If that's the case then the sysadmin</span>
288:         <span class="ruby-comment cmt"># will install probably the gem. So we clear RubyGems's</span>
289:         <span class="ruby-comment cmt"># cache so that it can detect new gems.</span>
290:         <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">clear_paths</span>
291:         <span class="ruby-identifier">send_error_page</span>(<span class="ruby-identifier">client</span>, <span class="ruby-value str">'load_error'</span>, <span class="ruby-identifier">:error</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>, <span class="ruby-identifier">:app_root</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">app_root</span>,
292:           <span class="ruby-identifier">:app_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">app_name</span>(<span class="ruby-identifier">app_type</span>))
293:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">child_exception</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">SystemExit</span>)
294:         <span class="ruby-identifier">send_error_page</span>(<span class="ruby-identifier">client</span>, <span class="ruby-value str">'app_exited_during_initialization'</span>, <span class="ruby-identifier">:error</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>,
295:           <span class="ruby-identifier">:app_root</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">app_root</span>, <span class="ruby-identifier">:app_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">app_name</span>(<span class="ruby-identifier">app_type</span>))
296:       <span class="ruby-keyword kw">else</span>
297:         <span class="ruby-identifier">send_error_page</span>(<span class="ruby-identifier">client</span>, <span class="ruby-value str">'app_init_error'</span>, <span class="ruby-identifier">:error</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>,
298:           <span class="ruby-identifier">:app_root</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">app_root</span>, <span class="ruby-identifier">:app_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">app_name</span>(<span class="ruby-identifier">app_type</span>))
299:       <span class="ruby-keyword kw">end</span>
300:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">FrameworkInitError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
301:       <span class="ruby-identifier">send_error_page</span>(<span class="ruby-identifier">client</span>, <span class="ruby-value str">'framework_init_error'</span>, <span class="ruby-identifier">:error</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>)
302:     <span class="ruby-keyword kw">end</span>
303:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">app_process</span>
304:       <span class="ruby-keyword kw">begin</span>
305:         <span class="ruby-identifier">client</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value str">'ok'</span>)
306:         <span class="ruby-identifier">app_process</span>.<span class="ruby-identifier">write_to_channel</span>(<span class="ruby-identifier">client</span>)
307:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EPIPE</span>
308:         <span class="ruby-comment cmt"># The Apache module may be interrupted during a spawn command,</span>
309:         <span class="ruby-comment cmt"># in which case it will close the connection. We ignore this error.</span>
310:       <span class="ruby-keyword kw">ensure</span>
311:         <span class="ruby-identifier">app_process</span>.<span class="ruby-identifier">close</span>
312:       <span class="ruby-keyword kw">end</span>
313:     <span class="ruby-keyword kw">end</span>
314:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000390">
                    
                    <a name="M000390"></a><b>load_error?</b>(e)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000390_source')" id="l_M000390_source">show</a>
                        
                    </p>
                    <div id="M000390_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/spawn_manager.rb, line 343</span>
343:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">load_error?</span>(<span class="ruby-identifier">e</span>)
344:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">child_exception</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">LoadError</span>) <span class="ruby-operator">||</span> (
345:                <span class="ruby-identifier">e</span>.<span class="ruby-identifier">child_exception</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">UnknownError</span>) <span class="ruby-operator">&amp;&amp;</span>
346:                <span class="ruby-identifier">e</span>.<span class="ruby-identifier">child_exception</span>.<span class="ruby-identifier">real_class_name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;MissingSourceFile&quot;</span>
347:     )
348:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000388">
                    
                    <a name="M000388"></a><b>send_error_page</b>(channel, template_name, options = {})
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000388_source')" id="l_M000388_source">show</a>
                        
                    </p>
                    <div id="M000388_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/spawn_manager.rb, line 320</span>
320:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">send_error_page</span>(<span class="ruby-identifier">channel</span>, <span class="ruby-identifier">template_name</span>, <span class="ruby-identifier">options</span> = {})
321:     <span class="ruby-identifier">require</span> <span class="ruby-value str">'phusion_passenger/html_template'</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-keyword kw">defined?</span>(<span class="ruby-constant">HTMLTemplate</span>)
322:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword kw">defined?</span>(<span class="ruby-constant">PlatformInfo</span>)
323:       <span class="ruby-identifier">require</span> <span class="ruby-value str">'phusion_passenger/platform_info'</span>
324:       <span class="ruby-identifier">require</span> <span class="ruby-value str">'phusion_passenger/platform_info/ruby'</span>
325:     <span class="ruby-keyword kw">end</span>
326:     <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;enterprisey&quot;</span>] = <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-node">&quot;#{SOURCE_ROOT}/enterprisey.txt&quot;</span>) <span class="ruby-operator">||</span>
327:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-value str">&quot;/etc/passenger_enterprisey.txt&quot;</span>)
328:     <span class="ruby-identifier">data</span> = <span class="ruby-constant">HTMLTemplate</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">template_name</span>, <span class="ruby-identifier">options</span>).<span class="ruby-identifier">result</span>
329:     <span class="ruby-identifier">channel</span>.<span class="ruby-identifier">write</span>(<span class="ruby-value str">'error_page'</span>)
330:     <span class="ruby-identifier">channel</span>.<span class="ruby-identifier">write_scalar</span>(<span class="ruby-identifier">data</span>)
331:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000380">
                    
                    <a name="M000380"></a><b>spawn_rack_application</b>(options)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000380_source')" id="l_M000380_source">show</a>
                        
                    </p>
                    <div id="M000380_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/spawn_manager.rb, line 235</span>
235:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">spawn_rack_application</span>(<span class="ruby-identifier">options</span>)
236:     <span class="ruby-identifier">app_group_name</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;app_group_name&quot;</span>]
237:     <span class="ruby-identifier">spawn_method</span>   = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;spawn_method&quot;</span>]
238:     <span class="ruby-identifier">spawner</span>        = <span class="ruby-keyword kw">nil</span>
239:     <span class="ruby-identifier">create_spawner</span> = <span class="ruby-keyword kw">nil</span>
240:     <span class="ruby-identifier">key</span>            = <span class="ruby-keyword kw">nil</span>
241:     
242:     <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">spawn_method</span>
243:     <span class="ruby-keyword kw">when</span> <span class="ruby-keyword kw">nil</span>, <span class="ruby-value str">&quot;&quot;</span>, <span class="ruby-value str">&quot;smart&quot;</span>, <span class="ruby-value str">&quot;smart-lv2&quot;</span>
244:       <span class="ruby-ivar">@spawners</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
245:         <span class="ruby-identifier">key</span> = <span class="ruby-node">&quot;app:#{app_group_name}&quot;</span>
246:         <span class="ruby-identifier">spawner</span> = <span class="ruby-ivar">@spawners</span>.<span class="ruby-identifier">lookup_or_add</span>(<span class="ruby-identifier">key</span>) <span class="ruby-keyword kw">do</span>
247:           <span class="ruby-identifier">spawner_timeout</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;app_spawner_timeout&quot;</span>]
248:           <span class="ruby-identifier">spawner</span> = <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">ApplicationSpawner</span>.<span class="ruby-identifier">new</span>(
249:             <span class="ruby-ivar">@options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">options</span>))
250:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">spawner_timeout</span> <span class="ruby-operator">!=</span> <span class="ruby-value">-1</span>
251:             <span class="ruby-identifier">spawner</span>.<span class="ruby-identifier">max_idle_time</span> = <span class="ruby-identifier">spawner_timeout</span>
252:           <span class="ruby-keyword kw">end</span>
253:           <span class="ruby-identifier">spawner</span>.<span class="ruby-identifier">start</span>
254:           <span class="ruby-identifier">spawner</span>
255:         <span class="ruby-keyword kw">end</span>
256:         <span class="ruby-keyword kw">begin</span>
257:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">spawner</span>.<span class="ruby-identifier">spawn_application</span>(<span class="ruby-identifier">options</span>)
258:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">AbstractServer</span><span class="ruby-operator">::</span><span class="ruby-constant">ServerError</span>
259:           <span class="ruby-ivar">@spawners</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">key</span>)
260:           <span class="ruby-identifier">raise</span>
261:         <span class="ruby-keyword kw">end</span>
262:       <span class="ruby-keyword kw">end</span>
263:     <span class="ruby-keyword kw">else</span>
264:       <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">ApplicationSpawner</span>.<span class="ruby-identifier">spawn_application</span>(
265:         <span class="ruby-ivar">@options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">options</span>))
266:     <span class="ruby-keyword kw">end</span>
267:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000378">
                    
                    <a name="M000378"></a><b>spawn_rails_application</b>(options)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000378_source')" id="l_M000378_source">show</a>
                        
                    </p>
                    <div id="M000378_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/phusion_passenger/spawn_manager.rb, line 185</span>
185:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">spawn_rails_application</span>(<span class="ruby-identifier">options</span>)
186:     <span class="ruby-identifier">app_root</span>       = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;app_root&quot;</span>]
187:     <span class="ruby-identifier">app_group_name</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;app_group_name&quot;</span>]
188:     <span class="ruby-identifier">spawn_method</span>   = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;spawn_method&quot;</span>]
189:     <span class="ruby-identifier">spawner</span>        = <span class="ruby-keyword kw">nil</span>
190:     <span class="ruby-identifier">create_spawner</span> = <span class="ruby-keyword kw">nil</span>
191:     <span class="ruby-identifier">key</span>            = <span class="ruby-keyword kw">nil</span>
192:     
193:     <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">spawn_method</span>
194:     <span class="ruby-keyword kw">when</span> <span class="ruby-keyword kw">nil</span>, <span class="ruby-value str">&quot;&quot;</span>, <span class="ruby-value str">&quot;smart&quot;</span>, <span class="ruby-value str">&quot;smart-lv2&quot;</span>
195:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">spawn_method</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;smart-lv2&quot;</span>
196:         <span class="ruby-identifier">framework_version</span> = <span class="ruby-constant">AppProcess</span>.<span class="ruby-identifier">detect_framework_version</span>(<span class="ruby-identifier">app_root</span>)
197:       <span class="ruby-keyword kw">end</span>
198:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">framework_version</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">framework_version</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:vendor</span>
199:         <span class="ruby-identifier">key</span> = <span class="ruby-node">&quot;app:#{app_group_name}&quot;</span>
200:         <span class="ruby-identifier">create_spawner</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword kw">do</span>
201:           <span class="ruby-constant">ClassicRails</span><span class="ruby-operator">::</span><span class="ruby-constant">ApplicationSpawner</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">options</span>))
202:         <span class="ruby-keyword kw">end</span>
203:         <span class="ruby-identifier">spawner_timeout</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;app_spawner_timeout&quot;</span>]
204:       <span class="ruby-keyword kw">else</span>
205:         <span class="ruby-identifier">key</span> = <span class="ruby-node">&quot;version:#{framework_version}&quot;</span>
206:         <span class="ruby-identifier">create_spawner</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword kw">do</span>
207:           <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;framework_version&quot;</span>] = <span class="ruby-identifier">framework_version</span>
208:           <span class="ruby-constant">ClassicRails</span><span class="ruby-operator">::</span><span class="ruby-constant">FrameworkSpawner</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">options</span>))
209:         <span class="ruby-keyword kw">end</span>
210:         <span class="ruby-identifier">spawner_timeout</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value str">&quot;framework_spawner_timeout&quot;</span>]
211:       <span class="ruby-keyword kw">end</span>
212:       
213:       <span class="ruby-ivar">@spawners</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
214:         <span class="ruby-identifier">spawner</span> = <span class="ruby-ivar">@spawners</span>.<span class="ruby-identifier">lookup_or_add</span>(<span class="ruby-identifier">key</span>) <span class="ruby-keyword kw">do</span>
215:           <span class="ruby-identifier">spawner</span> = <span class="ruby-identifier">create_spawner</span>.<span class="ruby-identifier">call</span>
216:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">spawner_timeout</span> <span class="ruby-operator">!=</span> <span class="ruby-value">-1</span>
217:             <span class="ruby-identifier">spawner</span>.<span class="ruby-identifier">max_idle_time</span> = <span class="ruby-identifier">spawner_timeout</span>
218:           <span class="ruby-keyword kw">end</span>
219:           <span class="ruby-identifier">spawner</span>.<span class="ruby-identifier">start</span>
220:           <span class="ruby-identifier">spawner</span>
221:         <span class="ruby-keyword kw">end</span>
222:         <span class="ruby-keyword kw">begin</span>
223:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">spawner</span>.<span class="ruby-identifier">spawn_application</span>(<span class="ruby-identifier">options</span>)
224:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">AbstractServer</span><span class="ruby-operator">::</span><span class="ruby-constant">ServerError</span>
225:           <span class="ruby-ivar">@spawners</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">key</span>)
226:           <span class="ruby-identifier">raise</span>
227:         <span class="ruby-keyword kw">end</span>
228:       <span class="ruby-keyword kw">end</span>
229:     <span class="ruby-keyword kw">else</span>
230:       <span class="ruby-keyword kw">return</span> <span class="ruby-constant">ClassicRails</span><span class="ruby-operator">::</span><span class="ruby-constant">ApplicationSpawner</span>.<span class="ruby-identifier">spawn_application</span>(
231:         <span class="ruby-ivar">@options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">options</span>))
232:     <span class="ruby-keyword kw">end</span>
233:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    