<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>OpenID::Consumer::AssociationManager</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../../css/main.css" type="text/css" media="screen" />
    <script src="../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            OpenID::Consumer::AssociationManager 
            
                <span class="parent">&lt; 
                    
                    Object
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../files/lib/openid/consumer/associationmanager_rb.html">lib/openid/consumer/associationmanager.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
An object that manages creating and storing associations for an <a
href="../../OpenID.html">OpenID</a> provider endpoint
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M000046">create_associate_request</a>,</li>
                
                <li><a href="#M000040">create_session</a></li>
                
            </ul>
        </dd>
    
        <dt>E</dt>
        <dd>
            <ul>
                
                <li><a href="#M000053">extract_association</a>,</li>
                
                <li><a href="#M000052">extract_expires_in</a>,</li>
                
                <li><a href="#M000044">extract_supported_association_type</a></li>
                
            </ul>
        </dd>
    
        <dt>G</dt>
        <dd>
            <ul>
                
                <li><a href="#M000042">get_association</a>,</li>
                
                <li><a href="#M000048">get_openid1_session_type</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M000043">negotiate_association</a>,</li>
                
                <li><a href="#M000041">new</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000045">request_association</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    

    

    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M000040">
                    
                    <a name="M000040"></a><b>create_session</b>(session_type)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000040_source')" id="l_M000040_source">show</a>
                        
                    </p>
                    <div id="M000040_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/associationmanager.rb, line 89</span>
 89:       <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">create_session</span>(<span class="ruby-identifier">session_type</span>)
 90:         <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">session_type</span>
 91:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'no-encryption'</span>
 92:           <span class="ruby-constant">NoEncryptionSession</span>.<span class="ruby-identifier">new</span>
 93:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'DH-SHA1'</span>
 94:           <span class="ruby-constant">DiffieHellmanSHA1Session</span>.<span class="ruby-identifier">new</span>
 95:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'DH-SHA256'</span>
 96:           <span class="ruby-constant">DiffieHellmanSHA256Session</span>.<span class="ruby-identifier">new</span>
 97:         <span class="ruby-keyword kw">else</span>
 98:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">&quot;Unknown association session type: &quot;</span>\
 99:                                <span class="ruby-node">&quot;#{session_type.inspect}&quot;</span>
100:         <span class="ruby-keyword kw">end</span>
101:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000041">
                    
                    <a name="M000041"></a><b>new</b>(store, server_url, compatibility_mode=false, negotiator=nil)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000041_source')" id="l_M000041_source">show</a>
                        
                    </p>
                    <div id="M000041_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/associationmanager.rb, line 103</span>
103:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">store</span>, <span class="ruby-identifier">server_url</span>, <span class="ruby-identifier">compatibility_mode</span>=<span class="ruby-keyword kw">false</span>,
104:                      <span class="ruby-identifier">negotiator</span>=<span class="ruby-keyword kw">nil</span>)
105:         <span class="ruby-ivar">@store</span> = <span class="ruby-identifier">store</span>
106:         <span class="ruby-ivar">@server_url</span> = <span class="ruby-identifier">server_url</span>
107:         <span class="ruby-ivar">@compatibility_mode</span> = <span class="ruby-identifier">compatibility_mode</span>
108:         <span class="ruby-ivar">@negotiator</span> = <span class="ruby-identifier">negotiator</span> <span class="ruby-operator">||</span> <span class="ruby-constant">DefaultNegotiator</span>
109:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Class Protected methods</div>
            
            <div class="method">
                <div class="title" id="M000052">
                    
                    <a name="M000052"></a><b>extract_expires_in</b>(message)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000052_source')" id="l_M000052_source">show</a>
                        
                    </p>
                    <div id="M000052_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/associationmanager.rb, line 272</span>
272:       <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">extract_expires_in</span>(<span class="ruby-identifier">message</span>)
273:         <span class="ruby-comment cmt"># expires_in should be a base-10 string.</span>
274:         <span class="ruby-identifier">expires_in_str</span> = <span class="ruby-identifier">message</span>.<span class="ruby-identifier">get_arg</span>(<span class="ruby-constant">OPENID_NS</span>, <span class="ruby-value str">'expires_in'</span>, <span class="ruby-constant">NO_DEFAULT</span>)
275:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span>(<span class="ruby-regexp re">/\A\d+\Z/</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">expires_in_str</span>)
276:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, <span class="ruby-node">&quot;Invalid expires_in field: #{expires_in_str}&quot;</span>
277:         <span class="ruby-keyword kw">end</span>
278:         <span class="ruby-identifier">expires_in_str</span>.<span class="ruby-identifier">to_i</span>
279:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000042">
                    
                    <a name="M000042"></a><b>get_association</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000042_source')" id="l_M000042_source">show</a>
                        
                    </p>
                    <div id="M000042_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/associationmanager.rb, line 111</span>
111:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_association</span>
112:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">nil?</span>
113:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
114:         <span class="ruby-keyword kw">end</span>
115: 
116:         <span class="ruby-identifier">assoc</span> = <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">get_association</span>(<span class="ruby-ivar">@server_url</span>)
117:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">assoc</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">assoc</span>.<span class="ruby-identifier">expires_in</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">0</span>
118:           <span class="ruby-identifier">assoc</span> = <span class="ruby-identifier">negotiate_association</span>
119:           <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">assoc</span>.<span class="ruby-identifier">nil?</span>
120:             <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">store_association</span>(<span class="ruby-ivar">@server_url</span>, <span class="ruby-identifier">assoc</span>)
121:           <span class="ruby-keyword kw">end</span>
122:         <span class="ruby-keyword kw">end</span>
123: 
124:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">assoc</span>
125:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000043">
                    
                    <a name="M000043"></a><b>negotiate_association</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000043_source')" id="l_M000043_source">show</a>
                        
                    </p>
                    <div id="M000043_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/associationmanager.rb, line 127</span>
127:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">negotiate_association</span>
128:         <span class="ruby-identifier">assoc_type</span>, <span class="ruby-identifier">session_type</span> = <span class="ruby-ivar">@negotiator</span>.<span class="ruby-identifier">get_allowed_type</span>
129:         <span class="ruby-keyword kw">begin</span>
130:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">request_association</span>(<span class="ruby-identifier">assoc_type</span>, <span class="ruby-identifier">session_type</span>)
131:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">ServerError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">why</span>
132:           <span class="ruby-identifier">supported_types</span> = <span class="ruby-identifier">extract_supported_association_type</span>(<span class="ruby-identifier">why</span>, <span class="ruby-identifier">assoc_type</span>)
133:           <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">supported_types</span>.<span class="ruby-identifier">nil?</span>
134:             <span class="ruby-comment cmt"># Attempt to create an association from the assoc_type and</span>
135:             <span class="ruby-comment cmt"># session_type that the server told us it supported.</span>
136:             <span class="ruby-identifier">assoc_type</span>, <span class="ruby-identifier">session_type</span> = <span class="ruby-identifier">supported_types</span>
137:             <span class="ruby-keyword kw">begin</span>
138:               <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">request_association</span>(<span class="ruby-identifier">assoc_type</span>, <span class="ruby-identifier">session_type</span>)
139:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">ServerError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">why</span>
140:               <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Server #{@server_url} refused its suggested &quot;</span> \
141:                        <span class="ruby-node">&quot;association type: session_type=#{session_type}, &quot;</span> \
142:                        <span class="ruby-node">&quot;assoc_type=#{assoc_type}&quot;</span>)
143:               <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
144:             <span class="ruby-keyword kw">end</span>
145:           <span class="ruby-keyword kw">end</span>
146:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">InvalidOpenIDNamespace</span>
147:           <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Server #{@server_url} returned a malformed association &quot;</span> \
148:                    <span class="ruby-value str">&quot;response.  Falling back to check_id mode for this request.&quot;</span>)
149:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
150:         <span class="ruby-keyword kw">end</span>
151:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Protected methods</div>
            
            <div class="method">
                <div class="title" id="M000046">
                    
                    <a name="M000046"></a><b>create_associate_request</b>(assoc_type, session_type)
                    
                </div>
                
                <div class="description">
                  <p>
Create an association request for the given assoc_type and session_type.
Returns a pair of the association session object and the request message
that will be sent to the server.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000046_source')" id="l_M000046_source">show</a>
                        
                    </p>
                    <div id="M000046_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/associationmanager.rb, line 215</span>
215:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_associate_request</span>(<span class="ruby-identifier">assoc_type</span>, <span class="ruby-identifier">session_type</span>)
216:         <span class="ruby-identifier">assoc_session</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">create_session</span>(<span class="ruby-identifier">session_type</span>)
217:         <span class="ruby-identifier">args</span> = {
218:           <span class="ruby-value str">'mode'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'associate'</span>,
219:           <span class="ruby-value str">'assoc_type'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">assoc_type</span>,
220:         }
221: 
222:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@compatibility_mode</span>
223:           <span class="ruby-identifier">args</span>[<span class="ruby-value str">'ns'</span>] = <span class="ruby-constant">OPENID2_NS</span>
224:         <span class="ruby-keyword kw">end</span>
225: 
226:         <span class="ruby-comment cmt"># Leave out the session type if we're in compatibility mode</span>
227:         <span class="ruby-comment cmt"># *and* it's no-encryption.</span>
228:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@compatibility_mode</span> <span class="ruby-operator">||</span>
229:             <span class="ruby-identifier">assoc_session</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">session_type</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">'no-encryption'</span>
230:           <span class="ruby-identifier">args</span>[<span class="ruby-value str">'session_type'</span>] = <span class="ruby-identifier">assoc_session</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">session_type</span>
231:         <span class="ruby-keyword kw">end</span>
232: 
233:         <span class="ruby-identifier">args</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-identifier">assoc_session</span>.<span class="ruby-identifier">get_request</span>)
234:         <span class="ruby-identifier">message</span> = <span class="ruby-constant">Message</span>.<span class="ruby-identifier">from_openid_args</span>(<span class="ruby-identifier">args</span>)
235:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">assoc_session</span>, <span class="ruby-identifier">message</span>
236:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000053">
                    
                    <a name="M000053"></a><b>extract_association</b>(assoc_response, assoc_session)
                    
                </div>
                
                <div class="description">
                  <p>
Attempt to extract an association from the response, given the association
response message and the established association session.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000053_source')" id="l_M000053_source">show</a>
                        
                    </p>
                    <div id="M000053_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/associationmanager.rb, line 284</span>
284:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">extract_association</span>(<span class="ruby-identifier">assoc_response</span>, <span class="ruby-identifier">assoc_session</span>)
285:         <span class="ruby-comment cmt"># Extract the common fields from the response, raising an</span>
286:         <span class="ruby-comment cmt"># exception if they are not found</span>
287:         <span class="ruby-identifier">assoc_type</span> = <span class="ruby-identifier">assoc_response</span>.<span class="ruby-identifier">get_arg</span>(<span class="ruby-constant">OPENID_NS</span>, <span class="ruby-value str">'assoc_type'</span>,
288:                                             <span class="ruby-constant">NO_DEFAULT</span>)
289:         <span class="ruby-identifier">assoc_handle</span> = <span class="ruby-identifier">assoc_response</span>.<span class="ruby-identifier">get_arg</span>(<span class="ruby-constant">OPENID_NS</span>, <span class="ruby-value str">'assoc_handle'</span>,
290:                                               <span class="ruby-constant">NO_DEFAULT</span>)
291:         <span class="ruby-identifier">expires_in</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">extract_expires_in</span>(<span class="ruby-identifier">assoc_response</span>)
292: 
293:         <span class="ruby-comment cmt"># OpenID 1 has funny association session behaviour.</span>
294:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">assoc_response</span>.<span class="ruby-identifier">is_openid1</span>
295:             <span class="ruby-identifier">session_type</span> = <span class="ruby-identifier">get_openid1_session_type</span>(<span class="ruby-identifier">assoc_response</span>)
296:         <span class="ruby-keyword kw">else</span>
297:           <span class="ruby-identifier">session_type</span> = <span class="ruby-identifier">assoc_response</span>.<span class="ruby-identifier">get_arg</span>(<span class="ruby-constant">OPENID2_NS</span>, <span class="ruby-value str">'session_type'</span>,
298:                                                 <span class="ruby-constant">NO_DEFAULT</span>)
299:         <span class="ruby-keyword kw">end</span>
300: 
301:         <span class="ruby-comment cmt"># Session type mismatch</span>
302:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">assoc_session</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">session_type</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">session_type</span>
303:           <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">assoc_response</span>.<span class="ruby-identifier">is_openid1</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">session_type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'no-encryption'</span>)
304:             <span class="ruby-comment cmt"># In OpenID 1, any association request can result in a</span>
305:             <span class="ruby-comment cmt"># 'no-encryption' association response. Setting</span>
306:             <span class="ruby-comment cmt"># assoc_session to a new no-encryption session should</span>
307:             <span class="ruby-comment cmt"># make the rest of this function work properly for</span>
308:             <span class="ruby-comment cmt"># that case.</span>
309:             <span class="ruby-identifier">assoc_session</span> = <span class="ruby-constant">NoEncryptionSession</span>.<span class="ruby-identifier">new</span>
310:           <span class="ruby-keyword kw">else</span>
311:             <span class="ruby-comment cmt"># Any other mismatch, regardless of protocol version</span>
312:             <span class="ruby-comment cmt"># results in the failure of the association session</span>
313:             <span class="ruby-comment cmt"># altogether.</span>
314:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, <span class="ruby-value str">&quot;Session type mismatch. Expected &quot;</span>\
315:                                  <span class="ruby-node">&quot;#{assoc_session.class.session_type}, got &quot;</span>\
316:                                  <span class="ruby-node">&quot;#{session_type}&quot;</span>
317:           <span class="ruby-keyword kw">end</span>
318:         <span class="ruby-keyword kw">end</span>
319: 
320:         <span class="ruby-comment cmt"># Make sure assoc_type is valid for session_type</span>
321:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">assoc_session</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">allowed_assoc_types</span>.<span class="ruby-identifier">member?</span>(<span class="ruby-identifier">assoc_type</span>)
322:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, <span class="ruby-value str">&quot;Unsupported assoc_type for session &quot;</span>\
323:                                <span class="ruby-node">&quot;#{assoc_session.class.session_type} &quot;</span>\
324:                                <span class="ruby-node">&quot;returned: #{assoc_type}&quot;</span>
325:         <span class="ruby-keyword kw">end</span>
326: 
327:         <span class="ruby-comment cmt"># Delegate to the association session to extract the secret</span>
328:         <span class="ruby-comment cmt"># from the response, however is appropriate for that session</span>
329:         <span class="ruby-comment cmt"># type.</span>
330:         <span class="ruby-keyword kw">begin</span>
331:           <span class="ruby-identifier">secret</span> = <span class="ruby-identifier">assoc_session</span>.<span class="ruby-identifier">extract_secret</span>(<span class="ruby-identifier">assoc_response</span>)
332:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Message</span><span class="ruby-operator">::</span><span class="ruby-constant">KeyNotFound</span>, <span class="ruby-constant">ArgumentError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">why</span>
333:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, <span class="ruby-value str">&quot;Malformed response for &quot;</span>\
334:                                <span class="ruby-node">&quot;#{assoc_session.class.session_type} &quot;</span>\
335:                                <span class="ruby-node">&quot;session: #{why.message}&quot;</span>
336:         <span class="ruby-keyword kw">end</span>
337: 
338: 
339:         <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Association</span>.<span class="ruby-identifier">from_expires_in</span>(<span class="ruby-identifier">expires_in</span>, <span class="ruby-identifier">assoc_handle</span>, <span class="ruby-identifier">secret</span>,
340:                                            <span class="ruby-identifier">assoc_type</span>)
341:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000044">
                    
                    <a name="M000044"></a><b>extract_supported_association_type</b>(server_error, assoc_type)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000044_source')" id="l_M000044_source">show</a>
                        
                    </p>
                    <div id="M000044_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/associationmanager.rb, line 154</span>
154:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">extract_supported_association_type</span>(<span class="ruby-identifier">server_error</span>, <span class="ruby-identifier">assoc_type</span>)
155:         <span class="ruby-comment cmt"># Any error message whose code is not 'unsupported-type' should</span>
156:         <span class="ruby-comment cmt"># be considered a total failure.</span>
157:         <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">server_error</span>.<span class="ruby-identifier">error_code</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">'unsupported-type'</span> <span class="ruby-keyword kw">or</span>
158:             <span class="ruby-identifier">server_error</span>.<span class="ruby-identifier">message</span>.<span class="ruby-identifier">is_openid1</span>)
159:           <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-value str">&quot;Server error when requesting an association from &quot;</span>\
160:                    <span class="ruby-node">&quot;#{@server_url}: #{server_error.error_text}&quot;</span>)
161:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
162:         <span class="ruby-keyword kw">end</span>
163: 
164:         <span class="ruby-comment cmt"># The server didn't like the association/session type that we</span>
165:         <span class="ruby-comment cmt"># sent, and it sent us back a message that might tell us how to</span>
166:         <span class="ruby-comment cmt"># handle it.</span>
167:         <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Unsupported association type #{assoc_type}: &quot;</span>\
168:                  <span class="ruby-node">&quot;#{server_error.error_text}&quot;</span>)
169: 
170:         <span class="ruby-comment cmt"># Extract the session_type and assoc_type from the error message</span>
171:         <span class="ruby-identifier">assoc_type</span> = <span class="ruby-identifier">server_error</span>.<span class="ruby-identifier">message</span>.<span class="ruby-identifier">get_arg</span>(<span class="ruby-constant">OPENID_NS</span>, <span class="ruby-value str">'assoc_type'</span>)
172:         <span class="ruby-identifier">session_type</span> = <span class="ruby-identifier">server_error</span>.<span class="ruby-identifier">message</span>.<span class="ruby-identifier">get_arg</span>(<span class="ruby-constant">OPENID_NS</span>, <span class="ruby-value str">'session_type'</span>)
173: 
174:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">assoc_type</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">session_type</span>.<span class="ruby-identifier">nil?</span>
175:           <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Server #{@server_url} responded with unsupported &quot;</span>\
176:                    <span class="ruby-value str">&quot;association session but did not supply a fallback.&quot;</span>)
177:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
178:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@negotiator</span>.<span class="ruby-identifier">allowed?</span>(<span class="ruby-identifier">assoc_type</span>, <span class="ruby-identifier">session_type</span>)
179:           <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-value str">&quot;Server sent unsupported session/association type: &quot;</span>\
180:                    <span class="ruby-node">&quot;session_type=#{session_type}, assoc_type=#{assoc_type}&quot;</span>)
181:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
182:         <span class="ruby-keyword kw">else</span>
183:           <span class="ruby-keyword kw">return</span> [<span class="ruby-identifier">assoc_type</span>, <span class="ruby-identifier">session_type</span>]
184:         <span class="ruby-keyword kw">end</span>
185:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000048">
                    
                    <a name="M000048"></a><b>get_openid1_session_type</b>(assoc_response)
                    
                </div>
                
                <div class="description">
                  <p>
Given an association response message, extract the <a
href="../../OpenID.html">OpenID</a> 1.X session type. Returns the
association type for this message
</p>
<p>
This function mostly takes care of the &#8216;no-encryption&#8217; default
behavior in <a href="../../OpenID.html">OpenID</a> 1.
</p>
<p>
If the association type is plain-text, this function will return
&#8216;no-encryption&#8217;
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000048_source')" id="l_M000048_source">show</a>
                        
                    </p>
                    <div id="M000048_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/associationmanager.rb, line 246</span>
246:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_openid1_session_type</span>(<span class="ruby-identifier">assoc_response</span>)
247:         <span class="ruby-comment cmt"># If it's an OpenID 1 message, allow session_type to default</span>
248:         <span class="ruby-comment cmt"># to nil (which signifies &quot;no-encryption&quot;)</span>
249:         <span class="ruby-identifier">session_type</span> = <span class="ruby-identifier">assoc_response</span>.<span class="ruby-identifier">get_arg</span>(<span class="ruby-constant">OPENID_NS</span>, <span class="ruby-value str">'session_type'</span>)
250: 
251:         <span class="ruby-comment cmt"># Handle the differences between no-encryption association</span>
252:         <span class="ruby-comment cmt"># respones in OpenID 1 and 2:</span>
253: 
254:         <span class="ruby-comment cmt"># no-encryption is not really a valid session type for</span>
255:         <span class="ruby-comment cmt"># OpenID 1, but we'll accept it anyway, while issuing a</span>
256:         <span class="ruby-comment cmt"># warning.</span>
257:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session_type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'no-encryption'</span>
258:           <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;WARNING: #{@server_url} sent 'no-encryption'&quot;</span>\
259:                    <span class="ruby-value str">&quot;for OpenID 1.X&quot;</span>)
260: 
261:         <span class="ruby-comment cmt"># Missing or empty session type is the way to flag a</span>
262:         <span class="ruby-comment cmt"># 'no-encryption' response. Change the session type to</span>
263:         <span class="ruby-comment cmt"># 'no-encryption' so that it can be handled in the same</span>
264:         <span class="ruby-comment cmt"># way as OpenID 2 'no-encryption' respones.</span>
265:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session_type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">''</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">session_type</span>.<span class="ruby-identifier">nil?</span>
266:           <span class="ruby-identifier">session_type</span> = <span class="ruby-value str">'no-encryption'</span>
267:         <span class="ruby-keyword kw">end</span>
268: 
269:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">session_type</span>
270:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000045">
                    
                    <a name="M000045"></a><b>request_association</b>(assoc_type, session_type)
                    
                </div>
                
                <div class="description">
                  <p>
Make and process one association request to this endpoint&#8217;s OP
endpoint URL. Returns an association object or nil if the association
processing failed. Raises <a href="../ServerError.html">ServerError</a>
when the remote <a href="../../OpenID.html">OpenID</a> server returns an
error.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000045_source')" id="l_M000045_source">show</a>
                        
                    </p>
                    <div id="M000045_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/associationmanager.rb, line 191</span>
191:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">request_association</span>(<span class="ruby-identifier">assoc_type</span>, <span class="ruby-identifier">session_type</span>)
192:         <span class="ruby-identifier">assoc_session</span>, <span class="ruby-identifier">args</span> = <span class="ruby-identifier">create_associate_request</span>(<span class="ruby-identifier">assoc_type</span>, <span class="ruby-identifier">session_type</span>)
193: 
194:         <span class="ruby-keyword kw">begin</span>
195:           <span class="ruby-identifier">response</span> = <span class="ruby-constant">OpenID</span>.<span class="ruby-identifier">make_kv_post</span>(<span class="ruby-identifier">args</span>, <span class="ruby-ivar">@server_url</span>)
196:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">extract_association</span>(<span class="ruby-identifier">response</span>, <span class="ruby-identifier">assoc_session</span>)
197:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">HTTPStatusError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">why</span>
198:           <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Got HTTP status error when requesting association: #{why}&quot;</span>)
199:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
200:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Message</span><span class="ruby-operator">::</span><span class="ruby-constant">KeyNotFound</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">why</span>
201:           <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-value str">&quot;Missing required parameter in response from &quot;</span>\
202:                    <span class="ruby-node">&quot;#{@server_url}: #{why}&quot;</span>)
203:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
204: 
205:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">ProtocolError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">why</span>
206:           <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Protocol error processing response from #{@server_url}: &quot;</span>\
207:                    <span class="ruby-node">&quot;#{why}&quot;</span>)
208:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
209:         <span class="ruby-keyword kw">end</span>
210:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    