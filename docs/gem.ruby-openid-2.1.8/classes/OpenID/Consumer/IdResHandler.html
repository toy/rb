<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>OpenID::Consumer::IdResHandler</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../../css/main.css" type="text/css" media="screen" />
    <script src="../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            OpenID::Consumer::IdResHandler 
            
                <span class="parent">&lt; 
                    
                    Object
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../files/lib/openid/consumer/idres_rb.html">lib/openid/consumer/idres.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
Handles an openid.mode=<a href="IdResHandler.html#M000115">id_res</a>
response. This object is instantiated and used by the <a
href="../Consumer.html">Consumer</a>.
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M000137">check_auth</a>,</li>
                
                <li><a href="#M000121">check_for_fields</a>,</li>
                
                <li><a href="#M000140">check_nonce</a>,</li>
                
                <li><a href="#M000136">check_signature</a>,</li>
                
                <li><a href="#M000138">create_check_auth_request</a></li>
                
            </ul>
        </dd>
    
        <dt>D</dt>
        <dd>
            <ul>
                
                <li><a href="#M000144">discover_and_verify</a></li>
                
            </ul>
        </dd>
    
        <dt>F</dt>
        <dd>
            <ul>
                
                <li><a href="#M000118">fetch</a></li>
                
            </ul>
        </dd>
    
        <dt>I</dt>
        <dd>
            <ul>
                
                <li><a href="#M000115">id_res</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M000113">new</a></li>
                
            </ul>
        </dd>
    
        <dt>O</dt>
        <dd>
            <ul>
                
                <li><a href="#M000117">openid_namespace</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M000139">process_check_auth_response</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M000116">server_url</a>,</li>
                
                <li><a href="#M000114">signed_fields</a>,</li>
                
                <li><a href="#M000119">signed_list</a></li>
                
            </ul>
        </dd>
    
        <dt>V</dt>
        <dd>
            <ul>
                
                <li><a href="#M000146">verify_discovered_services</a>,</li>
                
                <li><a href="#M000141">verify_discovery_results</a>,</li>
                
                <li><a href="#M000143">verify_discovery_results_openid1</a>,</li>
                
                <li><a href="#M000142">verify_discovery_results_openid2</a>,</li>
                
                <li><a href="#M000148">verify_discovery_single</a>,</li>
                
                <li><a href="#M000125">verify_return_to</a>,</li>
                
                <li><a href="#M000129">verify_return_to_args</a>,</li>
                
                <li><a href="#M000135">verify_return_to_base</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    

    

    
    <div class="sectiontitle">Attributes</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>endpoint</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>message</td>
            <td class='attr-desc'></td>
        </tr>
        
    </table>
    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M000113">
                    
                    <a name="M000113"></a><b>new</b>(message, current_url, store=nil, endpoint=nil)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000113_source')" id="l_M000113_source">show</a>
                        
                    </p>
                    <div id="M000113_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 51</span>
51:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">message</span>, <span class="ruby-identifier">current_url</span>, <span class="ruby-identifier">store</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">endpoint</span>=<span class="ruby-keyword kw">nil</span>)
52:         <span class="ruby-ivar">@store</span> = <span class="ruby-identifier">store</span> <span class="ruby-comment cmt"># Fer the nonce and invalidate_handle</span>
53:         <span class="ruby-ivar">@message</span> = <span class="ruby-identifier">message</span>
54:         <span class="ruby-ivar">@endpoint</span> = <span class="ruby-identifier">endpoint</span>
55:         <span class="ruby-ivar">@current_url</span> = <span class="ruby-identifier">current_url</span>
56:         <span class="ruby-ivar">@signed_list</span> = <span class="ruby-keyword kw">nil</span>
57: 
58:         <span class="ruby-comment cmt"># Start the verification process</span>
59:         <span class="ruby-identifier">id_res</span>
60:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000114">
                    
                    <a name="M000114"></a><b>signed_fields</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000114_source')" id="l_M000114_source">show</a>
                        
                    </p>
                    <div id="M000114_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 62</span>
62:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">signed_fields</span>
63:         <span class="ruby-identifier">signed_list</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span> <span class="ruby-value str">'openid.'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">x</span>}
64:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Protected methods</div>
            
            <div class="method">
                <div class="title" id="M000137">
                    
                    <a name="M000137"></a><b>check_auth</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000137_source')" id="l_M000137_source">show</a>
                        
                    </p>
                    <div id="M000137_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 228</span>
228:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">check_auth</span>
229:         <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Using 'check_authentication' with #{server_url}&quot;</span>)
230:         <span class="ruby-keyword kw">begin</span>
231:           <span class="ruby-identifier">request</span> = <span class="ruby-identifier">create_check_auth_request</span>
232:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Message</span><span class="ruby-operator">::</span><span class="ruby-constant">KeyNotFound</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">why</span>
233:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, <span class="ruby-value str">&quot;Could not generate 'check_authentication' &quot;</span>\
234:                                <span class="ruby-node">&quot;request: #{why.message}&quot;</span>
235:         <span class="ruby-keyword kw">end</span>
236: 
237:         <span class="ruby-identifier">response</span> = <span class="ruby-constant">OpenID</span>.<span class="ruby-identifier">make_kv_post</span>(<span class="ruby-identifier">request</span>, <span class="ruby-identifier">server_url</span>)
238: 
239:         <span class="ruby-identifier">process_check_auth_response</span>(<span class="ruby-identifier">response</span>)
240:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000121">
                    
                    <a name="M000121"></a><b>check_for_fields</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000121_source')" id="l_M000121_source">show</a>
                        
                    </p>
                    <div id="M000121_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 104</span>
104:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">check_for_fields</span>
105:         <span class="ruby-comment cmt"># XXX: if a field is missing, we should not have to explicitly</span>
106:         <span class="ruby-comment cmt"># check that it's present, just make sure that the fields are</span>
107:         <span class="ruby-comment cmt"># actually being used by the rest of the code in</span>
108:         <span class="ruby-comment cmt"># tests. Although, which fields are signed does need to be</span>
109:         <span class="ruby-comment cmt"># checked somewhere.</span>
110:         <span class="ruby-identifier">basic_fields</span> = [<span class="ruby-value str">'return_to'</span>, <span class="ruby-value str">'assoc_handle'</span>, <span class="ruby-value str">'sig'</span>, <span class="ruby-value str">'signed'</span>]
111:         <span class="ruby-identifier">basic_sig_fields</span> = [<span class="ruby-value str">'return_to'</span>, <span class="ruby-value str">'identity'</span>]
112: 
113:         <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">openid_namespace</span>
114:         <span class="ruby-keyword kw">when</span> <span class="ruby-constant">OPENID2_NS</span>
115:           <span class="ruby-identifier">require_fields</span> = <span class="ruby-identifier">basic_fields</span> <span class="ruby-operator">+</span> [<span class="ruby-value str">'op_endpoint'</span>]
116:           <span class="ruby-identifier">require_sigs</span> = <span class="ruby-identifier">basic_sig_fields</span> <span class="ruby-operator">+</span>
117:             [<span class="ruby-value str">'response_nonce'</span>, <span class="ruby-value str">'claimed_id'</span>, <span class="ruby-value str">'assoc_handle'</span>, <span class="ruby-value str">'op_endpoint'</span>]
118:         <span class="ruby-keyword kw">when</span> <span class="ruby-constant">OPENID1_NS</span>, <span class="ruby-constant">OPENID11_NS</span>
119:           <span class="ruby-identifier">require_fields</span> = <span class="ruby-identifier">basic_fields</span> <span class="ruby-operator">+</span> [<span class="ruby-value str">'identity'</span>]
120:           <span class="ruby-identifier">require_sigs</span> = <span class="ruby-identifier">basic_sig_fields</span>
121:         <span class="ruby-keyword kw">else</span>
122:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">RuntimeError</span>, <span class="ruby-value str">&quot;check_for_fields doesn't know about &quot;</span>\
123:                               <span class="ruby-node">&quot;namespace #{openid_namespace.inspect}&quot;</span>
124:         <span class="ruby-keyword kw">end</span>
125: 
126:         <span class="ruby-identifier">require_fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">field</span><span class="ruby-operator">|</span>
127:           <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@message</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-constant">OPENID_NS</span>, <span class="ruby-identifier">field</span>)
128:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, <span class="ruby-node">&quot;Missing required field #{field}&quot;</span>
129:           <span class="ruby-keyword kw">end</span>
130:         <span class="ruby-keyword kw">end</span>
131: 
132:         <span class="ruby-identifier">require_sigs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">field</span><span class="ruby-operator">|</span>
133:           <span class="ruby-comment cmt"># Field is present and not in signed list</span>
134:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@message</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-constant">OPENID_NS</span>, <span class="ruby-identifier">field</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">signed_list</span>.<span class="ruby-identifier">member?</span>(<span class="ruby-identifier">field</span>)
135:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, <span class="ruby-node">&quot;#{field.inspect} not signed&quot;</span>
136:           <span class="ruby-keyword kw">end</span>
137:         <span class="ruby-keyword kw">end</span>
138:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000140">
                    
                    <a name="M000140"></a><b>check_nonce</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000140_source')" id="l_M000140_source">show</a>
                        
                    </p>
                    <div id="M000140_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 277</span>
277:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">check_nonce</span>
278:         <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">openid_namespace</span>
279:         <span class="ruby-keyword kw">when</span> <span class="ruby-constant">OPENID1_NS</span>, <span class="ruby-constant">OPENID11_NS</span>
280:           <span class="ruby-identifier">nonce</span> =
281:             <span class="ruby-ivar">@message</span>.<span class="ruby-identifier">get_arg</span>(<span class="ruby-constant">BARE_NS</span>, <span class="ruby-constant">Consumer</span>.<span class="ruby-identifier">openid1_return_to_nonce_name</span>)
282: 
283:           <span class="ruby-comment cmt"># We generated the nonce, so it uses the empty string as the</span>
284:           <span class="ruby-comment cmt"># server URL</span>
285:           <span class="ruby-identifier">server_url</span> = <span class="ruby-value str">''</span>
286:         <span class="ruby-keyword kw">when</span> <span class="ruby-constant">OPENID2_NS</span>
287:           <span class="ruby-identifier">nonce</span> = <span class="ruby-ivar">@message</span>.<span class="ruby-identifier">get_arg</span>(<span class="ruby-constant">OPENID2_NS</span>, <span class="ruby-value str">'response_nonce'</span>)
288:           <span class="ruby-identifier">server_url</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">server_url</span>
289:         <span class="ruby-keyword kw">else</span>
290:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">StandardError</span>, <span class="ruby-value str">'Not reached'</span>
291:         <span class="ruby-keyword kw">end</span>
292: 
293:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">nonce</span>.<span class="ruby-identifier">nil?</span>
294:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, <span class="ruby-value str">'Nonce missing from response'</span>
295:         <span class="ruby-keyword kw">end</span>
296: 
297:         <span class="ruby-keyword kw">begin</span>
298:           <span class="ruby-identifier">time</span>, <span class="ruby-identifier">extra</span> = <span class="ruby-constant">Nonce</span>.<span class="ruby-identifier">split_nonce</span>(<span class="ruby-identifier">nonce</span>)
299:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">ArgumentError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">why</span>
300:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, <span class="ruby-node">&quot;Malformed nonce: #{nonce.inspect}&quot;</span>
301:         <span class="ruby-keyword kw">end</span>
302: 
303:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@store</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@store</span>.<span class="ruby-identifier">use_nonce</span>(<span class="ruby-identifier">server_url</span>, <span class="ruby-identifier">time</span>, <span class="ruby-identifier">extra</span>)
304:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, (<span class="ruby-value str">&quot;Nonce already used or out of range: &quot;</span>\
305:                                <span class="ruby-node">&quot;#{nonce.inspect}&quot;</span>)
306:         <span class="ruby-keyword kw">end</span>
307:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000136">
                    
                    <a name="M000136"></a><b>check_signature</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Raises <a href="../ProtocolError.html">ProtocolError</a> if the signature
is bad
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000136_source')" id="l_M000136_source">show</a>
                        
                    </p>
                    <div id="M000136_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 205</span>
205:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">check_signature</span>
206:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">nil?</span>
207:           <span class="ruby-identifier">assoc</span> = <span class="ruby-keyword kw">nil</span>
208:         <span class="ruby-keyword kw">else</span>
209:           <span class="ruby-identifier">assoc</span> = <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">get_association</span>(<span class="ruby-identifier">server_url</span>, <span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'assoc_handle'</span>))
210:         <span class="ruby-keyword kw">end</span>
211: 
212:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">assoc</span>.<span class="ruby-identifier">nil?</span>
213:           <span class="ruby-identifier">check_auth</span>
214:         <span class="ruby-keyword kw">else</span>
215:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">assoc</span>.<span class="ruby-identifier">expires_in</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">0</span>
216:             <span class="ruby-comment cmt"># XXX: It might be a good idea sometimes to re-start the</span>
217:             <span class="ruby-comment cmt"># authentication with a new association. Doing it</span>
218:             <span class="ruby-comment cmt"># automatically opens the possibility for</span>
219:             <span class="ruby-comment cmt"># denial-of-service by a server that just returns expired</span>
220:             <span class="ruby-comment cmt"># associations (or really short-lived associations)</span>
221:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, <span class="ruby-node">&quot;Association with #{server_url} expired&quot;</span>
222:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">assoc</span>.<span class="ruby-identifier">check_message_signature</span>(<span class="ruby-ivar">@message</span>)
223:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, <span class="ruby-node">&quot;Bad signature in response from #{server_url}&quot;</span>
224:           <span class="ruby-keyword kw">end</span>
225:         <span class="ruby-keyword kw">end</span>
226:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000138">
                    
                    <a name="M000138"></a><b>create_check_auth_request</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000138_source')" id="l_M000138_source">show</a>
                        
                    </p>
                    <div id="M000138_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 242</span>
242:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_check_auth_request</span>
243:         <span class="ruby-identifier">signed_list</span> = <span class="ruby-ivar">@message</span>.<span class="ruby-identifier">get_arg</span>(<span class="ruby-constant">OPENID_NS</span>, <span class="ruby-value str">'signed'</span>, <span class="ruby-constant">NO_DEFAULT</span>).<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>)
244: 
245:         <span class="ruby-comment cmt"># check that we got all the signed arguments</span>
246:         <span class="ruby-identifier">signed_list</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span>
247:           <span class="ruby-ivar">@message</span>.<span class="ruby-identifier">get_aliased_arg</span>(<span class="ruby-identifier">k</span>, <span class="ruby-constant">NO_DEFAULT</span>)
248:         }
249: 
250:         <span class="ruby-identifier">ca_message</span> = <span class="ruby-ivar">@message</span>.<span class="ruby-identifier">copy</span>
251:         <span class="ruby-identifier">ca_message</span>.<span class="ruby-identifier">set_arg</span>(<span class="ruby-constant">OPENID_NS</span>, <span class="ruby-value str">'mode'</span>, <span class="ruby-value str">'check_authentication'</span>)
252: 
253:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">ca_message</span>
254:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000144">
                    
                    <a name="M000144"></a><b>discover_and_verify</b>(claimed_id, to_match_endpoints)
                    
                </div>
                
                <div class="description">
                  <p>
Given an endpoint object created from the information in an <a
href="../../OpenID.html">OpenID</a> response, perform discovery and verify
the discovery results, returning the matching endpoint that is the result
of doing that discovery.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000144_source')" id="l_M000144_source">show</a>
                        
                    </p>
                    <div id="M000144_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 418</span>
418:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">discover_and_verify</span>(<span class="ruby-identifier">claimed_id</span>, <span class="ruby-identifier">to_match_endpoints</span>)
419:         <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Performing discovery on #{claimed_id}&quot;</span>)
420:         <span class="ruby-identifier">_</span>, <span class="ruby-identifier">services</span> = <span class="ruby-constant">OpenID</span>.<span class="ruby-identifier">discover</span>(<span class="ruby-identifier">claimed_id</span>)
421:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">services</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
422:           <span class="ruby-comment cmt"># XXX: this might want to be something other than</span>
423:           <span class="ruby-comment cmt"># ProtocolError. In Python, it's DiscoveryFailure</span>
424:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, (<span class="ruby-value str">&quot;No OpenID information found at &quot;</span>\
425:                                 <span class="ruby-node">&quot;#{claimed_id}&quot;</span>)
426:         <span class="ruby-keyword kw">end</span>
427:         <span class="ruby-identifier">verify_discovered_services</span>(<span class="ruby-identifier">claimed_id</span>, <span class="ruby-identifier">services</span>, <span class="ruby-identifier">to_match_endpoints</span>)
428:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000118">
                    
                    <a name="M000118"></a><b>fetch</b>(field, default=NO_DEFAULT)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000118_source')" id="l_M000118_source">show</a>
                        
                    </p>
                    <div id="M000118_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 88</span>
88:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">fetch</span>(<span class="ruby-identifier">field</span>, <span class="ruby-identifier">default</span>=<span class="ruby-constant">NO_DEFAULT</span>)
89:         <span class="ruby-ivar">@message</span>.<span class="ruby-identifier">get_arg</span>(<span class="ruby-constant">OPENID_NS</span>, <span class="ruby-identifier">field</span>, <span class="ruby-identifier">default</span>)
90:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000115">
                    
                    <a name="M000115"></a><b>id_res</b>()
                    
                </div>
                
                <div class="description">
                  <p>
This method will raise <a href="../ProtocolError.html">ProtocolError</a>
unless the request is a valid <a
href="IdResHandler.html#M000115">id_res</a> response. Once it has been
verified, the methods &#8216;endpoint&#8217;, &#8216;message&#8217;, and
&#8216;<a href="IdResHandler.html#M000114">signed_fields</a>&#8217; contain
the verified information.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000115_source')" id="l_M000115_source">show</a>
                        
                    </p>
                    <div id="M000115_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 72</span>
72:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">id_res</span>
73:         <span class="ruby-identifier">check_for_fields</span>
74:         <span class="ruby-identifier">verify_return_to</span>
75:         <span class="ruby-identifier">verify_discovery_results</span>
76:         <span class="ruby-identifier">check_signature</span>
77:         <span class="ruby-identifier">check_nonce</span>
78:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000117">
                    
                    <a name="M000117"></a><b>openid_namespace</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000117_source')" id="l_M000117_source">show</a>
                        
                    </p>
                    <div id="M000117_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 84</span>
84:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">openid_namespace</span>
85:         <span class="ruby-ivar">@message</span>.<span class="ruby-identifier">get_openid_namespace</span>
86:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000139">
                    
                    <a name="M000139"></a><b>process_check_auth_response</b>(response)
                    
                </div>
                
                <div class="description">
                  <p>
Process the response message from a check_authentication request,
invalidating associations if requested.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000139_source')" id="l_M000139_source">show</a>
                        
                    </p>
                    <div id="M000139_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 258</span>
258:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">process_check_auth_response</span>(<span class="ruby-identifier">response</span>)
259:         <span class="ruby-identifier">is_valid</span> = <span class="ruby-identifier">response</span>.<span class="ruby-identifier">get_arg</span>(<span class="ruby-constant">OPENID_NS</span>, <span class="ruby-value str">'is_valid'</span>, <span class="ruby-value str">'false'</span>)
260: 
261:         <span class="ruby-identifier">invalidate_handle</span> = <span class="ruby-identifier">response</span>.<span class="ruby-identifier">get_arg</span>(<span class="ruby-constant">OPENID_NS</span>, <span class="ruby-value str">'invalidate_handle'</span>)
262:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">invalidate_handle</span>.<span class="ruby-identifier">nil?</span>
263:           <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Received 'invalidate_handle' from server #{server_url}&quot;</span>)
264:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">nil?</span>
265:             <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-value str">'Unexpectedly got &quot;invalidate_handle&quot; without a store!'</span>)
266:           <span class="ruby-keyword kw">else</span>
267:             <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">remove_association</span>(<span class="ruby-identifier">server_url</span>, <span class="ruby-identifier">invalidate_handle</span>)
268:           <span class="ruby-keyword kw">end</span>
269:         <span class="ruby-keyword kw">end</span>
270: 
271:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">is_valid</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">'true'</span>
272:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, (<span class="ruby-node">&quot;Server #{server_url} responds that the &quot;</span>\
273:                                 <span class="ruby-value str">&quot;'check_authentication' call is not valid&quot;</span>)
274:         <span class="ruby-keyword kw">end</span>
275:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000116">
                    
                    <a name="M000116"></a><b>server_url</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000116_source')" id="l_M000116_source">show</a>
                        
                    </p>
                    <div id="M000116_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 80</span>
80:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">server_url</span>
81:         <span class="ruby-ivar">@endpoint</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@endpoint</span>.<span class="ruby-identifier">server_url</span>
82:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000119">
                    
                    <a name="M000119"></a><b>signed_list</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000119_source')" id="l_M000119_source">show</a>
                        
                    </p>
                    <div id="M000119_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 92</span>
 92:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">signed_list</span>
 93:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@signed_list</span>.<span class="ruby-identifier">nil?</span>
 94:           <span class="ruby-identifier">signed_list_str</span> = <span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'signed'</span>, <span class="ruby-keyword kw">nil</span>)
 95:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">signed_list_str</span>.<span class="ruby-identifier">nil?</span>
 96:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, <span class="ruby-value str">'Response missing signed list'</span>
 97:           <span class="ruby-keyword kw">end</span>
 98: 
 99:           <span class="ruby-ivar">@signed_list</span> = <span class="ruby-identifier">signed_list_str</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>, <span class="ruby-value">-1</span>)
100:         <span class="ruby-keyword kw">end</span>
101:         <span class="ruby-ivar">@signed_list</span>
102:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000146">
                    
                    <a name="M000146"></a><b>verify_discovered_services</b>(claimed_id, services, to_match_endpoints)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000146_source')" id="l_M000146_source">show</a>
                        
                    </p>
                    <div id="M000146_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 431</span>
431:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">verify_discovered_services</span>(<span class="ruby-identifier">claimed_id</span>, <span class="ruby-identifier">services</span>, <span class="ruby-identifier">to_match_endpoints</span>)
432:         <span class="ruby-comment cmt"># Search the services resulting from discovery to find one</span>
433:         <span class="ruby-comment cmt"># that matches the information from the assertion</span>
434:         <span class="ruby-identifier">failure_messages</span> = []
435:         <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">endpoint</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">services</span>
436:           <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">to_match_endpoint</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">to_match_endpoints</span>
437:             <span class="ruby-keyword kw">begin</span>
438:               <span class="ruby-identifier">verify_discovery_single</span>(<span class="ruby-identifier">endpoint</span>, <span class="ruby-identifier">to_match_endpoint</span>)
439:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">ProtocolError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">why</span>
440:               <span class="ruby-identifier">failure_messages</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">why</span>.<span class="ruby-identifier">message</span>
441:             <span class="ruby-keyword kw">else</span>
442:               <span class="ruby-comment cmt"># It matches, so discover verification has</span>
443:               <span class="ruby-comment cmt"># succeeded. Return this endpoint.</span>
444:               <span class="ruby-ivar">@endpoint</span> = <span class="ruby-identifier">endpoint</span>
445:               <span class="ruby-keyword kw">return</span>
446:             <span class="ruby-keyword kw">end</span>
447:           <span class="ruby-keyword kw">end</span>
448:         <span class="ruby-keyword kw">end</span>
449: 
450:         <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Discovery verification failure for #{claimed_id}&quot;</span>)
451:         <span class="ruby-identifier">failure_messages</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">failure_message</span><span class="ruby-operator">|</span>
452:           <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-value str">&quot; * Endpoint mismatch: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">failure_message</span>)
453:         <span class="ruby-keyword kw">end</span>
454: 
455:         <span class="ruby-comment cmt"># XXX: is DiscoveryFailure in Python OpenID</span>
456:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, (<span class="ruby-value str">&quot;No matching endpoint found after &quot;</span>\
457:                               <span class="ruby-node">&quot;discovering #{claimed_id}&quot;</span>)
458:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000141">
                    
                    <a name="M000141"></a><b>verify_discovery_results</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000141_source')" id="l_M000141_source">show</a>
                        
                    </p>
                    <div id="M000141_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 309</span>
309:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">verify_discovery_results</span>
310:         <span class="ruby-keyword kw">begin</span>
311:           <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">openid_namespace</span>
312:           <span class="ruby-keyword kw">when</span> <span class="ruby-constant">OPENID1_NS</span>, <span class="ruby-constant">OPENID11_NS</span>
313:             <span class="ruby-identifier">verify_discovery_results_openid1</span>
314:           <span class="ruby-keyword kw">when</span> <span class="ruby-constant">OPENID2_NS</span>
315:             <span class="ruby-identifier">verify_discovery_results_openid2</span>
316:           <span class="ruby-keyword kw">else</span>
317:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">StandardError</span>, <span class="ruby-node">&quot;Not reached: #{openid_namespace}&quot;</span>
318:           <span class="ruby-keyword kw">end</span>
319:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Message</span><span class="ruby-operator">::</span><span class="ruby-constant">KeyNotFound</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">why</span>
320:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, <span class="ruby-node">&quot;Missing required field: #{why.message}&quot;</span>
321:         <span class="ruby-keyword kw">end</span>
322:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000143">
                    
                    <a name="M000143"></a><b>verify_discovery_results_openid1</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000143_source')" id="l_M000143_source">show</a>
                        
                    </p>
                    <div id="M000143_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 367</span>
367:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">verify_discovery_results_openid1</span>
368:         <span class="ruby-identifier">claimed_id</span> =
369:           <span class="ruby-ivar">@message</span>.<span class="ruby-identifier">get_arg</span>(<span class="ruby-constant">BARE_NS</span>, <span class="ruby-constant">Consumer</span>.<span class="ruby-identifier">openid1_return_to_claimed_id_name</span>)
370: 
371:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">claimed_id</span>.<span class="ruby-identifier">nil?</span>
372:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@endpoint</span>.<span class="ruby-identifier">nil?</span>
373:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, (<span class="ruby-value str">&quot;When using OpenID 1, the claimed ID must &quot;</span>\
374:                                   <span class="ruby-value str">&quot;be supplied, either by passing it through &quot;</span>\
375:                                   <span class="ruby-value str">&quot;as a return_to parameter or by using a &quot;</span>\
376:                                   <span class="ruby-value str">&quot;session, and supplied to the IdResHandler &quot;</span>\
377:                                   <span class="ruby-value str">&quot;when it is constructed.&quot;</span>)
378:           <span class="ruby-keyword kw">else</span>
379:             <span class="ruby-identifier">claimed_id</span> = <span class="ruby-ivar">@endpoint</span>.<span class="ruby-identifier">claimed_id</span>
380:           <span class="ruby-keyword kw">end</span>
381:         <span class="ruby-keyword kw">end</span>
382: 
383:         <span class="ruby-identifier">to_match</span> = <span class="ruby-constant">OpenIDServiceEndpoint</span>.<span class="ruby-identifier">new</span>
384:         <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">type_uris</span> = [<span class="ruby-constant">OPENID_1_1_TYPE</span>]
385:         <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">local_id</span> = <span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'identity'</span>)
386:         <span class="ruby-comment cmt"># Restore delegate information from the initiation phase</span>
387:         <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">claimed_id</span> = <span class="ruby-identifier">claimed_id</span>
388: 
389:         <span class="ruby-identifier">to_match_1_0</span> = <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">dup</span>
390:         <span class="ruby-identifier">to_match_1_0</span>.<span class="ruby-identifier">type_uris</span> = [<span class="ruby-constant">OPENID_1_0_TYPE</span>]
391: 
392:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@endpoint</span>.<span class="ruby-identifier">nil?</span>
393:           <span class="ruby-keyword kw">begin</span>
394:             <span class="ruby-keyword kw">begin</span>
395:               <span class="ruby-identifier">verify_discovery_single</span>(<span class="ruby-ivar">@endpoint</span>, <span class="ruby-identifier">to_match</span>)
396:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">TypeURIMismatch</span>
397:               <span class="ruby-identifier">verify_discovery_single</span>(<span class="ruby-ivar">@endpoint</span>, <span class="ruby-identifier">to_match_1_0</span>)
398:             <span class="ruby-keyword kw">end</span>
399:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">ProtocolError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">why</span>
400:             <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-value str">'Error attempting to use stored discovery information: '</span> <span class="ruby-operator">+</span>
401:                      <span class="ruby-identifier">why</span>.<span class="ruby-identifier">message</span>)
402:             <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-value str">'Attempting discovery to verify endpoint'</span>)
403:           <span class="ruby-keyword kw">else</span>
404:             <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@endpoint</span>
405:           <span class="ruby-keyword kw">end</span>
406:         <span class="ruby-keyword kw">end</span>
407: 
408:         <span class="ruby-comment cmt"># Either no endpoint was supplied or OpenID 1.x verification</span>
409:         <span class="ruby-comment cmt"># of the information that's in the message failed on that</span>
410:         <span class="ruby-comment cmt"># endpoint.</span>
411:         <span class="ruby-identifier">discover_and_verify</span>(<span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">claimed_id</span>, [<span class="ruby-identifier">to_match</span>, <span class="ruby-identifier">to_match_1_0</span>])
412:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000142">
                    
                    <a name="M000142"></a><b>verify_discovery_results_openid2</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000142_source')" id="l_M000142_source">show</a>
                        
                    </p>
                    <div id="M000142_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 324</span>
324:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">verify_discovery_results_openid2</span>
325:         <span class="ruby-identifier">to_match</span> = <span class="ruby-constant">OpenIDServiceEndpoint</span>.<span class="ruby-identifier">new</span>
326:         <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">type_uris</span> = [<span class="ruby-constant">OPENID_2_0_TYPE</span>]
327:         <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">claimed_id</span> = <span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'claimed_id'</span>, <span class="ruby-keyword kw">nil</span>)
328:         <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">local_id</span> = <span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'identity'</span>, <span class="ruby-keyword kw">nil</span>)
329:         <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">server_url</span> = <span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'op_endpoint'</span>)
330: 
331:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">claimed_id</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">local_id</span>.<span class="ruby-identifier">nil?</span>
332:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, (<span class="ruby-value str">'openid.identity is present without '</span>\
333:                                 <span class="ruby-value str">'openid.claimed_id'</span>)
334:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">claimed_id</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">local_id</span>.<span class="ruby-identifier">nil?</span>
335:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, (<span class="ruby-value str">'openid.claimed_id is present without '</span>\
336:                                 <span class="ruby-value str">'openid.identity'</span>)
337: 
338:         <span class="ruby-comment cmt"># This is a response without identifiers, so there's really no</span>
339:         <span class="ruby-comment cmt"># checking that we can do, so return an endpoint that's for</span>
340:         <span class="ruby-comment cmt"># the specified `openid.op_endpoint'</span>
341:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">claimed_id</span>.<span class="ruby-identifier">nil?</span>
342:           <span class="ruby-ivar">@endpoint</span> =
343:             <span class="ruby-constant">OpenIDServiceEndpoint</span>.<span class="ruby-identifier">from_op_endpoint_url</span>(<span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">server_url</span>)
344:           <span class="ruby-keyword kw">return</span>
345:         <span class="ruby-keyword kw">end</span>
346: 
347:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@endpoint</span>.<span class="ruby-identifier">nil?</span>
348:           <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-value str">'No pre-discovered information supplied'</span>)
349:           <span class="ruby-identifier">discover_and_verify</span>(<span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">claimed_id</span>, [<span class="ruby-identifier">to_match</span>])
350:         <span class="ruby-keyword kw">else</span>
351:           <span class="ruby-keyword kw">begin</span>
352:             <span class="ruby-identifier">verify_discovery_single</span>(<span class="ruby-ivar">@endpoint</span>, <span class="ruby-identifier">to_match</span>)
353:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">ProtocolError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">why</span>
354:             <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-value str">&quot;Error attempting to use stored discovery &quot;</span>\
355:                      <span class="ruby-node">&quot;information: #{why.message}&quot;</span>)
356:             <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-value str">&quot;Attempting discovery to verify endpoint&quot;</span>)
357:             <span class="ruby-identifier">discover_and_verify</span>(<span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">claimed_id</span>, [<span class="ruby-identifier">to_match</span>])
358:           <span class="ruby-keyword kw">end</span>
359:         <span class="ruby-keyword kw">end</span>
360: 
361:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@endpoint</span>.<span class="ruby-identifier">claimed_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">claimed_id</span>
362:           <span class="ruby-ivar">@endpoint</span> = <span class="ruby-ivar">@endpoint</span>.<span class="ruby-identifier">dup</span>
363:           <span class="ruby-ivar">@endpoint</span>.<span class="ruby-identifier">claimed_id</span> = <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">claimed_id</span>
364:         <span class="ruby-keyword kw">end</span>
365:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000148">
                    
                    <a name="M000148"></a><b>verify_discovery_single</b>(endpoint, to_match)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000148_source')" id="l_M000148_source">show</a>
                        
                    </p>
                    <div id="M000148_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 460</span>
460:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">verify_discovery_single</span>(<span class="ruby-identifier">endpoint</span>, <span class="ruby-identifier">to_match</span>)
461:         <span class="ruby-comment cmt"># Every type URI that's in the to_match endpoint has to be</span>
462:         <span class="ruby-comment cmt"># present in the discovered endpoint.</span>
463:         <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">type_uri</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">type_uris</span>
464:           <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">endpoint</span>.<span class="ruby-identifier">uses_extension</span>(<span class="ruby-identifier">type_uri</span>)
465:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">TypeURIMismatch</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">type_uri</span>, <span class="ruby-identifier">endpoint</span>)
466:           <span class="ruby-keyword kw">end</span>
467:         <span class="ruby-keyword kw">end</span>
468: 
469:         <span class="ruby-comment cmt"># Fragments do not influence discovery, so we can't compare a</span>
470:         <span class="ruby-comment cmt"># claimed identifier with a fragment to discovered information.</span>
471:         <span class="ruby-identifier">defragged_claimed_id</span> =
472:           <span class="ruby-keyword kw">case</span> <span class="ruby-constant">Yadis</span><span class="ruby-operator">::</span><span class="ruby-constant">XRI</span>.<span class="ruby-identifier">identifier_scheme</span>(<span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">claimed_id</span>)
473:           <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:xri</span>
474:             <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">claimed_id</span>
475:           <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:uri</span>
476:             <span class="ruby-keyword kw">begin</span>
477:               <span class="ruby-identifier">parsed</span> = <span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">claimed_id</span>)
478:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">URI</span><span class="ruby-operator">::</span><span class="ruby-constant">InvalidURIError</span>
479:               <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">claimed_id</span>
480:             <span class="ruby-keyword kw">else</span>
481:               <span class="ruby-identifier">parsed</span>.<span class="ruby-identifier">fragment</span> = <span class="ruby-keyword kw">nil</span>
482:               <span class="ruby-identifier">parsed</span>.<span class="ruby-identifier">to_s</span>
483:             <span class="ruby-keyword kw">end</span>
484:           <span class="ruby-keyword kw">else</span>
485:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">StandardError</span>, <span class="ruby-value str">'Not reached'</span>
486:           <span class="ruby-keyword kw">end</span>
487: 
488:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">defragged_claimed_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">endpoint</span>.<span class="ruby-identifier">claimed_id</span>
489:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, (<span class="ruby-value str">&quot;Claimed ID does not match (different &quot;</span>\
490:                                 <span class="ruby-value str">&quot;subjects!), Expected &quot;</span>\
491:                                 <span class="ruby-node">&quot;#{defragged_claimed_id}, got &quot;</span>\
492:                                 <span class="ruby-node">&quot;#{endpoint.claimed_id}&quot;</span>)
493:         <span class="ruby-keyword kw">end</span>
494: 
495:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">get_local_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">endpoint</span>.<span class="ruby-identifier">get_local_id</span>
496:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, (<span class="ruby-value str">&quot;local_id mismatch. Expected &quot;</span>\
497:                                 <span class="ruby-node">&quot;#{to_match.get_local_id}, got &quot;</span>\
498:                                 <span class="ruby-node">&quot;#{endpoint.get_local_id}&quot;</span>)
499:         <span class="ruby-keyword kw">end</span>
500: 
501:         <span class="ruby-comment cmt"># If the server URL is nil, this must be an OpenID 1</span>
502:         <span class="ruby-comment cmt"># response, because op_endpoint is a required parameter in</span>
503:         <span class="ruby-comment cmt"># OpenID 2. In that case, we don't actually care what the</span>
504:         <span class="ruby-comment cmt"># discovered server_url is, because signature checking or</span>
505:         <span class="ruby-comment cmt"># check_auth should take care of that check for us.</span>
506:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">server_url</span>.<span class="ruby-identifier">nil?</span>
507:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">preferred_namespace</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">OPENID1_NS</span>
508:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">StandardError</span>,
509:             <span class="ruby-value str">&quot;The code calling this must ensure that OpenID 2 &quot;</span>\
510:             <span class="ruby-value str">&quot;responses have a non-none `openid.op_endpoint' and &quot;</span>\
511:             <span class="ruby-value str">&quot;that it is set as the `server_url' attribute of the &quot;</span>\
512:             <span class="ruby-value str">&quot;`to_match' endpoint.&quot;</span>
513:           <span class="ruby-keyword kw">end</span>
514:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">to_match</span>.<span class="ruby-identifier">server_url</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">endpoint</span>.<span class="ruby-identifier">server_url</span>
515:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, (<span class="ruby-value str">&quot;OP Endpoint mismatch. Expected&quot;</span>\
516:                                 <span class="ruby-node">&quot;#{to_match.server_url}, got &quot;</span>\
517:                                 <span class="ruby-node">&quot;#{endpoint.server_url}&quot;</span>)
518:         <span class="ruby-keyword kw">end</span>
519:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000125">
                    
                    <a name="M000125"></a><b>verify_return_to</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000125_source')" id="l_M000125_source">show</a>
                        
                    </p>
                    <div id="M000125_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 140</span>
140:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">verify_return_to</span>
141:         <span class="ruby-keyword kw">begin</span>
142:           <span class="ruby-identifier">msg_return_to</span> = <span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-constant">URINorm</span><span class="ruby-operator">::</span><span class="ruby-identifier">urinorm</span>(<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'return_to'</span>)))
143:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">URI</span><span class="ruby-operator">::</span><span class="ruby-constant">InvalidURIError</span>
144:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, (<span class="ruby-value str">&quot;return_to is not a valid URI&quot;</span>)
145:         <span class="ruby-keyword kw">end</span>
146: 
147:         <span class="ruby-identifier">verify_return_to_args</span>(<span class="ruby-identifier">msg_return_to</span>)
148:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@current_url</span>.<span class="ruby-identifier">nil?</span>
149:           <span class="ruby-identifier">verify_return_to_base</span>(<span class="ruby-identifier">msg_return_to</span>)
150:         <span class="ruby-keyword kw">end</span>
151:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000129">
                    
                    <a name="M000129"></a><b>verify_return_to_args</b>(msg_return_to)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000129_source')" id="l_M000129_source">show</a>
                        
                    </p>
                    <div id="M000129_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 153</span>
153:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">verify_return_to_args</span>(<span class="ruby-identifier">msg_return_to</span>)
154:         <span class="ruby-identifier">return_to_parsed_query</span> = {}
155:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">msg_return_to</span>.<span class="ruby-identifier">query</span>.<span class="ruby-identifier">nil?</span>
156:           <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">msg_return_to</span>.<span class="ruby-identifier">query</span>).<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">vs</span><span class="ruby-operator">|</span>
157:             <span class="ruby-identifier">return_to_parsed_query</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">vs</span>[<span class="ruby-value">0</span>]
158:           <span class="ruby-keyword kw">end</span>
159:         <span class="ruby-keyword kw">end</span>
160:         <span class="ruby-identifier">query</span> = <span class="ruby-ivar">@message</span>.<span class="ruby-identifier">to_post_args</span>
161:         <span class="ruby-identifier">return_to_parsed_query</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">rt_key</span>, <span class="ruby-identifier">rt_val</span><span class="ruby-operator">|</span>
162:           <span class="ruby-identifier">msg_val</span> = <span class="ruby-identifier">query</span>[<span class="ruby-identifier">rt_key</span>]
163:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">msg_val</span>.<span class="ruby-identifier">nil?</span>
164:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, <span class="ruby-node">&quot;Message missing return_to argument '#{rt_key}'&quot;</span>
165:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">msg_val</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">rt_val</span>
166:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, (<span class="ruby-node">&quot;Parameter '#{rt_key}' value &quot;</span>\
167:                                   <span class="ruby-node">&quot;#{msg_val.inspect} does not match &quot;</span>\
168:                                   <span class="ruby-node">&quot;return_to's value #{rt_val.inspect}&quot;</span>)
169:           <span class="ruby-keyword kw">end</span>
170:         <span class="ruby-keyword kw">end</span>
171:         <span class="ruby-ivar">@message</span>.<span class="ruby-identifier">get_args</span>(<span class="ruby-constant">BARE_NS</span>).<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">bare_key</span>, <span class="ruby-identifier">bare_val</span><span class="ruby-operator">|</span>
172:           <span class="ruby-identifier">rt_val</span> = <span class="ruby-identifier">return_to_parsed_query</span>[<span class="ruby-identifier">bare_key</span>]
173:           <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">return_to_parsed_query</span>.<span class="ruby-identifier">has_key?</span> <span class="ruby-identifier">bare_key</span>
174:             <span class="ruby-comment cmt"># This may be caused by your web framework throwing extra</span>
175:             <span class="ruby-comment cmt"># entries in to your parameters hash that were not GET or</span>
176:             <span class="ruby-comment cmt"># POST parameters.  For example, Rails has been known to</span>
177:             <span class="ruby-comment cmt"># add &quot;controller&quot; and &quot;action&quot; keys; another server adds</span>
178:             <span class="ruby-comment cmt"># at least a &quot;format&quot; key.</span>
179:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, (<span class="ruby-value str">&quot;Unexpected parameter (not on return_to): &quot;</span>\
180:                                   <span class="ruby-node">&quot;'#{bare_key}'=#{rt_val.inspect})&quot;</span>)
181:           <span class="ruby-keyword kw">end</span>
182:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">rt_val</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">bare_val</span>
183:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, (<span class="ruby-node">&quot;Parameter '#{bare_key}' value &quot;</span>\
184:                                   <span class="ruby-node">&quot;#{bare_val.inspect} does not match &quot;</span>\
185:                                   <span class="ruby-node">&quot;return_to's value #{rt_val.inspect}&quot;</span>)
186:           <span class="ruby-keyword kw">end</span>
187:         <span class="ruby-keyword kw">end</span>
188:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000135">
                    
                    <a name="M000135"></a><b>verify_return_to_base</b>(msg_return_to)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000135_source')" id="l_M000135_source">show</a>
                        
                    </p>
                    <div id="M000135_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/consumer/idres.rb, line 190</span>
190:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">verify_return_to_base</span>(<span class="ruby-identifier">msg_return_to</span>)
191:         <span class="ruby-keyword kw">begin</span>
192:           <span class="ruby-identifier">app_parsed</span> = <span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-constant">URINorm</span><span class="ruby-operator">::</span><span class="ruby-identifier">urinorm</span>(<span class="ruby-ivar">@current_url</span>))
193:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">URI</span><span class="ruby-operator">::</span><span class="ruby-constant">InvalidURIError</span>
194:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, <span class="ruby-node">&quot;current_url is not a valid URI: #{@current_url}&quot;</span>
195:         <span class="ruby-keyword kw">end</span>
196: 
197:         [<span class="ruby-identifier">:scheme</span>, <span class="ruby-identifier">:host</span>, <span class="ruby-identifier">:port</span>, <span class="ruby-identifier">:path</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">meth</span><span class="ruby-operator">|</span>
198:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">msg_return_to</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">meth</span>) <span class="ruby-operator">!=</span> <span class="ruby-identifier">app_parsed</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">meth</span>)
199:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">ProtocolError</span>, <span class="ruby-node">&quot;return_to #{meth.to_s} does not match&quot;</span>
200:           <span class="ruby-keyword kw">end</span>
201:         <span class="ruby-keyword kw">end</span>
202:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    