<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>OpenID::TrustRoot</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
    <script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Module</span> 
            OpenID::TrustRoot 
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/openid/trustroot_rb.html">lib/openid/trustroot.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>#</dt>
        <dd>
            <ul>
                
                <li><a href="#M000446">_extract_return_url</a></li>
                
            </ul>
        </dd>
    
        <dt>G</dt>
        <dd>
            <ul>
                
                <li><a href="#M000451">get_allowed_return_urls</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000450">return_to_matches</a></li>
                
            </ul>
        </dd>
    
        <dt>V</dt>
        <dd>
            <ul>
                
                <li><a href="#M000452">verify_return_to</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    
    <div class="sectiontitle">Classes and Modules</div>
    <ul>
        
        <li><span class="type">CLASS</span> <a href="TrustRoot/TrustRoot.html">OpenID::TrustRoot::TrustRoot</a></li>
        
    </ul>
    

    
    <div class="sectiontitle">Constants</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class="attr-name">TOP_LEVEL_DOMAINS</td>
            <td>=</td>
            <td class="attr-value">%w'       ac ad ae aero af ag ai al am an ao aq ar arpa as asia at       au aw ax az ba bb bd be bf bg bh bi biz bj bm bn bo br bs bt       bv bw by bz ca cat cc cd cf cg ch ci ck cl cm cn co com coop       cr cu cv cx cy cz de dj dk dm do dz ec edu ee eg er es et eu       fi fj fk fm fo fr ga gb gd ge gf gg gh gi gl gm gn gov gp gq       gr gs gt gu gw gy hk hm hn hr ht hu id ie il im in info int       io iq ir is it je jm jo jobs jp ke kg kh ki km kn kp kr kw       ky kz la lb lc li lk lr ls lt lu lv ly ma mc md me mg mh mil       mk ml mm mn mo mobi mp mq mr ms mt mu museum mv mw mx my mz       na name nc ne net nf ng ni nl no np nr nu nz om org pa pe pf       pg ph pk pl pm pn pr pro ps pt pw py qa re ro rs ru rw sa sb       sc sd se sg sh si sj sk sl sm sn so sr st su sv sy sz tc td       tel tf tg th tj tk tl tm tn to tp tr travel tt tv tw tz ua       ug uk us uy uz va vc ve vg vi vn vu wf ws xn--0zwm56d       xn--11b5bs3a9aj6g xn--80akhbyknj4f xn--9t4b11yi5a       xn--deba0ad xn--g6w251d xn--hgbk6aj7f53bba       xn--hlcj6aya9esc7a xn--jxalpdlp xn--kgbechtv xn--zckzah ye       yt yu za zm zw'</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">ALLOWED_PROTOCOLS</td>
            <td>=</td>
            <td class="attr-value">['http', 'https']</td>
        </tr>
        
        
        <tr valign='top'>
            <td class="attr-name">RP_RETURN_TO_URL_TYPE</td>
            <td>=</td>
            <td class="attr-value">'http://specs.openid.net/auth/2.0/return_to'</td>
        </tr>
        
        <tr valign='top'>
            <td>&nbsp;</td>
            <td colspan="2" class="attr-desc"><p>
The URI for relying party discovery, used in realm verification.
</p>
<p>
XXX: This should probably live somewhere else (like in <a
href="../OpenID.html">OpenID</a> or <a href="Yadis.html">OpenID::Yadis</a>
somewhere)
</p>
</td>
        </tr>
        
        
    </table>
    

    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M000446">
                    
                    <a name="M000446"></a><b>_extract_return_url</b>(endpoint)
                    
                </div>
                
                <div class="description">
                  <p>
If the endpoint is a relying party <a href="../OpenID.html">OpenID</a>
return_to endpoint, return the endpoint URL. Otherwise, return None.
</p>
<p>
This function is intended to be used as a filter for the <a
href="Yadis.html">Yadis</a> filtering interface.
</p>
<p>
endpoint: An XRDS BasicServiceEndpoint, as returned by performing <a
href="Yadis.html">Yadis</a> dicovery.
</p>
<p>
returns the endpoint URL or None if the endpoint is not a relying party
endpoint.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000446_source')" id="l_M000446_source">show</a>
                        
                    </p>
                    <div id="M000446_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/openid/trustroot.rb, line 59</span>
59:     <span class="ruby-keyword kw">def</span> <span class="ruby-constant">TrustRoot</span>.<span class="ruby-identifier">_extract_return_url</span>(<span class="ruby-identifier">endpoint</span>)
60:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">endpoint</span>.<span class="ruby-identifier">matchTypes</span>([<span class="ruby-constant">RP_RETURN_TO_URL_TYPE</span>])
61:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">endpoint</span>.<span class="ruby-identifier">uri</span>
62:       <span class="ruby-keyword kw">else</span>
63:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
64:       <span class="ruby-keyword kw">end</span>
65:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000451">
                    
                    <a name="M000451"></a><b>get_allowed_return_urls</b>(relying_party_url)
                    
                </div>
                
                <div class="description">
                  <p>
Given a relying party discovery URL return a list of return_to URLs.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000451_source')" id="l_M000451_source">show</a>
                        
                    </p>
                    <div id="M000451_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/trustroot.rb, line 96</span>
 96:     <span class="ruby-keyword kw">def</span> <span class="ruby-constant">TrustRoot</span>.<span class="ruby-identifier">get_allowed_return_urls</span>(<span class="ruby-identifier">relying_party_url</span>)
 97:       <span class="ruby-identifier">rp_url_after_redirects</span>, <span class="ruby-identifier">return_to_urls</span> = <span class="ruby-identifier">services</span>.<span class="ruby-identifier">get_service_endpoints</span>(
 98:         <span class="ruby-identifier">relying_party_url</span>, <span class="ruby-identifier">_extract_return_url</span>)
 99: 
100:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">rp_url_after_redirects</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">relying_party_url</span>
101:         <span class="ruby-comment cmt"># Verification caused a redirect</span>
102:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">RealmVerificationRedirected</span>.<span class="ruby-identifier">new</span>(
103:                 <span class="ruby-identifier">relying_party_url</span>, <span class="ruby-identifier">rp_url_after_redirects</span>)
104:       <span class="ruby-keyword kw">end</span>
105: 
106:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">return_to_urls</span>
107:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000450">
                    
                    <a name="M000450"></a><b>return_to_matches</b>(allowed_return_to_urls, return_to)
                    
                </div>
                
                <div class="description">
                  <p>
Is the return_to URL under one of the supplied allowed return_to URLs?
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000450_source')" id="l_M000450_source">show</a>
                        
                    </p>
                    <div id="M000450_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/openid/trustroot.rb, line 69</span>
69:     <span class="ruby-keyword kw">def</span> <span class="ruby-constant">TrustRoot</span>.<span class="ruby-identifier">return_to_matches</span>(<span class="ruby-identifier">allowed_return_to_urls</span>, <span class="ruby-identifier">return_to</span>)
70:       <span class="ruby-identifier">allowed_return_to_urls</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">allowed_return_to</span><span class="ruby-operator">|</span>
71:         <span class="ruby-comment cmt"># A return_to pattern works the same as a realm, except that</span>
72:         <span class="ruby-comment cmt"># it's not allowed to use a wildcard. We'll model this by</span>
73:         <span class="ruby-comment cmt"># parsing it as a realm, and not trying to match it if it has</span>
74:         <span class="ruby-comment cmt"># a wildcard.</span>
75: 
76:         <span class="ruby-identifier">return_realm</span> = <span class="ruby-constant">TrustRoot</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">allowed_return_to</span>)
77:         <span class="ruby-keyword kw">if</span> (<span class="ruby-comment cmt"># Parses as a trust root</span>
78:             <span class="ruby-operator">!</span><span class="ruby-identifier">return_realm</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">and</span>
79: 
80:             <span class="ruby-comment cmt"># Does not have a wildcard</span>
81:             <span class="ruby-operator">!</span><span class="ruby-identifier">return_realm</span>.<span class="ruby-identifier">wildcard</span> <span class="ruby-keyword kw">and</span>
82: 
83:             <span class="ruby-comment cmt"># Matches the return_to that we passed in with it</span>
84:             <span class="ruby-identifier">return_realm</span>.<span class="ruby-identifier">validate_url</span>(<span class="ruby-identifier">return_to</span>)
85:             )
86:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
87:         <span class="ruby-keyword kw">end</span>
88:       }
89: 
90:       <span class="ruby-comment cmt"># No URL in the list matched</span>
91:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
92:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000452">
                    
                    <a name="M000452"></a><b>verify_return_to</b>(realm_str, return_to, _vrfy=nil)
                    
                </div>
                
                <div class="description">
                  <p>
Verify that a return_to URL is valid for the given realm.
</p>
<p>
This function builds a discovery URL, performs <a
href="Yadis.html">Yadis</a> discovery on it, makes sure that the URL does
not redirect, parses out the return_to URLs, and finally checks to see if
the current return_to URL matches the return_to.
</p>
<p>
raises <a href="DiscoveryFailure.html">DiscoveryFailure</a> when <a
href="Yadis.html">Yadis</a> discovery fails returns true if the return_to
URL is valid for the realm
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000452_source')" id="l_M000452_source">show</a>
                        
                    </p>
                    <div id="M000452_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/openid/trustroot.rb, line 118</span>
118:     <span class="ruby-keyword kw">def</span> <span class="ruby-constant">TrustRoot</span>.<span class="ruby-identifier">verify_return_to</span>(<span class="ruby-identifier">realm_str</span>, <span class="ruby-identifier">return_to</span>, <span class="ruby-identifier">_vrfy</span>=<span class="ruby-keyword kw">nil</span>)
119:       <span class="ruby-comment cmt"># _vrfy parameter is there to make testing easier</span>
120:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">_vrfy</span>.<span class="ruby-identifier">nil?</span>
121:         <span class="ruby-identifier">_vrfy</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">method</span>(<span class="ruby-value str">'get_allowed_return_urls'</span>)
122:       <span class="ruby-keyword kw">end</span>
123: 
124:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">_vrfy</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Proc</span>) <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">_vrfy</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Method</span>))
125:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">&quot;_vrfy must be a Proc or Method&quot;</span>
126:       <span class="ruby-keyword kw">end</span>
127: 
128:       <span class="ruby-identifier">realm</span> = <span class="ruby-constant">TrustRoot</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">realm_str</span>)
129:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">realm</span>.<span class="ruby-identifier">nil?</span>
130:         <span class="ruby-comment cmt"># The realm does not parse as a URL pattern</span>
131:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
132:       <span class="ruby-keyword kw">end</span>
133: 
134:       <span class="ruby-keyword kw">begin</span>
135:         <span class="ruby-identifier">allowable_urls</span> = <span class="ruby-identifier">_vrfy</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">realm</span>.<span class="ruby-identifier">build_discovery_url</span>())
136:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">RealmVerificationRedirected</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">err</span>
137:         <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-identifier">err</span>.<span class="ruby-identifier">to_s</span>)
138:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
139:       <span class="ruby-keyword kw">end</span>
140: 
141:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">return_to_matches</span>(<span class="ruby-identifier">allowable_urls</span>, <span class="ruby-identifier">return_to</span>)
142:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
143:       <span class="ruby-keyword kw">else</span>
144:         <span class="ruby-constant">Util</span>.<span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Failed to validate return_to #{return_to} for &quot;</span> <span class="ruby-operator">+</span>
145:             <span class="ruby-node">&quot;realm #{realm_str}, was not in #{allowable_urls}&quot;</span>)
146:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
147:       <span class="ruby-keyword kw">end</span>
148:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    