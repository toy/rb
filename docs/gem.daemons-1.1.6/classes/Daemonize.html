<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Daemonize</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" />
    <script src="../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Module</span> 
            Daemonize 
            
        </h1>
        <ul class="files">
            
            <li><a href="../files/lib/daemons/daemonize_rb.html">lib/daemons/daemonize.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <h1><a href="Daemonize.html">Daemonize</a> Library</h1>
<p>
February. 4, 2005 Travis Whitton <whitton@atlantic.net>
</p>
<p>
<a href="Daemonize.html">Daemonize</a> allows you to easily modify any
existing Ruby program to run as a daemon. See README.rdoc for more details.
</p>
<h2>How to install</h2>
<ol>
<li>su to root

</li>
<li>ruby install.rb

</li>
</ol>
<p>
build the docs if you want to
</p>
<ol>
<li>rdoc &#8212;main README.rdoc daemonize.rb README.rdoc

</li>
</ol>
<h2>Copying</h2>
<p>
The <a href="Daemonize.html">Daemonize</a> extension module is copywrited
free software by Travis Whitton <whitton@atlantic.net>. You can
redistribute it under the terms specified in the COPYING file of the Ruby
distribution.
</p>
<h2>WARRANTY</h2>
<p>
THIS SOFTWARE IS PROVIDED &#8220;AS IS&#8221; AND WITHOUT ANY EXPRESS OR
IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES
OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.
</p>
<hr size="2"></hr><h2>Purpose</h2>
<p>
<a href="Daemonize.html">Daemonize</a> is a module derived from
Perl&#8217;s Proc::Daemon module. This module allows you to easily modify
any existing Ruby program to run as a daemon. A daemon is a process that
runs in the background with no controlling terminal. Generally servers
(like FTP and HTTP servers) run as daemon processes. Note, do not make the
mistake that a daemon == server. Converting a program to a daemon by hand
is a relatively simple process; however, this module will save you the
effort of repeatedly looking up the procedure, and it will also insure that
your programs are daemonized in the safest and most corrects fashion
possible.
</p>
<h2>Procedure</h2>
<p>
The <a href="Daemonize.html">Daemonize</a> module does the following:
</p>
<p>
Forks a child and exits the parent process.
</p>
<p>
Becomes a session leader (which detaches the program from the controlling
terminal).
</p>
<p>
Forks another child process and exits first child. This prevents the
potential of acquiring a controlling terminal.
</p>
<p>
Changes the current working directory to &#8220;/&#8221;.
</p>
<p>
Clears the file creation mask.
</p>
<p>
Closes file descriptors.
</p>
<h2>Example usage</h2>
<p>
Using the <a href="Daemonize.html">Daemonize</a> module is extremely
simple:
</p>
<pre>
    require 'daemonize'

    class TestDaemon
      include Daemonize

      def initialize
        daemonize()
        loop do
          # do some work here
        end
      end
    end
</pre>
<h2>Credits</h2>
<p>
<a href="Daemonize.html">Daemonize</a> was written by Travis Whitton and is
based on Perl&#8217;s Proc::Daemonize, which was written by Earl Hood. The
above documentation is also partially borrowed from the Proc::Daemonize POD
documentation.
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M000045">call_as_daemon</a>,</li>
                
                <li><a href="#M000045">call_as_daemon</a></li>
                
            </ul>
        </dd>
    
        <dt>D</dt>
        <dd>
            <ul>
                
                <li><a href="#M000046">daemonize</a>,</li>
                
                <li><a href="#M000046">daemonize</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000049">redirect_io</a>,</li>
                
                <li><a href="#M000049">redirect_io</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M000043">safefork</a>,</li>
                
                <li><a href="#M000043">safefork</a>,</li>
                
                <li><a href="#M000044">simulate</a>,</li>
                
                <li><a href="#M000044">simulate</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    

    
    <div class="sectiontitle">Constants</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class="attr-name">VERSION</td>
            <td>=</td>
            <td class="attr-value">&quot;0.1.1m&quot;</td>
        </tr>
        
        
    </table>
    

    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M000045">
                    
                    <a name="M000045"></a><b>call_as_daemon</b>(block, logfile_name = nil, app_name = nil)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000045_source')" id="l_M000045_source">show</a>
                        
                    </p>
                    <div id="M000045_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons/daemonize.rb, line 141</span>
141:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">call_as_daemon</span>(<span class="ruby-identifier">block</span>, <span class="ruby-identifier">logfile_name</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">app_name</span> = <span class="ruby-keyword kw">nil</span>)
142:     <span class="ruby-identifier">rd</span>, <span class="ruby-identifier">wr</span> = <span class="ruby-constant">IO</span>.<span class="ruby-identifier">pipe</span>
143:     
144:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tmppid</span> = <span class="ruby-identifier">safefork</span>
145:       <span class="ruby-comment cmt"># parent</span>
146:       <span class="ruby-identifier">wr</span>.<span class="ruby-identifier">close</span>
147:       <span class="ruby-identifier">pid</span> = <span class="ruby-identifier">rd</span>.<span class="ruby-identifier">read</span>.<span class="ruby-identifier">to_i</span>
148:       <span class="ruby-identifier">rd</span>.<span class="ruby-identifier">close</span>
149:       
150:       <span class="ruby-constant">Process</span>.<span class="ruby-identifier">waitpid</span>(<span class="ruby-identifier">tmppid</span>)
151:       
152:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">pid</span>
153:     <span class="ruby-keyword kw">else</span>
154:       <span class="ruby-comment cmt"># child</span>
155:       
156:       <span class="ruby-identifier">rd</span>.<span class="ruby-identifier">close</span>
157:       
158:       <span class="ruby-comment cmt"># Detach from the controlling terminal</span>
159:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">sess_id</span> = <span class="ruby-constant">Process</span>.<span class="ruby-identifier">setsid</span>
160:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">Daemons</span>.<span class="ruby-constant">RuntimeException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'cannot detach from controlling terminal'</span>)
161:       <span class="ruby-keyword kw">end</span>
162:   
163:       <span class="ruby-comment cmt"># Prevent the possibility of acquiring a controlling terminal</span>
164:       <span class="ruby-comment cmt">#if oldmode.zero?</span>
165:         <span class="ruby-identifier">trap</span> <span class="ruby-value str">'SIGHUP'</span>, <span class="ruby-value str">'IGNORE'</span>
166:         <span class="ruby-identifier">exit</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pid</span> = <span class="ruby-identifier">safefork</span>
167:       <span class="ruby-comment cmt">#end</span>
168:   
169:       <span class="ruby-identifier">wr</span>.<span class="ruby-identifier">write</span> <span class="ruby-constant">Process</span>.<span class="ruby-identifier">pid</span>
170:       <span class="ruby-identifier">wr</span>.<span class="ruby-identifier">close</span>
171:       
172:       <span class="ruby-comment cmt"># Always handle INT signal (thanks to Vit Ondruch)</span>
173:       <span class="ruby-comment cmt">#trap 'INT', 'DEFAULT'  # make sure we always handle the 'INT' signal</span>
174:       
175:       <span class="ruby-identifier">$0</span> = <span class="ruby-identifier">app_name</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">app_name</span>
176:       
177:       <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">chdir</span> <span class="ruby-value str">&quot;/&quot;</span>   <span class="ruby-comment cmt"># Release old working directory</span>
178:   
179:       <span class="ruby-comment cmt"># Make sure all file descriptors are closed</span>
180:       <span class="ruby-constant">ObjectSpace</span>.<span class="ruby-identifier">each_object</span>(<span class="ruby-constant">IO</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
181:         <span class="ruby-keyword kw">unless</span> [<span class="ruby-constant">STDIN</span>, <span class="ruby-constant">STDOUT</span>, <span class="ruby-constant">STDERR</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">io</span>)
182:           <span class="ruby-keyword kw">begin</span>
183:             <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">closed?</span>
184:               <span class="ruby-identifier">io</span>.<span class="ruby-identifier">close</span>
185:             <span class="ruby-keyword kw">end</span>
186:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>
187:           <span class="ruby-keyword kw">end</span>
188:         <span class="ruby-keyword kw">end</span>
189:       <span class="ruby-keyword kw">end</span>
190:       
191:       <span class="ruby-identifier">ios</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">8192</span>){<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-constant">IO</span>.<span class="ruby-identifier">for_fd</span>(<span class="ruby-identifier">i</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>}.<span class="ruby-identifier">compact</span>
192:       <span class="ruby-identifier">ios</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
193:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">fileno</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">3</span>
194:         <span class="ruby-identifier">io</span>.<span class="ruby-identifier">close</span>
195:       <span class="ruby-keyword kw">end</span>
196: 
197:   
198:       <span class="ruby-identifier">redirect_io</span>(<span class="ruby-identifier">logfile_name</span>)  
199:     
200:       <span class="ruby-identifier">block</span>.<span class="ruby-identifier">call</span>
201:       
202:       <span class="ruby-identifier">exit</span>
203:     <span class="ruby-keyword kw">end</span>
204:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000046">
                    
                    <a name="M000046"></a><b>daemonize</b>(logfile_name = nil, app_name = nil)
                    
                </div>
                
                <div class="description">
                  <p>
This method causes the current running process to become a daemon
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000046_source')" id="l_M000046_source">show</a>
                        
                    </p>
                    <div id="M000046_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons/daemonize.rb, line 209</span>
209:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">daemonize</span>(<span class="ruby-identifier">logfile_name</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">app_name</span> = <span class="ruby-keyword kw">nil</span>)
210:     <span class="ruby-identifier">srand</span> <span class="ruby-comment cmt"># Split rand streams between spawning and daemonized process</span>
211:     <span class="ruby-identifier">safefork</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">exit</span> <span class="ruby-comment cmt"># Fork and exit from the parent</span>
212: 
213:     <span class="ruby-comment cmt"># Detach from the controlling terminal</span>
214:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">sess_id</span> = <span class="ruby-constant">Process</span>.<span class="ruby-identifier">setsid</span>
215:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">Daemons</span>.<span class="ruby-constant">RuntimeException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'cannot detach from controlling terminal'</span>)
216:     <span class="ruby-keyword kw">end</span>
217: 
218:     <span class="ruby-comment cmt"># Prevent the possibility of acquiring a controlling terminal</span>
219:     <span class="ruby-comment cmt">#if oldmode.zero?</span>
220:       <span class="ruby-identifier">trap</span> <span class="ruby-value str">'SIGHUP'</span>, <span class="ruby-value str">'IGNORE'</span>
221:       <span class="ruby-identifier">exit</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pid</span> = <span class="ruby-identifier">safefork</span>
222:     <span class="ruby-comment cmt">#end</span>
223: 
224:     <span class="ruby-comment cmt"># Always handle INT signal (thanks to Vit Ondruch)</span>
225:     <span class="ruby-comment cmt">#trap 'INT', 'DEFAULT'  # make sure we always handle the 'INT' signal</span>
226:     
227:     <span class="ruby-identifier">$0</span> = <span class="ruby-identifier">app_name</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">app_name</span>
228:     
229:     <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">chdir</span> <span class="ruby-value str">&quot;/&quot;</span>   <span class="ruby-comment cmt"># Release old working directory</span>
230: 
231:     <span class="ruby-comment cmt"># Make sure all file descriptors are closed</span>
232:     <span class="ruby-constant">ObjectSpace</span>.<span class="ruby-identifier">each_object</span>(<span class="ruby-constant">IO</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
233:       <span class="ruby-keyword kw">unless</span> [<span class="ruby-constant">STDIN</span>, <span class="ruby-constant">STDOUT</span>, <span class="ruby-constant">STDERR</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">io</span>)
234:         <span class="ruby-keyword kw">begin</span>
235:           <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">closed?</span>
236:             <span class="ruby-identifier">io</span>.<span class="ruby-identifier">close</span>
237:           <span class="ruby-keyword kw">end</span>
238:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>
239:         <span class="ruby-keyword kw">end</span>
240:       <span class="ruby-keyword kw">end</span>
241:     <span class="ruby-keyword kw">end</span>
242: 
243:     <span class="ruby-identifier">redirect_io</span>(<span class="ruby-identifier">logfile_name</span>)
244:     
245:     <span class="ruby-comment cmt">#return oldmode ? sess_id : 0   # Return value is mostly irrelevant</span>
246:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">sess_id</span>
247:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000049">
                    
                    <a name="M000049"></a><b>redirect_io</b>(logfile_name)
                    
                </div>
                
                <div class="description">
                  <p>
Free file descriptors and point them somewhere sensible STDOUT/STDERR
should go to a logfile
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000049_source')" id="l_M000049_source">show</a>
                        
                    </p>
                    <div id="M000049_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons/daemonize.rb, line 254</span>
254:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">redirect_io</span>(<span class="ruby-identifier">logfile_name</span>)
255:     <span class="ruby-keyword kw">begin</span>; <span class="ruby-constant">STDIN</span>.<span class="ruby-identifier">reopen</span> <span class="ruby-value str">&quot;/dev/null&quot;</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>       
256:      
257:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logfile_name</span>
258:       <span class="ruby-keyword kw">begin</span>
259:         <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">reopen</span> <span class="ruby-identifier">logfile_name</span>, <span class="ruby-value str">&quot;a&quot;</span> 
260:         <span class="ruby-constant">File</span>.<span class="ruby-identifier">chmod</span>(<span class="ruby-value">0644</span>, <span class="ruby-identifier">logfile_name</span>)
261:         <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">sync</span> = <span class="ruby-keyword kw">true</span>
262:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>
263:         <span class="ruby-keyword kw">begin</span>; <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">reopen</span> <span class="ruby-value str">&quot;/dev/null&quot;</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>
264:       <span class="ruby-keyword kw">end</span>
265:     <span class="ruby-keyword kw">else</span>
266:       <span class="ruby-keyword kw">begin</span>; <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">reopen</span> <span class="ruby-value str">&quot;/dev/null&quot;</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>
267:     <span class="ruby-keyword kw">end</span>
268:     
269:     <span class="ruby-keyword kw">begin</span>; <span class="ruby-constant">STDERR</span>.<span class="ruby-identifier">reopen</span> <span class="ruby-constant">STDOUT</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>
270:     <span class="ruby-constant">STDERR</span>.<span class="ruby-identifier">sync</span> = <span class="ruby-keyword kw">true</span>
271:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000043">
                    
                    <a name="M000043"></a><b>safefork</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Try to fork if at all possible retrying every 5 sec if the maximum process
limit for the system has been reached
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000043_source')" id="l_M000043_source">show</a>
                        
                    </p>
                    <div id="M000043_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons/daemonize.rb, line 97</span>
 97:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">safefork</span>
 98:     <span class="ruby-identifier">tryagain</span> = <span class="ruby-keyword kw">true</span>
 99: 
100:     <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">tryagain</span>
101:       <span class="ruby-identifier">tryagain</span> = <span class="ruby-keyword kw">false</span>
102:       <span class="ruby-keyword kw">begin</span>
103:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pid</span> = <span class="ruby-identifier">fork</span>
104:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">pid</span>
105:         <span class="ruby-keyword kw">end</span>
106:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EWOULDBLOCK</span>
107:         <span class="ruby-identifier">sleep</span> <span class="ruby-value">5</span>
108:         <span class="ruby-identifier">tryagain</span> = <span class="ruby-keyword kw">true</span>
109:       <span class="ruby-keyword kw">end</span>
110:     <span class="ruby-keyword kw">end</span>
111:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000044">
                    
                    <a name="M000044"></a><b>simulate</b>(logfile_name = nil)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000044_source')" id="l_M000044_source">show</a>
                        
                    </p>
                    <div id="M000044_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons/daemonize.rb, line 115</span>
115:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">simulate</span>(<span class="ruby-identifier">logfile_name</span> = <span class="ruby-keyword kw">nil</span>)
116:     <span class="ruby-comment cmt"># NOTE: STDOUT and STDERR will not be redirected to the logfile, because in :ontop mode, we normally want to see the output</span>
117:     
118:     <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">chdir</span> <span class="ruby-value str">&quot;/&quot;</span>   <span class="ruby-comment cmt"># Release old working directory</span>
119: 
120:     <span class="ruby-comment cmt"># Make sure all file descriptors are closed</span>
121:     <span class="ruby-constant">ObjectSpace</span>.<span class="ruby-identifier">each_object</span>(<span class="ruby-constant">IO</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
122:       <span class="ruby-keyword kw">unless</span> [<span class="ruby-constant">STDIN</span>, <span class="ruby-constant">STDOUT</span>, <span class="ruby-constant">STDERR</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">io</span>)
123:         <span class="ruby-keyword kw">begin</span>
124:           <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">closed?</span>
125:             <span class="ruby-identifier">io</span>.<span class="ruby-identifier">close</span>
126:           <span class="ruby-keyword kw">end</span>
127:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>
128:         <span class="ruby-keyword kw">end</span>
129:       <span class="ruby-keyword kw">end</span>
130:     <span class="ruby-keyword kw">end</span>
131: 
132:     <span class="ruby-comment cmt"># Free file descriptors and</span>
133:     <span class="ruby-comment cmt"># point them somewhere sensible</span>
134:     <span class="ruby-comment cmt"># STDOUT/STDERR should go to a logfile</span>
135:     
136:     <span class="ruby-keyword kw">begin</span>; <span class="ruby-constant">STDIN</span>.<span class="ruby-identifier">reopen</span> <span class="ruby-value str">&quot;/dev/null&quot;</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>       
137:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Private methods</div>
            
            <div class="method">
                <div class="title" id="M000045">
                    
                    <a name="M000045"></a><b>call_as_daemon</b>(block, logfile_name = nil, app_name = nil)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000045_source')" id="l_M000045_source">show</a>
                        
                    </p>
                    <div id="M000045_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons/daemonize.rb, line 141</span>
141:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">call_as_daemon</span>(<span class="ruby-identifier">block</span>, <span class="ruby-identifier">logfile_name</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">app_name</span> = <span class="ruby-keyword kw">nil</span>)
142:     <span class="ruby-identifier">rd</span>, <span class="ruby-identifier">wr</span> = <span class="ruby-constant">IO</span>.<span class="ruby-identifier">pipe</span>
143:     
144:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tmppid</span> = <span class="ruby-identifier">safefork</span>
145:       <span class="ruby-comment cmt"># parent</span>
146:       <span class="ruby-identifier">wr</span>.<span class="ruby-identifier">close</span>
147:       <span class="ruby-identifier">pid</span> = <span class="ruby-identifier">rd</span>.<span class="ruby-identifier">read</span>.<span class="ruby-identifier">to_i</span>
148:       <span class="ruby-identifier">rd</span>.<span class="ruby-identifier">close</span>
149:       
150:       <span class="ruby-constant">Process</span>.<span class="ruby-identifier">waitpid</span>(<span class="ruby-identifier">tmppid</span>)
151:       
152:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">pid</span>
153:     <span class="ruby-keyword kw">else</span>
154:       <span class="ruby-comment cmt"># child</span>
155:       
156:       <span class="ruby-identifier">rd</span>.<span class="ruby-identifier">close</span>
157:       
158:       <span class="ruby-comment cmt"># Detach from the controlling terminal</span>
159:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">sess_id</span> = <span class="ruby-constant">Process</span>.<span class="ruby-identifier">setsid</span>
160:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">Daemons</span>.<span class="ruby-constant">RuntimeException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'cannot detach from controlling terminal'</span>)
161:       <span class="ruby-keyword kw">end</span>
162:   
163:       <span class="ruby-comment cmt"># Prevent the possibility of acquiring a controlling terminal</span>
164:       <span class="ruby-comment cmt">#if oldmode.zero?</span>
165:         <span class="ruby-identifier">trap</span> <span class="ruby-value str">'SIGHUP'</span>, <span class="ruby-value str">'IGNORE'</span>
166:         <span class="ruby-identifier">exit</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pid</span> = <span class="ruby-identifier">safefork</span>
167:       <span class="ruby-comment cmt">#end</span>
168:   
169:       <span class="ruby-identifier">wr</span>.<span class="ruby-identifier">write</span> <span class="ruby-constant">Process</span>.<span class="ruby-identifier">pid</span>
170:       <span class="ruby-identifier">wr</span>.<span class="ruby-identifier">close</span>
171:       
172:       <span class="ruby-comment cmt"># Always handle INT signal (thanks to Vit Ondruch)</span>
173:       <span class="ruby-comment cmt">#trap 'INT', 'DEFAULT'  # make sure we always handle the 'INT' signal</span>
174:       
175:       <span class="ruby-identifier">$0</span> = <span class="ruby-identifier">app_name</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">app_name</span>
176:       
177:       <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">chdir</span> <span class="ruby-value str">&quot;/&quot;</span>   <span class="ruby-comment cmt"># Release old working directory</span>
178:   
179:       <span class="ruby-comment cmt"># Make sure all file descriptors are closed</span>
180:       <span class="ruby-constant">ObjectSpace</span>.<span class="ruby-identifier">each_object</span>(<span class="ruby-constant">IO</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
181:         <span class="ruby-keyword kw">unless</span> [<span class="ruby-constant">STDIN</span>, <span class="ruby-constant">STDOUT</span>, <span class="ruby-constant">STDERR</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">io</span>)
182:           <span class="ruby-keyword kw">begin</span>
183:             <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">closed?</span>
184:               <span class="ruby-identifier">io</span>.<span class="ruby-identifier">close</span>
185:             <span class="ruby-keyword kw">end</span>
186:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>
187:           <span class="ruby-keyword kw">end</span>
188:         <span class="ruby-keyword kw">end</span>
189:       <span class="ruby-keyword kw">end</span>
190:       
191:       <span class="ruby-identifier">ios</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">8192</span>){<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-constant">IO</span>.<span class="ruby-identifier">for_fd</span>(<span class="ruby-identifier">i</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>}.<span class="ruby-identifier">compact</span>
192:       <span class="ruby-identifier">ios</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
193:         <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">fileno</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">3</span>
194:         <span class="ruby-identifier">io</span>.<span class="ruby-identifier">close</span>
195:       <span class="ruby-keyword kw">end</span>
196: 
197:   
198:       <span class="ruby-identifier">redirect_io</span>(<span class="ruby-identifier">logfile_name</span>)  
199:     
200:       <span class="ruby-identifier">block</span>.<span class="ruby-identifier">call</span>
201:       
202:       <span class="ruby-identifier">exit</span>
203:     <span class="ruby-keyword kw">end</span>
204:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000046">
                    
                    <a name="M000046"></a><b>daemonize</b>(logfile_name = nil, app_name = nil)
                    
                </div>
                
                <div class="description">
                  <p>
This method causes the current running process to become a daemon
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000046_source')" id="l_M000046_source">show</a>
                        
                    </p>
                    <div id="M000046_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons/daemonize.rb, line 209</span>
209:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">daemonize</span>(<span class="ruby-identifier">logfile_name</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">app_name</span> = <span class="ruby-keyword kw">nil</span>)
210:     <span class="ruby-identifier">srand</span> <span class="ruby-comment cmt"># Split rand streams between spawning and daemonized process</span>
211:     <span class="ruby-identifier">safefork</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">exit</span> <span class="ruby-comment cmt"># Fork and exit from the parent</span>
212: 
213:     <span class="ruby-comment cmt"># Detach from the controlling terminal</span>
214:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">sess_id</span> = <span class="ruby-constant">Process</span>.<span class="ruby-identifier">setsid</span>
215:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">Daemons</span>.<span class="ruby-constant">RuntimeException</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'cannot detach from controlling terminal'</span>)
216:     <span class="ruby-keyword kw">end</span>
217: 
218:     <span class="ruby-comment cmt"># Prevent the possibility of acquiring a controlling terminal</span>
219:     <span class="ruby-comment cmt">#if oldmode.zero?</span>
220:       <span class="ruby-identifier">trap</span> <span class="ruby-value str">'SIGHUP'</span>, <span class="ruby-value str">'IGNORE'</span>
221:       <span class="ruby-identifier">exit</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pid</span> = <span class="ruby-identifier">safefork</span>
222:     <span class="ruby-comment cmt">#end</span>
223: 
224:     <span class="ruby-comment cmt"># Always handle INT signal (thanks to Vit Ondruch)</span>
225:     <span class="ruby-comment cmt">#trap 'INT', 'DEFAULT'  # make sure we always handle the 'INT' signal</span>
226:     
227:     <span class="ruby-identifier">$0</span> = <span class="ruby-identifier">app_name</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">app_name</span>
228:     
229:     <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">chdir</span> <span class="ruby-value str">&quot;/&quot;</span>   <span class="ruby-comment cmt"># Release old working directory</span>
230: 
231:     <span class="ruby-comment cmt"># Make sure all file descriptors are closed</span>
232:     <span class="ruby-constant">ObjectSpace</span>.<span class="ruby-identifier">each_object</span>(<span class="ruby-constant">IO</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
233:       <span class="ruby-keyword kw">unless</span> [<span class="ruby-constant">STDIN</span>, <span class="ruby-constant">STDOUT</span>, <span class="ruby-constant">STDERR</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">io</span>)
234:         <span class="ruby-keyword kw">begin</span>
235:           <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">closed?</span>
236:             <span class="ruby-identifier">io</span>.<span class="ruby-identifier">close</span>
237:           <span class="ruby-keyword kw">end</span>
238:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>
239:         <span class="ruby-keyword kw">end</span>
240:       <span class="ruby-keyword kw">end</span>
241:     <span class="ruby-keyword kw">end</span>
242: 
243:     <span class="ruby-identifier">redirect_io</span>(<span class="ruby-identifier">logfile_name</span>)
244:     
245:     <span class="ruby-comment cmt">#return oldmode ? sess_id : 0   # Return value is mostly irrelevant</span>
246:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">sess_id</span>
247:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000049">
                    
                    <a name="M000049"></a><b>redirect_io</b>(logfile_name)
                    
                </div>
                
                <div class="description">
                  <p>
Free file descriptors and point them somewhere sensible STDOUT/STDERR
should go to a logfile
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000049_source')" id="l_M000049_source">show</a>
                        
                    </p>
                    <div id="M000049_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons/daemonize.rb, line 254</span>
254:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">redirect_io</span>(<span class="ruby-identifier">logfile_name</span>)
255:     <span class="ruby-keyword kw">begin</span>; <span class="ruby-constant">STDIN</span>.<span class="ruby-identifier">reopen</span> <span class="ruby-value str">&quot;/dev/null&quot;</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>       
256:      
257:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logfile_name</span>
258:       <span class="ruby-keyword kw">begin</span>
259:         <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">reopen</span> <span class="ruby-identifier">logfile_name</span>, <span class="ruby-value str">&quot;a&quot;</span> 
260:         <span class="ruby-constant">File</span>.<span class="ruby-identifier">chmod</span>(<span class="ruby-value">0644</span>, <span class="ruby-identifier">logfile_name</span>)
261:         <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">sync</span> = <span class="ruby-keyword kw">true</span>
262:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>
263:         <span class="ruby-keyword kw">begin</span>; <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">reopen</span> <span class="ruby-value str">&quot;/dev/null&quot;</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>
264:       <span class="ruby-keyword kw">end</span>
265:     <span class="ruby-keyword kw">else</span>
266:       <span class="ruby-keyword kw">begin</span>; <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">reopen</span> <span class="ruby-value str">&quot;/dev/null&quot;</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>
267:     <span class="ruby-keyword kw">end</span>
268:     
269:     <span class="ruby-keyword kw">begin</span>; <span class="ruby-constant">STDERR</span>.<span class="ruby-identifier">reopen</span> <span class="ruby-constant">STDOUT</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>
270:     <span class="ruby-constant">STDERR</span>.<span class="ruby-identifier">sync</span> = <span class="ruby-keyword kw">true</span>
271:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000043">
                    
                    <a name="M000043"></a><b>safefork</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Try to fork if at all possible retrying every 5 sec if the maximum process
limit for the system has been reached
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000043_source')" id="l_M000043_source">show</a>
                        
                    </p>
                    <div id="M000043_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons/daemonize.rb, line 97</span>
 97:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">safefork</span>
 98:     <span class="ruby-identifier">tryagain</span> = <span class="ruby-keyword kw">true</span>
 99: 
100:     <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">tryagain</span>
101:       <span class="ruby-identifier">tryagain</span> = <span class="ruby-keyword kw">false</span>
102:       <span class="ruby-keyword kw">begin</span>
103:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pid</span> = <span class="ruby-identifier">fork</span>
104:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">pid</span>
105:         <span class="ruby-keyword kw">end</span>
106:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EWOULDBLOCK</span>
107:         <span class="ruby-identifier">sleep</span> <span class="ruby-value">5</span>
108:         <span class="ruby-identifier">tryagain</span> = <span class="ruby-keyword kw">true</span>
109:       <span class="ruby-keyword kw">end</span>
110:     <span class="ruby-keyword kw">end</span>
111:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000044">
                    
                    <a name="M000044"></a><b>simulate</b>(logfile_name = nil)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000044_source')" id="l_M000044_source">show</a>
                        
                    </p>
                    <div id="M000044_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/daemons/daemonize.rb, line 115</span>
115:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">simulate</span>(<span class="ruby-identifier">logfile_name</span> = <span class="ruby-keyword kw">nil</span>)
116:     <span class="ruby-comment cmt"># NOTE: STDOUT and STDERR will not be redirected to the logfile, because in :ontop mode, we normally want to see the output</span>
117:     
118:     <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">chdir</span> <span class="ruby-value str">&quot;/&quot;</span>   <span class="ruby-comment cmt"># Release old working directory</span>
119: 
120:     <span class="ruby-comment cmt"># Make sure all file descriptors are closed</span>
121:     <span class="ruby-constant">ObjectSpace</span>.<span class="ruby-identifier">each_object</span>(<span class="ruby-constant">IO</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
122:       <span class="ruby-keyword kw">unless</span> [<span class="ruby-constant">STDIN</span>, <span class="ruby-constant">STDOUT</span>, <span class="ruby-constant">STDERR</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">io</span>)
123:         <span class="ruby-keyword kw">begin</span>
124:           <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">closed?</span>
125:             <span class="ruby-identifier">io</span>.<span class="ruby-identifier">close</span>
126:           <span class="ruby-keyword kw">end</span>
127:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>
128:         <span class="ruby-keyword kw">end</span>
129:       <span class="ruby-keyword kw">end</span>
130:     <span class="ruby-keyword kw">end</span>
131: 
132:     <span class="ruby-comment cmt"># Free file descriptors and</span>
133:     <span class="ruby-comment cmt"># point them somewhere sensible</span>
134:     <span class="ruby-comment cmt"># STDOUT/STDERR should go to a logfile</span>
135:     
136:     <span class="ruby-keyword kw">begin</span>; <span class="ruby-constant">STDIN</span>.<span class="ruby-identifier">reopen</span> <span class="ruby-value str">&quot;/dev/null&quot;</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>       
137:   <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    