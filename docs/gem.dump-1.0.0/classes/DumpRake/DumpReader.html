<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>DumpRake::DumpReader</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
    <script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            DumpRake::DumpReader 
            
                <span class="parent">&lt; 
                    
                    Dump
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/dump_rake/dump_reader_rb.html">lib/dump_rake/dump_reader.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>F</dt>
        <dd>
            <ul>
                
                <li><a href="#M000036">find_entry</a></li>
                
            </ul>
        </dd>
    
        <dt>M</dt>
        <dd>
            <ul>
                
                <li><a href="#M000040">migrate_down</a></li>
                
            </ul>
        </dd>
    
        <dt>O</dt>
        <dd>
            <ul>
                
                <li><a href="#M000035">open</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000054">read_asset?</a>,</li>
                
                <li><a href="#M000051">read_assets</a>,</li>
                
                <li><a href="#M000055">read_assets_entries</a>,</li>
                
                <li><a href="#M000039">read_config</a>,</li>
                
                <li><a href="#M000037">read_entry</a>,</li>
                
                <li><a href="#M000038">read_entry_to_file</a>,</li>
                
                <li><a href="#M000042">read_schema</a>,</li>
                
                <li><a href="#M000047">read_table</a>,</li>
                
                <li><a href="#M000044">read_tables</a>,</li>
                
                <li><a href="#M000021">restore</a>,</li>
                
                <li><a href="#M000041">restore_schema?</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M000043">schema</a>,</li>
                
                <li><a href="#M000028">summary</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    
    <div class="sectiontitle">Classes and Modules</div>
    <ul>
        
        <li><span class="type">CLASS</span> <a href="DumpReader/Summary.html">DumpRake::DumpReader::Summary</a></li>
        
    </ul>
    

    

    
    <div class="sectiontitle">Attributes</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>stream</td>
            <td class='attr-desc'></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>config</td>
            <td class='attr-desc'></td>
        </tr>
        
    </table>
    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M000021">
                    
                    <a name="M000021"></a><b>restore</b>(path)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000021_source')" id="l_M000021_source">show</a>
                        
                    </p>
                    <div id="M000021_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/dump_rake/dump_reader.rb, line 5</span>
 5:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">restore</span>(<span class="ruby-identifier">path</span>)
 6:       <span class="ruby-identifier">new</span>(<span class="ruby-identifier">path</span>).<span class="ruby-identifier">open</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dump</span><span class="ruby-operator">|</span>
 7:         <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">silence</span> <span class="ruby-keyword kw">do</span>
 8:           <span class="ruby-identifier">dump</span>.<span class="ruby-identifier">read_config</span>
 9:           <span class="ruby-identifier">dump</span>.<span class="ruby-identifier">migrate_down</span>
10:           <span class="ruby-identifier">dump</span>.<span class="ruby-identifier">read_schema</span>
11: 
12:           <span class="ruby-identifier">dump</span>.<span class="ruby-identifier">read_tables</span>
13:           <span class="ruby-identifier">dump</span>.<span class="ruby-identifier">read_assets</span>
14:         <span class="ruby-keyword kw">end</span>
15:       <span class="ruby-keyword kw">end</span>
16:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000028">
                    
                    <a name="M000028"></a><b>summary</b>(path, options = {})
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000028_source')" id="l_M000028_source">show</a>
                        
                    </p>
                    <div id="M000028_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/dump_rake/dump_reader.rb, line 41</span>
41:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">summary</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">options</span> = {})
42:       <span class="ruby-identifier">new</span>(<span class="ruby-identifier">path</span>).<span class="ruby-identifier">open</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dump</span><span class="ruby-operator">|</span>
43:         <span class="ruby-identifier">dump</span>.<span class="ruby-identifier">read_config</span>
44: 
45:         <span class="ruby-identifier">sum</span> = <span class="ruby-constant">Summary</span>.<span class="ruby-identifier">new</span>
46: 
47:         <span class="ruby-identifier">tables</span> = <span class="ruby-identifier">dump</span>.<span class="ruby-identifier">config</span>[<span class="ruby-identifier">:tables</span>]
48:         <span class="ruby-identifier">sum</span>.<span class="ruby-identifier">header</span> <span class="ruby-value str">'Tables'</span>
49:         <span class="ruby-identifier">sum</span>.<span class="ruby-identifier">data</span> <span class="ruby-identifier">tables</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span>(<span class="ruby-identifier">table</span>, <span class="ruby-identifier">rows</span>)<span class="ruby-operator">|</span>
50:           <span class="ruby-node">&quot;#{table}: #{Summary.pluralize(rows, 'row')}&quot;</span>
51:         }
52: 
53:         <span class="ruby-identifier">assets</span> = <span class="ruby-identifier">dump</span>.<span class="ruby-identifier">config</span>[<span class="ruby-identifier">:assets</span>]
54:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">assets</span>.<span class="ruby-identifier">present?</span>
55:           <span class="ruby-identifier">sum</span>.<span class="ruby-identifier">header</span> <span class="ruby-value str">'Assets'</span>
56:           <span class="ruby-identifier">sum</span>.<span class="ruby-identifier">data</span> <span class="ruby-identifier">assets</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">entry</span><span class="ruby-operator">|</span>
57:             <span class="ruby-keyword kw">if</span> <span class="ruby-constant">String</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">entry</span>
58:               <span class="ruby-identifier">entry</span>
59:             <span class="ruby-keyword kw">else</span>
60:               <span class="ruby-identifier">asset</span>, <span class="ruby-identifier">paths</span> = <span class="ruby-identifier">entry</span>
61:               <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Hash</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">paths</span>
62:                 <span class="ruby-node">&quot;#{asset}: #{Summary.pluralize paths[:files], 'file'} (#{Summary.pluralize paths[:total], 'entry'} total)&quot;</span>
63:               <span class="ruby-keyword kw">else</span>
64:                 <span class="ruby-node">&quot;#{asset}: #{Summary.pluralize paths, 'entry'}&quot;</span>
65:               <span class="ruby-keyword kw">end</span>
66:             <span class="ruby-keyword kw">end</span>
67:           }
68:         <span class="ruby-keyword kw">end</span>
69: 
70:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:schema</span>]
71:           <span class="ruby-identifier">sum</span>.<span class="ruby-identifier">header</span> <span class="ruby-value str">'Schema'</span>
72:           <span class="ruby-identifier">sum</span>.<span class="ruby-identifier">data</span> <span class="ruby-identifier">dump</span>.<span class="ruby-identifier">schema</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">&quot;\n&quot;</span>)
73:         <span class="ruby-keyword kw">end</span>
74: 
75:         <span class="ruby-identifier">sum</span>
76:       <span class="ruby-keyword kw">end</span>
77:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000036">
                    
                    <a name="M000036"></a><b>find_entry</b>(matcher)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000036_source')" id="l_M000036_source">show</a>
                        
                    </p>
                    <div id="M000036_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/dump_rake/dump_reader.rb, line 88</span>
88:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">find_entry</span>(<span class="ruby-identifier">matcher</span>)
89:       <span class="ruby-identifier">stream</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">entry</span><span class="ruby-operator">|</span>
90:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">matcher</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">full_name</span>
91:           <span class="ruby-comment cmt"># we can not return entry - after exiting stream.each the entry will be invalid and will read from tar start</span>
92:           <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">yield</span>(<span class="ruby-identifier">entry</span>)
93:         <span class="ruby-keyword kw">end</span>
94:       <span class="ruby-keyword kw">end</span>
95:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000040">
                    
                    <a name="M000040"></a><b>migrate_down</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000040_source')" id="l_M000040_source">show</a>
                        
                    </p>
                    <div id="M000040_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/dump_rake/dump_reader.rb, line 117</span>
117:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">migrate_down</span>
118:       <span class="ruby-keyword kw">case</span>
119:       <span class="ruby-keyword kw">when</span> <span class="ruby-constant">DumpRake</span><span class="ruby-operator">::</span><span class="ruby-constant">Env</span>.<span class="ruby-identifier">downcase</span>(<span class="ruby-identifier">:migrate_down</span>) <span class="ruby-operator">==</span> <span class="ruby-value str">'reset'</span>
120:         <span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">Task</span>[<span class="ruby-value str">'db:drop'</span>].<span class="ruby-identifier">invoke</span>
121:         <span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">Task</span>[<span class="ruby-value str">'db:create'</span>].<span class="ruby-identifier">invoke</span>
122:       <span class="ruby-keyword kw">when</span> <span class="ruby-operator">!</span><span class="ruby-constant">DumpRake</span><span class="ruby-operator">::</span><span class="ruby-constant">Env</span>.<span class="ruby-identifier">no?</span>(<span class="ruby-identifier">:migrate_down</span>)
123:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">avaliable_tables</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value str">'schema_migrations'</span>)
124:           <span class="ruby-identifier">find_entry</span>(<span class="ruby-value str">&quot;schema_migrations.dump&quot;</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">entry</span><span class="ruby-operator">|</span>
125:             <span class="ruby-identifier">migrated</span> = <span class="ruby-identifier">table_rows</span>(<span class="ruby-value str">'schema_migrations'</span>).<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">row</span><span class="ruby-operator">|</span> <span class="ruby-identifier">row</span>[<span class="ruby-value str">'version'</span>] }
126: 
127:             <span class="ruby-identifier">dump_migrations</span> = []
128:             <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">load</span>(<span class="ruby-identifier">entry</span>) <span class="ruby-comment cmt"># skip header</span>
129:             <span class="ruby-identifier">dump_migrations</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">load</span>(<span class="ruby-identifier">entry</span>).<span class="ruby-identifier">first</span> <span class="ruby-keyword kw">until</span> <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">eof?</span>
130: 
131:             <span class="ruby-identifier">migrate_down</span> = (<span class="ruby-identifier">migrated</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">dump_migrations</span>)
132: 
133:             <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">migrate_down</span>.<span class="ruby-identifier">empty?</span>
134:               <span class="ruby-identifier">migrate_down</span>.<span class="ruby-identifier">reverse</span>.<span class="ruby-identifier">with_progress</span>(<span class="ruby-value str">'Migrating down'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">version</span><span class="ruby-operator">|</span>
135:                 <span class="ruby-constant">DumpRake</span><span class="ruby-operator">::</span><span class="ruby-constant">Env</span>.<span class="ruby-identifier">with_env</span>(<span class="ruby-value str">'VERSION'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">version</span>) <span class="ruby-keyword kw">do</span>
136:                   <span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">Task</span>[<span class="ruby-value str">'db:migrate:down'</span>].<span class="ruby-identifier">tap</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">task</span><span class="ruby-operator">|</span>
137:                     <span class="ruby-keyword kw">begin</span>
138:                       <span class="ruby-identifier">task</span>.<span class="ruby-identifier">invoke</span>
139:                     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">IrreversibleMigration</span>
140:                       <span class="ruby-identifier">$stderr</span>.<span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Irreversible migration: #{version}&quot;</span>
141:                     <span class="ruby-keyword kw">end</span>
142:                     <span class="ruby-identifier">task</span>.<span class="ruby-identifier">reenable</span>
143:                   <span class="ruby-keyword kw">end</span>
144:                 <span class="ruby-keyword kw">end</span>
145:               <span class="ruby-keyword kw">end</span>
146:             <span class="ruby-keyword kw">end</span>
147:           <span class="ruby-keyword kw">end</span>
148:         <span class="ruby-keyword kw">end</span>
149:       <span class="ruby-keyword kw">end</span>
150:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000035">
                    
                    <a name="M000035"></a><b>open</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000035_source')" id="l_M000035_source">show</a>
                        
                    </p>
                    <div id="M000035_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/dump_rake/dump_reader.rb, line 79</span>
79:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">open</span>
80:       <span class="ruby-constant">Zlib</span><span class="ruby-operator">::</span><span class="ruby-constant">GzipReader</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">path</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">gzip</span><span class="ruby-operator">|</span>
81:         <span class="ruby-constant">Archive</span><span class="ruby-operator">::</span><span class="ruby-constant">Tar</span><span class="ruby-operator">::</span><span class="ruby-constant">Minitar</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">gzip</span>, <span class="ruby-value str">'r'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">stream</span><span class="ruby-operator">|</span>
82:           <span class="ruby-ivar">@stream</span> = <span class="ruby-identifier">stream</span>
83:           <span class="ruby-keyword kw">yield</span>(<span class="ruby-keyword kw">self</span>)
84:         <span class="ruby-keyword kw">end</span>
85:       <span class="ruby-keyword kw">end</span>
86:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000054">
                    
                    <a name="M000054"></a><b>read_asset?</b>(path, prefix)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000054_source')" id="l_M000054_source">show</a>
                        
                    </p>
                    <div id="M000054_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/dump_rake/dump_reader.rb, line 250</span>
250:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_asset?</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">prefix</span>)
251:       <span class="ruby-constant">DumpRake</span><span class="ruby-operator">::</span><span class="ruby-constant">Env</span>.<span class="ruby-identifier">filter</span>(<span class="ruby-identifier">:restore_assets</span>, <span class="ruby-constant">DumpRake</span><span class="ruby-operator">::</span><span class="ruby-constant">Assets</span><span class="ruby-operator">::</span><span class="ruby-constant">SPLITTER</span>).<span class="ruby-identifier">custom_pass?</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
252:         <span class="ruby-constant">File</span>.<span class="ruby-identifier">fnmatch</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">prefix</span>, <span class="ruby-identifier">value</span>), <span class="ruby-identifier">path</span>) <span class="ruby-operator">||</span>
253:         <span class="ruby-constant">File</span>.<span class="ruby-identifier">fnmatch</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">prefix</span>, <span class="ruby-identifier">value</span>, <span class="ruby-value str">'**'</span>), <span class="ruby-identifier">path</span>)
254:       <span class="ruby-keyword kw">end</span>
255:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000051">
                    
                    <a name="M000051"></a><b>read_assets</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000051_source')" id="l_M000051_source">show</a>
                        
                    </p>
                    <div id="M000051_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/dump_rake/dump_reader.rb, line 209</span>
209:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_assets</span>
210:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">config</span>[<span class="ruby-identifier">:assets</span>].<span class="ruby-identifier">blank?</span>
211:         <span class="ruby-identifier">assets</span> = <span class="ruby-identifier">config</span>[<span class="ruby-identifier">:assets</span>]
212:         <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Hash</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">assets</span>
213:           <span class="ruby-identifier">assets_count</span> = <span class="ruby-identifier">assets</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">sum</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">value</span><span class="ruby-operator">|</span> <span class="ruby-constant">Hash</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">value</span> <span class="ruby-value">? </span><span class="ruby-identifier">value</span>[<span class="ruby-identifier">:total</span>] <span class="ruby-operator">:</span> <span class="ruby-identifier">value</span> }
214:           <span class="ruby-identifier">assets_paths</span> = <span class="ruby-identifier">assets</span>.<span class="ruby-identifier">keys</span>
215:         <span class="ruby-keyword kw">else</span>
216:           <span class="ruby-identifier">assets_count</span>, <span class="ruby-identifier">assets_paths</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">assets</span>
217:         <span class="ruby-keyword kw">end</span>
218: 
219:         <span class="ruby-keyword kw">if</span> <span class="ruby-constant">DumpRake</span><span class="ruby-operator">::</span><span class="ruby-constant">Env</span>[<span class="ruby-identifier">:restore_assets</span>]
220:           <span class="ruby-identifier">assets_paths</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">asset</span><span class="ruby-operator">|</span>
221:             <span class="ruby-constant">DumpRake</span><span class="ruby-operator">::</span><span class="ruby-constant">Assets</span>.<span class="ruby-identifier">glob_asset_children</span>(<span class="ruby-identifier">asset</span>, <span class="ruby-value str">'**/*'</span>).<span class="ruby-identifier">reverse</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">child</span><span class="ruby-operator">|</span>
222:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">read_asset?</span>(<span class="ruby-identifier">child</span>, <span class="ruby-constant">DumpRake</span><span class="ruby-operator">::</span><span class="ruby-constant">RailsRoot</span>)
223:                 <span class="ruby-keyword kw">case</span>
224:                 <span class="ruby-keyword kw">when</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">file?</span>(<span class="ruby-identifier">child</span>)
225:                   <span class="ruby-constant">File</span>.<span class="ruby-identifier">unlink</span>(<span class="ruby-identifier">child</span>)
226:                 <span class="ruby-keyword kw">when</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">directory?</span>(<span class="ruby-identifier">child</span>)
227:                   <span class="ruby-keyword kw">begin</span>
228:                     <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">unlink</span>(<span class="ruby-identifier">child</span>)
229:                   <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ENOTEMPTY</span>
230:                     <span class="ruby-keyword kw">nil</span>
231:                   <span class="ruby-keyword kw">end</span>
232:                 <span class="ruby-keyword kw">end</span>
233:               <span class="ruby-keyword kw">end</span>
234:             <span class="ruby-keyword kw">end</span>
235:           <span class="ruby-keyword kw">end</span>
236:         <span class="ruby-keyword kw">else</span>
237:           <span class="ruby-constant">DumpRake</span><span class="ruby-operator">::</span><span class="ruby-constant">Env</span>.<span class="ruby-identifier">with_env</span>(<span class="ruby-identifier">:assets</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">assets_paths</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">':'</span>)) <span class="ruby-keyword kw">do</span>
238:             <span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">Task</span>[<span class="ruby-value str">'assets:delete'</span>].<span class="ruby-identifier">invoke</span>
239:           <span class="ruby-keyword kw">end</span>
240:         <span class="ruby-keyword kw">end</span>
241: 
242:         <span class="ruby-identifier">read_assets_entries</span>(<span class="ruby-identifier">assets_paths</span>, <span class="ruby-identifier">assets_count</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">stream</span>, <span class="ruby-identifier">root</span>, <span class="ruby-identifier">entry</span>, <span class="ruby-identifier">prefix</span><span class="ruby-operator">|</span>
243:           <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">DumpRake</span><span class="ruby-operator">::</span><span class="ruby-constant">Env</span>[<span class="ruby-identifier">:restore_assets</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">read_asset?</span>(<span class="ruby-identifier">entry</span>.<span class="ruby-identifier">full_name</span>, <span class="ruby-identifier">prefix</span>)
244:             <span class="ruby-identifier">stream</span>.<span class="ruby-identifier">extract_entry</span>(<span class="ruby-identifier">root</span>, <span class="ruby-identifier">entry</span>)
245:           <span class="ruby-keyword kw">end</span>
246:         <span class="ruby-keyword kw">end</span>
247:       <span class="ruby-keyword kw">end</span>
248:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000055">
                    
                    <a name="M000055"></a><b>read_assets_entries</b>(assets_paths, assets_count)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000055_source')" id="l_M000055_source">show</a>
                        
                    </p>
                    <div id="M000055_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/dump_rake/dump_reader.rb, line 257</span>
257:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_assets_entries</span>(<span class="ruby-identifier">assets_paths</span>, <span class="ruby-identifier">assets_count</span>)
258:       <span class="ruby-constant">Progress</span>.<span class="ruby-identifier">start</span>(<span class="ruby-value str">'Assets'</span>, <span class="ruby-identifier">assets_count</span> <span class="ruby-operator">||</span> <span class="ruby-value">1</span>) <span class="ruby-keyword kw">do</span>
259:         <span class="ruby-identifier">found_assets</span> = <span class="ruby-keyword kw">false</span>
260:         <span class="ruby-comment cmt"># old style — in separate tar</span>
261:         <span class="ruby-identifier">find_entry</span>(<span class="ruby-value str">'assets.tar'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">assets_tar</span><span class="ruby-operator">|</span>
262:           <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">assets_tar</span>.<span class="ruby-identifier">rewind</span>
263:             <span class="ruby-comment cmt"># rewind will fail - it must go to center of gzip</span>
264:             <span class="ruby-comment cmt"># also we don't need it - this is last step in dump restore</span>
265:           <span class="ruby-keyword kw">end</span>
266:           <span class="ruby-constant">Archive</span><span class="ruby-operator">::</span><span class="ruby-constant">Tar</span><span class="ruby-operator">::</span><span class="ruby-constant">Minitar</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">assets_tar</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">inp</span><span class="ruby-operator">|</span>
267:             <span class="ruby-identifier">inp</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">entry</span><span class="ruby-operator">|</span>
268:               <span class="ruby-keyword kw">yield</span> <span class="ruby-identifier">inp</span>, <span class="ruby-constant">DumpRake</span><span class="ruby-operator">::</span><span class="ruby-constant">RailsRoot</span>, <span class="ruby-identifier">entry</span>, <span class="ruby-keyword kw">nil</span>
269:               <span class="ruby-constant">Progress</span>.<span class="ruby-identifier">step</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">assets_count</span>
270:             <span class="ruby-keyword kw">end</span>
271:           <span class="ruby-keyword kw">end</span>
272:           <span class="ruby-identifier">found_assets</span> = <span class="ruby-keyword kw">true</span>
273:         <span class="ruby-keyword kw">end</span>
274: 
275:         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">found_assets</span>
276:           <span class="ruby-comment cmt"># new style — in same tar</span>
277:           <span class="ruby-identifier">assets_root_link</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">tmpdir</span>, <span class="ruby-identifier">prefix</span><span class="ruby-operator">|</span>
278:             <span class="ruby-identifier">stream</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">entry</span><span class="ruby-operator">|</span>
279:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">full_name</span>.<span class="ruby-identifier">starts_with?</span>(<span class="ruby-node">&quot;#{prefix}/&quot;</span>)
280:                 <span class="ruby-keyword kw">yield</span> <span class="ruby-identifier">stream</span>, <span class="ruby-identifier">tmpdir</span>, <span class="ruby-identifier">entry</span>, <span class="ruby-identifier">prefix</span>
281:                 <span class="ruby-constant">Progress</span>.<span class="ruby-identifier">step</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">assets_count</span>
282:               <span class="ruby-keyword kw">end</span>
283:             <span class="ruby-keyword kw">end</span>
284:           <span class="ruby-keyword kw">end</span>
285:         <span class="ruby-keyword kw">end</span>
286:       <span class="ruby-keyword kw">end</span>
287:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000039">
                    
                    <a name="M000039"></a><b>read_config</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000039_source')" id="l_M000039_source">show</a>
                        
                    </p>
                    <div id="M000039_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/dump_rake/dump_reader.rb, line 113</span>
113:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_config</span>
114:       <span class="ruby-ivar">@config</span> = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">load</span>(<span class="ruby-identifier">read_entry</span>(<span class="ruby-value str">'config'</span>))
115:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000037">
                    
                    <a name="M000037"></a><b>read_entry</b>(matcher)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000037_source')" id="l_M000037_source">show</a>
                        
                    </p>
                    <div id="M000037_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/dump_rake/dump_reader.rb, line 97</span>
 97:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_entry</span>(<span class="ruby-identifier">matcher</span>)
 98:       <span class="ruby-identifier">find_entry</span>(<span class="ruby-identifier">matcher</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">entry</span><span class="ruby-operator">|</span>
 99:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">read</span>
100:       <span class="ruby-keyword kw">end</span>
101:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000038">
                    
                    <a name="M000038"></a><b>read_entry_to_file</b>(matcher)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000038_source')" id="l_M000038_source">show</a>
                        
                    </p>
                    <div id="M000038_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/dump_rake/dump_reader.rb, line 103</span>
103:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_entry_to_file</span>(<span class="ruby-identifier">matcher</span>)
104:       <span class="ruby-identifier">find_entry</span>(<span class="ruby-identifier">matcher</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">entry</span><span class="ruby-operator">|</span>
105:         <span class="ruby-constant">Tempfile</span>.<span class="ruby-identifier">open</span>(<span class="ruby-value str">'dumper'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">temp</span><span class="ruby-operator">|</span>
106:           <span class="ruby-identifier">temp</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">entry</span>.<span class="ruby-identifier">read</span>(<span class="ruby-value">4096</span>)) <span class="ruby-keyword kw">until</span> <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">eof?</span>
107:           <span class="ruby-identifier">temp</span>.<span class="ruby-identifier">rewind</span>
108:           <span class="ruby-keyword kw">yield</span>(<span class="ruby-identifier">temp</span>)
109:         <span class="ruby-keyword kw">end</span>
110:       <span class="ruby-keyword kw">end</span>
111:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000042">
                    
                    <a name="M000042"></a><b>read_schema</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000042_source')" id="l_M000042_source">show</a>
                        
                    </p>
                    <div id="M000042_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/dump_rake/dump_reader.rb, line 156</span>
156:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_schema</span>
157:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">restore_schema?</span>
158:         <span class="ruby-identifier">read_entry_to_file</span>(<span class="ruby-value str">'schema.rb'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
159:           <span class="ruby-constant">DumpRake</span><span class="ruby-operator">::</span><span class="ruby-constant">Env</span>.<span class="ruby-identifier">with_env</span>(<span class="ruby-value str">'SCHEMA'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">path</span>) <span class="ruby-keyword kw">do</span>
160:             <span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">Task</span>[<span class="ruby-value str">'db:schema:load'</span>].<span class="ruby-identifier">invoke</span>
161:           <span class="ruby-keyword kw">end</span>
162:           <span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">Task</span>[<span class="ruby-value str">'db:schema:dump'</span>].<span class="ruby-identifier">invoke</span>
163:         <span class="ruby-keyword kw">end</span>
164:       <span class="ruby-keyword kw">end</span>
165:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000047">
                    
                    <a name="M000047"></a><b>read_table</b>(table, rows_count)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000047_source')" id="l_M000047_source">show</a>
                        
                    </p>
                    <div id="M000047_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/dump_rake/dump_reader.rb, line 180</span>
180:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_table</span>(<span class="ruby-identifier">table</span>, <span class="ruby-identifier">rows_count</span>)
181:       <span class="ruby-identifier">find_entry</span>(<span class="ruby-node">&quot;#{table}.dump&quot;</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">entry</span><span class="ruby-operator">|</span>
182:         <span class="ruby-identifier">table_sql</span> = <span class="ruby-identifier">quote_table_name</span>(<span class="ruby-identifier">table</span>)
183:         <span class="ruby-identifier">clear_table</span>(<span class="ruby-identifier">table_sql</span>)
184: 
185:         <span class="ruby-identifier">columns</span> = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">load</span>(<span class="ruby-identifier">entry</span>)
186:         <span class="ruby-identifier">columns_sql</span> = <span class="ruby-identifier">columns_insert_sql</span>(<span class="ruby-identifier">columns</span>)
187:         <span class="ruby-constant">Progress</span>.<span class="ruby-identifier">start</span>(<span class="ruby-identifier">table</span>, <span class="ruby-identifier">rows_count</span>) <span class="ruby-keyword kw">do</span>
188:           <span class="ruby-keyword kw">until</span> <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">eof?</span>
189:             <span class="ruby-identifier">rows_sql</span> = []
190:             <span class="ruby-value">1000</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword kw">do</span>
191:               <span class="ruby-identifier">rows_sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">values_insert_sql</span>(<span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">load</span>(<span class="ruby-identifier">entry</span>)) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">eof?</span>
192:             <span class="ruby-keyword kw">end</span>
193: 
194:             <span class="ruby-keyword kw">begin</span>
195:               <span class="ruby-identifier">insert_into_table</span>(<span class="ruby-identifier">table_sql</span>, <span class="ruby-identifier">columns_sql</span>, <span class="ruby-identifier">rows_sql</span>)
196:               <span class="ruby-constant">Progress</span>.<span class="ruby-identifier">step</span>(<span class="ruby-identifier">rows_sql</span>.<span class="ruby-identifier">length</span>)
197:             <span class="ruby-keyword kw">rescue</span>
198:               <span class="ruby-identifier">rows_sql</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">row_sql</span><span class="ruby-operator">|</span>
199:                 <span class="ruby-identifier">insert_into_table</span>(<span class="ruby-identifier">table_sql</span>, <span class="ruby-identifier">columns_sql</span>, <span class="ruby-identifier">row_sql</span>)
200:                 <span class="ruby-constant">Progress</span>.<span class="ruby-identifier">step</span>
201:               <span class="ruby-keyword kw">end</span>
202:             <span class="ruby-keyword kw">end</span>
203:           <span class="ruby-keyword kw">end</span>
204:         <span class="ruby-keyword kw">end</span>
205:         <span class="ruby-identifier">fix_sequence!</span>(<span class="ruby-identifier">table</span>)
206:       <span class="ruby-keyword kw">end</span>
207:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000044">
                    
                    <a name="M000044"></a><b>read_tables</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000044_source')" id="l_M000044_source">show</a>
                        
                    </p>
                    <div id="M000044_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/dump_rake/dump_reader.rb, line 171</span>
171:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_tables</span>
172:       <span class="ruby-identifier">verify_connection</span>
173:       <span class="ruby-identifier">config</span>[<span class="ruby-identifier">:tables</span>].<span class="ruby-identifier">with_progress</span>(<span class="ruby-value str">'Tables'</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">table</span>, <span class="ruby-identifier">rows</span><span class="ruby-operator">|</span>
174:         <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">restore_schema?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">schema_tables</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">table</span>)) <span class="ruby-operator">||</span> <span class="ruby-constant">DumpRake</span><span class="ruby-operator">::</span><span class="ruby-constant">Env</span>.<span class="ruby-identifier">filter</span>(<span class="ruby-identifier">:restore_tables</span>).<span class="ruby-identifier">pass?</span>(<span class="ruby-identifier">table</span>)
175:           <span class="ruby-identifier">read_table</span>(<span class="ruby-identifier">table</span>, <span class="ruby-identifier">rows</span>)
176:         <span class="ruby-keyword kw">end</span>
177:       <span class="ruby-keyword kw">end</span>
178:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000041">
                    
                    <a name="M000041"></a><b>restore_schema?</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000041_source')" id="l_M000041_source">show</a>
                        
                    </p>
                    <div id="M000041_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/dump_rake/dump_reader.rb, line 152</span>
152:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">restore_schema?</span>
153:       <span class="ruby-operator">!</span><span class="ruby-constant">DumpRake</span><span class="ruby-operator">::</span><span class="ruby-constant">Env</span>.<span class="ruby-identifier">no?</span>(<span class="ruby-identifier">:restore_schema</span>)
154:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000043">
                    
                    <a name="M000043"></a><b>schema</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000043_source')" id="l_M000043_source">show</a>
                        
                    </p>
                    <div id="M000043_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/dump_rake/dump_reader.rb, line 167</span>
167:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">schema</span>
168:       <span class="ruby-identifier">read_entry</span>(<span class="ruby-value str">'schema.rb'</span>)
169:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    