<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>CodeRay::Scanners::Ruby</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../../css/main.css" type="text/css" media="screen" />
    <script src="../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            CodeRay::Scanners::Ruby 
            
                <span class="parent">&lt; 
                    
                    Scanner
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../files/lib/coderay/scanners/ruby/string_state_rb.html">lib/coderay/scanners/ruby/string_state.rb</a></li>
            
            <li><a href="../../../files/lib/coderay/scanners/ruby_rb.html">lib/coderay/scanners/ruby.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
This scanner is really complex, since <a href="Ruby.html">Ruby</a>
<em>is</em> a complex language!
</p>
<p>
It tries to highlight 100% of all common code, and 90% of strange codes.
</p>
<p>
It is optimized for <a href="HTML.html">HTML</a> highlighting, and is not
very useful for parsing or pretty printing.
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>I</dt>
        <dd>
            <ul>
                
                <li><a href="#M000201">interpreted_string_state</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M000203">scan_tokens</a>,</li>
                
                <li><a href="#M000202">setup</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    
    <div class="sectiontitle">Classes and Modules</div>
    <ul>
        
        <li><span class="type">MODULE</span> <a href="Ruby/Patterns.html">CodeRay::Scanners::Ruby::Patterns</a></li>
        
        <li><span class="type">CLASS</span> <a href="Ruby/StringState.html">CodeRay::Scanners::Ruby::StringState</a></li>
        
    </ul>
    

    

    

    
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000201">
                    
                    <a name="M000201"></a><b>interpreted_string_state</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000201_source')" id="l_M000201_source">show</a>
                        
                    </p>
                    <div id="M000201_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/coderay/scanners/ruby.rb, line 19</span>
19:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">interpreted_string_state</span>
20:       <span class="ruby-constant">StringState</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">:string</span>, <span class="ruby-keyword kw">true</span>, <span class="ruby-value str">'&quot;'</span>
21:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Protected methods</div>
            
            <div class="method">
                <div class="title" id="M000203">
                    
                    <a name="M000203"></a><b>scan_tokens</b>(encoder, options)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000203_source')" id="l_M000203_source">show</a>
                        
                    </p>
                    <div id="M000203_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/coderay/scanners/ruby.rb, line 29</span>
 29:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">scan_tokens</span> <span class="ruby-identifier">encoder</span>, <span class="ruby-identifier">options</span>
 30:       <span class="ruby-identifier">state</span>, <span class="ruby-identifier">heredocs</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:state</span>] <span class="ruby-operator">||</span> <span class="ruby-ivar">@state</span>
 31:       <span class="ruby-identifier">heredocs</span> = <span class="ruby-identifier">heredocs</span>.<span class="ruby-identifier">dup</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">heredocs</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>)
 32:       
 33:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">state</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">instance_of?</span>(<span class="ruby-constant">StringState</span>)
 34:         <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">begin_group</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">type</span>
 35:       <span class="ruby-keyword kw">end</span>
 36:       
 37:       <span class="ruby-identifier">last_state</span> = <span class="ruby-keyword kw">nil</span>
 38:       
 39:       <span class="ruby-identifier">method_call_expected</span> = <span class="ruby-keyword kw">false</span>
 40:       <span class="ruby-identifier">value_expected</span> = <span class="ruby-keyword kw">true</span>
 41:       
 42:       <span class="ruby-identifier">inline_block_stack</span> = <span class="ruby-keyword kw">nil</span>
 43:       <span class="ruby-identifier">inline_block_curly_depth</span> = <span class="ruby-value">0</span>
 44:       
 45:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">heredocs</span>
 46:         <span class="ruby-identifier">state</span> = <span class="ruby-identifier">heredocs</span>.<span class="ruby-identifier">shift</span>
 47:         <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">begin_group</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">type</span>
 48:         <span class="ruby-identifier">heredocs</span> = <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">heredocs</span>.<span class="ruby-identifier">empty?</span>
 49:       <span class="ruby-keyword kw">end</span>
 50:       
 51:       <span class="ruby-comment cmt"># def_object_stack = nil</span>
 52:       <span class="ruby-comment cmt"># def_object_paren_depth = 0</span>
 53:       
 54:       <span class="ruby-identifier">patterns</span> = <span class="ruby-constant">Patterns</span>  <span class="ruby-comment cmt"># avoid constant lookup</span>
 55:       
 56:       <span class="ruby-identifier">unicode</span> = <span class="ruby-identifier">string</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:encoding</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">string</span>.<span class="ruby-identifier">encoding</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'UTF-8'</span>
 57:       
 58:       <span class="ruby-keyword kw">until</span> <span class="ruby-identifier">eos?</span>
 59:         
 60:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">instance_of?</span> <span class="ruby-operator">::</span><span class="ruby-constant">Symbol</span>
 61:           
 62:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-regexp re">/[ \t\f\v]+/</span>)
 63:             <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:space</span>
 64:             
 65:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-regexp re">/\n/</span>)
 66:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">heredocs</span>
 67:               <span class="ruby-identifier">unscan</span>  <span class="ruby-comment cmt"># heredoc scanning needs \n at start</span>
 68:               <span class="ruby-identifier">state</span> = <span class="ruby-identifier">heredocs</span>.<span class="ruby-identifier">shift</span>
 69:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">begin_group</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">type</span>
 70:               <span class="ruby-identifier">heredocs</span> = <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">heredocs</span>.<span class="ruby-identifier">empty?</span>
 71:             <span class="ruby-keyword kw">else</span>
 72:               <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:initial</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">state</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:undef_comma_expected</span>
 73:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:space</span>
 74:               <span class="ruby-identifier">value_expected</span> = <span class="ruby-keyword kw">true</span>
 75:             <span class="ruby-keyword kw">end</span>
 76:             
 77:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-identifier">bol?</span> <span class="ruby-value">? </span><span class="ruby-operator">/</span> \<span class="ruby-comment cmt">#(!)?.* | #{patterns::RUBYDOC_OR_DATA} /ox : /\#.*/)</span>
 78:             <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-keyword kw">self</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">:doctype</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">:comment</span>
 79:             
 80:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-regexp re">/\\\n/</span>)
 81:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">heredocs</span>
 82:               <span class="ruby-identifier">unscan</span>  <span class="ruby-comment cmt"># heredoc scanning needs \n at start</span>
 83:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">scan</span>(<span class="ruby-regexp re">/\\/</span>), <span class="ruby-identifier">:space</span>
 84:               <span class="ruby-identifier">state</span> = <span class="ruby-identifier">heredocs</span>.<span class="ruby-identifier">shift</span>
 85:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">begin_group</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">type</span>
 86:               <span class="ruby-identifier">heredocs</span> = <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">heredocs</span>.<span class="ruby-identifier">empty?</span>
 87:             <span class="ruby-keyword kw">else</span>
 88:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:space</span>
 89:             <span class="ruby-keyword kw">end</span>
 90:             
 91:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">state</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:initial</span>
 92:             
 93:             <span class="ruby-comment cmt"># IDENTS #</span>
 94:             <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">method_call_expected</span> <span class="ruby-operator">&amp;&amp;</span>
 95:                <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-identifier">unicode</span> <span class="ruby-value">? </span><span class="ruby-operator">/</span><span class="ruby-comment cmt">#{patterns::METHOD_NAME}/uo :</span>
 96:                                       <span class="ruby-node">/#{patterns::METHOD_NAME}/o</span>)
 97:               <span class="ruby-identifier">value_expected</span> = <span class="ruby-keyword kw">false</span>
 98:               <span class="ruby-identifier">kind</span> = <span class="ruby-identifier">patterns</span><span class="ruby-operator">::</span><span class="ruby-constant">IDENT_KIND</span>[<span class="ruby-identifier">match</span>]
 99:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">kind</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:ident</span>
100:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">match</span>[<span class="ruby-regexp re">/\A[A-Z]/</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">match</span>[<span class="ruby-regexp re">/[!?]$/</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">match?</span>(<span class="ruby-regexp re">/\(/</span>))
101:                   <span class="ruby-identifier">kind</span> = <span class="ruby-identifier">:constant</span>
102:                 <span class="ruby-keyword kw">end</span>
103:               <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">kind</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:keyword</span>
104:                 <span class="ruby-identifier">state</span> = <span class="ruby-identifier">patterns</span><span class="ruby-operator">::</span><span class="ruby-constant">KEYWORD_NEW_STATE</span>[<span class="ruby-identifier">match</span>]
105:                 <span class="ruby-identifier">value_expected</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">patterns</span><span class="ruby-operator">::</span><span class="ruby-constant">KEYWORDS_EXPECTING_VALUE</span>[<span class="ruby-identifier">match</span>]
106:               <span class="ruby-keyword kw">end</span>
107:               <span class="ruby-identifier">value_expected</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">value_expected</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">check</span>(<span class="ruby-node">/#{patterns::VALUE_FOLLOWS}/o</span>)
108:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">kind</span>
109:               
110:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">method_call_expected</span> <span class="ruby-operator">&amp;&amp;</span>
111:                <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-identifier">unicode</span> <span class="ruby-value">? </span><span class="ruby-operator">/</span><span class="ruby-comment cmt">#{patterns::METHOD_AFTER_DOT}/uo :</span>
112:                                       <span class="ruby-node">/#{patterns::METHOD_AFTER_DOT}/o</span>)
113:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">method_call_expected</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'::'</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">match</span>[<span class="ruby-regexp re">/\A[A-Z]/</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">match?</span>(<span class="ruby-regexp re">/\(/</span>)
114:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:constant</span>
115:               <span class="ruby-keyword kw">else</span>
116:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:ident</span>
117:               <span class="ruby-keyword kw">end</span>
118:               <span class="ruby-identifier">method_call_expected</span> = <span class="ruby-keyword kw">false</span>
119:               <span class="ruby-identifier">value_expected</span> = <span class="ruby-identifier">check</span>(<span class="ruby-node">/#{patterns::VALUE_FOLLOWS}/o</span>)
120:               
121:             <span class="ruby-comment cmt"># OPERATORS #</span>
122:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">method_call_expected</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-regexp re">/ (\.(?!\.)|::) | (?: \.\.\.? | ==?=? | [,\(\[\{] )() | [\)\]\}] /</span><span class="ruby-identifier">x</span>)
123:               <span class="ruby-identifier">method_call_expected</span> = <span class="ruby-keyword kw">self</span>[<span class="ruby-value">1</span>]
124:               <span class="ruby-identifier">value_expected</span> = <span class="ruby-operator">!</span><span class="ruby-identifier">method_call_expected</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword kw">self</span>[<span class="ruby-value">2</span>]
125:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">inline_block_stack</span>
126:                 <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">match</span>
127:                 <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'{'</span>
128:                   <span class="ruby-identifier">inline_block_curly_depth</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
129:                 <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'}'</span>
130:                   <span class="ruby-identifier">inline_block_curly_depth</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
131:                   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">inline_block_curly_depth</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>  <span class="ruby-comment cmt"># closing brace of inline block reached</span>
132:                     <span class="ruby-identifier">state</span>, <span class="ruby-identifier">inline_block_curly_depth</span>, <span class="ruby-identifier">heredocs</span> = <span class="ruby-identifier">inline_block_stack</span>.<span class="ruby-identifier">pop</span>
133:                     <span class="ruby-identifier">inline_block_stack</span> = <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">inline_block_stack</span>.<span class="ruby-identifier">empty?</span>
134:                     <span class="ruby-identifier">heredocs</span> = <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">heredocs</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">heredocs</span>.<span class="ruby-identifier">empty?</span>
135:                     <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:inline_delimiter</span>
136:                     <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">end_group</span> <span class="ruby-identifier">:inline</span>
137:                     <span class="ruby-keyword kw">next</span>
138:                   <span class="ruby-keyword kw">end</span>
139:                 <span class="ruby-keyword kw">end</span>
140:               <span class="ruby-keyword kw">end</span>
141:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:operator</span>
142:               
143:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-identifier">unicode</span> <span class="ruby-value">? </span><span class="ruby-operator">/</span><span class="ruby-comment cmt">#{patterns::SYMBOL}/uo :</span>
144:                                          <span class="ruby-node">/#{patterns::SYMBOL}/o</span>)
145:               <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">delim</span> = <span class="ruby-identifier">match</span>[<span class="ruby-value">1</span>]
146:               <span class="ruby-keyword kw">when</span> <span class="ruby-value">?'</span>, <span class="ruby-value">?&quot;</span>
147:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">begin_group</span> <span class="ruby-identifier">:symbol</span>
148:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-value str">':'</span>, <span class="ruby-identifier">:symbol</span>
149:                 <span class="ruby-identifier">match</span> = <span class="ruby-identifier">delim</span>.<span class="ruby-identifier">chr</span>
150:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:delimiter</span>
151:                 <span class="ruby-identifier">state</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span><span class="ruby-operator">::</span><span class="ruby-constant">StringState</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">:symbol</span>, <span class="ruby-identifier">delim</span> <span class="ruby-operator">==</span> <span class="ruby-value">?&quot;</span>, <span class="ruby-identifier">match</span>
152:               <span class="ruby-keyword kw">else</span>
153:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:symbol</span>
154:                 <span class="ruby-identifier">value_expected</span> = <span class="ruby-keyword kw">false</span>
155:               <span class="ruby-keyword kw">end</span>
156:               
157:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-regexp re">/ ' (?:(?&gt;[^'\\]*) ')? | &quot; (?:(?&gt;[^&quot;\\\#]*) &quot;)? /</span><span class="ruby-identifier">mx</span>)
158:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">begin_group</span> <span class="ruby-identifier">:string</span>
159:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">match</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
160:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:delimiter</span>
161:                 <span class="ruby-identifier">state</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span><span class="ruby-operator">::</span><span class="ruby-constant">StringState</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">:string</span>, <span class="ruby-identifier">match</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'&quot;'</span>, <span class="ruby-identifier">match</span>  <span class="ruby-comment cmt"># important for streaming</span>
162:               <span class="ruby-keyword kw">else</span>
163:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>[<span class="ruby-value">0</span>,<span class="ruby-value">1</span>], <span class="ruby-identifier">:delimiter</span>
164:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>], <span class="ruby-identifier">:content</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">match</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span>
165:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>[<span class="ruby-value">-1</span>,<span class="ruby-value">1</span>], <span class="ruby-identifier">:delimiter</span>
166:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">end_group</span> <span class="ruby-identifier">:string</span>
167:                 <span class="ruby-identifier">value_expected</span> = <span class="ruby-keyword kw">false</span>
168:               <span class="ruby-keyword kw">end</span>
169:               
170:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-identifier">unicode</span> <span class="ruby-value">? </span><span class="ruby-operator">/</span><span class="ruby-comment cmt">#{patterns::INSTANCE_VARIABLE}/uo :</span>
171:                                          <span class="ruby-node">/#{patterns::INSTANCE_VARIABLE}/o</span>)
172:               <span class="ruby-identifier">value_expected</span> = <span class="ruby-keyword kw">false</span>
173:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:instance_variable</span>
174:               
175:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">value_expected</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-regexp re">/\//</span>)
176:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">begin_group</span> <span class="ruby-identifier">:regexp</span>
177:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:delimiter</span>
178:               <span class="ruby-identifier">state</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span><span class="ruby-operator">::</span><span class="ruby-constant">StringState</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">:regexp</span>, <span class="ruby-keyword kw">true</span>, <span class="ruby-value str">'/'</span>
179:               
180:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-identifier">value_expected</span> <span class="ruby-value">? </span><span class="ruby-operator">/</span>[<span class="ruby-operator">-</span><span class="ruby-operator">+</span>]<span class="ruby-operator">?</span><span class="ruby-comment cmt">#{patterns::NUMERIC}/o : /#{patterns::NUMERIC}/o)</span>
181:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">method_call_expected</span>
182:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:error</span>
183:                 <span class="ruby-identifier">method_call_expected</span> = <span class="ruby-keyword kw">false</span>
184:               <span class="ruby-keyword kw">else</span>
185:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-keyword kw">self</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">:float</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">:integer</span>  <span class="ruby-comment cmt"># TODO: send :hex/:octal/:binary</span>
186:               <span class="ruby-keyword kw">end</span>
187:               <span class="ruby-identifier">value_expected</span> = <span class="ruby-keyword kw">false</span>
188:               
189:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-regexp re">/ [-+!~^\/]=? | [:;] | [*|&amp;]{1,2}=? | &gt;&gt;? /</span><span class="ruby-identifier">x</span>)
190:               <span class="ruby-identifier">value_expected</span> = <span class="ruby-keyword kw">true</span>
191:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:operator</span>
192:               
193:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">value_expected</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-node">/#{patterns::HEREDOC_OPEN}/o</span>)
194:               <span class="ruby-identifier">quote</span> = <span class="ruby-keyword kw">self</span>[<span class="ruby-value">3</span>]
195:               <span class="ruby-identifier">delim</span> = <span class="ruby-keyword kw">self</span>[<span class="ruby-identifier">quote</span> <span class="ruby-value">? </span><span class="ruby-value">4</span> <span class="ruby-operator">:</span> <span class="ruby-value">2</span>]
196:               <span class="ruby-identifier">kind</span> = <span class="ruby-identifier">patterns</span><span class="ruby-operator">::</span><span class="ruby-constant">QUOTE_TO_TYPE</span>[<span class="ruby-identifier">quote</span>]
197:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">begin_group</span> <span class="ruby-identifier">kind</span>
198:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:delimiter</span>
199:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">end_group</span> <span class="ruby-identifier">kind</span>
200:               <span class="ruby-identifier">heredocs</span> <span class="ruby-operator">||=</span> []  <span class="ruby-comment cmt"># create heredocs if empty</span>
201:               <span class="ruby-identifier">heredocs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span><span class="ruby-operator">::</span><span class="ruby-constant">StringState</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">kind</span>, <span class="ruby-identifier">quote</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;'&quot;</span>, <span class="ruby-identifier">delim</span>,
202:                 <span class="ruby-keyword kw">self</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'-'</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">:indented</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">:linestart</span>)
203:               <span class="ruby-identifier">value_expected</span> = <span class="ruby-keyword kw">false</span>
204:               
205:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">value_expected</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-node">/#{patterns::FANCY_STRING_START}/o</span>)
206:               <span class="ruby-identifier">kind</span> = <span class="ruby-identifier">patterns</span><span class="ruby-operator">::</span><span class="ruby-constant">FANCY_STRING_KIND</span>[<span class="ruby-keyword kw">self</span>[<span class="ruby-value">1</span>]]
207:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">begin_group</span> <span class="ruby-identifier">kind</span>
208:               <span class="ruby-identifier">state</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span><span class="ruby-operator">::</span><span class="ruby-constant">StringState</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">kind</span>, <span class="ruby-identifier">patterns</span><span class="ruby-operator">::</span><span class="ruby-constant">FANCY_STRING_INTERPRETED</span>[<span class="ruby-keyword kw">self</span>[<span class="ruby-value">1</span>]], <span class="ruby-keyword kw">self</span>[<span class="ruby-value">2</span>]
209:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:delimiter</span>
210:               
211:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">value_expected</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-node">/#{patterns::CHARACTER}/o</span>)
212:               <span class="ruby-identifier">value_expected</span> = <span class="ruby-keyword kw">false</span>
213:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:integer</span>
214:               
215:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-regexp re">/ %=? | &lt;(?:&lt;|=&gt;?)? | \? /</span><span class="ruby-identifier">x</span>)
216:               <span class="ruby-identifier">value_expected</span> = <span class="ruby-keyword kw">true</span>
217:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:operator</span>
218:               
219:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-regexp re">/`/</span>)
220:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">begin_group</span> <span class="ruby-identifier">:shell</span>
221:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:delimiter</span>
222:               <span class="ruby-identifier">state</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span><span class="ruby-operator">::</span><span class="ruby-constant">StringState</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">:shell</span>, <span class="ruby-keyword kw">true</span>, <span class="ruby-identifier">match</span>
223:               
224:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-identifier">unicode</span> <span class="ruby-value">? </span><span class="ruby-operator">/</span><span class="ruby-comment cmt">#{patterns::GLOBAL_VARIABLE}/uo :</span>
225:                                          <span class="ruby-node">/#{patterns::GLOBAL_VARIABLE}/o</span>)
226:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:global_variable</span>
227:               <span class="ruby-identifier">value_expected</span> = <span class="ruby-keyword kw">false</span>
228:               
229:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-identifier">unicode</span> <span class="ruby-value">? </span><span class="ruby-operator">/</span><span class="ruby-comment cmt">#{patterns::CLASS_VARIABLE}/uo :</span>
230:                                          <span class="ruby-node">/#{patterns::CLASS_VARIABLE}/o</span>)
231:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:class_variable</span>
232:               <span class="ruby-identifier">value_expected</span> = <span class="ruby-keyword kw">false</span>
233:               
234:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-regexp re">/\\\z/</span>)
235:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:space</span>
236:               
237:             <span class="ruby-keyword kw">else</span>
238:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">method_call_expected</span>
239:                 <span class="ruby-identifier">method_call_expected</span> = <span class="ruby-keyword kw">false</span>
240:                 <span class="ruby-keyword kw">next</span>
241:               <span class="ruby-keyword kw">end</span>
242:               <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">unicode</span>
243:                 <span class="ruby-comment cmt"># check for unicode</span>
244:                 <span class="ruby-identifier">$DEBUG_BEFORE</span>, <span class="ruby-identifier">$DEBUG</span> = <span class="ruby-identifier">$DEBUG</span>, <span class="ruby-keyword kw">false</span>
245:                 <span class="ruby-keyword kw">begin</span>
246:                   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">check</span>(<span class="ruby-regexp re">/./</span><span class="ruby-identifier">mu</span>).<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
247:                     <span class="ruby-comment cmt"># seems like we should try again with unicode</span>
248:                     <span class="ruby-identifier">unicode</span> = <span class="ruby-keyword kw">true</span>
249:                   <span class="ruby-keyword kw">end</span>
250:                 <span class="ruby-keyword kw">rescue</span>
251:                   <span class="ruby-comment cmt"># bad unicode char; use getch</span>
252:                 <span class="ruby-keyword kw">ensure</span>
253:                   <span class="ruby-identifier">$DEBUG</span> = <span class="ruby-identifier">$DEBUG_BEFORE</span>
254:                 <span class="ruby-keyword kw">end</span>
255:                 <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">unicode</span>
256:               <span class="ruby-keyword kw">end</span>
257:               
258:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">getch</span>, <span class="ruby-identifier">:error</span>
259:               
260:             <span class="ruby-keyword kw">end</span>
261:             
262:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">last_state</span>
263:               <span class="ruby-identifier">state</span> = <span class="ruby-identifier">last_state</span>
264:               <span class="ruby-identifier">last_state</span> = <span class="ruby-keyword kw">nil</span>
265:             <span class="ruby-keyword kw">end</span>
266:             
267:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">state</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:def_expected</span>
268:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-identifier">unicode</span> <span class="ruby-value">? </span><span class="ruby-operator">/</span>(<span class="ruby-value">?&gt;</span><span class="ruby-comment cmt">#{patterns::METHOD_NAME_EX})(?!\.|::)/uo :</span>
269:                                       <span class="ruby-node">/(?&gt;#{patterns::METHOD_NAME_EX})(?!\.|::)/o</span>)
270:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:method</span>
271:               <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:initial</span>
272:             <span class="ruby-keyword kw">else</span>
273:               <span class="ruby-identifier">last_state</span> = <span class="ruby-identifier">:dot_expected</span>
274:               <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:initial</span>
275:             <span class="ruby-keyword kw">end</span>
276:             
277:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">state</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:dot_expected</span>
278:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-regexp re">/\.|::/</span>)
279:               <span class="ruby-comment cmt"># invalid definition</span>
280:               <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:def_expected</span>
281:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:operator</span>
282:             <span class="ruby-keyword kw">else</span>
283:               <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:initial</span>
284:             <span class="ruby-keyword kw">end</span>
285:             
286:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">state</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:module_expected</span>
287:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-regexp re">/&lt;&lt;/</span>)
288:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:operator</span>
289:             <span class="ruby-keyword kw">else</span>
290:               <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:initial</span>
291:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-identifier">unicode</span> <span class="ruby-value">? </span><span class="ruby-operator">/</span> (<span class="ruby-value">?:</span><span class="ruby-comment cmt">#{patterns::IDENT}::)* #{patterns::IDENT} /oux :</span>
292:                                         <span class="ruby-node">/ (?:#{patterns::IDENT}::)* #{patterns::IDENT} /o</span><span class="ruby-identifier">x</span>)
293:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:class</span>
294:               <span class="ruby-keyword kw">end</span>
295:             <span class="ruby-keyword kw">end</span>
296:             
297:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">state</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:undef_expected</span>
298:             <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:undef_comma_expected</span>
299:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-identifier">unicode</span> <span class="ruby-value">? </span><span class="ruby-operator">/</span>(<span class="ruby-value">?&gt;</span><span class="ruby-comment cmt">#{patterns::METHOD_NAME_EX})(?!\.|::)/uo :</span>
300:                                       <span class="ruby-node">/(?&gt;#{patterns::METHOD_NAME_EX})(?!\.|::)/o</span>)
301:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:method</span>
302:             <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-node">/#{patterns::SYMBOL}/o</span>)
303:               <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">delim</span> = <span class="ruby-identifier">match</span>[<span class="ruby-value">1</span>]
304:               <span class="ruby-keyword kw">when</span> <span class="ruby-value">?'</span>, <span class="ruby-value">?&quot;</span>
305:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">begin_group</span> <span class="ruby-identifier">:symbol</span>
306:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-value str">':'</span>, <span class="ruby-identifier">:symbol</span>
307:                 <span class="ruby-identifier">match</span> = <span class="ruby-identifier">delim</span>.<span class="ruby-identifier">chr</span>
308:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:delimiter</span>
309:                 <span class="ruby-identifier">state</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span><span class="ruby-operator">::</span><span class="ruby-constant">StringState</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">:symbol</span>, <span class="ruby-identifier">delim</span> <span class="ruby-operator">==</span> <span class="ruby-value">?&quot;</span>, <span class="ruby-identifier">match</span>
310:                 <span class="ruby-identifier">state</span>.<span class="ruby-identifier">next_state</span> = <span class="ruby-identifier">:undef_comma_expected</span>
311:               <span class="ruby-keyword kw">else</span>
312:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:symbol</span>
313:               <span class="ruby-keyword kw">end</span>
314:             <span class="ruby-keyword kw">else</span>
315:               <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:initial</span>
316:             <span class="ruby-keyword kw">end</span>
317:             
318:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">state</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:undef_comma_expected</span>
319:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-regexp re">/,/</span>)
320:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:operator</span>
321:               <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:undef_expected</span>
322:             <span class="ruby-keyword kw">else</span>
323:               <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:initial</span>
324:             <span class="ruby-keyword kw">end</span>
325:             
326:           <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">state</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:alias_expected</span>
327:             <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-identifier">unicode</span> <span class="ruby-value">? </span><span class="ruby-operator">/</span>(<span class="ruby-comment cmt">#{patterns::METHOD_NAME_OR_SYMBOL})([ \t]+)(#{patterns::METHOD_NAME_OR_SYMBOL})/uo :</span>
328:                                    <span class="ruby-node">/(#{patterns::METHOD_NAME_OR_SYMBOL})([ \t]+)(#{patterns::METHOD_NAME_OR_SYMBOL})/o</span>)
329:             
330:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">match</span>
331:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-keyword kw">self</span>[<span class="ruby-value">1</span>], (<span class="ruby-keyword kw">self</span>[<span class="ruby-value">1</span>][<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">?:</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">:symbol</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">:method</span>)
332:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-keyword kw">self</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">:space</span>
333:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-keyword kw">self</span>[<span class="ruby-value">3</span>], (<span class="ruby-keyword kw">self</span>[<span class="ruby-value">3</span>][<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">?:</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">:symbol</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">:method</span>)
334:             <span class="ruby-keyword kw">end</span>
335:             <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:initial</span>
336:             
337:           <span class="ruby-keyword kw">else</span>
338:             <span class="ruby-comment cmt">#:nocov:</span>
339:             <span class="ruby-identifier">raise_inspect</span> <span class="ruby-value str">'Unknown state: %p'</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">state</span>], <span class="ruby-identifier">encoder</span>
340:             <span class="ruby-comment cmt">#:nocov:</span>
341:           <span class="ruby-keyword kw">end</span>
342:           
343:         <span class="ruby-keyword kw">else</span>  <span class="ruby-comment cmt"># StringState</span>
344:           
345:           <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan_until</span>(<span class="ruby-identifier">state</span>.<span class="ruby-identifier">pattern</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">scan_rest</span>
346:           <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">match</span>.<span class="ruby-identifier">empty?</span>
347:             <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:content</span>
348:             <span class="ruby-keyword kw">break</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">eos?</span>
349:           <span class="ruby-keyword kw">end</span>
350:           
351:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">heredoc</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword kw">self</span>[<span class="ruby-value">1</span>]  <span class="ruby-comment cmt"># end of heredoc</span>
352:             <span class="ruby-identifier">match</span> = <span class="ruby-identifier">getch</span>
353:             <span class="ruby-identifier">match</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">scan_until</span>(<span class="ruby-regexp re">/$/</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">eos?</span>
354:             <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:delimiter</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">match</span>.<span class="ruby-identifier">empty?</span>
355:             <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">end_group</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">type</span>
356:             <span class="ruby-identifier">state</span> = <span class="ruby-identifier">state</span>.<span class="ruby-identifier">next_state</span>
357:             <span class="ruby-keyword kw">next</span>
358:           <span class="ruby-keyword kw">end</span>
359:           
360:           <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">getch</span>
361:           
362:           <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">delim</span>
363:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">paren_depth</span>
364:               <span class="ruby-identifier">state</span>.<span class="ruby-identifier">paren_depth</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
365:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">paren_depth</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
366:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:content</span>
367:                 <span class="ruby-keyword kw">next</span>
368:               <span class="ruby-keyword kw">end</span>
369:             <span class="ruby-keyword kw">end</span>
370:             <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:delimiter</span>
371:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:regexp</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">eos?</span>
372:               <span class="ruby-identifier">match</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-node">/#{patterns::REGEXP_MODIFIERS}/o</span>)
373:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:modifier</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">match</span>.<span class="ruby-identifier">empty?</span>
374:             <span class="ruby-keyword kw">end</span>
375:             <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">end_group</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">type</span>
376:             <span class="ruby-identifier">value_expected</span> = <span class="ruby-keyword kw">false</span>
377:             <span class="ruby-identifier">state</span> = <span class="ruby-identifier">state</span>.<span class="ruby-identifier">next_state</span>
378:             
379:           <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'\\'</span>
380:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">interpreted</span>
381:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">esc</span> = <span class="ruby-identifier">scan</span>(<span class="ruby-node">/#{patterns::ESCAPE}/o</span>)
382:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">esc</span>, <span class="ruby-identifier">:char</span>
383:               <span class="ruby-keyword kw">else</span>
384:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:error</span>
385:               <span class="ruby-keyword kw">end</span>
386:             <span class="ruby-keyword kw">else</span>
387:               <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">esc</span> = <span class="ruby-identifier">getch</span>
388:               <span class="ruby-keyword kw">when</span> <span class="ruby-keyword kw">nil</span>
389:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:content</span>
390:               <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">delim</span>, <span class="ruby-value str">'\\'</span>
391:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">esc</span>, <span class="ruby-identifier">:char</span>
392:               <span class="ruby-keyword kw">else</span>
393:                 <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">esc</span>, <span class="ruby-identifier">:content</span>
394:               <span class="ruby-keyword kw">end</span>
395:             <span class="ruby-keyword kw">end</span>
396:             
397:           <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'#'</span>
398:             <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">peek</span>(<span class="ruby-value">1</span>)
399:             <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'{'</span>
400:               <span class="ruby-identifier">inline_block_stack</span> <span class="ruby-operator">||=</span> []
401:               <span class="ruby-identifier">inline_block_stack</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">state</span>, <span class="ruby-identifier">inline_block_curly_depth</span>, <span class="ruby-identifier">heredocs</span>]
402:               <span class="ruby-identifier">value_expected</span> = <span class="ruby-keyword kw">true</span>
403:               <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:initial</span>
404:               <span class="ruby-identifier">inline_block_curly_depth</span> = <span class="ruby-value">1</span>
405:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">begin_group</span> <span class="ruby-identifier">:inline</span>
406:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">getch</span>, <span class="ruby-identifier">:inline_delimiter</span>
407:             <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'$'</span>, <span class="ruby-value str">'@'</span>
408:               <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:escape</span>
409:               <span class="ruby-identifier">last_state</span> = <span class="ruby-identifier">state</span>
410:               <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:initial</span>
411:             <span class="ruby-keyword kw">else</span>
412:               <span class="ruby-comment cmt">#:nocov:</span>
413:               <span class="ruby-identifier">raise_inspect</span> <span class="ruby-value str">'else-case # reached; #%p not handled'</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">peek</span>(<span class="ruby-value">1</span>)], <span class="ruby-identifier">encoder</span>
414:               <span class="ruby-comment cmt">#:nocov:</span>
415:             <span class="ruby-keyword kw">end</span>
416:             
417:           <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">opening_paren</span>
418:             <span class="ruby-identifier">state</span>.<span class="ruby-identifier">paren_depth</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
419:             <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">text_token</span> <span class="ruby-identifier">match</span>, <span class="ruby-identifier">:content</span>
420:             
421:           <span class="ruby-keyword kw">else</span>
422:             <span class="ruby-comment cmt">#:nocov</span>
423:             <span class="ruby-identifier">raise_inspect</span> <span class="ruby-value str">'else-case &quot; reached; %p not handled, state = %p'</span> <span class="ruby-operator">%</span> [<span class="ruby-identifier">match</span>, <span class="ruby-identifier">state</span>], <span class="ruby-identifier">encoder</span>
424:             <span class="ruby-comment cmt">#:nocov:</span>
425:             
426:           <span class="ruby-keyword kw">end</span>
427:           
428:         <span class="ruby-keyword kw">end</span>
429:         
430:       <span class="ruby-keyword kw">end</span>
431:       
432:       <span class="ruby-comment cmt"># cleaning up</span>
433:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">StringState</span>
434:         <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">end_group</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">type</span>
435:       <span class="ruby-keyword kw">end</span>
436:       
437:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:keep_state</span>]
438:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">StringState</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">heredoc</span>
439:           (<span class="ruby-identifier">heredocs</span> <span class="ruby-operator">||=</span> []).<span class="ruby-identifier">unshift</span> <span class="ruby-identifier">state</span>
440:           <span class="ruby-identifier">state</span> = <span class="ruby-identifier">:initial</span>
441:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">heredocs</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">heredocs</span>.<span class="ruby-identifier">empty?</span>
442:           <span class="ruby-identifier">heredocs</span> = <span class="ruby-keyword kw">nil</span>
443:         <span class="ruby-keyword kw">end</span>
444:         <span class="ruby-ivar">@state</span> = <span class="ruby-identifier">state</span>, <span class="ruby-identifier">heredocs</span>
445:       <span class="ruby-keyword kw">end</span>
446:       
447:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">inline_block_stack</span>
448:         <span class="ruby-keyword kw">until</span> <span class="ruby-identifier">inline_block_stack</span>.<span class="ruby-identifier">empty?</span>
449:           <span class="ruby-identifier">state</span>, = <span class="ruby-operator">*</span><span class="ruby-identifier">inline_block_stack</span>.<span class="ruby-identifier">pop</span>
450:           <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">end_group</span> <span class="ruby-identifier">:inline</span>
451:           <span class="ruby-identifier">encoder</span>.<span class="ruby-identifier">end_group</span> <span class="ruby-identifier">state</span>.<span class="ruby-identifier">type</span>
452:         <span class="ruby-keyword kw">end</span>
453:       <span class="ruby-keyword kw">end</span>
454:       
455:       <span class="ruby-identifier">encoder</span>
456:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000202">
                    
                    <a name="M000202"></a><b>setup</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000202_source')" id="l_M000202_source">show</a>
                        
                    </p>
                    <div id="M000202_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/coderay/scanners/ruby.rb, line 25</span>
25:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">setup</span>
26:       <span class="ruby-ivar">@state</span> = <span class="ruby-identifier">:initial</span>
27:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    