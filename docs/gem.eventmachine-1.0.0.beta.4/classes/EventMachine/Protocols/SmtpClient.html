<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>EventMachine::Protocols::SmtpClient</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../../css/main.css" type="text/css" media="screen" />
    <script src="../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            EventMachine::Protocols::SmtpClient 
            
                <span class="parent">&lt; 
                    
                    Connection
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../files/lib/em/protocols/smtpclient_rb.html">lib/em/protocols/smtpclient.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
Simple SMTP client
</p>
<p>
@example
</p>
<pre>
 email = EM::Protocols::SmtpClient.send(
   :domain=&gt;&quot;example.com&quot;,
   :host=&gt;'localhost',
   :port=&gt;25, # optional, defaults 25
   :starttls=&gt;true, # use ssl
   :from=&gt;&quot;sender@example.com&quot;,
   :to=&gt; [&quot;to_1@example.com&quot;, &quot;to_2@example.com&quot;],
   :header=&gt; {&quot;Subject&quot; =&gt; &quot;This is a subject line&quot;},
   :body=&gt; &quot;This is the body of the email&quot;
 )
 email.callback{
   puts 'Email sent!'
 }
 email.errback{ |e|
   puts 'Email failed!'
 }
</pre>
<p>
Sending generated emails (using mailfactory)
</p>
<pre>
 mail = MailFactory.new
 mail.to = 'someone@site.co'
 mail.from = 'me@site.com'
 mail.subject = 'hi!'
 mail.text = 'hello world'
 mail.html = '&lt;h1&gt;hello world&lt;/h1&gt;'

 email = EM::P::SmtpClient.send(
   :domain=&gt;'site.com',
   :from=&gt;mail.from,
   :to=&gt;mail.to,
   :content=&gt;&quot;#{mail.to_s}\r\n.\r\n&quot;
 )
</pre>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M000217">connection_completed</a></li>
                
            </ul>
        </dd>
    
        <dt>I</dt>
        <dd>
            <ul>
                
                <li><a href="#M000232">invoke_auth</a>,</li>
                
                <li><a href="#M000244">invoke_data</a>,</li>
                
                <li><a href="#M000220">invoke_error</a>,</li>
                
                <li><a href="#M000224">invoke_internal_error</a>,</li>
                
                <li><a href="#M000237">invoke_mail_from</a>,</li>
                
                <li><a href="#M000239">invoke_rcpt_to</a>,</li>
                
                <li><a href="#M000230">invoke_starttls</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M000214">new</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M000216">post_init</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000236">receive_auth_response</a>,</li>
                
                <li><a href="#M000245">receive_data_response</a>,</li>
                
                <li><a href="#M000229">receive_ehlo_response</a>,</li>
                
                <li><a href="#M000219">receive_line</a>,</li>
                
                <li><a href="#M000238">receive_mail_from_response</a>,</li>
                
                <li><a href="#M000248">receive_message_response</a>,</li>
                
                <li><a href="#M000242">receive_rcpt_to_response</a>,</li>
                
                <li><a href="#M000228">receive_signon</a>,</li>
                
                <li><a href="#M000231">receive_starttls_response</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M000215">send</a></li>
                
            </ul>
        </dd>
    
        <dt>U</dt>
        <dd>
            <ul>
                
                <li><a href="#M000218">unbind</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    
    <div class="sectiontitle">Included Modules</div>
    <ul>
        
        <li>
            
            <a href="../UuidGenerator.html">EventMachine::UuidGenerator</a>
            
            START:includes
        </li>
        
        <li>
            
            <a href="../UuidGenerator.html">EventMachine::UuidGenerator</a>
            
            START:includes
        </li>
        
    </ul>
    

    

    

    

    
    <div class="sectiontitle">Attributes</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [W]
            </td>
            <td class='attr-name'>args</td>
            <td class='attr-desc'></td>
        </tr>
        
    </table>
    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M000214">
                    
                    <a name="M000214"></a><b>new</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000214_source')" id="l_M000214_source">show</a>
                        
                    </p>
                    <div id="M000214_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 71</span>
71:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>
72:         <span class="ruby-ivar">@succeeded</span> = <span class="ruby-keyword kw">nil</span>
73:         <span class="ruby-ivar">@responder</span> = <span class="ruby-keyword kw">nil</span>
74:         <span class="ruby-ivar">@code</span> = <span class="ruby-keyword kw">nil</span>
75:         <span class="ruby-ivar">@msg</span> = <span class="ruby-keyword kw">nil</span>
76:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000215">
                    
                    <a name="M000215"></a><b>send</b>(args={})
                    
                </div>
                
                <div class="description">
                  <p>
:host => required String
</p>
<pre>
  a string containing the IP address or host name of the SMTP server to connect to.
</pre>
<p>
:port => optional
</p>
<pre>
  defaults to 25.
</pre>
<p>
:domain => required String
</p>
<pre>
  This is passed as the argument to the EHLO command.
</pre>
<p>
:starttls => optional Boolean
</p>
<pre>
  If it evaluates true, then the client will initiate STARTTLS with
  the server, and abort the connection if the negotiation doesn't succeed.
  TODO, need to be able to pass certificate parameters with this option.
</pre>
<p>
:auth => optional Hash of auth parameters
</p>
<pre>
  If not given, then no auth will be attempted.
  (In that case, the connection will be aborted if the server requires auth.)
  Specify the hash value :type to determine the auth type, along with additional parameters
  depending on the type.
  Currently only :type =&gt; :plain is supported. Pass additional parameters :username (String),
  and :password (either a String or a Proc that will be called at auth-time).

  @example
    :auth =&gt; {:type=&gt;:plain, :username=&gt;&quot;mickey@disney.com&quot;, :password=&gt;&quot;mouse&quot;}
</pre>
<p>
:from => required String
</p>
<pre>
  Specifies the sender of the message. Will be passed as the argument
  to the MAIL FROM. Do NOT enclose the argument in angle-bracket (&lt;&gt;) characters.
  The connection will abort if the server rejects the value.
</pre>
<p>
:to => required String or Array of Strings
</p>
<pre>
  The recipient(s) of the message. Do NOT enclose
  any of the values in angle-brackets (&lt;&gt;) characters. It's NOT a fatal error if one or more
  recipients are rejected by the server. (Of course, if ALL of them are, the server will most
  likely trigger an error when we try to send data.) An array of codes containing the status
  of each requested recipient is available after the call completes. TODO, we should define
  an overridable stub that will be called on rejection of a recipient or a sender, giving
  user code the chance to try again or abort the connection.
</pre>
<p>
:header => Required hash of values to be transmitted in the header of the
message.
</p>
<pre>
  The hash keys are the names of the headers (do NOT append a trailing colon), and the values are strings
  containing the header values. TODO, support Arrays of header values, which would cause us to
  send that specific header line more than once.

  @example
    :header =&gt; {&quot;Subject&quot; =&gt; &quot;Bogus&quot;, &quot;CC&quot; =&gt; &quot;myboss@example.com&quot;}
</pre>
<p>
:body => Optional string, defaults blank.
</p>
<pre>
  This will be passed as the body of the email message.
  TODO, this needs to be significantly beefed up. As currently written, this requires the caller
  to properly format the input into CRLF-delimited lines of 7-bit characters in the standard
  SMTP transmission format. We need to be able to automatically convert binary data, and add
  correct line-breaks to text data. I think the :body parameter should remain as it is, and we
  should add a :content parameter that contains autoconversions and/or conversion parameters.
  Then we can check if either :body or :content is present and do the right thing.
</pre>
<p>
:content => Optional array or string
</p>
<pre>
  Alternative to providing header and body, an array or string of raw data which MUST be in
  correct SMTP body format, including a trailing dot line
</pre>
<p>
:verbose => Optional.
</p>
<pre>
  If true, will cause a lot of information (including the server-side of the
  conversation) to be dumped to $&gt;.
</pre>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000215_source')" id="l_M000215_source">show</a>
                        
                    </p>
                    <div id="M000215_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 134</span>
134:       <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">send</span> <span class="ruby-identifier">args</span>={}
135:         <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:port</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">25</span>
136:         <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:body</span>] <span class="ruby-operator">||=</span> <span class="ruby-value str">&quot;&quot;</span>
137: 
138: ??
139:         <span class="ruby-constant">EventMachine</span>.<span class="ruby-identifier">connect</span>( <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:host</span>], <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:port</span>], <span class="ruby-keyword kw">self</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
140:           <span class="ruby-comment cmt"># According to the EM docs, we will get here AFTER post_init is called.</span>
141:           <span class="ruby-identifier">c</span>.<span class="ruby-identifier">args</span> = <span class="ruby-identifier">args</span>
142:           <span class="ruby-identifier">c</span>.<span class="ruby-identifier">set_comm_inactivity_timeout</span> <span class="ruby-value">60</span>
143:         }
144:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000217">
                    
                    <a name="M000217"></a><b>connection_completed</b>()
                    
                </div>
                
                <div class="description">
                  <p>
@private
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000217_source')" id="l_M000217_source">show</a>
                        
                    </p>
                    <div id="M000217_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 174</span>
174:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">connection_completed</span>
175:         <span class="ruby-ivar">@responder</span> = <span class="ruby-identifier">:receive_signon</span>
176:         <span class="ruby-ivar">@msg</span> = []
177:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000216">
                    
                    <a name="M000216"></a><b>post_init</b>()
                    
                </div>
                
                <div class="description">
                  <p>
@private
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000216_source')" id="l_M000216_source">show</a>
                        
                    </p>
                    <div id="M000216_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 168</span>
168:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">post_init</span>
169:         <span class="ruby-ivar">@return_values</span> = <span class="ruby-constant">OpenStruct</span>.<span class="ruby-identifier">new</span>
170:         <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">start_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
171:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000219">
                    
                    <a name="M000219"></a><b>receive_line</b>(ln)
                    
                </div>
                
                <div class="description">
                  <p>
@private
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000219_source')" id="l_M000219_source">show</a>
                        
                    </p>
                    <div id="M000219_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 196</span>
196:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">receive_line</span> <span class="ruby-identifier">ln</span>
197:         <span class="ruby-identifier">$&gt;</span>.<span class="ruby-identifier">puts</span> <span class="ruby-identifier">ln</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@args</span>[<span class="ruby-identifier">:verbose</span>]
198:         <span class="ruby-ivar">@range</span> = <span class="ruby-identifier">ln</span>[<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-value">1</span>].<span class="ruby-identifier">to_i</span>
199:         <span class="ruby-ivar">@code</span> = <span class="ruby-identifier">ln</span>[<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-value">3</span>].<span class="ruby-identifier">to_i</span>
200:         <span class="ruby-ivar">@msg</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ln</span>[<span class="ruby-value">4</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
201:         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">ln</span>[<span class="ruby-value">3</span><span class="ruby-operator">...</span><span class="ruby-value">4</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'-'</span>
202:           <span class="ruby-identifier">$&gt;</span>.<span class="ruby-identifier">puts</span> <span class="ruby-ivar">@responder</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@args</span>[<span class="ruby-identifier">:verbose</span>]
203:           <span class="ruby-identifier">send</span> <span class="ruby-ivar">@responder</span>
204:           <span class="ruby-ivar">@msg</span>.<span class="ruby-identifier">clear</span>
205:         <span class="ruby-keyword kw">end</span>
206:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000218">
                    
                    <a name="M000218"></a><b>unbind</b>()
                    
                </div>
                
                <div class="description">
                  <p>
We can get here in a variety of ways, all of them being failures unless the
@succeeded flag is set. If a protocol success was recorded, then
don&#8217;t set a deferred success because the caller will already have
done it (no need to wait until the connection closes to invoke the
callbacks).
</p>
<p>
@private
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000218_source')" id="l_M000218_source">show</a>
                        
                    </p>
                    <div id="M000218_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 185</span>
185:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">unbind</span>
186:         <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@succeeded</span>
187:           <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">elapsed_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">start_time</span>
188:           <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">responder</span> = <span class="ruby-ivar">@responder</span>
189:           <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">code</span> = <span class="ruby-ivar">@code</span>
190:           <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">message</span> = <span class="ruby-ivar">@msg</span>
191:           <span class="ruby-identifier">set_deferred_status</span>(<span class="ruby-identifier">:failed</span>, <span class="ruby-ivar">@return_values</span>)
192:         <span class="ruby-keyword kw">end</span>
193:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Private methods</div>
            
            <div class="method">
                <div class="title" id="M000232">
                    
                    <a name="M000232"></a><b>invoke_auth</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Perform an authentication. If the caller didn&#8217;t request one, then
fall through to the mail-from state.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000232_source')" id="l_M000232_source">show</a>
                        
                    </p>
                    <div id="M000232_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 266</span>
266:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">invoke_auth</span>
267:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@args</span>[<span class="ruby-identifier">:auth</span>]
268:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@args</span>[<span class="ruby-identifier">:auth</span>][<span class="ruby-identifier">:type</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">:plain</span>
269:             <span class="ruby-identifier">psw</span> = <span class="ruby-ivar">@args</span>[<span class="ruby-identifier">:auth</span>][<span class="ruby-identifier">:password</span>]
270:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">psw</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:call</span>)
271:               <span class="ruby-identifier">psw</span> = <span class="ruby-identifier">psw</span>.<span class="ruby-identifier">call</span>
272:             <span class="ruby-keyword kw">end</span>
273:             <span class="ruby-comment cmt">#str = Base64::encode64(&quot;\0#{@args[:auth][:username]}\0#{psw}&quot;).chomp</span>
274:             <span class="ruby-identifier">str</span> = [<span class="ruby-node">&quot;\0#{@args[:auth][:username]}\0#{psw}&quot;</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">&quot;m&quot;</span>).<span class="ruby-identifier">chomp</span>
275:             <span class="ruby-identifier">send_data</span> <span class="ruby-node">&quot;AUTH PLAIN #{str}\r\n&quot;</span>
276:             <span class="ruby-ivar">@responder</span> = <span class="ruby-identifier">:receive_auth_response</span>
277:           <span class="ruby-keyword kw">else</span>
278:             <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">invoke_internal_error</span>(<span class="ruby-value str">&quot;unsupported auth type&quot;</span>)
279:           <span class="ruby-keyword kw">end</span>
280:         <span class="ruby-keyword kw">else</span>
281:           <span class="ruby-identifier">invoke_mail_from</span>
282:         <span class="ruby-keyword kw">end</span>
283:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000244">
                    
                    <a name="M000244"></a><b>invoke_data</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000244_source')" id="l_M000244_source">show</a>
                        
                    </p>
                    <div id="M000244_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 319</span>
319:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">invoke_data</span>
320:         <span class="ruby-identifier">send_data</span> <span class="ruby-value str">&quot;DATA\r\n&quot;</span>
321:         <span class="ruby-ivar">@responder</span> = <span class="ruby-identifier">:receive_data_response</span>
322:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000220">
                    
                    <a name="M000220"></a><b>invoke_error</b>()
                    
                </div>
                
                <div class="description">
                  <p>
We encountered an error from the server and will close the connection. Use
the error and message the server returned.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000220_source')" id="l_M000220_source">show</a>
                        
                    </p>
                    <div id="M000220_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 213</span>
213:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">invoke_error</span>
214:         <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">elapsed_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">start_time</span>
215:         <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">responder</span> = <span class="ruby-ivar">@responder</span>
216:         <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">code</span> = <span class="ruby-ivar">@code</span>
217:         <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">message</span> = <span class="ruby-ivar">@msg</span>
218:         <span class="ruby-identifier">set_deferred_status</span> <span class="ruby-identifier">:failed</span>, <span class="ruby-ivar">@return_values</span>
219:         <span class="ruby-identifier">send_data</span> <span class="ruby-value str">&quot;QUIT\r\n&quot;</span>
220:         <span class="ruby-identifier">close_connection_after_writing</span>
221:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000224">
                    
                    <a name="M000224"></a><b>invoke_internal_error</b>(msg = &quot;???&quot;)
                    
                </div>
                
                <div class="description">
                  <p>
We encountered an error on our side of the protocol and will close the
connection. Use an extra-protocol error code (900) and use the message from
the caller.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000224_source')" id="l_M000224_source">show</a>
                        
                    </p>
                    <div id="M000224_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 226</span>
226:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">invoke_internal_error</span> <span class="ruby-identifier">msg</span> = <span class="ruby-value str">&quot;???&quot;</span>
227:         <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">elapsed_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">start_time</span>
228:         <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">responder</span> = <span class="ruby-ivar">@responder</span>
229:         <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">code</span> = <span class="ruby-value">900</span>
230:         <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">message</span> = <span class="ruby-identifier">msg</span>
231:         <span class="ruby-identifier">set_deferred_status</span> <span class="ruby-identifier">:failed</span>, <span class="ruby-ivar">@return_values</span>
232:         <span class="ruby-identifier">send_data</span> <span class="ruby-value str">&quot;QUIT\r\n&quot;</span>
233:         <span class="ruby-identifier">close_connection_after_writing</span>
234:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000237">
                    
                    <a name="M000237"></a><b>invoke_mail_from</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000237_source')" id="l_M000237_source">show</a>
                        
                    </p>
                    <div id="M000237_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 289</span>
289:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">invoke_mail_from</span>
290:         <span class="ruby-identifier">send_data</span> <span class="ruby-node">&quot;MAIL FROM: &lt;#{@args[:from]}&gt;\r\n&quot;</span>
291:         <span class="ruby-ivar">@responder</span> = <span class="ruby-identifier">:receive_mail_from_response</span>
292:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000239">
                    
                    <a name="M000239"></a><b>invoke_rcpt_to</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000239_source')" id="l_M000239_source">show</a>
                        
                    </p>
                    <div id="M000239_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 298</span>
298:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">invoke_rcpt_to</span>
299:         <span class="ruby-ivar">@rcpt_responses</span> <span class="ruby-operator">||=</span> []
300:         <span class="ruby-identifier">l</span> = <span class="ruby-ivar">@rcpt_responses</span>.<span class="ruby-identifier">length</span>
301:         <span class="ruby-identifier">to</span> = <span class="ruby-ivar">@args</span>[<span class="ruby-identifier">:to</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>) <span class="ruby-operator">?</span> <span class="ruby-ivar">@args</span>[<span class="ruby-identifier">:to</span>] <span class="ruby-operator">:</span> [<span class="ruby-ivar">@args</span>[<span class="ruby-identifier">:to</span>].<span class="ruby-identifier">to_s</span>]
302:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">l</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">to</span>.<span class="ruby-identifier">length</span>
303:           <span class="ruby-identifier">send_data</span> <span class="ruby-node">&quot;RCPT TO: &lt;#{to[l]}&gt;\r\n&quot;</span>
304:           <span class="ruby-ivar">@responder</span> = <span class="ruby-identifier">:receive_rcpt_to_response</span>
305:         <span class="ruby-keyword kw">else</span>
306:           <span class="ruby-identifier">e</span> = <span class="ruby-ivar">@rcpt_responses</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">rr</span><span class="ruby-operator">|</span> <span class="ruby-identifier">rr</span>.<span class="ruby-identifier">last</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>}
307:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">e</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
308:             <span class="ruby-identifier">invoke_data</span>
309:           <span class="ruby-keyword kw">else</span>
310:             <span class="ruby-identifier">invoke_error</span>
311:           <span class="ruby-keyword kw">end</span>
312:         <span class="ruby-keyword kw">end</span>
313:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000230">
                    
                    <a name="M000230"></a><b>invoke_starttls</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000230_source')" id="l_M000230_source">show</a>
                        
                    </p>
                    <div id="M000230_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 248</span>
248:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">invoke_starttls</span>
249:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@args</span>[<span class="ruby-identifier">:starttls</span>]
250:           <span class="ruby-comment cmt"># It would be more sociable to first ask if @server_caps contains</span>
251:           <span class="ruby-comment cmt"># the string &quot;STARTTLS&quot; before we invoke it, but hey, life's too short.</span>
252:           <span class="ruby-identifier">send_data</span> <span class="ruby-value str">&quot;STARTTLS\r\n&quot;</span>
253:           <span class="ruby-ivar">@responder</span> = <span class="ruby-identifier">:receive_starttls_response</span>
254:         <span class="ruby-keyword kw">else</span>
255:           <span class="ruby-identifier">invoke_auth</span>
256:         <span class="ruby-keyword kw">end</span>
257:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000236">
                    
                    <a name="M000236"></a><b>receive_auth_response</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000236_source')" id="l_M000236_source">show</a>
                        
                    </p>
                    <div id="M000236_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 284</span>
284:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">receive_auth_response</span>
285:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">invoke_error</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@range</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>
286:         <span class="ruby-identifier">invoke_mail_from</span>
287:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000245">
                    
                    <a name="M000245"></a><b>receive_data_response</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000245_source')" id="l_M000245_source">show</a>
                        
                    </p>
                    <div id="M000245_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 323</span>
323:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">receive_data_response</span>
324:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">invoke_error</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@range</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>
325: 
326:         <span class="ruby-comment cmt"># The data to send can be given either in @args[:content] (an array or string of raw data</span>
327:         <span class="ruby-comment cmt"># which MUST be in correct SMTP body format, including a trailing dot line), or a header and</span>
328:         <span class="ruby-comment cmt"># body given in @args[:header] and @args[:body].</span>
329:         <span class="ruby-comment cmt">#</span>
330:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@args</span>[<span class="ruby-identifier">:content</span>]
331:           <span class="ruby-identifier">send_data</span> <span class="ruby-ivar">@args</span>[<span class="ruby-identifier">:content</span>].<span class="ruby-identifier">to_s</span>
332:         <span class="ruby-keyword kw">else</span>
333:           <span class="ruby-comment cmt"># The header can be a hash or an array.</span>
334:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@args</span>[<span class="ruby-identifier">:header</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>)
335:             (<span class="ruby-ivar">@args</span>[<span class="ruby-identifier">:header</span>] <span class="ruby-operator">||</span> {}).<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">send_data</span> <span class="ruby-node">&quot;#{k}: #{v}\r\n&quot;</span> }
336:           <span class="ruby-keyword kw">else</span>
337:             <span class="ruby-identifier">send_data</span> <span class="ruby-ivar">@args</span>[<span class="ruby-identifier">:header</span>].<span class="ruby-identifier">to_s</span>
338:           <span class="ruby-keyword kw">end</span>
339:           <span class="ruby-identifier">send_data</span> <span class="ruby-value str">&quot;\r\n&quot;</span>
340: 
341:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@args</span>[<span class="ruby-identifier">:body</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>)
342:             <span class="ruby-ivar">@args</span>[<span class="ruby-identifier">:body</span>].<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">e</span><span class="ruby-operator">|</span> <span class="ruby-identifier">send_data</span> <span class="ruby-identifier">e</span>}
343:           <span class="ruby-keyword kw">else</span>
344:             <span class="ruby-identifier">send_data</span> <span class="ruby-ivar">@args</span>[<span class="ruby-identifier">:body</span>].<span class="ruby-identifier">to_s</span>
345:           <span class="ruby-keyword kw">end</span>
346: 
347:           <span class="ruby-identifier">send_data</span> <span class="ruby-value str">&quot;\r\n.\r\n&quot;</span>
348:         <span class="ruby-keyword kw">end</span>
349: 
350:         <span class="ruby-ivar">@responder</span> = <span class="ruby-identifier">:receive_message_response</span>
351:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000229">
                    
                    <a name="M000229"></a><b>receive_ehlo_response</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000229_source')" id="l_M000229_source">show</a>
                        
                    </p>
                    <div id="M000229_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 242</span>
242:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">receive_ehlo_response</span>
243:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">invoke_error</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@range</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>
244:         <span class="ruby-ivar">@server_caps</span> = <span class="ruby-ivar">@msg</span>
245:         <span class="ruby-identifier">invoke_starttls</span>
246:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000238">
                    
                    <a name="M000238"></a><b>receive_mail_from_response</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000238_source')" id="l_M000238_source">show</a>
                        
                    </p>
                    <div id="M000238_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 293</span>
293:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">receive_mail_from_response</span>
294:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">invoke_error</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@range</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>
295:         <span class="ruby-identifier">invoke_rcpt_to</span>
296:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000248">
                    
                    <a name="M000248"></a><b>receive_message_response</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000248_source')" id="l_M000248_source">show</a>
                        
                    </p>
                    <div id="M000248_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 352</span>
352:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">receive_message_response</span>
353:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">invoke_error</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@range</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>
354:         <span class="ruby-identifier">send_data</span> <span class="ruby-value str">&quot;QUIT\r\n&quot;</span>
355:         <span class="ruby-identifier">close_connection_after_writing</span>
356:         <span class="ruby-ivar">@succeeded</span> = <span class="ruby-keyword kw">true</span>
357:         <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">elapsed_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">start_time</span>
358:         <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">responder</span> = <span class="ruby-ivar">@responder</span>
359:         <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">code</span> = <span class="ruby-ivar">@code</span>
360:         <span class="ruby-ivar">@return_values</span>.<span class="ruby-identifier">message</span> = <span class="ruby-ivar">@msg</span>
361:         <span class="ruby-identifier">set_deferred_status</span> <span class="ruby-identifier">:succeeded</span>, <span class="ruby-ivar">@return_values</span>
362:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000242">
                    
                    <a name="M000242"></a><b>receive_rcpt_to_response</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000242_source')" id="l_M000242_source">show</a>
                        
                    </p>
                    <div id="M000242_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 314</span>
314:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">receive_rcpt_to_response</span>
315:         <span class="ruby-ivar">@rcpt_responses</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-ivar">@code</span>, <span class="ruby-ivar">@msg</span>, <span class="ruby-ivar">@range</span>]
316:         <span class="ruby-identifier">invoke_rcpt_to</span>
317:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000228">
                    
                    <a name="M000228"></a><b>receive_signon</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000228_source')" id="l_M000228_source">show</a>
                        
                    </p>
                    <div id="M000228_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 236</span>
236:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">receive_signon</span>
237:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">invoke_error</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@range</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>
238:         <span class="ruby-identifier">send_data</span> <span class="ruby-node">&quot;EHLO #{@args[:domain]}\r\n&quot;</span>
239:         <span class="ruby-ivar">@responder</span> = <span class="ruby-identifier">:receive_ehlo_response</span>
240:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000231">
                    
                    <a name="M000231"></a><b>receive_starttls_response</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000231_source')" id="l_M000231_source">show</a>
                        
                    </p>
                    <div id="M000231_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/em/protocols/smtpclient.rb, line 258</span>
258:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">receive_starttls_response</span>
259:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">invoke_error</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@range</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>
260:         <span class="ruby-identifier">start_tls</span>
261:         <span class="ruby-identifier">invoke_auth</span>
262:       <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    