<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Jammit::Packager</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
    <script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Class</span> 
            Jammit::Packager 
            
                <span class="parent">&lt; 
                    
                    Object
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/jammit/packager_rb.html">lib/jammit/packager.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
The <a href="Packager.html">Jammit::Packager</a> resolves the configuration
file into lists of real assets that get merged into individual asset
packages. Given the compiled contents of an asset package, the <a
href="Packager.html">Packager</a> knows how to cache that package with the
correct timestamps.
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>C</dt>
        <dd>
            <ul>
                
                <li><a href="#M000040">cache</a>,</li>
                
                <li><a href="#M000049">cacheable</a>,</li>
                
                <li><a href="#M000050">create_packages</a></li>
                
            </ul>
        </dd>
    
        <dt>G</dt>
        <dd>
            <ul>
                
                <li><a href="#M000046">glob_files</a></li>
                
            </ul>
        </dd>
    
        <dt>I</dt>
        <dd>
            <ul>
                
                <li><a href="#M000041">individual_urls</a></li>
                
            </ul>
        </dd>
    
        <dt>L</dt>
        <dd>
            <ul>
                
                <li><a href="#M000048">latest_mtime</a></li>
                
            </ul>
        </dd>
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M000037">new</a>,</li>
                
                <li><a href="#M000051">not_found</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M000043">pack_javascripts</a>,</li>
                
                <li><a href="#M000042">pack_stylesheets</a>,</li>
                
                <li><a href="#M000044">pack_templates</a>,</li>
                
                <li><a href="#M000045">package_for</a>,</li>
                
                <li><a href="#M000047">path_to_url</a>,</li>
                
                <li><a href="#M000038">precache_all</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    

    

    
    <div class="sectiontitle">Attributes</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>force</td>
            <td class='attr-desc'><p>
Set force to false to allow packages to only be rebuilt when their source
files have changed since the last time their package was built.
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [RW]
            </td>
            <td class='attr-name'>package_names</td>
            <td class='attr-desc'><p>
Set force to false to allow packages to only be rebuilt when their source
files have changed since the last time their package was built.
</p></td>
        </tr>
        
    </table>
    

    
            <div class="sectiontitle">Class Public methods</div>
            
            <div class="method">
                <div class="title" id="M000037">
                    
                    <a name="M000037"></a><b>new</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Creating a new <a href="Packager.html">Packager</a> will rebuild the list
of assets from the <a
href="../Jammit.html#configuration">Jammit.configuration</a>. When
assets.yml is being changed on the fly, create a new <a
href="Packager.html">Packager</a>.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000037_source')" id="l_M000037_source">show</a>
                        
                    </p>
                    <div id="M000037_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/jammit/packager.rb, line 16</span>
16:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>
17:       <span class="ruby-ivar">@compressor</span>     = <span class="ruby-constant">Compressor</span>.<span class="ruby-identifier">new</span>
18:       <span class="ruby-ivar">@force</span>          = <span class="ruby-keyword kw">false</span>
19:       <span class="ruby-ivar">@package_names</span>  = <span class="ruby-keyword kw">nil</span>
20:       <span class="ruby-ivar">@config</span> = {
21:         <span class="ruby-identifier">:css</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-constant">Jammit</span>.<span class="ruby-identifier">configuration</span>[<span class="ruby-identifier">:stylesheets</span>] <span class="ruby-operator">||</span> {}),
22:         <span class="ruby-identifier">:js</span>  =<span class="ruby-operator">&gt;</span> (<span class="ruby-constant">Jammit</span>.<span class="ruby-identifier">configuration</span>[<span class="ruby-identifier">:javascripts</span>] <span class="ruby-operator">||</span> {})
23:       }
24:       <span class="ruby-ivar">@packages</span> = {
25:         <span class="ruby-identifier">:css</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">create_packages</span>(<span class="ruby-ivar">@config</span>[<span class="ruby-identifier">:css</span>]),
26:         <span class="ruby-identifier">:js</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">create_packages</span>(<span class="ruby-ivar">@config</span>[<span class="ruby-identifier">:js</span>])
27:       }
28:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000040">
                    
                    <a name="M000040"></a><b>cache</b>(package, extension, contents, output_dir, suffix=nil, mtime=nil)
                    
                </div>
                
                <div class="description">
                  <p>
Caches a single prebuilt asset package and gzips it at the highest
compression level. Ensures that the modification time of both both variants
is identical, for web server caching modules, as well as MHTML.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000040_source')" id="l_M000040_source">show</a>
                        
                    </p>
                    <div id="M000040_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/jammit/packager.rb, line 55</span>
55:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cache</span>(<span class="ruby-identifier">package</span>, <span class="ruby-identifier">extension</span>, <span class="ruby-identifier">contents</span>, <span class="ruby-identifier">output_dir</span>, <span class="ruby-identifier">suffix</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">mtime</span>=<span class="ruby-keyword kw">nil</span>)
56:       <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span>(<span class="ruby-identifier">output_dir</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">output_dir</span>)
57:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">OutputNotWritable</span>, <span class="ruby-node">&quot;Jammit doesn't have permission to write to \&quot;#{output_dir}\&quot;&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">writable?</span>(<span class="ruby-identifier">output_dir</span>)
58:       <span class="ruby-identifier">mtime</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">latest_mtime</span> <span class="ruby-identifier">package_for</span>(<span class="ruby-identifier">package</span>, <span class="ruby-identifier">extension</span>.<span class="ruby-identifier">to_sym</span>)[<span class="ruby-identifier">:paths</span>]
59:       <span class="ruby-identifier">files</span> = []
60:       <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">file_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">output_dir</span>, <span class="ruby-constant">Jammit</span>.<span class="ruby-identifier">filename</span>(<span class="ruby-identifier">package</span>, <span class="ruby-identifier">extension</span>, <span class="ruby-identifier">suffix</span>))
61:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">file_name</span>, <span class="ruby-value str">'wb+'</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">contents</span>) }
62:       <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Jammit</span>.<span class="ruby-identifier">gzip_assets</span>
63:         <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">zip_name</span> = <span class="ruby-node">&quot;#{file_name}.gz&quot;</span>
64:         <span class="ruby-constant">Zlib</span><span class="ruby-operator">::</span><span class="ruby-constant">GzipWriter</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">zip_name</span>, <span class="ruby-constant">Zlib</span><span class="ruby-operator">::</span><span class="ruby-constant">BEST_COMPRESSION</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">contents</span>) }
65:       <span class="ruby-keyword kw">end</span>
66:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">utime</span>(<span class="ruby-identifier">mtime</span>, <span class="ruby-identifier">mtime</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">files</span>)
67:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000041">
                    
                    <a name="M000041"></a><b>individual_urls</b>(package, extension)
                    
                </div>
                
                <div class="description">
                  <p>
Get the list of individual assets for a package.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000041_source')" id="l_M000041_source">show</a>
                        
                    </p>
                    <div id="M000041_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/jammit/packager.rb, line 70</span>
70:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">individual_urls</span>(<span class="ruby-identifier">package</span>, <span class="ruby-identifier">extension</span>)
71:       <span class="ruby-identifier">package_for</span>(<span class="ruby-identifier">package</span>, <span class="ruby-identifier">extension</span>)[<span class="ruby-identifier">:urls</span>]
72:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000043">
                    
                    <a name="M000043"></a><b>pack_javascripts</b>(package)
                    
                </div>
                
                <div class="description">
                  <p>
Return the compressed contents of a javascript package.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000043_source')" id="l_M000043_source">show</a>
                        
                    </p>
                    <div id="M000043_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/jammit/packager.rb, line 80</span>
80:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pack_javascripts</span>(<span class="ruby-identifier">package</span>)
81:       <span class="ruby-ivar">@compressor</span>.<span class="ruby-identifier">compress_js</span>(<span class="ruby-identifier">package_for</span>(<span class="ruby-identifier">package</span>, <span class="ruby-identifier">:js</span>)[<span class="ruby-identifier">:paths</span>])
82:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000042">
                    
                    <a name="M000042"></a><b>pack_stylesheets</b>(package, variant=nil, asset_url=nil)
                    
                </div>
                
                <div class="description">
                  <p>
Return the compressed contents of a stylesheet package.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000042_source')" id="l_M000042_source">show</a>
                        
                    </p>
                    <div id="M000042_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/jammit/packager.rb, line 75</span>
75:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pack_stylesheets</span>(<span class="ruby-identifier">package</span>, <span class="ruby-identifier">variant</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">asset_url</span>=<span class="ruby-keyword kw">nil</span>)
76:       <span class="ruby-ivar">@compressor</span>.<span class="ruby-identifier">compress_css</span>(<span class="ruby-identifier">package_for</span>(<span class="ruby-identifier">package</span>, <span class="ruby-identifier">:css</span>)[<span class="ruby-identifier">:paths</span>], <span class="ruby-identifier">variant</span>, <span class="ruby-identifier">asset_url</span>)
77:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000044">
                    
                    <a name="M000044"></a><b>pack_templates</b>(package)
                    
                </div>
                
                <div class="description">
                  <p>
Return the compiled contents of a JST package.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000044_source')" id="l_M000044_source">show</a>
                        
                    </p>
                    <div id="M000044_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/jammit/packager.rb, line 85</span>
85:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pack_templates</span>(<span class="ruby-identifier">package</span>)
86:       <span class="ruby-ivar">@compressor</span>.<span class="ruby-identifier">compile_jst</span>(<span class="ruby-identifier">package_for</span>(<span class="ruby-identifier">package</span>, <span class="ruby-identifier">:js</span>)[<span class="ruby-identifier">:paths</span>])
87:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000038">
                    
                    <a name="M000038"></a><b>precache_all</b>(output_dir=nil, base_url=nil)
                    
                </div>
                
                <div class="description">
                  <p>
Ask the packager to precache all defined assets, along with their
gzip&#8217;d versions. In order to prebuild the MHTML stylesheets, we need
to know the base_url, because IE only supports MHTML with absolute
references. Unless forced, will only rebuild assets whose source files have
been changed since their last package build.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000038_source')" id="l_M000038_source">show</a>
                        
                    </p>
                    <div id="M000038_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/jammit/packager.rb, line 35</span>
35:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">precache_all</span>(<span class="ruby-identifier">output_dir</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">base_url</span>=<span class="ruby-keyword kw">nil</span>)
36:       <span class="ruby-identifier">output_dir</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">Jammit</span>.<span class="ruby-identifier">public_root</span>, <span class="ruby-constant">Jammit</span>.<span class="ruby-identifier">package_path</span>)
37:       <span class="ruby-identifier">cacheable</span>(<span class="ruby-identifier">:js</span>, <span class="ruby-identifier">output_dir</span>).<span class="ruby-identifier">each</span>  {<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">cache</span>(<span class="ruby-identifier">p</span>, <span class="ruby-value str">'js'</span>,  <span class="ruby-identifier">pack_javascripts</span>(<span class="ruby-identifier">p</span>), <span class="ruby-identifier">output_dir</span>) }
38:       <span class="ruby-identifier">cacheable</span>(<span class="ruby-identifier">:css</span>, <span class="ruby-identifier">output_dir</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
39:         <span class="ruby-identifier">cache</span>(<span class="ruby-identifier">p</span>, <span class="ruby-value str">'css'</span>, <span class="ruby-identifier">pack_stylesheets</span>(<span class="ruby-identifier">p</span>), <span class="ruby-identifier">output_dir</span>)
40:         <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Jammit</span>.<span class="ruby-identifier">embed_assets</span>
41:           <span class="ruby-identifier">cache</span>(<span class="ruby-identifier">p</span>, <span class="ruby-value str">'css'</span>, <span class="ruby-identifier">pack_stylesheets</span>(<span class="ruby-identifier">p</span>, <span class="ruby-identifier">:datauri</span>), <span class="ruby-identifier">output_dir</span>, <span class="ruby-identifier">:datauri</span>)
42:           <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Jammit</span>.<span class="ruby-identifier">mhtml_enabled</span>
43:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">MissingConfiguration</span>, <span class="ruby-value str">&quot;A --base-url option is required in order to generate MHTML.&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">base_url</span>
44:             <span class="ruby-identifier">mtime</span> = <span class="ruby-identifier">latest_mtime</span> <span class="ruby-identifier">package_for</span>(<span class="ruby-identifier">p</span>, <span class="ruby-identifier">:css</span>)[<span class="ruby-identifier">:paths</span>]
45:             <span class="ruby-identifier">asset_url</span> = <span class="ruby-node">&quot;#{base_url}#{Jammit.asset_url(p, :css, :mhtml, mtime)}&quot;</span>
46:             <span class="ruby-identifier">cache</span>(<span class="ruby-identifier">p</span>, <span class="ruby-value str">'css'</span>, <span class="ruby-identifier">pack_stylesheets</span>(<span class="ruby-identifier">p</span>, <span class="ruby-identifier">:mhtml</span>, <span class="ruby-identifier">asset_url</span>), <span class="ruby-identifier">output_dir</span>, <span class="ruby-identifier">:mhtml</span>, <span class="ruby-identifier">mtime</span>)
47:           <span class="ruby-keyword kw">end</span>
48:         <span class="ruby-keyword kw">end</span>
49:       <span class="ruby-keyword kw">end</span>
50:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Private methods</div>
            
            <div class="method">
                <div class="title" id="M000049">
                    
                    <a name="M000049"></a><b>cacheable</b>(extension, output_dir)
                    
                </div>
                
                <div class="description">
                  <p>
Return a list of all of the packages that should be cached. If
&#8220;force&#8221; is true, this is all of them &#8212; otherwise only the
packages that are missing or whose source files have changed since the last
package build.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000049_source')" id="l_M000049_source">show</a>
                        
                    </p>
                    <div id="M000049_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/jammit/packager.rb, line 122</span>
122:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cacheable</span>(<span class="ruby-identifier">extension</span>, <span class="ruby-identifier">output_dir</span>)
123:       <span class="ruby-identifier">names</span> = <span class="ruby-ivar">@packages</span>[<span class="ruby-identifier">extension</span>].<span class="ruby-identifier">keys</span>
124:       <span class="ruby-identifier">names</span> = <span class="ruby-identifier">names</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@package_names</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">n</span> } <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@package_names</span>
125:       <span class="ruby-identifier">config_mtime</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">mtime</span>(<span class="ruby-constant">Jammit</span>.<span class="ruby-identifier">config_path</span>)
126:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">names</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@force</span>
127:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">names</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span><span class="ruby-operator">|</span>
128:         <span class="ruby-identifier">pack</span>        = <span class="ruby-identifier">package_for</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">extension</span>)
129:         <span class="ruby-identifier">cached</span>      = [<span class="ruby-constant">Jammit</span>.<span class="ruby-identifier">filename</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">extension</span>)]
130:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">extension</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:css</span>
131:           <span class="ruby-identifier">cached</span>.<span class="ruby-identifier">push</span> <span class="ruby-constant">Jammit</span>.<span class="ruby-identifier">filename</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">extension</span>, <span class="ruby-identifier">:datauri</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Jammit</span>.<span class="ruby-identifier">embed_assets</span>
132:           <span class="ruby-identifier">cached</span>.<span class="ruby-identifier">push</span> <span class="ruby-constant">Jammit</span>.<span class="ruby-identifier">filename</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">extension</span>, <span class="ruby-identifier">:mhtml</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Jammit</span>.<span class="ruby-identifier">mhtml_enabled</span>
133:         <span class="ruby-keyword kw">end</span>
134:         <span class="ruby-identifier">cached</span>.<span class="ruby-identifier">map!</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">output_dir</span>, <span class="ruby-identifier">file</span>) }
135:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">cached</span>.<span class="ruby-identifier">any?</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span> <span class="ruby-operator">!</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">file</span>) }
136:           <span class="ruby-keyword kw">true</span>
137:         <span class="ruby-keyword kw">else</span>
138:           <span class="ruby-identifier">since</span> = <span class="ruby-identifier">cached</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">mtime</span>(<span class="ruby-identifier">file</span>) }.<span class="ruby-identifier">min</span>
139:           <span class="ruby-identifier">config_mtime</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">since</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">pack</span>[<span class="ruby-identifier">:paths</span>].<span class="ruby-identifier">any?</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">src</span><span class="ruby-operator">|</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">mtime</span>(<span class="ruby-identifier">src</span>) <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">since</span> }
140:         <span class="ruby-keyword kw">end</span>
141:       <span class="ruby-keyword kw">end</span>
142:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000050">
                    
                    <a name="M000050"></a><b>create_packages</b>(config)
                    
                </div>
                
                <div class="description">
                  <p>
Compiles the list of assets that goes into each package. Runs an ordered
list of Dir.globs, taking the merged unique result. If there are JST files
in this package we need to add an extra path for when package_assets is off
(e.g. in a dev environment). This package (e.g. /assets/package-name.jst)
will never exist as an actual file but will be dynamically generated by <a
href="../Jammit.html">Jammit</a> on every request.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000050_source')" id="l_M000050_source">show</a>
                        
                    </p>
                    <div id="M000050_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/jammit/packager.rb, line 151</span>
151:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_packages</span>(<span class="ruby-identifier">config</span>)
152:       <span class="ruby-identifier">packages</span> = {}
153:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">packages</span> <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">config</span>
154:       <span class="ruby-identifier">config</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">globs</span><span class="ruby-operator">|</span>
155:         <span class="ruby-identifier">globs</span>                  <span class="ruby-operator">||=</span> []
156:         <span class="ruby-identifier">packages</span>[<span class="ruby-identifier">name</span>]         = {}
157:         <span class="ruby-identifier">paths</span>                  = <span class="ruby-identifier">globs</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">glob</span><span class="ruby-operator">|</span> <span class="ruby-identifier">glob_files</span>(<span class="ruby-identifier">glob</span>) }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
158:         <span class="ruby-identifier">packages</span>[<span class="ruby-identifier">name</span>][<span class="ruby-identifier">:paths</span>] = <span class="ruby-identifier">paths</span>
159:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">paths</span>.<span class="ruby-identifier">grep</span>(<span class="ruby-constant">Jammit</span>.<span class="ruby-identifier">template_extension_matcher</span>).<span class="ruby-identifier">empty?</span>
160:           <span class="ruby-identifier">packages</span>[<span class="ruby-identifier">name</span>][<span class="ruby-identifier">:urls</span>] = <span class="ruby-identifier">paths</span>.<span class="ruby-identifier">grep</span>(<span class="ruby-constant">JS_EXTENSION</span>).<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">path</span><span class="ruby-operator">|</span> <span class="ruby-identifier">path</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-identifier">path_to_url</span>, <span class="ruby-value str">''</span>) }
161:           <span class="ruby-identifier">packages</span>[<span class="ruby-identifier">name</span>][<span class="ruby-identifier">:urls</span>] <span class="ruby-operator">+=</span> [<span class="ruby-constant">Jammit</span>.<span class="ruby-identifier">asset_url</span>(<span class="ruby-identifier">name</span>, <span class="ruby-constant">Jammit</span>.<span class="ruby-identifier">template_extension</span>)]
162:         <span class="ruby-keyword kw">else</span>
163:           <span class="ruby-identifier">packages</span>[<span class="ruby-identifier">name</span>][<span class="ruby-identifier">:urls</span>] = <span class="ruby-identifier">paths</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">path</span><span class="ruby-operator">|</span> <span class="ruby-identifier">path</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-identifier">path_to_url</span>, <span class="ruby-value str">''</span>) }
164:         <span class="ruby-keyword kw">end</span>
165:       <span class="ruby-keyword kw">end</span>
166:       <span class="ruby-identifier">packages</span>
167:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000046">
                    
                    <a name="M000046"></a><b>glob_files</b>(glob)
                    
                </div>
                
                <div class="description">
                  <p>
Absolute globs are absolute &#8212; relative globs are relative to
ASSET_ROOT. Print a warning if no files were found that match the glob.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000046_source')" id="l_M000046_source">show</a>
                        
                    </p>
                    <div id="M000046_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/jammit/packager.rb, line 101</span>
101:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">glob_files</span>(<span class="ruby-identifier">glob</span>)
102:       <span class="ruby-identifier">absolute</span> = <span class="ruby-constant">Pathname</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">glob</span>).<span class="ruby-identifier">absolute?</span>
103:       <span class="ruby-identifier">paths</span> = <span class="ruby-constant">Dir</span>[<span class="ruby-identifier">absolute</span> <span class="ruby-value">? </span><span class="ruby-identifier">glob</span> <span class="ruby-operator">:</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">ASSET_ROOT</span>, <span class="ruby-identifier">glob</span>)].<span class="ruby-identifier">sort</span>
104:       <span class="ruby-constant">Jammit</span>.<span class="ruby-identifier">warn</span>(<span class="ruby-node">&quot;No assets match '#{glob}'&quot;</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">paths</span>.<span class="ruby-identifier">empty?</span>
105:       <span class="ruby-identifier">paths</span>
106:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000048">
                    
                    <a name="M000048"></a><b>latest_mtime</b>(paths)
                    
                </div>
                
                <div class="description">
                  <p>
Get the latest mtime of a list of files (plus the config path).
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000048_source')" id="l_M000048_source">show</a>
                        
                    </p>
                    <div id="M000048_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/jammit/packager.rb, line 114</span>
114:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">latest_mtime</span>(<span class="ruby-identifier">paths</span>)
115:       <span class="ruby-identifier">paths</span> <span class="ruby-operator">+=</span> [<span class="ruby-constant">Jammit</span>.<span class="ruby-identifier">config_path</span>]
116:       <span class="ruby-identifier">paths</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">mtime</span>(<span class="ruby-identifier">p</span>) }.<span class="ruby-identifier">max</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
117:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000051">
                    
                    <a name="M000051"></a><b>not_found</b>(package, extension)
                    
                </div>
                
                <div class="description">
                  <p>
Raise a <a href="PackageNotFound.html">PackageNotFound</a> exception for
missing packages...
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000051_source')" id="l_M000051_source">show</a>
                        
                    </p>
                    <div id="M000051_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/jammit/packager.rb, line 170</span>
170:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">not_found</span>(<span class="ruby-identifier">package</span>, <span class="ruby-identifier">extension</span>)
171:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">PackageNotFound</span>, <span class="ruby-node">&quot;assets.yml does not contain a \&quot;#{package}\&quot; #{extension.to_s.upcase} package&quot;</span>
172:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000045">
                    
                    <a name="M000045"></a><b>package_for</b>(package, extension)
                    
                </div>
                
                <div class="description">
                  <p>
Look up a package asset list by name, raising an exception if the package
has gone missing.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000045_source')" id="l_M000045_source">show</a>
                        
                    </p>
                    <div id="M000045_source" class="dyn-source">
                        <pre>    <span class="ruby-comment cmt"># File lib/jammit/packager.rb, line 94</span>
94:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">package_for</span>(<span class="ruby-identifier">package</span>, <span class="ruby-identifier">extension</span>)
95:       <span class="ruby-identifier">pack</span> = <span class="ruby-ivar">@packages</span>[<span class="ruby-identifier">extension</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@packages</span>[<span class="ruby-identifier">extension</span>][<span class="ruby-identifier">package</span>]
96:       <span class="ruby-identifier">pack</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">not_found</span>(<span class="ruby-identifier">package</span>, <span class="ruby-identifier">extension</span>)
97:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000047">
                    
                    <a name="M000047"></a><b>path_to_url</b>()
                    
                </div>
                
                <div class="description">
                  <p>
In Rails, the difference between a path and an asset URL is
&#8220;public&#8221;.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000047_source')" id="l_M000047_source">show</a>
                        
                    </p>
                    <div id="M000047_source" class="dyn-source">
                        <pre>     <span class="ruby-comment cmt"># File lib/jammit/packager.rb, line 109</span>
109:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">path_to_url</span>
110:       <span class="ruby-ivar">@path_to_url</span> <span class="ruby-operator">||=</span> <span class="ruby-node">/\A#{Regexp.escape(ASSET_ROOT)}(\/?#{Regexp.escape(Jammit.public_root.sub(ASSET_ROOT, ''))})?/</span>
111:     <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    